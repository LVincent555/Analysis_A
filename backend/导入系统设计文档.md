# å¥å£®æ•°æ®å¯¼å…¥ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## ğŸ¯ è®¾è®¡ç›®æ ‡

å®ç°ä¸€ä¸ª**å¥å£®ã€å¯é ã€å¹‚ç­‰**çš„æ•°æ®å¯¼å…¥ç³»ç»Ÿï¼Œæ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š

1. âœ… **åŸå­æ€§ï¼ˆAtomicityï¼‰** - æ¯ä¸ªæ–‡ä»¶è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š
2. âœ… **å¹‚ç­‰æ€§ï¼ˆIdempotencyï¼‰** - æ”¯æŒé‡å¤å¯¼å…¥ï¼Œä¸äº§ç”Ÿé‡å¤æ•°æ®
3. âœ… **æ— ä¾µå…¥æ€§ï¼ˆNon-Intrusiveï¼‰** - ä¸ä¿®æ”¹åŸå§‹Excelå’Œæ•°æ®åº“ç»“æ„
4. âœ… **çŠ¶æ€å¯è¿½æº¯** - å®Œæ•´è®°å½•æ¯æ¬¡å¯¼å…¥çš„çŠ¶æ€å’Œç»“æœ
5. âœ… **é”™è¯¯å¯æ¢å¤** - å¤±è´¥åå¯å®‰å…¨é‡è¯•

---

## ğŸ“ ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶

```
backend/
â”œâ”€â”€ data_import_state.json          # å¯¼å…¥çŠ¶æ€æ–‡ä»¶ï¼ˆæ ¸å¿ƒï¼‰
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ import_state_manager.py     # çŠ¶æ€ç®¡ç†å™¨
â”‚   â”œâ”€â”€ import_data_robust.py       # å¥å£®å¯¼å…¥è„šæœ¬
â”‚   â””â”€â”€ import_data.py              # åŸå§‹å¯¼å…¥è„šæœ¬ï¼ˆä¿ç•™ï¼‰
â””â”€â”€ import_data_robust.bat          # å¯åŠ¨è„šæœ¬
```

### çŠ¶æ€æ–‡ä»¶ç»“æ„

```json
{
  "version": "1.0",
  "created_at": "2025-11-06T17:56:00",
  "last_updated": "2025-11-06T18:00:00",
  "database": "db_20251106_analysis_a",
  "imports": {
    "20251103": {
      "filename": "20251103_data_sma_feature_color.xlsx",
      "status": "success",
      "file_hash": "abc123def456...",
      "imported_count": 5428,
      "skipped_count": 0,
      "start_time": "2025-11-06T17:47:00",
      "end_time": "2025-11-06T17:47:54",
      "duration_seconds": 54.2,
      "attempt_count": 1
    },
    "20251104": {
      "filename": "20251104_data_sma_feature_color.xlsx",
      "status": "failed",
      "error": "æ•°æ®åº“è¿æ¥ä¸­æ–­",
      "imported_count": 0,
      "attempt_count": 2,
      "rollback_reason": "æ–‡ä»¶å¯¼å…¥å¤±è´¥: ...",
      "rollback_time": "2025-11-06T17:48:30"
    }
  }
}
```

---

## ğŸ” æ ¸å¿ƒæœºåˆ¶

### 1. åŸå­æ€§ï¼ˆAtomicityï¼‰

**å®ç°æ–¹å¼**ï¼š
```python
db_session = SessionLocal()  # åˆ›å»ºäº‹åŠ¡
try:
    # å¯¼å…¥æ•´ä¸ªæ–‡ä»¶çš„æ‰€æœ‰æ•°æ®...
    db_session.commit()  # æˆåŠŸï¼šæäº¤
except Exception:
    db_session.rollback()  # å¤±è´¥ï¼šå›æ»š
finally:
    db_session.close()
```

**ä¿è¯**ï¼š
- æ¯ä¸ªæ–‡ä»¶åœ¨ä¸€ä¸ªç‹¬ç«‹çš„æ•°æ®åº“äº‹åŠ¡ä¸­
- ä»»ä½•é”™è¯¯éƒ½è§¦å‘`rollback()`ï¼Œå›æ»šæ‰€æœ‰å·²æ’å…¥çš„æ•°æ®
- ç¡®ä¿æ•°æ®åº“ä¸ä¼šå‡ºç°"åŠå¯¼å…¥"çŠ¶æ€

**ç¤ºä¾‹**ï¼š
- æ–‡ä»¶æœ‰5000æ¡è®°å½•ï¼Œå¯¼å…¥åˆ°ç¬¬3000æ¡æ—¶å‡ºé”™
- âŒ é”™è¯¯ï¼šæ•°æ®åº“æœ‰3000æ¡è„æ•°æ®
- âœ… æ­£ç¡®ï¼šrollbackåï¼Œæ•°æ®åº“ä¸­ä¸€æ¡ä¹Ÿæ²¡æœ‰

---

### 2. å¹‚ç­‰æ€§ï¼ˆIdempotencyï¼‰

**ä¸‰å±‚å¹‚ç­‰æ€§ä¿è¯**ï¼š

#### å±‚çº§1ï¼šçŠ¶æ€æ–‡ä»¶æ£€æŸ¥ï¼ˆå¿«é€Ÿï¼‰
```python
if state_manager.is_imported(date_str):
    return  # è·³è¿‡æ•´ä¸ªæ–‡ä»¶
```

#### å±‚çº§2ï¼šæ–‡ä»¶MD5æ ¡éªŒ
```python
current_hash = calculate_file_hash(file_path)
if current_hash == saved_hash and status == "success":
    return  # æ–‡ä»¶æœªå˜åŒ–ï¼Œè·³è¿‡
```

#### å±‚çº§3ï¼šæ•°æ®åº“å”¯ä¸€ç´¢å¼•ï¼ˆä¿åº•ï¼‰
```sql
CREATE UNIQUE INDEX idx_daily_stock_date_unique 
    ON daily_stock_data (stock_code, date);
```

**å†³ç­–æ ‘**ï¼š
```
å¯¼å…¥æ–‡ä»¶ 20251103_xxx.xlsx
  â”œâ”€ çŠ¶æ€æ–‡ä»¶ä¸­æœ‰è®°å½•å—ï¼Ÿ
  â”‚    â”œâ”€ æ˜¯ â†’ çŠ¶æ€æ˜¯successå—ï¼Ÿ
  â”‚    â”‚    â”œâ”€ æ˜¯ â†’ æ–‡ä»¶MD5å˜äº†å—ï¼Ÿ
  â”‚    â”‚    â”‚    â”œâ”€ å¦ â†’ â­ï¸ è·³è¿‡ï¼ˆå¹‚ç­‰ï¼‰
  â”‚    â”‚    â”‚    â””â”€ æ˜¯ â†’ ğŸ”„ é‡æ–°å¯¼å…¥
  â”‚    â”‚    â””â”€ å¦ï¼ˆfailedï¼‰â†’ ğŸ”„ é‡æ–°å¯¼å…¥
  â”‚    â””â”€ å¦ â†’ âœ… é¦–æ¬¡å¯¼å…¥
  â””â”€ å¯¼å…¥ä¸­é‡åˆ°é‡å¤ â†’ å”¯ä¸€ç´¢å¼•æ‹¦æˆª â†’ è·³è¿‡è¯¥æ¡
```

---

### 3. æ— ä¾µå…¥æ€§è®¾è®¡

**ä¸ä¿®æ”¹**ï¼š
- âŒ ä¸åœ¨Excelä¸­æ·»åŠ æ ‡è®°åˆ—
- âŒ ä¸åœ¨æ•°æ®åº“ä¸­æ·»åŠ "å¯¼å…¥çŠ¶æ€"è¡¨
- âŒ ä¸ä¿®æ”¹åŸæœ‰è¡¨ç»“æ„

**ä»…æ·»åŠ **ï¼š
- âœ… æœ¬åœ°JSONçŠ¶æ€æ–‡ä»¶ï¼ˆ`data_import_state.json`ï¼‰
- âœ… ç‹¬ç«‹çš„å¯¼å…¥è„šæœ¬æ¨¡å—

**ä¼˜åŠ¿**ï¼š
- åŸå§‹æ•°æ®ä¿æŒçº¯å‡€
- æ•°æ®åº“ç»“æ„ä¿æŒç®€æ´
- çŠ¶æ€æ–‡ä»¶å¯éšæ—¶åˆ é™¤é‡å»º
- å¯åŒæ—¶ä½¿ç”¨æ–°æ—§å¯¼å…¥è„šæœ¬

---

### 4. çŠ¶æ€å¯è¿½æº¯

**è®°å½•å†…å®¹**ï¼š
```json
{
  "filename": "20251103_data_sma_feature_color.xlsx",
  "status": "success",              // çŠ¶æ€
  "file_hash": "abc123...",          // æ–‡ä»¶æŒ‡çº¹
  "imported_count": 5428,            // å¯¼å…¥æ•°é‡
  "start_time": "2025-11-06T17:47:00",
  "end_time": "2025-11-06T17:47:54",
  "duration_seconds": 54.2,          // è€—æ—¶
  "attempt_count": 1                 // å°è¯•æ¬¡æ•°
}
```

**æ”¯æŒçš„æŸ¥è¯¢**ï¼š
- å“ªäº›æ—¥æœŸå·²å¯¼å…¥ï¼Ÿ
- æŸä¸ªæ–‡ä»¶å¯¼å…¥äº†å¤šå°‘æ¡ï¼Ÿ
- å¯¼å…¥å¤±è´¥çš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ
- æŸä¸ªæ–‡ä»¶å°è¯•å¯¼å…¥äº†å‡ æ¬¡ï¼Ÿ
- æ€»å…±å¯¼å…¥äº†å¤šå°‘æ•°æ®ï¼Ÿ

---

### 5. é”™è¯¯æ¢å¤

**å¤±è´¥åœºæ™¯1ï¼šç½‘ç»œä¸­æ–­**
```
çŠ¶æ€ï¼šfailed
åŸå› ï¼šæ•°æ®åº“è¿æ¥ä¸­æ–­
æ¢å¤ï¼šé‡æ–°è¿è¡Œè„šæœ¬ï¼Œè‡ªåŠ¨é‡è¯•å¤±è´¥çš„æ–‡ä»¶
```

**å¤±è´¥åœºæ™¯2ï¼šæ•°æ®æ ¼å¼é”™è¯¯**
```
çŠ¶æ€ï¼šrolled_back
åŸå› ï¼šæŸæ¡è®°å½•çš„æ•°æ®ç±»å‹é”™è¯¯
æ¢å¤ï¼šä¿®å¤Excelæ–‡ä»¶åï¼Œé‡æ–°å¯¼å…¥ï¼ˆæ–‡ä»¶MD5å˜åŒ–ä¼šè§¦å‘é‡å¯¼ï¼‰
```

**å¤±è´¥åœºæ™¯3ï¼šç¨‹åºå´©æºƒ**
```
çŠ¶æ€ï¼šin_progressï¼ˆæœªå®Œæˆï¼‰
æ¢å¤ï¼šé‡æ–°è¿è¡Œè„šæœ¬ï¼Œå°†é‡æ–°å¼€å§‹è¯¥æ–‡ä»¶
```

---

## ğŸ“Š çŠ¶æ€è½¬æ¢å›¾

```
[åˆå§‹çŠ¶æ€]
    â†“
[æ£€æŸ¥çŠ¶æ€æ–‡ä»¶]
    â†“
   åˆ¤æ–­
    â”œâ”€ å·²successä¸”æ–‡ä»¶æœªå˜ â†’ [è·³è¿‡]
    â”œâ”€ å·²failed â†’ [in_progress] â†’ å¯¼å…¥
    â”œâ”€ å·²in_progress â†’ [in_progress] â†’ å¯¼å…¥
    â””â”€ ä¸å­˜åœ¨ â†’ [in_progress] â†’ å¯¼å…¥
    â†“
[å¯¼å…¥ä¸­...]
    â”œâ”€ å…¨éƒ¨æˆåŠŸ â†’ [success] â†’ commit
    â””â”€ ä»»ä½•å¤±è´¥ â†’ [rolled_back] â†’ rollback
```

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### é¦–æ¬¡å¯¼å…¥
```bash
# Windows
import_data_robust.bat

# Linux/Mac
python scripts/import_data_robust.py
```

### é‡æ–°å¯¼å…¥å¤±è´¥çš„æ–‡ä»¶
```bash
# ç›´æ¥è¿è¡Œï¼Œè„šæœ¬ä¼šè‡ªåŠ¨è¯†åˆ«å¹¶é‡è¯•å¤±è´¥çš„æ–‡ä»¶
import_data_robust.bat
```

### å¼ºåˆ¶é‡æ–°å¯¼å…¥æ‰€æœ‰æ•°æ®
```python
# åˆ é™¤çŠ¶æ€æ–‡ä»¶
rm data_import_state.json

# æ¸…ç©ºæ•°æ®åº“
TRUNCATE TABLE daily_stock_data RESTART IDENTITY CASCADE;
TRUNCATE TABLE stocks RESTART IDENTITY CASCADE;

# é‡æ–°å¯¼å…¥
import_data_robust.bat
```

### æŸ¥çœ‹å¯¼å…¥çŠ¶æ€
```python
from scripts.import_state_manager import get_state_manager

state = get_state_manager()
state.print_summary()  # æ‰“å°ç»Ÿè®¡æ‘˜è¦

# æŸ¥çœ‹ç‰¹å®šæ—¥æœŸ
info = state.get_import_info('20251103')
print(info)
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### Q: å¯¼å…¥æ˜¾ç¤º"å·²è·³è¿‡"ï¼Œä½†æ•°æ®åº“ä¸­æ²¡æœ‰æ•°æ®
**A**: çŠ¶æ€æ–‡ä»¶å¯èƒ½è¿‡æœŸï¼Œåˆ é™¤`data_import_state.json`åé‡è¯•

### Q: å¯¼å…¥åˆ°ä¸€åŠå‡ºé”™ï¼Œæ•°æ®åº“ä¸­æœ‰éƒ¨åˆ†æ•°æ®æ€ä¹ˆåŠï¼Ÿ
**A**: è¿™è¯´æ˜äº‹åŠ¡æ²¡æœ‰æ­£ç¡®å›æ»šï¼Œéœ€è¦æ‰‹åŠ¨æ¸…ç©ºè¯¥æ—¥æœŸçš„æ•°æ®ï¼š
```sql
DELETE FROM daily_stock_data WHERE date = '2025-11-03';
```

### Q: å¦‚ä½•å®Œå…¨é‡ç½®å¯¼å…¥çŠ¶æ€ï¼Ÿ
**A**: 
```bash
# 1. åˆ é™¤çŠ¶æ€æ–‡ä»¶
del data_import_state.json

# 2. æ¸…ç©ºæ•°æ®åº“
psql ... -f sql/clear_data.sql

# 3. é‡æ–°å¯¼å…¥
import_data_robust.bat
```

---

## ğŸ“ˆ æ€§èƒ½ç‰¹æ€§

### å¹‚ç­‰æ€§æ£€æŸ¥é€Ÿåº¦
- **çŠ¶æ€æ–‡ä»¶æ£€æŸ¥**: < 1msï¼ˆè¯»JSONï¼‰
- **MD5å“ˆå¸Œè®¡ç®—**: ~50msï¼ˆ3MBæ–‡ä»¶ï¼‰
- **æ•°æ®åº“æŸ¥è¯¢**: ~10ms

### å¯¼å…¥é€Ÿåº¦
- **å•æ¡è®°å½•**: ~10ms
- **1000æ¡æ‰¹æ¬¡**: ~8ç§’
- **5000æ¡æ–‡ä»¶**: ~40-60ç§’

### çŠ¶æ€æ–‡ä»¶å¤§å°
- **100ä¸ªæ—¥æœŸ**: ~50KB
- **365ä¸ªæ—¥æœŸ**: ~180KB

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **çŠ¶æ€æ–‡ä»¶å¤‡ä»½**ï¼š
   - `data_import_state.json`æ˜¯å…³é”®æ–‡ä»¶
   - å»ºè®®å®šæœŸå¤‡ä»½ï¼ˆå¯åŠ å…¥ç‰ˆæœ¬æ§åˆ¶ï¼‰

2. **å¤šè¿›ç¨‹å¯¼å…¥**ï¼š
   - å½“å‰è®¾è®¡ä¸æ”¯æŒå¹¶å‘
   - å¤šè¿›ç¨‹ä¼šå¯¼è‡´çŠ¶æ€æ–‡ä»¶å†²çª

3. **æ–‡ä»¶ç§»åŠ¨/é‡å‘½å**ï¼š
   - æ–‡ä»¶MD5ä¼šå˜åŒ–
   - å¯èƒ½å¯¼è‡´é‡å¤å¯¼å…¥

4. **æ—¶åŒºé—®é¢˜**ï¼š
   - æ‰€æœ‰æ—¶é—´æˆ³ä½¿ç”¨æœ¬åœ°æ—¶åŒº
   - ç¡®ä¿æœåŠ¡å™¨æ—¶åŒºè®¾ç½®æ­£ç¡®

---

## ğŸ”„ ä¸åŸå§‹è„šæœ¬å¯¹æ¯”

| ç‰¹æ€§ | import_data.py | import_data_robust.py |
|------|----------------|----------------------|
| å¹‚ç­‰æ€§ | âŒ æ— ï¼ˆé‡å¤å¯¼å…¥ä¼šæŠ¥é”™ï¼‰ | âœ… å®Œæ•´ï¼ˆçŠ¶æ€æ–‡ä»¶+MD5ï¼‰ |
| åŸå­æ€§ | âš ï¸ éƒ¨åˆ†ï¼ˆæ¯1000æ¡æäº¤ï¼‰ | âœ… å®Œæ•´ï¼ˆæ–‡ä»¶çº§äº‹åŠ¡ï¼‰ |
| çŠ¶æ€è¿½æº¯ | âŒ æ—  | âœ… å®Œæ•´JSONè®°å½• |
| é”™è¯¯æ¢å¤ | âŒ éœ€æ‰‹åŠ¨æ¸…ç† | âœ… è‡ªåŠ¨é‡è¯• |
| æ–‡ä»¶æ ¡éªŒ | âŒ æ—  | âœ… MD5å“ˆå¸Œ |

---

## ğŸ“ åç»­ä¼˜åŒ–

### å¯èƒ½çš„å¢å¼º
1. æ”¯æŒå¹¶å‘å¯¼å…¥ï¼ˆä½¿ç”¨æ–‡ä»¶é”ï¼‰
2. å¯¼å…¥è¿›åº¦æ¡æ˜¾ç¤º
3. å¤±è´¥åè‡ªåŠ¨é€šçŸ¥ï¼ˆé‚®ä»¶/é’‰é’‰ï¼‰
4. å¯¼å…¥æ—¥å¿—æŒä¹…åŒ–åˆ°æ•°æ®åº“
5. æ”¯æŒå¢é‡æ›´æ–°ï¼ˆä»…å¯¼å…¥æ–°å¢è‚¡ç¥¨ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¥æœŸ**: 2025-11-06  
**ä½œè€…**: Cascade AI
