"""
æ•°æ®åº“è¿æ¥å’Œä¼šè¯ç®¡ç†

âš ï¸ é‡è¦æç¤ºï¼š
1. å¤åˆ¶æ­¤æ–‡ä»¶ä¸º database.py
2. ä¿®æ”¹æ•°æ®åº“è¿æ¥é…ç½®
3. database.py ä¸ä¼šè¢«æäº¤åˆ°Git

ğŸ“ é…ç½®è¯´æ˜ï¼š

ã€ç”Ÿäº§ç¯å¢ƒã€‘ï¼ˆæœåŠ¡å™¨éƒ¨ç½²ï¼‰
- DB_HOST = "localhost"  # æœåŠ¡å™¨ä¸Šæ•°æ®åº“ä½¿ç”¨localhost
- DB_NAME = "db_20251106_analysis_a"  # ç”Ÿäº§æ•°æ®åº“å
- DB_PASSWORD = "your_production_password"  # ç”Ÿäº§å¯†ç 

ã€æœ¬åœ°å¼€å‘ã€‘
- DB_HOST = "localhost"  # æœ¬åœ°æ•°æ®åº“åœ°å€
- DB_NAME = "stock_analysis"  # æœ¬åœ°æµ‹è¯•æ•°æ®åº“
- DB_PASSWORD = "your_local_password"  # æœ¬åœ°å¯†ç 

ğŸ’¡ ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®ï¼ˆæ¨èï¼‰ï¼š
åˆ›å»º backend/.env æ–‡ä»¶ï¼š
DB_HOST=your_host
DB_PORT=5432
DB_NAME=your_database
DB_USER=your_user
DB_PASSWORD=your_password

ğŸ” å†å²æ—¥æœŸæŸ¥çœ‹åŠŸèƒ½ï¼š
ç³»ç»Ÿæ”¯æŒæŸ¥çœ‹å†å²æ—¥æœŸçš„æ•°æ®ï¼Œæ‰€æœ‰APIéƒ½æ”¯æŒdateå‚æ•°(YYYYMMDDæ ¼å¼)
å‰ç«¯æœ‰å…¨å±€æ—¥æœŸé€‰æ‹©å™¨ï¼Œå¯ä»¥é€‰æ‹©ä»»æ„å†å²æ—¥æœŸè¿›è¡Œåˆ†æ
"""
import os
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from dotenv import load_dotenv
import logging

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

logger = logging.getLogger(__name__)

# æ•°æ®åº“è¿æ¥é…ç½®
# âš ï¸ ä¿®æ”¹ä¸ºä½ çš„æœåŠ¡å™¨é…ç½®
DB_HOST = os.getenv("DB_HOST", "localhost")  # æ•°æ®åº“æœåŠ¡å™¨åœ°å€
DB_PORT = os.getenv("DB_PORT", "5432")        # æ•°æ®åº“ç«¯å£
DB_NAME = os.getenv("DB_NAME", "stock_analysis")  # æ•°æ®åº“åç§°
DB_USER = os.getenv("DB_USER", "postgres")   # æ•°æ®åº“ç”¨æˆ·å
DB_PASSWORD = os.getenv("DB_PASSWORD", "")   # æ•°æ®åº“å¯†ç 

# æ„å»ºæ•°æ®åº“URL
DATABASE_URL = f"postgresql://{DB_USER}:{DB_PASSWORD}@{DB_HOST}:{DB_PORT}/{DB_NAME}"

# åˆ›å»ºæ•°æ®åº“å¼•æ“
engine = create_engine(
    DATABASE_URL,
    pool_size=10,  # è¿æ¥æ± å¤§å°
    max_overflow=20,  # æœ€å¤§æº¢å‡ºè¿æ¥æ•°
    pool_pre_ping=True,  # æ£€æŸ¥è¿æ¥æ˜¯å¦æœ‰æ•ˆ
    echo=False  # æ˜¯å¦æ‰“å°SQLè¯­å¥
)

# åˆ›å»ºä¼šè¯å·¥å‚
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# åˆ›å»ºBaseç±»
Base = declarative_base()


def get_db():
    """
    è·å–æ•°æ®åº“ä¼šè¯
    ç”¨äºFastAPIä¾èµ–æ³¨å…¥
    """
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


def test_connection():
    """
    æµ‹è¯•æ•°æ®åº“è¿æ¥
    """
    try:
        from sqlalchemy import text
        with engine.connect() as conn:
            conn.execute(text("SELECT 1"))
        logger.info(f"æ•°æ®åº“è¿æ¥æˆåŠŸ: {DB_HOST}:{DB_PORT}/{DB_NAME}")
        return True
    except Exception as e:
        logger.error(f"æ•°æ®åº“è¿æ¥å¤±è´¥: {str(e)}")
        return False
