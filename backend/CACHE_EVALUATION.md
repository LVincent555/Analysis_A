# åç«¯æ¥å£ç¼“å­˜éœ€æ±‚è¯„ä¼°

## ğŸ“Š æ¥å£æ¸…å•ä¸ç¼“å­˜å»ºè®®

### 1. ğŸ”´ **å¼ºçƒˆå»ºè®®ç¼“å­˜** - é™æ€/å‡†é™æ€æ•°æ®

#### `/api/dates` - å¯ç”¨æ—¥æœŸåˆ—è¡¨
- **æ›´æ–°é¢‘ç‡**: æ¯å¤©ä¸€æ¬¡ï¼ˆå‡Œæ™¨æ•°æ®å…¥åº“åï¼‰
- **è¯·æ±‚é¢‘ç‡**: æ¯ä¸ªç”¨æˆ·é¡µé¢åŠ è½½æ—¶1æ¬¡
- **æ•°æ®é‡**: å°ï¼ˆå‡ åä¸ªæ—¥æœŸå­—ç¬¦ä¸²ï¼‰
- **ç¼“å­˜ç­–ç•¥**: 
  - âœ… Redisç¼“å­˜ï¼ŒTTL: 1å°æ—¶
  - âœ… æœ¬åœ°å†…å­˜ç¼“å­˜ + å®šæ—¶åˆ·æ–°
- **ä¼˜å…ˆçº§**: â­â­â­â­â­

#### `/api/sectors/dates` - æ¿å—å¯ç”¨æ—¥æœŸ
- **æ›´æ–°é¢‘ç‡**: æ¯å¤©ä¸€æ¬¡
- **è¯·æ±‚é¢‘ç‡**: æ¿å—æ¨¡å—åŠ è½½æ—¶1æ¬¡
- **æ•°æ®é‡**: å°
- **ç¼“å­˜ç­–ç•¥**: åŒä¸Š
- **ä¼˜å…ˆçº§**: â­â­â­â­â­

---

### 2. ğŸŸ¡ **å»ºè®®ç¼“å­˜** - è®¡ç®—å¯†é›†å‹æ¥å£

#### `/api/analyze/{period}` - è‚¡ç¥¨é‡å¤åˆ†æ
- **æ›´æ–°é¢‘ç‡**: æ¯å¤©ä¸€æ¬¡
- **è¯·æ±‚é¢‘ç‡**: ç”¨æˆ·åˆ‡æ¢å‘¨æœŸ/æ¿å—/ç­›é€‰æ¡ä»¶æ—¶
- **è®¡ç®—å¤æ‚åº¦**: é«˜ï¼ˆèšåˆ+æ’åº+ç»Ÿè®¡ï¼‰
- **æ•°æ®é‡**: ä¸­ç­‰ï¼ˆå‡ ç™¾åªè‚¡ç¥¨ï¼‰
- **å‚æ•°ç»„åˆ**: `period(2,3,5,7,14) Ã— board_type(3) Ã— top_n(6) Ã— date(30+)` = **12,600+** ç§
- **ç¼“å­˜ç­–ç•¥**:
  - âœ… Redisç¼“å­˜ï¼ŒTTL: 6å°æ—¶ï¼ˆå½“å¤©æ•°æ®ï¼‰
  - âœ… ä½¿ç”¨å‚æ•°å“ˆå¸Œä½œä¸ºkey: `analyze:{period}:{board_type}:{top_n}:{date}`
  - âœ… è®¾ç½®æœ€å¤§ç¼“å­˜æ¡ç›®æ•°ï¼ˆLRUæ·˜æ±°ï¼‰
- **ä¼˜å…ˆçº§**: â­â­â­â­

#### `/api/industry/trend` - è¡Œä¸šè¶‹åŠ¿
- **æ›´æ–°é¢‘ç‡**: æ¯å¤©ä¸€æ¬¡
- **è¯·æ±‚é¢‘ç‡**: è¡Œä¸šè¶‹åŠ¿æ¨¡å—åŠ è½½æ—¶
- **è®¡ç®—å¤æ‚åº¦**: é«˜ï¼ˆå¤šæ—¥æœŸèšåˆï¼‰
- **å‚æ•°ç»„åˆ**: `period(å¤šç§) Ã— top_n Ã— date`
- **ç¼“å­˜ç­–ç•¥**: åŒä¸Š
- **ä¼˜å…ˆçº§**: â­â­â­â­

#### `/api/industry/weighted` - åŠ æƒè¡Œä¸šç»Ÿè®¡
- **æ›´æ–°é¢‘ç‡**: æ¯å¤©ä¸€æ¬¡
- **è¯·æ±‚é¢‘ç‡**: åˆ‡æ¢kå€¼æ—¶
- **è®¡ç®—å¤æ‚åº¦**: æé«˜ï¼ˆ5000+è‚¡ç¥¨åŠ æƒè®¡ç®—ï¼‰
- **å‚æ•°ç»„åˆ**: `k(è¿ç»­å€¼) Ã— date(30+)` = å¤§é‡
- **ç¼“å­˜ç­–ç•¥**:
  - âœ… Redisç¼“å­˜ï¼ŒTTL: 6å°æ—¶
  - âœ… kå€¼åˆ†æ¡£ç¼“å­˜ï¼ˆ0.1, 0.2, ..., 1.0ï¼‰å‡å°‘ç¼“å­˜æ¡ç›®
  - âœ… å‰ç«¯å¯ä»¥æ’å€¼è®¡ç®—ä¸­é—´å€¼
- **ä¼˜å…ˆçº§**: â­â­â­â­â­ (æœ€éœ€è¦ç¼“å­˜)

#### `/api/industry/top1000` - å‰Nåè¡Œä¸šç»Ÿè®¡
- **æ›´æ–°é¢‘ç‡**: æ¯å¤©ä¸€æ¬¡
- **è¯·æ±‚é¢‘ç‡**: æœ€æ–°çƒ­ç‚¹æ¨¡å—åŠ è½½æ—¶
- **è®¡ç®—å¤æ‚åº¦**: ä¸­ï¼ˆèšåˆè®¡ç®—ï¼‰
- **å‚æ•°ç»„åˆ**: `limit(å¤šç§) Ã— date(30+)`
- **ç¼“å­˜ç­–ç•¥**: Redisç¼“å­˜ï¼ŒTTL: 6å°æ—¶
- **ä¼˜å…ˆçº§**: â­â­â­

#### `/api/sectors/trend` - æ¿å—è¶‹åŠ¿
- **æ›´æ–°é¢‘ç‡**: æ¯å¤©ä¸€æ¬¡
- **è¯·æ±‚é¢‘ç‡**: æ¿å—è¶‹åŠ¿æ¨¡å—åŠ è½½æ—¶
- **è®¡ç®—å¤æ‚åº¦**: é«˜ï¼ˆå¤šæ—¥èšåˆï¼‰
- **å‚æ•°ç»„åˆ**: `days(å¤šç§) Ã— limit Ã— date`
- **ç¼“å­˜ç­–ç•¥**: Redisç¼“å­˜ï¼ŒTTL: 6å°æ—¶
- **ä¼˜å…ˆçº§**: â­â­â­â­

#### `/api/sectors/rank-changes` - æ¿å—æ’åå˜åŒ–
- **æ›´æ–°é¢‘ç‡**: æ¯å¤©ä¸€æ¬¡
- **è¯·æ±‚é¢‘ç‡**: æ¿å—è¶‹åŠ¿æ¨¡å—åŠ è½½æ—¶
- **è®¡ç®—å¤æ‚åº¦**: ä¸­ï¼ˆä¸¤å¤©å¯¹æ¯”ï¼‰
- **å‚æ•°ç»„åˆ**: `compare_days Ã— date`
- **ç¼“å­˜ç­–ç•¥**: Redisç¼“å­˜ï¼ŒTTL: 6å°æ—¶
- **ä¼˜å…ˆçº§**: â­â­â­

#### `/api/rank_jump` - æ’åè·³å˜åˆ†æ
- **æ›´æ–°é¢‘ç‡**: æ¯å¤©ä¸€æ¬¡
- **è¯·æ±‚é¢‘ç‡**: åˆ‡æ¢é˜ˆå€¼/æ¿å—ç±»å‹æ—¶
- **è®¡ç®—å¤æ‚åº¦**: é«˜ï¼ˆå¤§é‡æ’åå¯¹æ¯”ï¼‰
- **å‚æ•°ç»„åˆ**: `threshold(å¤šç§) Ã— board_type(3) Ã— date(30+)`
- **ç¼“å­˜ç­–ç•¥**: Redisç¼“å­˜ï¼ŒTTL: 6å°æ—¶
- **ä¼˜å…ˆçº§**: â­â­â­â­

#### `/api/steady-rise` - ç¨³æ­¥ä¸Šå‡åˆ†æ
- **æ›´æ–°é¢‘ç‡**: æ¯å¤©ä¸€æ¬¡
- **è¯·æ±‚é¢‘ç‡**: åˆ‡æ¢å‘¨æœŸ/æå‡é˜ˆå€¼æ—¶
- **è®¡ç®—å¤æ‚åº¦**: æé«˜ï¼ˆè¿ç»­å¤šæ—¥è¶‹åŠ¿åˆ†æï¼‰
- **å‚æ•°ç»„åˆ**: `period(å¤šç§) Ã— improvement(å¤šç§) Ã— board_type(3) Ã— date(30+)`
- **ç¼“å­˜ç­–ç•¥**: Redisç¼“å­˜ï¼ŒTTL: 6å°æ—¶
- **ä¼˜å…ˆçº§**: â­â­â­â­â­

---

### 3. ğŸŸ¢ **å¯é€‰ç¼“å­˜** - è½»é‡çº§æ¥å£

#### `/api/sectors/ranking` - æ¿å—æ’å
- **æ›´æ–°é¢‘ç‡**: æ¯å¤©ä¸€æ¬¡
- **è¯·æ±‚é¢‘ç‡**: ä½
- **è®¡ç®—å¤æ‚åº¦**: ä½ï¼ˆç®€å•æŸ¥è¯¢+æ’åºï¼‰
- **æ•°æ®é‡**: ä¸­ï¼ˆ100-500ä¸ªæ¿å—ï¼‰
- **ç¼“å­˜ç­–ç•¥**: 
  - âšª å¯é€‰ï¼šRedisç¼“å­˜ï¼ŒTTL: 1å°æ—¶
  - âšª æˆ–æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ï¼ˆç´¢å¼•ï¼‰å³å¯
- **ä¼˜å…ˆçº§**: â­â­

#### `/api/sectors/{sector_name}` - æ¿å—è¯¦æƒ…
- **æ›´æ–°é¢‘ç‡**: æ¯å¤©ä¸€æ¬¡
- **è¯·æ±‚é¢‘ç‡**: ç‚¹å‡»è¯¦æƒ…æŒ‰é’®æ—¶
- **è®¡ç®—å¤æ‚åº¦**: ä½ï¼ˆå•è¡¨æŸ¥è¯¢ï¼‰
- **æ•°æ®é‡**: å°ï¼ˆå•ä¸ªæ¿å—30å¤©æ•°æ®ï¼‰
- **ç¼“å­˜ç­–ç•¥**: 
  - âšª å¯é€‰ï¼šRedisç¼“å­˜ï¼ŒTTL: 2å°æ—¶
  - âšª çƒ­ç‚¹æ¿å—å¯ç¼“å­˜ï¼Œå†·é—¨æ¿å—ç›´æ¥æŸ¥è¯¢
- **ä¼˜å…ˆçº§**: â­â­

#### `/api/stock/{stock_code}` - ä¸ªè‚¡å†å²
- **æ›´æ–°é¢‘ç‡**: æ¯å¤©ä¸€æ¬¡
- **è¯·æ±‚é¢‘ç‡**: è‚¡ç¥¨æŸ¥è¯¢æ—¶
- **è®¡ç®—å¤æ‚åº¦**: ä½ï¼ˆå•è‚¡ç¥¨æŸ¥è¯¢ï¼‰
- **æ•°æ®é‡**: å°
- **ç¼“å­˜ç­–ç•¥**: 
  - âšª å¯é€‰ï¼šçƒ­ç‚¹è‚¡ç¥¨ç¼“å­˜
  - âšª LRUç¼“å­˜æœ€è¿‘æŸ¥è¯¢çš„100åªè‚¡ç¥¨
- **ä¼˜å…ˆçº§**: â­â­

#### `/api/sectors/search/{keyword}` - æœç´¢æ¿å—
- **æ›´æ–°é¢‘ç‡**: æ¯å¤©ä¸€æ¬¡ï¼ˆæ¿å—åˆ—è¡¨ï¼‰
- **è¯·æ±‚é¢‘ç‡**: è¾“å…¥æœç´¢æ—¶
- **è®¡ç®—å¤æ‚åº¦**: ä½ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
- **æ•°æ®é‡**: å°
- **ç¼“å­˜ç­–ç•¥**: 
  - âšª ä¸å»ºè®®ç¼“å­˜ï¼ˆå‚æ•°ç»„åˆå¤ªå¤šï¼‰
  - âšª æ•°æ®åº“å…¨æ–‡ç´¢å¼•ä¼˜åŒ–å³å¯
- **ä¼˜å…ˆçº§**: â­

---

## ğŸ¯ ç¼“å­˜å®æ–½ä¼˜å…ˆçº§

### ç¬¬ä¸€é˜¶æ®µï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰
1. âœ… `/api/dates` - å†…å­˜ç¼“å­˜
2. âœ… `/api/sectors/dates` - å†…å­˜ç¼“å­˜
3. âœ… `/api/industry/weighted` - Redisç¼“å­˜ï¼ˆæœ€é‡è¦ï¼‰
4. âœ… `/api/steady-rise` - Redisç¼“å­˜

### ç¬¬äºŒé˜¶æ®µï¼ˆè®¡ç®—å¯†é›†å‹ï¼‰
5. âœ… `/api/analyze/{period}` - Redisç¼“å­˜
6. âœ… `/api/industry/trend` - Redisç¼“å­˜
7. âœ… `/api/sectors/trend` - Redisç¼“å­˜
8. âœ… `/api/rank_jump` - Redisç¼“å­˜

### ç¬¬ä¸‰é˜¶æ®µï¼ˆè½»é‡ä¼˜åŒ–ï¼‰
9. âšª `/api/sectors/ranking` - å¯é€‰
10. âšª `/api/stock/{stock_code}` - çƒ­ç‚¹ç¼“å­˜

---

## ğŸ’¡ ç¼“å­˜å®æ–½æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šRedisç¼“å­˜ï¼ˆæ¨èï¼‰

```python
from functools import wraps
import redis
import hashlib
import json

redis_client = redis.Redis(host='localhost', port=6379, db=0, decode_responses=True)

def cache_response(ttl=3600, key_prefix="api"):
    """è£…é¥°å™¨ï¼šç¼“å­˜APIå“åº”"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            # ç”Ÿæˆç¼“å­˜key
            cache_key = f"{key_prefix}:{func.__name__}:{hash_params(kwargs)}"
            
            # å°è¯•ä»ç¼“å­˜è·å–
            cached = redis_client.get(cache_key)
            if cached:
                return json.loads(cached)
            
            # æ‰§è¡ŒåŸå‡½æ•°
            result = await func(*args, **kwargs)
            
            # å­˜å…¥ç¼“å­˜
            redis_client.setex(cache_key, ttl, json.dumps(result))
            
            return result
        return wrapper
    return decorator

# ä½¿ç”¨ç¤ºä¾‹
@router.get("/analyze/{period}")
@cache_response(ttl=21600, key_prefix="analyze")  # 6å°æ—¶
async def analyze_period(period: int, board_type: str, top_n: int, date: str):
    ...
```

### æ–¹æ¡ˆ2ï¼šå†…å­˜ç¼“å­˜ + TTL

```python
from datetime import datetime, timedelta
from threading import Lock

class MemoryCache:
    def __init__(self):
        self.cache = {}
        self.lock = Lock()
    
    def get(self, key):
        with self.lock:
            if key in self.cache:
                value, expiry = self.cache[key]
                if datetime.now() < expiry:
                    return value
                else:
                    del self.cache[key]
        return None
    
    def set(self, key, value, ttl_seconds):
        with self.lock:
            expiry = datetime.now() + timedelta(seconds=ttl_seconds)
            self.cache[key] = (value, expiry)

# å…¨å±€ç¼“å­˜å®ä¾‹
dates_cache = MemoryCache()

@router.get("/dates")
async def get_available_dates():
    cached = dates_cache.get("available_dates")
    if cached:
        return cached
    
    result = analysis_service.get_available_dates()
    dates_cache.set("available_dates", result, ttl_seconds=3600)
    return result
```

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### æ€§èƒ½æå‡
- **å“åº”æ—¶é—´**: ä» 500ms-2000ms â†’ **10ms-50ms** (ç¼“å­˜å‘½ä¸­æ—¶)
- **æ•°æ®åº“è´Ÿè½½**: å‡å°‘ **70-90%**
- **å¹¶å‘èƒ½åŠ›**: æå‡ **10-20å€**

### æˆæœ¬æ•ˆç›Š
- **Rediså†…å­˜**: çº¦ **100-500MB** (ä¸»è¦æ˜¯è®¡ç®—ç»“æœç¼“å­˜)
- **å¼€å‘æˆæœ¬**: **1-2å¤©** (è£…é¥°å™¨ + é…ç½®)
- **ç»´æŠ¤æˆæœ¬**: **ä½** (è‡ªåŠ¨è¿‡æœŸï¼Œæ— éœ€æ‰‹åŠ¨æ¸…ç†)

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç¼“å­˜å¤±æ•ˆç­–ç•¥
- æ¯æ—¥æ•°æ®æ›´æ–°åï¼Œæ¸…é™¤å½“å¤©ç›¸å…³ç¼“å­˜
- ä½¿ç”¨Redisçš„`SCAN`å‘½ä»¤æ‰¹é‡åˆ é™¤ï¼š`DEL analyze:*:20251107`

### 2. ç¼“å­˜é¢„çƒ­
- å¯åŠ¨æ—¶é¢„åŠ è½½å¸¸ç”¨å‚æ•°ç»„åˆ
- å®šæ—¶ä»»åŠ¡ï¼šå‡Œæ™¨æ•°æ®å…¥åº“åï¼Œé¢„ç”Ÿæˆçƒ­é—¨æŸ¥è¯¢ç¼“å­˜

### 3. ç›‘æ§æŒ‡æ ‡
- ç¼“å­˜å‘½ä¸­ç‡ï¼ˆç›®æ ‡ >80%ï¼‰
- ç¼“å­˜å¤§å°ï¼ˆè®¾ç½®ä¸Šé™ï¼‰
- è¿‡æœŸkeyæ•°é‡

---

## ğŸš€ å®æ–½å»ºè®®

**ç«‹å³å®æ–½**ï¼š
1. âœ… `/api/dates` - å†…å­˜ç¼“å­˜ï¼ˆæœ€ç®€å•ï¼Œç«‹ç«¿è§å½±ï¼‰
2. âœ… `/api/industry/weighted` - Redisç¼“å­˜ï¼ˆæœ€éœ€è¦ï¼‰

**é€æ­¥å®æ–½**ï¼š
3. âœ… å…¶ä»–è®¡ç®—å¯†é›†å‹æ¥å£ - Redisç¼“å­˜
4. âœ… æ·»åŠ ç¼“å­˜ç›‘æ§å’Œç®¡ç†æ¥å£

**æœªæ¥ä¼˜åŒ–**ï¼š
5. âšª CDNç¼“å­˜é™æ€æ•°æ®
6. âšª æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ï¼ˆç´¢å¼•ã€åˆ†åŒºï¼‰
7. âšª å¼‚æ­¥ä»»åŠ¡é¢„è®¡ç®—ç»“æœ
