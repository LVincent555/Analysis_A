# 数据导入指南

## 🎯 使用步骤

### 步骤1：安装依赖包

```bash
pip install -r requirements.txt
```

**新增依赖包**：
- `sqlalchemy>=2.0.0` - ORM框架
- `psycopg2-binary>=2.9.0` - PostgreSQL驱动
- `python-dotenv>=1.0.0` - 环境变量管理

---

### 步骤2：配置数据库连接

编辑 `backend/.env` 文件，填写数据库密码：

```ini
# PostgreSQL 数据库配置
DB_HOST=192.168.182.128
DB_PORT=5432
DB_NAME=db_20251106_analysis_a
DB_USER=postgres
DB_PASSWORD=你的数据库密码    # ← 填写这里

# 数据源配置
USE_DATABASE=true

# API配置
API_PORT=8000
DEBUG=True
```

---

### 步骤3：测试数据库连接

运行测试脚本：

```bash
# Windows
test_db.bat

# 或直接运行Python
python scripts\test_db_connection.py
```

**预期输出**：
```
============================================================
数据库连接测试
============================================================
数据库地址: 192.168.182.128:5432
数据库名称: db_20251106_analysis_a

✅ 数据库连接成功！

============================================================
数据文件检查
============================================================
数据目录: D:\...\stock_analysis_app\data
找到 4 个数据文件:

  1. 20251101_data_sma_feature_color.xlsx    (  2.34 MB)
  2. 20251102_data_sma_feature_color.xlsx    (  2.45 MB)
  3. 20251103_data_sma_feature_color.xlsx    (  2.38 MB)
  4. 20251104_data_sma_feature_color.xlsx    (  2.41 MB)

============================================================
准备就绪！可以运行 import_data.bat 开始导入数据
============================================================
```

---

### 步骤4：导入数据

**⚠️ 首次导入注意事项**：
- 数据库需要已经执行过 `backend/sql/version1.sql` 建表脚本
- 导入过程会自动跳过已存在的数据（防重复）
- 支持断点续传

运行导入脚本：

```bash
# Windows
import_data.bat

# 或直接运行Python
python scripts\import_data.py
```

**导入过程示例**：
```
============================================================
开始数据导入任务
============================================================
2025-11-06 17:00:00 - INFO - 数据库连接成功: 192.168.182.128:5432/db_20251106_analysis_a
2025-11-06 17:00:01 - INFO - 找到 4 个数据文件
2025-11-06 17:00:02 - INFO - 正在导入: 20251101_data_sma_feature_color.xlsx (日期: 2025-11-01)
2025-11-06 17:00:03 - INFO - 读取到 5042 条记录
2025-11-06 17:00:25 - INFO - 已导入 1000 条记录...
2025-11-06 17:00:45 - INFO - 已导入 2000 条记录...
...
2025-11-06 17:01:30 - INFO - ✅ 文件导入完成: 20251101_..., 导入: 5042, 跳过: 0
...
============================================================
✅ 导入任务完成！
总导入记录数: 20168
总跳过记录数: 0
============================================================
数据库统计: 股票数=5042, 每日数据条数=20168
```

---

## 📊 数据结构说明

### 表1：stocks (股票主表)
| 字段 | 类型 | 说明 |
|------|------|------|
| stock_code | VARCHAR(10) | 股票代码（主键）|
| stock_name | VARCHAR(50) | 股票名称 |
| industry | VARCHAR(100) | 行业 |
| last_updated | TIMESTAMP | 最后更新时间 |

### 表2：daily_stock_data (每日数据表)
- **id**: 自增主键
- **stock_code**: 股票代码（外键）
- **date**: 日期
- **rank**: 排名
- **83个技术指标字段**（价格、涨跌幅、换手率、各种技术指标等）

**索引**：
- `idx_daily_stock_date_unique`: (stock_code, date) 唯一索引，防止重复导入
- `idx_daily_date_rank`: (date, rank) 加速排名查询
- `idx_stocks_name_trgm`: 股票名称模糊查询（GIN索引）
- `idx_stocks_code_trgm`: 股票代码模糊查询（GIN索引）

---

## 🔧 常见问题

### Q1: 连接数据库失败
**错误**: `数据库连接失败: could not connect to server`

**解决方案**：
1. 检查数据库服务器是否启动
2. 检查IP地址和端口是否正确
3. 检查防火墙设置
4. 确认`.env`文件中的密码正确

---

### Q2: 导入时出现重复数据错误
**错误**: `跳过重复数据: 600000 - 2025-11-01`

**说明**: 这是正常现象，说明该股票该日期的数据已存在，会自动跳过。

---

### Q3: 如何重新导入某天的数据
**方案1（推荐）**: 删除特定日期的数据后重新导入
```sql
DELETE FROM daily_stock_data WHERE date = '2025-11-01';
```

**方案2**: 清空所有数据重新导入
```sql
TRUNCATE TABLE daily_stock_data CASCADE;
TRUNCATE TABLE stocks CASCADE;
```

---

### Q4: 导入速度慢
**优化建议**：
- 脚本已实现每1000条提交一次
- 大文件（5000+条记录）约需1-2分钟
- 4个文件总计约5-10分钟

---

## 📝 数据映射说明

Excel列名会自动映射到数据库字段，例如：
- `代码` → `stock_code`
- `名称` → `stock_name`
- `涨跌幅` → `price_change`
- `换手率%` → `turnover_rate_percent`
- `cci_-90` → `cci_neg_90` (负号转换为neg)

完整映射关系见 `scripts/import_data.py` 中的 `COLUMN_MAPPING` 字典。

---

## ✅ 验证导入成功

导入完成后，可以运行SQL验证：

```sql
-- 查看股票总数
SELECT COUNT(*) FROM stocks;

-- 查看每日数据总数
SELECT COUNT(*) FROM daily_stock_data;

-- 查看数据日期范围
SELECT MIN(date) as 最早日期, MAX(date) as 最新日期, COUNT(DISTINCT date) as 天数
FROM daily_stock_data;

-- 查看某天的数据量
SELECT date, COUNT(*) as 股票数
FROM daily_stock_data
GROUP BY date
ORDER BY date DESC;
```

---

## 🚀 下一步

数据导入完成后，即可启动后端服务：

```bash
cd backend
python -m uvicorn app.main:app --reload --port 8000
```

后端会自动从数据库读取数据，性能比读取Excel文件快10-100倍！
