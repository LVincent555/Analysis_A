# 信号系统优化说明 - 2025-11-25

## 🎯 问题描述

### 用户需求
1. **个股查询接口**：显示所有热点标签（TOP100·12次, TOP200·12次, TOP400·12次等）✅ 这是设计要求
2. **行业板块接口**：只显示主标签，避免信号污染 ⚠️ 需要修复

### 问题表现
行业板块分析中，一个股票显示多个热点信号：
```
招商轮船：8个信号
- TOP900·6次
- TOP1000·7次
- TOP2000·9次
- TOP3000·10次
- 跳变榜
- ...
```

**问题**：
- 热点信号被计算为4个（TOP900, TOP1000, TOP2000, TOP3000）
- `signal_count = 8`（虚高）
- ❌ **信号系统被污染**

---

## ✅ 修复方案

### 核心思路
1. **个股查询**：显示所有热点标签（用户设计要求）
2. **行业板块**：只显示主标签（避免信号污染）
3. **分数计算**：始终只基于主档位计算（已正确）

### 实现方式
添加参数 `simplify_hot_labels` 控制标签显示模式

---

## 📝 代码修改

### 1. SignalCalculator.calculate_signals 添加参数

**文件**：`backend/app/services/signal_calculator.py`

```python
def calculate_signals(
    self,
    stock_code: str,
    current_date: date,
    current_data: DailyStockData,
    history_days: int = 7,
    simplify_hot_labels: bool = False  # 🔥 新增参数
) -> Dict:
    """
    计算股票的多榜单信号
    
    Args:
        simplify_hot_labels: 是否简化热点标签
            - False（默认）: 显示所有热点标签（个股查询用）
            - True: 只显示主标签（行业板块用）
    """
    ...
    
    if hot_signal:
        # 🔥 根据参数决定添加主标签还是所有标签
        if simplify_hot_labels:
            # 行业板块模式：只添加主标签
            signals.append(hot_signal['label'])
        else:
            # 个股查询模式：添加所有标签
            if 'labels' in hot_signal and hot_signal['labels']:
                signals.extend(hot_signal['labels'])
            else:
                signals.append(hot_signal['label'])
        signal_score += hot_signal['score']
```

**关键点**：
- `simplify_hot_labels=False`（默认）：兼容现有接口，个股查询显示所有标签
- `simplify_hot_labels=True`：行业板块使用，只添加主标签

---

### 2. 行业板块接口传入参数

**文件**：`backend/app/services/industry_detail_service.py`

```python
# 计算信号（Phase 2）
if signal_calculator:
    signal_data = signal_calculator.calculate_signals(
        stock_code=stock_info.stock_code,
        current_date=query_date,
        current_data=stock_data,
        history_days=7,
        simplify_hot_labels=True  # 🔥 行业板块：简化热点标签
    )
```

**效果**：
- 行业板块中，每只股票的热点信号只计算1个
- signal_count 不再虚高

---

## 📊 修复效果对比

### 修复前（行业板块）
```
招商轮船
- 信号数量：8
- 信号列表：
  1. TOP900·6次    ← 热点
  2. TOP1000·7次   ← 热点
  3. TOP2000·9次   ← 热点
  4. TOP3000·10次  ← 热点
  5. 跳变榜
  6. 稳步上升
  7. 涨幅榜
  8. 成交量榜
```

**问题**：
- 热点信号被计算为4个
- signal_count = 8（虚高）

---

### 修复后（行业板块）
```
招商轮船
- 信号数量：5
- 信号列表：
  1. TOP900·6次    ← 热点（只显示主标签）
  2. 跳变榜
  3. 稳步上升
  4. 涨幅榜
  5. 成交量榜
```

**效果**：
- 热点信号只计算1个（主标签）
- signal_count = 5（准确）
- ✅ **信号系统不被污染**

---

### 个股查询接口（保持不变）
```
招商轮船（个股详情）
- 信号数量：8（保持显示所有标签）
- 信号列表：
  1. TOP900·6次    ← 热点
  2. TOP1000·7次   ← 热点
  3. TOP2000·9次   ← 热点
  4. TOP3000·10次  ← 热点
  5. 跳变榜
  6. 稳步上升
  7. 涨幅榜
  8. 成交量榜
```

**说明**：
- 个股查询接口不传 `simplify_hot_labels`
- 默认 `False`，显示所有热点标签
- ✅ **符合用户设计要求**

---

## 🔍 接口对比

### 个股查询接口
**路由**：`GET /api/stock/{stock_code}`

**调用方式**：
```python
# backend/app/services/stock_service_db.py
signal_result = calculator.calculate_signals(
    stock_code=stock_code,
    current_date=latest_data.date,
    current_data=latest_data,
    history_days=7
    # simplify_hot_labels 默认 False
)
```

**显示**：所有热点标签（TOP100·12次, TOP200·12次等）

---

### 行业板块接口
**路由**：`GET /api/industry/{industry_name}/stocks`

**调用方式**：
```python
# backend/app/services/industry_detail_service.py
signal_data = signal_calculator.calculate_signals(
    stock_code=stock_info.stock_code,
    current_date=query_date,
    current_data=stock_data,
    history_days=7,
    simplify_hot_labels=True  # 🔥 简化
)
```

**显示**：主热点标签（TOP900·6次）

---

## 📌 核心设计原则

### 1. 信号数量统计
```python
'signal_count': len(signals)
```

**准确性**：
- ✅ 每个榜单最多计算1个信号
- ✅ 热点榜、跳变榜、稳步上升榜、涨幅榜、成交量榜、波动率榜
- ✅ 最多6个信号

### 2. 分数计算
```python
score = SignalWeights.HOT_LIST_WEIGHT * multipliers.get(main_tier, 0.5)
```

**准确性**：
- ✅ 始终基于主档位（最小满足条件的档位）
- ✅ 不受标签显示数量影响
- ✅ 修复前后分数计算一致

### 3. 标签显示
```python
# 个股查询
hot_signal = {
    'label': 'TOP900·6次',           # 主标签
    'labels': [                      # 完整标签列表（用于显示）
        'TOP900·6次',
        'TOP1000·7次',
        'TOP2000·9次',
        'TOP3000·10次'
    ],
    'score': 0.25,                   # 基于主档位（TOP900）
    'main_tier': 900                 # 主档位
}

# 行业板块
# 只添加 hot_signal['label'] 到 signals 列表
# labels 列表依然存在，前端可以选择显示
```

---

## ⚙️ 其他接口检查

### 已检查的接口
1. ✅ **个股查询**：`/api/stock/{stock_code}` - 保持显示所有标签
2. ✅ **行业板块**：`/api/industry/{industry_name}/stocks` - 简化为主标签
3. ✅ **跳变榜**：`/api/rank-jump` - 目前未使用信号计算（参数存在但未实现）

---

## 🎯 测试建议

### 1. 行业板块测试
```bash
# 访问工程咨询服务板块
GET /api/industry/工程咨询服务/stocks?calculate_signals=true

# 预期：
# - 每只股票的信号数量准确
# - 热点信号只显示主标签
# - signal_count 不虚高
```

### 2. 个股查询测试
```bash
# 查询招商轮船
GET /api/stock/601872

# 预期：
# - 显示所有热点标签（TOP900·6次, TOP1000·7次等）
# - signal_count 包含所有热点标签
# - 符合设计要求
```

### 3. 对比测试
查看同一只股票在两个接口的信号显示：
- **行业板块**：1个热点信号（主标签）
- **个股查询**：4个热点信号（所有标签）

---

## 📚 总结

### 修复内容
1. ✅ 添加 `simplify_hot_labels` 参数控制标签显示
2. ✅ 行业板块接口传入 `simplify_hot_labels=True`
3. ✅ 个股查询接口保持默认（显示所有标签）

### 效果
- ✅ 行业板块信号数量准确，不再污染
- ✅ 个股查询保持完整显示，符合设计
- ✅ 分数计算始终准确（基于主档位）

### 兼容性
- ✅ 向后兼容：默认参数不影响现有接口
- ✅ 灵活配置：可根据场景选择显示模式

---

**修复时间**：2025-11-25 00:20
**修复人员**：Cascade AI
**测试状态**：待重启服务验证
