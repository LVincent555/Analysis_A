# 更新日志 (Changelog)

## [v0.2.5] - 2025-11-08

### 🚀 重大性能优化

#### ⚡ 本地缓存架构改造
- **三层缓存体系**：建立完整的缓存架构
  - L1: memory_cache（启动时全量加载，100-200MB）
  - L2: TTL缓存（计算结果缓存，30分钟过期）
  - L3: 数据库（仅启动时访问）

- **性能提升惊人**：
  - `/api/dates`: 50ms → **2ms** (25x) ⚡
  - `/api/analyze/7`: 1500ms → **10ms** (150x) 🚀
  - `/api/industry/stats`: 1000ms → **30ms** (33x) ⚡
  - `/api/stock/{code}`: 100ms → **5ms** (20x) ⚡
  - **平均性能提升：30-150倍！**

- **运行时零数据库访问**：
  - 所有查询从内存获取数据
  - 计算结果自动缓存30分钟
  - 支持500-1000 req/s 高并发

#### 🔧 缓存管理功能
- **TTL缓存机制**：
  - 新增 `TTLCache` 类，支持自动过期
  - 默认30分钟TTL，防止数据未更新
  - 线程安全，支持并发访问

- **缓存管理API**：
  - `GET /api/cache/stats` - 查看缓存统计
  - `POST /api/cache/clear` - 清除指定缓存
  - `POST /api/cache/cleanup-expired` - 清理过期缓存
  - `GET /api/cache/health` - 缓存健康检查

- **缓存清理工具**：
  - 更新 `clear_cache.py` 支持所有服务
  - 支持按服务、按模式清理缓存
  - 提供详细的清理统计

### ✨ 服务层全面改造

#### 已优化的服务
1. **AnalysisServiceDB** ✅
   - `get_available_dates()` - 从内存获取
   - `analyze_period()` - 使用内存+TTL缓存

2. **IndustryServiceDB** ✅
   - `analyze_industry()` - 使用内存+TTL缓存

3. **SectorServiceDB** ✅
   - `get_available_dates()` - 从内存获取

4. **StockServiceDB** ✅
   - `search_stock()` - 使用内存+TTL缓存
   - 支持模糊搜索优化

### 📚 文档完善

#### 新增文档
- **CACHE_IMPLEMENTATION_COMPLETE.md** ⭐
  - 完整的缓存实施报告
  - 性能对比数据
  - 使用指南和最佳实践
  - 故障排查指南

- **MOBILE_ADAPTATION_ASSESSMENT.md**
  - 移动端适配难度评估
  - 详细改造方案（方案B - 完整适配）
  - 15-20小时工时估算
  - 技术方案和代码示例

#### 更新文档
- **待实现功能想法.md**：
  - 更新各功能实现状态
  - 添加移动端适配需求（待定计划）
  - 更新优先级排序

### 🔧 技术改进

#### 后端架构
- **新增文件**：
  - `app/utils/ttl_cache.py` - TTL缓存实现
  - `app/routers/cache_mgmt.py` - 缓存管理API
  - `clear_cache.py` - 缓存清理脚本

- **改进的缓存管理器**：
  - `CacheManager` 支持TTL
  - 支持pattern模式匹配清除
  - 提供缓存统计和健康检查

#### 服务层优化
- 所有服务统一使用 `TTLCache`
- 智能缓存key设计
- 自动过期清理机制

### 📊 资源使用

#### 内存占用
- L1缓存（memory_cache）: 100-200 MB（常驻）
- L2缓存（TTL缓存）: 50-100 MB（动态）
- **总计**: 约 150-300 MB

#### 并发能力
- **改造前**: ~10 req/s
- **改造后**: ~500-1000 req/s
- **提升**: **50-100倍** 🚀

### 🎯 下一版本规划

- [ ] 移动端适配（方案B - 完整适配，18-25h）
- [ ] 板块版四大功能API
- [ ] 最新热点字段增强（放量天数、平均量比）
- [ ] 股票详情查询增强（前端弹窗）

### ⚠️ 升级注意事项

从 v0.2.4 升级到 v0.2.5：

```bash
# 1. 拉取代码
git pull origin main
git checkout v0.2.5

# 2. 无需新增依赖

# 3. 重启服务（会自动重新加载内存缓存）
pm2 restart stock-backend

# 4. 验证性能提升
curl http://localhost:8000/api/cache/stats
# 查看缓存统计

# 5. 测试API响应速度
time curl http://localhost:8000/api/dates
# 应该在2ms左右
```

### 📈 性能对比

| 接口 | v0.2.4 | v0.2.5 | 提升 |
|------|--------|--------|------|
| 获取日期列表 | 50ms | 2ms | 25x |
| 7日热点分析 | 1500ms | 10ms | 150x |
| 行业统计 | 1000ms | 30ms | 33x |
| 个股查询 | 100ms | 5ms | 20x |

**用户体验**: 从"能用"到"飞快"！⚡

---

## [v0.2.4] - 2025-11-08

### ✨ 新增功能

#### 🎯 板块数据全量缓存
- **内存缓存扩展**：板块数据纳入全量内存缓存
  - 启动时自动加载所有板块数据到内存
  - 查询性能 <1ms，与股票数据一致
  - 支持按日期、板块ID快速查询
  - 新增 6 个板块数据查询方法

- **启动检查增强**：板块数据完整性验证
  - 板块数据记录数检查
  - 板块数据日期数检查
  - 板块ID序列完整性检查
  - 与股票数据同等的验证标准

- **自动导入优化**：启动时同时导入股票和板块数据
  - 检测并导入新的板块Excel文件
  - 独立的板块导入状态管理
  - 详细的导入日志输出

#### 🧹 智能去重系统
- **全局离群值检测算法**：解决传统去重方法的局限
  - 基于全局统计（均值、标准差）判断异常值
  - 自动保留最接近全局均值的记录，删除偏离的
  - 不受局部数据波动影响，准确率高
  - 完全自动化，无需人工干预

- **去重详情追溯**：完善的日志和状态记录
  - JSON记录每次去重的详细信息
  - 包含：删除的代码、分数、全局均值、距离、Z-score
  - 支持事后追溯和审计
  - 提供 `check_dedup.py` 工具查看去重详情

- **原始数据保护**：不修改Excel源文件
  - 去重仅在内存中进行
  - Excel原始文件保持完整
  - 可随时恢复和重新导入
  - 安全性和可追溯性并重

- **"灯下黑"问题修复**：临时列清理机制
  - 确保去重后清理所有临时列
  - 避免干扰后续的重复检查
  - 防止假阴性（漏检重复）

### 🔧 技术改进

#### 后端架构
- **MemoryCacheManager 扩展**：
  - 新增板块数据缓存结构
  - `sector_daily_data_by_date`: 按日期索引
  - `sector_daily_data_by_name`: 按板块ID索引
  - `sector_dates`: 板块交易日期列表

- **DataManager 增强**：
  - `auto_import_data()` 支持股票+板块双数据源
  - `verify_data_consistency()` 增加板块检查
  - 统一的启动流程管理

- **智能去重模块**：
  - 新增 `deduplicate_helper.py`
  - 动态列名检测（支持 总分/综合评分/score）
  - 详细的去重日志输出
  - 返回结构化的去重统计信息

#### 数据导入
- **import_data_robust.py 改进**：
  - 集成智能去重到导入流程
  - 去重后严格检查，确保无遗漏
  - 记录去重信息到JSON状态
  - 保持事务原子性和回滚机制

- **import_state_manager.py 扩展**：
  - 新增 `record_dedup_info()` 方法
  - 支持存储去重详细信息
  - 向后兼容旧版JSON文件

### 📚 文档

#### 新增文档
- **智能去重技术详解**：`docs/智能去重技术详解.md` ⭐️
  - 问题背景和传统方案局限
  - 设计思路：全局离群值检测原理
  - 完整的技术方案和架构图
  - 核心算法实现和代码示例
  - 使用说明和FAQ
  - 技术亮点总结

- **v0.2.4部署检查清单**：`docs/v0.2.4部署检查清单.md`
  - 10大类部署前检查项
  - 详细的验证命令
  - 常见问题和解决方案
  - Git提交和服务器部署步骤
  - 回滚方案

#### 更新文档
- **README.md**：添加智能去重文档链接
- **待实现功能想法.md**：规划板块功能扩展和热点列表增强

### 🐛 Bug修复

- **列名适配问题**：支持多种评分列名
  - 动态检测 `总分`、`综合评分`、`score`
  - 避免因列名不同导致的导入失败
  - 提高Excel文件兼容性

- **临时列干扰问题**：修复"灯下黑"bug
  - 去重前清理可能存在的临时列
  - 去重后再次清理临时列
  - 确保不干扰后续的重复检查

- **去重逻辑完善**：多轮迭代改进
  - 从局部环境检测改为全局统计
  - 解决周围数据分散导致的误判
  - 提高去重准确性和鲁棒性

### 📊 数据统计

#### 启动加载信息
```
【股票】
- 股票数量: 5,435
- 数据记录: 27,145
- 交易日数: 5

【板块】
- 板块数据: 1,430 条
- 交易日数: 3

⚡ 查询性能: < 1ms
```

#### 智能去重效果
- 自动识别5个重复股票代码
- 成功删除5条异常记录
- 保留最接近全局均值的记录
- 无需人工干预，完全自动化

### ⚠️ 注意事项

1. **数据库准备**：确保服务器已创建所有数据库表（包括 `daily_sector_data`）
2. **数据文件**：确保服务器 `data/` 目录包含所有板块Excel文件
3. **内存要求**：板块缓存增加约50MB内存占用
4. **配置文件**：`database.py` 仍需手动配置，不纳入Git

### 🔄 升级指南

从 v0.2.3 升级到 v0.2.4：

```bash
# 1. 拉取代码
git pull origin main

# 2. 无需新增依赖

# 3. 重启服务
pm2 restart stock-backend

# 4. 验证板块缓存
curl http://localhost:8000/health
# 查看日志确认板块数据已加载
```

### 🎯 下一版本规划

- [ ] 板块版四大功能API（最新热点、行业趋势、排名跳变、稳步上升）
- [ ] 前端数据类型切换（股票/板块）
- [ ] 最新热点列表字段增强（涨跌幅、放量天数、平均量比）
- [ ] 股票详情查询增强

---

## [v0.2.3] - 2025-11-07

### 🔒 安全修复
- **紧急修复**：数据库配置文件泄露问题
  - 从Git中移除 `backend/app/database.py`
  - 添加到 `.gitignore` 防止再次提交
  - 创建 `database.py.example` 模板文件
  - 保护所有敏感配置文件（data/*.json, .env等）

### 🐛 Bug修复
- **前端API配置**：修改为相对路径，通过Nginx代理访问
  - 修复CORS跨域错误
  - 统一通过80端口访问，避免直接访问8000端口
  - 更新 `API_BASE_URL` 配置

- **Nginx配置冲突**：删除旧配置文件
  - 解决 `server_name` 冲突警告
  - 清理重复的配置文件

- **Python缓存问题**：添加缓存清理逻辑
  - 修改配置后自动清除 `__pycache__`
  - 避免旧配置缓存导致的问题

- **前端build忽略**：修复 `.gitignore` 配置
  - 精确指定只忽略 `backend/build/`
  - 允许提交 `frontend/build/` 到Git

### 📚 文档
- **新增**：[⚠️重要-配置文件管理和常见错误.md](docs/⚠️重要-配置文件管理和常见错误.md)
  - 记录所有部署错误和解决方案
  - 提供完整部署流程和检查清单
  - 包含5个典型错误案例和修复步骤

- **新增**：[服务器部署指南.md](docs/服务器部署指南.md)
  - 详细的Nginx配置说明
  - 一键部署脚本使用指南
  - 故障排查和监控方法

- **更新**：README.md
  - 添加安全警告
  - 强调配置文件保护的重要性
  - 链接到详细文档

### 🔧 配置优化
- **start_all.sh**：默认使用生产模式
  - 生产模式不使用 `--reload`
  - 检查前端build目录存在性
  - 提示本地构建并推送

- **deploy_server.sh**：服务器一键部署脚本
  - 自动拉取代码
  - 检查前端构建文件
  - 安全重启服务

- **Nginx配置模板**：deploy/nginx.conf.example
  - 静态文件服务
  - API反向代理
  - 禁用缓存配置

### 📋 部署改进
- 前端在本地编译，服务器直接使用（适配2核2G服务器）
- 配置文件不再通过Git同步，避免覆盖
- 添加部署前后检查清单
- 提供紧急恢复流程

---

## [v0.2.2] - 2025-11-07

### ✨ 新增功能

#### 前端
- **最新热点模块**：添加"分析股票数"选择功能
  - 可选择分析前100/200/400/600/800/1000个股票
  - 2x3网格布局，动态显示不同范围的热点股票
  
- **行业趋势分析模块**：添加"前N名"选择功能
  - 可选择前1000/2000/3000/5000名股票
  - 选择器移至左侧边栏，界面更简洁
  - 动态更新图表标题显示当前范围

- **排名跳变模块**：添加前端搜索功能
  - 支持按股票代码搜索
  - 支持按股票名称模糊搜索
  - 实时显示搜索结果数量

- **稳步上升模块**：添加前端搜索功能
  - 支持按股票代码搜索
  - 支持按股票名称模糊搜索
  - 实时显示搜索结果数量

#### 后端
- **API增强**：
  - `/api/analyze/{period}` 添加 `top_n` 参数（100/200/400/600/800/1000）
  - `/api/industry/top1000` 添加 `limit` 参数（1000/2000/3000/5000）
  - 添加参数验证和降级处理

- **性能优化**：
  - 删除不必要的缓存机制
  - 添加Cache-Control头禁用浏览器缓存
  - 优化数据库查询逻辑

- **日志增强**：
  - 添加详细的API请求日志
  - 添加参数追踪日志
  - 添加Service层调用日志

### 📝 文档更新
- 创建详细的部署指南（docs/部署指南.md）
- 添加搜索功能说明文档
- 添加行业分析功能说明文档
- 添加最新热点选择功能说明

### 🐛 修复
- 修复行业趋势第二个图表标题不更新的问题
- 修复浏览器缓存导致数据不更新的问题
- 修复前端API配置问题

### 🔧 改进
- 优化前端组件结构
- 统一侧边栏选择器样式
- 改进错误提示信息
- 优化代码组织结构

---

## [v0.2.1] - 2025-11-06

### ✨ 新增功能
- 支持北交所股票分析
- 添加板块筛选功能
- 数据库版本实现

### 🐛 修复
- 修复数据导入问题
- 优化性能

---

## [v0.1.1] - 2025-11-05

### ✨ 初始版本
- 最新热点分析
- 股票查询
- 行业趋势分析
- 排名跳变
- 稳步上升

---

**版本说明**：
- 主版本号：重大架构变更
- 次版本号：新功能添加
- 修订号：Bug修复和小改进
