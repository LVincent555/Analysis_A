# æ•°æ®å¯¼å…¥ç³»ç»Ÿå®Œæ•´æ‰‹å†Œ

> **ç‰ˆæœ¬**ï¼šv1.0  
> **æ›´æ–°æ—¥æœŸ**ï¼š2025-11-26  
> **æ•´åˆè‡ª**ï¼šæ¯æ—¥æ•°æ®æ›´æ–°æŒ‡å—ã€æ¿å—æ•°æ®å¯¼å…¥è¯´æ˜ã€æ¿å—æ•°æ®å¿«é€Ÿå¼€å§‹ã€æ•°æ®ç®¡ç†ä½¿ç”¨æŒ‡å—ã€å­¤å„¿æ•°æ®æ¸…ç†è¯´æ˜ã€é…ç½®æ–‡ä»¶ç®¡ç†å’Œå¸¸è§é”™è¯¯

---

## ğŸ“š ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#1-ç³»ç»Ÿæ¦‚è¿°)
2. [æ–‡ä»¶ç»“æ„](#2-æ–‡ä»¶ç»“æ„)
3. [æ•°æ®åº“è®¾è®¡](#3-æ•°æ®åº“è®¾è®¡)
4. [å¿«é€Ÿå¼€å§‹](#4-å¿«é€Ÿå¼€å§‹)
5. [ç»Ÿä¸€CLIå·¥å…·](#5-ç»Ÿä¸€cliå·¥å…·)
6. [è‚¡ç¥¨æ•°æ®å¯¼å…¥](#6-è‚¡ç¥¨æ•°æ®å¯¼å…¥)
7. [æ¿å—æ•°æ®å¯¼å…¥](#7-æ¿å—æ•°æ®å¯¼å…¥)
8. [çŠ¶æ€ç®¡ç†æœºåˆ¶](#8-çŠ¶æ€ç®¡ç†æœºåˆ¶)
9. [æ™ºèƒ½å»é‡æœºåˆ¶](#9-æ™ºèƒ½å»é‡æœºåˆ¶)
10. [å­¤å„¿æ•°æ®æ¸…ç†](#10-å­¤å„¿æ•°æ®æ¸…ç†)
11. [æ•°æ®ä¿®è¡¥å·¥å…·](#11-æ•°æ®ä¿®è¡¥å·¥å…·)
12. [æ•…éšœæ¢å¤](#12-æ•…éšœæ¢å¤)
13. [é…ç½®æ–‡ä»¶ç®¡ç†](#13-é…ç½®æ–‡ä»¶ç®¡ç†)
14. [å¸¸è§é—®é¢˜æ’æŸ¥](#14-å¸¸è§é—®é¢˜æ’æŸ¥)
15. [å®šæ—¶ä»»åŠ¡è®¾ç½®](#15-å®šæ—¶ä»»åŠ¡è®¾ç½®)
16. [æ€§èƒ½å‚è€ƒ](#16-æ€§èƒ½å‚è€ƒ)

---

## 1. ç³»ç»Ÿæ¦‚è¿°

### 1.1 æ ¸å¿ƒè®¾è®¡åŸåˆ™

æ•°æ®å¯¼å…¥ç³»ç»Ÿé‡‡ç”¨å¥å£®çš„è®¾è®¡åŸåˆ™ï¼š

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **åŸå­æ€§** | æ•´ä¸ªæ–‡ä»¶åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå¤±è´¥è‡ªåŠ¨å›æ»š |
| **å¹‚ç­‰æ€§** | åŸºäºçŠ¶æ€æ–‡ä»¶åˆ¤æ–­æ˜¯å¦éœ€è¦å¯¼å…¥ï¼Œé¿å…é‡å¤ |
| **å›æ»šæœºåˆ¶** | å¤±è´¥åå¯å®‰å…¨é‡è¯•ï¼Œä¸ä¼šç•™ä¸‹è„æ•°æ® |
| **æ— ä¾µå…¥æ€§** | ä¸ä¿®æ”¹åŸå§‹Excelå’Œæ•°æ®åº“ç»“æ„ |
| **æ–‡ä»¶æ ¡éªŒ** | MD5å“ˆå¸Œæ£€æµ‹æ–‡ä»¶å˜åŒ– |

### 1.2 æ”¯æŒçš„æ•°æ®ç±»å‹

- **è‚¡ç¥¨æ•°æ®**ï¼šæ¯æ—¥ä¸ªè‚¡æŠ€æœ¯æŒ‡æ ‡ï¼ŒåŒ…å«çº¦5400æ¡è®°å½•/å¤©
- **æ¿å—æ•°æ®**ï¼šæ¯æ—¥æ¿å—æŠ€æœ¯æŒ‡æ ‡ï¼ŒåŒ…å«çº¦500æ¡è®°å½•/å¤©

---

## 2. æ–‡ä»¶ç»“æ„

```
stock_analysis_app/
â”œâ”€â”€ update_daily_data.py              # âœ… ç»Ÿä¸€CLIå…¥å£ï¼ˆå”¯ä¸€ä¸»ç¨‹åºï¼‰
â”œâ”€â”€ update_daily_data.bat             # Windowså¿«æ·å¯åŠ¨
â”œâ”€â”€ update_daily_data.sh              # Linux/Macå¿«æ·å¯åŠ¨
â”‚
â”œâ”€â”€ backend/
â”‚   â””â”€â”€ scripts/
â”‚       â”œâ”€â”€ import_data_robust.py     # è‚¡ç¥¨æ•°æ®å¯¼å…¥æ ¸å¿ƒè„šæœ¬
â”‚       â”œâ”€â”€ import_sectors_robust.py  # æ¿å—æ•°æ®å¯¼å…¥æ ¸å¿ƒè„šæœ¬
â”‚       â”œâ”€â”€ import_state_manager.py   # çŠ¶æ€ç®¡ç†å™¨
â”‚       â”œâ”€â”€ data_importer.py          # å¯¼å…¥è°ƒåº¦å™¨
â”‚       â”œâ”€â”€ data_scanner.py           # æ–‡ä»¶å®Œæ•´æ€§æ‰«æå™¨
â”‚       â”œâ”€â”€ data_cleaner.py           # æ•°æ®æ¸…ç†å™¨
â”‚       â”œâ”€â”€ data_fixer.py             # æ•°æ®ä¿®è¡¥å™¨
â”‚       â””â”€â”€ deduplicate_helper.py     # æ™ºèƒ½å»é‡åŠ©æ‰‹
â”‚
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ data_import_state.json        # è‚¡ç¥¨æ•°æ®å¯¼å…¥çŠ¶æ€
â”‚   â”œâ”€â”€ sector_import_state.json      # æ¿å—æ•°æ®å¯¼å…¥çŠ¶æ€
â”‚   â”œâ”€â”€ YYYYMMDD_data_sma_feature_color.xlsx      # è‚¡ç¥¨æ•°æ®æ–‡ä»¶
â”‚   â””â”€â”€ YYYYMMDD_allbk_sma_feature_color.xlsx     # æ¿å—æ•°æ®æ–‡ä»¶
â”‚
â””â”€â”€ logs/
    â””â”€â”€ update_data_YYYYMMDD_HHMMSS.log  # æ“ä½œæ—¥å¿—
```

---

## 3. æ•°æ®åº“è®¾è®¡

### 3.1 è‚¡ç¥¨è¡¨ç»“æ„

#### stocks è¡¨ï¼ˆè‚¡ç¥¨ä¸»è¡¨ï¼‰
```sql
CREATE TABLE stocks (
    id BIGSERIAL PRIMARY KEY,
    stock_code VARCHAR(10) NOT NULL,    -- è‚¡ç¥¨ä»£ç ï¼ˆ6ä½ï¼‰
    stock_name VARCHAR(50) NOT NULL,    -- è‚¡ç¥¨åç§°
    industry VARCHAR(50),               -- æ‰€å±è¡Œä¸š
    last_updated TIMESTAMP,
    CONSTRAINT uq_stock_code UNIQUE (stock_code)
);
```

#### daily_stock_data è¡¨ï¼ˆè‚¡ç¥¨æ¯æ—¥æ•°æ®ï¼‰
```sql
CREATE TABLE daily_stock_data (
    id BIGSERIAL PRIMARY KEY,
    stock_code VARCHAR(10) REFERENCES stocks(stock_code),
    date DATE NOT NULL,
    rank INTEGER NOT NULL,
    -- 85ä¸ªæŠ€æœ¯æŒ‡æ ‡å­—æ®µï¼ˆåŒ…å«jumpå’Œå¸‚å€¼ï¼‰
    total_score DECIMAL(30, 10),
    open_price DECIMAL(30, 10),
    ...
    CONSTRAINT uq_stock_date UNIQUE (stock_code, date)
);
```

### 3.2 æ¿å—è¡¨ç»“æ„

#### sectors è¡¨ï¼ˆæ¿å—ä¸»è¡¨ï¼‰
```sql
CREATE TABLE sectors (
    id BIGSERIAL PRIMARY KEY,
    sector_name VARCHAR(100) NOT NULL,  -- æ¿å—åç§°ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
    CONSTRAINT uq_sector_name UNIQUE (sector_name)
);
```

#### sector_daily_data è¡¨ï¼ˆæ¿å—æ¯æ—¥æ•°æ®ï¼‰
```sql
CREATE TABLE sector_daily_data (
    id BIGSERIAL PRIMARY KEY,
    sector_id BIGINT REFERENCES sectors(id),
    date DATE NOT NULL,
    rank INTEGER NOT NULL,
    -- 83ä¸ªæŠ€æœ¯æŒ‡æ ‡å­—æ®µï¼ˆä¸å«jumpå’Œå¸‚å€¼ï¼‰
    total_score DECIMAL(30, 10),
    ...
    CONSTRAINT uq_sector_date UNIQUE (sector_id, date)
);
```

### 3.3 è‚¡ç¥¨ä¸æ¿å—æ•°æ®çš„åŒºåˆ«

| ç‰¹æ€§ | è‚¡ç¥¨å¯¼å…¥ | æ¿å—å¯¼å…¥ |
|------|----------|----------|
| **ä¸»è¡¨** | stocks | sectors |
| **æ•°æ®è¡¨** | daily_stock_data | sector_daily_data |
| **å”¯ä¸€æ ‡è¯†** | stock_code (6ä½æ•°å­—) | sector_name (ä¸­æ–‡åç§°) |
| **æ–‡ä»¶æ ¼å¼** | `YYYYMMDD_data_sma_feature_color.xlsx` | `YYYYMMDD_allbk_sma_feature_color.xlsx` |
| **ç‰¹æ®Šå­—æ®µ** | åŒ…å« jump, æ€»å¸‚å€¼ | ä¸åŒ…å«è¿™ä¸¤ä¸ªå­—æ®µ |
| **çŠ¶æ€æ–‡ä»¶** | `data_import_state.json` | `sector_import_state.json` |

---

## 4. å¿«é€Ÿå¼€å§‹

### 4.1 å‡†å¤‡å·¥ä½œæ¸…å•

- [ ] PostgreSQLæ•°æ®åº“å·²å®‰è£…å¹¶è¿è¡Œ
- [ ] æ•°æ®åº“è¿æ¥é…ç½®æ­£ç¡®ï¼ˆ`backend/app/database.py`ï¼‰
- [ ] Pythonç¯å¢ƒå·²å®‰è£…ä¾èµ–ï¼ˆ`pip install -r requirements.txt`ï¼‰
- [ ] æ‰§è¡Œå»ºè¡¨è„šæœ¬ï¼š`psql -U your_user -d your_database -f sql/sectors.sql`

### 4.2 ä¸‰æ­¥å¿«é€Ÿå¯¼å…¥

```bash
# 1. å°†æ–°æ•°æ®æ–‡ä»¶æ”¾å…¥ data/ ç›®å½•
cp /path/to/20251108_*.xlsx stock_analysis_app/data/

# 2. è¿è¡Œå¯¼å…¥è„šæœ¬
python update_daily_data.py

# 3. éªŒè¯å¯¼å…¥ç»“æœ
cat data/data_import_state.json
```

### 4.3 è·¨å¹³å°å¯åŠ¨æ–¹å¼

#### Windows
```cmd
update_daily_data.bat
# æˆ–
python update_daily_data.py
```

#### Linux/Mac
```bash
# é¦–æ¬¡éœ€è¦ç»™äºˆæ‰§è¡Œæƒé™
chmod +x update_daily_data.sh

# è¿è¡Œè„šæœ¬
./update_daily_data.sh
# æˆ–
python update_daily_data.py
```

---

## 5. ç»Ÿä¸€CLIå·¥å…·

`update_daily_data.py` æ˜¯ç³»ç»Ÿçš„ç»Ÿä¸€å…¥å£ï¼Œæ”¯æŒå¤šç§å­å‘½ä»¤ï¼š

### 5.1 å‘½ä»¤é€ŸæŸ¥è¡¨

| å‘½ä»¤ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `import` | å¯¼å…¥æ•°æ®ï¼ˆé»˜è®¤ï¼‰ | `python update_daily_data.py` |
| `scan` | æ‰«ææ–‡ä»¶å®Œæ•´æ€§ | `python update_daily_data.py scan` |
| `clean` | æ¸…ç†å­¤å„¿æ•°æ® | `python update_daily_data.py clean` |
| `delete` | ä¸»åŠ¨åˆ é™¤æŒ‡å®šæ—¥æœŸ | `python update_daily_data.py delete --dates 20251117` |
| `fix` | æ•°æ®ä¿®è¡¥ | `python update_daily_data.py fix --dates 20251117` |

### 5.2 å¯¼å…¥å‘½ä»¤

```bash
# é»˜è®¤å¯¼å…¥ï¼ˆæ¨èï¼‰
python update_daily_data.py

# æ˜ç¡®æŒ‡å®šå¯¼å…¥å‘½ä»¤
python update_daily_data.py import

# è·³è¿‡æ–‡ä»¶æ‰«æ
python update_daily_data.py import --skip-scan
```

### 5.3 æ‰«æå‘½ä»¤

```bash
# æ‰«ææ‰€æœ‰ç±»å‹
python update_daily_data.py scan

# åªæ‰«æè‚¡ç¥¨æ•°æ®
python update_daily_data.py scan --type stock

# åªæ‰«ææ¿å—æ•°æ®
python update_daily_data.py scan --type sector
```

### 5.4 æ¸…ç†å‘½ä»¤

```bash
# æŸ¥çœ‹è­¦å‘Š
python update_daily_data.py clean --scan

# é¢„æ¼”æ¸…ç†
python update_daily_data.py clean --dry-run

# æ‰§è¡Œæ¸…ç†ï¼ˆéœ€ç¡®è®¤ï¼‰
python update_daily_data.py clean

# æ¸…ç†æŒ‡å®šæ—¥æœŸ
python update_daily_data.py clean --dates 20251104,20251105
```

### 5.5 åˆ é™¤å‘½ä»¤

```bash
# é¢„æ¼”åˆ é™¤
python update_daily_data.py delete --dates 20251117 --dry-run

# æ‰§è¡Œåˆ é™¤ï¼ˆéœ€ç¡®è®¤ï¼‰
python update_daily_data.py delete --dates 20251117

# åªåˆ é™¤è‚¡ç¥¨æ•°æ®
python update_daily_data.py delete --dates 20251117 --type stock
```

### 5.6 ä¿®è¡¥å‘½ä»¤

```bash
# æŸ¥çœ‹ä¿®è¡¥å†å²
python update_daily_data.py fix --scan

# é¢„æ¼”ä¿®è¡¥
python update_daily_data.py fix --dates 20251117 --dry-run

# æ‰§è¡Œä¿®è¡¥
python update_daily_data.py fix --dates 20251117

# å›æ»šä¿®è¡¥
python update_daily_data.py fix --rollback --dates 20251117
```

---

## 6. è‚¡ç¥¨æ•°æ®å¯¼å…¥

### 6.1 æ•°æ®æ–‡ä»¶æ ¼å¼

**æ–‡ä»¶å‘½åè§„èŒƒ**ï¼š
```
YYYYMMDD_data_sma_feature_color.xlsx
```

**ç¤ºä¾‹**ï¼š
- `20251105_data_sma_feature_color.xlsx`
- `20251106_data_sma_feature_color.xlsx`

**Excelåˆ—ç»“æ„**ï¼š

| ä»£ç  | åç§° | è¡Œä¸š | æ—¥æœŸ | æ€»åˆ† | å¼€ç›˜ | æœ€é«˜ | ... | jump | æ€»å¸‚å€¼(äº¿) |
|------|------|------|------|------|------|------|-----|------|------------|
| 000001 | å¹³å®‰é“¶è¡Œ | é“¶è¡Œ | 2025-11-05 | 8.5 | 10.20 | 10.45 | ... | 0 | 1823.5 |

### 6.2 æ ¸å¿ƒå¯¼å…¥è„šæœ¬

`import_data_robust.py` æ ¸å¿ƒç‰¹æ€§ï¼š

```python
# Excelåˆ—ååˆ°æ•°æ®åº“å­—æ®µçš„æ˜ å°„
COLUMN_MAPPING = {
    'æ€»åˆ†': 'total_score',
    'å¼€ç›˜': 'open_price',
    'æœ€é«˜': 'high_price',
    'æœ€ä½': 'low_price',
    'close': 'close_price',
    'jump': 'jump',
    'æ¶¨è·Œå¹…': 'price_change',
    'æ¢æ‰‹ç‡%': 'turnover_rate_percent',
    'æ€»å¸‚å€¼(äº¿)': 'market_cap_billions',
    # ... å…±85ä¸ªå­—æ®µ
}
```

### 6.3 ç‹¬ç«‹è¿è¡Œ

```bash
cd backend/scripts
python import_data_robust.py
```

---

## 7. æ¿å—æ•°æ®å¯¼å…¥

### 7.1 æ•°æ®æ–‡ä»¶æ ¼å¼

**æ–‡ä»¶å‘½åè§„èŒƒ**ï¼š
```
YYYYMMDD_allbk_sma_feature_color.xlsx
```

**Excelåˆ—ç»“æ„**ï¼š

| ä»£ç  | åç§° | æ—¥æœŸ | æ€»åˆ† | å¼€ç›˜ | æœ€é«˜ | ... |
|------|------|------|------|------|------|-----|
| å·¥ç¨‹å»ºè®¾ | none | 2025-11-05 | 10.7 | 27763.88 | 28353.92 | ... |

**æ³¨æ„**ï¼š
- **ä»£ç åˆ—**ï¼šæ¿å—åç§°ï¼ˆä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼‰
- **åç§°åˆ—**ï¼šé€šå¸¸ä¸º "none"
- ä¸åŒ…å« `jump` å’Œ `æ€»å¸‚å€¼(äº¿)` å­—æ®µ

### 7.2 é¦–æ¬¡è®¾ç½®

```bash
# 1. åˆ›å»ºæ•°æ®åº“è¡¨
psql -U your_user -d your_database -f sql/sectors.sql

# 2. éªŒè¯è¡¨ç»“æ„
psql -d your_database -c "\dt sectors"
psql -d your_database -c "\dt sector_daily_data"

# 3. å‡†å¤‡æ•°æ®æ–‡ä»¶
ls data/*_allbk_sma_feature_color.xlsx

# 4. è¿è¡Œå¯¼å…¥
cd backend/scripts
python import_sectors_robust.py
```

### 7.3 å¯¼å…¥è¾“å‡ºç¤ºä¾‹

```
============================================================
å¼€å§‹æ¿å—æ•°æ®å¯¼å…¥ä»»åŠ¡ï¼ˆå¥å£®ç‰ˆï¼‰
============================================================
æ‰¾åˆ° 3 ä¸ªæ¿å—æ•°æ®æ–‡ä»¶
ğŸ“‚ æ­£åœ¨å¯¼å…¥æ¿å—æ•°æ®: 20251105_allbk_sma_feature_color.xlsx (æ—¥æœŸ: 2025-11-05)
ğŸ“Š è¯»å–åˆ° 500 ä¸ªæ¿å—è®°å½•
  è¿›åº¦: 100/500 (20.0%)
  è¿›åº¦: 200/500 (40.0%)
  è¿›åº¦: 300/500 (60.0%)
  è¿›åº¦: 400/500 (80.0%)
  è¿›åº¦: 500/500 (100.0%)
âœ… æ–‡ä»¶å¯¼å…¥å®Œæˆ: 20251105_allbk_sma_feature_color.xlsx
   å¯¼å…¥: 500 æ¡, è·³è¿‡: 0 æ¡, è€—æ—¶: 5.2ç§’
============================================================
âœ… æ¿å—æ•°æ®å¯¼å…¥ä»»åŠ¡å®Œæˆï¼
æ–‡ä»¶ç»Ÿè®¡: æˆåŠŸ=3, å¤±è´¥=0
æ•°æ®ç»Ÿè®¡: å¯¼å…¥=1500, è·³è¿‡=0
============================================================
```

---

## 8. çŠ¶æ€ç®¡ç†æœºåˆ¶

### 8.1 çŠ¶æ€æ–‡ä»¶ç»“æ„

**data_import_state.json / sector_import_state.json**ï¼š

```json
{
  "version": "1.1",
  "created_at": "2025-11-07T20:00:00",
  "last_updated": "2025-11-08T09:00:00",
  "fix_config": {
    "turnover_rate_fix": {
      "enabled": true,
      "auto_fix": true,
      "threshold": 0.01,
      "multiplier": 10000
    }
  },
  "imports": {
    "20251105": {
      "filename": "20251105_data_sma_feature_color.xlsx",
      "status": "success",
      "file_hash": "abc123def456...",
      "start_time": "2025-11-07T20:00:00",
      "end_time": "2025-11-07T20:00:15",
      "duration_seconds": 15.2,
      "imported_count": 5430,
      "skipped_count": 0,
      "attempt_count": 1,
      "dedup_info": null,
      "data_fixes": {},
      "warning_info": null,
      "deletion_info": null
    }
  }
}
```

### 8.2 çŠ¶æ€åˆ†ç±»

| çŠ¶æ€ | å›¾æ ‡ | è¯´æ˜ | å¤„ç†æ–¹å¼ |
|------|------|------|----------|
| `success` | âœ… | å¯¼å…¥æˆåŠŸ | æ­£å¸¸çŠ¶æ€ |
| `failed` | âŒ | å¯¼å…¥å¤±è´¥ | ä¿®å¤æ•°æ®æ–‡ä»¶åé‡æ–°å¯¼å…¥ |
| `warning` | âš ï¸ | æ–‡ä»¶ç¼ºå¤±/å˜æ›´ | ä½¿ç”¨cleanå‘½ä»¤æ¸…ç† |
| `deleted` | ğŸ—‘ï¸ | å·²æ¸…ç† | è®°å½•çŠ¶æ€ï¼Œæ•°æ®å·²åˆ é™¤ |
| `in_progress` | â³ | å¯¼å…¥ä¸­ | ä¸´æ—¶çŠ¶æ€ |
| `rolled_back` | ğŸ”„ | å·²å›æ»š | å¯å®‰å…¨é‡è¯• |

### 8.3 å¹‚ç­‰æ€§ä¿è¯

```python
# çŠ¶æ€ç®¡ç†å™¨åˆ¤æ–­æ˜¯å¦éœ€è¦å¯¼å…¥
def should_reimport(date_str: str, file_path: Path) -> bool:
    """
    åœºæ™¯åˆ¤æ–­ï¼š
    1. ä»æœªå¯¼å…¥è¿‡ â†’ éœ€è¦å¯¼å…¥
    2. ä¸Šæ¬¡å¤±è´¥ â†’ éœ€è¦é‡æ–°å¯¼å…¥
    3. æ–‡ä»¶å·²å˜åŒ–ï¼ˆå“ˆå¸Œä¸åŒï¼‰â†’ éœ€è¦é‡æ–°å¯¼å…¥
    4. ä¸Šæ¬¡æˆåŠŸä¸”æ–‡ä»¶æœªå˜ â†’ ä¸éœ€è¦å¯¼å…¥ï¼ˆè·³è¿‡ï¼‰
    5. å·²åˆ é™¤(deleted) â†’ éœ€è¦å¯¼å…¥
    6. å·²å›æ»š(rolled_back) â†’ éœ€è¦å¯¼å…¥
    """
```

### 8.4 ç¬¬ä¸€æ¬¡ vs ç¬¬äºŒæ¬¡è¿è¡Œ

**ç¬¬ä¸€æ¬¡è¿è¡Œ**ï¼š
```bash
$ python import_sectors_robust.py
ğŸ“‚ æ­£åœ¨å¯¼å…¥æ¿å—æ•°æ®: 20251105_allbk_sma_feature_color.xlsx
âœ… æ–‡ä»¶å¯¼å…¥å®Œæˆ: å¯¼å…¥ 500 æ¡
```

**ç¬¬äºŒæ¬¡è¿è¡Œï¼ˆè·³è¿‡å·²å¯¼å…¥ï¼‰**ï¼š
```bash
$ python import_sectors_robust.py
â­ï¸  è·³è¿‡æ–‡ä»¶ï¼ˆå·²æˆåŠŸå¯¼å…¥ï¼‰: 20251105_allbk_sma_feature_color.xlsx
```

---

## 9. æ™ºèƒ½å»é‡æœºåˆ¶

### 9.1 è‡ªåŠ¨å»é‡ç­–ç•¥

åœ¨å¯¼å…¥è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿä¼š**è‡ªåŠ¨æ£€æµ‹å¹¶å»é™¤æ˜æ˜¾å¼‚å¸¸çš„é‡å¤æ•°æ®**ï¼š

**å»é‡æ¡ä»¶ï¼ˆä¸¥æ ¼ï¼‰ï¼š**
1. âœ… æ£€æµ‹åŒä¸€è‚¡ç¥¨ä»£ç å‡ºç°å¤šæ¬¡
2. âœ… è®¡ç®—æ¯æ¡è®°å½•ä¸å‘¨å›´æ•°æ®çš„åç¦»åº¦
3. âœ… åªåˆ é™¤æ˜æ˜¾å¼‚å¸¸çš„è®°å½•ï¼ˆåç¦» > 2Ïƒï¼‰
4. âœ… åˆ†æ•°å·®å¼‚å¿…é¡» > 0.3

### 9.2 å»é‡ç¤ºä¾‹

```
æ£€æµ‹åˆ°é‡å¤: 300695ï¼ˆå…†ä¸°è‚¡ä»½ï¼‰
- è¡Œ3138: åˆ†æ•°=-4.7, å‘¨å›´å‡å€¼=-4.7, åç¦»=0.1Ïƒ âœ… ä¿ç•™
- è¡Œ3139: åˆ†æ•°=-4.2, å‘¨å›´å‡å€¼=-4.7, åç¦»=2.5Ïƒ âŒ åˆ é™¤ï¼ˆå¼‚å¸¸ï¼‰

ç»“æœ: è‡ªåŠ¨å»é™¤è¡Œ3139ï¼Œä¿ç•™æ­£å¸¸æ•°æ®
```

### 9.3 å»é‡åä»æœ‰é‡å¤

å¦‚æœè‡ªåŠ¨å»é‡åä»æœ‰é‡å¤ï¼š
- è§¦å‘ERRORï¼Œå¯¼å…¥å¤±è´¥
- éœ€è¦äººå·¥æ£€æŸ¥Excelæ–‡ä»¶
- å®Œæ•´å›æ»šï¼Œä¸å½±å“æ•°æ®åº“

```
âŒ Excelæ–‡ä»¶ä¸­å­˜åœ¨é‡å¤çš„è‚¡ç¥¨ä»£ç ï¼ˆå»é‡åä»å­˜åœ¨ï¼‰: 300614
   è‚¡ç¥¨ 300614 å‡ºç°äº† 2 æ¬¡ï¼Œåœ¨è¡Œ: [100, 200]

å¤„ç†æ–¹å¼ï¼š
1. æ‰“å¼€Excelæ£€æŸ¥è¿™ä¸¤è¡Œæ•°æ®
2. æ‰‹åŠ¨åˆ é™¤å…¶ä¸­ä¸€è¡Œ
3. é‡æ–°å¯¼å…¥
```

---

## 10. å­¤å„¿æ•°æ®æ¸…ç†

### 10.1 ä»€ä¹ˆæ˜¯å­¤å„¿æ•°æ®

å½“Excelæ–‡ä»¶è¢«åˆ é™¤æˆ–ä¿®æ”¹åï¼Œæ•°æ®åº“ä¸­å¯èƒ½ä»ç„¶ä¿ç•™ç€å¯¹åº”çš„æ•°æ®ï¼Œè¿™äº›å°±æ˜¯"å­¤å„¿æ•°æ®"ã€‚

### 10.2 è­¦å‘Šç±»å‹

| è­¦å‘Šç±»å‹ | è¯´æ˜ | å»ºè®®æ“ä½œ |
|----------|------|----------|
| `file_missing` | Excelæ–‡ä»¶å·²åˆ é™¤ï¼Œä½†æ•°æ®åº“ä»æœ‰æ•°æ® | `delete_db_data` |
| `file_changed` | Excelæ–‡ä»¶å·²è¢«ä¿®æ”¹ï¼Œä¸å¯¼å…¥æ—¶ä¸ä¸€è‡´ | `reimport_or_delete` |
| `rollback_residue` | å›æ»šçŠ¶æ€ï¼Œå¯èƒ½æœ‰æ•°æ®åº“æ®‹ç•™ | æ£€æŸ¥å¹¶æ¸…ç† |

### 10.3 æ¸…ç†å·¥ä½œæµ

```bash
# æ­¥éª¤1ï¼šè¿è¡Œå¯¼å…¥ï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼‰
python update_daily_data.py

# æ­¥éª¤2ï¼šæŸ¥çœ‹è­¦å‘Š
python update_daily_data.py clean --scan

# æ­¥éª¤3ï¼šé¢„æ¼”æ¸…ç†
python update_daily_data.py clean --dry-run

# æ­¥éª¤4ï¼šæ‰§è¡Œæ¸…ç†ï¼ˆéœ€ç¡®è®¤ï¼‰
python update_daily_data.py clean
# ç¡®è®¤ï¼Ÿ(yes/no): yes
```

### 10.4 å®‰å…¨æœºåˆ¶

1. âœ… **åªå¤„ç†warningçŠ¶æ€**ï¼šfailedçŠ¶æ€ä¸ä¼šè¢«æ¸…ç†
2. âœ… **äºŒæ¬¡ç¡®è®¤**ï¼šçœŸå®åˆ é™¤å‰éœ€è¦è¾“å…¥ç¡®è®¤
3. âœ… **é¢„æ¼”æ¨¡å¼**ï¼šå¯ä»¥å…ˆæŸ¥çœ‹å°†åˆ é™¤ä»€ä¹ˆ
4. âœ… **å®Œæ•´æ—¥å¿—**ï¼šæ‰€æœ‰æ“ä½œéƒ½æœ‰è¯¦ç»†æ—¥å¿—
5. âœ… **çŠ¶æ€è¿½è¸ª**ï¼šJSONæ–‡ä»¶è®°å½•å®Œæ•´çš„åˆ é™¤å†å²

---

## 11. æ•°æ®ä¿®è¡¥å·¥å…·

### 11.1 æ”¯æŒçš„ä¿®è¡¥ç±»å‹

ç›®å‰æ”¯æŒ**æ¢æ‰‹ç‡æ•°æ®ä¿®è¡¥**ï¼š
- æ£€æµ‹æ¢æ‰‹ç‡æ•°æ®æ˜¯å¦å¼‚å¸¸ï¼ˆå¦‚å°æ•°ç‚¹é”™ä½ï¼‰
- è‡ªåŠ¨æˆ–æ‰‹åŠ¨ä¿®è¡¥

### 11.2 ä¿®è¡¥å·¥ä½œæµ

```bash
# æŸ¥çœ‹ä¿®è¡¥å†å²
python update_daily_data.py fix --scan

# é¢„æ¼”ä¿®è¡¥
python update_daily_data.py fix --dates 20251117 --dry-run

# æ‰§è¡Œä¿®è¡¥
python update_daily_data.py fix --dates 20251117

# å›æ»šä¿®è¡¥
python update_daily_data.py fix --rollback --dates 20251117
```

### 11.3 ä¿®è¡¥é…ç½®

åœ¨çŠ¶æ€æ–‡ä»¶ä¸­é…ç½®ï¼š

```json
{
  "fix_config": {
    "turnover_rate_fix": {
      "enabled": true,
      "auto_fix": true,
      "threshold": 0.01,
      "multiplier": 10000
    }
  }
}
```

---

## 12. æ•…éšœæ¢å¤

### 12.1 å¯¼å…¥ä¸­æ–­ï¼ˆæ–­ç”µ/ç½‘ç»œæ•…éšœï¼‰

```bash
# ç›´æ¥é‡æ–°è¿è¡Œï¼Œäº‹åŠ¡å›æ»šä¿è¯æ•°æ®å®Œæ•´æ€§
python update_daily_data.py
```

**ç»“æœ**ï¼šå¤±è´¥çš„æ–‡ä»¶ä¼šè‡ªåŠ¨é‡è¯•ï¼Œå·²æˆåŠŸçš„æ–‡ä»¶ä¼šè·³è¿‡

### 12.2 å¼ºåˆ¶é‡æ–°å¯¼å…¥æŸå¤©æ•°æ®

**æ–¹æ³•1ï¼šåˆ é™¤æ•°æ®åº“è®°å½•**
```bash
python update_daily_data.py delete --dates 20251108

# ç„¶åé‡æ–°å¯¼å…¥
python update_daily_data.py
```

**æ–¹æ³•2ï¼šåˆ é™¤çŠ¶æ€æ–‡ä»¶è®°å½•**
```bash
# ç¼–è¾‘çŠ¶æ€æ–‡ä»¶ï¼Œåˆ é™¤å¯¹åº”æ—¥æœŸçš„æ¡ç›®
nano data/data_import_state.json

# é‡æ–°è¿è¡Œ
python update_daily_data.py
```

### 12.3 æ•°æ®åº“è¿æ¥å¤±è´¥

1. æ£€æŸ¥ `backend/app/database.py` é…ç½®
2. ç¡®è®¤æ•°æ®åº“æœåŠ¡æ­£åœ¨è¿è¡Œ
3. éªŒè¯æ•°æ®åº“å‡­æ®æ˜¯å¦æ­£ç¡®

```bash
# æµ‹è¯•è¿æ¥
cd backend
python3 -c "from app.database import test_connection; test_connection()"
```

### 12.4 æ•°æ®è¢«æ±¡æŸ“

```bash
# 1. è¿æ¥æ•°æ®åº“
psql -h localhost -U postgres -d your_database

# 2. åˆ é™¤æ‰€æœ‰æ•°æ®
TRUNCATE TABLE daily_stock_data CASCADE;
TRUNCATE TABLE stocks CASCADE;
TRUNCATE TABLE sector_daily_data CASCADE;
TRUNCATE TABLE sectors CASCADE;

# 3. åˆ é™¤çŠ¶æ€æ–‡ä»¶
rm data/data_import_state.json
rm data/sector_import_state.json

# 4. é‡æ–°å¯¼å…¥
python update_daily_data.py
```

---

## 13. é…ç½®æ–‡ä»¶ç®¡ç†

### 13.1 å¿…é¡»ä¿æŠ¤çš„æ–‡ä»¶ï¼ˆç»ä¸æäº¤åˆ°Gitï¼‰

```
âš ï¸ æ•°æ®åº“é…ç½®
backend/app/database.py           # æ•°æ®åº“è¿æ¥é…ç½®
backend/.env                      # ç¯å¢ƒå˜é‡æ–‡ä»¶

âš ï¸ æ•°æ®å’ŒçŠ¶æ€æ–‡ä»¶
data/*.json                       # æ‰€æœ‰JSONé…ç½®
data/data_import_state.json       # æ•°æ®å¯¼å…¥çŠ¶æ€
data/sector_import_state.json     # æ¿å—å¯¼å…¥çŠ¶æ€

âš ï¸ æ—¥å¿—å’Œè¿è¡Œæ—¶æ–‡ä»¶
logs/                             # æ—¥å¿—ç›®å½•
*.log                             # æ—¥å¿—æ–‡ä»¶
```

### 13.2 éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

#### æœ¬åœ°å‡†å¤‡
- [ ] ç¡®è®¤ `.gitignore` åŒ…å«æ‰€æœ‰é…ç½®æ–‡ä»¶
- [ ] æ£€æŸ¥ `git status` æ²¡æœ‰é…ç½®æ–‡ä»¶
- [ ] ç¼–è¯‘å‰ç«¯ï¼š`cd frontend && npm run build`

#### æœåŠ¡å™¨éƒ¨ç½²
- [ ] å¤‡ä»½æœåŠ¡å™¨é…ç½®ï¼š
  ```bash
  cp backend/app/database.py ~/database.py.backup
  cp data/data_import_state.json ~/data_import_state.json.backup
  ```
- [ ] æ‹‰å–ä»£ç ï¼š`git pull`
- [ ] æ¢å¤é…ç½®ï¼ˆå¦‚æœè¢«è¦†ç›–ï¼‰

### 13.3 é¦–æ¬¡æœåŠ¡å™¨é…ç½®

```bash
# å¤åˆ¶æ¨¡æ¿
cp backend/app/database.py.example backend/app/database.py

# ç¼–è¾‘é…ç½®
nano backend/app/database.py

# ä¿®æ”¹ä¸ºå®é™…å€¼
DB_HOST = "localhost"
DB_PORT = "5432"
DB_NAME = "your_database_name"
DB_USER = "your_username"
DB_PASSWORD = "your_password"
```

---

## 14. å¸¸è§é—®é¢˜æ’æŸ¥

### Q1: æ²¡æœ‰æ‰¾åˆ°æ•°æ®æ–‡ä»¶

**ç—‡çŠ¶**ï¼š
```
âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¾…å¯¼å…¥çš„æ•°æ®æ–‡ä»¶
```

**è§£å†³**ï¼š
1. æ£€æŸ¥æ•°æ®æ–‡ä»¶æ˜¯å¦åœ¨ `data/` ç›®å½•
2. æ£€æŸ¥æ–‡ä»¶å‘½åæ ¼å¼æ˜¯å¦æ­£ç¡®
3. ç¡®è®¤æ–‡ä»¶æ‰©å±•åä¸º `.xlsx`

### Q2: æ•°æ®åº“è¿æ¥å¤±è´¥

**ç—‡çŠ¶**ï¼š
```
âŒ æ•°æ®åº“è¿æ¥å¤±è´¥
```

**è§£å†³**ï¼š
1. æ£€æŸ¥ `backend/app/database.py` é…ç½®
2. ç¡®è®¤æ•°æ®åº“æœåŠ¡æ­£åœ¨è¿è¡Œ
3. éªŒè¯æ•°æ®åº“å‡­æ®

### Q3: é‡å¤æ•°æ®é”™è¯¯

**åœºæ™¯1ï¼šè‡ªåŠ¨å»é‡æˆåŠŸ**
```
ğŸ“Š è¯»å–åˆ° 5434 æ¡è®°å½•
âš ï¸  æ£€æµ‹åˆ° 1 ä¸ªé‡å¤çš„è‚¡ç¥¨ä»£ç 
  [å»é‡] è‚¡ç¥¨ 300695(å…†ä¸°è‚¡ä»½) è¡Œ3139 åˆ†æ•°=-4.2 â†’ åˆ é™¤
ğŸ“Š å»é‡åå‰©ä½™ 5433 æ¡è®°å½•
âœ… å¯¼å…¥æˆåŠŸ
```

**åœºæ™¯2ï¼šå»é‡åä»æœ‰é‡å¤ï¼ˆéœ€äººå·¥å¤„ç†ï¼‰**
```
âŒ Excelæ–‡ä»¶ä¸­å­˜åœ¨é‡å¤çš„è‚¡ç¥¨ä»£ç ï¼ˆå»é‡åä»å­˜åœ¨ï¼‰: 300614

å¤„ç†æ–¹å¼ï¼š
1. æ‰“å¼€Excelæ£€æŸ¥é‡å¤è¡Œ
2. æ‰‹åŠ¨åˆ é™¤å…¶ä¸­ä¸€è¡Œ
3. é‡æ–°å¯¼å…¥
```

### Q4: Pythonç¼“å­˜é—®é¢˜

**ç—‡çŠ¶**ï¼šä¿®æ”¹é…ç½®åä»ä½¿ç”¨æ—§é…ç½®

**è§£å†³**ï¼š
```bash
# æ¸…é™¤æ‰€æœ‰Pythonç¼“å­˜
find backend -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null
find backend -name "*.pyc" -delete

# é‡å¯æœåŠ¡
bash stop.sh && bash start_all.sh
```

### Q5: warningçŠ¶æ€èƒ½æ¢å¤å—ï¼Ÿ

**å¯ä»¥**ã€‚å¦‚æœæ–‡ä»¶è¿˜åœ¨ï¼š
1. é‡æ–°æ”¾å›Excelæ–‡ä»¶
2. å†æ¬¡è¿è¡Œå¯¼å…¥
3. æˆ–æ‰‹åŠ¨ç¼–è¾‘JSONï¼Œå°†statusæ”¹å›success

### Q6: åˆ é™¤åèƒ½æ¢å¤å—ï¼Ÿ

**ä¸èƒ½**ã€‚æ¸…ç†æ˜¯ç¡¬åˆ é™¤ï¼Œæ•°æ®æ°¸ä¹…ä¸¢å¤±ã€‚å»ºè®®å…ˆä½¿ç”¨ `--dry-run` é¢„æ¼”ã€‚

---

## 15. å®šæ—¶ä»»åŠ¡è®¾ç½®

### 15.1 Linux Crontab

æ¯å¤©æ—©ä¸Š9ç‚¹è‡ªåŠ¨æ‰§è¡Œï¼š

```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ å®šæ—¶ä»»åŠ¡
0 9 * * * cd /path/to/stock_analysis_app && ./update_daily_data.sh >> logs/cron.log 2>&1
```

### 15.2 Windowsä»»åŠ¡è®¡åˆ’ç¨‹åº

1. æ‰“å¼€"ä»»åŠ¡è®¡åˆ’ç¨‹åº"
2. åˆ›å»ºåŸºæœ¬ä»»åŠ¡
3. è§¦å‘å™¨ï¼šæ¯å¤© 09:00
4. æ“ä½œï¼šå¯åŠ¨ç¨‹åº
   - ç¨‹åºï¼š`C:\path\to\stock_analysis_app\update_daily_data.bat`
   - èµ·å§‹ä½ç½®ï¼š`C:\path\to\stock_analysis_app`

---

## 16. æ€§èƒ½å‚è€ƒ

### 16.1 å¯¼å…¥æ€§èƒ½

| æ•°æ®ç±»å‹ | æ•°æ®é‡ | å¯¼å…¥æ—¶é—´ |
|---------|--------|---------|
| è‚¡ç¥¨æ•°æ® | ~5400æ¡/å¤© | ~15ç§’ |
| æ¿å—æ•°æ® | ~500æ¡/å¤© | ~5ç§’ |
| **æ€»è®¡** | **~5900æ¡/å¤©** | **~20ç§’** |

### 16.2 å­˜å‚¨ä¼°ç®—

| åœºæ™¯ | æ•°æ®é‡ | é¢„è®¡å¤§å° |
|------|--------|----------|
| 30å¤©å†å²æ•°æ® | ~18ä¸‡æ¡ | ~50MB |
| 365å¤©å†å²æ•°æ® | ~215ä¸‡æ¡ | ~600MB |
| 3å¹´å†å²æ•°æ® | ~645ä¸‡æ¡ | ~1.8GB |

---

## é™„å½•ï¼šSQLéªŒè¯æŸ¥è¯¢

### æ£€æŸ¥è‚¡ç¥¨æ•°æ®

```sql
-- æ£€æŸ¥æ¯æ—¥æ•°æ®é‡
SELECT date, COUNT(*) 
FROM daily_stock_data 
GROUP BY date 
ORDER BY date DESC 
LIMIT 10;

-- æ£€æŸ¥ç‰¹å®šè‚¡ç¥¨å†å²
SELECT date, rank, total_score, price_change
FROM daily_stock_data
WHERE stock_code = '000001'
ORDER BY date DESC
LIMIT 30;
```

### æ£€æŸ¥æ¿å—æ•°æ®

```sql
-- æ£€æŸ¥æ¿å—æ€»æ•°
SELECT COUNT(*) FROM sectors;

-- æ£€æŸ¥ä»Šæ—¥æ’åå‰10
SELECT 
    s.sector_name,
    sd.rank,
    sd.total_score,
    sd.price_change
FROM sector_daily_data sd
JOIN sectors s ON sd.sector_id = s.id
WHERE sd.date = '2025-11-05'
ORDER BY sd.rank
LIMIT 10;

-- æ£€æŸ¥æ¿å—å†å²
SELECT date, rank, total_score, price_change
FROM sector_daily_data
WHERE sector_id = (SELECT id FROM sectors WHERE sector_name = 'å·¥ç¨‹å»ºè®¾')
ORDER BY date DESC
LIMIT 30;
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼š
1. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ `logs/update_data_*.log`
2. æ£€æŸ¥çŠ¶æ€æ–‡ä»¶ `data/data_import_state.json`
3. å‚è€ƒæœ¬æ–‡æ¡£å¯¹åº”ç« èŠ‚

---

**ç‰ˆæƒä¿¡æ¯**ï¼šStock Analysis Team Â© 2025
