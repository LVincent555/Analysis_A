# æ•°æ®åº“è¿ç§»è§„åˆ’ - ç‰ˆæœ¬å‘å¸ƒå‰å‡†å¤‡

> **æ–‡æ¡£ç›®çš„**: ç†æ¸…æœ¬åœ°å¼€å‘ç¯å¢ƒä¸æœåŠ¡å™¨ç¯å¢ƒçš„æ•°æ®åº“å·®å¼‚ï¼Œè§„åˆ’æœ¬åœ°å¤šå¯¹å¤šåˆ†ææ•°æ®è¿ç§»åˆ°æœåŠ¡å™¨çš„æ–¹æ¡ˆ
> 
> **æœ€åæ›´æ–°**: 2025-12-24

---

## 0. ä½ çš„é—®é¢˜è§£ç­”

### Q1: æœåŠ¡å™¨ç”¨æˆ·æ¯”æœ¬åœ°å¤šï¼Œå¯¼å‡ºæ•°æ®åèƒ½ç›´æ¥è¦†ç›–å¯¼å…¥å—ï¼Ÿ

> [!CAUTION]
> **ä¸èƒ½ç›´æ¥è¦†ç›–ï¼** ä»¥ä¸‹è¡¨å¿…é¡»ä¿ç•™æœåŠ¡å™¨æ•°æ®ï¼š

| è¡¨å | æœ¬åœ° | æœåŠ¡å™¨ | ç­–ç•¥ |
|------|------|--------|------|
| `users` | 2 æ¡ | **4 æ¡** | âŒ ä¸è¦†ç›–ï¼Œä¿ç•™æœåŠ¡å™¨ |
| `user_sessions` | 11 æ¡ | **13 æ¡** | âŒ ä¸è¦†ç›–ï¼Œä¿ç•™æœåŠ¡å™¨ |
| `user_roles` | - | - | âŒ ä¸è¦†ç›–ï¼Œä¿ç•™æœåŠ¡å™¨ |
| `operation_logs` | 2 æ¡ | - | âš ï¸ å¯é€‰ï¼Œå»ºè®®ä¸è¦†ç›– |
| `system_configs` | 33 æ¡ | 17 æ¡ | âš ï¸ åˆå¹¶ï¼Œç”¨ `ON CONFLICT DO NOTHING` |
| `roles` | 4 æ¡ | 4 æ¡ | âš ï¸ åˆå¹¶ï¼Œç”¨ `ON CONFLICT DO UPDATE` |

**å¯ä»¥å®‰å…¨è¦†ç›–çš„è¡¨**ï¼ˆåªå­˜åœ¨äºæœ¬åœ°ï¼ŒæœåŠ¡å™¨æ²¡æœ‰ï¼‰ï¼š

| è¡¨å | æ•°æ®é‡ | è¯´æ˜ |
|------|--------|------|
| `ext_providers` | 2 æ¡ | æ•°æ®æºå®šä¹‰ |
| `ext_board_list` | 527 æ¡ | æ¿å—åˆ—è¡¨ |
| `ext_board_daily_snap` | **122,403 æ¡** | è‚¡ç¥¨-æ¿å—å¿«ç…§ï¼ˆæ ¸å¿ƒæ•°æ®ï¼‰ |
| `ext_board_heat_daily` | **18,499 æ¡** | æ¿å—çƒ­åº¦ |
| `ext_board_local_map` | 527 æ¡ | æ˜ å°„å…³ç³» |
| `board_blacklist` | 30 æ¡ | é»‘åå• |
| `cache_stock_board_signal` | **196,333 æ¡** | ETL ç¼“å­˜ç»“æœ |

---

### Q2: éœ€è¦æ‰§è¡Œ sql æ–‡ä»¶å¤¹ä¸‹çš„å“ªäº› SQL æ–‡ä»¶ï¼Ÿ

> [!TIP]
> **åªéœ€è¦æ‰§è¡Œä¸€ä¸ªæ–‡ä»¶ï¼** æˆ‘å·²åˆ›å»ºä¸€é”®å‡çº§è„šæœ¬ã€‚

```
sql/server/
â”œâ”€â”€ V0.6.0_æ•°æ®åº“å‡çº§è„šæœ¬.sql   # âœ… ä¸€é”®æ‰§è¡Œè¿™ä¸ªå³å¯ï¼
â”œâ”€â”€ public-local.sql            # ğŸ“‹ å¯¹æ¯”ç”¨ï¼ˆæœ¬åœ°å¯¼å‡ºå¤‡ä»½ï¼‰
â”œâ”€â”€ public-server.sql           # ğŸ“‹ å¯¹æ¯”ç”¨ï¼ˆæœåŠ¡å™¨å¯¼å‡ºå¤‡ä»½ï¼‰
â””â”€â”€ upgrade_ext_boards.sql      # âŒ ä¸éœ€è¦ï¼ˆå·²åˆå¹¶åˆ°ä¸€é”®è„šæœ¬ï¼‰
```

**æ‰§è¡Œå‘½ä»¤**ï¼š

```bash
psql -U postgres -d db_20251106_analysis_a -f "sql/server/V0.6.0_æ•°æ®åº“å‡çº§è„šæœ¬.sql"

# æˆ–åœ¨ Navicat ä¸­ç›´æ¥æ‰“å¼€æ‰§è¡Œ
```

è„šæœ¬ç‰¹ç‚¹ï¼š
- âœ… **å¹‚ç­‰è®¾è®¡** - å¯é‡å¤æ‰§è¡Œï¼Œä¸ä¼šæŠ¥é”™
- âœ… **äº‹åŠ¡ä¿æŠ¤** - å¤±è´¥è‡ªåŠ¨å›æ»š
- âœ… **å®Œæ•´åŒ…å«** - è¡¨ç»“æ„ + ç´¢å¼• + è§†å›¾ + åˆå§‹æ•°æ® + ç³»ç»Ÿé…ç½®

---

### Q3: æ‰§è¡Œå®Œ SQL æ–‡ä»¶åï¼ŒæœåŠ¡å™¨éœ€è¦æ”¹åŠ¨ä»€ä¹ˆé…ç½®å—ï¼Ÿ

> [!TIP]
> **ä¸éœ€è¦æ”¹åŠ¨ä»»ä½•é…ç½®ï¼** åç«¯ä»£ç å·²ç»å‡†å¤‡å¥½äº†ã€‚

åç«¯ `main.py` å·²æ³¨å†Œä»¥ä¸‹è·¯ç”±ï¼š
```python
app.include_router(ext_board_mgmt_router)  # å¤–éƒ¨æ¿å—åŒæ­¥æ¨¡å—
app.include_router(board_heat_router)      # æ¿å—çƒ­åº¦APIï¼ˆå¤šå¯¹å¤šç³»ç»Ÿï¼‰
```

åªè¦æ•°æ®åº“è¡¨ç»“æ„å­˜åœ¨ï¼Œè¿™äº› API å°±èƒ½æ­£å¸¸å·¥ä½œã€‚

**å”¯ä¸€å¯èƒ½éœ€è¦çš„æ“ä½œ**ï¼šå¦‚æœæœåŠ¡å™¨æ˜¯ Docker éƒ¨ç½²ï¼Œå¯èƒ½éœ€è¦é‡å¯å®¹å™¨è®©æ–°ä»£ç ç”Ÿæ•ˆï¼š
```bash
docker-compose restart backend
```

---

## 1. æ•°æ®é‡å¯¹æ¯”ï¼ˆæ ¹æ®ä½ çš„æˆªå›¾ï¼‰

| è¡¨å | æœ¬åœ° | æœåŠ¡å™¨ | å·®å¼‚ |
|------|------|--------|------|
| `stocks` | 5,430 | 5,435 | æœåŠ¡å™¨å¤š 5 åªè‚¡ç¥¨ |
| `daily_stock_data` | 195,440 | **200,867** | æœåŠ¡å™¨å¤š ~5,400 æ¡ |
| `sectors` | 478 | 478 | ä¸€è‡´ |
| `daily_sector_data` | 19,285 | 17,611 | æœ¬åœ°å¤š ~1,600 æ¡ |
| `users` | 2 | **4** | æœåŠ¡å™¨å¤š 2 ä¸ªç”¨æˆ· |
| `user_sessions` | 11 | **13** | æœåŠ¡å™¨å¤š 2 ä¸ªä¼šè¯ |
| `ext_*` è¡¨ | æœ‰æ•°æ® | **ä¸å­˜åœ¨** | éœ€è¦è¿ç§» |
| `board_blacklist` | 30 | **ä¸å­˜åœ¨** | éœ€è¦è¿ç§» |
| `cache_stock_board_signal` | 196,333 | **ä¸å­˜åœ¨** | éœ€è¦è¿ç§» |

---

## 2. å®Œæ•´è¿ç§»æ­¥éª¤

### é˜¶æ®µ 1: å¤‡ä»½æœåŠ¡å™¨ï¼ˆå¿…åšï¼‰

```bash
# åœ¨æœåŠ¡å™¨ä¸Šå¤‡ä»½
pg_dump -U postgres -d db_20251106_analysis_a > backup_server_20241224.sql
```

### é˜¶æ®µ 2: åˆ›å»ºè¡¨ç»“æ„ï¼ˆä¸€é”®è„šæœ¬ï¼‰

```bash
# åœ¨æœåŠ¡å™¨æ‰§è¡Œä¸€é”®å‡çº§è„šæœ¬
psql -U postgres -d db_20251106_analysis_a -f "sql/server/V0.6.0_æ•°æ®åº“å‡çº§è„šæœ¬.sql"

# æˆ–åœ¨ Navicat ä¸­æ‰“å¼€ V0.6.0_æ•°æ®åº“å‡çº§è„šæœ¬.sql æ‰§è¡Œ
```

### é˜¶æ®µ 3: ä»æœ¬åœ°å¯¼å‡ºæ•°æ®

```bash
# åœ¨æœ¬åœ°æœºå™¨æ‰§è¡Œ - åªå¯¼å‡ºéœ€è¦è¿ç§»çš„è¡¨
pg_dump -U postgres -h 192.168.182.128 -d db_20251106_analysis_a \
    --data-only \
    --table=ext_providers \
    --table=ext_board_list \
    --table=ext_board_daily_snap \
    --table=ext_board_heat_daily \
    --table=ext_board_local_map \
    --table=board_blacklist \
    --table=cache_stock_board_signal \
    > ext_boards_data.sql
```

> [!NOTE]
> æ•°æ®é‡çº¦ 34 ä¸‡æ¡ï¼Œå¯¼å‡ºæ–‡ä»¶é¢„è®¡ 50-100MB

### é˜¶æ®µ 4: å¯¼å…¥åˆ°æœåŠ¡å™¨

```bash
# ä¼ è¾“åˆ°æœåŠ¡å™¨
scp ext_boards_data.sql server:/tmp/

# åœ¨æœåŠ¡å™¨å¯¼å…¥
psql -U postgres -d db_20251106_analysis_a -f /tmp/ext_boards_data.sql

# ä¿®å¤åºåˆ—å€¼ï¼ˆé‡è¦ï¼å¦åˆ™åç»­æ’å…¥ä¼šæŠ¥ä¸»é”®å†²çªï¼‰
psql -U postgres -d db_20251106_analysis_a << 'EOF'
SELECT setval('ext_providers_id_seq', COALESCE((SELECT MAX(id) FROM ext_providers), 1));
SELECT setval('ext_board_list_id_seq', COALESCE((SELECT MAX(id) FROM ext_board_list), 1));
SELECT setval('board_blacklist_id_seq', COALESCE((SELECT MAX(id) FROM board_blacklist), 1));
EOF
```

### é˜¶æ®µ 5: éªŒè¯

```sql
-- æ£€æŸ¥æ•°æ®é‡
SELECT 'ext_providers' AS t, COUNT(*) FROM ext_providers
UNION ALL SELECT 'ext_board_list', COUNT(*) FROM ext_board_list
UNION ALL SELECT 'ext_board_daily_snap', COUNT(*) FROM ext_board_daily_snap
UNION ALL SELECT 'ext_board_heat_daily', COUNT(*) FROM ext_board_heat_daily
UNION ALL SELECT 'ext_board_local_map', COUNT(*) FROM ext_board_local_map
UNION ALL SELECT 'board_blacklist', COUNT(*) FROM board_blacklist
UNION ALL SELECT 'cache_stock_board_signal', COUNT(*) FROM cache_stock_board_signal;

-- æœŸæœ›ç»“æœ:
-- ext_providers: 2
-- ext_board_list: 527
-- ext_board_daily_snap: 122403
-- ext_board_heat_daily: 18499
-- ext_board_local_map: 527
-- board_blacklist: 30
-- cache_stock_board_signal: 196333
```

---

## 3. server æ–‡ä»¶å¤¹ç»“æ„

```
sql/server/
â”œâ”€â”€ V0.6.0_æ•°æ®åº“å‡çº§è„šæœ¬.sql   # â­ ä¸»å‡çº§è„šæœ¬ï¼Œä¸€é”®æ‰§è¡Œ
â”œâ”€â”€ public-local.sql            # æœ¬åœ°æ•°æ®åº“å¯¼å‡ºï¼ˆä»…ä¾›å¯¹æ¯”ï¼‰
â”œâ”€â”€ public-server.sql           # æœåŠ¡å™¨æ•°æ®åº“å¯¼å‡ºï¼ˆä»…ä¾›å¯¹æ¯”ï¼‰
â””â”€â”€ upgrade_ext_boards.sql      # æ—§è„šæœ¬ï¼ˆå·²åˆå¹¶åˆ°V0.6.0è„šæœ¬ï¼‰
```

---

## 4. å¯é€‰ï¼šåŒæ­¥ system_configs

å¦‚æœæœ¬åœ°æœ‰æ–°å¢çš„ç³»ç»Ÿé…ç½®é¡¹ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹æ–¹å¼åˆå¹¶ï¼š

```sql
-- è¿™ä¼šæ’å…¥æœ¬åœ°æœ‰ä½†æœåŠ¡å™¨æ²¡æœ‰çš„é…ç½®ï¼Œä¸ä¼šè¦†ç›–å·²æœ‰çš„
INSERT INTO system_configs (config_key, config_value, config_type, category, description)
SELECT config_key, config_value, config_type, category, description
FROM (VALUES
    ('board_safe_pct', '0.3', 'float', 'board_heat', 'è¡Œä¸šå®‰å…¨é˜ˆå€¼'),
    -- ... å…¶ä»–æ–°é…ç½®
) AS new_configs(config_key, config_value, config_type, category, description)
ON CONFLICT (config_key) DO NOTHING;
```
