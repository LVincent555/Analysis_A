# ç»Ÿä¸€ç¼“å­˜ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ (Unified Cache System)

> **ç‰ˆæœ¬**: v3.0.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-04  
> **æ›´æ–°æ—¥æœŸ**: 2025-12-04  
> **çŠ¶æ€**: è®¾è®¡é˜¶æ®µ  
> **ç›®æ ‡ç¯å¢ƒ**: 2C2G æœåŠ¡å™¨ï¼ˆå†…å­˜æ•æ„Ÿå‹è®¾è®¡ï¼‰  
> **è®¾è®¡ç›®æ ‡**: å·¥ä¸šçº§ç¼“å­˜å­ç³»ç»Ÿ  
> **å…³è”æ–‡æ¡£**: 
> - [ç³»ç»Ÿç®¡ç†æ¨¡å—è®¾è®¡æ–‡æ¡£](../client/ç³»ç»Ÿç®¡ç†æ¨¡å—è®¾è®¡æ–‡æ¡£.md)
> - [Numpyç¼“å­˜ä¸­é—´ä»¶è®¾è®¡æ–¹æ¡ˆ](Numpyç¼“å­˜ä¸­é—´ä»¶è®¾è®¡æ–¹æ¡ˆ.md)

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#1-æ¦‚è¿°)
2. [ç¼“å­˜ç­–ç•¥æ¨¡å¼](#2-ç¼“å­˜ç­–ç•¥æ¨¡å¼)
3. [å¤šæ€å­˜å‚¨å¼•æ“](#3-å¤šæ€å­˜å‚¨å¼•æ“)
4. [æ ¸å¿ƒç»„ä»¶å®ç°](#4-æ ¸å¿ƒç»„ä»¶å®ç°)
5. [å†…å­˜ä¼˜åŒ–ç­–ç•¥](#5-å†…å­˜ä¼˜åŒ–ç­–ç•¥)
6. [æ—¥å¿—ç³»ç»Ÿè®¾è®¡](#6-æ—¥å¿—ç³»ç»Ÿè®¾è®¡)
7. [åº”ç”¨åœºæ™¯æ˜ å°„](#7-åº”ç”¨åœºæ™¯æ˜ å°„)
8. [é£é™©æ§åˆ¶](#8-é£é™©æ§åˆ¶)
9. [å®æ–½è®¡åˆ’](#9-å®æ–½è®¡åˆ’)

---

## 1. æ¦‚è¿°

### 1.1 èƒŒæ™¯ä¸æ¼”è¿›

ç³»ç»Ÿä»"åªè¯»åˆ†æç³»ç»Ÿ"æ¼”è¿›ä¸º"å®Œå¤‡çš„SaaSåå°"ï¼Œéœ€è¦ä¸€ä¸ª**å†…å­˜æ•æ„Ÿå‹ç»Ÿä¸€ç¼“å­˜æ¶æ„**ï¼š

| é˜¶æ®µ | ç¼“å­˜éœ€æ±‚ | è§£å†³æ–¹æ¡ˆ |
|------|----------|----------|
| v1.0 | è‚¡ç¥¨æ•°æ®åªè¯»æŸ¥è¯¢ | NumpyCacheMiddleware |
| v2.0 | + ä¼šè¯çŠ¶æ€ç®¡ç† | + è¿›ç¨‹å†…çŠ¶æ€ç®¡ç†å™¨ |
| **v3.0** | ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç¼“å­˜ | **UnifiedCacheSystem** |

### 1.2 è®¾è®¡ç›®æ ‡

| ç›®æ ‡ | æŒ‡æ ‡ | è¯´æ˜ |
|------|------|------|
| **æè‡´æ€§èƒ½** | è¯»å†™ < 1ms | çº¯å†…å­˜æ“ä½œï¼Œæ— IPCå¼€é”€ |
| **å†…å­˜å¯æ§** | < 150MB æ€»å ç”¨ | 2C2GæœåŠ¡å™¨å¯æ‰¿è½½ |
| **ç­–ç•¥çµæ´»** | 3ç§å†™å…¥æ¨¡å¼ | æŒ‰åœºæ™¯é€‰æ‹©æœ€ä¼˜ç­–ç•¥ |
| **å‘åå…¼å®¹** | Numpyç¼“å­˜é™çº§ | åŸæœ‰ç³»ç»Ÿæ— ç¼è¿ç§» |
| **æ— å¤–éƒ¨ä¾èµ–** | æ— Redis | å•è¿›ç¨‹è‡ªæ´½ |

### 1.3 æ ¸å¿ƒæ¶æ„å›¾ (ä¸‰å±‚å­˜å‚¨)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UnifiedCache (ç»Ÿä¸€ç¼“å­˜ç®¡ç†å™¨ - è·¯ç”±ç½‘å…³)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ L1 å†…å­˜å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚  â”‚ ObjectStore â”‚  â”‚ ObjectStore â”‚  â”‚        VectorStore          â”‚ â”‚â”‚
â”‚  â”‚  â”‚ (sessions)  â”‚  â”‚  (users)    â”‚  â”‚      (stock_market)         â”‚ â”‚â”‚
â”‚  â”‚  â”‚ Write-Behindâ”‚  â”‚ Cache-Aside â”‚  â”‚      Read-Only Numpy        â”‚ â”‚â”‚
â”‚  â”‚  â”‚ é«˜é¢‘å†™å…¥     â”‚  â”‚ è¯»å¤šå†™å°‘     â”‚  â”‚      é«˜å¯†åº¦åªè¯»              â”‚ â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ L2 ç£ç›˜å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚â”‚
â”‚  â”‚  â”‚     FileStore       â”‚  â”‚     FileStore       â”‚                  â”‚â”‚
â”‚  â”‚  â”‚   (api_response)    â”‚  â”‚     (reports)       â”‚                  â”‚â”‚
â”‚  â”‚  â”‚   DiskCache å°è£…     â”‚  â”‚   å¤§æ–‡ä»¶/æŠ¥è¡¨ç¼“å­˜     â”‚                  â”‚â”‚
â”‚  â”‚  â”‚   LRU è‡ªåŠ¨æ·˜æ±°       â”‚  â”‚   >10KB éç»“æ„åŒ–     â”‚                  â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ AuditLogBuffer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  ä¸šåŠ¡å®¡è®¡æ—¥å¿—ç¼“å†² â†’ Write-Behind â†’ æ‰¹é‡å†™å…¥ operation_logs è¡¨          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚        â”‚                â”‚                      â”‚                        â”‚
â”‚        â–¼                â–¼                      â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    PostgreSQL (æŒä¹…åŒ–å±‚)                              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 å†…å­˜é¢„ç®—åˆ†é… (2GBæ€»é‡)

| ç»„ä»¶ | é¢„ç®— | å­˜å‚¨ä»‹è´¨ | è¯´æ˜ |
|------|------|----------|------|
| Python è¿›ç¨‹åŸºç¡€ | ~100MB | å†…å­˜ | è§£é‡Šå™¨ + FastAPI |
| VectorStore (è‚¡ç¥¨æ•°æ®) | ~60MB | å†…å­˜ | 15ä¸‡æ¡ Ã— 20å­—æ®µ Numpy |
| ObjectStore (ä¼šè¯+ç”¨æˆ·) | ~10MB | å†…å­˜ | ~1000ä¼šè¯ Ã— Slotsä¼˜åŒ– |
| AuditLogBuffer | ~5MB | å†…å­˜ | å®¡è®¡æ—¥å¿—ç¼“å†²é˜Ÿåˆ— |
| FileStore (api_response) | ~200MB | **ç£ç›˜** | APIå“åº”ç¼“å­˜ (ä¸å å†…å­˜) |
| FileStore (reports) | ~500MB | **ç£ç›˜** | æŠ¥è¡¨æ–‡ä»¶ç¼“å­˜ (ä¸å å†…å­˜) |
| é¢„ç•™/å³°å€¼ | ~75MB | å†…å­˜ | GC + ä¸´æ—¶å¯¹è±¡ |
| **å†…å­˜æ€»è®¡** | **~250MB** | - | 2GBå®‰å…¨ âœ… |
| **ç£ç›˜å ç”¨** | **~700MB** | - | å¯é…ç½®ä¸Šé™ |

---

## 2. ç¼“å­˜ç­–ç•¥æ¨¡å¼ (Caching Patterns)

æ ¹æ®æ•°æ®çš„ä¸€è‡´æ€§è¦æ±‚å’Œè¯»å†™é¢‘ç‡ï¼Œç³»ç»Ÿæä¾›ä¸‰ç§æ ¸å¿ƒæ¨¡å¼ï¼Œé€šè¿‡**ç­–ç•¥æ¨¡å¼ (Strategy Pattern)**å®ç°çµæ´»åˆ‡æ¢ã€‚

### 2.1 ç­–ç•¥å¯¹æ¯”

| æ¨¡å¼ | æœºåˆ¶ | é€‚ç”¨åœºæ™¯ | ä¸€è‡´æ€§ | æ€§èƒ½ |
|------|------|----------|--------|------|
| **Write-Behind** | å†™å†…å­˜â†’åå°æ‰¹é‡å†™DB | é«˜é¢‘å†™å…¥ã€å…è®¸ä¸¢å¤± | æœ€ç»ˆä¸€è‡´ | â­â­â­â­â­ |
| **Write-Through** | å†™å†…å­˜+åŒæ­¥å†™DB | å…³é”®æ•°æ®ã€ä¸èƒ½ä¸¢å¤± | å¼ºä¸€è‡´ | â­â­â­ |
| **Cache-Aside** | è¯»ç©¿é€ã€å†™åˆ ç¼“å­˜ | è¯»å¤šå†™å°‘ã€å¯å›æº | æœ€ç»ˆä¸€è‡´ | â­â­â­â­ |

### 2.2 Write-Behind (å¼‚æ­¥å›å†™)

```
å†™è¯·æ±‚ â†’ æ›´æ–°å†…å­˜ â†’ ç«‹å³è¿”å› âœ“
                â†“
          æ ‡è®° is_dirty
                â†“
    åå°çº¿ç¨‹(10ç§’) â†’ æ‰¹é‡å†™DB
```

**é€‚ç”¨åœºæ™¯**ï¼š
- ä¼šè¯å¿ƒè·³ã€æœ€åæ´»è·ƒæ—¶é—´
- é¡µé¢è®¿é—®ç»Ÿè®¡
- åœ¨çº¿çŠ¶æ€æ›´æ–°

**é£é™©**ï¼šè¿›ç¨‹å´©æºƒä¸¢å¤±æœªè½åº“æ•°æ®ï¼ˆä¸šåŠ¡å¯æ¥å—ï¼‰

### 2.3 Write-Through (åŒæ­¥ç›´å†™)

```
å†™è¯·æ±‚ â†’ æ›´æ–°å†…å­˜ â†’ åŒæ­¥å†™DB â†’ è¿”å› âœ“
```

**é€‚ç”¨åœºæ™¯**ï¼š
- ç”¨æˆ·ä¿®æ”¹å¯†ç 
- ç®¡ç†å‘˜ä¿®æ”¹æƒé™é…ç½®
- è´¦æˆ·é”å®š/å¯ç”¨çŠ¶æ€

**ä»£ä»·**ï¼šå†™æ€§èƒ½å—DB I/Oé™åˆ¶ï¼ˆä½†é¢‘ç‡ä½ï¼Œå¯æ¥å—ï¼‰

### 2.4 Cache-Aside (æ—è·¯ç¼“å­˜)

```
è¯»è¯·æ±‚ â†’ æŸ¥å†…å­˜ â†’ å‘½ä¸­? â†’ è¿”å› âœ“
              â†“ æœªå‘½ä¸­
         æŸ¥DB â†’ å†™å…¥å†…å­˜ â†’ è¿”å› âœ“

å†™è¯·æ±‚ â†’ æ›´æ–°DB â†’ åˆ é™¤å†…å­˜ç¼“å­˜ (Evict)
              â†“
    ä¸‹æ¬¡è¯»è‡ªåŠ¨é‡æ–°åŠ è½½ (Lazy Load)
```

**é€‚ç”¨åœºæ™¯**ï¼š
- ç”¨æˆ·åŸºç¡€ä¿¡æ¯ï¼ˆæ˜µç§°ã€å¤´åƒï¼‰
- ç³»ç»Ÿå…¨å±€é…ç½®
- è‚¡ç¥¨åŸºç¡€ä¿¡æ¯åˆ—è¡¨

**ä¼˜ç‚¹**ï¼šä¿è¯"ç¼“å­˜å­˜åœ¨å³ä¸ºçƒ­æ•°æ®"

---

## 3. å¤šæ€å­˜å‚¨å¼•æ“ (Polymorphic Storage Engine)

ä¸ºåœ¨2GBå†…å­˜ä¸­åŒæ—¶å®¹çº³"15ä¸‡æ¡è‚¡ç¥¨æ•°æ®"å’Œ"åœ¨çº¿ç”¨æˆ·çŠ¶æ€"ï¼Œç³»ç»Ÿæ ¹æ®æ•°æ®ç‰¹æ€§**è‡ªåŠ¨è·¯ç”±**åˆ°ä¸åŒçš„åº•å±‚å¼•æ“ã€‚

### 3.1 æ¶æ„ç±»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UnifiedCache (ç»Ÿä¸€å…¥å£/è·¯ç”±ç½‘å…³)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    CacheRegion (æŠ½è±¡æ¥å£)                           â”‚  â”‚
â”‚  â”‚  + get(key, loader?) -> Any                                       â”‚  â”‚
â”‚  â”‚  + set(key, value, ttl?) -> None                                  â”‚  â”‚
â”‚  â”‚  + delete(key) -> None                                            â”‚  â”‚
â”‚  â”‚  + stats() -> dict                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â–³                    â–³                    â–³                    â”‚
â”‚          â”‚                    â”‚                    â”‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  ObjectStore  â”‚    â”‚  VectorStore  â”‚    â”‚   FileStore   â”‚          â”‚
â”‚  â”‚  (Dict+Slots) â”‚    â”‚  (Numpyå°è£…)   â”‚    â”‚ (DiskCache)   â”‚          â”‚
â”‚  â”‚  L1 å†…å­˜å±‚    â”‚    â”‚  L1 å†…å­˜å±‚     â”‚    â”‚  L2 ç£ç›˜å±‚    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚          â”‚                    â”‚                    â”‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  WritePolicy  â”‚    â”‚  NumpyCache   â”‚    â”‚   diskcache   â”‚          â”‚
â”‚  â”‚  (ç­–ç•¥æ¨¡å¼)   â”‚    â”‚  Middleware   â”‚    â”‚   (ç¬¬ä¸‰æ–¹åº“)  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ä¸‰ç§å­˜å‚¨å¼•æ“å¯¹æ¯”

| ç‰¹æ€§ | ObjectStore | VectorStore | FileStore |
|------|-------------|-------------|-----------|
| **åº•å±‚ç»“æ„** | `Dict[str, CacheEntry]` | `numpy.ndarray` | `diskcache.Cache` |
| **å­˜å‚¨ä»‹è´¨** | å†…å­˜ (L1) | å†…å­˜ (L1) | ç£ç›˜ (L2) |
| **å•æ¡å¼€é”€** | ~64 Bytes (Slots) | ~80 Bytes | æ— å†…å­˜å ç”¨ |
| **é€‚ç”¨æ•°æ®** | Session, User, Config | Stock, Sector, History | APIå“åº”, æŠ¥è¡¨, å¤§æ–‡æœ¬ |
| **å†™å…¥æ¨¡å¼** | Write-Behind / Through / Aside | Read-Only | Cache-Aside |
| **TTLæ”¯æŒ** | âœ… | âŒ æ•´ä½“æ›¿æ¢ | âœ… |
| **å®¹é‡é™åˆ¶** | å—å†…å­˜çº¦æŸ | å—å†…å­˜çº¦æŸ | é…ç½®ç£ç›˜ä¸Šé™ |
| **æ•°æ®å¤§å°** | < 1KB å°å¯¹è±¡ | æ‰¹é‡ç»“æ„åŒ– | > 10KB å¤§å¯¹è±¡ |
| **çº¿ç¨‹å®‰å…¨** | RLock | åªè¯»æ— éœ€é” | å†…ç½®åŸå­æ“ä½œ |

### 3.3 è®¾è®¡å†³ç­–ï¼šä¸ºä»€ä¹ˆä¸‰ç§å¼•æ“å¹¶å­˜ï¼Ÿ

> **æ ¸å¿ƒåŸåˆ™**ï¼šä¸åŒæ•°æ®ç‰¹æ€§ â†’ ä¸åŒå­˜å‚¨å¼•æ“ â†’ ç»Ÿä¸€æ¥å£

| å¼•æ“ | è§£å†³çš„é—®é¢˜ | å…¸å‹åœºæ™¯ |
|------|------------|----------|
| **ObjectStore** | ä¸šåŠ¡é€»è¾‘çŠ¶æ€ï¼Œé«˜é¢‘è¯»å†™ | ä¼šè¯å¿ƒè·³ã€ç”¨æˆ·ä¿¡æ¯ |
| **VectorStore** | ç»“æ„åŒ–æ•°æ®åˆ†æï¼Œé«˜å¯†åº¦åªè¯» | è‚¡ç¥¨æ—¥æ•°æ®ã€æ’è¡Œæ¦œ |
| **FileStore** | å¤§æ–‡ä»¶/éç»“æ„åŒ–ï¼ŒèŠ‚çœå†…å­˜ | APIå“åº”ç¼“å­˜ã€AIæŠ¥å‘Š |

**ä¸šåŠ¡å±‚æ— æ„ŸçŸ¥**ï¼šè°ƒç”¨æ–¹åªéœ€è¦ `UnifiedCache.xxx().get(key)`ï¼Œæ— éœ€å…³å¿ƒåº•å±‚æ˜¯å†…å­˜è¿˜æ˜¯ç£ç›˜ã€‚

---

## 4. æ ¸å¿ƒç»„ä»¶å®ç°

### 4.1 CacheEntry (Slots + Generic ä¼˜åŒ–)

```python
import time
from typing import TypeVar, Generic, Optional

T = TypeVar('T')

class CacheEntry(Generic[T]):
    """
    ç¼“å­˜æ¡ç›® - ä½¿ç”¨ __slots__ + Generic ä¼˜åŒ–
    
    ä¼˜åŒ–ç‚¹ï¼š
    1. __slots__: èŠ‚çœ 70%+ å†…å­˜
    2. Generic[T]: IDE å‹å¥½ï¼Œç±»å‹æç¤º
    3. version: æ”¯æŒé…ç½®çƒ­åŠ è½½
    
    å†…å­˜å¯¹æ¯”ï¼š
    - Dict: {"value": x, "expire_at": y, ...} â†’ ~200-400 Bytes
    - Slots: CacheEntry(...)                  â†’ ~56-72 Bytes
    """
    __slots__ = ('value', 'expire_at', 'last_access', 'is_dirty', 'version')
    
    value: T
    expire_at: float
    last_access: float
    is_dirty: bool
    version: int
    
    def __init__(self, value: T, ttl: int = 0, version: int = 1):
        self.value = value
        now = time.time()
        self.expire_at = now + ttl if ttl > 0 else 0  # 0=æ°¸ä¸è¿‡æœŸ
        self.last_access = now
        self.is_dirty = False
        self.version = version  # ç”¨äºé…ç½®çƒ­åŠ è½½æ£€æµ‹
    
    def is_expired(self) -> bool:
        return self.expire_at > 0 and time.time() > self.expire_at
    
    def touch(self) -> None:
        """æ›´æ–°è®¿é—®æ—¶é—´"""
        self.last_access = time.time()
    
    def is_stale(self, current_version: int) -> bool:
        """æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦è½åï¼ˆç”¨äºçƒ­åŠ è½½ï¼‰"""
        return self.version < current_version
```

### 4.2 CachePolicy ç­–ç•¥æ¥å£

```python
from abc import ABC, abstractmethod
from typing import Any, Callable, Dict, Optional

class CachePolicy(ABC):
    """ç¼“å­˜ç­–ç•¥æŠ½è±¡åŸºç±»"""
    
    def __init__(self, ttl: int = 0):
        self.ttl = ttl
    
    @abstractmethod
    def get(self, key: str, store: Dict, loader: Optional[Callable]) -> Any:
        """è¯»å–ç¼“å­˜"""
        pass
    
    @abstractmethod
    def set(self, key: str, value: Any, store: Dict, persister: Optional[Callable]) -> None:
        """å†™å…¥ç¼“å­˜"""
        pass
    
    @abstractmethod
    def on_write(self, key: str, entry: CacheEntry) -> None:
        """å†™å…¥åçš„é’©å­ï¼ˆå¦‚æ ‡è®°è„æ•°æ®ï¼‰"""
        pass
```

### 4.3 Write-Behind ç­–ç•¥å®ç°

```python
import threading
import time
from typing import Dict, Set

class WriteBehindPolicy(CachePolicy):
    """
    Write-Behind (å¼‚æ­¥å›å†™) ç­–ç•¥
    
    å†™æ“ä½œåªæ›´æ–°å†…å­˜ï¼Œåå°çº¿ç¨‹æ‰¹é‡åŒæ­¥åˆ°DB
    """
    
    def __init__(self, ttl: int = 1800, sync_interval: int = 10):
        super().__init__(ttl)
        self.sync_interval = sync_interval
        self.dirty_keys: Set[str] = set()
        self._lock = threading.Lock()
    
    def get(self, key: str, store: Dict, loader: Callable = None) -> Any:
        entry = store.get(key)
        if entry and not entry.is_expired():
            entry.touch()
            return entry.value
        return None  # Write-Behind æ¨¡å¼ä¸ä¸»åŠ¨å›æº
    
    def set(self, key: str, value: Any, store: Dict, persister: Callable = None) -> None:
        entry = CacheEntry(value, self.ttl)
        entry.is_dirty = True
        store[key] = entry
        with self._lock:
            self.dirty_keys.add(key)
    
    def on_write(self, key: str, entry: CacheEntry) -> None:
        entry.is_dirty = True
        with self._lock:
            self.dirty_keys.add(key)
    
    def get_dirty_keys(self) -> Set[str]:
        """è·å–å¹¶æ¸…ç©ºè„æ•°æ®é”®é›†åˆï¼ˆSyncerè°ƒç”¨ï¼‰"""
        with self._lock:
            keys = self.dirty_keys.copy()
            self.dirty_keys.clear()
            return keys
```

### 4.4 Cache-Aside ç­–ç•¥å®ç°

```python
class CacheAsidePolicy(CachePolicy):
    """
    Cache-Aside (æ—è·¯ç¼“å­˜) ç­–ç•¥
    
    è¯»ï¼šå…ˆæŸ¥ç¼“å­˜â†’æœªå‘½ä¸­â†’å›æºåŠ è½½â†’å†™å…¥ç¼“å­˜
    å†™ï¼šå…ˆå†™DBâ†’åˆ é™¤ç¼“å­˜ï¼ˆLazy Loadï¼‰
    """
    
    def get(self, key: str, store: Dict, loader: Callable = None) -> Any:
        # 1. æŸ¥ç¼“å­˜
        entry = store.get(key)
        if entry:
            if entry.is_expired():
                del store[key]
            else:
                entry.touch()
                return entry.value
        
        # 2. æœªå‘½ä¸­ï¼Œå›æºåŠ è½½
        if loader:
            value = loader()
            if value is not None:
                store[key] = CacheEntry(value, self.ttl)
            return value
        return None
    
    def set(self, key: str, value: Any, store: Dict, persister: Callable = None) -> None:
        # 1. å…ˆå†™ DB
        if persister:
            persister(value)
        
        # 2. åˆ é™¤ç¼“å­˜ (Lazy Load)
        if key in store:
            del store[key]
    
    def on_write(self, key: str, entry: CacheEntry) -> None:
        pass  # Cache-Aside ä¸éœ€è¦æ ‡è®°è„æ•°æ®
```

### 4.5 ObjectStore å®ç°

```python
import threading
from typing import Any, Callable, Dict, Optional

class ObjectStore:
    """
    å¯¹è±¡å­˜å‚¨å¼•æ“
    
    ç”¨äºå­˜å‚¨å¸¸è§„ä¸šåŠ¡å¯¹è±¡ï¼ˆSessionã€Userã€Configï¼‰
    æ”¯æŒ TTLã€ç­–ç•¥åˆ‡æ¢ã€çº¿ç¨‹å®‰å…¨
    """
    
    def __init__(self, name: str, policy: CachePolicy):
        self.name = name
        self.policy = policy
        self.store: Dict[str, CacheEntry] = {}
        self._lock = threading.RLock()
    
    def get(self, key: str, loader: Callable = None) -> Any:
        """
        è¯»å–ç¼“å­˜
        
        Args:
            key: ç¼“å­˜é”®
            loader: å›æºåŠ è½½å‡½æ•°ï¼ˆä»…Cache-Asideä½¿ç”¨ï¼‰
        """
        with self._lock:
            return self.policy.get(key, self.store, loader)
    
    def set(self, key: str, value: Any, persister: Callable = None) -> None:
        """
        å†™å…¥ç¼“å­˜
        
        Args:
            key: ç¼“å­˜é”®
            value: ç¼“å­˜å€¼
            persister: æŒä¹…åŒ–å‡½æ•°ï¼ˆä»…Write-Through/Cache-Asideä½¿ç”¨ï¼‰
        """
        with self._lock:
            self.policy.set(key, value, self.store, persister)
    
    def delete(self, key: str) -> bool:
        """åˆ é™¤ç¼“å­˜"""
        with self._lock:
            if key in self.store:
                del self.store[key]
                return True
            return False
    
    def clear_expired(self) -> int:
        """æ¸…ç†è¿‡æœŸæ¡ç›®ï¼ˆè¿”å›æ¸…ç†æ•°é‡ï¼‰"""
        with self._lock:
            expired_keys = [k for k, v in self.store.items() if v.is_expired()]
            for k in expired_keys:
                del self.store[k]
            return len(expired_keys)
    
    def stats(self) -> dict:
        """ç»Ÿè®¡ä¿¡æ¯"""
        with self._lock:
            total = len(self.store)
            expired = sum(1 for v in self.store.values() if v.is_expired())
            dirty = sum(1 for v in self.store.values() if v.is_dirty)
            return {
                "name": self.name,
                "type": "object",
                "total": total,
                "expired": expired,
                "dirty": dirty
            }
```

### 4.6 VectorStore (Numpyå°è£…)

```python
class VectorStore:
    """
    å‘é‡å­˜å‚¨å¼•æ“ - å°è£…åŸæœ‰ NumpyCacheMiddleware
    
    å°†æ—§çš„ Numpy ç¼“å­˜é™çº§ä¸ºç»Ÿä¸€ç¼“å­˜ç³»ç»Ÿä¸­çš„ä¸€ä¸ª"åªè¯»é«˜å¯†åº¦åˆ†åŒº"
    """
    
    def __init__(self, numpy_middleware):
        """
        Args:
            numpy_middleware: åŸæœ‰çš„ NumpyCacheMiddleware å®ä¾‹
        """
        self.core = numpy_middleware
        self.name = "stock_market"
    
    def get(self, key: str, loader: Callable = None) -> Any:
        """
        å‘é‡å­˜å‚¨é€šå¸¸ä¸æ”¯æŒå•KeyæŸ¥è¯¢
        æ”¹ç”¨ query() æ–¹æ³•åšå¤æ‚æŸ¥è¯¢
        """
        raise NotImplementedError("VectorStore uses query() instead of get()")
    
    def set(self, key: str, value: Any, persister: Callable = None) -> None:
        """å‘é‡å­˜å‚¨æ˜¯åªè¯»çš„"""
        raise NotImplementedError("VectorStore is read-only")
    
    def query(self, method_name: str, *args, **kwargs) -> Any:
        """
        é€ä¼ è°ƒç”¨åˆ°åº•å±‚ NumpyCacheMiddleware
        
        ç¤ºä¾‹:
            vector_store.query("get_top_n_by_rank", date, 100)
            vector_store.query("get_stock_by_code", "600000")
        """
        if hasattr(self.core, method_name):
            return getattr(self.core, method_name)(*args, **kwargs)
        raise AttributeError(f"Method {method_name} not found in NumpyCacheMiddleware")
    
    def reload(self) -> None:
        """é‡æ–°åŠ è½½æ•°æ®ï¼ˆæ•°æ®æ›´æ–°æ—¶è°ƒç”¨ï¼‰"""
        self.core.load_from_db()
    
    def stats(self) -> dict:
        """ç»Ÿè®¡ä¿¡æ¯"""
        return {
            "name": self.name,
            "type": "vector",
            "memory_mb": self.core.get_memory_usage() if hasattr(self.core, 'get_memory_usage') else "N/A",
            "rows": len(self.core.data) if hasattr(self.core, 'data') else "N/A"
        }
```

### 4.7 FileStore (ç£ç›˜ç¼“å­˜é€‚é…å™¨)

```python
from diskcache import Cache
from typing import Any, Callable, Optional

class FileStore:
    """
    [é€‚é…å™¨æ¨¡å¼] å°† DiskCache æ¥å…¥ç»Ÿä¸€ç¼“å­˜ç³»ç»Ÿ
    
    ç‰¹æ€§ï¼š
    1. æŒä¹…åŒ–ï¼šåŸºäº SQLite/æ–‡ä»¶ç³»ç»Ÿ
    2. LRUæ·˜æ±°ï¼šè‡ªåŠ¨ç®¡ç†ç£ç›˜å ç”¨
    3. çº¿ç¨‹å®‰å…¨ï¼šåº•å±‚ diskcache å·²å®ç°é”
    4. é›¶å†…å­˜å ç”¨ï¼šæ•°æ®å­˜åœ¨ç£ç›˜
    
    é€‚ç”¨åœºæ™¯ï¼š
    - APIå“åº”ç¼“å­˜ (JSONåºåˆ—åŒ–ç»“æœ)
    - ç”Ÿæˆçš„æŠ¥è¡¨/PDF
    - AIç”Ÿæˆçš„åˆ†ææŠ¥å‘Š (å¤§æ®µæ–‡æœ¬)
    - >10KB çš„éç»“æ„åŒ–æ•°æ®
    """
    
    def __init__(self, name: str, cache_dir: str, size_limit_gb: float = 0.5):
        """
        Args:
            name: åˆ†åŒºåç§°
            cache_dir: ç¼“å­˜ç›®å½•è·¯å¾„
            size_limit_gb: ç£ç›˜å ç”¨ä¸Šé™ (GB)
        """
        self.name = name
        # é’ˆå¯¹ 2C2G ä¼˜åŒ–ï¼šé™åˆ¶ç¼“å­˜å¤§å°ï¼Œé˜²æ­¢ç£ç›˜å†™æ»¡
        self.core = Cache(
            directory=cache_dir,
            size_limit=int(size_limit_gb * 1024 * 1024 * 1024),
            eviction_policy='least-recently-used',
            tag_index=False  # å…³é—­æ ‡ç­¾ç´¢å¼•èŠ‚çœæ€§èƒ½
        )

    def get(self, key: str, loader: Optional[Callable] = None) -> Any:
        """
        ç»Ÿä¸€æ¥å£å®ç°ï¼šæ”¯æŒ Cache-Aside æ¨¡å¼
        """
        # DiskCache çš„ get æ“ä½œæ˜¯åŸå­çš„
        val = self.core.get(key)
        
        # å¦‚æœæœªå‘½ä¸­ä¸”æä¾›äº†åŠ è½½å™¨ï¼Œè‡ªåŠ¨å›æºå¹¶å†™å…¥
        if val is None and loader:
            try:
                val = loader()
                if val is not None:
                    # é»˜è®¤ç¼“å­˜ 5 åˆ†é’Ÿï¼Œé¿å…ç¼“å­˜é›ªå´©
                    self.core.set(key, val, expire=300)
            except Exception:
                pass  # å®¹é”™ï¼šåŠ è½½å¤±è´¥è¿”å› None
                
        return val

    def set(self, key: str, value: Any, ttl: int = 0) -> None:
        """
        å†™å…¥ç¼“å­˜
        
        Args:
            key: ç¼“å­˜é”®
            value: ç¼“å­˜å€¼ï¼ˆå¯åºåˆ—åŒ–å¯¹è±¡ï¼‰
            ttl: è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ï¼Œ0=ä½¿ç”¨é»˜è®¤24å°æ—¶
        """
        expire = ttl if ttl > 0 else 86400  # é»˜è®¤ 24 å°æ—¶
        self.core.set(key, value, expire=expire)

    def delete(self, key: str) -> bool:
        return self.core.delete(key)

    def clear(self) -> None:
        """æ¸…ç©ºæ•´ä¸ªåˆ†åŒº"""
        self.core.clear()

    def stats(self) -> dict:
        """ç›‘æ§æŒ‡æ ‡"""
        return {
            "name": self.name,
            "type": "disk",
            "size_mb": round(self.core.volume() / (1024 * 1024), 2),
            "count": len(self.core),
            "directory": self.core.directory
        }
```

### 4.8 UnifiedCache ç»Ÿä¸€ç®¡ç†å™¨

```python
from typing import Dict, Union

# ç±»å‹åˆ«åï¼šæ‰€æœ‰æ”¯æŒçš„å­˜å‚¨å¼•æ“
CacheRegion = Union[ObjectStore, VectorStore, FileStore]

class UnifiedCache:
    """
    ç»Ÿä¸€ç¼“å­˜ç®¡ç†å™¨ - å…¨å±€è·¯ç”±ç½‘å…³
    
    èŒè´£ï¼š
    1. æ³¨å†Œå¹¶ç®¡ç†æ‰€æœ‰ç¼“å­˜åˆ†åŒºï¼ˆå†…å­˜ + ç£ç›˜ï¼‰
    2. æä¾›è¯­æ³•ç³–å¿«é€Ÿè®¿é—®å¸¸ç”¨åˆ†åŒº
    3. åè°ƒå…¨å±€ GC æ“ä½œ
    
    è®¾è®¡åŸåˆ™ï¼šä¸šåŠ¡å±‚åªä¸ UnifiedCache äº¤äº’ï¼Œæ— éœ€å…³å¿ƒåº•å±‚å­˜å‚¨å¼•æ“
    """
    
    _regions: Dict[str, CacheRegion] = {}
    
    @classmethod
    def register(cls, name: str, region: CacheRegion) -> None:
        """æ³¨å†Œç¼“å­˜åˆ†åŒº"""
        cls._regions[name] = region
    
    @classmethod
    def get_region(cls, name: str) -> CacheRegion:
        """è·å–ç¼“å­˜åˆ†åŒº"""
        if name not in cls._regions:
            raise KeyError(f"Cache region '{name}' not registered")
        return cls._regions[name]
    
    # ========== è¯­æ³•ç³–ï¼šL1 å†…å­˜å±‚ ==========
    
    @classmethod
    def session(cls) -> ObjectStore:
        """è®¿é—®ä¼šè¯åˆ†åŒº (å†…å­˜)"""
        return cls.get_region("sessions")
    
    @classmethod
    def user(cls) -> ObjectStore:
        """è®¿é—®ç”¨æˆ·åˆ†åŒº (å†…å­˜)"""
        return cls.get_region("users")
    
    @classmethod
    def stock(cls) -> VectorStore:
        """è®¿é—®è‚¡ç¥¨æ•°æ®åˆ†åŒº (å†…å­˜/Numpy)"""
        return cls.get_region("stock_market")
    
    @classmethod
    def config(cls) -> ObjectStore:
        """è®¿é—®é…ç½®åˆ†åŒº (å†…å­˜)"""
        return cls.get_region("config")
    
    # ========== è¯­æ³•ç³–ï¼šL2 ç£ç›˜å±‚ ==========
    
    @classmethod
    def api(cls) -> FileStore:
        """è®¿é—® API å“åº”ç¼“å­˜ (ç£ç›˜)"""
        return cls.get_region("api_response")
    
    @classmethod
    def report(cls) -> FileStore:
        """è®¿é—®æŠ¥è¡¨æ–‡ä»¶ç¼“å­˜ (ç£ç›˜)"""
        return cls.get_region("reports")
    
    # ========== å…¨å±€æ“ä½œ ==========
    
    @classmethod
    def stats(cls) -> dict:
        """æ‰€æœ‰åˆ†åŒºç»Ÿè®¡"""
        return {name: region.stats() for name, region in cls._regions.items()}
    
    @classmethod
    def gc(cls) -> dict:
        """ä¸»åŠ¨GCï¼šæ¸…ç†è¿‡æœŸç¼“å­˜"""
        import gc
        result = {}
        for name, region in cls._regions.items():
            if isinstance(region, ObjectStore):
                result[name] = region.clear_expired()
            elif isinstance(region, FileStore):
                # FileStore ç”± DiskCache è‡ªåŠ¨ LRU æ·˜æ±°
                result[name] = "auto-eviction"
        gc.collect()  # è§¦å‘ Python GC
        return result
    
    @classmethod
    def clear_all(cls) -> dict:
        """
        æ¸…ç©ºæ‰€æœ‰ç¼“å­˜ï¼ˆç®¡ç†å‘˜æ“ä½œï¼‰
        
        æ³¨æ„ï¼šä¼šæ¸…ç©ºç£ç›˜ç¼“å­˜ï¼Œè‚¡ç¥¨æ•°æ®éœ€è¦é‡æ–°åŠ è½½
        """
        result = {}
        for name, region in cls._regions.items():
            if isinstance(region, ObjectStore):
                region.store.clear()
                result[name] = "cleared"
            elif isinstance(region, FileStore):
                region.clear()
                result[name] = "cleared"
            elif isinstance(region, VectorStore):
                result[name] = "skipped (reload manually)"
        return result
```

### 4.9 DatabaseSyncer åå°åŒæ­¥å™¨ (å«GCé˜²æŠ–)

```python
import threading
import time
import logging
import gc
from typing import List
from sqlalchemy.orm import Session

logger = logging.getLogger(__name__)

class DatabaseSyncer(threading.Thread):
    """
    æ•°æ®åº“åŒæ­¥å™¨ - å®ˆæŠ¤çº¿ç¨‹
    
    èŒè´£ï¼š
    1. å®šæœŸæ‰«æ Write-Behind ç­–ç•¥çš„è„æ•°æ®
    2. æ‰¹é‡æ›´æ–°åˆ° PostgreSQL
    3. æ¸…ç†è¿‡æœŸç¼“å­˜
    4. æ™ºèƒ½GCï¼šå†…å­˜é˜ˆå€¼è§¦å‘ + æ—¶é—´é—´éš”è§¦å‘
    """
    
    # GC è§¦å‘é˜ˆå€¼ï¼ˆé’ˆå¯¹ 2GB æœåŠ¡å™¨ï¼‰
    MEMORY_THRESHOLD_PERCENT = 80  # å†…å­˜ä½¿ç”¨è¶…è¿‡ 80% æ—¶å¼ºåˆ¶ GC
    
    def __init__(self, sync_interval: int = 10, gc_interval: int = 300):
        super().__init__()
        self.daemon = True
        self.running = True
        self.sync_interval = sync_interval
        self.gc_interval = gc_interval
        self._last_gc = time.time()
    
    def run(self):
        logger.info(f"[Syncer] Started, sync={self.sync_interval}s, gc={self.gc_interval}s")
        while self.running:
            time.sleep(self.sync_interval)
            try:
                self._sync_sessions()
                self._sync_audit_logs()  # åŒæ­¥å®¡è®¡æ—¥å¿—
                self._maybe_gc()
            except Exception as e:
                logger.error(f"[Syncer] Error: {e}")
    
    def _sync_sessions(self):
        """åŒæ­¥ä¼šè¯æ•°æ®åˆ°DB"""
        from .manager import UnifiedCache
        from ..database import SessionLocal
        from ..db_models import UserSession
        
        try:
            store = UnifiedCache.session()
            policy = store.policy
            
            if not isinstance(policy, WriteBehindPolicy):
                return
            
            dirty_keys = policy.get_dirty_keys()
            if not dirty_keys:
                return
            
            # æ„å»ºæ‰¹é‡æ›´æ–°æ•°æ®
            mappings = []
            with store._lock:
                for key in dirty_keys:
                    entry = store.store.get(key)
                    if entry and entry.value:
                        v = entry.value
                        mappings.append({
                            "id": int(key),
                            "last_active": v.get("last_active"),
                            "current_status": v.get("status"),
                            "ip_address": v.get("ip_address")
                        })
                        entry.is_dirty = False
            
            if mappings:
                db = SessionLocal()
                try:
                    db.bulk_update_mappings(UserSession, mappings)
                    db.commit()
                    logger.info(f"[Syncer] Synced {len(mappings)} sessions")
                finally:
                    db.close()
        
        except Exception as e:
            logger.error(f"[Syncer] Session sync error: {e}")
    
    def _sync_audit_logs(self):
        """åŒæ­¥å®¡è®¡æ—¥å¿—åˆ°DBï¼ˆè¯¦è§ç¬¬6ç« ï¼‰"""
        # å®ç°è§ 6.1 èŠ‚
        pass
    
    def _maybe_gc(self):
        """
        æ™ºèƒ½GCï¼šå†…å­˜é˜ˆå€¼é˜²æŠ–
        
        ç­–ç•¥ï¼š
        1. å†…å­˜ä½¿ç”¨ > 80%ï¼šç«‹å³ GCï¼ˆä¸ç®¡æ—¶é—´é—´éš”ï¼‰
        2. å†…å­˜ä½¿ç”¨ < 80%ï¼šæŒ‰æ—¶é—´é—´éš” GCï¼ˆé¿å…é¢‘ç¹ GC é€ æˆ CPU æŠ–åŠ¨ï¼‰
        """
        import psutil
        
        now = time.time()
        mem = psutil.virtual_memory()
        
        # æ¡ä»¶1ï¼šå†…å­˜å‹åŠ›å¤§ï¼Œæ¿€è¿›GC
        need_gc_by_memory = mem.percent > self.MEMORY_THRESHOLD_PERCENT
        # æ¡ä»¶2ï¼šæ—¶é—´åˆ°äº†ï¼Œå¸¸è§„GC
        need_gc_by_time = (now - self._last_gc) > self.gc_interval
        
        if need_gc_by_memory or need_gc_by_time:
            from .manager import UnifiedCache
            result = UnifiedCache.gc()
            
            reason = "memory_pressure" if need_gc_by_memory else "scheduled"
            logger.info(f"[Syncer] GC completed ({reason}, mem={mem.percent}%): {result}")
            self._last_gc = now
    
    def stop(self):
        self.running = False
    
    def force_sync(self):
        """å¼ºåˆ¶åŒæ­¥ï¼ˆä¼˜é›…å…³é—­æ—¶è°ƒç”¨ï¼‰"""
        logger.info("[Syncer] Force sync triggered")
        self._sync_sessions()


# å…¨å±€å•ä¾‹
db_syncer = DatabaseSyncer()
```

### 4.10 é€šç”¨å¯¹å¤–æ¥å£å±‚ (Public Interface Facade)

ä¸ºé™ä½ä¸šåŠ¡å±‚å¯¹åº•å±‚å¼•æ“çš„æ„ŸçŸ¥ï¼Œå¹¶æä¾›ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œé”®ç”Ÿæˆé€»è¾‘ï¼Œå¼•å…¥ `PublicCache` é—¨é¢ã€‚

**è®¾è®¡å›¾**ï¼š

```
ä¸šåŠ¡é€»è¾‘ (API Routers)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      PublicCache         â”‚ â—„â”€â”€ 1. ç»Ÿä¸€å…¥å£ (å•ä¾‹)
â”‚    (Facade é—¨é¢)         â”‚ â—„â”€â”€ 2. é”™è¯¯ç†”æ–­ (Safe Guard)
â”‚                          â”‚ â—„â”€â”€ 3. é”®ç”Ÿæˆå™¨ (Key Builder)
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ é€šç”¨æ¥å£ (Generic) â”‚  â”‚ â—„â”€â”€ get_user, set_session, ...
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ä¸“ç”¨æ¥å£ (Domain)  â”‚  â”‚ â—„â”€â”€ stock_rank, sector_hot, ...
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
     UnifiedCache
     (è·¯ç”±ç½‘å…³)
```

**è®¾è®¡åŸåˆ™**ï¼š

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **é”™è¯¯éš”ç¦»** | ç¼“å­˜å¼‚å¸¸ï¼ˆç£ç›˜æ»¡ã€è¿æ¥æ–­ï¼‰ä¸ä¼šå¯¼è‡´ä¸šåŠ¡å´©æºƒ |
| **é”®å€¼è§„èŒƒ** | ç»Ÿä¸€çš„ Key æ ¼å¼ï¼Œé˜²æ­¢å†²çª |
| **ç±»å‹æç¤º** | IDE å‹å¥½ï¼Œè‡ªåŠ¨è¡¥å…¨ |
| **ä¸šåŠ¡è§£è€¦** | ä¸šåŠ¡å±‚æ— éœ€æ„ŸçŸ¥ ObjectStore/FileStore ç»†èŠ‚ |

#### 4.10.1 å®‰å…¨ç†”æ–­è£…é¥°å™¨

```python
# backend/app/core/caching/facade.py
import logging
import time
from typing import Any, Callable, Optional, TypeVar
from functools import wraps

logger = logging.getLogger(__name__)
T = TypeVar("T")

def safe_cache_call(default_return: Any = None):
    """
    [è£…é¥°å™¨] ç¼“å­˜æ“ä½œçš„å®‰å…¨ç†”æ–­å™¨
    
    å¦‚æœç¼“å­˜å±‚æŠ›å‡ºå¼‚å¸¸ï¼ˆå¦‚ç£ç›˜æ»¡ã€Keyé”™è¯¯ï¼‰ï¼Œæ•è·å¼‚å¸¸å¹¶è®°å½•æ—¥å¿—ï¼Œ
    è¿”å›é»˜è®¤å€¼ï¼Œç¡®ä¿ä¸šåŠ¡é€»è¾‘ä¸å´©æºƒã€‚
    """
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            try:
                return func(*args, **kwargs)
            except Exception as e:
                logger.error(f"[CacheError] {func.__name__} failed: {e}")
                return default_return
        return wrapper
    return decorator
```

#### 4.10.2 é”®ç”Ÿæˆå™¨ (Key Builder)

```python
class KeyBuilder:
    """
    é”®ç”Ÿæˆå™¨ - è§„èŒƒå…¨å±€ Key æ ¼å¼
    
    å‘½åè§„åˆ™ï¼š
    - å†…å­˜ç¼“å­˜ï¼šç›´æ¥ IDï¼ˆsession, user ç­‰ï¼‰
    - ç£ç›˜ç¼“å­˜ï¼šå‰ç¼€:å‚æ•°ï¼ˆapi:xxx, report:xxxï¼‰
    - ä¸šåŠ¡æ•°æ®ï¼šä¸šåŠ¡åŸŸ:å…·ä½“æ ‡è¯†ï¼ˆstock:600000, sector:BK0001ï¼‰
    """
    
    # ========== é€šç”¨é”® ==========
    @staticmethod
    def session(sid: int) -> str:
        return str(sid)
    
    @staticmethod
    def user(uid: int) -> str:
        return str(uid)
    
    @staticmethod
    def config(key: str) -> str:
        return key
    
    # ========== API ç¼“å­˜é”® ==========
    @staticmethod
    def api(endpoint: str, params_hash: str) -> str:
        return f"api:{endpoint}:{params_hash}"
    
    @staticmethod
    def report(report_type: str, params_hash: str) -> str:
        return f"report:{report_type}:{params_hash}"
    
    # ========== è‚¡ç¥¨ä¸šåŠ¡é”® ==========
    @staticmethod
    def stock_daily(date: str) -> str:
        """æ—¥æ•°æ®ç¼“å­˜é”®"""
        return f"daily:{date}"
    
    @staticmethod
    def stock_rank(date: str, top_n: int) -> str:
        """æ’è¡Œæ¦œç¼“å­˜é”®"""
        return f"rank:{date}:{top_n}"
    
    @staticmethod
    def sector_list(date: str) -> str:
        """æ¿å—åˆ—è¡¨ç¼“å­˜é”®"""
        return f"sector:{date}"
    
    @staticmethod
    def hotspot(date: str) -> str:
        """çƒ­ç‚¹åˆ†æç¼“å­˜é”®"""
        return f"hotspot:{date}"
```

#### 4.10.3 PublicCache é—¨é¢å®ç°

```python
from .manager import UnifiedCache

class PublicCache:
    """
    é€šç”¨å¯¹å¤–æ¥å£å±‚ (Facade)
    
    ä¸šåŠ¡å±‚åº”è¯¥åªè°ƒç”¨æ­¤ç±»ï¼Œè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨ UnifiedCacheã€‚
    
    åˆ†ç±»ï¼š
    1. é€šç”¨æ¥å£ï¼šä¼šè¯ã€ç”¨æˆ·ã€é…ç½®ï¼ˆæ‰€æœ‰é¡¹ç›®é€šç”¨ï¼‰
    2. ä¸“ç”¨æ¥å£ï¼šè‚¡ç¥¨ã€æ¿å—ã€çƒ­ç‚¹ï¼ˆæœ¬é¡¹ç›®ç‰¹å®šï¼‰
    """
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    #                    Part 1: é€šç”¨æ¥å£ (Generic)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    # ---------- 1.1 ä¼šè¯ç®¡ç† (Write-Behind) ----------
    
    @staticmethod
    @safe_cache_call(default_return=None)
    def get_session(sid: int) -> Optional[dict]:
        """è·å–ä¼šè¯çŠ¶æ€"""
        return UnifiedCache.session().get(KeyBuilder.session(sid))
    
    @staticmethod
    @safe_cache_call(default_return=None)
    def set_session_heartbeat(sid: int, status: int, ip: str) -> None:
        """æ›´æ–°ä¼šè¯å¿ƒè·³ï¼ˆé«˜é¢‘è°ƒç”¨ï¼‰"""
        data = {
            "status": status,
            "last_active": time.time(),
            "ip_address": ip
        }
        UnifiedCache.session().set(KeyBuilder.session(sid), data)
    
    @staticmethod
    def remove_session(sid: int) -> None:
        """ç§»é™¤ä¼šè¯ï¼ˆç™»å‡ºæ—¶ï¼‰"""
        UnifiedCache.session().delete(KeyBuilder.session(sid))
    
    # ---------- 1.2 ç”¨æˆ·ä¿¡æ¯ (Cache-Aside) ----------
    
    @staticmethod
    @safe_cache_call(default_return=None)
    def get_user(uid: int, loader: Callable[[], dict] = None) -> Optional[dict]:
        """
        è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå¸¦å›æºåŠ è½½ï¼‰
        
        Args:
            uid: ç”¨æˆ·ID
            loader: å›æºåŠ è½½å‡½æ•°ï¼ˆæœªå‘½ä¸­æ—¶è°ƒç”¨ï¼‰
        """
        return UnifiedCache.user().get(KeyBuilder.user(uid), loader=loader)
    
    @staticmethod
    def invalidate_user(uid: int) -> None:
        """ç”¨æˆ·æ•°æ®å¤±æ•ˆï¼ˆä¿®æ”¹èµ„æ–™åè°ƒç”¨ï¼‰"""
        UnifiedCache.user().delete(KeyBuilder.user(uid))
    
    # ---------- 1.3 ç³»ç»Ÿé…ç½® (Cache-Aside) ----------
    
    @staticmethod
    @safe_cache_call(default_return=None)
    def get_config(key: str, loader: Callable = None) -> Any:
        """è·å–ç³»ç»Ÿé…ç½®"""
        return UnifiedCache.config().get(KeyBuilder.config(key), loader=loader)
    
    @staticmethod
    def set_config(key: str, value: Any) -> None:
        """è®¾ç½®ç³»ç»Ÿé…ç½®ï¼ˆWrite-Through å»ºè®®åœ¨ä¸šåŠ¡å±‚å…ˆå†™DBï¼‰"""
        UnifiedCache.config().set(KeyBuilder.config(key), value)
    
    # ---------- 1.4 API å“åº”ç¼“å­˜ (FileStore) ----------
    
    @staticmethod
    @safe_cache_call(default_return=None)
    def get_api_cache(endpoint: str, params_hash: str, loader: Callable = None) -> Any:
        """
        é€šç”¨ API å“åº”ç¼“å­˜
        
        Args:
            endpoint: API ç«¯ç‚¹åï¼ˆå¦‚ "daily_rank"ï¼‰
            params_hash: å‚æ•°å“ˆå¸Œ
            loader: æœªå‘½ä¸­æ—¶çš„è®¡ç®—å‡½æ•°
        """
        key = KeyBuilder.api(endpoint, params_hash)
        return UnifiedCache.api().get(key, loader=loader)
    
    @staticmethod
    @safe_cache_call(default_return=None)
    def set_api_cache(endpoint: str, params_hash: str, value: Any, ttl: int = 300) -> None:
        """è®¾ç½® API ç¼“å­˜"""
        key = KeyBuilder.api(endpoint, params_hash)
        UnifiedCache.api().set(key, value, ttl=ttl)
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    #                Part 2: ä¸“ç”¨æ¥å£ (Domain-Specific)
    #                    é’ˆå¯¹è‚¡ç¥¨åˆ†æç³»ç»Ÿçš„ä¸šåŠ¡æ¥å£
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    # ---------- 2.1 è‚¡ç¥¨æ•°æ®æŸ¥è¯¢ (VectorStore) ----------
    
    @staticmethod
    def stock_rank(date: str, top_n: int = 100) -> list:
        """
        è·å–æ—¥æ’è¡Œæ¦œ
        
        ç›´æ¥é€ä¼ åˆ° Numpy å±‚ï¼Œä¸åŠ  safe_cache_call
        ï¼ˆVectorStore æ˜¯æ ¸å¿ƒåŠŸèƒ½ï¼Œå¼‚å¸¸éœ€è¦æš´éœ²ï¼‰
        """
        return UnifiedCache.stock().query("get_top_n_by_rank", date, top_n)
    
    @staticmethod
    def stock_by_code(code: str) -> Optional[dict]:
        """è·å–ä¸ªè‚¡è¯¦æƒ…"""
        return UnifiedCache.stock().query("get_stock_by_code", code)
    
    @staticmethod
    def stock_by_codes(codes: list) -> list:
        """æ‰¹é‡è·å–è‚¡ç¥¨æ•°æ®"""
        return UnifiedCache.stock().query("get_stocks_by_codes", codes)
    
    @staticmethod
    def stock_history(code: str, start_date: str, end_date: str) -> list:
        """è·å–è‚¡ç¥¨å†å²æ•°æ®"""
        return UnifiedCache.stock().query("get_history", code, start_date, end_date)
    
    # ---------- 2.2 æ¿å—æ•°æ® (VectorStore + FileStore) ----------
    
    @staticmethod
    def sector_list(date: str) -> list:
        """è·å–æ¿å—åˆ—è¡¨"""
        return UnifiedCache.stock().query("get_sectors", date)
    
    @staticmethod
    def sector_stocks(sector_code: str, date: str) -> list:
        """è·å–æ¿å—æˆåˆ†è‚¡"""
        return UnifiedCache.stock().query("get_sector_stocks", sector_code, date)
    
    @staticmethod
    @safe_cache_call(default_return=None)
    def sector_analysis(sector_code: str, date: str, loader: Callable = None) -> dict:
        """
        æ¿å—æ·±åº¦åˆ†æï¼ˆè€—æ—¶è®¡ç®—ï¼Œç»“æœç¼“å­˜åˆ°ç£ç›˜ï¼‰
        """
        key = f"sector_analysis:{sector_code}:{date}"
        return UnifiedCache.api().get(key, loader=loader)
    
    # ---------- 2.3 çƒ­ç‚¹åˆ†æ (FileStore) ----------
    
    @staticmethod
    @safe_cache_call(default_return=None)
    def hotspot_daily(date: str, loader: Callable = None) -> dict:
        """
        æ¯æ—¥çƒ­ç‚¹åˆ†æï¼ˆè€—æ—¶è®¡ç®—ï¼Œç¼“å­˜24å°æ—¶ï¼‰
        """
        key = KeyBuilder.hotspot(date)
        return UnifiedCache.api().get(key, loader=loader)
    
    @staticmethod
    @safe_cache_call(default_return=None)
    def cache_hotspot(date: str, data: dict) -> None:
        """ç¼“å­˜çƒ­ç‚¹åˆ†æç»“æœ"""
        key = KeyBuilder.hotspot(date)
        UnifiedCache.api().set(key, data, ttl=86400)  # 24å°æ—¶
    
    # ---------- 2.4 ä¿¡å·ç³»ç»Ÿ (FileStore) ----------
    
    @staticmethod
    @safe_cache_call(default_return=None)
    def signal_scan(date: str, signal_type: str, loader: Callable = None) -> list:
        """
        ä¿¡å·æ‰«æç»“æœï¼ˆè€—æ—¶è®¡ç®—ï¼Œç¼“å­˜åˆ°ç£ç›˜ï¼‰
        
        Args:
            date: æ—¥æœŸ
            signal_type: ä¿¡å·ç±»å‹ï¼ˆå¦‚ "danzhen", "tupo"ï¼‰
            loader: è®¡ç®—å‡½æ•°
        """
        key = f"signal:{signal_type}:{date}"
        return UnifiedCache.api().get(key, loader=loader)
    
    # ---------- 2.5 è¡Œä¸šè·³å˜ (FileStore) ----------
    
    @staticmethod
    @safe_cache_call(default_return=None)
    def industry_jump(date: str, days: int = 5, loader: Callable = None) -> list:
        """
        è¡Œä¸šè·³å˜åˆ†æï¼ˆè·¨æ—¥æœŸè®¡ç®—ï¼Œç»“æœè¾ƒå¤§ï¼‰
        """
        key = f"industry_jump:{date}:{days}"
        return UnifiedCache.api().get(key, loader=loader)
    
    # ---------- 2.6 æŠ¥è¡¨ç”Ÿæˆ (FileStore - å¤§æ–‡ä»¶) ----------
    
    @staticmethod
    @safe_cache_call(default_return=None)
    def get_report(report_type: str, params_hash: str) -> Optional[str]:
        """è·å–å·²ç”Ÿæˆçš„æŠ¥è¡¨"""
        key = KeyBuilder.report(report_type, params_hash)
        return UnifiedCache.report().get(key)
    
    @staticmethod
    @safe_cache_call(default_return=None)
    def cache_report(report_type: str, params_hash: str, content: str, ttl: int = 86400) -> None:
        """
        ç¼“å­˜ç”Ÿæˆçš„æŠ¥è¡¨ï¼ˆHTML/PDFå­—ç¬¦ä¸²ï¼‰
        
        Args:
            report_type: æŠ¥è¡¨ç±»å‹ï¼ˆdaily_summary, sector_deep, stock_detailï¼‰
            params_hash: å‚æ•°å“ˆå¸Œ
            content: æŠ¥è¡¨å†…å®¹
            ttl: è¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤24å°æ—¶ï¼‰
        """
        key = KeyBuilder.report(report_type, params_hash)
        UnifiedCache.report().set(key, content, ttl=ttl)
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    #                    Part 3: ç®¡ç†æ¥å£ (Admin)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    @staticmethod
    def stats() -> dict:
        """è·å–æ‰€æœ‰ç¼“å­˜ç»Ÿè®¡"""
        return UnifiedCache.stats()
    
    @staticmethod
    def gc() -> dict:
        """è§¦å‘ GC"""
        return UnifiedCache.gc()
    
    @staticmethod
    def clear_api_cache() -> None:
        """æ¸…ç©º API ç¼“å­˜"""
        UnifiedCache.api().clear()
    
    @staticmethod
    def clear_report_cache() -> None:
        """æ¸…ç©ºæŠ¥è¡¨ç¼“å­˜"""
        UnifiedCache.report().clear()
    
    @staticmethod
    def reload_stock_data() -> None:
        """é‡æ–°åŠ è½½è‚¡ç¥¨æ•°æ®"""
        UnifiedCache.stock().reload()


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                     å¯¼å‡ºå…¨å±€å•ä¾‹
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

cache = PublicCache()
```

#### 4.10.4 ä¸šåŠ¡å±‚è°ƒç”¨ç¤ºä¾‹

**ä¿®æ”¹å‰ï¼ˆä¾èµ–åº•å±‚ç»†èŠ‚ï¼‰**ï¼š

```python
# âŒ é—®é¢˜ï¼šKey æ ¼å¼æ•£è½å„å¤„ï¼Œå¼‚å¸¸æœªå¤„ç†ï¼Œè€¦åˆä¸¥é‡
from app.core.cache.manager import UnifiedCache

cache_key = f"heavy:{date}"  # æ‰‹å†™ Keyï¼Œå®¹æ˜“æ‹¼é”™
result = UnifiedCache.api().get(cache_key, loader=...)  # ç£ç›˜å¼‚å¸¸ä¼šå´©
```

**ä¿®æ”¹åï¼ˆä½¿ç”¨é€šç”¨æ¥å£ï¼‰**ï¼š

```python
# âœ… æ¨èï¼šç»Ÿä¸€å…¥å£ï¼Œè‡ªåŠ¨é”™è¯¯å¤„ç†ï¼ŒKey è§„èŒƒ
from app.core.cache.facade import cache

# ä¼šè¯å¿ƒè·³
cache.set_session_heartbeat(session_id, status=1, ip="127.0.0.1")

# ç”¨æˆ·ä¿¡æ¯ï¼ˆå¸¦å›æºï¼‰
user = cache.get_user(user_id, loader=lambda: db.query(User).get(user_id).to_dict())

# è‚¡ç¥¨æ’è¡Œ
rank = cache.stock_rank("2024-01-15", top_n=100)

# çƒ­ç‚¹åˆ†æï¼ˆè‡ªåŠ¨ç¼“å­˜ï¼‰
hotspot = cache.hotspot_daily("2024-01-15", loader=lambda: analyze_hotspot("2024-01-15"))

# ä¿¡å·æ‰«æ
signals = cache.signal_scan("2024-01-15", "danzhen", loader=lambda: scan_danzhen("2024-01-15"))

# æŠ¥è¡¨ç¼“å­˜
cache.cache_report("daily_summary", "hash123", html_content, ttl=86400)
```

---

## 5. å†…å­˜ä¼˜åŒ–ç­–ç•¥

### 5.1 Strict Slots è§„èŒƒ

æ‰€æœ‰ç¼“å­˜å€¼å¯¹è±¡å¿…é¡»ä½¿ç”¨ `__slots__`ï¼š

```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ __slots__
class SessionData:
    __slots__ = ('user_id', 'status', 'last_active', 'ip_address')
    
    def __init__(self, user_id, status, last_active, ip_address):
        self.user_id = user_id
        self.status = status  # int: 1/2/3ï¼Œä¸ç”¨ str
        self.last_active = last_active
        self.ip_address = ip_address

# âŒ é”™è¯¯ï¼šä½¿ç”¨æ™®é€šå­—å…¸
session = {"user_id": 1, "status": "online", ...}  # å†…å­˜æµªè´¹ 70%+
```

### 5.2 String Interning (å­—ç¬¦ä¸²é©»ç•™)

å¯¹é‡å¤ç‡é«˜çš„å­—ç¬¦ä¸²ä½¿ç”¨ `sys.intern()`:

```python
import sys

# çŠ¶æ€å­˜ int è€Œé str
status = 1  # âœ… è€Œé "online"

# é«˜é¢‘é‡å¤å­—ç¬¦ä¸²é©»ç•™
platform = sys.intern("Windows")
app_version = sys.intern("1.0.0")
```

### 5.3 Lazy Loading ç­–ç•¥

| åˆ†åŒº | åŠ è½½ç­–ç•¥ | åŸå›  |
|------|----------|------|
| `sessions` | å¯åŠ¨é¢„çƒ­ | ä¼šè¯çŠ¶æ€éœ€ç«‹å³å¯ç”¨ |
| `users` | æ‡’åŠ è½½ | åªç¼“å­˜æ´»è·ƒç”¨æˆ·ï¼ŒæŒ‰éœ€åŠ è½½ |
| `config` | å¯åŠ¨é¢„çƒ­ | é…ç½®é¡¹æœ‰é™ï¼Œå…¨é‡åŠ è½½ |
| `stock_market` | å¯åŠ¨é¢„çƒ­ | æ ¸å¿ƒä¸šåŠ¡ï¼Œå¿…é¡»é¢„çƒ­ |

### 5.4 ä¸»åŠ¨GC

```python
# Syncer ä¸­æ¯ 5 åˆ†é’Ÿè§¦å‘ä¸€æ¬¡
import gc

def periodic_gc():
    # 1. æ¸…ç†è¿‡æœŸç¼“å­˜
    UnifiedCache.gc()
    
    # 2. å¼ºåˆ¶Python GC
    gc.collect()
```

---

## 6. æ—¥å¿—ç³»ç»Ÿè®¾è®¡ (Dual-Track Logging)

é’ˆå¯¹ 2C2G æœåŠ¡å™¨å’Œ"ä¸“ä¸šåŒ–ç®¡ç†"éœ€æ±‚ï¼Œé‡‡ç”¨**åŒè½¨åˆ¶**æ—¥å¿—è®¾è®¡ï¼šä¸šåŠ¡å®¡è®¡æ—¥å¿—å­˜æ•°æ®åº“ï¼ˆå¯æŸ¥è¯¢ï¼‰ï¼Œç³»ç»Ÿè°ƒè¯•æ—¥å¿—å­˜æ–‡ä»¶ï¼ˆè‡ªåŠ¨è½®è½¬ï¼‰ã€‚

### 6.1 ä¸šåŠ¡å®¡è®¡æ—¥å¿— (Audit Log â†’ PostgreSQL)

**ç”¨é€”**ï¼šç»™ç®¡ç†å‘˜çœ‹ï¼ˆè°ç™»å½•äº†ï¼Ÿè°æ”¹äº†å¯†ç ï¼Ÿè°è¢«è¸¢äº†ï¼Ÿï¼‰

**è®¾è®¡**ï¼šåˆ©ç”¨ `UnifiedCache` çš„ Write-Behind èƒ½åŠ›ï¼Œæ‰¹é‡å†™å…¥æ•°æ®åº“

```python
from dataclasses import dataclass
from typing import List, Optional
from datetime import datetime
import threading

@dataclass
class AuditLogEntry:
    """å®¡è®¡æ—¥å¿—æ¡ç›®"""
    __slots__ = ('user_id', 'action', 'target', 'detail', 'ip', 'created_at')
    
    user_id: int
    action: str       # login, logout, password_change, force_logout, etc.
    target: str       # æ“ä½œå¯¹è±¡ï¼ˆå¦‚è¢«è¸¢çš„ç”¨æˆ·IDï¼‰
    detail: str       # JSON è¯¦æƒ…
    ip: str
    created_at: datetime


class AuditLogBuffer:
    """
    å®¡è®¡æ—¥å¿—ç¼“å†²åŒº - Write-Behind æ¨¡å¼
    
    ä¸šåŠ¡ä»£ç è°ƒç”¨ log() æ—¶ï¼Œç›´æ¥ push åˆ°å†…å­˜é˜Ÿåˆ—
    DatabaseSyncer æ¯ 10 ç§’æ‰¹é‡ Insert åˆ° operation_logs è¡¨
    """
    
    def __init__(self, max_size: int = 1000):
        self._buffer: List[AuditLogEntry] = []
        self._lock = threading.Lock()
        self.max_size = max_size
    
    def log(
        self, 
        user_id: int, 
        action: str, 
        target: str = "", 
        detail: str = "", 
        ip: str = ""
    ) -> None:
        """è®°å½•å®¡è®¡æ—¥å¿—ï¼ˆå†…å­˜æ“ä½œï¼Œå¾®ç§’çº§ï¼‰"""
        entry = AuditLogEntry(
            user_id=user_id,
            action=action,
            target=target,
            detail=detail,
            ip=ip,
            created_at=datetime.utcnow()
        )
        with self._lock:
            self._buffer.append(entry)
            # é˜²æ­¢å†…å­˜æº¢å‡ºï¼šè¶…è¿‡ä¸Šé™æ—¶ä¸¢å¼ƒæœ€æ—§çš„
            if len(self._buffer) > self.max_size:
                self._buffer.pop(0)
    
    def flush(self) -> List[AuditLogEntry]:
        """è·å–å¹¶æ¸…ç©ºç¼“å†²åŒºï¼ˆSyncer è°ƒç”¨ï¼‰"""
        with self._lock:
            entries = self._buffer.copy()
            self._buffer.clear()
            return entries
    
    def stats(self) -> dict:
        with self._lock:
            return {"pending": len(self._buffer), "max_size": self.max_size}


# å…¨å±€å•ä¾‹
audit_log = AuditLogBuffer()
```

**DatabaseSyncer é›†æˆ**ï¼š

```python
# åœ¨ DatabaseSyncer._sync_audit_logs() ä¸­å®ç°
def _sync_audit_logs(self):
    """åŒæ­¥å®¡è®¡æ—¥å¿—åˆ°DB"""
    from ..db_models import OperationLog
    from ..database import SessionLocal
    
    entries = audit_log.flush()
    if not entries:
        return
    
    db = SessionLocal()
    try:
        for entry in entries:
            log = OperationLog(
                user_id=entry.user_id,
                action=entry.action,
                target=entry.target,
                detail=entry.detail,
                ip_address=entry.ip,
                created_at=entry.created_at
            )
            db.add(log)
        db.commit()
        logger.info(f"[Syncer] Flushed {len(entries)} audit logs")
    except Exception as e:
        logger.error(f"[Syncer] Audit log error: {e}")
        db.rollback()
    finally:
        db.close()
```

**ä¸šåŠ¡å±‚ä½¿ç”¨**ï¼š

```python
# ç™»å½•æ—¶è®°å½•
audit_log.log(user.id, "login", ip=request.client.host)

# ä¿®æ”¹å¯†ç æ—¶è®°å½•
audit_log.log(user.id, "password_change", detail='{"method": "self"}')

# ç®¡ç†å‘˜è¸¢äººæ—¶è®°å½•
audit_log.log(admin.id, "force_logout", target=str(target_user_id))
```

### 6.2 ç³»ç»Ÿè°ƒè¯•æ—¥å¿— (System Log â†’ æ–‡ä»¶)

**ç”¨é€”**ï¼šç»™å¼€å‘äººå‘˜çœ‹ï¼ˆæŠ¥é”™å †æ ˆã€æ€§èƒ½è­¦å‘Šã€ç³»ç»Ÿå¯åŠ¨ä¿¡æ¯ï¼‰

**å·¥å…·**ï¼šæ¨è `loguru`ï¼Œé…ç½®æ›´ç®€å•ï¼Œè‡ªåŠ¨è½®è½¬

```python
# backend/app/core/logger.py
import sys
from loguru import logger

# 1. ç§»é™¤é»˜è®¤å¤„ç†ç¨‹åº
logger.remove()

# 2. æ§åˆ¶å°è¾“å‡º (å¼€å‘ç¯å¢ƒ)
logger.add(
    sys.stderr, 
    level="DEBUG" if DEBUG else "INFO",
    format="<green>{time:HH:mm:ss}</green> | <level>{level: <8}</level> | {message}"
)

# 3. æ–‡ä»¶è¾“å‡º (ç”Ÿäº§ç¯å¢ƒ - å…³é”®é…ç½®)
# âš ï¸ å¿…é¡»è®¾ç½® rotation å’Œ retentionï¼Œé˜²æ­¢ç£ç›˜è¢«æ—¥å¿—æ’‘çˆ†
logger.add(
    "logs/app.log",
    rotation="10 MB",      # æ¯ä¸ªæ–‡ä»¶æœ€å¤§ 10MB
    retention="7 days",    # åªä¿ç•™æœ€è¿‘ 7 å¤©
    level="WARNING",       # ç”Ÿäº§ç¯å¢ƒåªè®°å½• WARNING ä»¥ä¸Š (èŠ‚çœIO)
    compression="zip",     # è½®è½¬åå‹ç¼© (èŠ‚çœç£ç›˜)
    enqueue=True,          # çº¿ç¨‹å®‰å…¨
    format="{time:YYYY-MM-DD HH:mm:ss} | {level} | {module}:{function}:{line} - {message}"
)

# 4. å•ç‹¬çš„é”™è¯¯æ—¥å¿— (ä¾¿äºå¿«é€Ÿå®šä½ Bug)
logger.add(
    "logs/error.log",
    rotation="10 MB",
    retention="30 days",   # é”™è¯¯æ—¥å¿—ä¿ç•™æ›´ä¹…
    level="ERROR",
    backtrace=True,        # è¯¦ç»†å †æ ˆ
    diagnose=True          # å˜é‡è¯Šæ–­
)

# å¯¼å‡ºç»™å…¶ä»–æ¨¡å—ä½¿ç”¨
__all__ = ["logger"]
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```python
from app.core.logger import logger

logger.info("Server started")
logger.warning(f"Memory usage high: {mem_percent}%")
logger.error(f"Database connection failed: {e}")
logger.exception("Unhandled exception")  # è‡ªåŠ¨è®°å½•å †æ ˆ
```

### 6.3 æ—¥å¿—ç³»ç»Ÿå¯¹æ¯”

| æ–¹é¢ | å®¡è®¡æ—¥å¿— (AuditLog) | ç³»ç»Ÿæ—¥å¿— (Loguru) |
|------|---------------------|-------------------|
| **å­˜å‚¨ä½ç½®** | PostgreSQL | æ–‡ä»¶ (logs/*.log) |
| **æŸ¥è¯¢æ–¹å¼** | SQL / API | grep / æ—¥å¿—å·¥å…· |
| **ç›®æ ‡ç”¨æˆ·** | ç®¡ç†å‘˜ | å¼€å‘äººå‘˜ |
| **å†…å®¹ç±»å‹** | ä¸šåŠ¡æ“ä½œè®°å½• | ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ |
| **å†™å…¥æ¨¡å¼** | Write-Behind æ‰¹é‡ | å®æ—¶å†™å…¥ |
| **ä¿ç•™ç­–ç•¥** | æ•°æ®åº“å½’æ¡£ | 7å¤©è½®è½¬å‹ç¼© |
| **æ€§èƒ½å½±å“** | æä½ (å†…å­˜ç¼“å†²) | ä½ (å¼‚æ­¥é˜Ÿåˆ—) |

---

## 7. åº”ç”¨åœºæ™¯æ˜ å°„

### 7.1 åˆ†åŒºæ³¨å†Œï¼ˆå¯åŠ¨æ—¶ï¼‰

```python
from contextlib import asynccontextmanager
from fastapi import FastAPI

@asynccontextmanager
async def lifespan(app: FastAPI):
    # ========== å¯åŠ¨æ—¶ ==========
    
    # 1. æ³¨å†Œä¼šè¯ç¼“å­˜ (Write-Behind, 30åˆ†é’Ÿè¿‡æœŸ)
    UnifiedCache.register(
        "sessions",
        ObjectStore("sessions", WriteBehindPolicy(ttl=1800, sync_interval=10))
    )
    
    # 2. æ³¨å†Œç”¨æˆ·ç¼“å­˜ (Cache-Aside, 1å°æ—¶è¿‡æœŸ)
    UnifiedCache.register(
        "users",
        ObjectStore("users", CacheAsidePolicy(ttl=3600))
    )
    
    # 3. æ³¨å†Œé…ç½®ç¼“å­˜ (Cache-Aside, æ°¸ä¸è¿‡æœŸ)
    UnifiedCache.register(
        "config",
        ObjectStore("config", CacheAsidePolicy(ttl=0))
    )
    
    # 4. æ³¨å†Œè‚¡ç¥¨æ•°æ® (å°è£…åŸæœ‰Numpyç¼“å­˜)
    from ..services.numpy_cache_middleware import NumpyCacheMiddleware
    numpy_core = NumpyCacheMiddleware()
    numpy_core.load_from_db()
    UnifiedCache.register(
        "stock_market",
        VectorStore(numpy_core)
    )
    
    # 5. ğŸ†• æ³¨å†Œ API å“åº”ç¼“å­˜ (ç£ç›˜, 200MBä¸Šé™)
    UnifiedCache.register(
        "api_response",
        FileStore("api_response", cache_dir=".cache/api", size_limit_gb=0.2)
    )
    
    # 6. ğŸ†• æ³¨å†ŒæŠ¥è¡¨æ–‡ä»¶ç¼“å­˜ (ç£ç›˜, 500MBä¸Šé™)
    UnifiedCache.register(
        "reports",
        FileStore("reports", cache_dir=".cache/reports", size_limit_gb=0.5)
    )
    
    # 7. å¯åŠ¨åŒæ­¥çº¿ç¨‹
    db_syncer.start()
    
    yield
    
    # ========== å…³é—­æ—¶ ==========
    db_syncer.force_sync()
    db_syncer.stop()


app = FastAPI(lifespan=lifespan)
```

### 7.2 åœºæ™¯Aï¼šä¼šè¯å¿ƒè·³ (Write-Behind)

```python
def update_heartbeat(session_id: int, status: int, ip: str):
    """å¤„ç†å¿ƒè·³ - æå¿«ï¼Œæ— DBæ“ä½œ"""
    UnifiedCache.session().set(
        key=str(session_id),
        value={
            "status": status,
            "last_active": time.time(),
            "ip_address": ip
        }
    )
    # åå°çº¿ç¨‹æ¯10ç§’æ‰¹é‡åŒæ­¥åˆ°DB
```

### 7.3 åœºæ™¯Bï¼šç”¨æˆ·ä¿¡æ¯ (Cache-Aside)

```python
def get_user_profile(user_id: int) -> dict:
    """è·å–ç”¨æˆ·ä¿¡æ¯ - è‡ªåŠ¨å¤„ç†ç¼“å­˜ç©¿é€"""
    return UnifiedCache.user().get(
        key=str(user_id),
        loader=lambda: db.query(User).get(user_id).to_dict()  # æœªå‘½ä¸­æ—¶å›æº
    )

def update_user_profile(user_id: int, data: dict):
    """æ›´æ–°ç”¨æˆ·ä¿¡æ¯ - å…ˆå†™DBï¼Œå†åˆ ç¼“å­˜"""
    UnifiedCache.user().set(
        key=str(user_id),
        value=data,
        persister=lambda val: db.execute(update_stmt)  # åŒæ­¥å†™DB
    )
    # ä¸‹æ¬¡è¯»å–æ—¶è‡ªåŠ¨é‡æ–°åŠ è½½
```

### 7.4 åœºæ™¯Cï¼šè‚¡ç¥¨æ•°æ®æŸ¥è¯¢ (VectorStore)

```python
def get_daily_rank(date: str, top_n: int = 100):
    """è·å–æ—¥æ’è¡Œ - é€ä¼ åˆ°NumpyæŸ¥è¯¢"""
    return UnifiedCache.stock().query("get_top_n_by_rank", date, top_n)

def get_stock_detail(code: str):
    """è·å–ä¸ªè‚¡è¯¦æƒ…"""
    return UnifiedCache.stock().query("get_stock_by_code", code)
```

### 7.5 åœºæ™¯Dï¼šç³»ç»Ÿé…ç½® (Write-Through)

```python
# å¯¹äºæå…³é”®çš„é…ç½®ï¼Œä½¿ç”¨ Write-Through
def update_security_config(key: str, value: Any):
    """æ›´æ–°å®‰å…¨é…ç½® - å¼ºä¸€è‡´æ€§"""
    # 1. åŒæ­¥å†™DB
    db.execute(update_config_stmt)
    db.commit()
    
    # 2. æ›´æ–°å†…å­˜
    UnifiedCache.config().set(key, value)
```

### 7.6 åœºæ™¯Eï¼šAPIå“åº”ç¼“å­˜ (FileStore)

```python
@router.get("/heavy-calculation")
def get_heavy_data(date: str):
    """è€—æ—¶è®¡ç®— - ç»“æœç¼“å­˜åˆ°ç£ç›˜"""
    cache_key = f"heavy:{date}"
    
    return UnifiedCache.api().get(
        key=cache_key,
        loader=lambda: complex_calculation(date)  # æœªå‘½ä¸­æ—¶è®¡ç®—å¹¶ç¼“å­˜
    )


@router.post("/generate-report")
def generate_report(params: ReportParams):
    """ç”ŸæˆæŠ¥å‘Š - å¤§æ–‡ä»¶å­˜ç£ç›˜"""
    report_key = f"report:{params.hash()}"
    
    # å…ˆæŸ¥ç¼“å­˜
    cached = UnifiedCache.report().get(report_key)
    if cached:
        return cached
    
    # ç”ŸæˆæŠ¥å‘Š (>10KB çš„å¤§æ–‡æœ¬)
    report_html = generate_html_report(params)
    
    # å­˜å…¥ç£ç›˜ç¼“å­˜ (24å°æ—¶è¿‡æœŸ)
    UnifiedCache.report().set(report_key, report_html, ttl=86400)
    
    return report_html
```

### 7.7 åœºæ™¯Fï¼šç®¡ç†å‘˜æ¸…ç†ç¼“å­˜

```python
@router.post("/admin/clear-cache")
def clear_system_cache(admin: User = Depends(require_admin)):
    """ç®¡ç†å‘˜ä¸€é”®æ¸…ç†æ‰€æœ‰ç¼“å­˜"""
    result = {
        # L1 å†…å­˜å±‚
        "sessions": UnifiedCache.session().clear_expired(),
        "users": UnifiedCache.user().clear_expired(),
        
        # L2 ç£ç›˜å±‚
        "api_response": "cleared" if UnifiedCache.api().clear() else "failed",
        "reports": "cleared" if UnifiedCache.report().clear() else "failed",
        
        # VectorStore
        "stock_market": "reload triggered"
    }
    
    # é‡æ–°åŠ è½½ Numpy æ•°æ®
    UnifiedCache.stock().reload()
    
    return {"success": True, "result": result}
```

---

## 8. é£é™©æ§åˆ¶

### 8.1 å•è¿›ç¨‹éƒ¨ç½²çº¦æŸ

| é£é™© | å½±å“ | å¯¹ç­– |
|------|------|------|
| å¤šWorkerè¿›ç¨‹ | çŠ¶æ€ä¸åŒæ­¥ | **å¼ºåˆ¶ `--workers 1`** |
| è´Ÿè½½å‡è¡¡ | å¿ƒè·³è·¯ç”±ä¸ä¸€è‡´ | æœ¬ç³»ç»Ÿä¸ºå†…éƒ¨å·¥å…·ï¼Œæ— éœ€LB |

```bash
# ç”Ÿäº§éƒ¨ç½²å‘½ä»¤
gunicorn app.main:app -w 1 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

### 8.2 è¿›ç¨‹å´©æºƒé£é™©

| é£é™© | å½±å“ | å¯¹ç­– |
|------|------|------|
| æœªåŒæ­¥æ•°æ®ä¸¢å¤± | æœ€å¤šä¸¢å¤±10ç§’å¿ƒè·³ | **ä¸šåŠ¡å¯æ¥å—** |
| å†…å­˜çŠ¶æ€ä¸¢å¤± | é‡å¯åéœ€é‡å»º | **å¯åŠ¨é¢„çƒ­** |

```python
# å¯åŠ¨é¢„çƒ­é€»è¾‘
def load_active_sessions():
    threshold = datetime.utcnow() - timedelta(minutes=30)
    sessions = db.query(UserSession).filter(
        UserSession.last_active > threshold
    ).all()
    
    for s in sessions:
        UnifiedCache.session().set(str(s.id), s.to_cache_dict())
```

### 8.3 å†…å­˜æ³„æ¼é˜²æŠ¤

| é£é™© | å½±å“ | å¯¹ç­– |
|------|------|------|
| ç¼“å­˜åªå¢ä¸å‡ | å†…å­˜çˆ†æ»¡ | TTL + æƒ°æ€§æ¸…ç† |
| Python GCæƒ°æ€§ | å†…å­˜ç¢ç‰‡ | ä¸»åŠ¨ `gc.collect()` |

### 8.4 çº¿ç¨‹å®‰å…¨ä¿éšœ

æ‰€æœ‰ ObjectStore æ“ä½œéƒ½åœ¨ `RLock` ä¿æŠ¤ä¸‹è¿›è¡Œï¼š

```python
class ObjectStore:
    def __init__(self):
        self._lock = threading.RLock()  # å¯é‡å…¥é”
    
    def get(self, key, loader=None):
        with self._lock:  # æ‰€æœ‰è¯»å†™éƒ½åŠ é”
            ...
```

---

## 9. å®æ–½è®¡åˆ’

### 9.1 ç›®å½•ç»“æ„

```
backend/app/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ caching/                  # ğŸ†• ç»Ÿä¸€ç¼“å­˜æ¨¡å— (æ³¨æ„: ç”¨ caching é¿å… .gitignore å†²çª)
â”‚   â”‚   â”œâ”€â”€ __init__.py           # å¯¼å‡º cache å•ä¾‹
â”‚   â”‚   â”œâ”€â”€ entry.py              # CacheEntry (Slots + Generic)
â”‚   â”‚   â”œâ”€â”€ policy.py             # CachePolicy ç­–ç•¥æ¥å£
â”‚   â”‚   â”œâ”€â”€ policies/
â”‚   â”‚   â”‚   â”œâ”€â”€ write_behind.py   # Write-Behind å®ç°
â”‚   â”‚   â”‚   â”œâ”€â”€ cache_aside.py    # Cache-Aside å®ç°
â”‚   â”‚   â”‚   â””â”€â”€ write_through.py  # Write-Through å®ç°
â”‚   â”‚   â”œâ”€â”€ store.py              # ObjectStore, VectorStore, FileStore
â”‚   â”‚   â”œâ”€â”€ manager.py            # UnifiedCache ç®¡ç†å™¨
â”‚   â”‚   â”œâ”€â”€ syncer.py             # DatabaseSyncer (å«GCé˜²æŠ–)
â”‚   â”‚   â””â”€â”€ facade.py             # ğŸ†• PublicCache é—¨é¢ + KeyBuilder
â”‚   â”‚
â”‚   â”œâ”€â”€ logger.py                 # ğŸ†• ç³»ç»Ÿè°ƒè¯•æ—¥å¿— (Loguru)
â”‚   â””â”€â”€ audit.py                  # ğŸ†• ä¸šåŠ¡å®¡è®¡æ—¥å¿— (AuditLogBuffer)
â”‚
â”œâ”€â”€ services/
â”‚   â””â”€â”€ numpy_cache_middleware.py # åŸæœ‰ï¼Œè¢«VectorStoreå°è£…
â”‚
â”œâ”€â”€ .cache/                       # ğŸ†• ç£ç›˜ç¼“å­˜ç›®å½•
â”‚   â”œâ”€â”€ api/                      # APIå“åº”ç¼“å­˜
â”‚   â””â”€â”€ reports/                  # æŠ¥è¡¨æ–‡ä»¶ç¼“å­˜
â”‚
â”œâ”€â”€ logs/                         # ğŸ†• æ—¥å¿—ç›®å½•
â”‚   â”œâ”€â”€ app.log                   # ç³»ç»Ÿæ—¥å¿—
â”‚   â””â”€â”€ error.log                 # é”™è¯¯æ—¥å¿—
â”‚
â””â”€â”€ main.py                       # é›†æˆ lifespan
```

### 9.2 å®æ–½é˜¶æ®µ

#### Phase 1: æ ¸å¿ƒæ¡†æ¶ (1å¤©)

| ä»»åŠ¡ | äº§å‡º |
|------|------|
| åˆ›å»º `core/cache/` ç›®å½• | ç›®å½•ç»“æ„ |
| å®ç° `CacheEntry` (Generic) | entry.py |
| å®ç° `CachePolicy` æ¥å£ | policy.py |
| å®ç° Write-Behind ç­–ç•¥ | write_behind.py |
| å®ç° Cache-Aside ç­–ç•¥ | cache_aside.py |

#### Phase 2: å­˜å‚¨å¼•æ“ (1å¤©)

| ä»»åŠ¡ | äº§å‡º |
|------|------|
| å®ç° `ObjectStore` | store.py |
| å®ç° `VectorStore` (å°è£…Numpy) | store.py |
| å®ç° `FileStore` (å°è£…DiskCache) | store.py |
| å®ç° `UnifiedCache` | manager.py |

#### Phase 2.5: å¯¹å¤–æ¥å£å±‚ (0.5å¤©) ğŸ†•

| ä»»åŠ¡ | äº§å‡º |
|------|------|
| å®ç° `KeyBuilder` é”®ç”Ÿæˆå™¨ | facade.py |
| å®ç° `safe_cache_call` ç†”æ–­è£…é¥°å™¨ | facade.py |
| å®ç° `PublicCache` é—¨é¢ (é€šç”¨æ¥å£) | facade.py |
| å®ç° `PublicCache` é—¨é¢ (ä¸“ç”¨æ¥å£) | facade.py |
| å¯¼å‡º `cache` å…¨å±€å•ä¾‹ | `__init__.py` |

#### Phase 3: åŒæ­¥ä¸æ—¥å¿— (0.5å¤©)

| ä»»åŠ¡ | äº§å‡º |
|------|------|
| å®ç° `DatabaseSyncer` (å«GCé˜²æŠ–) | syncer.py |
| å®ç° `AuditLogBuffer` | audit.py |
| é…ç½® Loguru æ—¥å¿— | logger.py |

#### Phase 4: é›†æˆä¸é‡æ„ (1å¤©)

| ä»»åŠ¡ | äº§å‡º |
|------|------|
| ä¿®æ”¹ `main.py` lifespan | å¯åŠ¨æ³¨å†Œ |
| **é‡æ„ç°æœ‰ä»£ç ä½¿ç”¨ `cache` æ¥å£** | routers/*.py |
| æ·»åŠ ä¾èµ– | requirements.txt |

### 9.3 éªŒæ”¶æ ‡å‡†

- [ ] å¿ƒè·³å¤„ç†è€—æ—¶ < 1msï¼ˆçº¯å†…å­˜æ“ä½œï¼‰
- [ ] ç”¨æˆ·ä¿¡æ¯é¦–æ¬¡åŠ è½½ < 50msï¼ˆDBå›æºï¼‰
- [ ] ç”¨æˆ·ä¿¡æ¯ç¼“å­˜å‘½ä¸­ < 1ms
- [ ] APIå“åº”ç¼“å­˜å‘½ä¸­ < 10msï¼ˆç£ç›˜IOï¼‰
- [ ] æ•°æ®åº“å†™å…¥é‡é™ä½ 90%+
- [ ] å†…å­˜å ç”¨ < 250MBï¼Œç£ç›˜ç¼“å­˜ < 700MB
- [ ] è¿è¡Œ24å°æ—¶æ— å†…å­˜æ³„æ¼
- [ ] GCé˜²æŠ–æ­£å¸¸å·¥ä½œï¼ˆå†…å­˜>80%æ—¶æ¿€è¿›GCï¼‰
- [ ] **ä¸šåŠ¡å±‚åªä½¿ç”¨ `cache.xxx()` æ¥å£ï¼Œæ— ç›´æ¥è°ƒç”¨ UnifiedCache** ğŸ†•
- [ ] **ç¼“å­˜å¼‚å¸¸ä¸ä¼šå¯¼è‡´ API å´©æºƒï¼ˆç†”æ–­å™¨ç”Ÿæ•ˆï¼‰** ğŸ†•

### 9.4 æ–°å¢ä¾èµ–

```txt
# requirements.txt æ–°å¢
diskcache>=5.6.0      # FileStore åº•å±‚
loguru>=0.7.0         # ç³»ç»Ÿæ—¥å¿—
psutil>=5.9.0         # GC å†…å­˜ç›‘æ§
```

---

## 10. é™„å½•

### A. æ€§èƒ½å¯¹æ¯”

| æ“ä½œ | ç›´æ¥DB | æœ¬æ–¹æ¡ˆ | æå‡ |
|------|--------|--------|------|
| å¿ƒè·³å†™å…¥ | ~5ms | ~0.01ms | 500x |
| ç”¨æˆ·ä¿¡æ¯è¯»å– | ~10ms | ~0.1ms (å‘½ä¸­) | 100x |
| åœ¨çº¿åˆ—è¡¨æŸ¥è¯¢ | ~50ms | ~1ms | 50x |
| DBå†™å…¥é‡/åˆ†é’Ÿ | 120æ¬¡ | 6æ¬¡ | 95%â†“ |

### B. ä¸ Redis æ–¹æ¡ˆå¯¹æ¯”

| æ–¹é¢ | Redis æ–¹æ¡ˆ | æœ¬æ–¹æ¡ˆ |
|------|------------|--------|
| éƒ¨ç½²å¤æ‚åº¦ | éœ€é¢å¤–ç»„ä»¶ | é›¶ä¾èµ– |
| æ€§èƒ½ | ç½‘ç»œIO ~1ms | å†…å­˜ ~0.01ms |
| å¤šå®ä¾‹æ”¯æŒ | âœ… | âŒ ä»…å•è¿›ç¨‹ |
| æŒä¹…åŒ– | RDB/AOFé…ç½® | è‡ªåŠ¨å›å†™ |
| å†…å­˜æ•ˆç‡ | ä¸€èˆ¬ | æé«˜ (Slots+Numpy) |
| é€‚ç”¨åœºæ™¯ | å¤§è§„æ¨¡åˆ†å¸ƒå¼ | ä¼ä¸šå†…éƒ¨å·¥å…· |

### C. å‚è€ƒæ–‡æ¡£

- [Numpyç¼“å­˜ä¸­é—´ä»¶è®¾è®¡æ–¹æ¡ˆ](Numpyç¼“å­˜ä¸­é—´ä»¶è®¾è®¡æ–¹æ¡ˆ.md) - VectorStoreå†…æ ¸
- [ç³»ç»Ÿç®¡ç†æ¨¡å—è®¾è®¡æ–‡æ¡£](../client/ç³»ç»Ÿç®¡ç†æ¨¡å—è®¾è®¡æ–‡æ¡£.md) - ä¼šè¯ç®¡ç†éœ€æ±‚

---

**æ–‡æ¡£ç»´æŠ¤**ï¼šå¼€å‘ç»„  
**æœ€åæ›´æ–°**ï¼š2025-12-05

---

## 11. å®æ–½è¿›åº¦ (v0.5.0)

### å·²å®Œæˆ

| é˜¶æ®µ | ä»»åŠ¡ | çŠ¶æ€ | äº§å‡º |
|------|------|------|------|
| Phase 1 | CacheEntry (Generic) | âœ… | `entry.py` |
| Phase 1 | CachePolicy æ¥å£ | âœ… | `policy.py` |
| Phase 1 | Write-Behind ç­–ç•¥ | âœ… | `policies/write_behind.py` |
| Phase 1 | Cache-Aside ç­–ç•¥ | âœ… | `policies/cache_aside.py` |
| Phase 1 | Write-Through ç­–ç•¥ | âœ… | `policies/write_through.py` |
| Phase 2 | ObjectStore | âœ… | `store.py` |
| Phase 2 | VectorStore | âœ… | `store.py` |
| Phase 2 | FileStore | âœ… | `store.py` |
| Phase 2 | UnifiedCache | âœ… | `manager.py` |
| Phase 2.5 | KeyBuilder | âœ… | `facade.py` |
| Phase 2.5 | safe_cache_call | âœ… | `facade.py` |
| Phase 2.5 | PublicCache é—¨é¢ | âœ… | `facade.py` |
| Phase 2.5 | cache å…¨å±€å•ä¾‹ | âœ… | `__init__.py` |
| Phase 3 | DatabaseSyncer | âœ… | `syncer.py` |
| Phase 3 | AuditLogBuffer | âœ… | `audit.py` |
| Phase 3 | æ—¥å¿—é…ç½® | âœ… | `logging_config.py` |
| Phase 4 | main.py lifespan | âœ… | å¯åŠ¨æ³¨å†Œ |
| Phase 4 | ä¾èµ–æ›´æ–° | âœ… | `requirements.txt` |
| Phase 4 | auth/dependencies.py | âœ… | ä¼šè¯å¯†é’¥è¿ç§» |
| Phase 4 | routers/cache_mgmt.py | âœ… | ç®¡ç†æ¥å£ |
| Phase 4 | routers/industry.py | âœ… | ä½¿ç”¨ cache.xxx() |
| Phase 4 | routers/strategies.py | âœ… | ä½¿ç”¨ cache.xxx() |
| Phase 4 | routers/admin.py | âœ… | å¯¼å…¥/åˆ é™¤æ•°æ®åæ¸…ç†ç¼“å­˜ |
| Phase 4 | routers/analysis.py | âœ… | çƒ­ç‚¹æ¦œä½¿ç”¨ç»Ÿä¸€ç¼“å­˜ |
| Phase 4 | services/stock_service_db.py | âœ… | ä½¿ç”¨ cache.xxx() |
| Phase 4 | services/rank_jump_service_db.py | âœ… | ä½¿ç”¨ cache.xxx() |
| Phase 4 | services/steady_rise_service_db.py | âœ… | ä½¿ç”¨ cache.xxx() |
| Phase 4 | services/industry_service_db.py | âœ… | ä½¿ç”¨ cache.xxx() |
| Phase 4 | services/industry_detail_service.py | âœ… | ä½¿ç”¨ cache.xxx() |
| Phase 4 | services/analysis_service_db.py | âœ… | ä½¿ç”¨ cache.xxx() |
| Phase 5 | åˆ é™¤æ—§ api_cache.py | âœ… | ç§»é™¤å†—ä½™ä»£ç  |
| Phase 5 | å¯åŠ¨é¢„åŠ è½½3å¤©çƒ­ç‚¹æ¦œ | âœ… | `startup.py` |
| Phase 5 | TTL ç»Ÿä¸€ä¸º 25 å°æ—¶ | âœ… | æ‰€æœ‰æœåŠ¡ |

### æµ‹è¯•çŠ¶æ€

- âœ… 45 ä¸ª API é›†æˆæµ‹è¯•é€šè¿‡
- âœ… æ¨¡å—å¯¼å…¥éªŒè¯é€šè¿‡
- âœ… å¤šæ—¥æœŸæµ‹è¯•é€šè¿‡ (æœ€æ–° + 20251120)
- âœ… ç¼“å­˜åŠ é€Ÿæ•ˆæœéªŒè¯

### ç¼“å­˜æ•ˆæœ (API é›†æˆæµ‹è¯•)

| æ¥å£ | é¦–æ¬¡(å†·) | ç¼“å­˜(çƒ­) | åŠ é€Ÿæ¯” |
|------|----------|----------|--------|
| åŠ æƒè¡Œä¸š | 181ms | 6ms | **30x** |
| å‘¨æœŸåˆ†æ | 542ms | 9ms | **60x** |
| æ’åè·³å˜ | 268ms | 19ms | **14x** |
| ç¨³æ­¥ä¸Šå‡ | 433ms | 34ms | **13x** |
| çƒ­ç‚¹æ¦œ | 1348ms | 160ms | **8x** |
| è¡Œä¸šç»Ÿè®¡ | 16ms | 5ms | **3x** |

### æ•°æ®ä¸€è‡´æ€§ä¿éšœ

å¯¼å…¥/åˆ é™¤æ•°æ®æ—¶è‡ªåŠ¨æ¸…ç†ç¼“å­˜ï¼š

```python
# admin.py ä¸­çš„ç¼“å­˜æ¸…ç†é€»è¾‘
from ..core.caching import cache
from ..services.hot_spots_cache import HotSpotsCache

# å¯¼å…¥æ•°æ®å
preload_cache()           # é‡è½½ Numpy ç¼“å­˜
cache.clear_api_cache()   # æ¸…ç†ç»Ÿä¸€ç¼“å­˜ API å±‚
HotSpotsCache.clear_cache()  # æ¸…ç†çƒ­ç‚¹æ¦œç¼“å­˜

# åˆ é™¤æ•°æ®å (åŒä¸Š)
```
