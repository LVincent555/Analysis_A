# æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–è¯´æ˜

## âš ï¸ ç´§æ€¥ä¼˜åŒ–ï¼šæ•°æ®åº“è¿æ¥æ± å¯¼è‡´å†…å­˜å ç”¨è¿‡é«˜

### é—®é¢˜
å½“å‰é…ç½®ï¼ˆ`database.py`æˆ–`database.py.example`ï¼‰ï¼š
```python
engine = create_engine(
    DATABASE_URL,
    pool_size=10,        # âŒ å¤ªå¤§
    max_overflow=20,     # âŒ å¤ªå¤§
    pool_pre_ping=True,
    echo=False
)
```

**å†…å­˜å ç”¨**ï¼š
- æ¯ä¸ªPostgreSQLè¿æ¥ï¼š10-20MB
- æœ€å¤§è¿æ¥æ•°ï¼š10 + 20 = 30ä¸ª
- **æ€»å ç”¨**ï¼š30 Ã— 15MB = **450MB**ï¼ˆ22.5%çš„2GBå†…å­˜ï¼ï¼‰

---

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### ä¿®æ”¹ `database.py`

```python
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
import os

# æ•°æ®åº“è¿æ¥URL
DATABASE_URL = os.getenv(
    "DATABASE_URL",
    "postgresql://postgres:password@localhost/stock_db"
)

# åˆ›å»ºæ•°æ®åº“å¼•æ“
engine = create_engine(
    DATABASE_URL,
    pool_size=2,         # âœ… 10 â†’ 2ï¼ˆ2æ ¸CPUå¤Ÿç”¨ï¼‰
    max_overflow=2,      # âœ… 20 â†’ 2ï¼ˆå‡å°‘æº¢å‡ºï¼‰
    pool_pre_ping=True,  # ä¿æŒï¼šæ£€æŸ¥è¿æ¥æœ‰æ•ˆæ€§
    pool_recycle=3600,   # âœ… æ–°å¢ï¼š1å°æ—¶å›æ”¶è¿æ¥
    pool_timeout=30,     # âœ… æ–°å¢ï¼š30ç§’è¶…æ—¶
    echo=False           # ä¿æŒï¼šä¸æ‰“å°SQL
)

# åˆ›å»ºSessionLocalç±»
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# åˆ›å»ºBaseç±»
Base = declarative_base()

def get_db():
    """æ•°æ®åº“ä¼šè¯ä¾èµ–"""
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœ

| é…ç½®é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | è¯´æ˜ |
|-------|-------|--------|------|
| **pool_size** | 10 | 2 | 2æ ¸CPUï¼Œ2ä¸ªè¿æ¥è¶³å¤Ÿ |
| **max_overflow** | 20 | 2 | å‡å°‘æº¢å‡ºè¿æ¥ |
| **æœ€å¤§è¿æ¥æ•°** | 30 | 4 | æ€»æ•°å‡å°‘86% |
| **å†…å­˜å ç”¨** | 450MB | 60MB | èŠ‚çœ390MB (87%) |
| **pool_recycle** | æ—  | 3600s | é˜²æ­¢é•¿è¿æ¥å ç”¨ |
| **pool_timeout** | æ—  | 30s | é¿å…æ— é™ç­‰å¾… |

---

## ğŸ¯ ä¸ºä»€ä¹ˆ2ä¸ªè¿æ¥å¤Ÿç”¨ï¼Ÿ

### 1. å†…å­˜ç¼“å­˜æ¶æ„
- å¯åŠ¨æ—¶ä¸€æ¬¡æ€§åŠ è½½æ•°æ®åˆ°å†…å­˜
- è¿è¡Œæ—¶å¤§éƒ¨åˆ†æŸ¥è¯¢**ä¸è®¿é—®æ•°æ®åº“**
- æ•°æ®åº“ä»…ç”¨äºå¯åŠ¨åŠ è½½å’Œå¶å°”çš„æ›´æ–°

### 2. å¹¶å‘éœ€æ±‚åˆ†æ
- 2æ ¸CPU â†’ 2ä¸ªè¿æ¥å¯¹åº”2ä¸ªæ ¸å¿ƒ
- FastAPIä½¿ç”¨å¼‚æ­¥IOï¼Œä¸é˜»å¡çº¿ç¨‹
- å†…å­˜ç¼“å­˜å“åº”æ—¶é—´<1msï¼Œæ— éœ€ç­‰å¾…

### 3. å®é™…ä½¿ç”¨åœºæ™¯
```python
# å¯åŠ¨æ—¶ï¼š1ä¸ªè¿æ¥åŠ è½½æ•°æ®
memory_cache.load_all_data()  # ä½¿ç”¨1ä¸ªè¿æ¥

# è¿è¡Œæ—¶ï¼š99%è¯·æ±‚ä¸è®¿é—®æ•°æ®åº“
@app.get("/api/industry/trend")
async def get_industry_trend(...):
    data = memory_cache.get_top_n_stocks(...)  # âœ… å†…å­˜æŸ¥è¯¢
    return data

# å¶å°”æ›´æ–°ï¼š1ä¸ªè¿æ¥
@app.post("/api/update")
async def update_data():
    db.query(...).update()  # ä½¿ç”¨1ä¸ªè¿æ¥
```

---

## âš™ï¸ å‚æ•°è¯´æ˜

### pool_sizeï¼ˆè¿æ¥æ± å¤§å°ï¼‰
- **å®šä¹‰**ï¼šä¿æŒçš„å¸¸é©»è¿æ¥æ•°
- **ä¼˜åŒ–å‰**ï¼š10ä¸ª
- **ä¼˜åŒ–å**ï¼š2ä¸ª
- **ç†ç”±**ï¼š2æ ¸CPUï¼Œ2ä¸ªè¿æ¥å¯¹åº”2ä¸ªæ ¸å¿ƒ

### max_overflowï¼ˆæœ€å¤§æº¢å‡ºè¿æ¥ï¼‰
- **å®šä¹‰**ï¼šè¿æ¥æ± æ»¡æ—¶å¯åˆ›å»ºçš„é¢å¤–è¿æ¥æ•°
- **ä¼˜åŒ–å‰**ï¼š20ä¸ª
- **ä¼˜åŒ–å**ï¼š2ä¸ª
- **ç†ç”±**ï¼šä¸´æ—¶é«˜å³°ä¹Ÿä¸éœ€è¦å¤ªå¤šè¿æ¥

### pool_recycleï¼ˆè¿æ¥å›æ”¶æ—¶é—´ï¼‰
- **å®šä¹‰**ï¼šè¿æ¥ä½¿ç”¨è¶…è¿‡è¿™ä¸ªæ—¶é—´åè‡ªåŠ¨å…³é—­é‡å»º
- **ä¼˜åŒ–å‰**ï¼šæ— ï¼ˆå¯èƒ½æ°¸ä¹…æŒæœ‰ï¼‰
- **ä¼˜åŒ–å**ï¼š3600ç§’ï¼ˆ1å°æ—¶ï¼‰
- **ç†ç”±**ï¼šé˜²æ­¢é•¿è¿æ¥å ç”¨å†…å­˜ä¸é‡Šæ”¾

### pool_timeoutï¼ˆè¿æ¥è¶…æ—¶æ—¶é—´ï¼‰
- **å®šä¹‰**ï¼šç­‰å¾…å¯ç”¨è¿æ¥çš„æœ€é•¿æ—¶é—´
- **ä¼˜åŒ–å‰**ï¼šæ— ï¼ˆå¯èƒ½æ°¸ä¹…ç­‰å¾…ï¼‰
- **ä¼˜åŒ–å**ï¼š30ç§’
- **ç†ç”±**ï¼šé¿å…æ­»é”å¯¼è‡´æ— é™ç­‰å¾…

---

## ğŸš¨ å¸¸è§é—®é¢˜

### Q1: 2ä¸ªè¿æ¥ä¼šä¸ä¼šå¤ªå°‘ï¼Ÿ
**A**: ä¸ä¼šã€‚
- 2æ ¸CPUï¼Œ2ä¸ªè¿æ¥å·²ç»å¯¹åº”2ä¸ªæ ¸å¿ƒ
- 99%çš„æŸ¥è¯¢èµ°å†…å­˜ç¼“å­˜ï¼Œä¸è®¿é—®æ•°æ®åº“
- å³ä½¿é«˜å¹¶å‘ï¼Œä¹Ÿæ˜¯CPUç“¶é¢ˆï¼Œä¸æ˜¯è¿æ¥æ•°ç“¶é¢ˆ

### Q2: å¦‚æœå¹¶å‘å¾ˆé«˜æ€ä¹ˆåŠï¼Ÿ
**A**: ä¸¤ä¸ªæ–¹å‘ï¼š
1. **å†…å­˜ç¼“å­˜å‘½ä¸­ç‡**ï¼šä¼˜åŒ–å>95%ï¼Œå¤§éƒ¨åˆ†è¯·æ±‚ä¸è®¿é—®æ•°æ®åº“
2. **å¼‚æ­¥IO**ï¼šFastAPIçš„å¼‚æ­¥æœºåˆ¶å¯ä»¥ç”¨å°‘é‡è¿æ¥å¤„ç†é«˜å¹¶å‘

### Q3: ä»€ä¹ˆæƒ…å†µéœ€è¦æ›´å¤šè¿æ¥ï¼Ÿ
**A**: ä»¥ä¸‹æƒ…å†µæ‰éœ€è¦ï¼š
- CPUæ ¸å¿ƒæ•°>2ï¼ˆä¾‹å¦‚4æ ¸ â†’ pool_size=4ï¼‰
- é¢‘ç¹çš„æ•°æ®åº“å†™å…¥æ“ä½œ
- å¤æ‚çš„äº‹åŠ¡å¤„ç†

### Q4: ä¼šä¸ä¼šå½±å“æ€§èƒ½ï¼Ÿ
**A**: ä¸ä¼šã€‚
- æ•°æ®åº“æŸ¥è¯¢ä¸æ˜¯ç“¶é¢ˆï¼ˆå·²æœ‰å†…å­˜ç¼“å­˜ï¼‰
- å³ä½¿å¶å°”ç­‰å¾…è¿æ¥ï¼Œä¹Ÿåªæœ‰30mså»¶è¿Ÿ
- å†…å­˜èŠ‚çœ390MBå¸¦æ¥çš„æ”¶ç›Šè¿œå¤§äºå¾®å°å»¶è¿Ÿ

---

## ğŸ“ˆ ç›‘æ§å»ºè®®

### ç›‘æ§è¿æ¥æ± ä½¿ç”¨æƒ…å†µ
```python
# åœ¨main.pyæ·»åŠ ç›‘æ§ç«¯ç‚¹
@app.get("/api/db-pool-stats")
async def get_db_pool_stats():
    return {
        "pool_size": engine.pool.size(),
        "checked_out": engine.pool.checkedout(),
        "overflow": engine.pool.overflow(),
        "checked_in": engine.pool.checkedin()
    }
```

### é¢„æœŸç»“æœ
- **checked_out**ï¼šé€šå¸¸0-1ï¼ˆå¾ˆå°‘ä½¿ç”¨ï¼‰
- **overflow**ï¼š0ï¼ˆå¾ˆå°‘æº¢å‡ºï¼‰
- **è¯´æ˜**ï¼š2ä¸ªè¿æ¥å®Œå…¨å¤Ÿç”¨

---

## ğŸ¯ ç«‹å³è¡ŒåŠ¨

### æ­¥éª¤1ï¼šå¤‡ä»½åŸæ–‡ä»¶
```bash
cp backend/app/database.py backend/app/database.py.backup
```

### æ­¥éª¤2ï¼šä¿®æ”¹é…ç½®
æ‰“å¼€ `backend/app/database.py`ï¼Œä¿®æ”¹è¿™5è¡Œï¼š
```python
pool_size=2,         # æ”¹è¿™é‡Œ
max_overflow=2,      # æ”¹è¿™é‡Œ
pool_recycle=3600,   # æ–°å¢è¿™è¡Œ
pool_timeout=30,     # æ–°å¢è¿™è¡Œ
```

### æ­¥éª¤3ï¼šé‡å¯æœåŠ¡
```bash
cd backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### æ­¥éª¤4ï¼šéªŒè¯å†…å­˜å ç”¨
```bash
# æŸ¥çœ‹Pythonè¿›ç¨‹å†…å­˜
ps aux | grep uvicorn

# é¢„æœŸï¼šRSSåº”è¯¥ä»1.5GBé™åˆ°850MBå·¦å³
```

---

## âœ… ä¼˜åŒ–å®Œæˆæ£€æŸ¥

- [ ] ä¿®æ”¹äº† `database.py`
- [ ] pool_size æ”¹ä¸º 2
- [ ] max_overflow æ”¹ä¸º 2
- [ ] æ·»åŠ äº† pool_recycle=3600
- [ ] æ·»åŠ äº† pool_timeout=30
- [ ] é‡å¯äº†æœåŠ¡
- [ ] å†…å­˜å ç”¨é™ä½åˆ°900MBä»¥ä¸‹
- [ ] æœåŠ¡æ­£å¸¸è¿è¡Œï¼Œæ— æŠ¥é”™

---

**ä¼˜åŒ–æ—¥æœŸ**ï¼š2025-11-25
**é¢„æœŸæ•ˆæœ**ï¼šèŠ‚çœ390MBå†…å­˜ï¼ŒæœåŠ¡å™¨ç¨³å®šæ€§å¤§å¹…æå‡
