# 单针下二十策略 - 设计文档

## 📋 策略概述

**策略名称**：单针下二十策略（原神启动信号）

**核心逻辑**：捕捉主力洗盘后的拉升机会，通过多周期位置指标识别"指标快速下杀但股价坚挺+缩量"的信号。

**预期收益**：单次7-15%，成功率60-70%

---

## 🖥️ 前端页面设计

### 导航结构

```
功能导航
├── 最新热点
├── 查询系统
├── 行业趋势分析
├── 排名跳变
├── 稳步上升
└── 各种策略（新增主模块）⭐
    └── 单针下二十（子模块）⭐
```

### 页面功能

**单针下二十页面**：与现有「最新热点」页面类似
- 日期范围选择
- 股票列表展示（按评分排序）
- 搜索过滤
- 行业分布统计图表

### 信号系统集成

```
单针下二十子模块
    ↓ (计算九维评分)
子模块信号排名
    ↓ (输出信号)
主模块信号系统（板块排序主体）
    ↓
股票搜索可见标签「单针下二十」
```

**关键点**：
1. 子模块内部有独立的信号排名（九维评分）
2. 信号最终并入主体信号系统
3. 股票搜索时可通过标签「单针下二十」筛选
4. 与现有热点榜、排名跳变等信号平级

---

## 🏛️ 后端模块架构设计

### 目录结构（建议）

```
backend/app/services/
├── strategies/                    # 各种策略大模块
│   ├── __init__.py
│   ├── common/                    # 公共组件（可复用）⭐
│   │   ├── __init__.py
│   │   ├── indicator_calculator.py   # 计算RSI, MACD, ADX, 乖离率等
│   │   ├── volatility_engine.py      # 计算历史波动率、压缩比
│   │   ├── rank_analyzer.py          # 计算排名变化
│   │   └── position_calculator.py    # 计算位置指标（原神启动）
│   │
│   └── needle_under_20/           # 单针下二十子模块
│       ├── __init__.py
│       ├── pattern_recognizer.py  # 形态识别器
│       ├── signal_scorer.py       # 九维评分引擎
│       ├── context_validator.py   # 语境验证器
│       └── config.py              # 参数配置
│
├── signal_calculator.py           # 主信号系统（已有）
└── ...
```

### 模块解耦设计

```
┌─────────────────────────────────────────────────────────┐
│  Common_Utils (公共组件 - 可复用)                        │
│  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐  │
│  │ Indicator     │ │ Volatility    │ │ Position      │  │
│  │ Calculator    │ │ Engine        │ │ Calculator    │  │
│  │ (RSI/MACD/ADX)│ │ (波动率压缩比) │ │ (原神启动)    │  │
│  └───────────────┘ └───────────────┘ └───────────────┘  │
└─────────────────────────────────────────────────────────┘
                          ↓ 调用
┌─────────────────────────────────────────────────────────┐
│  Needle_Under_20_Submodule (单针下二十)                  │
│  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐  │
│  │ Pattern       │→│ Signal        │→│ Context       │  │
│  │ Recognizer    │ │ Scorer        │ │ Validator     │  │
│  │ (形态识别)    │ │ (九维评分)    │ │ (语境验证)    │  │
│  └───────────────┘ └───────────────┘ └───────────────┘  │
└─────────────────────────────────────────────────────────┘
                          ↓ 输出信号
┌─────────────────────────────────────────────────────────┐
│  主信号系统 (signal_calculator.py)                       │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────┐   │
│  │ 热点榜  │ │ 排名跳变│ │ 稳步上升│ │ 单针下二十 ⭐│   │
│  └─────────┘ └─────────┘ └─────────┘ └─────────────┘   │
│                          ↓                              │
│              signals.append("单针下二十")               │
│                          ↓                              │
│              股票搜索可见标签「单针下二十」              │
└─────────────────────────────────────────────────────────┘
```

### 核心组件说明

| 组件 | 功能 | 可复用性 | 说明 |
|------|------|----------|------|
| **Indicator_Calculator** | 技术指标计算 | ✅ 高 | RSI/MACD/ADX/KDJ等，其他策略可复用 |
| **Volatility_Engine** | 波动率分析 | ✅ 高 | 波动率压缩比，其他策略可复用 |
| **Position_Calculator** | 位置指标计算 | ✅ 高 | 原神启动指标，其他策略可复用 |
| **Pattern_Recognizer** | 形态识别器 | ⚠️ 中 | 单针下二十专用，但可扩展 |
| **Signal_Scorer** | 九维评分引擎 | ⚠️ 中 | 评分框架可复用，维度可调整 |
| **Context_Validator** | 语境验证器 | ✅ 高 | 前后关联判据，其他策略可复用 |

### 信号输出到主系统

```python
# signal_calculator.py 中新增

def calculate_needle_under_20_signal(self, stock_code: str, date: date) -> dict:
    """计算单针下二十信号"""
    from .strategies.needle_under_20 import NeedleUnder20Strategy
    
    strategy = NeedleUnder20Strategy()
    result = strategy.analyze(stock_code, date)
    
    if result and result['total_score'] >= 60:
        return {
            'signal_type': '单针下二十',
            'score': result['total_score'],
            'pattern': result['pattern'],  # 空中加油/双底共振
            'labels': result['labels'],
        }
    return None
```

---

## 🎯 策略原理

### 指标定义

基于原神启动指标的多周期位置计算：

```
位置指标(N) = 100 × (收盘价 - N天最低价) / (N天最高价 - N天最低价)
```

**四条线**：
- **短期（白线）**：N1 = 5天
- **中期（黄线）**：固定10天
- **中长期（紫线）**：固定20天
- **长期（红线）**：N2 = 21天（可配置30或60）

### 衍生高阶指标（新增）

| 指标 | 计算公式 | 作用 |
|------|----------|------|
| **排名变化** | 当日排名 - 昨日排名 | 负数表示排名上升/进步 |
| **布林乖离率** | (收盘价 - 布林中轨) / 布林中轨 × 100% | 判断超买超卖程度 |
| **波动率压缩比** | 当日波动率 / 过去20日平均波动率 | 识别洗盘窒息点 |
| **下影线比例** | (min(开,收) - 最低) / (最高 - 最低) | 识别下探支撑 |
| **BETA系数** | 个股相对大盘的贝塔值 | 判断独立行情 |
| **相关性** | 个股与大盘的相关系数 | 筛选逆势妖股 |

### 沉睡数据价值挖掘

#### ADX（平均趋向指标）
- **作用**：判断"是调整还是反转"
- **特征**：当白线<20时，若ADX>25且维持上升，说明是强势趋势中的暂时回调（牛回头）
- **数据验证**：
  - 久其软件 11/14 下杀时 ADX=33.32，数值较高，趋势还在，随后反转
  - 特发信息 11/19 下杀时 ADX=20.62，趋势较弱，洗盘时间更长

#### OBV（能量潮）
- **作用**：主力资金监控
- **特征**：股价创短期新低（白线<20），但OBV没有创前低（底背离），说明主力没有出货

#### 布林带下轨
- **作用**：物理支撑验证
- **特征**：单针刺破下轨后收回，或精准点到下轨，具有"超跌反弹"的物理意义
- **数据验证**：特发信息 11/19 最低价9.17，布林下轨9.02，悬停在下轨之上，支撑有效

### 核心信号

**"白线下20买"**：短期≤20 且 长期≥60
- 含义：短期极度超卖，长期还在高位
- 本质：主力洗盘，股价坚挺

## 📊 四种典型形态

### 可变时间窗口设计

不同股票的下杀节奏不同，需要支持可变时间窗口：

| 类型 | 时间 | 判定逻辑 |
|------|------|----------|
| **单日针** | 1天 | 当日短期<20 且 前一日>40（急跌） |
| **多日针** | 2-3天 | 连续2-3天累计跌幅达标，且最后一日短期<20 |

**参数**：`Drop_Duration` = 1~3天

---

### 形态A：空中加油型（Sky Refueling）

**又名**：红高白低型、强势整理

**核心特征**：
- 长期位置（红线） > 60%（趋势向上）
- 短期位置（白线）快速下杀至 < 20%
- 1-2天完成下杀
- 成交量极度萎缩（换手率 < 5%）
- **波动率压缩**：信号日波动率 ≤ 20日均波动率

**本质**：上升趋势中的强力洗盘，胜率极高

**示例**：特发信息 11/19-11/21
```
11/19: 长期68%, 短期4.3%, 换手2.04%, 波动率0.447 → 信号日
11/20: 长期47%, 短期47%, 换手3.54%, 波动率0.285 → 确认（波动率收敛）
11/21: 涨停+10.00%, 换手8.57% → 启动
```

**判定条件**：
```python
红线 > 60 且 白线 < 20
波动率压缩比 <= 1.0（信号日波动率/20日均波动率）
```

**参数**：
- `long_position_min`: 60
- `short_position_max`: 20
- `max_drop_days`: 2
- `turnover_max`: 5.0
- `vol_compression_ratio`: 1.0

---

### 形态B：双底共振型（Double Resonance）

**又名**：红白双杀型、双底反转

**核心特征**：
- 长期和短期同时在低位（< 30）
- 红白线差值 < 15（双杀共振）
- 同步下杀后共振上涨
- 1-3天下杀期
- 爆发力强，但风险略高

**本质**：超跌反弹，红白线双杀后的V型反转

**示例**：航天动力 11/19-11/20
```
11/19: 长期33%, 短期22%, 换手2.46%, 差值11% → 双底信号
11/20: 涨停+10.01%, 换手6.79% → 启动
```

**判定条件**：
```python
红线 < 30 且 白线 < 20 且 abs(红线 - 白线) < 15
```

**参数**：
- `long_position_max`: 30
- `short_position_max`: 25
- `resonance_diff`: 15（两线最大差值）

### 形态C：白穿红线型（低位金叉）

**特征**：
- 短期从下方上穿长期
- 交叉点位置 < 30（低位）
- MACD同步金叉

**参数**：
- `cross_position_max`: 30
- `cross_momentum`: 10（穿越后加速度）

### 形态D：缓慢下杀型（蓄力突破）

**特征**：
- 2-3天缓慢下探
- 每天小幅阴跌（-1% ~ -2%）
- 量能逐步萎缩
- 波动率收敛

**示例**：国机精工 11/13-11/19
```
11/13: -1.14%, 换手3.40%, 短期15%
11/14: +1.75%, 换手3.61%, 短期29%
11/19: +3.92%, 换手6.66%, 短期86%
11/24: 涨停+10.01%
```

**参数**：
- `slow_drop_days`: [2, 3]
- `daily_drop_range`: [-3, 1]
- `volume_shrink_rate`: 0.9

## 🔍 核心判据

### 1. 位置指标判据

| 条件 | 阈值 | 权重 |
|------|------|------|
| 短期位置 < 阈值 | 20 | 30% |
| 长期位置状态 | 形态相关 | 20% |
| 下杀持续天数 | 1-3天 | 10% |

### 2. 波动率判据

**历史波动率分析**：
- 计算20日平均波动率
- 信号日波动率应在均值的80-95%
- 启动日波动率突破均值105%以上

**波动率模式**：
```
下杀期: 0.35-0.45（略微收敛）
洗盘完成: < 0.30（极度收敛）或稳定
启动前夜: > 0.45（开始放大）
```

**权重**：15%

### 3. 成交量判据

**量能序列**：
- 信号日：换手率 < 5%（极度缩量）
- 洗盘期：成交量持续萎缩
- 启动日：成交量放大至洗盘期的1.5-3倍

**量价配合**：
- 价跌量缩：✅ 主力控盘
- 价跌量增：❌ 恐慌抛售
- 价平量缩：✅✅ 洗盘完成
- 价涨量增：✅ 确认信号

**权重**：25%

### 4. 技术指标判据

**MACD底背离**：
- 股价创新低但MACD不创新低
- 或MACD在零轴下方即将金叉

**RSI超卖**：
- 信号日RSI < 40
- 启动日RSI > 50
- 涨停日RSI > 70

**BETA系数**：
- BETA < -2：极度负相关，逆势走强
- 说明走独立行情，不受大盘影响

**权重**：15%

### 5. 价格行为判据

**信号日价格特征**：
- 跌幅控制：-3% ~ +1%
- 实体小：(收-开)/开 < 2%
- 下影线：可能有长下影

**启动日确认**：
- 涨幅 > 3%
- 突破前期高点
- 理想情况：涨停

**权重**：15%

## ⚙️ 参数配置体系

### 完整参数配置表

```python
NEEDLE_UNDER_20_CONFIG = {
    # ========== 核心指标参数 ==========
    "N1_SHORT": 5,              # 短期周期（可调：3, 5, 7）
    "N2_LONG": 30,              # 长期周期（可调：21, 30, 60）
    "NEEDLE_THRESHOLD": 20,     # 单针触发阈值（白线）
    
    # ========== 形态判定参数 ==========
    "SKY_REFUEL_LONG_MIN": 60,  # 空中加油：红线最小值
    "DOUBLE_BOTTOM_LONG_MAX": 30,  # 双底共振：红线最大值
    "DOUBLE_BOTTOM_DIFF": 15,   # 双底共振：红白线最大差值
    
    # ========== 时间窗口参数 ==========
    "DROP_WINDOW_DAYS": 3,      # 允许下杀持续的最长天数
    "LOOKBACK_DAYS": 10,        # 回溯多少天判断红线趋势
    "CONFIRM_NEXT_DAY": True,   # 是否需要次日确认
    
    # ========== 评分阈值参数 ==========
    "RANK_DELTA_THRESHOLD": -500,   # 排名进步名次阈值（负数表示进步）
    "BOLL_BIAS_MIN": -8.0,      # 乖离率下限 (%)
    "BOLL_BIAS_MAX": -3.0,      # 乖离率上限 (%)
    "TURNOVER_LIMIT": 5.0,      # 缩量换手率上限 (%)
    "KDJ_LIMIT": 20.0,          # KDJ共振阈值
    "CORRELATION_LIMIT": 0.3,   # 独立行情相关性上限
    "ADX_TREND_MIN": 25,        # ADX趋势有效最小值
    
    # ========== 波动率参数 ==========
    "VOL_WINDOW": 20,           # 波动率均值窗口
    "VOL_COMPRESSION_RATIO": 1.0,  # 波动率压缩比上限
    
    # ========== 量能参数 ==========
    "VOLUME_AMPLIFY_RATIO": 1.5,   # 启动日放量倍数
    
    # ========== 幅度限制 ==========
    "MAX_DROP_PCT": -5.0,       # 下杀期间最大允许跌幅（跌太多就是真跌）
    
    # ========== 技术指标参数 ==========
    "MACD_THRESHOLD": -0.05,    # MACD底部阈值
    "RSI_OVERSOLD": 35,         # RSI超卖线
    "RSI_START": 50,            # RSI启动线
    "BETA_STRONG": -2.0,        # 强负相关阈值
}
```

### 参数说明表

| 参数类别 | 参数名 | 默认值 | 说明 |
|----------|--------|--------|------|
| 基础阈值 | NEEDLE_THRESHOLD | 20 | 单针探底触发值（可调至15或25） |
| 红线形态 | SKY_REFUEL_LONG_MIN | 60 | 定义形态A的红线高度 |
| 红线形态 | DOUBLE_BOTTOM_LONG_MAX | 30 | 定义形态B的红线高度 |
| 时间窗口 | DROP_WINDOW_DAYS | 3 | 允许下杀持续的最长天数 |
| 波动率 | VOL_COMPRESSION_RATIO | 1.0 | 信号日波动率/20日均波动率 |
| 幅度限制 | MAX_DROP_PCT | -5.0% | 下杀期间最大允许跌幅 |
| 历史关联 | LOOKBACK_DAYS | 10 | 回溯多少天判断红线趋势 |
| 确认信号 | CONFIRM_NEXT_DAY | True | 是否需要次日阳线确认 |

### 核心参数（简化版）
```python
{
    # 周期参数
    "short_period": 5,      # 短期周期（可调：3, 5, 7）
    "long_period": 21,      # 长期周期（可调：21, 30, 60）
    
    # 阈值参数
    "short_threshold": 20,  # 短期触发阈值
    "long_high": 60,        # 长期高位阈值
    "long_low": 30,         # 长期低位阈值
    
    # 时间参数
    "max_drop_days": 3,     # 最大下杀天数
    "lookback_days": 7,     # 历史回溯天数
    
    # 量能参数
    "turnover_threshold": 5.0,      # 换手率阈值
    "volume_amplify_ratio": 1.5,    # 启动日放量倍数
    
    # 波动率参数
    "volatility_avg_period": 20,    # 波动率均值周期
    "volatility_signal_ratio": [0.8, 0.95],  # 信号日比率
    "volatility_start_ratio": 1.05,  # 启动日比率
    
    # 技术指标参数
    "macd_threshold": -0.05,  # MACD底部阈值
    "rsi_oversold": 35,       # RSI超卖线
    "rsi_start": 50,          # RSI启动线
    "beta_strong": -2.0,      # 强负相关阈值
}
```

### 形态参数
```python
{
    # 形态A
    "mode_a": {
        "long_min": 60,
        "short_max": 20,
        "max_days": 2,
    },
    
    # 形态B
    "mode_b": {
        "long_range": [20, 40],
        "short_max": 25,
        "resonance_diff": 15,
    },
    
    # 形态C
    "mode_c": {
        "cross_position": 30,
        "cross_momentum": 10,
    },
    
    # 形态D
    "mode_d": {
        "slow_days": [2, 3],
        "daily_drop": [-3, 1],
    }
}
```

## 📈 九维信号评分系统（核心）

### 评分概览

满分 **100分** + 额外加分项，按总分降序排列信号。

| 维度 | 信号名称 | 判据逻辑 | 分数 | 设计意图 |
|------|----------|----------|------|----------|
| 1 | 排名逆势跃升 | 股价跌但排名进步>500名 | +15 | 市场对抗力 |
| 2 | 布林中轨支撑 | 乖离率在-8%~-3%之间 | +12 | 价格安全边际 |
| 3 | 极度缩量 | 换手率<5%且低于5日均量 | +10 | 主力未出货 |
| 4 | KDJ共振超卖 | K值<20（与白线共振） | +10 | 多指标确认 |
| 5 | 独立妖股 | 与大盘相关性<0.3 | +8 | 筛选逆势股 |
| 6 | ADX趋势有效 | ADX>25且方向向上 | +8 | 调整非反转 |
| 7 | OBV底背离 | 价格新低但OBV不新低 | +8 | 主力护盘 |
| 8 | 下影线支撑 | 下影线占比>50% | +6 | 探底回升 |
| 9 | MACD金叉预备 | DIF>DEA且接近零轴 | +5 | 动能转正 |

### 形态加分

| 条件 | 分数 | 说明 |
|------|------|------|
| 空中加油（形态A） | +10 | 红线>60，白线<20 |
| 双底共振（形态B） | +8 | 红白线同时低位 |
| 单日急跌 | +5 | 一天完成下杀 |
| 次日高开确认 | +5 | 次日开盘价>昨日收盘 |

### 信号强度分级

```python
# 评分公式
总分 = 基础分(各维度累加) + 形态加分

# 信号分级
总分 >= 80: ⭐⭐⭐ 强烈信号（优先关注，形态完美）
总分 60-79: ⭐⭐ 关注信号（次要关注，条件基本满足）
总分 40-59: ⭐ 观望信号（可选关注，部分条件满足）
总分 < 40: 忽略（条件不足）
```

### 评分细节输出

为每只股票生成评分详情，便于前端展示：
```python
{
    "stock_code": "000070",
    "stock_name": "特发信息",
    "total_score": 85,
    "pattern": "空中加油",
    "score_details": {
        "排名逆势跃升": 15,
        "布林中轨支撑": 12,
        "极度缩量": 10,
        "形态加分": 10,
        ...
    },
    "labels": ["空中加油", "排名逆袭", "极度缩量"],
    "signal_date": "2025-11-19"
}
```

---

## 📊 历史语境评估（Context Evaluation）

### 前向判据（Looking Back）

在触发基础信号后，回溯检查历史数据：

| 判据 | 条件 | 处理 |
|------|------|------|
| 无连续暴跌 | 信号日前5天内无>5%的实体大阴线 | 是则通过，否则剔除 |
| 支撑位确认 | 下杀最低价触及关键支撑（如BOLL中轨） | 是则加分 |
| 趋势未破坏 | 红线趋势斜率>0 | 是则加分 |

**验证案例**：国机精工 11/13 收盘26.84，接近布林中轨28.38下方支撑区域，未触及下轨26.48，支撑有效。

### 后向判据（Looking Forward）

用于次日确认，避免假信号：

| 判据 | 条件 | 处理 |
|------|------|------|
| 次日高开 | 次日开盘价 > 昨日收盘价 | 加5分 |
| 次日收阳 | 次日收盘价 > 昨日收盘价 | 加5分 |
| 放量突破 | 次日成交量 > 昨日1.5倍 | 加5分 |

**验证案例**：久其软件 11/14下杀，11/17收盘7.73大涨5.7%，确认有效。

---

## 📈 简化评分模型（兼容旧版）

```python
综合得分 = (
    位置指标得分 × 0.30 +
    量能得分 × 0.25 +
    波动率得分 × 0.15 +
    技术指标得分 × 0.15 +
    价格行为得分 × 0.15
)

# 信号强度分级
得分 >= 80: 强烈信号（优先关注）
得分 60-79: 关注信号（次要关注）
得分 < 60: 忽略
```

## 🚀 执行流程

### 1. 每日扫描（盘后）
```
加载最新数据 → 计算多周期位置指标 → 初步筛选
```

### 2. 信号识别
```
判断下杀期（1-3天） → 检查波动率和成交量 → 形态匹配（A/B/C/D）
```

### 3. 综合评分
```
计算各维度得分 → 加权汇总 → 输出信号强度
```

### 4. 次日验证
```
观察开盘表现 → 确认突破有效性 → 决定是否买入
```

### 5. 持仓管理
```
设置止损（-3%） → 设置止盈（涨停或+15%） → 跟踪位置指标
```

## 📊 历史验证案例

### 案例1：国机精工（002046）
- **信号日**：2025-11-13
- **形态**：形态D（缓慢下杀）
- **得分**：82分
- **结果**：11/24涨停（+10.01%），6个交易日累计涨幅约15%

### 案例2：久其软件（002279）
- **信号日**：2025-11-14
- **形态**：形态A（红高白低）
- **得分**：78分
- **结果**：11/17启动（+5.75%），11/21涨停（+9.96%）

### 案例3：特发信息（000070）
- **信号日**：2025-11-19
- **形态**：形态A（红高白低）
- **得分**：85分
- **结果**：11/21涨停（+10.00%），11/24再涨停（+10.05%）

### 案例4：航天动力（600343）
- **信号日**：2025-11-19
- **形态**：形态B（红白双杀）
- **得分**：76分
- **结果**：11/20涨停（+10.01%），11/24再涨停（+10.00%）

**成功率**：4/4 = 100%（样本量小，需更多验证）

## ⚠️ 风险控制

### 止损策略
1. **次日止损**：次日跌破-3%
2. **位置止损**：短期位置跌破30
3. **时间止损**：3天无启动迹象

### 止盈策略
1. **目标止盈**：累计盈利15%
2. **涨停止盈**：涨停次日冲高卖出
3. **位置止盈**：短期位置达到100

### 仓位管理
- 单只股票：不超过总仓位的20%
- 同时持仓：不超过3只
- 分批建仓：信号日买30%，确认日加仓70%

## � API接口设计

### 后端路由

```python
# backend/app/routers/strategies.py (新建)

@router.get("/strategies/needle-under-20")
async def get_needle_under_20_stocks(
    date: str = None,           # 日期，默认最新
    days: int = 2,              # 分析天数范围
    min_score: int = 60,        # 最低评分阈值
    pattern: str = None,        # 形态筛选：sky_refuel/double_bottom
):
    """
    获取单针下二十信号股票列表
    返回：按评分降序排列的股票列表
    """
    pass

@router.get("/strategies/needle-under-20/{stock_code}")
async def get_stock_needle_detail(stock_code: str, date: str = None):
    """
    获取单只股票的单针下二十详情
    返回：评分详情、形态、标签等
    """
    pass
```

### 返回数据结构

```json
{
    "data": [
        {
            "rank": 1,
            "stock_code": "000070",
            "stock_name": "特发信息",
            "industry": "通信设备",
            "total_score": 85,
            "pattern": "空中加油",
            "pattern_en": "sky_refuel",
            "labels": ["空中加油", "排名逆袭", "极度缩量"],
            "signal_date": "2025-11-19",
            "latest_rank": 53,
            "price_change": "+0.60%",
            "score_details": {
                "排名逆势跃升": 15,
                "布林中轨支撑": 12,
                "极度缩量": 10,
                "形态加分": 10
            }
        }
    ],
    "total_count": 5,
    "date_range": ["2025-11-24", "2025-11-21"],
    "industry_distribution": {
        "通信设备": 1,
        "软件服务": 2
    }
}
```

### 前端路由

```javascript
// 新增路由配置
{
    path: '/strategies',
    name: '各种策略',
    icon: 'Strategy',
    children: [
        {
            path: '/strategies/needle-under-20',
            name: '单针下二十',
            component: 'NeedleUnder20Page'
        }
    ]
}
```

---

## �🔧 待实现功能

### 第一阶段：基础功能
- [ ] 多周期位置指标计算引擎（`position_calculator.py`）
- [ ] 四种形态识别算法（`pattern_recognizer.py`）
- [ ] 波动率分析模块（`volatility_engine.py`）
- [ ] 成交量分析模块
- [ ] **九维信号评分系统**（`signal_scorer.py`）
- [ ] 历史语境评估器（`context_validator.py`）
- [ ] API接口（`routers/strategies.py`）
- [ ] 前端页面（`NeedleUnder20Page.vue`）
- [ ] 信号集成到主系统（`signal_calculator.py`）

### 第二阶段：高阶指标
- [ ] ADX趋势判断模块
- [ ] OBV底背离检测
- [ ] 布林带支撑验证
- [ ] KDJ共振信号
- [ ] 排名变化追踪
- [ ] 相关性/BETA独立行情筛选

### 第三阶段：自动化
- [ ] 每日自动扫描全市场
- [ ] 信号实时推送（企业微信/邮件）
- [ ] 自选股池自动管理
- [ ] 历史回测系统
- [ ] 评分详情可视化展示

### 第四阶段：优化迭代
- [ ] 参数自适应优化
- [ ] 机器学习模型训练
- [ ] 多策略组合优化
- [ ] 实盘跟踪统计
- [ ] 胜率/盈亏比统计

## � 预期分析流程

```
1. 数据清洗
   └── 载入所有股票历史数据

2. 指标计算
   └── 计算"原神启动"的短期、长期数值
   └── 计算波动率、ADX、OBV等高阶指标

3. 初筛 (Filter 1)
   └── 找出所有 短期 <= 20 的股票

4. 形态分流
   ├── 红线高位 → 进入「空中加油策略组」
   └── 红线低位 → 进入「双底共振策略组」

5. 精筛 (Filter 2)
   ├── 检查波动率是否异常放大？(是则剔除)
   ├── 检查成交量是否萎缩？(是则加分)
   └── 检查前几日是否有崩盘趋势？(是则剔除)

6. 九维评分
   └── 计算各维度得分 → 生成总分 → 生成标签

7. 输出
   └── 按总分降序排列的股票列表
   └── 包含：代码、名称、总分、形态、标签、评分详情
```

## �📚 参考资料

- 原神启动指标公式
- 案例股票：国机精工、久其软件、特发信息、航天动力
- 分析周期：2025年11月
- Gemini策略讨论记录

---

**文档版本**：v2.2  
**创建日期**：2025-11-24  
**更新日期**：2025-11-25  
**更新内容**：

- v2.2 (2025-11-25 22:00) - **核心逻辑重构**
  - ✅ 实现洗盘检测器 `washout_detector_v2.py`
  - ✅ 形态判断基于红线(长期)位置：
    - 空中加油：红线≥60 + 白线下杀
    - 双底共振：红线30-60 + 白线下杀
    - 低位洗盘：红线<30 + 白线下杀（低优先级，不排除）
  - ✅ BBI支撑作为排除条件（可选）
  - ⏳ 评分需加入股价跌幅因子（跌幅小=洗盘效率高=高分）
  - ⏳ 需添加可选筛选项：BBI破位、股价跌幅阈值

- v2.1 (2025-11-25 13:00)
  - 修正位置指标公式：`HHV(C,N)` 用收盘价最高值，非最高价
  - 短期周期N1默认改为3（与同花顺一致）
  - 前端添加位置阈值可调参数（20/30/40/50/60）
  - **待修复**：真跌vs假跌判断逻辑未正确实现
  
- v2.0 (2025-11-25)
  - 新增模块架构设计
  - 新增九维信号评分系统
  - 新增衍生高阶指标（ADX、OBV、布林带等）
  - 新增历史语境评估（前向/后向判据）
  - 新增可变时间窗口设计
  - 新增完整参数配置表
  - 增强形态A/B的说明（空中加油/双底共振）

---

## 🔴 当前实现状态

### 已完成
- [x] 位置指标计算器（position_calculator.py）- 公式已修正
- [x] 形态识别器（pattern_recognizer.py）- 基础框架
- [x] 九维评分引擎（signal_scorer.py）- 基础框架
- [x] API接口（strategies.py）- 支持动态阈值
- [x] 前端页面（NeedleUnder20Module.js）- 含策略介绍

### 待修复（核心问题）
- [ ] **真跌vs假跌判断**：需结合历史数据，而非简单阈值
- [ ] **历史行为基准**：计算个股历史的正常联动关系
- [ ] **异常检测**：当前行为是否偏离历史基准

---

## 🎯 核心设计理念（v2.1更新）

### 关键认知

**"单针下二十"只是筛选入口，核心价值在于识别"假跌/洗盘"机会。**

简单阈值筛选（Excel能做）：
```python
if 指标跌幅 > X and 股价跌幅 < Y:  # ❌ 错误思路
    return "洗盘信号"
```

基于历史数据的智能判断（AI应该做）：
```python
# ✅ 正确思路
历史基准 = 计算该股票过去N天的"指标/股价联动关系"
当日表现 = 计算当日的联动关系
if 当日表现 显著偏离 历史基准:
    return "异常信号（可能是洗盘）"
```

### 洗盘效率模型

```
洗盘效率 = |指标跌幅| / |股价跌幅|

历史平均效率 = mean(过去20天每天的洗盘效率)
历史标准差 = std(过去20天每天的洗盘效率)

当日Z-Score = (当日效率 - 历史平均) / 历史标准差

判断逻辑：
- Z-Score > 2.0：极度异常，指标跌但股价坚挺 → 高概率洗盘 ✅
- Z-Score > 1.0：轻度异常，可能是洗盘 ⚠️
- Z-Score ≈ 0：正常联动，真跌 ❌
- 额外条件：股价跌幅 > 5% 直接判定为真跌 ❌
```

### 多维度历史基准

| 维度 | 历史基准计算 | 异常判断 |
|------|-------------|---------|
| 洗盘效率 | 20日平均(指标跌幅/股价跌幅) | 当日 >> 平均 |
| 波动率 | 20日平均波动率 | 当日 < 平均×0.9（收敛）|
| 成交量 | 5日平均成交量 | 当日 < 平均×0.7（缩量）|
| 价格位置 | 20日价格区间 | 当日接近下轨（支撑）|

### 综合评分公式

```python
洗盘概率得分 = (
    洗盘效率Z分数 × 30% +      # 核心：指标跌但股价稳
    波动率收敛程度 × 25% +      # 洗盘时波动率会压缩
    成交量萎缩程度 × 25% +      # 洗盘时量能会萎缩
    价格支撑强度 × 20%          # 关键位置支撑
)

if 股价跌幅 > 5%:
    洗盘概率得分 = 0  # 真跌，直接剔除
```

---

### 当前代码位置
```
backend/app/services/strategies/
├── common/
│   ├── position_calculator.py  ✅ 公式已修正
│   ├── indicator_calculator.py ✅
│   ├── volatility_engine.py    ⚠️ 需添加历史基准计算
│   └── history_analyzer.py     🆕 待创建：历史行为分析器
└── needle_under_20/
    ├── config.py               ✅ N1=3, N2=10
    ├── pattern_recognizer.py   ⚠️ 需加入真跌过滤
    ├── signal_scorer.py        ⚠️ 需重写为基于历史的评分
    ├── washout_detector_v2.py  ✅ 已创建：洗盘检测器v2
    └── strategy.py             ⚠️ 需传递历史数据
```

---

## 🔥 v2.2 核心认识（开发复盘）

### 关键发现

通过测试股票验证（超卓航科、平潭发展、国机精工），明确了以下核心逻辑：

#### 1. 形态判断基于红线位置

```
红线(长期位置) 决定形态类型：
├── ≥60 → 空中加油（上升趋势中的洗盘，最优）
├── 30-60 → 双底共振（震荡趋势中的洗盘，中等）
└── <30 → 低位洗盘（下降趋势中的洗盘，谨慎但不排除）
```

#### 2. 白线下杀是触发条件

```
白线(短期位置) 从高位急跌：
├── 前几天白线最高 ≥80 且 下杀≥30 → 高质量信号
├── 前几天白线最高 ≥60 且 下杀≥20 → 中质量信号
└── 下杀≥15 → 基础信号
```

#### 3. BBI是支撑验证（可选排除）

```
BBI支撑：
├── 收盘价 > BBI → 站上支撑 ✓（加分）
└── 收盘价 < BBI → 破位 ✗（可选排除）
```

#### 4. 股价跌幅决定洗盘效率

**核心公式**：
```
洗盘效率 = 白线下杀幅度 / 股价跌幅

示例：
- 国机精工：白线下杀50，股价跌-2% → 效率=25 → 高效洗盘 ✅
- 和顺石油：白线下杀50，股价跌-8% → 效率=6.25 → 低效洗盘 ⚠️
```

**结论**：白线跌得多但股价跌得少 = 真洗盘；两者同步大跌 = 真跌

### 筛选选项设计

| 筛选项 | 选项值 | 默认 | 说明 |
|--------|--------|------|------|
| BBI破位 | 排除/不排除 | 排除 | BBI破位是否作为排除条件 |
| 股价跌幅 | 5%/6%/8%/10%/不限 | 不限 | 股价跌幅超过阈值则排除 |
| 短期位置 | 20/30/40/50/60 | 20 | 保留旧筛选（作为辅助） |

### 评分公式（待优化）

```python
# 基础分（形态决定）
base_score = {
    '空中加油': 40,
    '双底共振': 25,
    '低位洗盘': 10
}

# 白线下杀加分
drop_bonus = min(30, short_drop)  # 最多+30

# 股价跌幅扣分（核心！）
price_penalty = max(0, abs(price_change_pct) * 3)  # 跌幅每1%扣3分

# 洗盘效率加分
efficiency_bonus = min(20, washout_efficiency)  # 效率高加分

# 总分
total_score = base_score + drop_bonus - price_penalty + efficiency_bonus
```

### 显示字段（前端）

| 字段 | 格式 | 说明 |
|------|------|------|
| 股价涨跌 | +2.5% / -3.2% | 当日涨跌幅 |
| 白线下杀 | 45.2 | 白线从前高下降的幅度 |
| 洗盘效率 | 18.5 | 白线下杀/股价跌幅 |
| BBI状态 | 站上/破位 | 是否站在BBI之上 |

---

## 📝 版本更新日志

### v4.0 (2025-11-30) - 重大更新

#### 核心改进

**1. 洗盘检测器重写 (washout_detector_v2.py)**
- 简化为两种形态：**空中加油** 和 **底部放量**
- 核心条件：
  - 白线位置 ≤ 10（极低位）
  - 白线下杀幅度 ≥ 40点
  - 红线 ≥ 55 为空中加油，否则为底部放量

**2. 周期选项支持**
- 支持 **10天周期**（数据有限时使用）和 **21天周期**（对齐同花顺）
- 前端添加周期切换按钮
- 21天周期需要28天数据，数据不足时按钮禁用并提示
- API参数：`long_period=10` 或 `long_period=21`

**3. LRU缓存优化**
- 添加25小时TTL缓存，最多缓存10个参数组合
- 首次请求约1.3秒，后续命中缓存瞬间返回
- 重启后端自动清空缓存
- 位置：`backend/app/routers/strategies.py`

**4. 排序优化**
- 评分相同时，按热点排名升序排序（排名越小越靠前）
- 排序key：`(-total_score, latest_rank)`

**5. 先过滤再计算优化**
- 涨幅>5%的股票直接跳过（不太可能是下杀）
- 数据量不足的股票跳过
- 减少无效计算，提升性能

#### 前端更新

**1. 周期选择器**
```
周期: [10天] [21天(禁用)]
```
- 21天按钮在数据不足时自动禁用
- 鼠标悬停显示"需要28天数据，当前N天"

**2. 数据状态提示**
```
数据20天 (需28天才能用21天周期)
```
- 数据充足时显示绿色 ✓
- 数据不足时显示黄色警告

#### API变更

**请求参数新增**：
| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| long_period | int | 10 | 计算周期：10或21 |

**响应字段新增**：
| 字段 | 类型 | 说明 |
|------|------|------|
| long_period | int | 当前使用的周期 |
| data_days | int | 数据库可用天数 |
| required_days | int | 当前周期需要的天数 |
| data_sufficient | bool | 数据是否充足 |

#### 文件变更

```
backend/app/
├── routers/strategies.py          # 添加LRU缓存、周期参数、先过滤
├── services/strategies/
│   └── needle_under_20/
│       └── washout_detector_v2.py # 重写检测逻辑

frontend/src/components/modules/
└── NeedleUnder20Module.js         # 添加周期选择器、数据状态提示
```

#### 性能数据

| 场景 | 耗时 |
|------|------|
| 首次计算 | ~1.3秒 |
| 缓存命中 | <10ms |
| 缓存有效期 | 25小时 |
| 缓存容量 | 10个参数组合 |

---

### v3.0 (2025-11-28)
- 添加BBI破位筛选
- 添加股价跌幅阈值筛选
- 优化评分公式

### v2.0 (2025-11-25)
- 九维评分系统
- 四种形态识别
- 前端页面实现

### v1.0 (2025-11-20)
- 初始设计文档
- 位置指标计算器
- 基础架构搭建

---

**作者**：策略研发团队
**最后更新**：2025-11-30
