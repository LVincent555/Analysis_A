# æ•°æ®å¯¼å…¥å’Œç»´æŠ¤å·¥å…·ä½¿ç”¨æŒ‡å—

## ğŸ“ æ–‡ä»¶ç»“æ„

```
stock_analysis_app/
â”œâ”€â”€ update_daily_data.py          # âœ… ç»Ÿä¸€CLIå…¥å£ï¼ˆå”¯ä¸€ä¸»ç¨‹åºï¼‰
â”œâ”€â”€ backend/
â”‚   â””â”€â”€ scripts/
â”‚       â”œâ”€â”€ import_data_robust.py       # è‚¡ç¥¨æ•°æ®å¯¼å…¥
â”‚       â”œâ”€â”€ import_sectors_robust.py    # æ¿å—æ•°æ®å¯¼å…¥
â”‚       â”œâ”€â”€ import_state_manager.py     # çŠ¶æ€ç®¡ç†ï¼ˆå…¼å®¹è€ç‰ˆæœ¬JSONï¼‰
â”‚       â”œâ”€â”€ data_importer.py            # å¯¼å…¥è°ƒåº¦å™¨
â”‚       â”œâ”€â”€ data_scanner.py             # æ–‡ä»¶æ‰«æå™¨
â”‚       â””â”€â”€ data_cleaner.py             # æ•°æ®æ¸…ç†å™¨
â””â”€â”€ data/
    â”œâ”€â”€ data_import_state.json          # è‚¡ç¥¨æ•°æ®çŠ¶æ€
    â””â”€â”€ sector_import_state.json        # æ¿å—æ•°æ®çŠ¶æ€
```

---

## âš™ï¸ æ™ºèƒ½å»é‡æœºåˆ¶

### è‡ªåŠ¨å»é‡å¼‚å¸¸æ•°æ®

åœ¨å¯¼å…¥è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿä¼š**è‡ªåŠ¨æ£€æµ‹å¹¶å»é™¤æ˜æ˜¾å¼‚å¸¸çš„é‡å¤æ•°æ®**ï¼š

**å»é‡ç­–ç•¥ï¼ˆä¸¥æ ¼æ¡ä»¶ï¼‰ï¼š**
1. âœ… æ£€æµ‹åŒä¸€è‚¡ç¥¨ä»£ç å‡ºç°å¤šæ¬¡
2. âœ… è®¡ç®—æ¯æ¡è®°å½•ä¸å‘¨å›´æ•°æ®çš„åç¦»åº¦
3. âœ… åªåˆ é™¤æ˜æ˜¾å¼‚å¸¸çš„è®°å½•ï¼ˆåç¦» > 2Ïƒï¼‰
4. âœ… åˆ†æ•°å·®å¼‚å¿…é¡» > 0.3

**ç¤ºä¾‹ï¼š**
```
æ£€æµ‹åˆ°é‡å¤: 300695ï¼ˆå…†ä¸°è‚¡ä»½ï¼‰
- è¡Œ3138: åˆ†æ•°=-4.7, å‘¨å›´å‡å€¼=-4.7, åç¦»=0.1Ïƒ âœ… ä¿ç•™
- è¡Œ3139: åˆ†æ•°=-4.2, å‘¨å›´å‡å€¼=-4.7, åç¦»=2.5Ïƒ âŒ åˆ é™¤ï¼ˆå¼‚å¸¸ï¼‰

ç»“æœ: è‡ªåŠ¨å»é™¤è¡Œ3139ï¼Œä¿ç•™æ­£å¸¸æ•°æ®
```

**å¦‚æœå»é‡åä»æœ‰é‡å¤ï¼š**
- è§¦å‘ERRORï¼Œå¯¼å…¥å¤±è´¥
- éœ€è¦äººå·¥æ£€æŸ¥Excelæ–‡ä»¶
- å®Œæ•´å›æ»šï¼Œä¸å½±å“æ•°æ®åº“

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯¼å…¥æ•°æ®ï¼ˆé»˜è®¤æ“ä½œï¼‰

```bash
# æ–¹å¼1ï¼šç›´æ¥è¿è¡Œï¼ˆé»˜è®¤å¯¼å…¥ï¼‰
python update_daily_data.py

# æ–¹å¼2ï¼šæ˜ç¡®æŒ‡å®šå¯¼å…¥å‘½ä»¤
python update_daily_data.py import

# è·³è¿‡æ–‡ä»¶æ‰«æ
python update_daily_data.py import --skip-scan
```

**è¯´æ˜ï¼š**
- è‡ªåŠ¨å¯¼å…¥è‚¡ç¥¨å’Œæ¿å—æ•°æ®
- è‡ªåŠ¨æ‰«ææ–‡ä»¶å®Œæ•´æ€§ï¼ˆå¯è·³è¿‡ï¼‰
- å¹‚ç­‰æ€§ï¼šé‡å¤è¿è¡Œä¸ä¼šé‡å¤å¯¼å…¥
- å¤±è´¥è‡ªåŠ¨å›æ»š

---

### 2. æ‰«ææ–‡ä»¶å®Œæ•´æ€§

```bash
# æ‰«ææ‰€æœ‰ç±»å‹
python update_daily_data.py scan

# åªæ‰«æè‚¡ç¥¨æ•°æ®
python update_daily_data.py scan --type stock

# åªæ‰«ææ¿å—æ•°æ®
python update_daily_data.py scan --type sector
```

**æ£€æµ‹å†…å®¹ï¼š**
- âœ… Excelæ–‡ä»¶ç¼ºå¤±ï¼ˆå¯¼å…¥åè¢«åˆ é™¤ï¼‰
- âœ… Excelæ–‡ä»¶å˜æ›´ï¼ˆæ–‡ä»¶hashä¸ä¸€è‡´ï¼‰
- âš ï¸  å‘ç°å¼‚å¸¸ä¼šæ ‡è®°ä¸º `warning` çŠ¶æ€

---

### 3. æ¸…ç†å­¤å„¿æ•°æ®

#### æŸ¥çœ‹è­¦å‘Š

```bash
# æŸ¥çœ‹æ‰€æœ‰è­¦å‘Š
python update_daily_data.py clean --scan

# åªæŸ¥çœ‹è‚¡ç¥¨æ•°æ®è­¦å‘Š
python update_daily_data.py clean --scan --type stock
```

#### é¢„æ¼”æ¸…ç†

```bash
# é¢„æ¼”æ‰€æœ‰
python update_daily_data.py clean --dry-run

# é¢„æ¼”æŒ‡å®šç±»å‹
python update_daily_data.py clean --dry-run --type stock
```

#### æ‰§è¡Œæ¸…ç†

```bash
# æ¸…ç†æ‰€æœ‰è­¦å‘Šæ•°æ®ï¼ˆéœ€è¦ç¡®è®¤ï¼‰
python update_daily_data.py clean

# æ¸…ç†æŒ‡å®šæ—¥æœŸ
python update_daily_data.py clean --dates 20251104,20251105

# åªæ¸…ç†è‚¡ç¥¨æ•°æ®
python update_daily_data.py clean --type stock
```

âš ï¸ **è­¦å‘Šï¼šæ¸…ç†æ˜¯ç¡¬åˆ é™¤ï¼Œæ•°æ®å°†æ°¸ä¹…ä¸¢å¤±ï¼**

---

## ğŸ“Š æ•°æ®çŠ¶æ€è¯´æ˜

### JSONçŠ¶æ€æ–‡ä»¶

**data_import_state.json** å’Œ **sector_import_state.json**

```json
{
  "version": "1.0",
  "imports": {
    "20251104": {
      "filename": "20251104_data_sma_feature_color.xlsx",
      "status": "success",        // âœ… æˆåŠŸ
      "file_hash": "abc123...",
      "imported_count": 5434
    },
    "20251105": {
      "filename": "20251105_data_sma_feature_color.xlsx",
      "status": "warning",        // âš ï¸ è­¦å‘Šï¼ˆæ–‡ä»¶ç¼ºå¤±/å˜æ›´ï¼‰
      "warning_info": {
        "warning_type": "file_missing",
        "detected_at": "2025-11-07 23:00:00",
        "suggest_action": "delete_db_data"
      }
    },
    "20251106": {
      "filename": "20251106_data_sma_feature_color.xlsx",
      "status": "failed",         // âŒ å¤±è´¥ï¼ˆå¦‚é‡å¤æ•°æ®ï¼‰
      "error": "duplicate key..."
    },
    "20251107": {
      "filename": "20251107_data_sma_feature_color.xlsx",
      "status": "deleted",        // ğŸ—‘ï¸ å·²åˆ é™¤
      "deletion_info": {
        "deleted_at": "2025-11-07 23:15:00",
        "deleted_by": "clean_script"
      }
    }
  }
}
```

### çŠ¶æ€åˆ†ç±»

| çŠ¶æ€ | è¯´æ˜ | å¤„ç†æ–¹å¼ |
|------|------|----------|
| `success` | âœ… å¯¼å…¥æˆåŠŸ | æ­£å¸¸çŠ¶æ€ |
| `failed` | âŒ å¯¼å…¥å¤±è´¥ï¼ˆERRORçº§ï¼‰ | ä¿®å¤æ•°æ®æ–‡ä»¶åé‡æ–°å¯¼å…¥ |
| `warning` | âš ï¸ æ–‡ä»¶ç¼ºå¤±/å˜æ›´ | ä½¿ç”¨cleanå‘½ä»¤æ¸…ç† |
| `deleted` | ğŸ—‘ï¸ å·²æ¸…ç† | è®°å½•çŠ¶æ€ï¼Œå·²åˆ é™¤ |
| `in_progress` | â³ å¯¼å…¥ä¸­ | ä¸´æ—¶çŠ¶æ€ |

---

## ğŸ”„ å…¸å‹å·¥ä½œæµ

### åœºæ™¯1ï¼šæ¯æ—¥å¯¼å…¥æ–°æ•°æ®

```bash
# 1. å°†æ–°çš„Excelæ–‡ä»¶æ”¾å…¥ data/ ç›®å½•
# 2. è¿è¡Œå¯¼å…¥
python update_daily_data.py

# è¾“å‡ºï¼š
# âœ… æ‰€æœ‰æ•°æ®å¯¼å…¥æˆåŠŸï¼
# âœ… æ­£å¸¸: 5 ä¸ª
```

### åœºæ™¯2ï¼šå‘ç°æ•°æ®é—®é¢˜ï¼Œåˆ é™¤Excelæ–‡ä»¶

```bash
# 1. åˆ é™¤æœ‰é—®é¢˜çš„Excelæ–‡ä»¶ï¼ˆå¦‚ï¼š20251104_data_sma_feature_color.xlsxï¼‰

# 2. è¿è¡Œå¯¼å…¥ï¼ˆè‡ªåŠ¨æ‰«æï¼‰
python update_daily_data.py

# è¾“å‡ºï¼š
# âš ï¸  ç¼ºå¤±: 1 ä¸ªï¼ˆå·²æ ‡è®°ä¸ºwarningï¼‰
# âš ï¸  å‘ç°æ–‡ä»¶å¼‚å¸¸ï¼
#    è¿è¡Œæ¸…ç†å·¥å…·æŸ¥çœ‹è¯¦æƒ…: python update_daily_data.py clean --scan

# 3. æŸ¥çœ‹è¯¦æƒ…
python update_daily_data.py clean --scan

# 4. é¢„æ¼”æ¸…ç†
python update_daily_data.py clean --dry-run

# 5. æ‰§è¡Œæ¸…ç†
python update_daily_data.py clean
# ç¡®è®¤ï¼Ÿ(yes/no): yes
# âœ… æ¸…ç†å®Œæˆ
```

### åœºæ™¯3ï¼šExcelæ–‡ä»¶è¢«ä¿®æ”¹

```bash
# 1. è¿è¡Œå¯¼å…¥ï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼‰
python update_daily_data.py

# è¾“å‡ºï¼š
# âš ï¸  å˜æ›´: 1 ä¸ªï¼ˆå·²æ ‡è®°ä¸ºwarningï¼‰

# 2. å†³ç­–ï¼š
# é€‰é¡¹Aï¼šæ¸…ç†æ—§æ•°æ®ï¼Œé‡æ–°å¯¼å…¥
python update_daily_data.py clean
# ç„¶åé‡æ–°å¯¼å…¥

# é€‰é¡¹Bï¼šæ¢å¤åŸæ–‡ä»¶ï¼ˆå¦‚æœæœ‰å¤‡ä»½ï¼‰
```

---

## ğŸ”§ ç‹¬ç«‹è¿è¡Œè„šæœ¬

### åç«¯è„šæœ¬å¯ä»¥ç‹¬ç«‹è¿è¡Œ

```bash
cd backend/scripts

# ç‹¬ç«‹å¯¼å…¥è‚¡ç¥¨æ•°æ®
python import_data_robust.py

# ç‹¬ç«‹å¯¼å…¥æ¿å—æ•°æ®
python import_sectors_robust.py

# ç‹¬ç«‹æ‰«ææ–‡ä»¶
python data_scanner.py

# ç‹¬ç«‹æ¸…ç†æ•°æ®
python data_cleaner.py --scan
python data_cleaner.py --clean --dry-run
```

---

## âš™ï¸ å…¼å®¹æ€§è¯´æ˜

### è€ç‰ˆæœ¬JSONå…¼å®¹

- âœ… **å®Œå…¨å…¼å®¹**è€ç‰ˆæœ¬JSONæ–‡ä»¶
- âœ… è‡ªåŠ¨å‡çº§ï¼ˆæ— éœ€æ‰‹åŠ¨æ“ä½œï¼‰
- âœ… ç¼ºå¤±çš„å­—æ®µè‡ªåŠ¨è¡¥å…¨
- âœ… ä¸å¼ºåˆ¶å‡çº§ï¼Œå¹³æ»‘è¿‡æ¸¡

### ç¤ºä¾‹

```python
# è€ç‰ˆæœ¬JSONï¼ˆæ²¡æœ‰warning_infoå­—æ®µï¼‰
{
  "imports": {
    "20251104": {
      "status": "success",
      "file_hash": "abc123..."
    }
  }
}

# è‡ªåŠ¨å‡çº§å
{
  "version": "1.0",  # è‡ªåŠ¨æ·»åŠ 
  "imports": {
    "20251104": {
      "status": "success",
      "file_hash": "abc123...",
      "warning_info": null,    # è‡ªåŠ¨æ·»åŠ 
      "deletion_info": null    # è‡ªåŠ¨æ·»åŠ 
    }
  }
}
```

---

## ğŸ›¡ï¸ å®‰å…¨æœºåˆ¶

1. **å¯¼å…¥å¤±è´¥è‡ªåŠ¨å›æ»š**
   - äº‹åŠ¡æœºåˆ¶
   - å¤±è´¥ä¸å½±å“ç°æœ‰æ•°æ®
   - å®Œæ•´æ—¥å¿—è®°å½•

2. **æ¸…ç†éœ€è¦äºŒæ¬¡ç¡®è®¤**
   - édry-runæ¨¡å¼å¿…é¡»è¾“å…¥yes
   - é¢„æ¼”æ¨¡å¼ä¸ä¼šçœŸæ­£åˆ é™¤

3. **ERROR vs WARNING åŒºåˆ†**
   - ERRORï¼ˆfailedï¼‰ï¼šæ•°æ®é—®é¢˜ï¼Œä¸å¯¼å…¥
     - é‡å¤æ•°æ®
     - çº¦æŸè¿å
     - æ–‡ä»¶æ ¼å¼é”™è¯¯
   - WARNINGï¼ˆwarningï¼‰ï¼šæ–‡ä»¶å˜åŠ¨
     - æ–‡ä»¶ç¼ºå¤±
     - æ–‡ä»¶å˜æ›´

4. **åç«¯å¯åŠ¨ä¸é˜»å¡**
   - Warningåªè®°å½•æ—¥å¿—
   - ä¸å½±å“APIæœåŠ¡
   - å¯æŸ¥è¯¢çŠ¶æ€API

---

## ğŸ“ æ—¥å¿—æ–‡ä»¶

æ‰€æœ‰æ“ä½œéƒ½æœ‰å®Œæ•´æ—¥å¿—è®°å½•ï¼š

```
logs/update_data_20251107_230000.log
```

æ—¥å¿—åŒ…å«ï¼š
- å¯¼å…¥è¿‡ç¨‹è¯¦æƒ…
- æ–‡ä»¶æ‰«æç»“æœ
- æ¸…ç†æ“ä½œè®°å½•
- é”™è¯¯å †æ ˆä¿¡æ¯

---

## ğŸ†˜ å¸¸è§é—®é¢˜

### Q1: é‡å¤æ•°æ®é”™è¯¯æ€ä¹ˆåŠï¼Ÿ

**A:** ç³»ç»Ÿä¼š**è‡ªåŠ¨å¤„ç†æ˜æ˜¾å¼‚å¸¸çš„é‡å¤**ã€‚å¦‚æœè¿˜æŠ¥é”™ï¼Œè¯´æ˜æ˜¯å¤æ‚çš„é‡å¤æƒ…å†µã€‚

**åœºæ™¯1ï¼šè‡ªåŠ¨å»é‡æˆåŠŸï¼ˆå¸¸è§ï¼‰**
```
ğŸ“Š è¯»å–åˆ° 5434 æ¡è®°å½•
âš ï¸  æ£€æµ‹åˆ° 1 ä¸ªé‡å¤çš„è‚¡ç¥¨ä»£ç 
  [å»é‡] è‚¡ç¥¨ 300695(å…†ä¸°è‚¡ä»½) è¡Œ3139 åˆ†æ•°=-4.2 å‘¨å›´å‡å€¼=-4.7 åç¦»=2.5Ïƒ â†’ åˆ é™¤
ğŸ“Š å»é‡åå‰©ä½™ 5433 æ¡è®°å½•
âœ… å¯¼å…¥æˆåŠŸ
```

**åœºæ™¯2ï¼šå»é‡åä»æœ‰é‡å¤ï¼ˆéœ€è¦äººå·¥å¤„ç†ï¼‰**
```
âŒ Excelæ–‡ä»¶ä¸­å­˜åœ¨é‡å¤çš„è‚¡ç¥¨ä»£ç ï¼ˆå»é‡åä»å­˜åœ¨ï¼‰: 300614
   è‚¡ç¥¨ 300614 å‡ºç°äº† 2 æ¬¡ï¼Œåœ¨è¡Œ: [100, 200]

å¤„ç†æ–¹å¼ï¼š
1. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
   cat logs/update_data_*.log | grep "300614"

2. æ‰“å¼€Excelæ£€æŸ¥è¿™ä¸¤è¡Œæ•°æ®
   - å¦‚æœåˆ†æ•°ç›¸åŒæˆ–æ¥è¿‘ï¼Œå¯èƒ½æ˜¯çœŸå®çš„é‡å¤æ•°æ®é”™è¯¯
   - æ‰‹åŠ¨åˆ é™¤å…¶ä¸­ä¸€è¡Œ

3. é‡æ–°å¯¼å…¥
   python update_daily_data.py
```

### Q2: warningçŠ¶æ€èƒ½æ¢å¤å—ï¼Ÿ

**A:** å¦‚æœæ–‡ä»¶è¿˜åœ¨ï¼Œå¯ä»¥æ¢å¤ï¼š

```python
# æ–¹æ³•1ï¼šé‡æ–°æ”¾å›Excelæ–‡ä»¶ï¼Œå†æ¬¡è¿è¡Œå¯¼å…¥
# æ–¹æ³•2ï¼šæ‰‹åŠ¨ç¼–è¾‘JSONï¼Œå°†statusæ”¹å›success
```

### Q3: åˆ é™¤åèƒ½æ¢å¤å—ï¼Ÿ

**A:** ä¸èƒ½ã€‚æ¸…ç†æ˜¯ç¡¬åˆ é™¤ï¼Œæ•°æ®æ°¸ä¹…ä¸¢å¤±ã€‚å»ºè®®å…ˆä½¿ç”¨ `--dry-run` é¢„æ¼”ã€‚

### Q4: å¦‚ä½•æŸ¥çœ‹å½“å‰æ•°æ®çŠ¶æ€ï¼Ÿ

```bash
# æŸ¥çœ‹JSONæ–‡ä»¶
cat data/data_import_state.json

# æ‰«ææ–‡ä»¶
python update_daily_data.py scan

# æŸ¥çœ‹è­¦å‘Š
python update_daily_data.py clean --scan
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
1. æ—¥å¿—æ–‡ä»¶ï¼ˆlogs/ç›®å½•ï¼‰
2. JSONçŠ¶æ€æ–‡ä»¶ï¼ˆdata/ç›®å½•ï¼‰
3. æœ¬æ–‡æ¡£

---

**æœ€åæ›´æ–°ï¼š2025-11-07**
