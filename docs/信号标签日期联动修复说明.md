# ä¿¡å·æ ‡ç­¾æ—¥æœŸè”åŠ¨ä¿®å¤è¯´æ˜

## ğŸ”´ é—®é¢˜æè¿°

**ä¸¥é‡Bug**: ä¿¡å·æ ‡ç­¾ï¼ˆå¦‚"TOP100Â·2æ¬¡"ï¼‰æ²¡æœ‰ä¸ç”¨æˆ·é€‰æ‹©çš„æŸ¥è¯¢æ—¥æœŸè”åŠ¨ï¼Œå§‹ç»ˆæ˜¾ç¤ºåŸºäºæœ€æ–°æ—¥æœŸçš„ç»Ÿè®¡ç»“æœã€‚

### é—®é¢˜è¡¨ç°
ç”¨æˆ·åœ¨å‰ç«¯é€‰æ‹©å†å²æ—¥æœŸï¼ˆå¦‚2025å¹´11æœˆ5æ—¥ï¼‰æŸ¥è¯¢è‚¡ç¥¨æ—¶ï¼š
- âŒ **é”™è¯¯è¡¨ç°**: æ˜¾ç¤º"TOP100Â·2æ¬¡"ï¼Œä½†è¿™ä¸ªç»Ÿè®¡æ˜¯åŸºäºæœ€æ–°æ—¥æœŸï¼ˆ11æœˆ12æ—¥ï¼‰å¾€å‰14å¤©çš„ç»“æœ
- âœ… **æ­£ç¡®è¡¨ç°**: åº”è¯¥æ˜¾ç¤ºåŸºäº11æœˆ5æ—¥å¾€å‰14å¤©çš„TOP100å‡ºç°æ¬¡æ•°

### å½±å“èŒƒå›´
- ä¸ªè‚¡æŸ¥è¯¢é¡µé¢
- æœ€æ–°çƒ­ç‚¹é¡µé¢ï¼ˆå¦‚æœä¹Ÿä½¿ç”¨äº†selectedDateï¼‰
- è¡Œä¸šè¯¦æƒ…é¡µé¢ï¼ˆå¦‚æœä¹Ÿä½¿ç”¨äº†selectedDateï¼‰

---

## ğŸ” æ ¹æœ¬åŸå› 

### é—®é¢˜1: å‰ç«¯æœªä¼ é€’æ—¥æœŸå‚æ•° âŒ

**æ–‡ä»¶**: `frontend/src/components/modules/StockQueryModule.js`

**é—®é¢˜ä»£ç ** (ç¬¬37-45è¡Œ)ï¼š
```javascript
// ä¸ä½¿ç”¨selectedDateï¼Œå§‹ç»ˆæŸ¥è¯¢å…¨éƒ¨å†å²æ•°æ®
const url = `${API_BASE_URL}/api/stock/${stockCode.trim()}`;
const response = await axios.get(url, {
  params: {
    ...signalThresholds  // âŒ ç¼ºå°‘ date å‚æ•°
  }
});
```

**åæœ**: 
- åç«¯APIçš„`target_date`å‚æ•°ä¸º`None`
- è§¦å‘é»˜è®¤é€»è¾‘ï¼šä½¿ç”¨`memory_cache.get_latest_date()`ï¼ˆæœ€æ–°æ—¥æœŸï¼‰
- ä¿¡å·æ ‡ç­¾åŸºäºæœ€æ–°æ—¥æœŸç»Ÿè®¡ï¼Œä¸ç”¨æˆ·é€‰æ‹©çš„å†å²æ—¥æœŸä¸ç¬¦

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: å‰ç«¯ä¼ é€’æ—¥æœŸå‚æ•°

**æ–‡ä»¶**: `frontend/src/components/modules/StockQueryModule.js`

**ä¿®å¤åä»£ç **:
```javascript
// ä½¿ç”¨selectedDateä½œä¸ºåŸºå‡†æ—¥æœŸï¼Œè®¡ç®—ä¿¡å·æ—¶ä¼šä»¥è¯¥æ—¥æœŸä¸ºåŸºå‡†å¾€å‰ç»Ÿè®¡
const url = `${API_BASE_URL}/api/stock/${stockCode.trim()}`;
const response = await axios.get(url, {
  params: {
    date: selectedDate,  // âœ… ä¼ é€’æ—¥æœŸå‚æ•°
    ...signalThresholds,
    volume_surge_min: signalThresholds.volumeSurgeMin,
    volatility_surge_min: signalThresholds.volatilitySurgeMin
  }
});
```

**æ•ˆæœ**:
- åç«¯æ¥æ”¶åˆ°`target_date = selectedDate`ï¼ˆå¦‚"20251105"ï¼‰
- åŸºäºè¯¥æ—¥æœŸæŸ¥è¯¢å†å²æ•°æ®å¹¶è®¡ç®—ä¿¡å·
- ä¿¡å·æ ‡ç­¾ç»Ÿè®¡çª—å£ï¼š`selectedDate`å¾€å‰14å¤©

---

## ğŸ§ª éªŒè¯é€»è¾‘

### åç«¯æ•°æ®æµï¼ˆå·²éªŒè¯æ­£ç¡®ï¼‰

#### 1. APIå±‚ (`stock.py`)
```python
@router.get("/stock/{stock_code}")
async def query_stock(
    stock_code: str, 
    date: str = None,  # âœ… æ¥æ”¶å‰ç«¯ä¼ æ¥çš„æ—¥æœŸ
    ...
):
    result = stock_service.search_stock(
        stock_code, 
        target_date=date,  # âœ… ä¼ é€’ç»™serviceå±‚
        ...
    )
```

#### 2. Serviceå±‚ (`stock_service_db.py`)
```python
def search_stock(self, keyword: str, target_date: Optional[str] = None, ...):
    # 1. ç¡®å®šç›®æ ‡æ—¥æœŸ
    if target_date:
        target_date_obj = datetime.strptime(target_date, '%Y%m%d').date()
    else:
        target_date_obj = memory_cache.get_latest_date()  # âŒ ä¹‹å‰èµ°è¿™é‡Œ
    
    # 2. è·å–å†å²æ•°æ®ï¼ˆä»¥target_date_objä¸ºåŸºå‡†å¾€å‰30å¤©ï¼‰
    all_dates = memory_cache.get_dates_range(60)
    target_dates = [d for d in all_dates if d <= target_date_obj][:30]
    history_data = memory_cache.get_stock_history(stock_code, target_dates)
    
    # 3. è®¡ç®—ä¿¡å·ï¼ˆæœ€æ–°æ•°æ® = target_date_objçš„æ•°æ®ï¼‰
    latest_data = history_data[0]  # âœ… è¿™æ˜¯target_date_objçš„æ•°æ®
    signal_result = calculator.calculate_signals(
        stock_code=stock_code,
        current_date=latest_data.date,  # âœ… ä½¿ç”¨target_date_obj
        current_data=latest_data,
        ...
    )
```

#### 3. ä¿¡å·è®¡ç®—å™¨ (`signal_calculator.py`)
```python
def calculate_signals(
    self,
    stock_code: str,
    current_date: date,  # âœ… è¿™æ˜¯target_date_obj
    ...
):
    # é«˜é¢‘çƒ­ç‚¹æ¦œï¼šåŸºäº14å¤©èšåˆæ•°æ®
    hot_signal = self.calculate_hot_spot_signal(
        stock_code, 
        current_date.strftime('%Y%m%d')  # âœ… ä¼ é€’target_date
    )
```

#### 4. çƒ­ç‚¹æ¦œç¼“å­˜ (`hot_spots_cache.py`)
```python
@classmethod
def _load_date(cls, date: str):
    # å°†å­—ç¬¦ä¸²æ—¥æœŸè½¬ä¸ºdateå¯¹è±¡
    target_date_obj = datetime.strptime(date, '%Y%m%d').date()
    
    # âœ… è·å–ä»¥target_date_objä¸ºåŸºå‡†å¾€å‰çš„14å¤©
    all_dates = memory_cache.dates  # é™åºï¼šæ–°â†’æ—§
    target_dates = [d for d in all_dates if d <= target_date_obj][:14]
    
    # ç»Ÿè®¡æ¯åªè‚¡ç¥¨åœ¨è¿™14å¤©å†…çš„å‡ºç°æ¬¡æ•°
    for date_obj in target_dates:
        daily_stocks = memory_cache.get_top_n_stocks(date_obj, 3000)
        for stock_data in daily_stocks:
            # ç»Ÿè®¡å„æ¡£ä½å‡ºç°æ¬¡æ•°ï¼ˆTOP100, TOP200, ...ï¼‰
            ...
```

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### åœºæ™¯: ç”¨æˆ·é€‰æ‹©2025å¹´11æœˆ5æ—¥æŸ¥è¯¢"ä¸œæ–¹ç¯å®‡(603706)"

| æ—¶é—´ç‚¹ | ä¿®å¤å‰ | ä¿®å¤å |
|--------|--------|--------|
| **å‰ç«¯ä¼ å‚** | `date: undefined` | `date: "20251105"` |
| **åç«¯target_date** | `None` â†’ ä½¿ç”¨æœ€æ–°æ—¥æœŸ(11æœˆ12æ—¥) | `"20251105"` |
| **14å¤©ç»Ÿè®¡çª—å£** | 10æœˆ30æ—¥~11æœˆ12æ—¥ | 10æœˆ23æ—¥~11æœˆ5æ—¥ |
| **TOP100æ¬¡æ•°ç»Ÿè®¡** | åŸºäºæœ€æ–°14å¤©ï¼Œæ˜¾ç¤º"2æ¬¡" | åŸºäº11æœˆ5æ—¥å‰14å¤©ï¼Œå¯èƒ½æ˜¯"1æ¬¡"æˆ–"0æ¬¡" |
| **ç”¨æˆ·ä½“éªŒ** | âŒ æ•°æ®é”™è¯¯ï¼Œè¯¯å¯¼ç”¨æˆ· | âœ… æ•°æ®å‡†ç¡®ï¼Œåæ˜ å†å²çœŸå®æƒ…å†µ |

---

## âœ… ä¿®å¤éªŒè¯æ¸…å•

### å‰ç«¯éªŒè¯
- [x] `StockQueryModule.js` ä¼ é€’`date: selectedDate`å‚æ•°
- [ ] åˆ·æ–°é¡µé¢ï¼Œé€‰æ‹©å†å²æ—¥æœŸï¼ˆå¦‚11æœˆ5æ—¥ï¼‰
- [ ] æŸ¥è¯¢è‚¡ç¥¨ï¼Œè§‚å¯Ÿä¿¡å·æ ‡ç­¾æ˜¯å¦å˜åŒ–
- [ ] åˆ‡æ¢æ—¥æœŸï¼Œä¿¡å·æ ‡ç­¾åº”å®æ—¶æ›´æ–°

### åç«¯éªŒè¯
- [x] ç¡®è®¤`stock.py` APIæ¥æ”¶`date`å‚æ•°
- [x] ç¡®è®¤`stock_service_db.py`ä½¿ç”¨`target_date`å‚æ•°
- [x] ç¡®è®¤`signal_calculator.py`ä¼ é€’æ­£ç¡®æ—¥æœŸ
- [x] ç¡®è®¤`hot_spots_cache.py`åŸºäºç›®æ ‡æ—¥æœŸç»Ÿè®¡14å¤©

### åŠŸèƒ½æµ‹è¯•
- [ ] æŸ¥è¯¢è‚¡ç¥¨Aï¼Œé€‰æ‹©11æœˆ5æ—¥ï¼Œè®°å½•ä¿¡å·æ ‡ç­¾
- [ ] åŒä¸€è‚¡ç¥¨Aï¼Œåˆ‡æ¢åˆ°11æœˆ12æ—¥ï¼Œä¿¡å·æ ‡ç­¾åº”ä¸åŒ
- [ ] éªŒè¯æ ‡ç­¾æ¬¡æ•°çš„å‡†ç¡®æ€§ï¼ˆæ‰‹åŠ¨æ ¸å¯¹æ•°æ®åº“ï¼‰

---

## ğŸ”„ å…¶ä»–éœ€è¦ä¿®å¤çš„é¡µé¢

### 1. è¡Œä¸šè¯¦æƒ…é¡µ (`IndustryQueryModule.js`)

**æ£€æŸ¥ç‚¹**: æ˜¯å¦ä¹Ÿå­˜åœ¨åŒæ ·é—®é¢˜ï¼Ÿ

```javascript
// éœ€è¦æ£€æŸ¥æ˜¯å¦ä¼ é€’äº† date å‚æ•°
const response = await axios.get(`${API_BASE_URL}/api/industry/${industry}/stocks`, {
  params: {
    date: selectedDate,  // â“ æ˜¯å¦ä¼ é€’ï¼Ÿ
    ...
  }
});
```

### 2. æœ€æ–°çƒ­ç‚¹é¡µ (`HotSpotsModule.js`)

**æ£€æŸ¥ç‚¹**: å¦‚æœæ”¯æŒå†å²æ—¥æœŸæŸ¥è¯¢ï¼Œæ˜¯å¦ä¼ é€’æ—¥æœŸå‚æ•°ï¼Ÿ

---

## ğŸ“ åç»­æ”¹è¿›å»ºè®®

### 1. ç¼“å­˜é”®åº”åŒ…å«æ—¥æœŸ
å½“å‰`HotSpotsCache`çš„ç¼“å­˜é”®åªæœ‰æ—¥æœŸï¼Œå¦‚æœå¤šä¸ªè¯·æ±‚åŒæ—¶è®¿é—®ä¸åŒæ—¥æœŸï¼Œå¯èƒ½ä¼šæœ‰ç¼“å­˜æ··ä¹±ã€‚å»ºè®®ï¼š
```python
# å½“å‰
cls._cache[date] = {...}

# æ”¹è¿›ï¼ˆå¦‚æœéœ€è¦ï¼‰
# å·²ç»åŒ…å«æ—¥æœŸï¼Œæ— éœ€ä¿®æ”¹
```

### 2. å‰ç«¯æ—¥æœŸé€‰æ‹©å™¨åŒæ­¥
ç¡®ä¿æ‰€æœ‰é¡µé¢çš„æ—¥æœŸé€‰æ‹©å™¨éƒ½æ­£ç¡®åŒæ­¥åˆ°APIè°ƒç”¨å‚æ•°ä¸­ã€‚

### 3. æ·»åŠ æ—¥å¿—
åœ¨å…³é”®ä½ç½®æ·»åŠ æ—¥å¿—ï¼Œæ–¹ä¾¿è°ƒè¯•ï¼š
```python
logger.info(f"ğŸ” è®¡ç®—ä¿¡å·: stock={stock_code}, date={current_date}, ç»Ÿè®¡çª—å£={14å¤©å‰}~{current_date}")
```

---

## ğŸ¯ æ€»ç»“

**æ ¹æœ¬é—®é¢˜**: å‰ç«¯æ²¡æœ‰ä¼ é€’`date`å‚æ•°ï¼Œå¯¼è‡´åç«¯å§‹ç»ˆä½¿ç”¨æœ€æ–°æ—¥æœŸè®¡ç®—ä¿¡å·æ ‡ç­¾ã€‚

**æ ¸å¿ƒä¿®å¤**: åœ¨`StockQueryModule.js`ä¸­æ·»åŠ `date: selectedDate`å‚æ•°ã€‚

**åç«¯é€»è¾‘**: å·²éªŒè¯æ­£ç¡®ï¼Œæ— éœ€ä¿®æ”¹ã€‚åç«¯ä¼šåŸºäºä¼ å…¥çš„æ—¥æœŸå¾€å‰ç»Ÿè®¡14å¤©ã€‚

**é¢„æœŸæ•ˆæœ**: ç”¨æˆ·é€‰æ‹©ä¸åŒå†å²æ—¥æœŸæ—¶ï¼Œä¿¡å·æ ‡ç­¾ä¼šå®æ—¶æ›´æ–°ï¼Œå‡†ç¡®åæ˜ è¯¥æ—¥æœŸçš„ç»Ÿè®¡ç»“æœã€‚

---

**ä¿®å¤æ—¥æœŸ**: 2025-11-13  
**ä¿®å¤äººå‘˜**: Cascade AI Assistant  
**æµ‹è¯•çŠ¶æ€**: â³ å¾…ç”¨æˆ·æµ‹è¯•éªŒè¯
