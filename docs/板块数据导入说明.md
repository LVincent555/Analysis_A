# 板块数据导入说明

## 📋 概述

板块数据导入脚本使用与股票数据相同的健壮设计原则，实现了：
- ✅ **原子性**：整个文件在一个事务中，失败自动回滚
- ✅ **幂等性**：基于状态文件判断是否需要导入，避免重复
- ✅ **回滚机制**：失败后可安全重试，不会留下脏数据

## 🗂️ 数据库结构

### 1. sectors 表（板块主表）
```sql
CREATE TABLE sectors (
    id BIGSERIAL PRIMARY KEY,           -- 自动递增ID
    sector_name VARCHAR(100) NOT NULL,  -- 板块名称（唯一）
    CONSTRAINT uq_sector_name UNIQUE (sector_name)
);
```

### 2. sector_daily_data 表（板块每日数据）
```sql
CREATE TABLE sector_daily_data (
    id BIGSERIAL PRIMARY KEY,
    sector_id BIGINT REFERENCES sectors(id),
    date DATE NOT NULL,
    rank INTEGER NOT NULL,
    -- 83个技术指标字段（与个股相同，但不包含jump和市值）
    total_score DECIMAL(30, 10),
    open_price DECIMAL(30, 10),
    ...
);
```

## 📁 数据文件格式

### 文件命名规范
```
YYYYMMDD_allbk_sma_feature_color.xlsx
```

**示例**：
- `20251105_allbk_sma_feature_color.xlsx`
- `20251106_allbk_sma_feature_color.xlsx`

### Excel文件结构

| 代码 | 名称 | 日期 | 总分 | 开盘 | 最高 | ... |
|------|------|------|------|------|------|-----|
| 工程建设 | none | 2025-11-05 | 10.7 | 27763.88 | 28353.92 | ... |
| 社区团购 | none | 2025-11-05 | 9.7 | 973.59 | 996.61 | ... |

**关键字段**：
- **代码**：板块名称（作为唯一标识）
- **名称**：通常为 "none"
- **日期**：数据日期
- **其他字段**：83个技术指标

## 🚀 使用步骤

### 步骤1：创建数据库表

```bash
# 进入SQL目录
cd stock_analysis_app/sql

# 执行建表脚本
psql -U your_user -d your_database -f sectors.sql
```

或在PostgreSQL客户端中执行：
```sql
\i /path/to/stock_analysis_app/sql/sectors.sql
```

### 步骤2：准备数据文件

将板块Excel文件放入数据目录：
```
stock_analysis_app/data/
├── 20251105_allbk_sma_feature_color.xlsx
├── 20251106_allbk_sma_feature_color.xlsx
└── ...
```

### 步骤3：运行导入脚本

```bash
# 进入脚本目录
cd stock_analysis_app/backend/scripts

# 运行导入
python import_sectors_robust.py
```

## 📊 导入过程示例

```
============================================================
开始板块数据导入任务（健壮版）
============================================================
找到 3 个板块数据文件
📂 正在导入板块数据: 20251105_allbk_sma_feature_color.xlsx (日期: 2025-11-05)
📊 读取到 500 个板块记录
  进度: 100/500 (20.0%)
  进度: 200/500 (40.0%)
  进度: 300/500 (60.0%)
  进度: 400/500 (80.0%)
  进度: 500/500 (100.0%)
✅ 文件导入完成: 20251105_allbk_sma_feature_color.xlsx
   导入: 500 条, 跳过: 0 条, 耗时: 5.2秒
============================================================
✅ 板块数据导入任务完成！
文件统计: 成功=3, 失败=0
数据统计: 导入=1500, 跳过=0
============================================================
```

## 🔄 幂等性验证

### 第一次运行
```bash
$ python import_sectors_robust.py
📂 正在导入板块数据: 20251105_allbk_sma_feature_color.xlsx
✅ 文件导入完成: 导入 500 条
```

### 第二次运行（跳过已导入）
```bash
$ python import_sectors_robust.py
⏭️  跳过文件（已成功导入）: 20251105_allbk_sma_feature_color.xlsx
```

### 状态文件
导入状态存储在 `data/sector_import_state.json`：
```json
{
  "version": "1.0",
  "created_at": "2025-11-07T20:00:00",
  "imports": {
    "20251105": {
      "status": "success",
      "filename": "20251105_allbk_sma_feature_color.xlsx",
      "imported_count": 500,
      "skipped_count": 0,
      "duration": 5.2,
      "file_hash": "abc123...",
      "timestamp": "2025-11-07T20:00:05"
    }
  }
}
```

## 🔧 故障恢复

### 场景1：导入中断（网络/断电）

**症状**：部分数据已写入数据库

**解决**：
```bash
# 直接重新运行，事务回滚保证数据完整性
python import_sectors_robust.py
```

**结果**：失败的文件会自动重试，已成功的文件会跳过

### 场景2：数据文件更新

**症状**：文件内容变化，但文件名相同

**解决**：
```bash
# 删除状态文件中对应日期的记录
# 或者直接删除整个状态文件重新导入
rm data/sector_import_state.json
python import_sectors_robust.py
```

## 📝 与股票导入的区别

| 特性 | 股票导入 | 板块导入 |
|------|----------|----------|
| **主表** | stocks | sectors |
| **数据表** | daily_stock_data | sector_daily_data |
| **唯一标识** | stock_code (6位数字) | sector_name (中文名称) |
| **文件格式** | YYYYMMDD_data_sma_feature_color.xlsx | YYYYMMDD_allbk_sma_feature_color.xlsx |
| **特殊字段** | 包含 jump, 总市值 | 不包含这两个字段 |
| **状态文件** | data_import_state.json | sector_import_state.json |

## ⚠️ 注意事项

1. **数据库连接**
   - 确保 `backend/app/database.py` 配置正确
   - 导入前测试连接：`python -c "from app.database import test_connection; test_connection()"`

2. **文件编码**
   - Excel文件应使用标准格式
   - 避免特殊字符和格式错误

3. **磁盘空间**
   - 500个板块 × 365天 ≈ 18万条记录
   - 预留足够数据库空间

4. **事务大小**
   - 每个文件一个事务
   - 如果文件过大（>1万行），考虑分批处理

## 🔍 查询验证

### 检查板块数量
```sql
SELECT COUNT(*) FROM sectors;
```

### 检查某日数据
```sql
SELECT 
    s.sector_name,
    sd.rank,
    sd.total_score,
    sd.price_change
FROM sector_daily_data sd
JOIN sectors s ON sd.sector_id = s.id
WHERE sd.date = '2025-11-05'
ORDER BY sd.rank
LIMIT 10;
```

### 检查板块历史数据
```sql
SELECT 
    date,
    rank,
    total_score,
    price_change
FROM sector_daily_data
WHERE sector_id = (SELECT id FROM sectors WHERE sector_name = '工程建设')
ORDER BY date DESC
LIMIT 30;
```

## 📞 问题排查

### 问题1：找不到文件
```
错误: 板块数据目录不存在
```
**解决**：检查 `app/config.py` 中的 `DATA_DIR` 配置

### 问题2：数据库连接失败
```
错误: 数据库连接失败
```
**解决**：检查 `database.py` 中的连接参数

### 问题3：唯一索引冲突
```
警告: 跳过重复数据: 工程建设 - 2025-11-05
```
**解决**：正常现象，表示该板块该日期已存在，会自动跳过

## 📚 相关文档

- [数据库设计文档](./数据库设计文档.md)
- [股票数据导入说明](./数据导入说明.md)
- [API开发指南](./API开发指南.md)

---

**版本**：v1.0  
**更新日期**：2025-11-07  
**作者**：Stock Analysis Team
