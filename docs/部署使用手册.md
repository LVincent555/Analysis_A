# ğŸ“˜ éƒ¨ç½²ä½¿ç”¨æ‰‹å†Œ

> **æ™ºèƒ½éƒ¨ç½²è„šæœ¬ - ä¸€é”®éƒ¨ç½²åˆ°UbuntuæœåŠ¡å™¨**

---

## ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆ3æ­¥å®Œæˆï¼‰

### ç¬¬1æ­¥ï¼šä¸Šä¼ é¡¹ç›®åˆ°æœåŠ¡å™¨

```bash
# ä»æœ¬åœ°ä¸Šä¼ ï¼ˆWindows PowerShellæˆ–Linuxç»ˆç«¯ï¼‰
scp -r stock_analysis_app root@60.205.251.109:/root/

# æˆ–ä½¿ç”¨Git
ssh root@60.205.251.109
cd /root
git clone <your-repo-url> stock_analysis_app
```

### ç¬¬2æ­¥ï¼šSSHç™»å½•æœåŠ¡å™¨

```bash
ssh root@60.205.251.109
cd /root/stock_analysis_app
```

### ç¬¬3æ­¥ï¼šè¿è¡Œéƒ¨ç½²è„šæœ¬

```bash
# å¼€å‘æ¨¡å¼ï¼ˆæ¨èå…ˆç”¨è¿™ä¸ªæµ‹è¯•ï¼‰
python3 deploy_smart.py dev

# æˆ–ç”Ÿäº§æ¨¡å¼ï¼ˆéœ€è¦å®‰è£…Nginxï¼‰
python3 deploy_smart.py prod
```

**å°±è¿™ä¹ˆç®€å•ï¼è„šæœ¬ä¼šè‡ªåŠ¨å¤„ç†ä¸€åˆ‡** âœ¨

---

## ğŸ“– è¯¦ç»†è¯´æ˜

### ğŸ¯ ä¸¤ç§éƒ¨ç½²æ¨¡å¼

| ç‰¹æ€§ | å¼€å‘æ¨¡å¼ (`dev`) | ç”Ÿäº§æ¨¡å¼ (`prod`) |
|------|-----------------|------------------|
| **å®‰è£…è¦æ±‚** | Python + Node.js + PostgreSQL | è¿˜éœ€è¦ Nginx |
| **è®¿é—®æ–¹å¼** | http://60.205.251.109:3000 | http://60.205.251.109 |
| **ç«¯å£** | å‰ç«¯3000ï¼Œåç«¯8000 | ç»Ÿä¸€80ç«¯å£ |
| **é€‚ç”¨åœºæ™¯** | æµ‹è¯•ã€å¼€å‘ã€ä¸ªäººä½¿ç”¨ | ç”Ÿäº§ç¯å¢ƒã€å¯¹å¤–æœåŠ¡ |
| **æœåŠ¡ç®¡ç†** | æ‰‹åŠ¨å¯åŠ¨/åœæ­¢ | Systemdè‡ªåŠ¨ç®¡ç† |
| **å¼€æœºè‡ªå¯** | âŒ å¦ | âœ… æ˜¯ |
| **éƒ¨ç½²æ—¶é—´** | âš¡ 5åˆ†é’Ÿ | â±ï¸ 10åˆ†é’Ÿ |

---

## ğŸ”§ æ™ºèƒ½éƒ¨ç½²è„šæœ¬åŠŸèƒ½

`deploy_smart.py` ä¼šè‡ªåŠ¨ï¼š

### âœ… ç¯å¢ƒæ£€æŸ¥
- æ£€æŸ¥Pythonã€Node.jsã€PostgreSQLæ˜¯å¦å®‰è£…
- æ£€æŸ¥ç³»ç»Ÿç‰ˆæœ¬å’Œä¾èµ–

### âœ… æ™ºèƒ½é…ç½®
- è‡ªåŠ¨æ£€æµ‹ `backend/.env` æ˜¯å¦å­˜åœ¨
- å¦‚æœé…ç½®ä¸æ­£ç¡®ï¼Œè‡ªåŠ¨æ›´æ–°ä¸ºä»¥ä¸‹é…ç½®ï¼š
  ```env
  DB_HOST=localhost
  DB_PORT=5432
  DB_NAME=db_20251106_analysis_a
  DB_USER=postgres
  DB_PASSWORD=3.1415926
  ```
- å¦‚æœä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»º

### âœ… ä¾èµ–ç®¡ç†
- è‡ªåŠ¨åˆ›å»ºPythonè™šæ‹Ÿç¯å¢ƒï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
- è‡ªåŠ¨å®‰è£…Pythonä¾èµ–
- è‡ªåŠ¨å®‰è£…npmä¾èµ–

### âœ… æ•°æ®åº“æ™ºèƒ½æ£€æµ‹
- è‡ªåŠ¨æµ‹è¯•æ•°æ®åº“è¿æ¥
- æ£€æµ‹æ˜¯å¦å·²æœ‰æ•°æ®ï¼ˆæ£€æŸ¥ `data_import_state.json`ï¼‰
- å¦‚æœæ•°æ®åº“ä¸ºç©ºï¼Œè¯¢é—®æ˜¯å¦å¯¼å…¥æ•°æ®
- **é²æ£’æ€§**ï¼šå¦‚æœå·²æœ‰æ•°æ®ï¼Œè·³è¿‡å¯¼å…¥

### âœ… å‰ç«¯å¤„ç†
- å¼€å‘æ¨¡å¼ï¼šç¡®ä¿npmä¾èµ–å·²å®‰è£…
- ç”Ÿäº§æ¨¡å¼ï¼šè‡ªåŠ¨æ„å»ºå‰ç«¯ï¼ˆæˆ–è¯¢é—®æ˜¯å¦é‡æ–°æ„å»ºï¼‰

### âœ… æœåŠ¡é…ç½®
- å¼€å‘æ¨¡å¼ï¼šç”Ÿæˆå¯åŠ¨è„šæœ¬
- ç”Ÿäº§æ¨¡å¼ï¼šç”ŸæˆSystemdå’ŒNginxé…ç½®æ–‡ä»¶

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šå¼€å‘æ¨¡å¼éƒ¨ç½²

```bash
# 1. è¿è¡Œéƒ¨ç½²è„šæœ¬
python3 deploy_smart.py dev

# è¾“å‡ºç¤ºä¾‹ï¼š
# ======================================================================
# ğŸš€ æ™ºèƒ½éƒ¨ç½²è„šæœ¬ - DEVæ¨¡å¼
# ======================================================================
# 
# ğŸ“‹ æ£€æŸ¥ç³»ç»Ÿä¾èµ–...
#   âœ“ Python 3.12.3
#   âœ“ Node.js v24.3.0
#   âœ“ PostgreSQL å®¢æˆ·ç«¯å·²å®‰è£…
#
# ğŸ”§ é…ç½®åç«¯...
#   âœ“ .env æ–‡ä»¶å·²å­˜åœ¨
#   âœ“ .envé…ç½®æ­£ç¡®
#   âœ“ è™šæ‹Ÿç¯å¢ƒå·²å­˜åœ¨
#   ğŸ“¦ å®‰è£…Pythonä¾èµ–...
#   âœ“ Pythonä¾èµ–å·²å®‰è£…
#
# ğŸ—„ï¸  æ£€æŸ¥æ•°æ®åº“...
#   âœ“ æ•°æ®åº“è¿æ¥æˆåŠŸ
#   âœ“ æ•°æ®å·²å¯¼å…¥ (4 ä¸ªæ—¥æœŸ)
#     æœ€æ–°æ—¥æœŸ: 20251106
#
# ğŸ¨ é…ç½®å‰ç«¯...
#   âœ“ npmä¾èµ–å·²å­˜åœ¨
#
# ======================================================================
# ğŸ¯ å¼€å‘æ¨¡å¼éƒ¨ç½²
# ======================================================================
#
#   âœ“ åˆ›å»º start_backend.sh
#   âœ“ åˆ›å»º start_frontend.sh
#
# âœ… å¼€å‘æ¨¡å¼éƒ¨ç½²å®Œæˆï¼
#
# ğŸš€ å¯åŠ¨æœåŠ¡ï¼š
#
#   æ–¹å¼1ï¼šå‰åå°åˆ†åˆ«å¯åŠ¨ï¼ˆæ¨èç”¨screen/tmuxï¼‰
#     ./start_backend.sh    # åç«¯
#     ./start_frontend.sh   # å‰ç«¯
#
#   æ–¹å¼2ï¼šåå°è¿è¡Œ
#     nohup ./start_backend.sh > backend.log 2>&1 &
#     nohup ./start_frontend.sh > frontend.log 2>&1 &
#
# ğŸŒ è®¿é—®åœ°å€ï¼š
#   å‰ç«¯ï¼šhttp://60.205.251.109:3000
#   APIï¼š http://60.205.251.109:8000/docs

# 2. å¯åŠ¨æœåŠ¡ï¼ˆä½¿ç”¨screenä¿æŒåå°è¿è¡Œï¼‰
screen -S backend
./start_backend.sh
# æŒ‰ Ctrl+A+D åˆ†ç¦»ä¼šè¯

screen -S frontend
./start_frontend.sh
# æŒ‰ Ctrl+A+D åˆ†ç¦»ä¼šè¯

# 3. æŸ¥çœ‹è¿è¡Œä¸­çš„screenä¼šè¯
screen -ls

# 4. é‡æ–°è¿æ¥
screen -r backend  # è¿æ¥åˆ°åç«¯
screen -r frontend # è¿æ¥åˆ°å‰ç«¯
```

### ç¤ºä¾‹2ï¼šç”Ÿäº§æ¨¡å¼éƒ¨ç½²

```bash
# 1. å…ˆå®‰è£…Nginx
sudo apt update
sudo apt install nginx

# 2. è¿è¡Œéƒ¨ç½²è„šæœ¬
python3 deploy_smart.py prod

# è„šæœ¬ä¼šç”Ÿæˆé…ç½®æ–‡ä»¶å¹¶æ˜¾ç¤ºå®‰è£…å‘½ä»¤

# 3. æŒ‰ç…§æç¤ºå®‰è£…SystemdæœåŠ¡
sudo cp deploy/stock-backend.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl start stock-backend
sudo systemctl enable stock-backend

# 4. æŒ‰ç…§æç¤ºå®‰è£…Nginxé…ç½®
sudo cp deploy/nginx-stock-analysis.conf /etc/nginx/sites-available/stock-analysis
sudo ln -s /etc/nginx/sites-available/stock-analysis /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx

# 5. è®¿é—®
# http://60.205.251.109
```

---

## ğŸ§¹ æ¸…ç†Gitå†å²

å¦‚æœä½ çš„Gitä»“åº“ä¸­åŒ…å«äº†node_modulesæˆ–venvï¼š

```bash
# 1. è¿è¡Œæ¸…ç†è„šæœ¬
python3 clean_git_history.py

# è„šæœ¬ä¼šï¼š
# - æ›´æ–° .gitignore
# - ä»Gitç¼“å­˜ä¸­åˆ é™¤node_moduleså’Œvenv
# - ï¼ˆå¯é€‰ï¼‰ä»Gitå†å²ä¸­å½»åº•åˆ é™¤

# 2. æ¨é€åˆ°è¿œç¨‹ï¼ˆå¦‚æœéœ€è¦ï¼‰
git push origin main --force
```

---

## ğŸ› ï¸ å¸¸ç”¨ç®¡ç†å‘½ä»¤

### å¼€å‘æ¨¡å¼

```bash
# å¯åŠ¨æœåŠ¡
./start_backend.sh &
./start_frontend.sh &

# æŸ¥çœ‹è¿›ç¨‹
ps aux | grep uvicorn
ps aux | grep node

# åœæ­¢æœåŠ¡
pkill -f uvicorn
pkill -f "node.*start"

# æŸ¥çœ‹æ—¥å¿—
tail -f backend.log
tail -f frontend.log
```

### ç”Ÿäº§æ¨¡å¼

```bash
# æœåŠ¡ç®¡ç†
sudo systemctl start stock-backend     # å¯åŠ¨
sudo systemctl stop stock-backend      # åœæ­¢
sudo systemctl restart stock-backend   # é‡å¯
sudo systemctl status stock-backend    # çŠ¶æ€

# æŸ¥çœ‹æ—¥å¿—
journalctl -u stock-backend -f         # å®æ—¶æ—¥å¿—
journalctl -u stock-backend -n 100     # æœ€è¿‘100è¡Œ

# Nginxç®¡ç†
sudo systemctl restart nginx
sudo nginx -t                           # æµ‹è¯•é…ç½®
```

### æ›´æ–°æ•°æ®

```bash
# ä¸Šä¼ æ–°çš„Excelæ–‡ä»¶åˆ°dataç›®å½•
scp 20251107_data_sma_feature_color.xlsx root@60.205.251.109:/root/stock_analysis_app/data/

# å¯¼å…¥æ•°æ®
cd /root/stock_analysis_app/backend
source venv/bin/activate
python scripts/import_data_robust.py
```

### æ•°æ®åº“æ“ä½œ

```bash
# è¿æ¥æ•°æ®åº“
psql -U postgres -d db_20251106_analysis_a

# æŸ¥çœ‹æ•°æ®
psql -U postgres -d db_20251106_analysis_a -c "SELECT COUNT(*) FROM daily_stock_data;"

# å¤‡ä»½æ•°æ®åº“
pg_dump -U postgres -d db_20251106_analysis_a > backup_$(date +%Y%m%d).sql

# æ¢å¤æ•°æ®åº“
psql -U postgres -d db_20251106_analysis_a < backup_20251107.sql
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥PostgreSQLæ˜¯å¦è¿è¡Œ
sudo systemctl status postgresql

# æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨
psql -U postgres -l | grep db_20251106_analysis_a

# æµ‹è¯•è¿æ¥
psql -U postgres -d db_20251106_analysis_a -c "SELECT 1;"

# æ£€æŸ¥.envé…ç½®
cat backend/.env
```

### é—®é¢˜2ï¼šç«¯å£è¢«å ç”¨

```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
sudo netstat -tlnp | grep 3000
sudo netstat -tlnp | grep 8000

# æ€æ­»è¿›ç¨‹
sudo kill -9 <PID>
```

### é—®é¢˜3ï¼šå‰ç«¯æ— æ³•è®¿é—®åç«¯

```bash
# æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ
curl http://localhost:8000/api/dates

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status
sudo ufw allow 3000/tcp
sudo ufw allow 8000/tcp
sudo ufw allow 80/tcp
```

### é—®é¢˜4ï¼šNginx 502é”™è¯¯

```bash
# æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ
sudo systemctl status stock-backend

# æ£€æŸ¥Nginxé…ç½®
sudo nginx -t

# æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log
```

---

## ğŸ“Š æœåŠ¡å™¨èµ„æºç›‘æ§

```bash
# æŸ¥çœ‹CPUå’Œå†…å­˜
htop

# æŸ¥çœ‹è¿›ç¨‹èµ„æº
ps aux --sort=-%mem | head -n 10

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æŸ¥çœ‹ç‰¹å®šè¿›ç¨‹
ps aux | grep uvicorn
ps aux | grep node
```

---

## ğŸ”’ å®‰å…¨å»ºè®®

### 1. ä¿®æ”¹SSHç«¯å£ï¼ˆå¯é€‰ï¼‰
```bash
sudo nano /etc/ssh/sshd_config
# ä¿®æ”¹ Port 22 ä¸ºå…¶ä»–ç«¯å£
sudo systemctl restart sshd
```

### 2. é…ç½®é˜²ç«å¢™
```bash
sudo ufw enable
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw allow 3000/tcp  # å‰ç«¯ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
sudo ufw allow 8000/tcp  # åç«¯ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
```

### 3. ä½¿ç”¨HTTPSï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
```bash
# å®‰è£…Certbot
sudo apt install certbot python3-certbot-nginx

# è·å–è¯ä¹¦ï¼ˆéœ€è¦åŸŸåï¼‰
sudo certbot --nginx -d your-domain.com
```

---

## ğŸ“ å¿«é€Ÿå‚è€ƒ

### é…ç½®ä¿¡æ¯
- **æ•°æ®åº“å**ï¼š`db_20251106_analysis_a`
- **æ•°æ®åº“ç”¨æˆ·**ï¼š`postgres`
- **æœåŠ¡å™¨IP**ï¼š`60.205.251.109`
- **å‰ç«¯ç«¯å£**ï¼š3000ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
- **åç«¯ç«¯å£**ï¼š8000
- **ç»Ÿä¸€ç«¯å£**ï¼š80ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰

### é‡è¦æ–‡ä»¶
- `backend/.env` - æ•°æ®åº“é…ç½®
- `data/data_import_state.json` - æ•°æ®å¯¼å…¥çŠ¶æ€
- `deploy/stock-backend.service` - SystemdæœåŠ¡é…ç½®
- `deploy/nginx-stock-analysis.conf` - Nginxé…ç½®

### å¸¸ç”¨å‘½ä»¤
```bash
# éƒ¨ç½²
python3 deploy_smart.py dev    # å¼€å‘æ¨¡å¼
python3 deploy_smart.py prod   # ç”Ÿäº§æ¨¡å¼

# å¯åŠ¨ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
./start_backend.sh &
./start_frontend.sh &

# ç®¡ç†ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰
sudo systemctl restart stock-backend
sudo systemctl restart nginx

# æ—¥å¿—
journalctl -u stock-backend -f
tail -f /var/log/nginx/error.log

# æ›´æ–°æ•°æ®
cd backend && source venv/bin/activate
python scripts/import_data_robust.py
```

---

## ğŸ‰ å®Œæˆï¼

ç°åœ¨ä½ çš„è‚¡ç¥¨åˆ†æç³»ç»Ÿå·²ç»éƒ¨ç½²å¥½äº†ï¼

**è®¿é—®åœ°å€ï¼š**
- å¼€å‘æ¨¡å¼ï¼šhttp://60.205.251.109:3000
- ç”Ÿäº§æ¨¡å¼ï¼šhttp://60.205.251.109

**æœ‰é—®é¢˜ï¼Ÿ** æŸ¥çœ‹ä¸Šé¢çš„æ•…éšœæ’æŸ¥éƒ¨åˆ†æˆ–æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ã€‚
