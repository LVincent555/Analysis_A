# 📅 历史日期查看功能说明

## 功能概述

系统现已支持查看任意历史日期的股票分析数据。用户可以通过全局日期选择器选择任意历史日期，所有分析模块都会相应显示该日期的数据。

## 主要特性

### 1. 全局日期选择器
- **位置**：应用顶部Header右侧
- **功能**：下拉选择任意可用的历史日期
- **默认值**：系统自动选择最新日期
- **标识**：最新日期会标注"(最新)"

### 2. 支持的模块

所有分析模块都完全支持历史日期查看：

#### ✅ 最新热点分析（HotSpots）
- 查看指定日期往前N天的热点股票
- 行业分布统计基于选定日期
- 支持不同板块和TopN参数

#### ✅ 行业趋势分析（IndustryTrend）
- 显示从选定日期往前的行业趋势
- 前N名行业统计基于选定日期
- 趋势图表展示历史变化

#### ✅ 排名跳变分析（RankJump）
- 分析选定日期与前一天的排名变化
- 跳变阈值和σ筛选在历史日期有效
- 支持不同板块筛选

#### ✅ 稳步上升分析（SteadyRise）
- 从选定日期往前推N天
- 检查连续排名上升的股票
- 支持自定义周期和提升幅度

#### ✅ 股票查询（StockQuery）
- 查询单只股票在选定日期往前30天的历史
- 排名和技术指标完整展示
- 趋势图基于历史数据

## 技术实现

### 前端改动

#### 1. Header组件 (`App.js`)
```javascript
// 添加全局日期状态
const [selectedDate, setSelectedDate] = useState(null);

// 日期选择器
<select value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)}>
  {availableDates.dates.map((date) => (
    <option key={date} value={date}>
      {formatDate(date)}{date === availableDates.latest_date && ' (最新)'}
    </option>
  ))}
</select>
```

#### 2. API服务层
所有API调用方法都添加了可选的`date`参数：
- `analyzePeriod(period, boardType, topN, date)`
- `analyzeRankJump(threshold, boardType, date)`
- `analyzeSteadyRise(period, boardType, minImprovement, date)`
- `getTop1000IndustryStats(limit, date)`
- `getIndustryTrend(date)`
- `queryStock(stockCode, date)`

#### 3. 模块组件
所有模块组件都接收`selectedDate` prop并传递给API调用：
```javascript
// 示例：HotSpotsModule
export default function HotSpotsModule({ boardType, selectedPeriod, topN, selectedDate }) {
  useEffect(() => {
    // API调用时传入selectedDate
    const url = `${API_BASE_URL}/api/analyze/${period}?date=${selectedDate}`;
  }, [selectedDate, ...]);
}
```

### 后端改动

#### 1. API路由层
所有路由添加可选的`date`参数：
```python
@router.get("/analyze/{period}")
async def analyze_period(
    period: int, 
    board_type: str = 'main', 
    top_n: int = 100, 
    date: str = None  # 新增参数
):
    return analysis_service.analyze_period(
        period, 
        max_count=top_n, 
        board_type=board_type, 
        target_date=date  # 传递给service层
    )
```

#### 2. Service服务层
所有服务方法添加`target_date`参数，修改查询逻辑：

**示例：analyze_period**
```python
def analyze_period(
    self,
    period: int = 3,
    max_count: int = 100,
    board_type: str = 'main',
    target_date: Optional[str] = None  # 新增参数
) -> AnalysisResult:
    # 如果指定target_date，从该日期往前推period天
    if target_date:
        target_date_obj = datetime.strptime(target_date, '%Y%m%d').date()
        dates = db.query(DailyStockData.date)\
            .distinct()\
            .filter(DailyStockData.date <= target_date_obj)\
            .order_by(desc(DailyStockData.date))\
            .limit(period)\
            .all()
    else:
        # 不指定则使用最新日期
        dates = db.query(DailyStockData.date)\
            .distinct()\
            .order_by(desc(DailyStockData.date))\
            .limit(period)\
            .all()
```

#### 3. 修改的服务文件
- ✅ `analysis_service_db.py` - analyze_period()
- ✅ `stock_service_db.py` - search_stock()
- ✅ `rank_jump_service_db.py` - analyze_rank_jump()
- ✅ `steady_rise_service_db.py` - analyze_steady_rise()
- ✅ `industry.py` (路由) - get_industry_trend(), get_top1000_industry()

## 使用说明

### 用户操作流程
1. 打开应用
2. 在Header右侧找到"数据日期"选择器
3. 点击下拉框，选择想要查看的历史日期
4. 系统自动刷新所有模块，显示选定日期的数据

### 开发者本地测试
1. 确保数据库中有多个日期的历史数据
2. 启动后端服务：`cd backend && uvicorn app.main:app --reload`
3. 启动前端服务：`cd frontend && npm start`
4. 访问 http://localhost:3000
5. 测试日期切换功能

### 部署注意事项
1. 前端需要重新编译：`npm run build`
2. 后端无需额外配置，向后兼容
3. API不传`date`参数时默认使用最新日期
4. 确保数据库连接配置正确（参考`database.py.example`）

## API参数格式

### 日期格式
- **格式**：YYYYMMDD
- **示例**：20251106
- **说明**：8位数字字符串，无分隔符

### API调用示例

**获取指定日期的2天热点**
```
GET /api/analyze/2?board_type=main&top_n=100&date=20251105
```

**查询股票在指定日期的历史**
```
GET /api/stock/600519?date=20251105
```

**分析指定日期的排名跳变**
```
GET /api/rank-jump?jump_threshold=2000&board_type=main&date=20251105
```

## 兼容性

### 向后兼容
- 所有API不传`date`参数时，默认使用最新日期
- 旧版前端调用仍然正常工作
- 数据库查询逻辑保持一致

### 前端兼容
- 支持所有现代浏览器
- 移动端自适应
- 日期选择器响应式设计

## 版本信息

- **功能版本**：v0.2.4-dev
- **实现日期**：2025-11-07
- **影响模块**：前端全部模块 + 后端全部API

## 后续优化建议

1. **性能优化**
   - 添加历史数据查询缓存
   - 优化大量日期切换时的性能

2. **功能增强**
   - 添加日期范围选择
   - 支持日期对比功能
   - 添加快速日期跳转（今天、昨天、上周等）

3. **用户体验**
   - 添加日期切换动画
   - 添加加载状态提示
   - 支持键盘快捷键切换日期

---

**📌 重要提示**：本功能完全兼容现有代码，不会影响原有功能的正常使用。
