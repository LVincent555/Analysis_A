# v0.2.7 快速部署指南

**版本**: v0.2.7  
**日期**: 2025-11-11

---

## ✅ 已完成修改

### 后端修改
1. ✅ `signal_calculator.py` - 三种信号模式（instant/v1/v2）
2. ✅ `industry_detail_service.py` - 动态排序逻辑
3. ✅ `industry_detail.py` - 添加hot_list_version参数
4. ✅ `stock.py` - 添加hot_list_version参数
5. ✅ `rank_jump.py` - 添加hot_list_version参数
6. ✅ `analysis.py` - 支持2000/3000，更新验证逻辑

### 前端修改
1. ✅ `package.json` - 版本号更新为0.2.7
2. ✅ `SignalConfigContext.js` - 添加hotListVersion配置
3. ✅ `SignalConfigPanel.js` - 三选一模式选择
4. ✅ `IndustryDetailPage.js` - 修复bug，添加version参数
5. ✅ `IndustryDetailDialog.js` - 添加version参数
6. ✅ `StockQueryModule.js` - 添加version参数
7. ✅ `App.js` - 添加2000/3000选项

---

## 🚀 部署步骤

### 1. 重启后端
```bash
cd backend
# 停止旧进程（Ctrl+C）
python main.py
```

**验证**: 看到启动日志，无报错

### 2. 编译前端
```bash
cd frontend
npm run build
```

**验证**: 
- 编译成功
- build目录已生成
- 无错误信息

### 3. 清理用户缓存（重要！）
**用户操作**:
1. 打开浏览器开发者工具（F12）
2. Console标签输入：`localStorage.clear()`
3. 强制刷新：`Ctrl+F5`

---

## 🧪 功能测试

### 测试1: 三种模式切换
1. 打开配置面板
2. 选择"最新热点TOP信号（原版）"
3. 保存配置
4. 查看板块弹窗，确认按**信号数量**排序
5. 切换到"最新热点TOP信号（新版）"
6. 确认按**信号强度**排序

**预期**:
- 原版：3个信号 > 2个信号 > 1个信号
- 新版：40%强度 > 38%强度 > 37%强度

### 测试2: 2000/3000选项
1. 点击"最新热点"
2. 左侧"分析股票数"看到8个选项
3. 点击"前2000个"
4. 确认API调用`top_n=2000`
5. 后端日志无"⚠️ 警告"

**预期**:
- 按钮显示：前100个、前200个...前2000个、前3000个
- API正常返回数据
- 后端日志：`top_n=2000`（不是100）

### 测试3: 弹窗排序
1. 点击任意板块
2. 查看TOP 10成分股
3. 确认排序符合当前模式

**原版v1预期**:
```
#1 某股票  3个信号  XX%
#2 某股票  2个信号  XX%
#3 某股票  1个信号  XX%
```

**新版v2预期**:
```
#1 某股票  X个信号  40%
#2 某股票  X个信号  38%
#3 某股票  X个信号  37%
```

---

## 🐛 常见问题

### Q1: 切换模式后排序没变化？
**A**: 清理localStorage缓存
```javascript
localStorage.clear()
// 然后 Ctrl+F5
```

### Q2: 选择2000后仍显示100条数据？
**A**: 
1. 检查后端日志是否有"⚠️ 警告"
2. 确认`analysis.py`第55行已包含2000
3. 重启后端服务

### Q3: 后端日志显示"top_n=100"而不是2000？
**A**: 参数验证失败，检查：
```python
# analysis.py 第55行
if top_n not in [100, 200, 400, 600, 800, 1000, 2000, 3000]:
```

### Q4: 弹窗排序仍按强度而非数量？
**A**: 
1. 确认选择的是"原版"模式
2. 清理localStorage
3. 检查后端日志：`version=v1, 优先级=数量>强度`

---

## 📊 后端日志示例

### 正常日志（2000选项）
```
📨 收到请求: GET /api/analyze/14
📝 查询参数: {'top_n': '2000', ...}
🔍 Router层收到参数:
   top_n=2000 (type: int)
🎯 API调用参数: period=14, top_n=2000, ...
```

### 正常日志（原版模式）
```
📊 信号配置: mode=frequent, version=v1
🔄 按信号排序，version=v1, 优先级=数量>强度
```

### 异常日志（需要修复）
```
⚠️  警告: top_n=2000 不在允许范围内，使用默认值100
```
→ 说明`analysis.py`未更新

---

## 🎯 核心改动点

### 1. 信号模式选择
```javascript
// SignalConfigPanel.js
<select>
  <option value="instant">总分TOP信号</option>
  <option value="frequent_v1">最新热点TOP信号（原版）</option>
  <option value="frequent_v2">最新热点TOP信号（新版）</option>
</select>
```

### 2. 动态排序
```python
# industry_detail_service.py
if signal_thresholds.hot_list_version == "v1":
    # 原版：数量 > 强度
    return sorted(stocks, key=lambda x: (-x.signal_count, -x.signal_strength, x.rank))
else:
    # 新版：强度 > 数量
    return sorted(stocks, key=lambda x: (-x.signal_strength, -x.signal_count, x.rank))
```

### 3. 2000/3000支持
```python
# analysis.py
if top_n not in [100, 200, 400, 600, 800, 1000, 2000, 3000]:
    top_n = 100
```

```javascript
// App.js
{[100, 200, 400, 600, 800, 1000, 2000, 3000].map((n) => (
  <button>前{n}个</button>
))}
```

---

## 📝 检查清单

部署前：
- [ ] 后端所有文件已保存
- [ ] 前端所有文件已保存
- [ ] package.json版本号为0.2.7

部署后：
- [ ] 后端启动无报错
- [ ] 前端编译成功
- [ ] 用户清理localStorage
- [ ] 三种模式切换正常
- [ ] 2000/3000选项可用
- [ ] 排序逻辑正确

---

**维护人员**: AI Assistant  
**发布日期**: 2025-11-11 14:42
