# v0.2.4 部署说明

> 📖 **必读：** 请先阅读 [服务器部署指南.md](./服务器部署指南.md) 了解基础部署流程

## 版本信息
- **版本号：** v0.2.4
- **发布日期：** 2025-11-08
- **主要更新：** 板块数据全量缓存、智能去重系统

---

## 🚀 快速部署

### 前置条件（已完成✅）
- ✅ 服务器数据库表已创建（包括 `daily_sector_data`）
- ✅ data 文件夹已上传到服务器
- ✅ 板块Excel文件已上传（`*_allbk_sma_feature_color.xlsx`）

### 本地操作

```bash
# 1. 编译前端
cd frontend
npm run build

# 2. 提交代码（Windows）
cd ..
deploy\git_commit_v0.2.4.bat

# Linux/Mac:
# bash deploy/git_commit_v0.2.4.sh
```

### 服务器操作

```bash
# 1. SSH连接
ssh root@60.205.251.109

# 2. 进入项目目录
cd /root/stock_analysis_app

# 3. 拉取代码
git pull origin main

# 4. 一键部署
bash deploy_server.sh

# 5. 验证部署
curl http://localhost:8000/health
```

---

## ✅ 部署验证

### 查看启动日志
```bash
tail -f logs/backend.log
```

### 关键日志检查
应该看到以下内容：

```
✅ 数据库连接正常
✅ 股票总数: 5435
✅ 板块数据记录: 1430          👈 新增
✅ 板块数据日期数: 3 天         👈 新增
✅ 板块ID序列完整: 1 到 1430   👈 新增

🔄 检查并导入新数据...
📊 检查股票数据...
📊 检查板块数据...              👈 新增
✅ 所有数据已是最新

✅ 全量内存缓存已就绪
   📊 股票数据记录: 27,145
   📊 板块数据记录: 1,430      👈 新增
   📊 板块交易日数: 3           👈 新增
   ⚡ 查询性能: < 1ms

✅ 应用启动完成！
```

### API测试
```bash
# 健康检查
curl http://localhost:8000/health

# 板块分析测试
curl "http://localhost:8000/api/sectors/analysis?date=20251107"

# 热点股票测试
curl "http://localhost:8000/api/analysis/hot-spots?date=20251107&max_count=10"
```

---

## 🆕 v0.2.4 新特性

### 1. 板块数据全量缓存
- ✅ 启动时自动加载所有板块数据到内存
- ✅ 查询性能 <1ms
- ✅ 与股票数据同等待遇

### 2. 智能去重系统
- ✅ 基于全局离群值检测算法
- ✅ 自动处理Excel中的重复数据
- ✅ 不修改原始Excel文件
- ✅ 详细的去重日志和追溯

### 3. 启动检查增强
- ✅ 同时检查股票和板块数据文件
- ✅ 自动导入新的板块Excel
- ✅ 完整的数据一致性验证

---

## ⚠️ v0.2.4 特别注意

### 1. 数据库表检查
确保服务器已创建 `daily_sector_data` 表：
```sql
psql -d db_20251106_analysis_a -c "\d daily_sector_data"
```

### 2. 板块数据文件检查
确保 data 目录包含板块Excel：
```bash
ls -lh data/*allbk*.xlsx
```

应该看到：
```
20251105_allbk_sma_feature_color.xlsx
20251106_allbk_sma_feature_color.xlsx
20251107_allbk_sma_feature_color.xlsx
```

### 3. 内存占用
板块缓存增加约 50MB 内存占用，建议服务器内存 ≥ 1GB

---

## 🐛 常见问题

### Q1: 启动日志没有显示板块数据？
**原因：** 可能是板块Excel文件缺失或数据库表未创建

**解决：**
```bash
# 检查文件
ls data/*allbk*.xlsx

# 检查数据库表
psql -d db_20251106_analysis_a -c "SELECT COUNT(*) FROM daily_sector_data;"
```

### Q2: 板块数据记录为0？
**原因：** 板块数据未导入到数据库

**解决：**
```bash
# 手动导入板块数据
cd backend/scripts
python import_sectors_robust.py
```

### Q3: 智能去重没有工作？
**原因：** Excel文件可能没有重复数据

**检查：**
```bash
# 查看去重日志
cat data/data_import_state.json | grep dedup_info
```

---

## 📊 数据统计

### 启动后内存占用
```
【股票】
- 股票数量: 5,435
- 数据记录: 27,145
- 交易日数: 5

【板块】
- 板块数据: 1,430 条
- 交易日数: 3

【性能】
- 查询: <1ms
- 内存: +50MB
```

---

## 🔄 回滚方案

如果遇到问题，快速回滚到 v0.2.3：

```bash
# 服务器上执行
cd /root/stock_analysis_app
git checkout v0.2.3
bash deploy_server.sh
```

---

## 📞 更多信息

- **完整检查清单：** [v0.2.4部署检查清单.md](./v0.2.4部署检查清单.md)
- **智能去重详解：** [智能去重技术详解.md](./智能去重技术详解.md)
- **更新日志：** [../CHANGELOG.md](../CHANGELOG.md)

---

**部署完成后请在群里确认！** ✅
