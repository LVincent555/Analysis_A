# å­¤å„¿æ•°æ®æ¸…ç†å·¥å…·ä½¿ç”¨è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

å½“Excelæ–‡ä»¶è¢«åˆ é™¤æˆ–ä¿®æ”¹åï¼Œæ•°æ®åº“ä¸­å¯èƒ½ä»ç„¶ä¿ç•™ç€å¯¹åº”çš„æ•°æ®ã€‚æœ¬å·¥å…·ç”¨äºæ£€æµ‹å¹¶æ¸…ç†è¿™äº›"å­¤å„¿æ•°æ®"ã€‚

## ğŸ”„ å·¥ä½œæµç¨‹

### 1. ä¸»ç¨‹åºè‡ªåŠ¨æ£€æµ‹ï¼ˆupdate_daily_data.pyï¼‰

æ¯æ¬¡è¿è¡Œæ•°æ®å¯¼å…¥æ—¶ï¼Œä¼šè‡ªåŠ¨æ‰«ææ–‡ä»¶å®Œæ•´æ€§ï¼š

```bash
python update_daily_data.py
```

**æ£€æµ‹å†…å®¹ï¼š**
- âœ… æ–‡ä»¶æ˜¯å¦ç¼ºå¤±ï¼ˆå·²å¯¼å…¥ä½†Excelæ–‡ä»¶ä¸å­˜åœ¨ï¼‰
- âœ… æ–‡ä»¶æ˜¯å¦å˜æ›´ï¼ˆæ–‡ä»¶hashä¸å¯¼å…¥æ—¶ä¸ä¸€è‡´ï¼‰

**æ ‡è®°ä¸ºwarningçš„æƒ…å†µï¼š**
- `file_missing`: Excelæ–‡ä»¶å·²åˆ é™¤ï¼Œä½†æ•°æ®åº“ä¸­ä»æœ‰æ•°æ®
- `file_changed`: Excelæ–‡ä»¶å·²è¢«ä¿®æ”¹ï¼Œä¸å¯¼å…¥æ—¶ä¸ä¸€è‡´

### 2. æŸ¥çœ‹è­¦å‘Šæ•°æ®

æ‰«æå¹¶æ˜¾ç¤ºæ‰€æœ‰warningçŠ¶æ€çš„æ•°æ®ï¼š

```bash
python clean_orphan_data.py --scan
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
âš ï¸  å‘ç° 2 ä¸ªè­¦å‘ŠçŠ¶æ€çš„ STOCK æ•°æ®ï¼š
================================================================================

ğŸ“… æ—¥æœŸ: 20251104
   æ–‡ä»¶: 20251104_data_sma_feature_color.xlsx
   é—®é¢˜: file_missing
   æ£€æµ‹æ—¶é—´: 2025-11-07 23:00:00
   å¯¼å…¥è®°å½•æ•°: 5421
   å»ºè®®æ“ä½œ: delete_db_data
   âš ï¸  Excelæ–‡ä»¶å·²ç¼ºå¤±ï¼Œæ•°æ®åº“ä¸­ä»æœ‰æ•°æ®

ğŸ“… æ—¥æœŸ: 20251105
   æ–‡ä»¶: 20251105_data_sma_feature_color.xlsx
   é—®é¢˜: file_changed
   æ£€æµ‹æ—¶é—´: 2025-11-07 23:00:00
   å¯¼å…¥è®°å½•æ•°: 5398
   å»ºè®®æ“ä½œ: reimport_or_delete
   âš ï¸  Excelæ–‡ä»¶å·²å˜æ›´ï¼Œä¸å¯¼å…¥æ—¶ä¸ä¸€è‡´
   åŸå§‹Hash: ghi789abcdef1234...
   å½“å‰Hash: xyz999fedcba4321...
```

### 3. é¢„æ¼”æ¸…ç†ï¼ˆæ¨èå…ˆé¢„æ¼”ï¼‰

åœ¨ä¸çœŸæ­£åˆ é™¤çš„æƒ…å†µä¸‹ï¼ŒæŸ¥çœ‹å°†è¦åˆ é™¤çš„æ•°æ®ï¼š

```bash
# é¢„æ¼”æ‰€æœ‰è­¦å‘Šæ•°æ®çš„æ¸…ç†
python clean_orphan_data.py --dry-run

# åªé¢„æ¼”è‚¡ç¥¨æ•°æ®
python clean_orphan_data.py --dry-run --type stock

# åªé¢„æ¼”æ¿å—æ•°æ®
python clean_orphan_data.py --dry-run --type sector
```

### 4. æ‰§è¡Œæ¸…ç†ï¼ˆç¡¬åˆ é™¤ï¼‰

**âš ï¸ è­¦å‘Šï¼šè¿™å°†æ°¸ä¹…åˆ é™¤æ•°æ®åº“ä¸­çš„æ•°æ®ï¼**

```bash
# æ¸…ç†æ‰€æœ‰è­¦å‘Šæ•°æ®
python clean_orphan_data.py --clean

# åªæ¸…ç†è‚¡ç¥¨æ•°æ®
python clean_orphan_data.py --clean --type stock

# åªæ¸…ç†æ¿å—æ•°æ®
python clean_orphan_data.py --clean --type sector

# æ¸…ç†æŒ‡å®šæ—¥æœŸçš„æ•°æ®
python clean_orphan_data.py --clean --dates 20251104,20251105
```

**æ‰§è¡Œæ—¶ä¼šè¦æ±‚ç¡®è®¤ï¼š**
```
âš ï¸  è­¦å‘Šï¼šå³å°†åˆ é™¤æ•°æ®åº“æ•°æ®ï¼
ç¡®è®¤ç»§ç»­ï¼Ÿ(yes/no): yes
```

## ğŸ“Š çŠ¶æ€è¯´æ˜

### JSONçŠ¶æ€æ–‡ä»¶ä¸­çš„çŠ¶æ€

**data_import_state.json** (è‚¡ç¥¨æ•°æ®)  
**sector_import_state.json** (æ¿å—æ•°æ®)

```json
{
  "imports": {
    "20251104": {
      "filename": "20251104_data_sma_feature_color.xlsx",
      "status": "warning",  // âš ï¸ è­¦å‘ŠçŠ¶æ€
      "warning_info": {
        "detected_at": "2025-11-07 23:00:00",
        "warning_type": "file_missing",     // æˆ– "file_changed"
        "original_hash": "abc123...",
        "current_hash": null,               // file_missingæ—¶ä¸ºnull
        "suggest_action": "delete_db_data"
      }
    },
    "20251105": {
      "filename": "20251105_data_sma_feature_color.xlsx",
      "status": "deleted",  // ğŸ—‘ï¸ å·²åˆ é™¤çŠ¶æ€
      "deletion_info": {
        "deleted_at": "2025-11-07 23:15:00",
        "deleted_by": "clean_script",
        "delete_reason": "orphan_cleanup_file_missing",
        "original_imported_count": 5421
      }
    }
  }
}
```

### çŠ¶æ€æµè½¬

```
success â†’ warning (æ–‡ä»¶ç¼ºå¤±/å˜æ›´) â†’ deleted (æ¸…ç†å)
  â†‘          â†“
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ (clear_warningæ¢å¤)
```

## ğŸ¯ å…¸å‹ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šå‘ç°æ•°æ®è´¨é‡é—®é¢˜ï¼Œåˆ é™¤Excelæ–‡ä»¶

1. åˆ é™¤æœ‰é—®é¢˜çš„Excelæ–‡ä»¶ï¼ˆå¦‚ 20251104_data_sma_feature_color.xlsxï¼‰
2. è¿è¡Œå¯¼å…¥è„šæœ¬ï¼š`python update_daily_data.py`
   - ä¼šè‡ªåŠ¨æ ‡è®°ä¸º `warning` çŠ¶æ€
3. æŸ¥çœ‹è­¦å‘Šï¼š`python clean_orphan_data.py --scan`
4. é¢„æ¼”æ¸…ç†ï¼š`python clean_orphan_data.py --dry-run`
5. æ‰§è¡Œæ¸…ç†ï¼š`python clean_orphan_data.py --clean`

### åœºæ™¯2ï¼šExcelæ–‡ä»¶è¢«æ„å¤–ä¿®æ”¹

1. è¿è¡Œå¯¼å…¥è„šæœ¬ï¼š`python update_daily_data.py`
   - æ£€æµ‹åˆ°æ–‡ä»¶hashå˜åŒ–ï¼Œæ ‡è®°ä¸º `warning`
2. æŸ¥çœ‹è¯¦æƒ…ï¼š`python clean_orphan_data.py --scan`
3. å†³ç­–ï¼š
   - **é€‰é¡¹A**ï¼šæ¢å¤åŸæ–‡ä»¶ï¼Œè¿è¡Œ `clear_warning`
   - **é€‰é¡¹B**ï¼šåˆ é™¤æ—§æ•°æ®ï¼Œé‡æ–°å¯¼å…¥æ–°æ–‡ä»¶

### åœºæ™¯3ï¼šæ‰¹é‡æ¸…ç†å¤šä¸ªæ—¥æœŸ

```bash
# åªæ¸…ç†ç‰¹å®šå‡ å¤©çš„æ•°æ®
python clean_orphan_data.py --clean --dates 20251104,20251105,20251106
```

## âš™ï¸ æŠ€æœ¯ç»†èŠ‚

### åˆ é™¤ç­–ç•¥

- **ç¡¬åˆ é™¤**ï¼šç›´æ¥ä»æ•°æ®åº“ç‰©ç†åˆ é™¤è®°å½•
- **è‡ªå¢ID**ï¼šå…è®¸å‡ºç°IDç©ºæ´ï¼ˆä¸å½±å“åŠŸèƒ½ï¼Œå› ä¸ºIDä¸å…³è”å…¶ä»–è¡¨ï¼‰
- **æ— ä¾µå…¥**ï¼šä¸ä¿®æ”¹æ•°æ®åº“ç»“æ„ï¼Œåªåˆ é™¤æ•°æ®

### å®‰å…¨æœºåˆ¶

1. âœ… **åªå¤„ç†warningçŠ¶æ€**ï¼šfailedçŠ¶æ€ä¸ä¼šè¢«æ¸…ç†
2. âœ… **äºŒæ¬¡ç¡®è®¤**ï¼šçœŸå®åˆ é™¤å‰éœ€è¦è¾“å…¥ç¡®è®¤
3. âœ… **é¢„æ¼”æ¨¡å¼**ï¼šå¯ä»¥å…ˆæŸ¥çœ‹å°†åˆ é™¤ä»€ä¹ˆ
4. âœ… **å®Œæ•´æ—¥å¿—**ï¼šæ‰€æœ‰æ“ä½œéƒ½æœ‰è¯¦ç»†æ—¥å¿—
5. âœ… **çŠ¶æ€è¿½è¸ª**ï¼šJSONæ–‡ä»¶è®°å½•å®Œæ•´çš„åˆ é™¤å†å²

### æ–‡ä»¶æ£€æµ‹é€»è¾‘

```python
# æ£€æµ‹æ–‡ä»¶æ˜¯å¦ç¼ºå¤±
if not file_path.exists():
    mark_warning("file_missing")

# æ£€æµ‹æ–‡ä»¶æ˜¯å¦å˜æ›´
if current_hash != original_hash:
    mark_warning("file_changed")
```

## ğŸ“ å‘½ä»¤å‚æ•°è¯´æ˜

```bash
python clean_orphan_data.py [OPTIONS]

é€‰é¡¹ï¼š
  --scan            æ‰«æå¹¶æ˜¾ç¤ºè­¦å‘ŠçŠ¶æ€çš„æ•°æ®
  --clean           æ‰§è¡Œæ¸…ç†ï¼ˆçœŸå®åˆ é™¤ï¼‰
  --dry-run         é¢„æ¼”æ¨¡å¼ï¼ˆä¸çœŸæ­£åˆ é™¤ï¼‰
  --type TYPE       æ•°æ®ç±»å‹ï¼šstock / sector / allï¼ˆé»˜è®¤ï¼šallï¼‰
  --dates DATES     æŒ‡å®šæ—¥æœŸï¼Œé€—å·åˆ†éš”ï¼Œå¦‚ï¼š20251104,20251105
  -h, --help        æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
```

## â“ å¸¸è§é—®é¢˜

### Q1: åˆ é™¤åèƒ½æ¢å¤å—ï¼Ÿ
A: **ä¸èƒ½**ã€‚è¿™æ˜¯ç¡¬åˆ é™¤ï¼Œæ•°æ®ä¼šæ°¸ä¹…ä¸¢å¤±ã€‚å»ºè®®å…ˆä½¿ç”¨ `--dry-run` é¢„æ¼”ã€‚

### Q2: failedçŠ¶æ€çš„æ•°æ®ä¼šè¢«åˆ é™¤å—ï¼Ÿ
A: **ä¸ä¼š**ã€‚åªæœ‰warningçŠ¶æ€çš„æ•°æ®æ‰ä¼šè¢«å¤„ç†ã€‚failedçŠ¶æ€è¡¨ç¤ºå¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶è¿˜åœ¨ï¼Œä¸æ˜¯å­¤å„¿æ•°æ®ã€‚

### Q3: åˆ é™¤åIDä¼šé‡æ–°ç¼–å·å—ï¼Ÿ
A: **ä¸ä¼š**ã€‚IDä¼šæœ‰ç©ºæ´ï¼Œä½†ä¸å½±å“åŠŸèƒ½ï¼ˆIDä¸å…³è”å…¶ä»–è¡¨ï¼‰ã€‚

### Q4: å¦‚ä½•åªæŸ¥çœ‹ä¸åˆ é™¤ï¼Ÿ
A: ä½¿ç”¨ `--scan` æˆ– `--dry-run` å‚æ•°ã€‚

### Q5: è¯¯æ ‡è®°ä¸ºwarningæ€ä¹ˆåŠï¼Ÿ
A: å¯ä»¥æ‰‹åŠ¨ç¼–è¾‘JSONæ–‡ä»¶ï¼Œå°†statusæ”¹å›successï¼Œæˆ–ä½¿ç”¨ `clear_warning` æ–¹æ³•ã€‚

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `update_daily_data.py` - ä¸»å¯¼å…¥è„šæœ¬ï¼ˆè‡ªåŠ¨æ‰«ææ–‡ä»¶ï¼‰
- `clean_orphan_data.py` - æ¸…ç†å·¥å…·
- `backend/scripts/import_state_manager.py` - çŠ¶æ€ç®¡ç†å™¨
- `data/data_import_state.json` - è‚¡ç¥¨æ•°æ®çŠ¶æ€
- `data/sector_import_state.json` - æ¿å—æ•°æ®çŠ¶æ€

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶æˆ–è”ç³»å¼€å‘è€…ã€‚
