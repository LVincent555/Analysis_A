# 信号标签档位显示修复说明

## 🔴 问题描述

**严重设计缺陷**: 信号标签显示逻辑不符合用户预期。

### 问题表现

**案例**：东方环宇(603706) 在2025年11月12日
- **最新排名**: 746名
- **错误显示**: "TOP100·2次" ❌
- **正确显示**: "TOP800·6次" ✅

### 用户期望

用户期望信号标签**只显示最新一天排名所在档位的统计**：
- 11月12日排名746 → 属于TOP800档位 → 应显示"TOP800·6次"
- 表示：在过去14天内，该股票有6次进入TOP800

---

## 🔍 问题根源

### 旧逻辑（错误）

**文件**: `backend/app/services/signal_calculator.py` (第253-285行)

**逻辑**：显示所有"有意义"的档位统计

```python
# 遍历所有档位，收集"次数增加"的档位
for tier in [100, 200, 400, 600, 800, 1000, 2000, 3000]:
    count = tier_counts.get(tier, 0)
    if count > prev_count and count >= 2:
        labels.append(f"TOP{tier}·{count}次")  # 添加多个档位
    ...

# 显示最后3个档位（最低的3个）
display_labels = labels[-3:]
label = ', '.join(display_labels)
```

**问题**：
1. 会生成多个档位标签，如：`["TOP100·2次", "TOP800·6次"]`
2. 最终显示可能是 `"TOP100·2次, TOP800·6次"` 或只显示第一个
3. **与用户期望不符**：用户只想看最新排名所在档位

---

## ✅ 修复方案

### 新逻辑（正确）

**文件**: `backend/app/services/signal_calculator.py` (第253-277行)

**逻辑**：只显示最新一天排名所在档位的统计

```python
# 📊 新逻辑：只显示最新一天排名所在档位的统计
# 确定最新排名所属档位
tiers = [100, 200, 400, 600, 800, 1000, 2000, 3000]
current_tier = None
for tier in tiers:
    if rank <= tier:
        current_tier = tier
        break

if not current_tier:
    # 排名超过3000，不显示热点信号
    return None

# 获取该档位的出现次数
hit_count_in_tier = tier_counts.get(current_tier, 0)

# 至少出现2次才显示
if hit_count_in_tier < 2:
    return None

# 生成标签：只显示当前档位
label = f"TOP{current_tier}·{hit_count_in_tier}次"
main_tier = current_tier
```

**优点**：
1. ✅ 符合用户直觉：看到的档位就是当前排名所在档位
2. ✅ 信息准确：显示该档位在14天内的真实出现次数
3. ✅ 简洁明了：只显示一个标签，不会混淆

---

## 📊 修复前后对比

### 案例1：东方环宇(603706) - 2025年11月12日

| 项目 | 修复前 | 修复后 |
|-----|--------|--------|
| **最新排名** | 746名 | 746名 |
| **所属档位** | TOP800 | TOP800 |
| **TOP100出现次数** | 2次 | 2次 |
| **TOP800出现次数** | 6次 | 6次 |
| **显示标签** | "TOP100·2次" ❌ | "TOP800·6次" ✅ |
| **符合预期** | 否 | 是 |

### 案例2：高排名股票 - 假设排名50

| 项目 | 修复前 | 修复后 |
|-----|--------|--------|
| **最新排名** | 50名 | 50名 |
| **所属档位** | TOP100 | TOP100 |
| **TOP100出现次数** | 10次 | 10次 |
| **显示标签** | "TOP100·10次" ✅ | "TOP100·10次" ✅ |
| **影响** | 无变化 | 无变化 |

### 案例3：中等排名股票 - 假设排名350

14天统计：
- TOP100: 1次
- TOP200: 2次
- TOP400: 5次
- TOP600: 7次

| 项目 | 修复前 | 修复后 |
|-----|--------|--------|
| **最新排名** | 350名 | 350名 |
| **所属档位** | TOP400 | TOP400 |
| **显示标签** | "TOP200·2次, TOP400·5次" | "TOP400·5次" ✅ |
| **改进** | 显示多个档位，混淆 | 只显示当前档位，清晰 |

---

## 🧪 验证测试

### 测试用例

#### 1. 基础测试：档位判断

| 排名 | 期望档位 | 期望标签格式 |
|-----|---------|------------|
| 50 | TOP100 | "TOP100·X次" |
| 150 | TOP200 | "TOP200·X次" |
| 350 | TOP400 | "TOP400·X次" |
| 550 | TOP600 | "TOP600·X次" |
| 750 | TOP800 | "TOP800·X次" |
| 950 | TOP1000 | "TOP1000·X次" |
| 1500 | TOP2000 | "TOP2000·X次" |
| 2500 | TOP3000 | "TOP3000·X次" |
| 3500 | 无 | null（不显示） |

#### 2. 次数过滤测试

| 档位出现次数 | 是否显示 | 说明 |
|------------|---------|------|
| 1次 | ❌ | 至少2次才显示 |
| 2次 | ✅ | 显示 |
| 10次 | ✅ | 显示 |
| 14次 | ✅ | 显示 |

#### 3. 日期联动测试

同一股票在不同日期的表现：

**股票A**：
- 11月5日：排名86 → 显示"TOP100·X次"（基于11月5日前14天统计）
- 11月12日：排名746 → 显示"TOP800·X次"（基于11月12日前14天统计）

**验证点**：
- [ ] 切换日期后，档位标签应随最新排名变化
- [ ] 统计次数应基于选定日期往前14天
- [ ] 两个日期的统计窗口不同，次数可能不同

---

## 🔧 技术细节

### 档位判断逻辑

```python
# 定义档位边界
tiers = [100, 200, 400, 600, 800, 1000, 2000, 3000]

# 示例：排名746
for tier in tiers:
    if 746 <= tier:  # 746 <= 100? 否; 746 <= 200? 否; ... 746 <= 800? 是
        current_tier = 800  # 确定档位
        break
```

### 次数获取逻辑

```python
# tier_counts 结构示例
tier_counts = {
    100: 2,   # 14天内有2次进入TOP100
    200: 2,   # 14天内有2次进入TOP200（与TOP100相同）
    400: 2,   # 同上
    600: 6,   # 14天内有6次进入TOP600
    800: 6,   # 14天内有6次进入TOP800（与TOP600相同）
    1000: 6,
    2000: 6,
    3000: 6
}

# 获取当前档位次数
current_tier = 800
hit_count_in_tier = tier_counts.get(800, 0)  # 6次
```

**注意**：档位次数是累积的，小档位的次数 ≤ 大档位的次数。

---

## 📝 相关文件修改

### 修改文件

1. **backend/app/services/signal_calculator.py**
   - 行号：253-277
   - 修改内容：重写档位标签生成逻辑
   - 修改类型：逻辑优化

### 未修改文件（验证无需修改）

1. **backend/app/services/hot_spots_cache.py**
   - 档位统计逻辑正确，无需修改

2. **frontend/src/components/modules/StockQueryModule.js**
   - 上一次修复已添加`date`参数，无需再改

---

## 🎯 预期效果

### 用户体验改进

#### 修复前
- 用户看到"TOP100·2次"
- 困惑：为什么排名746还显示TOP100？
- 误解：可能认为统计有误

#### 修复后
- 用户看到"TOP800·6次"
- 清晰：排名746确实在TOP800档位
- 理解：该股票在过去14天有6次进入TOP800

### 数据一致性

✅ **档位与排名一致**：显示的档位与当前排名匹配  
✅ **统计准确**：次数基于该档位的真实出现次数  
✅ **日期联动**：不同日期查询，档位和次数都会正确变化

---

## ⚠️ 注意事项

### 1. 档位跳跃现象

某些股票可能在不同日期跨越多个档位：
- 11月1日：排名50（TOP100）
- 11月5日：排名500（TOP600）
- 11月12日：排名2000（TOP2000）

**处理**：每次查询时，标签会显示对应日期的档位，符合预期。

### 2. 档位次数的含义

"TOP800·6次"表示：
- 在过去14天内，有6次排名进入TOP800（即排名≤800）
- **不是**：有6次恰好在TOP600-800区间

### 3. 最小显示次数

至少2次才显示标签，避免偶发进榜的股票产生误导。

---

## 🔄 后续优化方向

### 1. 档位详细统计（可选）

如果需要查看所有档位的统计，可以在详情页展示：

```
档位统计（过去14天）：
- TOP100: 2次
- TOP200: 2次
- TOP400: 2次
- TOP600: 6次
- TOP800: 6次 ⭐ 当前档位
```

### 2. 档位趋势分析（可选）

显示档位变化趋势：
- "档位上升"：从TOP1000提升到TOP800
- "档位下降"：从TOP200降至TOP600

### 3. 多日对比（可选）

对比不同日期的档位和次数：

| 日期 | 排名 | 档位 | 14天出现次数 |
|-----|------|------|------------|
| 11月5日 | 86 | TOP100 | 5次 |
| 11月12日 | 746 | TOP800 | 6次 |

---

## 📋 部署检查清单

### 代码审查
- [x] 逻辑正确性验证
- [x] 边界条件处理（排名超过3000）
- [x] 次数过滤（至少2次）
- [x] 变量名准确性（`hit_count_in_tier`）

### 测试验证
- [ ] 单元测试：档位判断逻辑
- [ ] 单元测试：次数获取逻辑
- [ ] 集成测试：与缓存层的交互
- [ ] 用户测试：前端显示正确性

### 部署步骤
1. [ ] 提交代码到版本控制
2. [ ] 部署到测试环境
3. [ ] 验证各种排名情况
4. [ ] 部署到生产环境
5. [ ] 监控日志，确认无错误

---

## 🎯 总结

**核心改进**：
- 从"显示所有档位"改为"只显示当前排名所在档位"
- 符合用户直觉和预期
- 信息更准确、简洁

**修复效果**：
- ✅ 解决档位不匹配问题
- ✅ 提升用户体验
- ✅ 数据展示更清晰

**测试要点**：
- 不同排名区间的档位判断
- 不同出现次数的过滤
- 不同日期的联动效果

---

**修复日期**: 2025-11-13  
**修复人员**: Cascade AI Assistant  
**影响范围**: 个股查询页、行业详情页、最新热点页  
**测试状态**: ⏳ 待部署测试
