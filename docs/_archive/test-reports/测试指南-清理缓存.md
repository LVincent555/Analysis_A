# 测试指南 - 清理缓存验证版本切换

**日期**: 2025-11-11 14:20  
**用途**: 验证原版/新版信号模式切换是否生效

---

## 🎯 问题现象

用户选择"最新热点TOP信号（原版）"后，弹窗显示的TOP 10成分股排序仍然是：
```
#1 粤桂股份  3个信号  40%   ← 按强度排序
#2 云南能投  1个信号  38%   ← 1个信号排在2个信号前面！
#3 常山北明  2个信号  37%
```

**期望排序（原版v1 - 按信号数量）**:
```
#1 粤桂股份  3个信号  40%   ← 3个信号优先
#2 常山北明  2个信号  37%   ← 2个信号其次
#3 浙江东日  3个信号  34%   ← 3个信号
#4 华金资本  2个信号  37%
#5 云南能投  1个信号  38%   ← 1个信号排后面
```

---

## 🔧 已修复内容

### 1. 前端：IndustryDetailDialog.js
**问题**: 弹窗API调用缺少`hot_list_version`参数

**修复**:
```javascript
// 修复前（缺少hot_list_version）
params: {
  hot_list_mode: signalThresholds.hotListMode || 'instant',
  hot_list_top: signalThresholds.hotListTop,
  ...
}

// 修复后
params: {
  hot_list_mode: signalThresholds.hotListMode || 'frequent',
  hot_list_version: signalThresholds.hotListVersion || 'v2',  // ← 添加
  hot_list_top: signalThresholds.hotListTop,
  ...
}
```

### 2. 后端：industry_detail_service.py
**问题**: 排序逻辑没有根据version调整优先级

**修复**:
```python
# 添加版本判断
elif sort_mode == "signal":
    version = signal_thresholds.hot_list_version if signal_thresholds else "v2"
    logger.info(f"🔄 按信号排序，version={version}")
    
    if signal_thresholds and signal_thresholds.hot_list_version == "v1":
        # 原版：数量 > 强度
        return sorted(stocks, key=lambda x: (
            -x.signal_count,     # 优先信号数量
            -x.signal_strength,
            x.rank
        ))
    else:
        # 新版：强度 > 数量
        return sorted(stocks, key=lambda x: (
            -x.signal_strength,  # 优先信号强度
            -x.signal_count,
            x.rank
        ))
```

### 3. 调试日志
添加了两处日志方便调试：
- 信号配置日志：显示mode和version
- 排序逻辑日志：显示优先级顺序

---

## ✅ 测试步骤

### 步骤1: 清理前端缓存
由于前端使用localStorage保存配置，需要清理：

**方法A - 浏览器开发者工具**:
1. 按`F12`打开开发者工具
2. 切换到`Application`标签（Chrome）或`Storage`标签（Firefox）
3. 左侧找到`Local Storage` → 选择你的域名
4. 找到`stock_analysis_signal_thresholds`键
5. 右键删除或点击删除按钮
6. 刷新页面（`Ctrl+F5`强制刷新）

**方法B - 控制台命令**:
1. 按`F12`打开开发者工具
2. 切换到`Console`标签
3. 输入：`localStorage.clear()`
4. 刷新页面（`Ctrl+F5`）

### 步骤2: 重启后端服务
```bash
cd backend
python main.py
```

### 步骤3: 前端重新编译
```bash
cd frontend
npm run build
```

### 步骤4: 验证原版模式
1. 打开应用
2. 点击右上角配置图标
3. 选择"最新热点TOP信号（原版）"
4. 点击"保存配置"
5. 点击任意板块查看弹窗

**预期结果**:
- 后端日志显示：`📊 信号配置: mode=frequent, version=v1`
- 后端日志显示：`🔄 按信号排序，version=v1, 优先级=数量>强度`
- 弹窗TOP 10排序：信号数量多的排前面

**验证方法**:
```
如果看到：
#1 某股票  3个信号  XX%
#2 某股票  2个信号  XX%
#3 某股票  1个信号  XX%

说明原版生效✅
```

### 步骤5: 验证新版模式
1. 配置面板选择"最新热点TOP信号（新版）"
2. 点击"保存配置"
3. 再次查看板块弹窗

**预期结果**:
- 后端日志显示：`version=v2`
- 后端日志显示：`优先级=强度>数量`
- 弹窗TOP 10排序：信号强度高的排前面

---

## 🐛 如果仍然不生效

### 检查1: localStorage是否正确保存
```javascript
// 在浏览器控制台输入
JSON.parse(localStorage.getItem('stock_analysis_signal_thresholds'))

// 应该看到：
{
  hotListMode: "frequent",
  hotListVersion: "v1",  // 或 "v2"
  ...
}
```

### 检查2: API请求参数
1. 打开开发者工具 → Network标签
2. 点击板块查看弹窗
3. 找到`stocks`请求
4. 查看Query String Parameters
5. 确认`hot_list_version=v1`或`v2`

### 检查3: 后端日志
查看终端输出，应该看到：
```
📊 信号配置: mode=frequent, version=v1
🔄 按信号排序，version=v1, 优先级=数量>强度
```

### 检查4: 清理后端缓存
**方法A - 重启后端**（最简单）:
```bash
Ctrl+C  # 停止后端
python main.py  # 重新启动
```

**方法B - 代码清理**（如果需要）:
在`industry_detail_service.py`的`__init__`方法添加：
```python
def __init__(self):
    self.db_service = database_service
    self.cache = {}  # 重置缓存
```

---

## 📊 测试案例

### 案例1: 综合行业（原版模式）

**期望排序**:
```
#1 粤桂股份  000833  3个信号  40%
#2 浙江东日  600113  3个信号  34%
#3 常山北明  000158  2个信号  37%
#4 华金资本  000532  2个信号  37%
#5 云南能投  002053  1个信号  38%
```

**判断标准**: 3个信号的都排在2个信号前面，2个信号的都排在1个信号前面

### 案例2: 综合行业（新版模式）

**期望排序**:
```
#1 粤桂股份  000833  3个信号  40%
#2 云南能投  002053  1个信号  38%
#3 常山北明  000158  2个信号  37%
#4 华金资本  000532  2个信号  37%
#5 浙江东日  600113  3个信号  34%
```

**判断标准**: 按信号强度百分比排序（40% > 38% > 37% > 34%）

---

## 🎯 成功标准

- ✅ 原版模式：3个信号优先于1个信号（即使强度略低）
- ✅ 新版模式：40%强度优先于37%强度（即使信号少）
- ✅ 切换模式后立即生效（缓存key不同）
- ✅ 后端日志正确显示version和优先级

---

## 📝 相关文档

- `v0.3.1-三种信号模式切换.md` - 功能说明
- `BUG修复-原版排序未生效.md` - 问题分析

---

**创建日期**: 2025-11-11 14:20  
**维护人员**: AI Assistant
