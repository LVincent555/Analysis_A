# 信号配置功能完善总结

## 🐛 修复的问题

### 问题1：板块详情页配置不生效

**现象**：
- 用户修改信号阈值配置
- 点击"应用设置并刷新"按钮
- 配置没有生效，还是使用旧的阈值

**原因**：
打开配置面板时，`tempThresholds`是在组件初始化时复制的`thresholds`。当用户应用配置后关闭面板，`thresholds`更新了，但下次打开面板时`tempThresholds`还是旧值。

**解决方案**：
在打开配置面板时，同步最新的`thresholds`到`tempThresholds`：

```javascript
<button
  onClick={() => {
    // 打开配置面板时，同步最新的阈值到临时阈值
    if (!showThresholdConfig) {
      setTempThresholds({...thresholds});
    }
    setShowThresholdConfig(!showThresholdConfig);
  }}
>
```

---

### 问题2：股票查询页面缺少信号配置功能

**需求**：
用户希望在股票查询页面也能配置信号阈值，而不是使用固定的硬编码值。

**解决方案**：
在股票查询页面添加完整的信号阈值配置功能。

---

## ✅ 修改内容

### 1. 板块详情页 - 修复配置同步

**文件**：`frontend/src/pages/IndustryDetailPage.js`

**修改位置**：第265-277行

**修改内容**：
```javascript
// 修改前
<button
  onClick={() => setShowThresholdConfig(!showThresholdConfig)}
>

// 修改后
<button
  onClick={() => {
    if (!showThresholdConfig) {
      setTempThresholds({...thresholds});
    }
    setShowThresholdConfig(!showThresholdConfig);
  }}
>
```

---

### 2. 股票查询页 - 添加信号配置

**文件**：`frontend/src/components/modules/StockQueryModule.js`

#### 2.1 添加状态管理

```javascript
// 信号阈值配置
const [showThresholdConfig, setShowThresholdConfig] = useState(false);
const [signalThresholds, setSignalThresholds] = useState({
  hotListTop: 100,
  rankJumpMin: 2000,
  priceSurgeMin: 5.0,
  volumeSurgeMin: 10.0,
  volatilitySurgeMin: 30.0
});
const [tempThresholds, setTempThresholds] = useState({...signalThresholds});
```

#### 2.2 修改信号判断逻辑

```javascript
// 修改前：硬编码阈值
if (latest.rank <= 100) signals.push(...);
if (previous.rank - latest.rank >= 2000) signals.push(...);
if (latest.price_change >= 5) signals.push(...);

// 修改后：使用配置的阈值
if (latest.rank <= signalThresholds.hotListTop) signals.push(...);
if (previous.rank - latest.rank >= signalThresholds.rankJumpMin) signals.push(...);
if (latest.price_change >= signalThresholds.priceSurgeMin) signals.push(...);
```

#### 2.3 添加配置按钮

在股票信息卡片的右上角添加"信号配置"按钮：

```javascript
<button
  onClick={() => {
    if (!showThresholdConfig) {
      setTempThresholds({...signalThresholds});
    }
    setShowThresholdConfig(!showThresholdConfig);
  }}
  className="flex items-center gap-1 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg"
>
  <Settings className="h-3.5 w-3.5" />
  <span>信号配置</span>
</button>
```

#### 2.4 添加配置面板

在股票信息卡片上方添加配置面板（5列布局）：

```javascript
{showThresholdConfig && (
  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
    <div className="flex items-center justify-between mb-3">
      <h3 className="font-semibold text-gray-900">信号阈值配置</h3>
      <button
        onClick={() => {
          setSignalThresholds({...tempThresholds});
          setShowThresholdConfig(false);
        }}
        className="px-4 py-2 bg-green-600 text-white rounded-lg"
      >
        应用设置
      </button>
    </div>
    <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
      {/* 5个配置项 */}
    </div>
  </div>
)}
```

---

## 📊 功能对比

### 板块详情页 vs 股票查询页

| 功能 | 板块详情页 | 股票查询页 |
|-----|-----------|-----------|
| **配置项** | 6个 | 5个 |
| **配置方式** | 下拉框 | 下拉框 |
| **应用方式** | 应用设置并刷新 | 应用设置 |
| **生效时机** | 重新加载API数据 | 立即重新计算信号 |
| **布局** | 6列 | 5列 |

### 配置项说明

**板块详情页（6项）**：
1. 热点榜阈值
2. 跳变榜阈值
3. 稳步上升天数
4. 涨幅榜阈值
5. 成交量阈值
6. 波动率上升阈值

**股票查询页（5项）**：
1. 热点榜阈值
2. 跳变榜阈值
3. 涨幅榜阈值
4. 成交量阈值
5. 波动率上升阈值

*注：股票查询页缺少"稳步上升天数"配置，因为前端实时判断连续上升天数较复杂，暂不支持。*

---

## 🎨 UI设计

### 配置按钮位置

**板块详情页**：
```
┌────────────────────────────────────────────┐
│ ← 返回 / 行业趋势分析 / 通信设备             │
│                          [信号阈值配置] ← 这里 │
└────────────────────────────────────────────┘
```

**股票查询页**：
```
┌────────────────────────────────────────────┐
│ 中兴通讯 (000063)          [信号配置] ← 这里   │
│ 行业: 通信设备                最新排名 #68    │
└────────────────────────────────────────────┘
```

### 配置面板

**板块详情页**：
- 6列布局
- 黄色背景
- 右上角"应用设置并刷新"按钮（绿色）

**股票查询页**：
- 5列布局
- 黄色背景
- 右上角"应用设置"按钮（绿色）
- 更紧凑的设计

---

## 🔧 技术细节

### 状态管理

两个页面都使用相同的模式：
```javascript
const [thresholds, setThresholds] = useState({...});  // 正式阈值
const [tempThresholds, setTempThresholds] = useState({...thresholds});  // 临时阈值
```

**工作流程**：
1. 打开配置面板 → 复制`thresholds`到`tempThresholds`
2. 修改下拉框 → 更新`tempThresholds`
3. 点击"应用设置" → 复制`tempThresholds`到`thresholds`
4. `thresholds`更新 → 触发重新计算

### 响应式布局

**板块详情页**：
```css
grid-cols-2 md:grid-cols-3 lg:grid-cols-6
小屏幕：2列
中等屏幕：3列
大屏幕：6列
```

**股票查询页**：
```css
grid-cols-2 md:grid-cols-5
小屏幕：2列
中等屏幕：5列
```

---

## ✅ 测试清单

### 板块详情页测试

- [ ] **配置同步测试**
  1. 打开板块详情页
  2. 点击"信号阈值配置"
  3. 修改某个阈值（如跳变榜改为3000）
  4. 点击"应用设置并刷新"
  5. 再次打开配置面板
  6. **验证**：下拉框显示的是刚才选择的值（3000）

- [ ] **配置生效测试**
  1. 修改热点榜阈值为TOP 50
  2. 应用设置
  3. **验证**：信号标签变化，只显示TOP 50的股票有"热点榜"信号

### 股票查询页测试

- [ ] **配置按钮测试**
  1. 查询任意股票
  2. 找到右上角"信号配置"按钮
  3. 点击按钮
  4. **验证**：配置面板显示

- [ ] **配置生效测试**
  1. 修改热点榜阈值为TOP 200
  2. 点击"应用设置"
  3. **验证**：信号标签立即更新（如果排名≤200，显示"热点榜TOP200"）

- [ ] **跳变榜测试**
  1. 查询排名大幅提升的股票（如从4000→1500）
  2. 默认阈值2000，应该触发信号
  3. 修改阈值为3000
  4. **验证**：信号消失（提升2500<3000）

- [ ] **波动率测试**
  1. 查询有波动率变化的股票
  2. 默认阈值30%，检查是否触发
  3. 修改阈值为50%
  4. **验证**：信号变化

---

## 📝 使用说明

### 板块详情页 - 如何配置信号阈值

1. **进入板块详情页**
   - 查询系统 > 板块查询 > 选择板块

2. **打开配置面板**
   - 点击右上角"信号阈值配置"按钮

3. **修改阈值**
   - 选择需要的阈值（6个配置项）
   - 每个配置项有3-6个选项

4. **应用配置**
   - 点击"应用设置并刷新"按钮
   - 页面会重新加载，使用新阈值

### 股票查询页 - 如何配置信号阈值

1. **查询股票**
   - 输入股票代码，点击查询

2. **打开配置面板**
   - 点击股票信息卡片右上角"信号配置"按钮

3. **修改阈值**
   - 选择需要的阈值（5个配置项）

4. **应用配置**
   - 点击"应用设置"按钮
   - 信号标签立即更新

---

## 🎯 阈值推荐

### 默认配置（平衡型）

```
热点榜：TOP 100
跳变榜：≥2000名
稳步上升：≥3天
涨幅榜：≥5%
成交量：≥10%
波动率上升：≥30%
```

### 激进策略（捕捉更多信号）

```
热点榜：TOP 200
跳变榜：≥1000名
稳步上升：≥2天
涨幅榜：≥3%
成交量：≥5%
波动率上升：≥30%
```

### 保守策略（只看强信号）

```
热点榜：TOP 50
跳变榜：≥3000名
稳步上升：≥5天
涨幅榜：≥7%
成交量：≥15%
波动率上升：≥50%
```

---

## 🚀 后续优化建议

1. **配置持久化**
   - 将用户配置保存到localStorage
   - 下次打开自动加载

2. **配置预设**
   - 提供"激进/平衡/保守"三个预设
   - 一键切换

3. **配置同步**
   - 板块详情页和股票查询页共享配置
   - 修改一个，另一个自动同步

4. **配置导出/导入**
   - 导出配置为JSON
   - 导入他人配置

---

## 📋 修改文件清单

1. **frontend/src/pages/IndustryDetailPage.js**
   - 修复配置同步问题

2. **frontend/src/components/modules/StockQueryModule.js**
   - 添加信号阈值配置功能
   - 添加Settings图标导入
   - 添加状态管理
   - 添加配置按钮和配置面板
   - 修改信号判断逻辑使用配置阈值

---

**修复时间**: 2025-11-09  
**测试状态**: ✅ 待测试  

🎉 **配置同步问题已修复！股票查询页信号配置已添加！** 🎉
