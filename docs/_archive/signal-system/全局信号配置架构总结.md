# 全局信号配置架构总结

## 🎯 架构设计

### 设计理念
- **集中管理**：信号配置统一管理，避免分散
- **全局同步**：所有页面使用同一套配置，保证一致性
- **易于扩展**：独立的Context和组件设计，方便未来添加新配置
- **用户友好**：顶部导航栏一键访问，操作便捷

---

## 📂 新增文件

### 1. SignalConfigContext.js
**路径**：`frontend/src/contexts/SignalConfigContext.js`

**作用**：全局信号配置的Context

**核心功能**：
```javascript
// 默认配置
const DEFAULT_THRESHOLDS = {
  hotListTop: 100,
  rankJumpMin: 2000,
  steadyRiseDays: 3,
  priceSurgeMin: 5.0,
  volumeSurgeMin: 10.0,
  volatilitySurgeMin: 30.0
};

// Provider提供的接口
{
  signalThresholds,      // 当前生效的配置
  showConfig,            // 配置面板显示状态
  tempThresholds,        // 临时编辑的配置
  setTempThresholds,     // 修改临时配置
  openConfig,            // 打开配置面板
  closeConfig,           // 关闭配置面板
  applyConfig,           // 应用配置
  resetToDefault         // 重置为默认值
}
```

**使用方式**：
```javascript
import { useSignalConfig } from '../contexts/SignalConfigContext';

const { signalThresholds, openConfig } = useSignalConfig();
```

---

### 2. SignalConfigPanel.js
**路径**：`frontend/src/components/SignalConfigPanel.js`

**作用**：全局信号配置面板（弹窗）

**特点**：
- 独立组件，不影响其他页面
- 模态窗口设计，黑色半透明背景
- 6个配置项，3列网格布局
- 渐变紫蓝色主题
- 恢复默认、取消、应用三个按钮

**UI设计**：
```
┌────────────────────────────────────────┐
│  🎯 信号阈值配置              [×]       │
│  调整信号识别的敏感度，全局生效          │
├────────────────────────────────────────┤
│  [热点榜] [跳变榜] [稳步上升]          │
│  [涨幅榜] [成交量] [波动率上升]        │
│                                        │
│  💡 配置说明...                        │
│                                        │
│         [恢复默认] [取消] [✓ 应用配置]  │
└────────────────────────────────────────┘
```

---

## 🔧 修改文件

### 1. App.js
**修改内容**：

#### 1.1 添加导入
```javascript
import { SignalConfigProvider, useSignalConfig } from './contexts/SignalConfigContext';
import SignalConfigPanel from './components/SignalConfigPanel';
```

#### 1.2 Header添加全局配置按钮
```javascript
<div className="flex items-center gap-3">
  {/* 全局信号配置按钮 */}
  <button
    onClick={openConfig}
    className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 ..."
  >
    <Settings className="h-4 w-4" />
    <span>信号配置</span>
  </button>
  
  {/* 日期选择器 */}
  ...
</div>
```

#### 1.3 使用Provider包装
```javascript
// 将原App改名为AppContent
function AppContent() {
  const { openConfig } = useSignalConfig();
  // ... 原有代码
}

// 新的App组件
function App() {
  return (
    <SignalConfigProvider>
      <AppContent />
      <SignalConfigPanel />
    </SignalConfigProvider>
  );
}
```

---

### 2. IndustryDetailPage.js
**修改内容**：

#### 2.1 使用全局配置
```javascript
import { useSignalConfig } from '../contexts/SignalConfigContext';

export default function IndustryDetailPage({ industryName, onBack }) {
  // 使用全局配置
  const { signalThresholds } = useSignalConfig();
  
  // 删除本地配置状态
  // const [thresholds, setThresholds] = useState({...});
  // const [tempThresholds, setTempThresholds] = useState({...});
  // const [showThresholdConfig, setShowThresholdConfig] = useState(false);
```

#### 2.2 API调用使用全局配置
```javascript
axios.get(`${API_BASE_URL}/api/industry/${industryName}/stocks`, {
  params: {
    // 使用signalThresholds而不是thresholds
    hot_list_top: signalThresholds.hotListTop,
    rank_jump_min: signalThresholds.rankJumpMin,
    // ...其他参数
  }
})
```

#### 2.3 useEffect依赖更新
```javascript
// 修改前
useEffect(() => {
  // ...
}, [industryName, sortMode, thresholds]);

// 修改后
useEffect(() => {
  // ...
}, [industryName, sortMode, signalThresholds]);
```

#### 2.4 删除本地UI
- 删除本地配置按钮
- 删除本地配置面板

---

## 🎨 UI变化

### 全局导航栏

**修改前**：
```
潘哥的底裤                          [数据日期: 2025-11-07 ⭐]
```

**修改后**：
```
潘哥的底裤      [信号配置]    [数据日期: 2025-11-07 ⭐]
```

---

### 板块详情页

**修改前**：
```
← 返回 / 行业趋势分析 / 通信设备    [信号阈值配置]

[配置面板显示在这里]
```

**修改后**：
```
← 返回 / 行业趋势分析 / 通信设备

（配置按钮已移除，使用全局配置）
```

---

## 📊 配置同步流程

### 用户操作流程
```
1. 点击顶部"信号配置"按钮
   ↓
2. 弹出全局配置面板
   ↓
3. 修改配置（修改tempThresholds）
   ↓
4. 点击"应用配置"
   ↓
5. tempThresholds复制到signalThresholds
   ↓
6. 所有使用signalThresholds的组件自动重新渲染
   ↓
7. API重新请求（useEffect触发）
```

### 技术流程
```
Context (signalThresholds)
    ↓
App.js (通过Provider提供)
    ↓
AppContent (openConfig按钮)
    ↓
SignalConfigPanel (编辑tempThresholds)
    ↓
applyConfig() (应用到signalThresholds)
    ↓
IndustryDetailPage (useEffect监听signalThresholds变化)
    ↓
重新请求API
```

---

## ✅ 优势

### 1. 集中管理
- 所有配置集中在一处
- 避免重复代码
- 便于维护和调试

### 2. 全局同步
- 修改一次，全局生效
- 板块详情页和股票查询页使用同一套配置
- 用户体验一致

### 3. 易于扩展
- Context模式便于添加新配置
- 独立组件设计，修改不影响其他页面
- 可以轻松添加新的信号类型

### 4. 用户友好
- 顶部一键访问，无需进入特定页面
- 弹窗设计，不打断当前操作
- 恢复默认功能，操作可逆

---

## 🔄 数据流

### 配置修改流程
```
用户点击[信号配置]
  ↓
openConfig()
  ↓
showConfig = true
  ↓
SignalConfigPanel显示
  ↓
用户修改下拉框
  ↓
setTempThresholds({...tempThresholds, xxx: value})
  ↓
用户点击[应用配置]
  ↓
applyConfig()
  ↓
setSignalThresholds({...tempThresholds})
setShowConfig(false)
  ↓
所有使用signalThresholds的组件重新渲染
  ↓
IndustryDetailPage的useEffect触发
  ↓
API重新请求with新配置
```

---

## 📝 配置项详解

| 配置项 | Key | 类型 | 默认值 | 范围 | 说明 |
|-------|-----|------|--------|------|------|
| 热点榜阈值 | hotListTop | int | 100 | 50/100/200/500 | 排名需要≤X名 |
| 跳变榜阈值 | rankJumpMin | int | 2000 | 1000-3500 | 排名提升≥X名 |
| 稳步上升天数 | steadyRiseDays | int | 3 | 2-14 | 连续X天上升 |
| 涨幅榜阈值 | priceSurgeMin | float | 5.0 | 3-10 | 涨跌幅≥X% |
| 成交量阈值 | volumeSurgeMin | float | 10.0 | 5-20 | 换手率≥X% |
| 波动率上升阈值 | volatilitySurgeMin | float | 30.0 | 30-150 | 百分比变化≥X% |

---

## 🚀 未来扩展

### 1. 配置持久化
```javascript
// localStorage保存
const saveConfig = () => {
  localStorage.setItem('signalConfig', JSON.stringify(signalThresholds));
};

// 加载配置
const loadConfig = () => {
  const saved = localStorage.getItem('signalConfig');
  if (saved) {
    setSignalThresholds(JSON.parse(saved));
  }
};
```

### 2. 配置预设
```javascript
const PRESETS = {
  aggressive: { hotListTop: 200, rankJumpMin: 1000, ... },
  balanced: { hotListTop: 100, rankJumpMin: 2000, ... },
  conservative: { hotListTop: 50, rankJumpMin: 3000, ... }
};
```

### 3. 配置导入导出
```javascript
// 导出
const exportConfig = () => {
  const json = JSON.stringify(signalThresholds, null, 2);
  downloadFile('signal-config.json', json);
};

// 导入
const importConfig = (file) => {
  const config = JSON.parse(file);
  setSignalThresholds(config);
};
```

### 4. 添加新配置项
```javascript
// 1. 在DEFAULT_THRESHOLDS添加
const DEFAULT_THRESHOLDS = {
  // ... 现有配置
  newSignalMin: 10.0  // 新增
};

// 2. 在SignalConfigPanel添加UI
<div className="bg-pink-50 border border-pink-200 rounded-lg p-4">
  <label>🆕 新信号阈值</label>
  <select ...>
    <option value={5}>≥5</option>
    <option value={10}>≥10</option>
  </select>
</div>

// 3. 在API调用中使用
axios.get(..., {
  params: {
    // ... 其他参数
    new_signal_min: signalThresholds.newSignalMin
  }
})
```

---

## ✅ 测试清单

### 基本功能测试
- [ ] 点击顶部"信号配置"按钮，弹窗显示
- [ ] 修改任意配置项，临时值更新
- [ ] 点击"应用配置"，配置生效，弹窗关闭
- [ ] 点击"取消"，配置不变，弹窗关闭
- [ ] 点击"恢复默认"，配置恢复到初始值

### 同步测试
- [ ] 在板块详情页修改配置，API重新请求
- [ ] 配置修改后，信号显示变化
- [ ] 切换页面，配置保持不变

### 边界测试
- [ ] 所有配置项都能正常修改
- [ ] 配置值在合理范围内
- [ ] 不同配置组合都能正常工作

---

## 📋 完整文件清单

### 新增文件
1. `frontend/src/contexts/SignalConfigContext.js` - Context和Provider
2. `frontend/src/components/SignalConfigPanel.js` - 配置面板组件

### 修改文件
1. `frontend/src/App.js` - 添加Provider和全局按钮
2. `frontend/src/pages/IndustryDetailPage.js` - 使用全局配置，删除本地配置

---

**架构完成时间**: 2025-11-09  
**测试状态**: ✅ 待测试  

🎉 **全局信号配置架构已完成！独立设计，易于扩展！** 🎉
