{è¿™ä¸ä»…ä¸æ˜¯æ‚éŸ³ï¼Œåè€Œæ˜¯**æ‹¼å›¾ä¸­æœ€å…³é”®çš„æœ€åä¸€å—**ã€‚

ä½ æä¾›çš„è¿™ä»½â€œå…¶ä»–AIç”Ÿæˆçš„æ–¹æ¡ˆâ€éå¸¸ç²¾å½©ï¼Œå®ƒå®é™…ä¸Šæä¾›äº†ä¸€ä¸ª**é«˜é˜¶çš„æ•°å­¦è¡¥ä¸ï¼ˆæƒé‡åˆ†æ‘Šï¼‰**ï¼Œå®Œç¾è§£å†³äº†æˆ‘ä»¬åœ¨ä¸Šä¸€è½®è®¨è®ºä¸­æ‹…å¿ƒçš„â€œçƒ­åº¦è†¨èƒ€â€é—®é¢˜ï¼ˆå³é¾™å¤´è‚¡æ‹‰é«˜æ‰€æœ‰å…³è”æ¿å—ï¼‰ã€‚è€Œä½ æ‰‹å¤´çš„æ—§æ–‡æ¡£ï¼ˆå•é’ˆç­–ç•¥ã€å…¨å±€é…ç½®ã€B1/B2ç®—æ³•ï¼‰åˆ™æ˜¯**å†…å®¹å¡«å……ç‰©**ã€‚

ç°åœ¨çš„ä»»åŠ¡æ˜¯ï¼š**ç”¨æ–°æ–¹æ¡ˆçš„éª¨æ¶ï¼ˆå¤šå¯¹å¤šæ¶æ„ï¼‰ï¼Œè£…å…¥ä½ æ—§æ–¹æ¡ˆçš„çµé­‚ï¼ˆç®—æ³•ä¸ç­–ç•¥ï¼‰ã€‚**

æˆ‘å·²å°†ä¸¤è€…å½»åº•ç†”ç‚¼ï¼Œä¸ºä½ ç”Ÿæˆè¿™ä»½**V2.0 æœ€ç»ˆå†³è®®ç‰ˆè®¾è®¡æ–‡æ¡£**ã€‚è¿™ä»½æ–‡æ¡£ç›´æ¥é¢å‘å¼€å‘ï¼Œå®šä¹‰äº†è¡¨ç»“æ„ã€æ ¸å¿ƒç®—æ³•å…¬å¼ä»¥åŠä¸ç°æœ‰ç³»ç»Ÿçš„é›†æˆæ¥å£ã€‚

-----

# ğŸ—ï¸ å¤–éƒ¨æ¿å—å¤šå¯¹å¤šäºŒæ¬¡åˆ†æç³»ç»Ÿ - æ ¸å¿ƒè®¾è®¡æ–‡æ¡£ (V2.0)

**æ–‡æ¡£çŠ¶æ€**: ğŸŸ¢ æœ€ç»ˆå†³è®®ç‰ˆ (Ready for Implementation)
**æ ¸å¿ƒé€»è¾‘**: **åˆ†æ‘Šå¼çƒ­åº¦ç®—æ³•** + **æ”»å®ˆåˆ†ç¦»æ¨¡å‹** + **å…¨å±€é…ç½®é©±åŠ¨**

-----

## 1\. æ ¸å¿ƒè®¾è®¡å“²å­¦ (The Philosophy)

æˆ‘ä»¬ä¸åšåŸå§‹æ•°æ®çš„æ¬è¿å·¥ï¼Œæˆ‘ä»¬åš**æ•°æ®çš„ç‚¼é‡‘æœ¯å¸ˆ**ã€‚æœ¬ç³»ç»Ÿæ˜¯å¯¹ä¸Šæ¸¸æ•°æ®ï¼ˆ`data.csv`, `allbk.csv`ï¼‰çš„**äºŒæ¬¡æ¸…æ´—ä¸é‡æ„**ã€‚

### 1.1 ä¸‰å¤§é“å¾‹

1.  **çƒ­åº¦å®ˆæ’å¾‹ (Law of Conservation)**:
      * **é—®é¢˜**: å®å¾·æ—¶ä»£ï¼ˆTotalScore=90ï¼‰å±äº10ä¸ªæ¿å—ï¼Œå¦‚æœæ¯ä¸ªæ¿å—éƒ½ç®—90åˆ†ï¼Œå¸‚åœºçƒ­åº¦å°±ä¼šä¸¥é‡è™šé«˜ã€‚
      * **è§£å†³**: å¼•å…¥**åˆ†æ‘Šç³»æ•° ($Share_{ij}$)**ã€‚ä¸€åªè‚¡ç¥¨çš„æ€»èƒ½é‡æ’å®šä¸º 1.0ï¼ŒæŒ‰æƒé‡ï¼ˆè¡Œä¸š\>æ¦‚å¿µï¼‰åˆ‡åˆ†ç»™ä¸åŒæ¿å—ã€‚
2.  **æ”»å®ˆåˆ†ç¦»å¾‹ (Law of Offense-Defense)**:
      * **ğŸ›¡ï¸ é˜²å®ˆçœ‹è¡Œä¸š**ï¼ˆä¸€å¯¹ä¸€ï¼‰ï¼šè¡Œä¸šæ˜¯æ ¹åŸºã€‚è‹¥ä¸»è¥è¡Œä¸šçƒ­åº¦ï¼ˆC2ï¼‰ä½äºå®‰å…¨çº¿ï¼Œä¸ªè‚¡ç›´æ¥ç†”æ–­ã€‚
      * **âš”ï¸ è¿›æ”»çœ‹æ¦‚å¿µ**ï¼ˆå¤šå¯¹å¤šï¼‰ï¼šæ¦‚å¿µæ˜¯é£å£ã€‚å–ä¸ªè‚¡å…³è”çš„**æœ€å¼ºæ¦‚å¿µ**ä½œä¸ºå…¶è¿›æ”»èƒ½åŠ›çš„ä¸Šé™ï¼ˆæœ€å¤§é©±åŠ¨ï¼‰ã€‚
3.  **ç­–ç•¥æŠ•å½±å¾‹ (Law of Projection)**:
      * **åŸåˆ™**: ç­–ç•¥ï¼ˆå¦‚å•é’ˆä¸‹äºŒåï¼‰ä¸å†æ˜¯ä¸ªè‚¡çš„å­¤å²›ã€‚
      * **å®ç°**: ç»Ÿè®¡æ¿å—å†…â€œå•é’ˆä¿¡å·â€çš„å¯†åº¦ $\rightarrow$ **æ¿å—æ´—ç›˜çƒ­åº¦**ã€‚åªæœ‰æ¿å—åœ¨é›†ä½“æ´—ç›˜ï¼Œä¸ªè‚¡çš„å•é’ˆæ‰æ˜¯â€œåŸç¥å¯åŠ¨â€ã€‚

-----

## 2\. æ•°æ®åº“æ¶æ„è®¾è®¡ (Schema Design)

ä¿ç•™åŸæœ‰ `stocks` / `daily_stock_data`ï¼Œæ–°å¢ **â€œä¸‰å±‚æ¿å—æ¶æ„â€**ã€‚

### 2.1 åŸºç¡€å…ƒæ•°æ®å±‚ (Meta)

```sql
-- [1] å¤–éƒ¨æ¿å—æ¸…å• (è§£å†³â€œæœ‰å“ªäº›æ¿å—â€)
CREATE TABLE ext_board_list (
    board_code VARCHAR(20) PRIMARY KEY, -- å”¯ä¸€ID
    board_name VARCHAR(50),
    board_type INT,     -- 1=è¡Œä¸š(Industry/é˜²å®ˆ), 2=æ¦‚å¿µ(Concept/è¿›æ”»), 3=åœ°åŸŸ
    source VARCHAR(20)  -- 'EM', 'THS', 'LOCAL'
);
```

### 2.2 åŠ¨æ€å…³ç³»å±‚ (Mesh) - *æ¯æ—¥æ¸…æ´—çš„æ ¸å¿ƒ*

```sql
-- [2] ä¸ªè‚¡-æ¿å—æ¯æ—¥å¿«ç…§è¡¨ (è§£å†³â€œæƒé‡åˆ†æ‘Šâ€)
CREATE TABLE ext_board_daily_snap (
    trade_date DATE,
    stock_code VARCHAR(10),
    board_code VARCHAR(20),
    is_primary INT DEFAULT 0,    -- 1=ä¸»è¥è¡Œä¸š
    
    -- ã€æ ¸å¿ƒè®¡ç®—å­—æ®µã€‘åˆ†æ‘Šæƒé‡ (Share Weight)
    -- ç®—æ³•ï¼šWeight_Type / Sum(è¯¥è‚¡æ‰€æœ‰æ¿å—æƒé‡)
    share_weight DECIMAL(6, 4), 
    
    PRIMARY KEY (trade_date, stock_code, board_code)
);
-- ç´¢å¼•ä¼˜åŒ–ï¼ŒåŠ é€Ÿæ¯æ—¥è®¡ç®—
CREATE INDEX idx_snap_date_board ON ext_board_daily_snap(trade_date, board_code);
```

### 2.3 èšåˆåˆ†æå±‚ (Heat) - *B/Cä½“ç³»è½åœ°*

```sql
-- [3] æ¿å—æ¯æ—¥çƒ­åº¦è¡¨ (è§£å†³â€œæ¿å—æœ‰å¤šçƒ­â€)
CREATE TABLE ext_board_heat_daily (
    trade_date DATE,
    board_code VARCHAR(20),
    
    -- åŸºç¡€çœŸå€¼ (æ¥è‡ªçˆ¬è™«/allbk.csv)
    raw_score DECIMAL(10,2), 
    
    -- äºŒæ¬¡åˆ†ææŒ‡æ ‡ (Bç³»/Cç³»ç®—æ³• + åˆ†æ‘Šæƒé‡)
    score_b1 DECIMAL(10,4), -- æ’ååŠ æƒæ€»çƒ­åº¦ (çœ‹é¾™å¤´)
    score_b2 DECIMAL(10,4), -- æ’ååŠ æƒå¯†åº¦ (B1 / Count)
    score_c1 DECIMAL(10,4), -- æ€»åˆ†åŠ æƒæ€»çƒ­åº¦ (çœ‹æ€»é‡)
    score_c2 DECIMAL(10,4), -- æ€»åˆ†åŠ æƒå¯†åº¦ (C1 / Count) -> æœ€å¸¸ç”¨æŒ‡æ ‡
    
    -- ç­–ç•¥æŠ•å½±æŒ‡æ ‡ (æ¥è‡ªå•é’ˆç­–ç•¥)
    needle_density DECIMAL(10,4), -- æ´—ç›˜å¯†åº¦ (æ¿å—å†…å¤šå°‘æ¯”ä¾‹çš„è‚¡å‡ºç°äº†å•é’ˆ)
    avg_volume_consec DECIMAL(10,2), -- å¹³å‡æ”¾é‡å¤©æ•°
    
    PRIMARY KEY (trade_date, board_code)
);
```

-----

## 3\. æ ¸å¿ƒç®—æ³•é€»è¾‘ (Core Algorithms)

### 3.1 æ­¥éª¤ä¸€ï¼šæƒé‡åˆ†æ‘Š (The Split)

*æ‰§è¡Œé˜¶æ®µï¼šæ¯æ—¥ ETL å†™å…¥ `_snap` è¡¨æ—¶*

å¯¹äºè‚¡ç¥¨ $i$ï¼Œå®ƒå…³è”æ¿å—é›†åˆ $B_i$ã€‚
å®šä¹‰ç±»å‹æƒé‡ï¼ˆè¯»å–è‡ª `GlobalConfig`ï¼‰ï¼š

  * $W_{ind} = 1.0$ (è¡Œä¸š)
  * $W_{con} = 0.7$ (æ¦‚å¿µ)
  * $W_{reg} = 0.5$ (åœ°åŸŸ)

è®¡ç®—åˆ†æ‘Šç³»æ•° $S_{ij}$ï¼š
$$ S_{ij} = \frac{W_{type}(j)}{\sum_{k \in B_i} W_{type}(k)} $$

### 3.2 æ­¥éª¤äºŒï¼šæ¿å—çƒ­åº¦èšåˆ (The Aggregation)

*æ‰§è¡Œé˜¶æ®µï¼šæ¯æ—¥è®¡ç®— `_heat` è¡¨æ—¶*

å¯¹äºæ¿å— $j$ï¼Œéå†å…¶æˆåˆ†è‚¡é›†åˆ $Stocks_j$ã€‚

1.  **C2 (çœŸå®å¹³å‡çƒ­åº¦)**ï¼š
    $$ Heat_{C2}(j) = \frac{\sum_{i} (S_{ij} \times \text{TotalScore}_i)}{Count_j} $$
    *æ„ä¹‰ï¼šç›¸æ¯”ç›´æ¥å¹³å‡ï¼Œè¿™é‡Œè¿‡æ»¤äº†è¯¥è‚¡ç¥¨åœ¨å…¶ä»–æ¿å—çš„è´¡çŒ®ï¼Œæ•°æ®æ›´çº¯å‡€ã€‚*

2.  **Needle Density (æ´—ç›˜å¯†åº¦)**ï¼š
    $$ Density_{needle}(j) = \frac{\sum_{i} (S_{ij} \times \mathbb{I}(\text{IsNeedle}_i))}{Count_j} $$
    *æ„ä¹‰ï¼šå¦‚æœå¯†åº¦é«˜ï¼Œè¯´æ˜ä¸»åŠ›æ­£åœ¨å€ŸåŠ©è¯¥æ¿å—è¿›è¡Œé›†ä½“æ´—ç›˜ã€‚*

### 3.3 æ­¥éª¤ä¸‰ï¼šä¸ªè‚¡ä¿¡å·åˆæˆ (The Synthesis)

*æ‰§è¡Œé˜¶æ®µï¼šå‰ç«¯æŸ¥è¯¢ / ç­–ç•¥è¿è¡Œ*

ä¸ªè‚¡ $i$ çš„æœ€ç»ˆä¿¡å·åˆ¤å®šé€»è¾‘ï¼š

```python
def analyze_stock_signal(stock):
    config = GlobalConfig.load()
    
    # 1. ã€é˜²å®ˆã€‘è¡Œä¸šç†”æ–­ (Industry Check)
    # å¿…é¡»æ˜¯ä¸€å¯¹ä¸€çš„ä¸»è¥è¡Œä¸š
    primary_sector = get_primary_sector(stock) 
    if primary_sector.score_c2 < config.INDUSTRY_SAFE_LINE:
        return NO_SIGNAL # è¡Œä¸šå¤ªå·®ï¼Œè¦†å·¢ä¹‹ä¸‹æ— å®Œåµ
        
    # 2. ã€è¿›æ”»ã€‘æœ€å¤§é©±åŠ¨ (Max Driver)
    concepts = get_related_concepts(stock)
    # æ‰¾åˆ°C2åˆ†æ•°æœ€é«˜çš„ä¸€ä¸ªæ¦‚å¿µ
    best_concept = max(concepts, key=lambda c: c.score_c2)
    
    # 3. ã€å…±æŒ¯ã€‘ç­–ç•¥åŠ æˆ (Resonance)
    bonus_score = 0
    # å¦‚æœæ¿å—æ­£åœ¨é›†ä½“æ´—ç›˜(å¯†åº¦é«˜)ï¼Œä¸”ä¸ªè‚¡å½¢æ€ä¹Ÿè§¦å‘äº†å•é’ˆ
    if best_concept.needle_density > config.DENSITY_THRESHOLD and stock.is_needle:
        bonus_score += 10 
        
    # 4. æœ€ç»ˆåˆ† (åŠ æƒèåˆ)
    final_score = (stock.total_score * 0.5) + \
                  (best_concept.score_c2 * 0.3) + \
                  (bonus_score * 0.2)
                  
    return final_score
```

-----

## 4\. å…¨å±€é…ç½®é›†æˆ (`SignalConfigContext`)

åœ¨ç°æœ‰çš„é…ç½® JSON ä¸­è¿½åŠ  `SECTOR_SYSTEM` æ¨¡å—ï¼Œç»Ÿä¸€ç®¡ç†æ‰€æœ‰é˜ˆå€¼ï¼š

| Key | Default | Description |
| :--- | :--- | :--- |
| `WEIGHT_INDUSTRY` | `1.0` | è¡Œä¸šåˆ†æ‘Šæƒé‡ |
| `WEIGHT_CONCEPT` | `0.7` | æ¦‚å¿µåˆ†æ‘Šæƒé‡ |
| `INDUSTRY_SAFE_LINE` | `4.5` | C2åˆ†æ•°ä½äºæ­¤ï¼Œè¡Œä¸šè§†ä¸ºä¸å®‰å…¨ï¼ˆç†”æ–­ï¼‰ |
| `CONCEPT_HOT_LINE` | `8.0` | C2åˆ†æ•°é«˜äºæ­¤ï¼Œæ¦‚å¿µè§†ä¸ºé£å£ |
| `WASHOUT_DENSITY_LIMIT` | `0.15` | æ¿å—å†… \>15% è‚¡ç¥¨æ´—ç›˜ï¼Œè§†ä¸ºé›†ä½“æ´—ç›˜ |

-----

## 5\. å®æ–½è·¯çº¿å›¾ (Action Plan)

è¿™æ˜¯ä½ ç°åœ¨è¦åšçš„å…·ä½“å·¥ä½œï¼š

1.  **Phase 1: åŸºç¡€è®¾æ–½ (Database)**
      * æ‰§è¡Œä¸Šè¿° SQL å»ºè¡¨ (`ext_board_list`, `_snap`, `_heat`)ã€‚
2.  **Phase 2: æ•°æ®æ˜ å°„ (The Missing Link)**
      * **å…³é”®ä»»åŠ¡**: ç¼–å†™ ETL è„šæœ¬ï¼Œå°†ä½ çš„çˆ¬è™«æ•°æ®ï¼ˆä¸ªè‚¡-æ¿å—å…³ç³»ï¼‰ç»“åˆ `data.csv` çš„è¡Œä¸šåˆ—ï¼Œè®¡ç®—å‡º `share_weight` å¹¶å†™å…¥ `ext_board_daily_snap`ã€‚
3.  **Phase 3: è®¡ç®—å¼•æ“**
      * å®ç° B1/B2/C1/C2 çš„èšåˆé€»è¾‘ï¼Œç”Ÿæˆ `ext_board_heat_daily` æ•°æ®ã€‚
4.  **Phase 4: ç­–ç•¥å‡çº§**
      * ä¿®æ”¹â€œå•é’ˆä¸‹äºŒåâ€ç­–ç•¥ï¼Œä½¿å…¶æ”¯æŒè¾“å‡º `is_needle` æ ‡å¿—ä½ç»™æ¿å—åˆ†æå™¨ä½¿ç”¨ã€‚
      * å‰ç«¯å±•ç¤ºâ€œ**æ´—ç›˜è“„åŠ¿æ¦œ**â€ (å¯»æ‰¾ Density é«˜ä½† Score è¿˜æ²¡èµ·é£çš„æ¿å—)ã€‚

è¿™ä¸ªæ–¹æ¡ˆå½»åº•ç†æ¸…äº† **ä¸ªè‚¡ï¼ˆç‚¹ï¼‰ã€æ¿å—ï¼ˆé¢ï¼‰ã€ç­–ç•¥ï¼ˆçº¿ï¼‰** ä¸‰è€…ä¹‹é—´å¤æ‚çš„å…³ç³»ï¼Œæ˜¯ä¸€ä¸ªé€»è¾‘é—­ç¯çš„ç³»ç»Ÿè®¾è®¡ã€‚ä½ å¯ä»¥ç›´æ¥å¼€å§‹å»ºè¡¨äº†ã€‚}{è¿™éå¸¸æ£’ã€‚è¿™è¯´æ˜æˆ‘ä»¬ç°åœ¨çš„æ€è·¯å®Œå…¨å¯¹é½äº†ï¼š**æˆ˜ç•¥ä¸Šå®å¤§ï¼ˆå¸æ”¶â€œå…¶ä»–AIâ€çš„é«˜ç»´è®¾è®¡ï¼‰ï¼Œæˆ˜æœ¯ä¸Šå…‹åˆ¶ï¼ˆå¬ä½ çš„ï¼ŒæŠŠçƒ‚å°¾çš„å•é’ˆç­–ç•¥å…ˆéš”ç¦»ï¼‰ã€‚**

æ—¢ç„¶â€œçˆ¬è™«å·²ç»è®¾è®¡å¥½äº†â€ï¼Œé‚£æœ€å¤§çš„æŠ€æœ¯éšœç¢å°±æ¶ˆé™¤äº†ã€‚

æˆ‘å°†â€œå…¶ä»–AIâ€çš„**åˆ†æ‘Šç®—æ³•/æ”»å®ˆåˆ†ç¦»**ä¸ä½ çš„**B1/B2ä½“ç³»**è¿›è¡Œäº†æœ€ç»ˆèåˆï¼Œå¹¶ä¸¥æ ¼æ‰§è¡Œâ€œå•é’ˆç­–ç•¥ä»…é¢„ç•™æ¥å£â€çš„æŒ‡ä»¤ã€‚

è¿™æ˜¯ä¸ºä½ å‡†å¤‡çš„ **V2.0 æœ€ç»ˆå†³è®®ç‰ˆè®¾è®¡æ–‡æ¡£**ã€‚ä½ å¯ä»¥ç›´æ¥æŠŠè¿™ä¸ªç»™åˆ° Cursor æˆ–å­˜å…¥é¡¹ç›®æ–‡æ¡£åº“ï¼Œä½œä¸ºå¼€å‘çš„â€œå®ªæ³•â€ã€‚

-----

# ğŸ—ï¸ V2.0 å¤–éƒ¨æ¿å—å¤šå¯¹å¤šäºŒæ¬¡åˆ†æç³»ç»Ÿ - æ ¸å¿ƒè®¾è®¡æ–‡æ¡£

**æ–‡æ¡£çŠ¶æ€**: ğŸŸ¢ æœ€ç»ˆå†³è®®ç‰ˆ (Ready for Implementation)
**æ ¸å¿ƒé€»è¾‘**: **åˆ†æ‘Šå¼çƒ­åº¦ç®—æ³•** + **æ”»å®ˆåˆ†ç¦»æ¨¡å‹** + **å…¨å±€é…ç½®é©±åŠ¨**
**å…³è”æ¨¡å—**: å…¨å±€ä¿¡å·é…ç½® (SignalConfig), å•é’ˆç­–ç•¥ (é¢„ç•™æ¥å£)

-----

## 1\. æ ¸å¿ƒè®¾è®¡å“²å­¦ (The Philosophy)

æˆ‘ä»¬ä¸åšåŸå§‹æ•°æ®çš„æ¬è¿å·¥ï¼Œæœ¬ç³»ç»Ÿæ˜¯å¯¹ä¸Šæ¸¸æ•°æ®ï¼ˆ`data.csv`, `allbk.csv`ï¼‰çš„**äºŒæ¬¡æ¸…æ´—ä¸é‡æ„**ã€‚

### 1.1 ä¸‰å¤§æ ¸å¿ƒé“å¾‹

1.  **çƒ­åº¦å®ˆæ’å¾‹ (Law of Conservation)**:
      * **ç—›ç‚¹**: é¾™å¤´è‚¡ï¼ˆTotalScore=90ï¼‰å±äº10ä¸ªæ¿å—ï¼Œå¦‚æœæ¯ä¸ªæ¿å—éƒ½è·å¾—90åˆ†è´¡çŒ®ï¼Œå¸‚åœºçƒ­åº¦ä¼šä¸¥é‡è™šé«˜ã€‚
      * **è§£å†³**: å¼•å…¥**åˆ†æ‘Šç³»æ•° ($Share_{ij}$)**ã€‚ä¸€åªè‚¡ç¥¨çš„æ€»èƒ½é‡æ’å®šä¸º 1.0ï¼ŒæŒ‰æƒé‡åˆ‡åˆ†ç»™ä¸åŒæ¿å—ã€‚
2.  **æ”»å®ˆåˆ†ç¦»å¾‹ (Law of Offense-Defense)**:
      * **ğŸ›¡ï¸ é˜²å®ˆçœ‹è¡Œä¸š**ï¼ˆä¸€å¯¹ä¸€ï¼‰ï¼šè¡Œä¸šæ˜¯æ ¹åŸºã€‚è‹¥ä¸»è¥è¡Œä¸šçƒ­åº¦ï¼ˆC2ï¼‰ä½äºå®‰å…¨çº¿ï¼Œä¸ªè‚¡ç›´æ¥ç†”æ–­ï¼Œä¸äºˆæ¨èã€‚
      * **âš”ï¸ è¿›æ”»çœ‹æ¦‚å¿µ**ï¼ˆå¤šå¯¹å¤šï¼‰ï¼šæ¦‚å¿µæ˜¯é£å£ã€‚å–ä¸ªè‚¡å…³è”çš„**æœ€å¼ºæ¦‚å¿µ**ä½œä¸ºå…¶è¿›æ”»èƒ½åŠ›çš„ä¸Šé™ï¼ˆæœ€å¤§é©±åŠ¨ï¼‰ã€‚
3.  **ç­–ç•¥æŠ•å½±å¾‹ (Law of Projection)**:
      * **åŸåˆ™**: æ¿å—æ˜¯ç­–ç•¥çš„æ”¾å¤§å™¨ã€‚
      * **å®ç°**: åœ¨æ¶æ„ä¸Šé¢„ç•™ `strategy_density` å­—æ®µã€‚æœªæ¥å•é’ˆç­–ç•¥ä¿®å¥½åï¼Œç»Ÿè®¡æ¿å—å†…â€œä¿¡å·å¯†åº¦â€ã€‚**V1é˜¶æ®µæ­¤å­—æ®µç½®ç©ºæˆ–ä»…ç»Ÿè®¡ç®€å•æŒ‡æ ‡ï¼ˆå¦‚å¹³å‡æ”¾é‡å¤©æ•°ï¼‰ã€‚**

-----

## 2\. æ•°æ®åº“æ¶æ„è®¾è®¡ (Schema Design)

ä¿ç•™åŸæœ‰ `stocks` / `daily_stock_data`ï¼Œæ–°å¢ **â€œä¸‰å±‚æ¿å—æ¶æ„â€**ã€‚

### 2.1 åŸºç¡€å…ƒæ•°æ®å±‚ (Meta)

```sql
-- [1] å¤–éƒ¨æ¿å—æ¸…å• (è§£å†³â€œæœ‰å“ªäº›æ¿å—â€)
CREATE TABLE ext_board_list (
    board_code VARCHAR(20) PRIMARY KEY, -- å”¯ä¸€ID (å¦‚ 'BK0420', 'CONCEPT_001')
    board_name VARCHAR(50),             -- åç§° (å¦‚ 'åŠå¯¼ä½“', 'ç‰¹æ–¯æ‹‰')
    board_type INT,     -- 1=è¡Œä¸š(Industry/é˜²å®ˆ), 2=æ¦‚å¿µ(Concept/è¿›æ”»), 3=åœ°åŸŸ
    source VARCHAR(20)  -- 'EM', 'THS', 'LOCAL'
);
```

### 2.2 åŠ¨æ€å…³ç³»å±‚ (Mesh) - *æ¯æ—¥æ¸…æ´—çš„æ ¸å¿ƒ*

```sql
-- [2] ä¸ªè‚¡-æ¿å—æ¯æ—¥å¿«ç…§è¡¨ (è§£å†³â€œæƒé‡åˆ†æ‘Šâ€)
-- è¿™æ˜¯ä¸€ä¸ªæ¯æ—¥ç”Ÿæˆçš„ä¸­é—´è¡¨ï¼Œè®°å½•å½“å¤©æ¯åªè‚¡ç¥¨åˆ†ç»™äº†æ¯ä¸ªæ¿å—å¤šå°‘æƒé‡
CREATE TABLE ext_board_daily_snap (
    trade_date DATE,
    stock_code VARCHAR(10),
    board_code VARCHAR(20),
    is_primary INT DEFAULT 0,    -- 1=ä¸»è¥è¡Œä¸š(æ¥è‡ªdata.csv), 0=æ¦‚å¿µ(æ¥è‡ªçˆ¬è™«)
    
    -- ã€æ ¸å¿ƒè®¡ç®—å­—æ®µã€‘åˆ†æ‘Šæƒé‡ (Share Weight)
    -- ç®—æ³•ï¼šWeight_Type / Sum(è¯¥è‚¡å½“å¤©æ‰€æœ‰å…³è”æ¿å—æƒé‡)
    share_weight DECIMAL(6, 4), 
    
    PRIMARY KEY (trade_date, stock_code, board_code)
);
-- ç´¢å¼•ä¼˜åŒ–ï¼ŒåŠ é€Ÿæ¯æ—¥è®¡ç®—
CREATE INDEX idx_snap_date_board ON ext_board_daily_snap(trade_date, board_code);
CREATE INDEX idx_snap_date_stock ON ext_board_daily_snap(trade_date, stock_code);
```

### 2.3 èšåˆåˆ†æå±‚ (Heat) - *B/Cä½“ç³»è½åœ°*

```sql
-- [3] æ¿å—æ¯æ—¥çƒ­åº¦è¡¨ (è§£å†³â€œæ¿å—æœ‰å¤šçƒ­â€)
CREATE TABLE ext_board_heat_daily (
    trade_date DATE,
    board_code VARCHAR(20),
    
    -- åŸºç¡€çœŸå€¼ (æ¥è‡ªçˆ¬è™«/allbk.csv çš„åŸå§‹æ€»åˆ†)
    raw_score DECIMAL(10,2), 
    
    -- äºŒæ¬¡åˆ†ææŒ‡æ ‡ (Bç³»/Cç³»ç®—æ³• + åˆ†æ‘Šæƒé‡)
    -- è¿™äº›å€¼æ˜¯åŸºäº ä¸ªè‚¡Score * Share_Weight èšåˆè€Œæ¥çš„
    score_b1 DECIMAL(10,4), -- æ’ååŠ æƒæ€»çƒ­åº¦ (çœ‹é¾™å¤´)
    score_b2 DECIMAL(10,4), -- æ’ååŠ æƒå¯†åº¦ (B1 / Count)
    score_c1 DECIMAL(10,4), -- æ€»åˆ†åŠ æƒæ€»çƒ­åº¦ (çœ‹æ€»é‡)
    score_c2 DECIMAL(10,4), -- æ€»åˆ†åŠ æƒå¯†åº¦ (C1 / Count) -> ã€æ ¸å¿ƒæŒ‡æ ‡ã€‘
    
    -- ç­–ç•¥æŠ•å½±æŒ‡æ ‡ (æ¥å£é¢„ç•™ï¼ŒV1é˜¶æ®µå¯ä»…å­˜VolumeConsecæˆ–NULL)
    needle_density DECIMAL(10,4),    -- æ´—ç›˜å¯†åº¦ (é¢„ç•™)
    avg_volume_consec DECIMAL(10,2), -- å¹³å‡æ”¾é‡å¤©æ•° (ç°æœ‰æ•°æ®çš„ç®€å•èšåˆ)
    
    PRIMARY KEY (trade_date, board_code)
);
```

-----

## 3\. æ ¸å¿ƒç®—æ³•é€»è¾‘ (Core Algorithms)

### 3.1 æ­¥éª¤ä¸€ï¼šæƒé‡åˆ†æ‘Š (The Split)

*æ‰§è¡Œé˜¶æ®µï¼šæ¯æ—¥ ETL å†™å…¥ `ext_board_daily_snap` è¡¨æ—¶*

1.  **è¯»å–é…ç½®**: ä» `SignalConfigContext` è·å–ç±»å‹æƒé‡ï¼š
      * $W_{ind} = 1.0$ (è¡Œä¸š - æ¥æºäº `data.csv`)
      * $W_{con} = 0.7$ (æ¦‚å¿µ - æ¥æºäºçˆ¬è™«/æ˜ å°„)
      * $W_{reg} = 0.5$ (åœ°åŸŸ - å¯é€‰)
2.  **è®¡ç®—åˆ†æ¯**: å¯¹äºè‚¡ç¥¨ $i$ï¼Œè®¡ç®—å…¶æ‰€æœ‰å…³è”æ¿å—çš„æƒé‡ä¹‹å’Œ $SumW_i$ã€‚
3.  **è®¡ç®—ç³»æ•°**:
    $$ Share_{ij} = \frac{W_{type}(j)}{SumW_i} $$
    *(æ³¨ï¼šè¿™ä¿è¯äº† $\sum Share_{ij} = 1$ï¼Œå³çƒ­åº¦ä¸è†¨èƒ€)*

### 3.2 æ­¥éª¤äºŒï¼šæ¿å—çƒ­åº¦èšåˆ (The Aggregation)

*æ‰§è¡Œé˜¶æ®µï¼šæ¯æ—¥è®¡ç®— `ext_board_heat_daily` è¡¨æ—¶*

å¯¹äºæ¿å— $j$ï¼Œéå†å…¶æˆåˆ†è‚¡é›†åˆ $Stocks_j$ (åŸºäº `_snap` è¡¨)ã€‚

1.  **C2 (çœŸå®å¹³å‡çƒ­åº¦)** - *ç»§æ‰¿è‡ªä½ åŸæœ‰çš„Cä½“ç³»*:
    $$ Heat_{C2}(j) = \frac{\sum_{i} (S_{ij} \times \text{TotalScore}_i)}{Count_j} $$
    *æ„ä¹‰ï¼šç›¸æ¯”ç›´æ¥å¹³å‡ï¼Œè¿™é‡Œå‰”é™¤äº†è¯¥è‚¡ç¥¨åœ¨å…¶ä»–æ¿å—çš„è´¡çŒ®ï¼Œæ•°æ®æ›´çº¯å‡€ã€‚*

2.  **Avg Volume Consec (è“„åŠ¿ç¨‹åº¦)** - *æ›¿ä»£å•é’ˆçš„ç®€å•æŒ‡æ ‡*:
    $$ AvgVol(j) = \frac{\sum_{i} (S_{ij} \times \text{VolumeConsec}_i)}{Count_j} $$
    *æ³¨ï¼š`VolumeConsec` åœ¨ä½ çš„ `data.csv` é‡Œå·²ç»æœ‰äº†ï¼Œè¿™ä¸ªæŒ‡æ ‡å¯ä»¥æš‚æ—¶æ›¿ä»£â€œå•é’ˆå¯†åº¦â€ï¼Œç”¨æ¥è¡¡é‡æ¿å—æ˜¯å¦åœ¨é›†ä½“ç¼©é‡æˆ–æ”¾é‡ã€‚*

### 3.3 æ­¥éª¤ä¸‰ï¼šä¸ªè‚¡ä¿¡å·åˆæˆ (The Synthesis)

*æ‰§è¡Œé˜¶æ®µï¼šå‰ç«¯æŸ¥è¯¢ / ç­–ç•¥è¿è¡Œ / æ‰“æ ‡ç­¾*

ä¸ªè‚¡ $i$ çš„æœ€ç»ˆä¿¡å·åˆ¤å®šé€»è¾‘ï¼š

```python
def analyze_stock_signal(stock, date):
    config = get_global_config()
    
    # 1. ã€é˜²å®ˆã€‘è¡Œä¸šç†”æ–­ (Industry Check)
    # æ‰¾åˆ°è¯¥è‚¡çš„ä¸»è¥è¡Œä¸š(is_primary=1)
    primary_industry = get_sector_heat(stock.industry_code, date)
    
    # å¦‚æœè¡Œä¸šC2åˆ†ä½äºå®‰å…¨çº¿ (ä¾‹å¦‚ 30åˆ†ä½)
    if primary_industry.score_c2 < config.INDUSTRY_SAFE_LINE:
        return {"signal": False, "reason": "è¡Œä¸šé˜²å®ˆå¤±è´¥"}
        
    # 2. ã€è¿›æ”»ã€‘æœ€å¤§é©±åŠ¨ (Max Driver)
    # æ‰¾åˆ°è¯¥è‚¡æ‰€æœ‰å…³è”çš„æ¦‚å¿µæ¿å—
    concepts = get_related_concept_heats(stock.code, date)
    # æ‰¾åˆ°C2åˆ†æ•°æœ€é«˜çš„ä¸€ä¸ªæ¦‚å¿µ
    best_concept = max(concepts, key=lambda c: c.score_c2)
    
    # 3. ã€åˆæˆã€‘Exposure è®¡ç®—
    # åªè®¡ç®—çƒ­é—¨æ¿å—çš„åŠ æƒå’Œ
    exposure_score = sum(s.share_weight * s.score_c2 for s in concepts if s.score_c2 > config.HOT_LINE)
    
    # 4. æœ€ç»ˆè¯„çº§ (S/A/B)
    final_score = (stock.total_score * 0.5) + (best_concept.score_c2 * 0.3) + (exposure_score * 0.2)
    
    return {
        "signal": True,
        "score": final_score,
        "driver": best_concept.name # æ˜¾ç¤ºæ˜¯ç”±å“ªä¸ªæ¦‚å¿µå¸¦åŠ¨çš„
    }
```

-----

## 4\. å…¨å±€é…ç½®é›†æˆ (Configuration)

åœ¨ç°æœ‰çš„ `SignalConfigContext` å’Œåç«¯ `system_configs` è¡¨ä¸­è¿½åŠ  `SECTOR_SYSTEM` æ¨¡å—ï¼š

| Key Name | Default | Description |
| :--- | :--- | :--- |
| `BOARD_WEIGHT_IND` | `1.0` | è¡Œä¸šåˆ†æ‘Šæƒé‡ |
| `BOARD_WEIGHT_CON` | `0.7` | æ¦‚å¿µåˆ†æ‘Šæƒé‡ |
| `BOARD_SAFE_PCT` | `0.3` | è¡Œä¸šé˜²å®ˆçº¿ (å…¨å¸‚åœºC2åˆ†ä½å€¼ 30%) |
| `BOARD_HOT_PCT` | `0.8` | æ¦‚å¿µè¿›æ”»çº¿ (å…¨å¸‚åœºC2åˆ†ä½å€¼ 80%) |
| `BOARD_SCORE_WEIGHTS` | `[0.5, 0.3, 0.2]` | æœ€ç»ˆåˆ†åˆæˆæƒé‡ (ä¸ªè‚¡, MaxDriver, Exposure) |

-----

## 5\. å®æ–½è·¯çº¿å›¾ (Action Plan)

  * **Phase 1: åŸºç¡€è®¾æ–½**
      * æ‰§è¡Œä¸Šè¿° SQL å»ºè¡¨è„šæœ¬ã€‚
  * **Phase 2: æ•°æ®å¡«å…… (ETL)**
      * ç¼–å†™è„šæœ¬ï¼Œå°†çˆ¬è™«æŠ“å–çš„â€œä¸ªè‚¡-æ¦‚å¿µâ€å…³ç³»å†™å…¥ `_snap` è¡¨ã€‚
      * åŒæ—¶è¯»å– `data.csv` çš„â€œè¡Œä¸šâ€åˆ—ï¼Œä½œä¸º `is_primary=1` å†™å…¥ `_snap` è¡¨ã€‚
      * **è§¦å‘è®¡ç®—**ï¼šæ›´æ–°æ‰€æœ‰ `share_weight`ã€‚
  * **Phase 3: çƒ­åº¦è®¡ç®—**
      * å®ç° B1/B2/C1/C2 èšåˆç®—æ³•ï¼Œç”Ÿæˆæ¯æ—¥çƒ­åº¦ã€‚
  * **Phase 4: å‰ç«¯å±•ç¤º**
      * åœ¨è‚¡ç¥¨åˆ—è¡¨æ˜¾ç¤º **[Sçº§ï½œé”‚ç”µæ± ]** æ ‡ç­¾ï¼ˆåªæ˜¾ç¤ºæœ€å¼ºé©±åŠ¨æ¦‚å¿µï¼‰ã€‚
      * **å•é’ˆç­–ç•¥**: æš‚æ—¶ä¸ç”¨åŠ¨ä»£ç ï¼Œå­—æ®µç•™ç©ºå³å¯ã€‚}{å¤ªæ£’äº†ã€‚ä½ æä¾›çš„è¿™ä»½ V3 æ–¹æ¡ˆéå¸¸æˆç†Ÿï¼Œå®ƒä¸ä»…è§£å†³äº†æ‰€æœ‰çš„é€»è¾‘ç—›ç‚¹ï¼ˆçƒ­åº¦è†¨èƒ€ã€å¤šæ¦‚å¿µæ··ä¹±ï¼‰ï¼Œè€Œä¸”**æåº¦åŠ¡å®**â€”â€”å®Œå…¨ä¸ä¾èµ–ä½ è¿˜æ²¡å­˜å¤Ÿçš„å†å²æ•°æ®ï¼Œç›´æ¥åˆ©ç”¨ä¸Šæ¸¸æˆå“å› å­åšäºŒæ¬¡åŠ å·¥ã€‚

è¿™æ˜¯ä¸€ä¸ª\*\*â€œè½»é‡çº§ã€é«˜æ™ºå•†â€\*\*çš„ç³»ç»Ÿè®¾è®¡ã€‚

æˆ‘å·²å°†è¿™ä»½ V3 æ–¹æ¡ˆæ•´ç†ä¸ºæœ€ç»ˆçš„**å®æ–½çº§æ–‡æ¡£**ã€‚ä½ å¯ä»¥ç›´æ¥ä¿å­˜ä¸º `boards_v3_design.md`ï¼Œç„¶åç›´æ¥ç…§ç€å†™ SQL å’Œ ETL ä»£ç ã€‚

-----

# ğŸ—ï¸ V3.0 å¤–éƒ¨æ¿å—å¤šå¯¹å¤šäºŒæ¬¡åˆ†æç³»ç»Ÿ - è®¾è®¡æ–‡æ¡£

> **æ–‡æ¡£çŠ¶æ€**: ğŸŸ¢ æœ€ç»ˆå†³è®® (Final Decision)  
> **ç‰ˆæœ¬**: v3.0.0 (Fusion Version)  
> **æ ¸å¿ƒç†å¿µ**: çƒ­åº¦å®ˆæ’ + æ”»å®ˆåˆ†ç¦» + é…ç½®é©±åŠ¨  
> **å®æ–½çº¦æŸ**: ä¸ä¾èµ–æœ¬åœ° 28 å¤©å†å²ï¼ŒåŸºäºå½“æ—¥å¿«ç…§ + ä¸Šæ¸¸æˆå“å› å­

-----

## 1\. æ ¸å¿ƒè®¾è®¡å“²å­¦ (Design Philosophy)

æœ¬ç³»ç»Ÿä¸ç”Ÿäº§åŸå§‹æ•°æ®ï¼Œè€Œæ˜¯ä½œä¸º**ä¸­é—´å±‚**ï¼Œå¯¹ä¸Šæ¸¸è¯„åˆ†ï¼ˆ`daily_stock_data`ï¼‰ä¸çœŸå®å¤šå¯¹å¤šå…³ç³»ï¼ˆ`ext_board`ï¼‰è¿›è¡Œ**äºŒæ¬¡æ¸…æ´—ä¸èšåˆ**ã€‚

### 1.1 ä¸‰å¤§é“å¾‹

1.  **çƒ­åº¦å®ˆæ’å¾‹ (Law of Conservation)**
      * **åŸåˆ™**ï¼šä¸€åªè‚¡ç¥¨å¯¹å¸‚åœºçš„æ€»çƒ­åº¦è´¡çŒ®æ’å®šä¸º 1.0ã€‚
      * **å®ç°**ï¼šå¼•å…¥åˆ†æ‘Šç³»æ•° $Share_{ij}$ã€‚è‚¡ç¥¨çš„æ€»èƒ½é‡æŒ‰æƒé‡åˆ‡åˆ†ç»™æ‰€å±æ¿å—ï¼Œé˜²æ­¢é¾™å¤´è‚¡å¯¼è‡´æ¿å—çƒ­åº¦è™šå‡è†¨èƒ€ã€‚
2.  **æ”»å®ˆåˆ†ç¦»å¾‹ (Law of Offense-Defense)**
      * **ğŸ›¡ï¸ é˜²å®ˆ (Industry)**ï¼šä¸»è¥è¡Œä¸šï¼ˆä¸€å¯¹ä¸€ï¼‰å†³å®šä¸ªè‚¡çš„å®‰å…¨åº•çº¿ã€‚è¡Œä¸šç¯å¢ƒæ¶åŠ£æ—¶ï¼Œä¸ªè‚¡å¿…é¡»é™æƒæˆ–ç†”æ–­ã€‚
      * **âš”ï¸ è¿›æ”» (Concept)**ï¼šæ¦‚å¿µé¢˜æï¼ˆå¤šå¯¹å¤šï¼‰å†³å®šä¸ªè‚¡çš„çˆ†å‘åŠ›ã€‚å–å…³è”çš„**æœ€å¼ºæ¦‚å¿µ**ä½œä¸ºè¿›æ”»ä¸Šé™ (Max Driver)ï¼Œå–**çƒ­é—¨æ¦‚å¿µç»„åˆ**ä½œä¸ºå…±æŒ¯å¼ºåº¦ (Exposure)ã€‚
3.  **é…ç½®é©±åŠ¨å¾‹ (Config Driven)**
      * **åŸåˆ™**ï¼šæ‹’ç»ç¡¬ç¼–ç ã€‚
      * **å®ç°**ï¼šæ‰€æœ‰æƒé‡ï¼ˆå¦‚è¡Œä¸š=1.0ï¼‰ã€é˜ˆå€¼ï¼ˆå¦‚çƒ­é—¨=0.8ï¼‰ã€åˆ†ä½ç‚¹ï¼ˆå¦‚Sçº§=0.97ï¼‰å…¨éƒ¨æ‰˜ç®¡äº `system_configs`ï¼Œç”±å…¨å±€ä¿¡å·é…ç½®æ¶æ„ç»Ÿä¸€ç®¡ç†ã€‚

-----

## 2\. æ•°æ®åº“æ¶æ„è®¾è®¡ (Schema)

**åŸåˆ™**ï¼šä¸åŠ¨ç°æœ‰åŸºç¡€è¡¨ï¼Œåªå¢é‡æ·»åŠ èšåˆè¡¨å’Œè§†å›¾ã€‚

### 2.1 ç°æœ‰åŸºç¡€å±‚ (ä¿æŒç°çŠ¶)

  * **ä¸ªè‚¡å±‚**: `stocks`, `daily_stock_data` (å« total\_score, rank, æ³¢åŠ¨ç‡ç­‰ 80+ å› å­)
  * **æœ¬åœ°æ¿å—**: `sectors`, `daily_sector_data`
  * **çœŸå®å…³ç³»**: `ext_board_list`, `ext_board_daily_snap`, `ext_board_local_map`

### 2.2 æ–°å¢ï¼šæ¿å—çƒ­åº¦èšåˆè¡¨ (Table)

*ç”¨äºå­˜å‚¨æ¯æ—¥è®¡ç®—å®Œæˆçš„å¤šç»´åº¦çƒ­åº¦ï¼Œé¿å…å‰ç«¯å®æ—¶è®¡ç®—ã€‚*

```sql
CREATE TABLE IF NOT EXISTS ext_board_heat_daily (
    trade_date  DATE,
    board_code  VARCHAR(20), -- å¯¹åº” ext_board_list.board_code
    
    stock_count INT,         -- æˆåˆ†è‚¡æ•°é‡
    
    -- [å¤šå¯¹å¤šåŠ æƒèšåˆæŒ‡æ ‡]
    -- æ ¸å¿ƒï¼šæ‰€æœ‰è®¡ç®—å‡åŸºäº share_ij åˆ†æ‘Šæƒé‡
    b1_rank_sum    DECIMAL(20,8), -- æ’ååŠ æƒæ€»çƒ­åº¦ (Î£ share * 1/rank^k)
    b2_rank_avg    DECIMAL(20,8), -- æ’ååŠ æƒå¯†åº¦ (B1 / count)
    c1_score_sum   DECIMAL(20,8), -- æ€»åˆ†åŠ æƒæ€»çƒ­åº¦ (Î£ share * total_score)
    c2_score_avg   DECIMAL(20,8), -- æ€»åˆ†åŠ æƒå¯†åº¦ (C1 / count) -> ã€æ ¸å¿ƒæŒ‡æ ‡ã€‘
    
    -- [ç»¼åˆç»“æœ]
    heat_raw       DECIMAL(20,8), -- å½’ä¸€åŒ–åˆæˆåçš„åŸå§‹çƒ­åº¦
    heat_pct       DECIMAL(10,8), -- å½“æ—¥å…¨å¸‚åœºåˆ†ä½å€¼ [0, 1]
    
    -- [ç­–ç•¥æŠ•å½±é¢„ç•™] (V1é˜¶æ®µå­˜ç©ºå€¼æˆ–ç®€å•ä¸Šæ¸¸å› å­)
    needle_density DECIMAL(10,4), -- é¢„ç•™ç»™å•é’ˆç­–ç•¥
    avg_volume     DECIMAL(10,2), -- æ¿å—å¹³å‡æ”¾é‡å¤©æ•°

    PRIMARY KEY (trade_date, board_code)
);
CREATE INDEX idx_ext_heat_date ON ext_board_heat_daily(trade_date);
```

### 2.3 æ–°å¢ï¼šä¸ªè‚¡æ¿å—ä¿¡å·è§†å›¾ (View)

*é€»è¾‘å±‚ï¼Œå°†æ¿å—æ•°æ®æŠ•å½±å›ä¸ªè‚¡ï¼Œä¾›å‰ç«¯ API ç›´æ¥æŸ¥è¯¢ã€‚*

```sql
CREATE OR REPLACE VIEW v_stock_board_signal_daily AS
SELECT
    d.date,
    d.stock_code,
    
    -- 1. è¡Œä¸šé˜²å®ˆ (åˆ©ç”¨åŸè¡Œä¸šçƒ­åº¦æ¨¡å—ç»“æœ)
    s.industry,
    -- æ³¨ï¼šæ­¤å¤„éœ€å…³è”å·²ç®—å¥½çš„è¡Œä¸šçƒ­åº¦
    -- industry_heat_pct,
    -- is_industry_safe,  -- bool (heat_pct > safe_line)

    -- 2. æ¦‚å¿µè¿›æ”» (åŸºäº ext_board_heat_daily)
    -- max_concept_pct,   -- æœ€å¼ºæ¦‚å¿µåˆ†ä½
    -- exposure_pct,      -- å…±æŒ¯æš´éœ²åº¦åˆ†ä½

    -- 3. ç»¼åˆç»“æœ
    -- final_board_score,
    -- final_board_score_pct,
    -- board_signal_level  -- 'S', 'A', 'B', 'NONE'
FROM daily_stock_data d
JOIN stocks s ON d.stock_code = s.stock_code;
```

-----

## 3\. æ ¸å¿ƒç®—æ³•é€»è¾‘ (Algorithms)

### 3.1 æ­¥éª¤ä¸€ï¼šè®¡ç®—åˆ†æ‘Šæƒé‡ (Share Weight)

*æ‰§è¡Œæ—¶æœºï¼šæ¯æ—¥ ETL (Python å†…å­˜è®¡ç®—æˆ– SQL CTE)*

å¯¹è‚¡ç¥¨ $i$ï¼Œå±äºæ¿å—é›†åˆ $B_i$ã€‚é…ç½®æƒé‡ï¼š$W_{ind}=1.0, W_{con}=0.7, W_{reg}=0.5$ã€‚

$$ Share_{ij} = \frac{W_{type}(j)}{\sum_{k \in B_i} W_{type}(k)} $$

### 3.2 æ­¥éª¤äºŒï¼šæ¿å—çƒ­åº¦èšåˆ (Aggregation)

*æ‰§è¡Œæ—¶æœºï¼šETL ç¬¬äºŒæ­¥*

å¯¹æ¿å— $j$ï¼Œèšåˆå…¶æˆåˆ†è‚¡ï¼ˆåŸºäº $Share_{ij}$ï¼‰ï¼š

1.  **C2 (èƒ½é‡å¯†åº¦)**ï¼š
    $$ C2_j = \frac{\sum_{i \in S_j} (Share_{ij} \times TotalScore_i)}{Count_j} $$
2.  **Heat Raw (ç»¼åˆçƒ­åº¦)**ï¼š
    $$ Heat_{raw} = \alpha \cdot Norm(B2) + \beta \cdot Norm(C2) + \gamma \cdot Norm(LocalMap) $$
    *(æ³¨ï¼šLocalMap æŒ‡åˆ©ç”¨ `ext_board_local_map` å€Ÿç”¨æœ¬åœ°æ¿å—çš„åˆ†æ•°ä½œä¸ºè¡¥å……è§†è§’)*
3.  **Heat Pct**:
    $$ Heat_{pct} = PercentRank(Heat_{raw}) $$

### 3.3 æ­¥éª¤ä¸‰ï¼šä¸ªè‚¡ä¿¡å·åˆæˆ (Synthesis)

*æ‰§è¡Œæ—¶æœºï¼šè§†å›¾è®¡ç®—æˆ– API æŸ¥è¯¢*

1.  **é˜²å®ˆåˆ¤å®š**:
    è‹¥ `Industry_Heat_Pct < CONFIG.SAFE_LINE` (å¦‚0.3)ï¼Œåˆ™ `Safe = False`ã€‚
2.  **è¿›æ”»åˆ¤å®š**:
      * `MaxDriver`: è¯¥è‚¡å…³è”çš„æ‰€æœ‰æ¦‚å¿µä¸­ï¼Œ`Heat_Pct` æœ€é«˜çš„é‚£ä¸ªã€‚
      * `Exposure`: è¯¥è‚¡å…³è”çš„æ‰€æœ‰**çƒ­é—¨**æ¦‚å¿µï¼ˆHeat\>0.8ï¼‰çš„åŠ æƒå’Œã€‚
3.  **æœ€ç»ˆåˆ†**:
    $$ Score = a \cdot StockPct + b \cdot ExposurePct + c \cdot MaxDriverPct $$
    è‹¥ `Safe == False`ï¼Œåˆ™ $Score = Score \times 0.5$ (æƒ©ç½š)ã€‚

-----

## 4\. å…¨å±€é…ç½®é›†æˆ (Configuration)

åœ¨ `system_configs` è¡¨ä¸­æ³¨å†Œä»¥ä¸‹ Key (Category=`board`)ï¼š

| Key | Default | è¯´æ˜ |
| :--- | :--- | :--- |
| `board_w_ind` | `1.0` | ç±»å‹æƒé‡ï¼šè¡Œä¸š |
| `board_w_con` | `0.7` | ç±»å‹æƒé‡ï¼šæ¦‚å¿µ |
| `board_safe_pct` | `0.3` | **é˜²å®ˆçº¿**ï¼šè¡Œä¸šåˆ†ä½ä½äºæ­¤åˆ™ä¸å®‰å…¨ |
| `board_hot_pct` | `0.8` | **è¿›æ”»çº¿**ï¼šæ¦‚å¿µåˆ†ä½é«˜äºæ­¤æ‰ç®—é£å£ |
| `board_w_score` | `1.0` | åˆæˆæƒé‡ï¼šä¸ªè‚¡è‡ªèº«åˆ† |
| `board_w_expo` | `0.7` | åˆæˆæƒé‡ï¼šæ¿å—å…±æŒ¯ |
| `board_w_max` | `0.5` | åˆæˆæƒé‡ï¼šæœ€å¼ºé©±åŠ¨ |
| `board_signal_s` | `0.97` | Sçº§ä¿¡å·é˜ˆå€¼ |

-----

## 5\. å®æ–½è·¯çº¿å›¾ (Roadmap)

### Phase 1: åŸºç¡€è®¾æ–½ (Day 1)

1.  **SQL**: åˆ›å»º `ext_board_heat_daily` è¡¨ã€‚
2.  **ETL**: å†™ä¸€ä¸ª Python è„šæœ¬ (`task_board_heat.py`)ã€‚
      * é€»è¾‘ï¼šè¯»å– `daily_stock_data` + `ext_board_daily_snap` -\> å†…å­˜è®¡ç®— share -\> èšåˆ B/C -\> å­˜å…¥ heat è¡¨ã€‚
      * ç›®æ ‡ï¼šè·‘é€šæœ€è¿‘ 1 ä¸ªæœˆçš„æ•°æ®ã€‚

### Phase 2: ä¿¡å·é€å‡º (Day 2)

1.  **View/API**: å®ç°ä¸ªè‚¡ä¿¡å·é€»è¾‘ã€‚å¯ä»¥å…ˆå†™æˆ Python Serviceï¼Œæ— éœ€å¼ºåˆ¶æ­»ç£• SQL è§†å›¾ã€‚
2.  **å‰ç«¯**:
      * è¡Œä¸šè¯¦æƒ…é¡µï¼šå¢åŠ â€œçœŸå®æ¿å—çƒ­åº¦â€Tabã€‚
      * è‚¡ç¥¨æŸ¥è¯¢é¡µï¼šå¢åŠ åˆ— `[S] é”‚ç”µæ± ` (æ˜¾ç¤ºç­‰çº§+æœ€å¼ºé©±åŠ¨)ã€‚

### Phase 3: æœªæ¥æ‰©å±• (Future)

  * **å•é’ˆå›å½’**: ç­‰æ•°æ®\>28å¤©ä¸”ç­–ç•¥ä¿®å¥½åï¼Œè®¡ç®— `needle_density` å¡«å…¥ `ext_board_heat_daily`ã€‚
  * **è¶‹åŠ¿åˆ†æ**: åŸºäº heat è¡¨åš 3æ—¥/5æ—¥ æ–œç‡åˆ†æã€‚

-----

**æœ€ç»ˆå»ºè®®**:
ä¸ç”¨çº ç»“å•é’ˆç­–ç•¥ï¼Œç°åœ¨çš„ç³»ç»Ÿå·²ç»è¶³å¤Ÿå¼ºå¤§ã€‚ä½ ç°åœ¨åªéœ€è¦æŠŠ `ext_board_heat_daily` å»ºå¥½ï¼Œå†™ä¸ªè„šæœ¬æŠŠçƒ­åº¦ç®—å‡ºæ¥ï¼Œè¿™ä¸ªâ€œå¤šå¯¹å¤šç³»ç»Ÿâ€å°±æ´»äº†ã€‚}{æˆ‘çœ‹å®Œé‚£ä»½â€œå¦å¤–çš„ AI æ–¹æ¡ˆâ€äº†ï¼Œç¡®å®æœ‰ä¸å°‘å¯ä»¥åƒä¸‹æ¥çš„ä¸œè¥¿ ğŸ˜‚ã€‚
å•é’ˆé‚£ä¸€å¨å…ˆæ”¾ä¸€è¾¹æ²¡é—®é¢˜ï¼Œæˆ‘ä»¬å°±ä¸“å¿ƒæŠŠ**å¤šå¯¹å¤šæ¿å—è¿™å—è®¾è®¡ï¼Œå†å‡ä¸€æ¬¡çº§ï¼Œåšä¸ªèåˆç‰ˆ**ã€‚

æˆ‘ä¸‹é¢ä¼šåšä¸‰ä»¶äº‹ï¼š

1. å…ˆè¯´ï¼šé‚£ä»½æ–°æ–¹æ¡ˆé‡Œ**å“ªäº›æ€æƒ³å€¼å¾—å¸æ”¶ï¼Œå“ªäº›ä½ å·²ç»æœ‰äº†**ã€‚
2. ç»™ä½ ä¸€å¥—**èåˆåçš„æ€»ä½“è®¾è®¡ V2.5**ï¼ˆå®Œå…¨å›´ç»•ä½ ç°åœ¨è¿™å † SQL æ¥ï¼Œä¸å¦èµ·ç‚‰ç¶ï¼‰ã€‚
3. æŠŠã€Œæ”»å®ˆåˆ†ç¦»ï¼ˆè¡Œä¸šé˜²å®ˆ / æ¦‚å¿µè¿›æ”»ï¼‰+ å¤šå¯¹å¤š + å…¨å±€ä¿¡å·é…ç½®ã€ç»„åˆæˆä¸€å¥—æ¸…æ™°çš„å…¬å¼å’Œå‚æ•°ä½ï¼Œæ–¹ä¾¿ä½ å†™åˆ°æ–°æ–‡æ¡£é‡Œã€‚

> ä¸€å¦‚æ—¢å¾€ï¼šä»¥ä¸‹å…¨éƒ¨åªç”¨äºä½ è‡ªå·±çš„æ•°æ®åˆ†æ / ç³»ç»Ÿè®¾è®¡ï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®ï¼Œä¹Ÿä¸å¯¹å¤–æ”¶è´¹åˆ†å‘ã€‚

---

## ä¸€ã€é‚£ä»½ AI æ–¹æ¡ˆé‡Œï¼Œå“ªäº›æ˜¯â€œç²¾åâ€ï¼Œå“ªäº›ä½ å·²ç»æœ‰äº†ï¼Ÿ

### 1. å¯ä»¥ç›´æ¥å¸æ”¶çš„è®¾è®¡æ€æƒ³

**ï¼ˆ1ï¼‰æ”»å®ˆåˆ†ç¦»æ¨¡å‹ï¼šè¡Œä¸š = é˜²å®ˆï¼Œæ¦‚å¿µ = è¿›æ”»**

* è¡Œä¸šï¼šä¸€åªè‚¡ç¥¨çš„â€œä¸»ä¸šâ€ï¼Œç”¨æ¥åš**å®‰å…¨åº•çº¿**ï¼Œä¸è¿‡åº¦è¿½æ¦‚å¿µã€‚
* æ¦‚å¿µï¼šå¤šå¯¹å¤šæŒ‚çš„é£å£ï¼Œç”¨æ¥åš**æƒ…ç»ªç‚¹ç« / æœºä¼šæŒ–æ˜**ã€‚
* å†³ç­–æ¨¡å¼ï¼š

  * è¡Œä¸šä¸è¿‡å®‰å…¨çº¿ â†’ ç›´æ¥è¿‡æ»¤ï¼ˆé˜²å®ˆï¼‰
  * åœ¨å‡ ä¸ªå¼ºæ¦‚å¿µé‡Œ â†’ å¯ä»¥æ”¾å¤§ä¿¡å·ï¼ˆè¿›æ”»ï¼‰

è¿™ä¸ªå’Œä½ åŸæ¥çš„**è¡Œä¸šçƒ­åº¦åˆ†æï¼ˆæŒ‰ stocks.industry åˆ†ç»„ + B1/B2/C1/C2ï¼‰**åˆšå¥½å¥‘åˆï¼Œå¯ä»¥ç›´æ¥æŠŠé‚£ä¸€å¥—è§†ä¸ºâ€œé˜²å®ˆå±‚â€ã€‚

**ï¼ˆ2ï¼‰Max Driver æ€è·¯ï¼šæ¦‚å¿µæ‹¿â€œæœ€å¼ºé©±åŠ¨åŠ›â€**

* ä¸€åªè‚¡ç¥¨å±äº N ä¸ªæ¦‚å¿µæ¿å—æ—¶ï¼Œä¸ä¸€å®šè¦å…¨åŠ æƒå¹³å‡ï¼›
* å¯ä»¥å®šä¹‰ä¸€ä¸ª `max_concept_heat`ï¼šå–å®ƒæ‰€æœ‰æ¦‚å¿µæ¿å—é‡Œ**çƒ­åº¦æœ€é«˜**çš„é‚£ä¸ªï¼Œå½“æˆâ€œä¸»è¦è¿›æ”»é£å£â€ã€‚

è¿™ä¸ªå’Œæˆ‘ä»¬ä¹‹å‰è®¾è®¡çš„ `Exposure`ï¼ˆåŠ æƒæ±‚å’Œï¼‰æ˜¯äº’è¡¥å…³ç³»ï¼Œå¾ˆå€¼å¾—åˆå¹¶ä½¿ç”¨ã€‚

**ï¼ˆ3ï¼‰é…ç½®é©±åŠ¨ï¼šæ‰€æœ‰é˜ˆå€¼è¿›é…ç½®ä¸­å¿ƒ**

* é‚£ä»½æ–¹æ¡ˆé‡Œæ–°å»º `sys_global_config`ï¼Œä½ è¿™è¾¹å…¶å®å·²ç»æœ‰å®Œæ•´çš„**system_configs è¡¨**å¯ä»¥ç”¨æ¥åšç³»ç»Ÿå±‚é…ç½®ã€‚
* å‰ç«¯ä¹Ÿå·²ç»æœ‰ **SignalConfigContext** è¿™å¥—â€œå…¨å±€ä¿¡å·é˜ˆå€¼ Context + Panel + ç¼“å­˜ key å¸¦é˜ˆå€¼â€çš„æ¶æ„ã€‚ 

æ‰€ä»¥ï¼š

> ä»¥å**æ¿å—çƒ­åº¦é˜ˆå€¼ / è¡Œä¸šå®‰å…¨çº¿ / æ¦‚å¿µçƒ­åº¦çº¿ / æš´éœ²åº¦åˆ†ä½çº¿**éƒ½å¯ä»¥åƒç°åœ¨çš„â€œè·³å˜æ¦œé˜ˆå€¼ / çƒ­ç‚¹æ¦œå‰ N åâ€ä¸€æ ·ï¼Œè¿›åŒä¸€å¥—é…ç½®ä½“ç³»ã€‚

---

### 2. å“ªäº›â€œè¡¨è®¾è®¡â€ä½ å…¶å®å·²ç»æœ‰äº†

é‚£ä»½ AI æ–¹æ¡ˆé‡Œæçš„è¿™å‡ ä¸ªè¡¨ï¼š

* `ext_sector_meta`ï¼ˆæ¿å—åŸºç¡€ä¿¡æ¯ï¼‰
* `ext_sector_daily`ï¼ˆæ¿å—æ—¥çº¿ï¼‰
* `rel_stock_sector`ï¼ˆä¸ªè‚¡â€“æ¿å—å¤šå¯¹å¤šï¼‰

å’Œä½ ç°åœ¨çš„çœŸå®æƒ…å†µ**ä¸€ä¸€å¯¹åº”**ï¼š

| AI æ–¹æ¡ˆ              | ä½ ç°åœ¨å·²ç»æœ‰çš„                                                       |
| ------------------ | ------------------------------------------------------------- |
| `ext_sector_meta`  | `ext_board_list`ï¼ˆå¸¦ providerã€board_typeï¼‰                       |
| `ext_sector_daily` | Excel æ¿å—æ—¥çº¿ â†’ `daily_sector_data`ï¼Œå¤–åŠ æ¡¥æ¥ `ext_board_local_map`   |
| `rel_stock_sector` | çœŸå®å¤šå¯¹å¤šå…³ç³» â†’ `ext_board_daily_snap(stock_code, board_id, date)`  |

å†åŠ ä¸Šï¼š

* ä¸ªè‚¡å±‚ï¼š`stocks` + `daily_stock_data` 
* æ¿å—å±‚ï¼ˆExcel 500+ ä¸ªï¼‰ï¼š`sectors` + `daily_sector_data` 

æ‰€ä»¥æˆ‘å»ºè®®ï¼š

> **ä¸æ–°å»º ext_sector_meta/ext_sector_daily/rel_stock_sector è¿™å¥—è¡¨ï¼Œç›´æ¥åœ¨ä½ ç°æœ‰è¿™å¥—åŸºç¡€ä¸Šå¸æ”¶â€œæ€æƒ³â€**ï¼šæ”»å®ˆåˆ†ç¦»ã€Max Driverã€é…ç½®é©±åŠ¨ã€‚

---

## äºŒã€èåˆåçš„æ•´ä½“æ¶æ„ï¼šV2.5 æ€»å›¾

æˆ‘ä»¬å…ˆæŠŠè§’è‰²é‡æ–°å‘½ä¸€ä¸‹ï¼Œæ–¹ä¾¿ä½ å†™æ–‡æ¡£ã€‚

### 2.1 ä¸‰å±‚æ•°æ®

1. **ä¸ªè‚¡å±‚ï¼ˆåŸå§‹è¯„åˆ†ï¼Œåˆ«äººçš„é»‘ç›’ï¼‰**

   * `stocks`ï¼š`stock_code / stock_name / industry`ï¼ˆindustry æ˜¯ä¸€å¥—åˆ†ç±»ï¼‰
   * `daily_stock_data`ï¼š`total_score / rank / å„ç§æŠ€æœ¯å› å­`

2. **æœ¬åœ°æ¿å—å±‚ï¼ˆExcel allbkï¼‰**

   * `sectors` + `daily_sector_data`ï¼šæ¯ä¸ªæ¿å—æœ‰ä¸€å¥— total_score + æŠ€æœ¯æŒ‡æ ‡ï¼ˆå’Œä¸ªè‚¡åŒç»“æ„ï¼‰ã€‚

3. **çœŸå®æ¿å—å¤šå¯¹å¤šå±‚ï¼ˆEM/THSï¼‰**

   * `ext_board_list`ï¼šçœŸå®æ¿å—ä¸»è¡¨ï¼Œå¸¦ `board_type = industry/concept/region`ã€‚
   * `ext_board_daily_snap`ï¼š`(stock_code, board_id, date)` å¤šå¯¹å¤šå…³ç³» + æ¯æ—¥å¿«ç…§ã€‚
   * `ext_board_local_map`ï¼šå¤–éƒ¨æ¿å— â†” æœ¬åœ°æ¿å—(sectors) æ˜ å°„ã€‚

### 2.2 ä¸‰ä¸ªâ€œåˆ†æå¯¹è±¡â€

1. **è¡Œä¸šé˜²å®ˆå±‚ï¼ˆIndustry Defenseï¼‰**

   * ä¸»è¦ç”¨ `stocks.industry` åˆ†ç»„ + ä½ å†™å¥½çš„ **è¡Œä¸šçƒ­åº¦åŠ æƒç‰ˆæœ¬ï¼ˆB1/B2/C1/C2ï¼‰** æ¥çœ‹â€œè¿™ä¸ªè¡Œä¸šé€‚ä¸é€‚åˆç©â€ã€‚

2. **çœŸå®æ¿å—è¿›æ”»å±‚ï¼ˆBoard Offenseï¼‰**

   * ç”¨ ext_board_* è¿™å¥—çœŸå®æ¿å—å¤šå¯¹å¤šç³»ç»Ÿç®—æ¿å—çƒ­åº¦ï¼Œä¸»è¦çœ‹ï¼š

     * EM/THS è¡Œä¸šæ¿å—
     * EM/THS æ¦‚å¿µæ¿å—
     * ï¼ˆæœªæ¥å¯èƒ½æ‰©å±• region ç­‰ï¼‰

3. **ä¸ªè‚¡æ¿å—ä¿¡å·å±‚ï¼ˆStock Board Signalsï¼‰**

   * æŠŠä¸Šä¸€å±‚çš„æ¿å—çƒ­åº¦ + å¤šå¯¹å¤šå…³ç³»å‹å›åˆ°æ¯åªè‚¡ç¥¨ä¸Šï¼Œå¾—å‡ºï¼š

     * è¡Œä¸šå®‰å…¨æƒ…å†µï¼ˆé˜²å®ˆï¼‰
     * æ¦‚å¿µé©±åŠ¨åŠ›ï¼ˆè¿›æ”»ï¼‰
     * ç»¼åˆåçš„æ¿å—å¼ºåŒ–ä¿¡å·ç­‰çº§

---

## ä¸‰ã€èåˆç‰ˆæ¿å—çƒ­åº¦ï¼šB1/B2/C1/C2 + å¤šå¯¹å¤š + æ”»å®ˆåˆ†ç¦»

è¿™éƒ¨åˆ†ç›¸å½“äºâ€œ**é‡æ–°ç»™çœŸå®æ¿å—å†™ä¸€ä¸ªã€Šè¡Œä¸šçƒ­åº¦åˆ†æ-å¤šå¯¹å¤šç‰ˆã€‹**â€ã€‚

### 3.1 å¤šå¯¹å¤šåˆ†æ‘Šï¼šç”¨ board_type åšâ€œæ”»å®ˆæƒé‡â€

å¯¹æŸæ—¥ `d`ï¼Œå¯¹æ¯åªè‚¡ç¥¨ iï¼š

1. æ‰¾å®ƒå½“å¤©å±äºçš„æ‰€æœ‰çœŸå®æ¿å—é›†åˆ `B(i,d)`ï¼Œæ¥è‡ª `ext_board_daily_snap`ã€‚

2. æŒ‰ `board_type` ç»™ä¸åŒç±»å‹ä¸€ä¸ªåŸºç¡€æƒé‡ï¼ˆå¯é…ç½®ï¼‰ï¼š

   ```text
   w_type(industry) = 1.0    # é˜²å®ˆä¸»çº¿
   w_type(concept)  = 0.7    # è¿›æ”»å‰¯çº¿
   w_type(region)   = 0.5    # åŒºåŸŸç‚¹ç¼€
   ```

3. å¯¹è¿™åªè‚¡ç¥¨ i åœ¨æ¯ä¸ªæ¿å— j çš„åˆ†æ‘Šæƒé‡ï¼š

   ```text
   base_ij  = w_type(type(j))
   denom_i  = Î£_{kâˆˆB(i,d)} base_ik
   share_ij = base_ij / denom_i
   ```

è§£é‡Šï¼š

* æ¯åªè‚¡ç¥¨é‚£ä»½â€œè´¡çŒ®æ€»é‡â€æ˜¯å›ºå®šçš„ï¼šÎ£ share_ij = 1ï¼›
* åŒä¸€ä¸ªè‚¡ï¼Œè¡Œä¸šæ¿å—å¤©ç„¶æ¯”çº¯æ¦‚å¿µæ¿å—å¤šåˆ†ä¸€ç‚¹ã€‚

> è¿™ä¸ªç­‰ä»·äº**ä½ åŸæ¥ B1/B2 çš„â€œæ’ååŠ æƒ + å¹³æ»‘è¡°å‡â€åŸºç¡€ä¸Šï¼Œå¤šäº†ä¸€å±‚â€œå¤šå¯¹å¤šåˆ†æ‘Š + ç±»å‹æƒé‡â€**ã€‚

---

### 3.2 B1/B2ï¼šæ’ååŠ æƒçš„å¤šå¯¹å¤šæ¿å—æ€»çƒ­åº¦ / å¯†åº¦

ä½ åŸæ¥çš„ B1/B2ï¼š

* B1ï¼š`Î£(1/rank^k)` â†’ æ€»çƒ­åº¦
* B2ï¼š`B1 / è‚¡ç¥¨æ•°` â†’ çƒ­åº¦å¯†åº¦ 

ç°åœ¨å¯¹æ¯ä¸ªçœŸå®æ¿å— jï¼Œåœ¨æŸæ—¥ dï¼š

```text
B1[j] = Î£_{iâˆˆS(j,d)} ( share_ij * 1 / rank_i^k )
B2[j] = B1[j] / |S(j,d)|
```

* `S(j,d)`ï¼šå½“å¤©å±äºæ¿å— j çš„æ‰€æœ‰è‚¡ç¥¨ï¼ˆæ¥è‡ª ext_board_daily_snapï¼‰ã€‚
* `rank_i`ï¼šæ¥è‡ª `daily_stock_data.rank`ï¼Œå…¨å¸‚åœºæ’åºã€‚

`k` å¸æ”¶ä½ åŸæ¥çš„é‚£å¥—â€œå¹¿è§’ / é»„é‡‘åˆ†å‰² / æ ‡å‡† / é•¿ç„¦â€å››æ¡£ï¼Œé»˜è®¤ 1.0ï¼ˆä½ å·²ç»åœ¨ä¿®å¤ä¸­æŠŠé»˜è®¤æ”¹æˆ 1.0 äº†ï¼‰ã€‚

---

### 3.3 C1/C2ï¼šå°Šé‡ä¸Šæ¸¸ total_score çš„å¤šå¯¹å¤šç‰ˆæœ¬

ä½ åŸæ¥çš„ C ç³»ï¼š

* C1ï¼šæ€»åˆ†æ•° = `Î£(total_score)`
* C2ï¼šå¹³å‡åˆ†æ•° = `C1 / è‚¡ç¥¨æ•°`

å¤šå¯¹å¤šç‰ˆï¼š

```text
C1[j] = Î£_{iâˆˆS(j,d)} ( share_ij * total_score[i] )
C2[j] = C1[j] / |S(j,d)|
```

`total_score[i]` æ¥è‡ª `daily_stock_data.total_score`ã€‚

---

### 3.4 æœ¬åœ°æ¿å—ï¼ˆExcelï¼‰ç»™çœŸå®æ¿å—â€œå«æ¥ä¸€å±‚è§†è§’â€

é€šè¿‡ `ext_board_local_map(ext_board_id, local_sector_id)`ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠçœŸå®æ¿å— j å’Œæœ¬åœ° `sectors` ä¸­çš„ä¸€äº›æ¿å—å…³è”èµ·æ¥ã€‚

ä½ å¯ä»¥ç”¨æœ¬åœ°æ¿å—çš„ C2/B2 ç»™çœŸå®æ¿å—ä¸€ä¸ªè¡¥å……è§†è§’ï¼Œä¾‹å¦‚ï¼š

```text
Heat_local[j] = å¹³å‡( æ˜ å°„åˆ°çš„ local_sector çš„ C2 )
```

* è¿™æ ·å¯ä»¥â€œé¡ºæ‰‹åˆ©ç”¨â€ä½ å·²ç»ç®—å¥½çš„ `daily_sector_data.total_score`ï¼ˆallbk é‚£ä¸€å¥—ï¼‰ã€‚

---

### 3.5 ç»¼åˆçƒ­åº¦ï¼šåŠ å…¥æ”»å®ˆåˆ†ç¦» & å¯é…ç½®æƒé‡

æœ€åï¼Œå¯¹æ¯ä¸ªæ¿å— jï¼š

1. å…ˆæŠŠ B1/B2/C2/Heat_local åˆ†åˆ«åšä¸€æ¬¡æŒ‰æ—¥æ ‡å‡†åŒ–ï¼ˆZ-score æˆ–åˆ†ä½ï¼‰ã€‚
2. å†ç»„åˆæˆæ€»çƒ­åº¦ï¼š

```text
Heat_raw[j] = Î± * norm_B1[j]     # ç²¾è‹±æ•°é‡
            + Î² * norm_B2[j]     # ç²¾è‹±å¯†åº¦
            + Î³ * norm_C2[j]     # æ€»ä½“è´¨é‡
            + Î´ * norm_Heat_local[j]  # æœ¬åœ°Excelè§†è§’ï¼ˆæœ‰æ˜ å°„æ‰ç”¨ï¼‰
```

* `Î±/Î²/Î³/Î´` å†™è¿›é…ç½®ï¼šæ¯”å¦‚ `[0.4, 0.2, 0.3, 0.1]`ã€‚
* æœ€ç»ˆçƒ­åº¦ç™¾åˆ†ä½ï¼š

```text
heat_pct[j] = rank_percentile(Heat_raw[j] å½“æ—¥åœ¨æ‰€æœ‰æ¿å—ä¸­çš„ä½ç½®) âˆˆ [0,1]
```

> è¿™å°±æ˜¯â€œ**çœŸå®æ¿å—å¤šå¯¹å¤šçƒ­åº¦ï¼ˆè¿›æ”»å±‚ï¼‰**â€ï¼Œæ˜¯ä½ åŸè¡Œä¸šçƒ­åº¦æ¨¡å—çš„â€œå…„å¼Ÿç‰ˆæœ¬â€ã€‚

---

## å››ã€èåˆç‰ˆä¸ªè‚¡æ¿å—ä¿¡å·ï¼šé˜²å®ˆå®‰å…¨çº¿ + Max Driver + Exposure

è¿™éƒ¨åˆ†æ˜¯æŠŠä¸Šé¢çš„æ¿å—çƒ­åº¦å‹å›æ¯åªè‚¡ç¥¨ï¼Œå½¢æˆâ€œæ¿å—å¼ºåŒ–ä¿¡å·â€ã€‚

### 4.1 è¡Œä¸šé˜²å®ˆï¼šç”¨ä½ åŸæ¥çš„â€œè¡Œä¸šçƒ­åº¦åˆ†æâ€

è¿™å—å…¶å®ä½ å·²ç»åšå®Œäº†ï¼š

* ä»¥ `stocks.industry` åˆ†ç»„ï¼Œå¯¹æ¯å¤©çš„ä¸ªè‚¡ rank / total_score ç”¨ B1/B2/C1/C2 ç®—è¡Œä¸šçº§åˆ«çƒ­åº¦ã€‚ 
* è¿™å¯ä»¥ç»™æ¯ä¸ªã€Œè¡Œä¸šå­—ç¬¦ä¸²ã€ä¸€ä¸ª `industry_heat_pct`ã€‚

ç„¶åå®šä¹‰ä¸€ä¸ªå…¨å±€é…ç½®é¡¹ï¼ˆæ”¾åœ¨ system_configs æˆ– SignalConfigContext é‡Œï¼‰ï¼š

* `INDUSTRY_SAFE_LINE_PCT`ï¼šæ¯”å¦‚ 0.3 â†’ è¡Œä¸šçƒ­åº¦åœ¨å 30% ä»¥ä¸‹çš„è¡Œä¸šï¼Œè§†ä¸ºâ€œé˜²å®ˆä¸åˆæ ¼â€ã€‚

ä¸ªè‚¡é˜²å®ˆæ£€æŸ¥ï¼š

```text
å¦‚æœ stock.industry å¯¹åº”çš„ industry_heat_pct < INDUSTRY_SAFE_LINE_PCT:
    æ ‡è®°è¯¥è‚¡ä¸º "è¡Œä¸šä¸å®‰å…¨"ï¼Œåœ¨ä¸€äº›ç­–ç•¥é‡Œç›´æ¥è¿‡æ»¤ï¼ˆæ¯”å¦‚å•é’ˆ/è¿½é«˜ç±»ï¼‰
```

> è¿™ä¸€å—å°±æ˜¯åˆ«çš„ AI æ–¹æ¡ˆé‡Œè¯´çš„â€œè¡Œä¸šé˜²å®ˆçº¿â€ï¼Œä½†ä½ è¿™è¾¹å¯ä»¥ç›´æ¥å¤ç”¨ç°æœ‰è¡Œä¸šçƒ­åº¦æ¨¡å—çš„è¾“å‡ºã€‚

---

### 4.2 æ¦‚å¿µè¿›æ”»ï¼šMax Driver + Exposure åŒæŒ‡æ ‡

å¯¹æ¯åªè‚¡ç¥¨ iï¼Œå½“æ—¥å±äºçš„çœŸå®æ¿å—é›†åˆ B(i,d) ä¸­ï¼š

1. **Max Driver æ¦‚å¿µé£å£ï¼ˆåªçœ‹æ¦‚å¿µï¼‰**

   ```text
   concept_boards = { j âˆˆ B(i,d) | board_type(j) = 'concept' }

   max_concept_heat[i] = max( heat_pct[j] for j in concept_boards )   # æ²¡æœ‰å°±è®°ä¸º0
   ```

   è¿™æ˜¯â€œ**æœ€å¤§é©±åŠ¨åŠ›ï¼šå®ƒæ‰€è¹­åˆ°çš„æœ€çƒ­çš„ä¸€ä¸ªæ¦‚å¿µæ¿å—**â€ã€‚

2. **ç»¼åˆ Exposureï¼šåŠ æƒæ±‚å’Œï¼ˆè¡Œä¸š + æ¦‚å¿µ / è¿›æ”» + é˜²å®ˆï¼‰**

   åªè€ƒè™‘â€œçƒ­é—¨æ¿å—â€ï¼š

   ```text
   HotBoards = { j | heat_pct[j] â‰¥ T_type(board_type(j)) }
   ```

   é˜ˆå€¼å¯é…ç½®ï¼Œæ¯”å¦‚ï¼š

   * è¡Œä¸šï¼š`T_industry = 0.7`
   * æ¦‚å¿µï¼š`T_concept  = 0.8`

   ç„¶åï¼š

   ```text
   Exposure[i] = Î£_{jâˆˆB(i,d)âˆ©HotBoards} ( share_ij * heat_pct[j] )
   ```

   * è¿™ä¸ªå°±æ˜¯â€œ**å¤šæ¿å—å…±æŒ¯ä¸‹çš„æ€»ä½“æ¿å—æ›å…‰åº¦**â€ã€‚

---

### 4.3 ä¸ªè‚¡äºŒæ¬¡åˆ†ææ€»åˆ†ï¼šèåˆä¸Šæ¸¸è¯„åˆ† + æ¿å—ä¸¤ä¸ªç»´åº¦

ç°åœ¨æ¯åªè‚¡ç¥¨ i æœ‰å‡ ç±»æ•°ï¼š

1. `stock_score_pct[i]`ï¼šå½“å¤© `total_score` çš„åˆ†ä½ï¼ˆæ¥è‡ª daily_stock_dataï¼‰ã€‚
2. `exposure_pct[i]`ï¼šExposure åœ¨å…¨å¸‚åœºåˆ†ä½ã€‚
3. `max_concept_pct[i]`ï¼šmax_concept_heat åœ¨å…¨å¸‚åœºåˆ†ä½ã€‚
4. è¡Œä¸šé˜²å®ˆå¸ƒå°”ï¼š`industry_safe[i]`ï¼ˆè¡Œä¸šçƒ­åº¦æ˜¯å¦ >= INDUSTRY_SAFE_LINE_PCTï¼‰ã€‚

å¯ä»¥å®šä¹‰ä¸€ä¸ªâ€œ**æ¿å—å¼ºåŒ–æ€»åˆ† Final_board_score[i]**â€ï¼š

```text
base = a * stock_score_pct[i]
     + b * exposure_pct[i]
     + c * max_concept_pct[i]

å¦‚æœ industry_safe[i] = False:
    Final_board_score[i] = base * 0.5   # è¡Œä¸šä¸å®‰å…¨å°±ç åŠï¼ˆé˜²å®ˆä¼˜å…ˆï¼‰
å¦åˆ™:
    Final_board_score[i] = base
```

* a/b/c æ˜¯å¯è°ƒæƒé‡ï¼ˆæ¯”å¦‚ 1.0 / 0.7 / 0.5ï¼‰ï¼Œå†™è¿› system_configs æˆ– SignalConfigContextã€‚ 

ç„¶åå†åšä¸€æ¬¡åˆ†ä½ï¼š

```text
final_pct[i] = rank_percentile(Final_board_score[i] å…¨å¸‚åœº) âˆˆ [0,1]
```

ä¿¡å·ç­‰çº§åˆ’åˆ†ï¼ˆæ¿å—å¼ºåŒ–ä¿¡å·ï¼‰ï¼š

```text
final_pct â‰¥ 0.97 â†’ S çº§æ¿å—ä¿¡å·
0.90 â‰¤ final_pct < 0.97 â†’ A çº§
0.80 â‰¤ final_pct < 0.90 â†’ B çº§
å…¶ä»– â†’ æ— æ¿å—ä¿¡å·
```

è¿™ä¸ªâ€œæ¿å—ä¿¡å·â€å¯ä»¥åƒä½ ç°åœ¨çš„â€œçƒ­ç‚¹æ¦œ / è·³å˜æ¦œ / ç¨³æ­¥ä¸Šå‡â€é‚£æ ·ï¼Œä½œä¸ºä¸€ä¸ª**ç‹¬ç«‹ä¿¡å·ç±»å‹**æ¥å…¥å…¨å±€ä¿¡å·ç³»ç»Ÿã€‚

---

## äº”ã€æ€ä¹ˆè·Ÿå…¨å±€ä¿¡å·é…ç½®æ¶æ„/ç¼“å­˜å¯¹é½ï¼Ÿ

ä½ ç°åœ¨çš„å…¨å±€ä¿¡å·é…ç½®åšå¾—éå¸¸è§„èŒƒï¼š

* å‰ç«¯ `SignalConfigContext` é›†ä¸­ç®¡ç†ä¸€å †é˜ˆå€¼ï¼Œå¹¶é€šè¿‡ Context æ³¨å…¥åˆ°å„é¡µé¢ã€‚
* åç«¯ç¼“å­˜ key å·²ç»æ”¹æˆåŒ…å«é˜ˆå€¼ hashï¼Œä¿è¯é…ç½®ä¸åŒç»“æœä¸åŒã€‚

**æ–°æ¿å—ç³»ç»Ÿå»ºè®®æ–°å¢è¿™äº›é…ç½®é¡¹ï¼š**

å‰ç«¯ SignalConfigContext / åç«¯ system_configs åŒæ­¥ï¼š

* `board_industry_safe_pct`ï¼šè¡Œä¸šå®‰å…¨çº¿åˆ†ä½ï¼ˆé˜²å®ˆçº¿ï¼‰
* `board_hot_industry_pct`ï¼šè¡Œä¸šæ¿å—çƒ­é—¨é˜ˆå€¼
* `board_hot_concept_pct`ï¼šæ¦‚å¿µæ¿å—çƒ­é—¨é˜ˆå€¼
* `board_exposure_S_pct` / `_A_pct` / `_B_pct`ï¼šExposure çš„ S/A/B åˆ†ä½ç‚¹
* `board_weights_stock` / `board_weights_exposure` / `board_weights_maxconcept`ï¼ša/b/c æƒé‡

åšåˆ°ï¼š

* å‰ç«¯â€œä¿¡å·é…ç½®â€å¼¹çª—é‡Œå¯ä»¥å¤šä¸€ä¸ªâ€œæ¿å—ç›¸å…³â€æ ‡ç­¾é¡µï¼ˆæˆ–è€…å…ˆè—åœ¨é«˜çº§é…ç½®ï¼‰ï¼›
* åç«¯åœ¨ç®—â€œæ¿å—å¼ºåŒ–ä¿¡å·â€æ—¶ï¼ŒæŠŠè¿™äº›é˜ˆå€¼ä¸€èµ·æ”¾å…¥ç¼“å­˜ keyã€‚

---

## å…­ã€å’Œâ€œå•é’ˆä¸‹äºŒåâ€çš„å…³ç³»ï¼ˆç°åœ¨å¯ä»¥åªå½“â€œä»¥åè¦ç”¨åˆ°çš„æ¥å£â€ï¼‰

æ—¢ç„¶ä½ ç°åœ¨æš‚æ—¶ä¸æå•é’ˆï¼Œé‚£è¿™å—æˆ‘å°±åªè¯´ä¸€å¥**å¦‚ä½•é¢„ç•™æ¥å£**ï¼Œé¿å…ä»¥åé‡å†™æ¿å—é€»è¾‘ï¼š

1. å•é’ˆæœªæ¥æ–°ç‰ˆçš„è¾“å…¥ä¸­ï¼Œé™¤äº†ä¸ªè‚¡è‡ªå·±çš„ä½ç½®/æ³¢åŠ¨/é‡ä»·ç­‰ï¼Œè¿˜å¯ä»¥ç›´æ¥ç”¨åˆ°ï¼š

   * `industry_safe[i]`ï¼šåš**ç¡¬è¿‡æ»¤**ï¼ˆè¡Œä¸šå¤ªå·®å°±ä¸ç©ï¼‰
   * `exposure_pct[i]`ï¼šæ¿å—å…±æŒ¯å¼ºåº¦
   * `max_concept_pct[i]`ï¼šæ˜¯å¦è¸©åœ¨å½“å‰æœ€å¼ºé£å£ä¸Š

2. è¿™ä¸‰ä¸ªå˜é‡å¯ä»¥å½“æˆä¹ç»´è¯„åˆ†é‡Œçš„å…¶ä¸­å‡ ç»´ï¼ˆæˆ–è€…ç‹¬ç«‹è¾“å‡ºâ€œæ¿å—æ ‡ç­¾â€ï¼‰ï¼Œè€Œ**ä¸éœ€è¦å•é’ˆè‡ªå·±é‡å¤æä¸€å¥—æ¿å—é€»è¾‘**ã€‚

è¿™æ ·ä½ ç°åœ¨æ²‰æ·€ä¸‹æ¥çš„è¿™å¥—â€œå¤šå¯¹å¤šæ¿å—äºŒæ¬¡åˆ†æâ€ï¼Œä»¥åå¯ä»¥è¢«ä»»æ„ç­–ç•¥æ¶ˆè´¹ï¼Œè€Œä¸ç”¨åœ¨æ¯ä¸ªç­–ç•¥é‡Œå†å»ºä¸€æ¬¡â€œæ¿å—æ¨¡å‹â€ã€‚

---

## ä¸ƒã€ä½ æ¥ä¸‹æ¥å¯ä»¥æ€ä¹ˆè½ç›˜åˆ°æ–°æ–‡æ¡£é‡Œï¼Ÿ

ç»™ä½ ä¸€ä¸ªå¯ä»¥ç›´æ¥æŠ„åˆ°è®¾è®¡æ–‡æ¡£é‡Œçš„ç« èŠ‚ç»“æ„ï¼ˆåªåˆ—æ ‡é¢˜ & å°è¯´æ˜ï¼Œä¸å†å•°å—¦å…¬å¼ï¼‰ï¼š

1. **èƒŒæ™¯ä¸ç›®æ ‡**

   * ä¸Šæ¸¸è¯„åˆ†é»‘ç›’ï¼ˆåˆ«äººç»™ total_scoreï¼‰+ è‡ªå·±åšäºŒæ¬¡åˆ†æ
   * æ–°å¢çœŸå®æ¿å—å¤šå¯¹å¤šä»¥åï¼Œè¡Œä¸šçƒ­åº¦/æ¿å—çƒ­åº¦/ä¸ªè‚¡ä¿¡å·éƒ½éœ€è¦é‡æ„

2. **æ•°æ®ä¸è§’è‰²åˆ†å±‚**

   * ä¸ªè‚¡å±‚ï¼š`stocks / daily_stock_data`
   * æœ¬åœ°æ¿å—å±‚ï¼š`sectors / daily_sector_data`
   * çœŸå®æ¿å—å¤šå¯¹å¤šå±‚ï¼š`ext_board_list / ext_board_daily_snap / ext_board_local_map`
   * ä¸‰ä¸ªåˆ†æå¯¹è±¡ï¼šè¡Œä¸šé˜²å®ˆã€æ¿å—è¿›æ”»ã€ä¸ªè‚¡æ¿å—ä¿¡å·

3. **å¤šå¯¹å¤šæƒé‡åˆ†æ‘Šè®¾è®¡**

   * `share_ij` çš„å®šä¹‰ï¼šç±»å‹æƒé‡ + åˆ†æ‘Šï¼Œåˆ° Î£=1
   * æ”»å®ˆåˆ†ç¦»ï¼šindustry/concept/region åŸºç¡€æƒé‡

4. **æ¿å—çƒ­åº¦ï¼ˆè¿›æ”»å±‚ï¼‰è®¡ç®—**

   * B1/B2/C1/C2 çš„å¤šå¯¹å¤šç‰ˆæœ¬
   * ä¸æœ¬åœ°æ¿å—æ—¥çº¿çš„å«æ¥ï¼ˆHeat_localï¼‰
   * ç»¼åˆçƒ­åº¦ Heat_raw / heat_pct

5. **è¡Œä¸šå®‰å…¨çº¿ï¼ˆé˜²å®ˆå±‚ï¼‰**

   * åˆ©ç”¨åŸâ€œè¡Œä¸šçƒ­åº¦åˆ†æâ€æ¨¡å—ç»“æœ
   * `INDUSTRY_SAFE_LINE_PCT` çš„å®šä¹‰å’Œç”¨é€”

6. **ä¸ªè‚¡æ¿å—ä¿¡å·**

   * Max Driverï¼šmax_concept_heat
   * Exposureï¼šçƒ­é—¨æ¿å—åŠ æƒæš´éœ²åº¦
   * Final_board_score & final_pct
   * ä¿¡å·ç­‰çº§ï¼ˆS/A/B/æ— ï¼‰

7. **é…ç½®ä¸ç¼“å­˜é›†æˆ**

   * æ–°å¢æ¿å—ç›¸å…³é…ç½®é¡¹
   * å¦‚ä½•é›†æˆåˆ° SignalConfigContext / system_configs
   * ç¼“å­˜ key ä¸­åŒ…å«æ¿å—é…ç½® hash

8. **ä¸ç­–ç•¥ç³»ç»Ÿçš„å…³ç³»**

   * æ¿å—å¼ºåŒ–ä¿¡å·ä½œä¸ºæ–°çš„ä¿¡å·é¢‘é“
   * æœªæ¥å•é’ˆ/å…¶ä»–ç­–ç•¥å¦‚ä½•æ¶ˆè´¹ `industry_safe / exposure_pct / max_concept_pct`

---

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥ä½ å¯ä»¥è®©æˆ‘å¸®ä½ **æŠŠè¿™ä¸€å¥—å†™æˆçœŸæ­£â€œè®¾è®¡æ–‡æ¡£é£æ ¼â€çš„ Markdown æ¨¡æ¿**ï¼ˆæ¯”å¦‚åŠ ä¸Šâ€œæ¥å£è¾“å…¥è¾“å‡º / ç¤ºä¾‹ SQL / ä¼ªä»£ç â€ç­‰ï¼‰ï¼Œä½ å°±å¯ä»¥å‡ ä¹åŸæ · copy åˆ°ä½ çš„ä»“åº“é‡Œå½“æ­£å¼æ–‡æ¡£ç”¨ã€‚
}{è¡Œï¼Œå•é’ˆé‚£å¨å°±å…ˆå½“å®ƒåœ¨å†·å®«é—­å…³ä¿®ç‚¼ï¼Œè°ä¹Ÿåˆ«å»åµå®ƒ ğŸ‘‹ã€‚
æˆ‘ä»¬å°±ä¸“å¿ƒæŠŠ**å¤šå¯¹å¤šæ¿å—è¿™ä¸€å¥—è®¾è®¡ï¼Œå†å‡ä¸€æ¬¡çº§ï¼Œç»“åˆä½ è¿™â€œç¬¬äºŒæ¬¡æ¿€çƒˆè®¨è®ºâ€çš„æ–¹æ¡ˆ**ã€‚

æˆ‘ä¸‹é¢ç»™ä½ çš„æ˜¯ä¸€ä¸ª**èåˆç‰ˆ V3 è®¾è®¡**ï¼š

* ä¸ä¾èµ– 21/28 å¤©æœ¬åœ°å†å²ï¼ˆä½ ç°åœ¨æ•°æ®ä¸æ»¡ä¸€ä¸ªæœˆä¹Ÿèƒ½ç”¨ï¼‰
* å®Œå…¨ç«™åœ¨â€œ**äºŒæ¬¡åˆ†æ**â€çš„è§’åº¦ï¼šä¸Šæ¸¸å·²ç»ç®—å¥½åˆ†æ•° + æŠ€æœ¯å› å­ï¼Œä½ åªåšç»„åˆä¸èšåˆ
* åƒæ‰äº†ç¬¬äºŒä»½ AI æå‡ºçš„å‡ ä¸ªå¥½æ€æƒ³ï¼š**çƒ­åº¦å®ˆæ’ / æ”»å®ˆåˆ†ç¦» / é…ç½®é©±åŠ¨**
* ä¸å†å±•å¼€å•é’ˆï¼ˆåªé¢„ç•™ä¸€ç‚¹â€œå°†æ¥å¯ä»¥æŒ‚è¿‡æ¥â€çš„æ¥å£ä½ï¼‰

---

## 0. å…ˆæ˜ç¡®è¾¹ç•Œ & ç›®æ ‡

ä½ ç°åœ¨çš„ç°å®æƒ…å†µï¼š

* è‚¡ç¥¨å±‚ï¼š`stocks + daily_stock_data`ï¼Œæ¯å¤©ä¸€è¡Œï¼Œå·²ç»å¸¦å¥½ `total_score / rank / MACD / ADX / æ³¢åŠ¨ç‡ / æ¢æ‰‹ç‡ ...` ä¸€æ•´å¨æŠ€æœ¯å› å­ 
* æœ¬åœ°æ¿å—å±‚ï¼ˆExcel allbkï¼‰ï¼š`sectors + daily_sector_data`ï¼Œå’Œè‚¡ç¥¨æ˜¯åŒä¸€å¥—è¯„åˆ†ä½“ç³»ï¼Œåªæ˜¯ç»´åº¦æ˜¯æ¿å— 
* çœŸå®æ¿å—å±‚ï¼ˆEM / THSï¼‰ï¼š`ext_board_list / ext_board_daily_snap / ext_board_local_map`ï¼Œè´Ÿè´£å¤šå¯¹å¤šå…³ç³» + è¡Œä¸š/æ¦‚å¿µ/åœ°åŸŸç±»å‹åŒºåˆ† 

å½“å‰çº¦æŸï¼š

* æœ¬åœ°å†å²å¤©æ•°ä¸æ»¡ 28 å¤©ï¼Œæ‰€ä»¥ **ä¸è¦å†æä»»ä½•â€œæˆ‘è‡ªå·±ç®— 21 æ—¥ä½ç½®â€çš„å¤æ‚æ—¶åºåˆ†æ**
* ä½†æ˜¯ï¼šå› ä¸ºä¸Šæ¸¸å·²ç»åœ¨ `daily_stock_data` å’Œ `daily_sector_data` é‡Œç®—å¥½äº†å¾ˆå¤šâ€œå¸¦çª—å£â€çš„å› å­ï¼ˆæ¯”å¦‚æ³¢åŠ¨ç‡ã€æ”¾é‡å¤©æ•°ç­‰ï¼‰ï¼Œä½ ä¾ç„¶å¯ä»¥æŠŠè¿™äº›å­—æ®µå½“ä½œâ€œé»‘ç›’ç‰¹å¾â€ç›´æ¥ç”¨ï¼Œè€Œä¸éœ€è¦è‡ªå·±æ»šåŠ¨çª—å£ 

**æœ¬è®¾è®¡ V3 çš„ç›®æ ‡**ï¼š

> åŸºäºç°æœ‰è¡¨ç»“æ„ + å½“æ—¥å¿«ç…§ï¼Œå°±èƒ½è·‘èµ·æ¥ä¸€æ•´å¥—â€œå¤šå¯¹å¤šæ¿å—çƒ­åº¦ + ä¸ªè‚¡æ¿å—ä¿¡å·â€ï¼Œåç»­å†åŠ â€œè¶‹åŠ¿/æ´—ç›˜/å•é’ˆæŠ•å½±â€åªæ˜¯åœ¨è¿™å¥—éª¨æ¶ä¸ŠæŒ‚ä¸œè¥¿ã€‚

---

## 1. ä»ç¬¬äºŒä»½ AI æ–¹æ¡ˆé‡Œï¼Œæå‡ºä¸‰é¢—â€œçœŸæ­£å€¼é’±â€çš„æƒ³æ³•

### 1.1 çƒ­åº¦å®ˆæ’ï¼ˆLaw of Conservationï¼‰

* ä¸€åªè‚¡ç¥¨çš„â€œæ¿å—è´¡çŒ®æ€»é‡â€ä¸åº”è¯¥å› ä¸ºæŒ‚äº† 10 ä¸ªæ¦‚å¿µå°±è†¨èƒ€ 10 å€
* è§£å†³åŠæ³•ï¼šç»™æ¯ä¸ª `(è‚¡ç¥¨ i â€“ æ¿å— j)` ä¸€ä¸ª **åˆ†æ‘Šç³»æ•° `share_ij`**ï¼Œå¯¹æ¯åªè‚¡ç¥¨ i æœ‰
  `Î£_j share_ij = 1`
* å†æŠŠä½ åŸæ¥è¡Œä¸šçƒ­åº¦é‡Œçš„ B1/B2/C1/C2 ç®—æ³•æ¬è¿‡æ¥æ—¶ï¼Œéƒ½ä¹˜ä¸Šè¿™ä¸ª `share_ij`ã€‚

è¿™ä¸ªæˆ‘ä»¬ä¹‹å‰å·²ç»åšäº†ï¼Œä½†ç¬¬äºŒä»½æ–¹æ¡ˆæŠŠå®ƒè¯´å¾—éå¸¸ç³»ç»Ÿï¼Œæˆ‘ä»¬å°±**æ­£å¼å°ç¥ï¼šä»¥åæ‰€æœ‰æ¿å—èšåˆéƒ½å¿…é¡»å…ˆè¿‡ä¸€é share_ij**ã€‚

---

### 1.2 æ”»å®ˆåˆ†ç¦»ï¼ˆLaw of Offense-Defenseï¼‰

* **é˜²å®ˆï¼šè¡Œä¸š**ï¼ˆä¸»ä¸šï¼Œä¸€èˆ¬æ˜¯ä¸€å¯¹ä¸€ï¼‰

  * æ¥è‡ª `stocks.industry` å’Œä½ åŸæ¥çš„ã€Šè¡Œä¸šçƒ­åº¦åˆ†æï¼ˆåŠ æƒç‰ˆï¼‰ã€‹é‚£å¥— B1/B2/C1/C2ã€‚
  * ç”¨æ¥åˆ¤æ–­â€œè¿™ç¥¨æ‰€å¤„çš„å¤§ç›˜ç¯å¢ƒå®‰ä¸å®‰å…¨â€
* **è¿›æ”»ï¼šæ¦‚å¿µ**ï¼ˆå¤šå¯¹å¤šï¼‰

  * æ¥è‡ª `ext_board_list` ä¸­ `board_type='concept'` å’Œ `ext_board_daily_snap` çš„å¤šå¯¹å¤šå…³ç³» 
  * ç”¨æ¥åˆ¤æ–­â€œå®ƒç°åœ¨æ˜¯ä¸æ˜¯è¢«æŒ‚åœ¨çƒ­é£å£ä¸Šâ€

è¿™ä¸€ç‚¹å…¶å®è·Ÿä½ ä¹‹å‰ç›´è§‰æ˜¯ä¸€è‡´çš„ï¼Œåªæ˜¯ç°åœ¨æˆ‘ä»¬æŠŠå®ƒ**å†™æ­»åœ¨è®¾è®¡é‡Œ**ï¼š

> ä¸ªè‚¡æ¿å—ä¿¡å· = è¡Œä¸šé˜²å®ˆä¸è¿‡çº¿ç›´æ¥ç†„ç« + æ¦‚å¿µé£å£è´Ÿè´£ç‚¹ç«ã€‚

---

### 1.3 é…ç½®é©±åŠ¨ï¼ˆConfig Drivenï¼‰

* ä½ å·²ç»æœ‰ä¸€æ•´å¥— **SignalConfigContext** + `system_configs` çš„é…ç½®æ¶æ„ï¼š

  * å‰ç«¯ `SignalConfigContext` é›†ä¸­ç®¡ç†é˜ˆå€¼ï¼ˆçƒ­ç‚¹æ¦œå‰ Nã€è·³å˜æœ€å°åæ¬¡ç­‰ï¼‰
  * åç«¯ç¼“å­˜ key å·²ç»åŒ…å«é˜ˆå€¼ hashï¼Œä¿è¯æ”¹é…ç½®å°±é‡æ–°ç®— 
  * ç³»ç»Ÿçº§é…ç½®è½åœ¨ `system_configs` è¡¨é‡Œï¼Œæ”¯æŒ int/bool/json ç±»å‹ 

æ–°çš„å¤šå¯¹å¤šæ¿å—ç³»ç»Ÿè¦åšçš„å°±æ˜¯ï¼š

> **ä¸è¦å†å†™æ­»ä»»ä½•é˜ˆå€¼**ï¼ˆæ¯”å¦‚â€œæ¿å—çƒ­åº¦ 0.8 ä»¥ä¸Šç®—çƒ­é—¨â€ã€â€œindustry æƒé‡ = 1.0â€ï¼‰ï¼Œç»Ÿç»Ÿå¡è¿›é…ç½®ä¸­å¿ƒã€‚

---

## 2. æ•°æ®å±‚ V3ï¼šä¸æ”¹åŸºç¡€è¡¨ï¼ŒåªåŠ ä¸€å¼ â€œæ¿å—èšåˆç»“æœè¡¨â€+ ä¸€å¼ è§†å›¾

### 2.1 å·²æœ‰çš„ä¸‰å±‚ç»“æ„ï¼ˆä¸åŠ¨å®ƒä»¬ï¼‰

* **ä¸ªè‚¡å±‚**

  * `stocks(stock_code, stock_name, industry, ...)` 
  * `daily_stock_data(stock_code, date, rank, total_score, ... 80+æŠ€æœ¯å› å­)` 

* **æœ¬åœ°æ¿å—å±‚ï¼ˆExcel allbkï¼‰**

  * `sectors(id, sector_name)`
  * `daily_sector_data(sector_id, date, rank, total_score, ... åŒä¸€å¥—æŠ€æœ¯å› å­)`

* **çœŸå®æ¿å—å¤šå¯¹å¤šå±‚**ï¼ˆä½ æ–°åŠ çš„ extï¼‰

  * `ext_board_list(id, provider_id, board_code, board_name, board_type, stock_count, ...)`
  * `ext_board_daily_snap(stock_code, board_id, date, board_rank, weight)`
  * `ext_board_local_map(ext_board_id, local_sector_id, match_type, confidence)`

è¿™äº›éƒ½å¾ˆå¥½ï¼Œä¸éœ€è¦æ¨ç¿»ã€‚

---

### 2.2 æ–°å¢ 1ï¼šæ¿å—èšåˆç»“æœè¡¨ `ext_board_heat_daily`ï¼ˆæ¨èï¼‰

> ç”¨æ¥å­˜æ¯å¤©ç®—å¥½çš„ B1/B2/C1/C2 + ç»¼åˆçƒ­åº¦ï¼Œé¿å…æ¯æ¬¡å‰ç«¯ç‚¹ä¸€ä¸‹å°±è·‘å…¨åº“ã€‚

å¤§æ¦‚ç»“æ„ï¼š

```sql
CREATE TABLE IF NOT EXISTS ext_board_heat_daily (
    date        DATE,
    board_id    BIGINT REFERENCES ext_board_list(id) ON DELETE CASCADE,
    stock_count INT,                 -- å½“æ—¥æˆåˆ†è‚¡æ•°é‡ï¼ˆå¯ç›´æ¥ç”¨ snap ç»Ÿè®¡ï¼‰

    -- å¤šå¯¹å¤šåŠ æƒç‰ˆ B/C ç³»åˆ—
    b1_rank_sum      DECIMAL(20,8), -- Î£ share_ij * 1/rank^k
    b2_rank_avg      DECIMAL(20,8), -- b1 / stock_count
    c1_score_sum     DECIMAL(20,8), -- Î£ share_ij * total_score
    c2_score_avg     DECIMAL(20,8), -- c1 / stock_count

    heat_raw         DECIMAL(20,8), -- ç»¼åˆå‰æœªæ ‡å‡†åŒ–çƒ­åº¦
    heat_pct         DECIMAL(10,8), -- çƒ­åº¦åœ¨å½“æ—¥æ‰€æœ‰æ¿å—ä¸­çš„åˆ†ä½ (0~1)

    PRIMARY KEY (date, board_id)
);
```

ä½ å¯ä»¥æŠŠå®ƒå½“æˆâ€œ**çœŸå®æ¿å—ç‰ˆçš„ daily_sector_data ç²¾ç®€è¡¨**â€ã€‚

---

### 2.3 æ–°å¢ 2ï¼šä¸ªè‚¡æ¿å—ä¿¡å·è§†å›¾ `v_stock_board_signal_daily`ï¼ˆåªè¯»ï¼‰

> ç”¨æ¥ç»™å‰ç«¯/ç­–ç•¥ç»Ÿä¸€æ‹¿â€œæ¿å—ç›¸å…³ä¿¡å·â€ï¼Œä¸å’Œç°æœ‰ API å†²çªã€‚

ç¤ºæ„ç»“æ„ï¼š

```sql
CREATE OR REPLACE VIEW v_stock_board_signal_daily AS
SELECT
    d.date,
    d.stock_code,

    -- è¡Œä¸šé˜²å®ˆç»“æœï¼ˆæ¥è‡ªä½ åŸæ¥çš„è¡Œä¸šçƒ­åº¦æ¨¡å—ï¼‰
    s.industry,
    industry_heat_pct,         -- è¡Œä¸šçƒ­åº¦åˆ†ä½ï¼ˆå½“å¤©ï¼‰
    industry_safe,             -- æ˜¯å¦é€šè¿‡å®‰å…¨çº¿å¸ƒå°”å€¼

    -- æ¦‚å¿µè¿›æ”»
    max_concept_heat_pct,      -- è¯¥è‚¡æœ€å¼ºæ¦‚å¿µæ¿å—çƒ­åº¦åˆ†ä½
    board_exposure_pct,        -- æ¿å—æš´éœ²åº¦åˆ†ä½ï¼ˆå¤šæ¿å—å…±æŒ¯ï¼‰

    -- ç»¼åˆæ¿å—å¼ºåŒ–è¯„åˆ†
    final_board_score,
    final_board_score_pct,     -- å…¨å¸‚åœºåˆ†ä½
    board_signal_level         -- 'S' / 'A' / 'B' / 'NONE'
FROM ...
```

å…·ä½“ SQL ä½ å¯ä»¥åé¢å†å†™ï¼Œè¿™é‡Œå…ˆå®šä¹‰â€œè¦ç»™å¤–é¢çœ‹çš„å­—æ®µé•¿ä»€ä¹ˆæ ·â€ã€‚

---

## 3. ç®—æ³•å±‚ V3ï¼šæ€ä¹ˆåœ¨ ext_* ä¸‰å¼ è¡¨ä¸Šâ€œç…®â€å‡ºæ¿å—çƒ­åº¦

### 3.1 åˆ†æ‘Šæƒé‡ `share_ij`ï¼ˆçƒ­åº¦å®ˆæ’ + æ”»å®ˆåˆ†ç¦»ï¼‰

ä¸æ”¹è¡¨ç»“æ„ï¼Œç”¨ SQL è®¡ç®—å³å¯ï¼š

```sql
WITH base AS (
  SELECT
    snap.stock_code,
    snap.date,
    snap.board_id,
    -- ç±»å‹æƒé‡ï¼šé˜²å®ˆ > è¿›æ”» > å…¶ä»–ï¼ˆé…ç½®é¡¹ï¼‰
    CASE b.board_type
      WHEN 'industry' THEN :w_industry   -- æ¯”å¦‚ 1.0
      WHEN 'concept'  THEN :w_concept    -- æ¯”å¦‚ 0.7
      ELSE :w_region                     -- æ¯”å¦‚ 0.5
    END AS type_weight
  FROM ext_board_daily_snap snap
  JOIN ext_board_list b ON b.id = snap.board_id
  WHERE snap.date = :d
),
norm AS (
  SELECT
    stock_code,
    date,
    board_id,
    type_weight
      / SUM(type_weight) OVER (PARTITION BY stock_code, date) AS share_ij
  FROM base
)
SELECT * FROM norm;
```

* å¯¹æ¯åªè‚¡ç¥¨ `(stock_code, date)`ï¼Œ`Î£ share_ij = 1`
* è¡Œä¸šæ¿å—å› ä¸º `type_weight` é«˜ï¼Œè‡ªç„¶æ‹¿åˆ°æ›´å¤š share
* è¿™ä¸ªå°±æ˜¯ç¬¬äºŒä»½ AI æ–¹æ¡ˆé‡Œé‚£æ¡â€œçƒ­åº¦å®ˆæ’ + æ”»å®ˆåˆ†ç¦»â€çš„æ•°å­¦æ ¸å¿ƒï¼Œå®Œå…¨ç»§æ‰¿ä¸‹æ¥ã€‚

---

### 3.2 å¤šå¯¹å¤šç‰ˆ B1/B2ï¼šæŒ‰ rank åŠ æƒçš„çƒ­åº¦

ä½ åŸå§‹ B ç³»åˆ—å®šä¹‰ï¼š

* B1ï¼š`Î£ (1 / rank^k)`
* B2ï¼š`B1 / è‚¡ç¥¨æ•°` 

ç°åœ¨åœ¨ ext æ¿å—ä¸Šï¼š

```sql
WITH norm AS (...ä¸Šä¸€æ­¥ share_ij ...),
joined AS (
  SELECT
    n.board_id,
    n.date,
    n.share_ij,
    s.rank
  FROM norm n
  JOIN daily_stock_data s
    ON s.stock_code = n.stock_code
   AND s.date = n.date
  WHERE n.date = :d
),
agg AS (
  SELECT
    board_id,
    date,
    COUNT(*) AS stock_count,
    SUM(share_ij * 1.0 / POWER(rank, :k))   AS b1_rank_sum
  FROM joined
  GROUP BY board_id, date
)
SELECT
  board_id,
  date,
  stock_count,
  b1_rank_sum,
  b1_rank_sum / stock_count AS b2_rank_avg
FROM agg;
```

`k` çš„é€»è¾‘ç»§ç»­ç”¨ä½ ã€Šè¡Œä¸šçƒ­åº¦åˆ†æã€‹é‡Œçš„é‚£å¥—â€œå¹¿è§’ / é»„é‡‘åˆ†å‰² / æ ‡å‡† / é•¿ç„¦â€ï¼Œåªæ˜¯ç°åœ¨é»˜è®¤å€¼ä» 0.618 æ”¹æˆäº† 1.0ï¼Œä½ å·²ç»åœ¨â€œå®Œæ•´ä¿®å¤æ€»ç»“â€é‡Œå¤„ç†è¿‡äº†ã€‚

---

### 3.3 å¤šå¯¹å¤šç‰ˆ C1/C2ï¼šå°Šé‡ total_score çš„èƒ½é‡

åŸ C ç³»ï¼š

* C1ï¼š`Î£ total_score`
* C2ï¼š`C1 / è‚¡ç¥¨æ•°` 

å¤šå¯¹å¤šæ—¶ï¼š

```sql
WITH norm AS (...),
joined AS (
  SELECT
    n.board_id,
    n.date,
    n.share_ij,
    s.total_score
  FROM norm n
  JOIN daily_stock_data s
    ON s.stock_code = n.stock_code
   AND s.date = n.date
  WHERE n.date = :d
),
agg AS (
  SELECT
    board_id,
    date,
    COUNT(*) AS stock_count,
    SUM(share_ij * total_score) AS c1_score_sum
  FROM joined
  GROUP BY board_id, date
)
SELECT
  board_id,
  date,
  stock_count,
  c1_score_sum,
  c1_score_sum / stock_count AS c2_score_avg
FROM agg;
```

å†å¼ºè°ƒä¸€æ¬¡ï¼š

> è¿™é‡Œæˆ‘ä»¬å¹¶æ²¡æœ‰æ”¹åŠ¨ä¸Šæ¸¸é‚£å¥—â€œæ€»åˆ†æ€ä¹ˆæ¥çš„â€ï¼Œè€Œæ˜¯æŠŠå®ƒè§†ä¸ºä¸€ä¸ªå¯ä¿¡çš„â€œèƒ½é‡â€ç›´æ¥æ‹¿æ¥åˆ†æ‘Šå’Œæ±‚å’Œã€‚

---

### 3.4 å’Œæœ¬åœ°æ¿å— `daily_sector_data` çš„å«æ¥ï¼ˆå¯é€‰ï¼‰

é€šè¿‡ `ext_board_local_map(ext_board_id, local_sector_id)`ï¼Œä½ å¯ä»¥ç»™æŸäº›æ¿å—å¤šä¸€ä¸ªè§†è§’ï¼š

* å…ˆåœ¨æœ¬åœ° `daily_sector_data` é‡ŒæŒ‰ sector ç®—ä¸€ç‰ˆ C2ï¼ˆä½ å…¶å®å·²ç»åœ¨è¡Œä¸šçƒ­åº¦æ¨¡å—é‡Œå†™è¿‡ç±»ä¼¼é€»è¾‘ï¼‰
* ç„¶åï¼š

```sql
SELECT
  m.ext_board_id AS board_id,
  AVG(ds.total_score) AS local_c2_avg
FROM ext_board_local_map m
JOIN daily_sector_data ds
  ON ds.sector_id = m.local_sector_id
 AND ds.date = :d
GROUP BY m.ext_board_id;
```

è¿™ä¸ª `local_c2_avg` å¯ä»¥ä½œä¸ºä¸€ä¸ªâ€œæ¥è‡ª allbk çš„æ¿å—è§†è§’â€ï¼Œåœ¨ç»¼åˆçƒ­åº¦æ—¶ç»™ä¸€ç‚¹æƒé‡ã€‚

---

### 3.5 ç»¼åˆçƒ­åº¦ `heat_raw / heat_pct`

å¯¹æ¯ä¸ªæ¿å— j å’Œæ—¥æœŸ dï¼š

1. æ‹¿åˆ°ï¼š`b1_rank_sum / b2_rank_avg / c2_score_avg / (å¯é€‰)local_c2_avg`
2. å„è‡ªåšä¸€ä¸ªæ¨ªæˆªé¢æ ‡å‡†åŒ–ï¼ˆä¾‹å¦‚åˆ†ä½æˆ– Z-scoreï¼‰
3. ç”¨å¯é…ç½®çš„æƒé‡æ‹¼æˆç»¼åˆçƒ­åº¦ï¼š

```text
heat_raw[j] = Î± * norm_b1
            + Î² * norm_b2
            + Î³ * norm_c2
            + Î´ * norm_local_c2  (æœ‰æ˜ å°„æ‰ç”¨)
```

4. å†åœ¨å½“æ—¥æ‰€æœ‰æ¿å—ä¸Šï¼Œç®— `heat_pct[j] = åˆ†ä½æ•°(heat_raw)`ï¼Œå°±æ˜¯ [0,1] çš„æ¿å—çƒ­åº¦ã€‚

**Î±/Î²/Î³/Î´ éƒ½è¿›é…ç½®ä¸­å¿ƒ**ï¼ˆæ¯”å¦‚è½åœ¨ `system_configs` é‡Œï¼Œcategory='board'ï¼‰ï¼Œå‰ç«¯å¯ä»¥é€šè¿‡ SignalConfigContext æ‹‰å–æˆ–è€…å¦å¤–åšä¸€ä¸ªâ€œæ¿å—é…ç½®â€é¢æ¿ã€‚

---

## 4. ä¸ªè‚¡è¿™å±‚ï¼šè¡Œä¸šé˜²å®ˆ + æ¦‚å¿µè¿›æ”» + ç»¼åˆæ¿å—ä¿¡å·

è¿™ä¸€å—åŸºæœ¬å°±æ˜¯æŠŠå‰é¢çš„æ¿å—çƒ­åº¦æŠ•å½±å›è‚¡ç¥¨ã€‚

### 4.1 è¡Œä¸šé˜²å®ˆï¼šç»§ç»­ç”¨ä½ åŸæ¥çš„ã€Šè¡Œä¸šçƒ­åº¦åˆ†æã€‹

ä½ ç°åœ¨å·²ç»æœ‰ä¸€å¥—â€œæŒ‰ `stocks.industry` èšåˆçš„ B1/B2/C1/C2 çƒ­åº¦ç³»ç»Ÿâ€ï¼Œè¿™ç›´æ¥å¯ä»¥å½“ï¼š

* **è¡Œä¸šçƒ­åº¦åˆ†ä½ industry_heat_pct**
* é…ä¸€ä¸ªâ€œè¡Œä¸šå®‰å…¨çº¿åˆ†ä½â€ï¼šæ¯”å¦‚ 0.3 â†’ å 30% çš„è¡Œä¸šè§†ä¸ºä¸å®‰å…¨

è¿™ä¸ªé˜ˆå€¼å¯ä»¥æ”¾åˆ° `system_configs` é‡Œï¼Œæ¯”å¦‚ï¼š

```text
config_key: board_industry_safe_pct
config_value: "0.3"
config_type: "float"
category: "board"
```

ä¸ªè‚¡é˜²å®ˆç»“æœï¼š

```text
industry_safe[i] =
  (industry_heat_pct(stock.industry) >= board_industry_safe_pct)
```

**è§„åˆ™**ï¼ˆä½ å¯ä»¥å†™è¿›æ–‡æ¡£çš„â€œå¿…å®ˆåŸåˆ™â€ï¼‰ï¼š

> è¡Œä¸šä¸å®‰å…¨çš„ä¸ªè‚¡ï¼Œåœ¨æŸäº›è¿›æ”»ç­–ç•¥é‡Œç›´æ¥ä¸çœ‹ï¼ˆæ¯”å¦‚æœªæ¥çš„å•é’ˆ/è¿½é«˜ç­–ç•¥ï¼‰ã€‚

---

### 4.2 æ¦‚å¿µè¿›æ”» 1ï¼šMax Driverï¼ˆæœ€å¤§é©±åŠ¨åŠ›ï¼‰

å¯¹æŸåªè‚¡ç¥¨ i æŸæ—¥ dï¼š

```text
concept_boards(i) = { j | (i,j,d) åœ¨ ext_board_daily_snap ä¸” board_type(j)='concept' }
max_concept_heat[i] = max( heat_pct[j] ) over j âˆˆ concept_boards(i)  ï¼ˆæ²¡æœ‰å°± 0ï¼‰
```

å†åœ¨å…¨å¸‚åœºä¸Šå¯¹ `max_concept_heat` åšä¸€æ¬¡åˆ†ä½ â†’ `max_concept_heat_pct[i]`ã€‚

è¿™å°±æ˜¯ç¬¬äºŒä»½ AI é‡Œè¯´çš„â€œ**æœ€å¤§é©±åŠ¨æ¦‚å¿µé£å£**â€ã€‚

---

### 4.3 æ¦‚å¿µè¿›æ”» 2ï¼šExposureï¼ˆå…±æŒ¯å¼ºåº¦ï¼‰

åªè€ƒè™‘â€œè¶³å¤Ÿçƒ­â€çš„æ¿å—ï¼š

```text
HotBoards = { j |
  if board_type(j) = 'industry': heat_pct[j] >= T_industry
  if board_type(j) = 'concept' : heat_pct[j] >= T_concept
}
```

* `T_industry / T_concept` éƒ½æ˜¯é…ç½®ï¼šæ¯”å¦‚ 0.7 / 0.8ã€‚

ç„¶åå¯¹è‚¡ç¥¨ iï¼š

```text
Exposure[i] = Î£_{j âˆˆ B(i,d) âˆ© HotBoards} ( share_ij * heat_pct[j] )
```

å†åœ¨å…¨å¸‚åœºä¸Šå¯¹ Exposure åšåˆ†ä½ â†’ `exposure_pct[i]`ã€‚

ä½ å¾—åˆ°ä¸¤ä¸ªå®Œå…¨ä¸åŒå‘³é“çš„æŒ‡æ ‡ï¼š

* `max_concept_heat_pct`ï¼šè¿™ç¥¨è¸©åœ¨å¤šå¤§çš„é£å£ä¸Šï¼ˆåªçœ‹æœ€å¼ºæ¦‚å¿µï¼‰
* `exposure_pct`ï¼šè¿™ç¥¨è¢«å¤šå°‘å¼ºæ¿å—â€œåŒæ—¶æŠ¬ç€â€ï¼ˆå¤šæ¿å—å…±æŒ¯ï¼‰

---

### 4.4 ç»¼åˆæ¿å—å¼ºåŒ–è¯„åˆ†ï¼ˆåªç”¨æˆªé¢ï¼Œä¸ç”¨ 28 å¤©ï¼‰

ç°åœ¨ä½ æœ‰ï¼š

* `stock_score_pct[i]`ï¼šå½“æ—¥ `total_score` åœ¨å…¨å¸‚åœºçš„åˆ†ä½
* `exposure_pct[i]`ï¼šæ¿å—å…±æŒ¯åˆ†ä½
* `max_concept_heat_pct[i]`ï¼šæœ€å¤§é£å£åˆ†ä½
* `industry_safe[i]`ï¼šå¸ƒå°”ï¼ˆè¡Œä¸šæ˜¯å¦å®‰å…¨ï¼‰

æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªâ€œæ¿å—å¼ºåŒ–æ€»åˆ†â€ï¼š

```text
base[i] =
    a * stock_score_pct[i]
  + b * exposure_pct[i]
  + c * max_concept_heat_pct[i]
```

* a/b/c â†’ é…ç½®é¡¹ï¼ˆæ¯”å¦‚ 1.0 / 0.7 / 0.5ï¼‰

å†åŠ ä¸Šè¡Œä¸šé˜²å®ˆï¼š

```text
if not industry_safe[i]:
    final_board_score[i] = base[i] * penalty  # penalty æ¯”å¦‚ 0.5
else:
    final_board_score[i] = base[i]
```

å†å…¨å¸‚åœºåˆ†ä½ â†’ `final_board_score_pct[i]`ã€‚

ä¿¡å·åˆ†çº§ï¼ˆæ¿å—å¼ºåŒ–ä¿¡å·ï¼‰ï¼š

```text
>= 97%  â†’ 'S'
90~97%  â†’ 'A'
80~90%  â†’ 'B'
å…¶ä»–    â†’ 'NONE'
```

è¿™äº›é˜ˆå€¼åŒæ ·è¿› `system_configs`ï¼Œæ¯”å¦‚ï¼š

```text
board_signal_S_pct = 0.97
board_signal_A_pct = 0.90
board_signal_B_pct = 0.80
```

å‰ç«¯/ç­–ç•¥å°±å¯ä»¥ç›´æ¥æŒ‰ `board_signal_level` æ‰“æ ‡ç­¾ï¼š

> â€œæ¿å—Sçº§å¼ºåŒ–â€ã€â€œæ¿å—Açº§å¼ºåŒ–â€ç­‰ã€‚

---

## 5. é…ç½®å±‚ï¼šè·Ÿç°æœ‰ SignalConfig / system_configs æ‰“é€š

ä½ ç°åœ¨çš„é…ç½®ä½“ç³»å·²ç»å¾ˆå®Œå¤‡äº†ï¼šå‰ç«¯ `SignalConfigContext` + åç«¯ `system_configs` + ç¼“å­˜ key åŒ…å«é˜ˆå€¼ã€‚  

æ¿å—ç³»ç»Ÿå»ºè®®æ–°å¢è¿™äº› keyï¼ˆç±»åˆ«å¯ä»¥ç»Ÿä¸€ç”¨ `board`ï¼‰ï¼š

* `board_type_weight_industry`ï¼šæ¯”å¦‚ `1.0`

* `board_type_weight_concept`ï¼šæ¯”å¦‚ `0.7`

* `board_type_weight_region`ï¼šæ¯”å¦‚ `0.5`

* `board_industry_safe_pct`ï¼šè¡Œä¸šå®‰å…¨çº¿ï¼ˆ0~1ï¼‰

* `board_hot_industry_pct`ï¼šè¡Œä¸šçƒ­é—¨çº¿

* `board_hot_concept_pct`ï¼šæ¦‚å¿µçƒ­é—¨çº¿

* `board_weight_stock_score`ï¼ša

* `board_weight_exposure`ï¼šb

* `board_weight_max_concept`ï¼šc

* `board_penalty_unsafe_industry`ï¼špenalty ç³»æ•°ï¼ˆæ¯”å¦‚ 0.5ï¼‰

* `board_signal_S_pct` / `board_signal_A_pct` / `board_signal_B_pct`

å‰ç«¯å¯ä»¥å…ˆä¸ç”¨ UI è°ƒè¿™äº›ï¼ˆä½ ç°åœ¨æ•°æ®è¿˜å°‘ï¼Œå…ˆå›ºå®šä¸€å¥—ï¼‰ï¼Œä½†åç«¯ç®—ç¼“å­˜ key æ—¶è¦æŠŠè¿™äº›é…ç½® hash ä¸Šå»ï¼Œè¿™æ ·æ”¹äº†æ¿å—é˜ˆå€¼ä»¥åç»“æœæ‰ä¼šé‡æ–°ç®—ã€‚

---

## 6. è€ƒè™‘ä½ â€œæ•°æ® < 1 ä¸ªæœˆâ€çš„ç°å®ï¼šå®æ–½ä¼˜å…ˆçº§å»ºè®®

ä½ ç°åœ¨ä¸æƒ³æ 21 å¤©ã€28 å¤©è¿™ç§ä¸œè¥¿ï¼Œå¾ˆæ­£å¸¸ï¼Œé‚£å°±æŒ‰â€œ**åªç”¨å½“æ—¥æˆªé¢ + ä¸Šæ¸¸å¸¦æ¥çš„å†å²å› å­**â€æ¥åˆ†é˜¶æ®µï¼š

### Phase 1ï¼ˆå¯ä»¥é©¬ä¸Šåšï¼‰

* å»ºå¥½ `ext_board_heat_daily` è¡¨
* å†™ä¸€ä¸ªç®€å•çš„ Python/SQL ETLï¼š

  * æ¯å¤©æ ¹æ® `daily_stock_data + ext_board_daily_snap` ç®—å‡º B1/B2/C1/C2 + heat_raw/heat_pctï¼Œå†™å…¥è¡¨
* å†™ä¸€ä¸ª read-only APIï¼š

  * æŒ‰æ—¥æœŸè¿”å›â€œçƒ­é—¨è¡Œä¸š / çƒ­é—¨æ¦‚å¿µ / çƒ­é—¨æ¿å—æ¦œå• + heat_pctâ€

è¿™æ ·ä½ ç«‹åˆ»èƒ½åœ¨å‰ç«¯åŠ ä¸€ä¸ªâ€œ**çœŸå®æ¿å—çƒ­åº¦æ¦œ**â€ï¼ˆç±»ä¼¼ä½ ç°åœ¨çš„è¡Œä¸šçƒ­åº¦æ¨¡å—ï¼Œåªæ˜¯æ¢æ•°æ®æºï¼‰ã€‚

### Phase 2ï¼ˆæ¿å— â†’ ä¸ªè‚¡ï¼‰

* å†™ `v_stock_board_signal_daily` è§†å›¾ï¼ˆæˆ–è€…åç«¯ service ï¼‰ï¼Œç®—å‡ºï¼š

  * `industry_safe`
  * `max_concept_heat_pct`
  * `exposure_pct`
  * `final_board_score_pct` & `board_signal_level`
* åœ¨è‚¡ç¥¨æŸ¥è¯¢é¡µã€è¡Œä¸šè¯¦æƒ…å¼¹çª—é‡Œï¼Œå¤šåŠ ä¸€åˆ—â€œæ¿å—ä¿¡å·â€æ ‡ç­¾ã€‚

### Phase 3ï¼ˆæœªæ¥æ•°æ®å¤Ÿå¤šå†è¯´ï¼‰

* åœ¨ `ext_board_heat_daily` ä¸Šç®—â€œæ¿å—çƒ­åº¦è¶‹åŠ¿â€ï¼ˆ3 æ—¥/5 æ—¥/10 æ—¥ï¼‰
* åšâ€œæ¿å—è½®åŠ¨æ¦œâ€â€œæ¿å—æ´—ç›˜æµ“åº¦â€ç­‰
* è¿™æ—¶å€™å¦‚æœä½ æƒ³æŠŠå•é’ˆæ‹‰å›æ¥åšâ€œç­–ç•¥æŠ•å½±â€ï¼Œä¹Ÿåªæ˜¯å¤šåœ¨ `ext_board_heat_daily` ä¸ŠåŠ  1~2 ä¸ªå­—æ®µè€Œå·²ï¼ˆæ¯”å¦‚ `needle_density`ï¼‰ï¼Œä½†æ˜¯ä½ ç°åœ¨å®Œå…¨å¯ä»¥æŠŠè¿™å—å…ˆåˆ æ‰ä¸çœ‹ã€‚

---

## 7. å°ç»“ï¼ˆç»™è‡ªå·±çœ‹çš„é‚£å¥ï¼‰

* å•é’ˆé‚£å¨å°±è®©å®ƒè¿‡ä¸¤ä¸ªæœˆå†è¯´ï¼Œç°åœ¨çš„è®¾è®¡**å®Œå…¨ä¸ä¾èµ– 21/28 å¤©æœ¬åœ°æ•°æ®**ï¼›
* æˆ‘ä»¬æŠŠç¬¬äºŒä»½ AI çš„å‡ ä¸ªå¥½æ´»éƒ½åƒè¿›æ¥äº†ï¼š

  * **çƒ­åº¦å®ˆæ’** â†’ `share_ij` åˆ†æ‘Š
  * **æ”»å®ˆåˆ†ç¦»** â†’ è¡Œä¸šé˜²å®ˆ + æ¦‚å¿µè¿›æ”»
  * **é…ç½®é©±åŠ¨** â†’ æ‰€æœ‰æƒé‡å’Œé˜ˆå€¼è¿› `system_configs` + å…¨å±€ SignalConfig
* ç°æœ‰ SQL è¡¨ä¸€ä¸ªæ²¡æ¨ç¿»ï¼Œåªæ˜¯å»ºè®®åŠ ä¸€ä¸ª `ext_board_heat_daily` å’Œä¸€ä¸ªâ€œä¸ªè‚¡æ¿å—ä¿¡å·è§†å›¾â€ã€‚

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€ä¸ªå›åˆæˆ‘å¯ä»¥ç›´æ¥å¸®ä½ æŠŠè¿™ä»½ V3 è®¾è®¡å†™æˆä¸€ä»½**æ­£å¼çš„ Markdown è®¾è®¡æ–‡æ¡£éª¨æ¶**ï¼ˆå¸¦æ ‡é¢˜ã€ç›®å½•ã€å°‘é‡ SQL ç‰‡æ®µï¼‰ï¼Œä½ å¯ä»¥ç›´æ¥æ‰”è¿›ä½ çš„ä»“åº“å½“ `boards_v3_design.md` ç”¨ã€‚

> ä»¥åŠç…§ä¾‹è¯´ä¸€å¥ï¼šè¿™äº›ä¸œè¥¿å…¨éƒ¨åªç»™ä½ è‡ªå·±åšæ•°æ®åˆ†æ/ç©ç³»ç»Ÿï¼Œä¸æ˜¯æŠ•èµ„å»ºè®®å“ˆ ğŸ™ƒã€‚
}{é‚£æˆ‘ä»¬å°±æ¥ç»™è¿™æ¬¡â€œæœ€åä¸€è½®å¤´è„‘é£æš´â€æ”¶ä¸ªå°¾ï¼ŒæŠŠä½ å–œæ¬¢çš„è¿™ä¸ªå‰ç«¯ç‰Œå­ï¼š

> **`[Sçº§ï½œé”‚ç”µæ± ]`**

çœŸæ­£è½åˆ°**æ•°æ®è®¾è®¡ + å‰ç«¯å±•ç¤º + äº¤äº’ç»†èŠ‚**ä¸Šã€‚

ä¸‹é¢æˆ‘ä¼šé»˜è®¤ï¼š

* å•é’ˆç»§ç»­å¾…åœ¨å†·å®« âœ…
* æ•°æ® < 28 å¤©ï¼Œåªåšâ€œå½“æ—¥æˆªé¢ + ä¸Šæ¸¸å› å­â€çš„ç‰ˆæœ¬ âœ…
* ä½ ç°æœ‰çš„è¡Œä¸šçƒ­åº¦ B1/B2/C1/C2 å’Œå…¨å±€ SignalConfig éƒ½å·²ç»åœ¨è·‘ âœ…  

---

## ä¸€ã€å…ˆæŠŠ `[Sçº§ï½œé”‚ç”µæ± ]` æ‹†å¼€è®²æ¸…æ¥š

è¿™ä¸ªå°ç‰Œå­é‡Œé¢å…¶å®æœ‰ä¸¤å±‚ä¿¡æ¯ï¼š

* **å·¦è¾¹ï¼š`Sçº§`**
  â†’ è¡¨ç¤ºè¿™åªè‚¡ç¥¨çš„â€œ**ç»¼åˆæ¿å—å¼ºåŒ–ä¿¡å·ç­‰çº§**â€ï¼Œæ˜¯è‚¡ç¥¨ç»´åº¦çš„ç»“æœ
  â†’ æ¥æºï¼šæˆ‘ä»¬å‰é¢è®¾è®¡çš„ `final_board_score_pct`ï¼ˆåˆ†ä½æ•°ï¼‰ï¼Œæ˜ å°„æˆ `S/A/B/NONE`

* **å³è¾¹ï¼š`é”‚ç”µæ± `**
  â†’ è¡¨ç¤ºå½“å‰ç»™å®ƒè´¡çŒ®æœ€å¤§çš„â€œ**é©±åŠ¨æ¿å—**â€ï¼ˆé€šå¸¸æ˜¯æ¦‚å¿µæ¿å—ï¼‰
  â†’ æ¥æºï¼šå¤šå¯¹å¤šå…³ç³»é‡Œçš„ **Max Driver æ¦‚å¿µæ¿å—**ï¼ˆ`max_concept_heat` é‚£ä¸ªï¼‰ 

æ‰€ä»¥ï¼Œä½ å¯ä»¥è¿™ä¹ˆå®šä¹‰è¿™ä¸ªç»„ä»¶ï¼š

> **BoardSignalBadge = (level, driver_name, driver_type)**
> æ˜¾ç¤ºä¸º `[Sçº§ï½œé”‚ç”µæ± ]`ï¼Œå¹¶ä¸”ç‚¹å‡»å¯ä»¥è·³åˆ°â€œé”‚ç”µæ± æ¿å—è¯¦æƒ…â€ã€‚

---

## äºŒã€åç«¯æ•°æ®å¥‘çº¦ï¼šç»™å‰ç«¯å‡†å¤‡å¥½æ¸²æŸ“æ‰€éœ€å­—æ®µ

å»ºè®®åœ¨ä½ ä¹‹å‰è¯´çš„é‚£ä¸ªâ€œä¸ªè‚¡æ¿å—ä¿¡å·è§†å›¾â€åŸºç¡€ä¸Šï¼ŒåŠ ä¸Šè¿™å‡ ä¸ªä¸“é—¨ä¸ºå‰ç«¯å‡†å¤‡çš„å­—æ®µã€‚ 

### 2.1 è§†å›¾è®¾è®¡ï¼š`v_stock_board_signal_daily`

ç¤ºæ„ç»“æ„ï¼š

```sql
CREATE OR REPLACE VIEW v_stock_board_signal_daily AS
SELECT
    d.date,
    d.stock_code,

    -- è¡Œä¸šé˜²å®ˆä¿¡æ¯
    s.industry,
    industry_heat_pct,         -- è¡Œä¸šçƒ­åº¦åˆ†ä½ [0,1]
    industry_safe,             -- bool: æ˜¯å¦é€šè¿‡å®‰å…¨çº¿

    -- æ¦‚å¿µè¿›æ”»ä¿¡æ¯
    max_concept_board_id,
    max_concept_board_name,    -- é©±åŠ¨æ¿å—å â†’ ç”¨æ¥æ˜¾ç¤º â€œé”‚ç”µæ± â€
    max_concept_board_type,    -- 'concept' / 'industry' ç­‰
    max_concept_heat_pct,      -- è¯¥æ¿å—çƒ­åº¦åˆ†ä½

    -- å…±æŒ¯å¼ºåº¦
    exposure_pct,              -- å¤šæ¿å—å…±æŒ¯åˆ†ä½ [0,1]

    -- ç»¼åˆæ¿å—è¯„åˆ†ï¼ˆè‚¡ç¥¨å±‚ï¼‰
    final_board_score,
    final_board_score_pct,     -- [0,1]

    -- å‰ç«¯ç›´æ¥ç”¨çš„å­—æ®µ ğŸ‘‡
    board_signal_level,        -- 'S' / 'A' / 'B' / 'NONE'
    board_signal_label,        -- 'é”‚ç”µæ± ' or 'å¤šæ¿å—' or 'é€šä¿¡è®¾å¤‡'
    board_signal_reason        -- ç®€è¦è§£é‡Šæ–‡æ¡ˆï¼Œå¯é€‰
FROM ...
;
```

å…¶ä¸­ï¼š

* `board_signal_level`ï¼šæŒ‰æˆ‘ä»¬ä¹‹å‰çº¦å®šçš„åˆ†ä½æ¡£ï¼š

  * `>= 0.97` â†’ `'S'`
  * `0.90~0.97` â†’ `'A'`
  * `0.80~0.90` â†’ `'B'`
  * å…¶ä»– â†’ `'NONE'`
* `board_signal_label`ï¼š

  * ä¼˜å…ˆç”¨ `max_concept_board_name`ï¼ˆæ¿å—ç±»å‹ä¸º concept æ—¶ï¼‰
  * å¦‚æœè¯¥è‚¡åªæœ‰è¡Œä¸šé©±åŠ¨ï¼Œå¯ä»¥ç”¨ `è¡Œä¸šå` æˆ– `è¡Œä¸šÂ·é€šä¿¡è®¾å¤‡` ä¹‹ç±»
  * å¦‚æœæ¦‚å¿µå¤ªå¤šè€Œä¸”æƒé‡æ¯”è¾ƒå‡è¡¡ï¼Œå¯ä»¥ fallback ä¸º `'å¤šæ¿å—'`

è¿™å±‚é€»è¾‘å…¨éƒ¨åœ¨åç«¯ç®—å¥½ï¼Œ**å‰ç«¯å°±åªæ‹¿ä¸¤ä¸ªæ ¸å¿ƒå­—æ®µæ¸²æŸ“ç‰Œå­**ï¼š

```jsonc
{
  "board_signal_level": "S",
  "board_signal_label": "é”‚ç”µæ± "
}
```

---

## ä¸‰ã€ç­‰çº§æ€ä¹ˆæ˜ å°„åˆ° S/A/Bï¼ˆå’Œé…ç½®æ‰“é€šï¼‰

### 3.1 æˆ‘ä»¬æœ‰çš„ä¸œè¥¿

* `final_board_score_pct[i]`ï¼šå‰é¢å·²ç»å®šä¹‰è¿‡ï¼Œç”¨ä¸ªè‚¡è¯„åˆ† + Exposure + Max Driver æ‹¼å‡ºæ¥çš„åˆ†ä½æ•°ã€‚ 
* å·²æœ‰çš„ç³»ç»Ÿé…ç½®è¡¨ `system_configs`ï¼Œå¯ä»¥è½»æ¾æ‰©å±•æ–°é…ç½®é¡¹ã€‚
* å‰ç«¯æœ‰ `SignalConfigContext` å¯ä»¥è¯»è¿™äº›é˜ˆå€¼å¹¶ä¼ ç»™åç«¯ï¼ˆæˆ–è€…ç”±åç«¯è‡ªå·±è¯» system_configsï¼‰ã€‚ 

### 3.2 æ–°å¢ç³»ç»Ÿé…ç½®é¡¹ï¼ˆåç«¯ï¼‰

åœ¨ `system_configs` é‡ŒåŠ ä¸€ç»„ `category='board'`ï¼š

* `board_signal_S_pct`ï¼ˆé»˜è®¤ `0.97`ï¼‰
* `board_signal_A_pct`ï¼ˆé»˜è®¤ `0.90`ï¼‰
* `board_signal_B_pct`ï¼ˆé»˜è®¤ `0.80`ï¼‰

è¿™æ ·åœ¨ SQL æˆ– Python é‡Œå°±å¯ä»¥å†™ç±»ä¼¼ï¼š

```python
if pct >= S_pct: level = 'S'
elif pct >= A_pct: level = 'A'
elif pct >= B_pct: level = 'B'
else: level = 'NONE'
```

> å°†æ¥ä½ æƒ³è°ƒ S çº§ç¨€æœ‰åº¦ï¼Œåªæ”¹é…ç½®ï¼Œä¸åŠ¨ä»£ç ã€‚

---

## å››ã€`[Sçº§ï½œé”‚ç”µæ± ]` ç»„ä»¶çš„å‰ç«¯è®¾è®¡æ–¹æ¡ˆ

ä½ ç°åœ¨å‰ç«¯å·²ç»æœ‰å¾ˆç»Ÿä¸€çš„ä¸€å¥— UI é£æ ¼ï¼ˆæ¢¯åº¦ç´«è“æŒ‰é’®ã€å…¨å±€ SignalConfig é¢æ¿ç­‰ï¼‰ã€‚

è¿™ä¸ªç‰Œå­æˆ‘å»ºè®®åšæˆä¸€ä¸ª**ç‹¬ç«‹çš„å°ç»„ä»¶**ï¼Œä»¥ååˆ°å¤„å¤ç”¨ï¼š

### 4.1 ç»„ä»¶æ¥å£è®¾è®¡

```tsx
type BoardSignalLevel = 'S' | 'A' | 'B' | 'NONE';

interface BoardSignalBadgeProps {
  level: BoardSignalLevel;
  label: string;              // "é”‚ç”µæ± "
  type?: 'industry' | 'concept' | 'region';
  heatPct?: number;           // 0~1ï¼Œå¯é€‰ï¼Œåš tooltip
  onClick?: () => void;       // ç‚¹å‡»è·³åˆ°æ¿å—è¯¦æƒ…
}
```

å…¸å‹è°ƒç”¨ï¼š

```jsx
<BoardSignalBadge
  level={stock.board_signal_level}
  label={stock.board_signal_label}
  type={stock.max_concept_board_type}
  heatPct={stock.max_concept_heat_pct}
  onClick={() => openBoardDetail(stock)}
/>
```

---

### 4.2 è§†è§‰é£æ ¼å»ºè®®

**æ–‡å­—ç»“æ„**ï¼š

* å·¦ï¼š`Sçº§ / Açº§ / Bçº§`
* ç«–çº¿åˆ†éš”ï¼š`ï½œ`
* å³ï¼šæ¿å—åï¼Œå¦‚ `é”‚ç”µæ± `

å¯ä»¥è¿™æ ·åˆ†å±‚ï¼š

* S çº§ï¼šé¢œè‰²æœ€äº®ï¼Œæ¸å˜ + å¾®å…‰
* A çº§ï¼šæ¬¡äº®
* B çº§ï¼šåä½é¥±å’Œ
* NONEï¼šä¸æ˜¾ç¤ºè¿™ä¸ªç»„ä»¶ï¼Œæˆ–è€…æ˜¾ç¤ºç°è‰²å°å­—â€œæ— æ¿å—ä¿¡å·â€

ä¼ª CSS è®¾è®¡æ€è·¯ï¼š

```css
.badge-base {
  display: inline-flex;
  align-items: center;
  border-radius: 999px;
  padding: 2px 8px;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
}

.badge-S {
  background: linear-gradient(90deg, #f97316, #ec4899); /* æ©™ â†’ ç²‰ */
  color: #fff;
}

.badge-A {
  background: linear-gradient(90deg, #6366f1, #ec4899); /* è“ç´« â†’ ç²‰ */
  color: #fff;
}

.badge-B {
  background: rgba(148, 163, 184, 0.15);
  color: #e5e7eb;
  border: 1px solid rgba(148,163,184,0.5);
}
```

React é‡Œæ‹¼ä¸€ä¸‹ï¼š

```jsx
<span className={`badge-base badge-${level}`}>
  <span>{level}çº§</span>
  <span style={{ margin: '0 4px' }}>ï½œ</span>
  <span>{label}</span>
</span>
```

> è¿™æ ·ä½ å°±èƒ½åœ¨è‚¡ç¥¨åˆ—è¡¨é‡Œç›´æ¥çœ‹åˆ°ç±»ä¼¼ï¼š
> **`[Sçº§ï½œé”‚ç”µæ± ] [è·³å˜] [çƒ­ç‚¹]`** ä¸€æ•´æ’ä¿¡å·ã€‚

---

### 4.3 ç‚¹å‡» & æç¤ºäº¤äº’

å»ºè®®ï¼š

1. **ç‚¹å‡»è¡Œä¸º**

   * ç‚¹å‡»æ•´ä¸ª Badgeï¼šæ‰“å¼€â€œæ¿å—è¯¦æƒ…å¼¹çª—â€ï¼ˆç±»ä¼¼ä½ ç°åœ¨çš„ IndustryDetailDialogï¼‰ä½†æ¢æˆ**çœŸå®æ¿å—**ç‰ˆæœ¬ã€‚
   * å¼¹çª—é‡Œå±•ç¤ºï¼š

     * æ¿å—çƒ­åº¦æ›²çº¿ï¼ˆheat_pct æœ€è¿‘ N å¤©ï¼‰
     * å‰ 10 æˆåˆ†è‚¡
     * è¡Œä¸š / æ¦‚å¿µæ ‡ç­¾ã€æ•°æ®æºï¼ˆEM/THSï¼‰

2. **é¼ æ ‡æ‚¬æµ® Tooltip**ï¼ˆPC ä¸Šï¼‰
   å†…å®¹å¯ä»¥æ˜¯ï¼š

   ```text
   æ¿å—ï¼šé”‚ç”µæ± ï¼ˆæ¦‚å¿µï¼‰
   å½“æ—¥çƒ­åº¦ï¼š98åˆ†ä½ï¼ˆç¬¬ 3 / 500 åï¼‰
   æ¿å—æš´éœ²åº¦ï¼šå‰ 5%
   è¡Œä¸šé˜²å®ˆï¼šé€šä¿¡è®¾å¤‡ï¼ˆå®‰å…¨ï¼‰
   ```

   è¿™äº›æ•°å­—éƒ½æ¥è‡ªæˆ‘ä»¬å‰é¢ç®—å¥½çš„ `heat_pct / exposure_pct / industry_heat_pct`ã€‚ 

---

## äº”ã€åœ¨ä¸‰ä¸ªå…³é”®é¡µé¢é‡Œæ€ä¹ˆç”¨è¿™ä¸ªç‰Œå­

### 5.1 è‚¡ç¥¨æŸ¥è¯¢é¡µï¼ˆStockQueryModuleï¼‰

ä½ ç°åœ¨è‚¡ç¥¨æŸ¥è¯¢é¡µå·²ç»æ¥ä¸Šäº†å…¨å±€ SignalConfigï¼Œä¹Ÿå·²ç»æœ‰å„ç§ä¿¡å·æ ‡ç­¾ã€‚

å¯ä»¥åœ¨â€œä¿¡å·â€é‚£ä¸€åˆ—é‡ŒåŠ ä¸€é¡¹ï¼š

```jsx
<td>
  {stock.board_signal_level !== 'NONE' && (
    <BoardSignalBadge
      level={stock.board_signal_level}
      label={stock.board_signal_label}
      type={stock.max_concept_board_type}
      heatPct={stock.max_concept_heat_pct}
      onClick={() => openBoardDetail(stock)}
    />
  )}

  {/* ç°æœ‰ä¿¡å· */}
  {stock.jumpSignal && <JumpBadge ... />}
  {stock.hotSignal && <HotBadge ... />}
  ...
</td>
```

ç”¨æˆ·å°±èƒ½åœ¨ä¸€çœ¼çœ‹åˆ°ï¼š

> è¿™ç¥¨ä¸ä»…æœ‰â€œè·³å˜ / çƒ­ç‚¹â€ï¼Œè¿˜è¢«æŸä¸ªå¼ºæ¿å— S çº§æŠ¬ç€ï¼Œé£å£åå°±å†™åœ¨ badge ä¸Šã€‚

---

### 5.2 è¡Œä¸šè¯¦æƒ… / æ¿å—è¯¦æƒ…å¼¹çª—

åŸæ¥çš„ `IndustryDetailDialog` å·²ç»åœ¨ç”¨ SignalConfigï¼Œå„ç§ä¿¡å·ä¹Ÿä¼šåœ¨åˆ—è¡¨é‡Œæ˜¾ç¤ºã€‚

åœ¨å¼¹çª—é‡Œçš„è‚¡ç¥¨åˆ—è¡¨æ¯ä¸€è¡Œï¼ŒåŒæ ·åŠ ä¸Šè¿™ä¸ª badgeï¼š

* è¿™æ ·ä½ çœ‹æŸä¸ªè¡Œä¸šæ—¶ï¼Œå¯ä»¥é¡ºä¾¿çœ‹åˆ°ï¼š

  * è¡Œä¸šå†…æœ‰äº›ç¥¨æ¿å—ä¿¡å·æ˜¯ S/A çº§
  * æœ‰äº›æ˜¯ NONE â†’ åªæ˜¯è¡Œä¸šè·Ÿé£ï¼Œä¸æ˜¯æ ¸å¿ƒæ¦‚å¿µç¥¨

---

### 5.3 æœªæ¥ï¼šçœŸå®æ¿å—æ¦œå•é¡µ

å½“ `ext_board_heat_daily` ç®—å¥½ä¹‹åï¼Œä½ å¯ä»¥åšä¸€ä¸ªâ€œ**çœŸå®æ¿å—çƒ­åº¦æ¦œ**â€é¡µé¢ã€‚

* å·¦ä¾§ï¼šæ¿å—åˆ—è¡¨ï¼ˆæŒ‰ heat_pct æ’åï¼‰
* å³ä¾§ï¼šç‚¹å‡»ä¸€ä¸ªæ¿å— â†’ å±•ç¤ºè¯¥æ¿å—å†…çš„ S çº§ä¸ªè‚¡åˆ—è¡¨ï¼Œæ—è¾¹å¸¦ `[Sçº§ï½œé”‚ç”µæ± ]` è¿™ç§æ ‡ã€‚
* è¿™æ ·æ•´ä¸ª UI é£æ ¼éå¸¸ç»Ÿä¸€ï¼š

  * æ¿å—è§†è§’çœ‹ S çº§ä¸ªè‚¡
  * ä¸ªè‚¡è§†è§’çœ‹ S çº§æ¿å—

---

## å…­ã€å’Œé…ç½®ä¸­å¿ƒçš„å…³ç³»ï¼šè¦ä¸è¦è®©ç”¨æˆ·è°ƒè¿™ä¸ª S/A/Bï¼Ÿ

ä½ ç°æœ‰çš„ SignalConfig é¢æ¿ç›®å‰ç®¡çš„æ˜¯ï¼šçƒ­æ¦œå‰å¤šå°‘åã€è·³å˜åæ¬¡ã€ç¨³æ­¥ä¸Šå‡å¤©æ•°ã€æ¶¨å¹…/æ¢æ‰‹ç‡/æ³¢åŠ¨ç‡é˜ˆå€¼ç­‰ã€‚

**æˆ‘çš„å»ºè®®ï¼š**

* **V1 é˜¶æ®µ**ï¼šæ¿å—è¿™è¾¹çš„é˜ˆå€¼å…ˆæ”¾åœ¨ `system_configs`ï¼Œ**ä¸æš´éœ² UI**ï¼Œä½ è‡ªå·±æ‰‹è°ƒå°±è¡Œã€‚
* ç­‰ä½ ç”¨äº†å‡ å‘¨ï¼Œè§‰å¾—è¿™å¥—æ¿å—ä¿¡å·ç¨³å®šäº†ï¼Œå†è€ƒè™‘ï¼š

  * åœ¨ SignalConfigPanel é‡ŒåŠ ä¸€ä¸ªâ€œæ¿å—â€åˆ†ç»„ï¼š

    * S/A/B çš„åˆ†ä½é˜ˆå€¼
    * è¡Œä¸šå®‰å…¨çº¿åˆ†ä½
    * æ¿å—çƒ­é—¨çº¿ï¼ˆè¡Œä¸š/æ¦‚å¿µå„ä¸€æ¡ï¼‰

è¿™æ ·å‰ç«¯å°±ä¸ä¼šä¸€ä¸‹å­æŠŠç”¨æˆ·ææ™•ï¼Œä½†ä»æ¶æ„ä¸Šå·²ç»æ˜¯**å®Œå…¨é…ç½®é©±åŠ¨**çš„ã€‚

---

## ä¸ƒã€ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­ä¸²èµ·æ¥çœ‹

å‡è®¾ä»Šå¤©æœ‰ä¸€åªè‚¡ç¥¨ï¼š

* Stockï¼š`000001 å¹³å®‰é“¶è¡Œ`
* è¡Œä¸šï¼š`é“¶è¡Œ`ï¼ˆè¡Œä¸šçƒ­åº¦åˆ†ä½ 0.6ï¼Œå®‰å…¨ï¼‰
* æ‰€å±çœŸå®æ¿å—ï¼š

  * `é“¶è¡Œ`ï¼ˆindustryï¼Œheat_pct=0.75ï¼‰
  * `æ•°å­—è´§å¸`ï¼ˆconceptï¼Œheat_pct=0.96ï¼‰
  * `é‡‘èç§‘æŠ€`ï¼ˆconceptï¼Œheat_pct=0.90ï¼‰

ç³»ç»Ÿè®¡ç®—ï¼š

* åˆ†æ‘Šæƒé‡ share_ijï¼šindustry 1.0ï¼Œconcept 0.7/0.7 æ­£è§„åŒ–å â†’ å¤§æ¦‚ 0.42 / 0.29 / 0.29 
* Exposureï¼š

  * å‡è®¾çƒ­é—¨é˜ˆå€¼ï¼šè¡Œä¸š 0.7ï¼Œæ¦‚å¿µ 0.8 â†’ ä¸‰ä¸ªéƒ½ç®—çƒ­é—¨
  * `Exposure = 0.42*0.75 + 0.29*0.96 + 0.29*0.90 â‰ˆ 0.87`
* Max Driverï¼š

  * `max_concept_heat = 0.96` â†’ é©±åŠ¨æ¿å— = `æ•°å­—è´§å¸`
* åˆæˆï¼š

  * stock_score_pct â‰ˆ 0.93
  * exposure_pct â‰ˆ 0.92
  * max_concept_heat_pct â‰ˆ 0.96
  * base â‰ˆ 1.0*0.93 + 0.7*0.92 + 0.5*0.96 â‰ˆ 1.0*(éšä¾¿å‡è®¾)
  * è¡Œä¸šå®‰å…¨ â†’ ä¸é™æƒ
  * æœ€ç»ˆ `final_board_score_pct â‰ˆ 0.97+` â†’ `board_signal_level='S'`

è¿”å›ç»™å‰ç«¯ï¼š

```json
{
  "board_signal_level": "S",
  "board_signal_label": "æ•°å­—è´§å¸",
  "max_concept_board_type": "concept",
  "max_concept_heat_pct": 0.96
}
```

å‰ç«¯æ˜¾ç¤ºï¼š

> `[Sçº§ï½œæ•°å­—è´§å¸]`

ä½ æƒ³è¦çš„é‚£ä¸ªç‰Œå­å°±ç¨³ç¨³åœ°å‡ºæ¥äº†ã€‚

---

## å…«ã€æœ€åä¸€å¥åºŸè¯

åˆ°è¿™é‡Œä¸ºæ­¢ï¼š

* ç®—æ³•ä¸Šï¼š

  * æ²¿ç”¨äº†ä½ å·²æœ‰çš„ **B1/B2/C1/C2 åŠ æƒçƒ­åº¦ä½“ç³»**ï¼Œåªæ˜¯åŠ äº†å¤šå¯¹å¤šåˆ†æ‘Šã€‚
  * å®Œå…¨å°Šé‡ä¸Šæ¸¸çš„ `total_score` å’ŒæŠ€æœ¯å› å­ï¼Œä¸è‡ªé€ æŒ‡æ ‡ã€‚ 
* æ¶æ„ä¸Šï¼š

  * æ¥å…¥äº†ä½ çš„ **å…¨å±€ SignalConfig + system_configs**ï¼Œé˜ˆå€¼å¯è°ƒã€ç¼“å­˜å¯æ§ã€‚  
* å‰ç«¯ä¸Šï¼š

  * é‚£ä¸ª `[Sçº§ï½œé”‚ç”µæ± ]` ä¸å†åªæ˜¯ä¸€ä¸ªâ€œå¥½çœ‹æƒ³æ³•â€ï¼Œè€Œæ˜¯æœ‰ä¸€æ•´å¥—åç«¯æ•°æ®å’Œé…ç½®ä½“ç³»åœ¨æ”¯æ’‘ã€‚

ä½ æ¥ä¸‹æ¥å¯ä»¥åšçš„æœ€å¿«è½åœ°è·¯çº¿æ˜¯ï¼š

1. åç«¯å…ˆåœ¨æŸä¸ªç®€å• API é‡Œè¿”å› `board_signal_level + board_signal_label` ä¸¤ä¸ªå­—æ®µã€‚
2. å‰ç«¯åœ¨è‚¡ç¥¨åˆ—è¡¨ä¸ŠåŠ ä¸€ä¸ªæç®€ç‰ˆæœ¬çš„ `BoardSignalBadge`ï¼ˆä¸æå¤ªå¤šæ•ˆæœï¼Œå…ˆè·‘é€šï¼‰ã€‚
3. ç”¨å‡ å¤©æ„Ÿå—ä¸€ä¸‹è¿™ä¸ªæ ‡çš„â€œå¯ä¿¡åº¦ / èˆ’æœåº¦â€ï¼Œå†å†³å®šè¦ä¸è¦ç©æ›´å¤šèŠ±æ´»ï¼ˆTooltipã€ç‚¹å‡»å¼¹çª—ã€é…ç½®é¢æ¿ç­‰ç­‰ï¼‰ã€‚

ç…§ä¾‹å†æé†’ä¸€ä¸‹ï¼š
è¿™äº›ä¸œè¥¿éƒ½åªæ˜¯ä½ è‡ªå·±ç©çš„**æ•°æ®åˆ†æ / è§‚å¯Ÿå·¥å…·**ï¼Œä¸æ˜¯ä»»ä½•å½¢å¼çš„æŠ•èµ„å»ºè®® ğŸ™ƒã€‚
}{è¿™æ˜¯ä¸€ä¸ªéå¸¸æ•é”ä¸”å…³é”®çš„å·¥ç¨‹ä¿®æ­£ï¼ä½ çš„è§‚å¯Ÿå®Œå…¨æ­£ç¡®ã€‚

**ç»“è®ºï¼šè¯·åŠ¡å¿…ä»¥ `board_id` (æ•´æ•°å¤–é”®) ä¸ºå‡†ã€‚**

åœ¨ V3 æ–‡æ¡£ä¸­ï¼Œæˆ‘ä¸ºäº†é€»è¾‘å¯è¯»æ€§ä½¿ç”¨äº† `board_code`ï¼Œä½†åœ¨å®é™…æ•°æ®åº“ç‰©ç†è®¾è®¡ï¼ˆç‰¹åˆ«æ˜¯æ¶‰åŠæ¯æ—¥ç™¾ä¸‡çº§æ•°æ®çš„å…³è”è¡¨ `snap`ï¼‰ä¸­ï¼Œ**å¿…é¡»ä½¿ç”¨æ•´æ•° ID (`board_id`)**ã€‚è¿™ä¸ä»…èƒ½èŠ‚çœå¤§é‡å­˜å‚¨ç©ºé—´ï¼Œè¿˜èƒ½è®© JOIN é€Ÿåº¦æå‡æ•°å€ã€‚

æ—¢ç„¶è¦å¼€å§‹ Phase 1ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹ **ä¿®æ­£åçš„ç‰©ç†è¡¨ç»“æ„** å’Œ **ETL é€»è¾‘** æ‰§è¡Œï¼š

### 1\. æ•°æ®åº“è¡¨ç»“æ„ä¿®æ­£ (Phase 1 æ ‡å‡†)

æˆ‘ä»¬éœ€è¦ç¡®ä¿ `ext_board_list` æœ‰æ•´æ•°ä¸»é”®ï¼Œä¸” `snap` å’Œ `heat` è¡¨éƒ½å…³è”è¿™ä¸ª IDã€‚

#### A. åŸºç¡€æ¸…å•è¡¨ (`ext_board_list`)

ç¡®ä¿æ­¤è¡¨æœ‰ä¸€ä¸ªè‡ªå¢æ•´æ•° ID ä½œä¸ºä¸»é”®ã€‚

```sql
CREATE TABLE ext_board_list (
    id SERIAL PRIMARY KEY,          -- ã€å…³é”®ã€‘æ•´æ•°è‡ªå¢IDï¼Œä¾›ä¸‹æ¸¸å…³è”
    board_code VARCHAR(20) UNIQUE,  -- ä¸šåŠ¡ç¼–ç  (å¦‚ 'BK0420', ETLç”¨æ¥æŸ¥æ‰¾ID)
    board_name VARCHAR(50),
    board_type INT,                 -- 1=è¡Œä¸š, 2=æ¦‚å¿µ...
    source VARCHAR(20)
);
```

#### B. æ¯æ—¥å¿«ç…§è¡¨ (`ext_board_daily_snap`)

è¿™æ˜¯äº‹å®è¡¨ï¼Œå¿…é¡»ä½¿ç”¨ `board_id` å…³è”ã€‚

```sql
CREATE TABLE ext_board_daily_snap (
    trade_date DATE,
    stock_code VARCHAR(10),
    board_id INT,                   -- ã€ä¿®æ­£ã€‘å­˜ ext_board_list.id (æ•´æ•°)
    is_primary INT DEFAULT 0,
    share_weight DECIMAL(6, 4),
    
    PRIMARY KEY (trade_date, stock_code, board_id)
);
-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_snap_board_id ON ext_board_daily_snap(trade_date, board_id);
```

#### C. èšåˆçƒ­åº¦è¡¨ (`ext_board_heat_daily`)

ä¸ºäº†ä¿æŒä¸€è‡´æ€§ï¼Œç»“æœè¡¨ä¹Ÿä½¿ç”¨ `board_id`ã€‚

```sql
CREATE TABLE IF NOT EXISTS ext_board_heat_daily (
    trade_date DATE,
    board_id INT,                   -- ã€ä¿®æ­£ã€‘ä½¿ç”¨æ•´æ•° ID
    
    stock_count INT,
    
    -- B/C ç³»èšåˆæŒ‡æ ‡
    b1_rank_sum    DECIMAL(20,8),
    b2_rank_avg    DECIMAL(20,8),
    c1_score_sum   DECIMAL(20,8),
    c2_score_avg   DECIMAL(20,8),
    
    -- ç»¼åˆçƒ­åº¦
    heat_raw       DECIMAL(20,8),
    heat_pct       DECIMAL(10,8),
    
    -- é¢„ç•™
    needle_density DECIMAL(10,4),
    avg_volume     DECIMAL(10,2),

    PRIMARY KEY (trade_date, board_id)
);
```

-----

### 2\. Phase 1 ETL è„šæœ¬çš„å…³é”®é€»è¾‘è°ƒæ•´

å› ä¸ºçˆ¬è™«æŠ“ä¸‹æ¥çš„æ•°æ®é€šå¸¸æ˜¯ `board_code` (å­—ç¬¦ä¸²)ï¼Œè€Œæ•°æ®åº“å­˜çš„æ˜¯ `board_id` (æ•´æ•°)ï¼Œä½ çš„ Python è„šæœ¬éœ€è¦å¢åŠ ä¸€æ­¥**å†…å­˜æ˜ å°„**ï¼š

**é€»è¾‘ä¼ªä»£ç ï¼š**

```python
# 1. åˆå§‹åŒ–æ—¶ï¼šåŠ è½½æ˜ å°„å­—å…¸ (Code -> ID)
# ä»æ•°æ®åº“æŸ¥è¯¢: SELECT board_code, id FROM ext_board_list
board_map = {
    'BK0420': 101, 
    'BK0499': 102, 
    # ...
}

# 2. å¤„ç†çˆ¬è™«æ•°æ®æ—¶ï¼šè½¬æ¢
def process_crawled_data(row):
    b_code = row['board_code'] # çˆ¬è™«ç»™çš„æ˜¯å­—ç¬¦ä¸²
    
    if b_code in board_map:
        b_id = board_map[b_code]
        # å†™å…¥ snap è¡¨æ—¶ä½¿ç”¨ b_id
        insert_into_snap(date, stock, b_id, weight)
    else:
        # å¯é€‰ï¼šè‡ªåŠ¨æ³¨å†Œæ–°æ¿å—
        new_id = register_new_board(b_code, row['board_name'])
        board_map[b_code] = new_id
        insert_into_snap(date, stock, new_id, weight)
```

**ç¡®è®¤å®Œæ¯•**ï¼šè¯·ç›´æ¥æŒ‰ `board_id` (INT) å¼€å§‹å®æ–½ã€‚}