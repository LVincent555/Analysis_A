# 🚀 V3.5 外部板块系统 - 算法透明化与深度可视化规划书

**版本**: V3.5 (Anti-Lazy Edition)  
**创建日期**: 2025-12-11  
**状态**: 🔴 待实施  
**核心任务**: 剔除宽指噪音 + 修复评分基准 + 算力透明化 + 深度可视化

---

## 📋 问题诊断报告

### 当前系统存在的三大致命问题

| 问题编号 | 问题名称 | 严重程度 | 现象描述 |
|----------|----------|----------|----------|
| **BUG-001** | 宽指噪音未清洗 | 🔴 严重 | 南极电商显示"融资融券 [S级]"，掩盖了真正有价值的"百货零售"或"跨境电商" |
| **BUG-002** | S级通胀/评分基准错误 | 🔴 严重 | 酿酒行业全员S级，说明算法可能在板块内部排名而非全市场对标 |
| **BUG-003** | 可视化黑盒 | 🟡 中等 | 看不到分摊系数 `share_ij`、贡献分、加权计算过程，无法验证算法正确性 |
| **BUG-004** | 显示数量受限 | 🟡 中等 | 板块详情只显示前20只股票，无法查看完整成分股 |
| **BUG-005** | 信号降级逻辑缺失 | 🔴 严重 | 当前板块无S级时不显示其他板块的S级信号，信息丢失 |

### 问题根源分析

```
┌─────────────────────────────────────────────────────────────────────┐
│ 【根因1】task_board_heat.py Line 491-492                            │
│                                                                     │
│   top_boards.sort(key=lambda x: x['heat_pct'], reverse=True)       │
│   max_driver = top_boards[0] if top_boards else {}                  │
│                                                                     │
│ → 问题：无脑取热度最高的板块，完全没有过滤宽指黑名单                  │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ 【根因2】task_board_heat.py Line 514-521                            │
│                                                                     │
│   if final_score >= signal_S_pct:                                   │
│       signal_level = 'S'                                            │
│                                                                     │
│ → 问题：final_score 的计算基准是什么？是否对标全市场5000只股票？     │
│   当前公式：w_stock*总分 + w_exposure*共振 + w_max*最强概念          │
│   阈值 signal_S_pct = 0.97 是绝对值而非分位数！                      │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ 【根因3】board_heat.py Line 403                                     │
│                                                                     │
│   LIMIT 20                                                          │
│                                                                     │
│ → 问题：成分股查询硬编码限制20条，前端无法分页                       │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 一、核心逻辑修正方案 (Backend Logic Fixes)

### 1.1 宽指黑名单与降权机制 (The Noise Filter)

#### 1.1.1 定义结构性黑名单

**位置**: `system_configs` 表或 `backend/app/core/constants.py`

```python
# 宽指黑名单 - 这些板块对个股分析几乎无意义
BROAD_INDEX_BLACKLIST = [
    # 资金通道类
    '融资融券', '转融通标的', '深股通', '沪股通', '港股通',
    # 指数成分类
    '富时罗素', '标准普尔', 'MSCI中国', '上证180', '上证380',
    'HS300_', '沪深300', '中证500', '中证1000', '创业板综',
    # 机构持仓类
    '证金持股', '基金重仓', '社保重仓', 'QFII重仓', '险资重仓',
    # 市值分类类
    '大盘股', '中盘股', '小盘股', '微盘股',
    # 其他无效概念
    '预盈预增', '预亏预减', '业绩预告', '年报季报',
    'ST股', '*ST', '次新股', '新股与次新股',
]

# 黑名单板块的权重惩罚系数（接近0但保留底色）
BLACKLIST_WEIGHT_PENALTY = 0.01
```

#### 1.1.2 ETL权重降权实现

**修改文件**: `backend/scripts/task_board_heat.py`

```python
def _calc_share_weight(self, df_snap: pd.DataFrame, df_board: pd.DataFrame) -> pd.DataFrame:
    """
    计算分摊权重 share_ij（热度守恒）
    【V3.5 新增】：黑名单板块强制降权
    """
    # 合并板块类型
    df = df_snap.merge(df_board, left_on='board_id', right_on='id', how='left')
    
    # 加载黑名单
    blacklist = self._get_blacklist()
    
    # 分配类型权重
    type_weights = {
        'industry': self.config.w_industry,
        'concept': self.config.w_concept,
        'region': self.config.w_region
    }
    df['type_weight'] = df['board_type'].map(type_weights).fillna(self.config.w_concept)
    
    # 【V3.5】黑名单降权
    df['is_blacklisted'] = df['board_name'].apply(
        lambda name: any(bl in name for bl in blacklist)
    )
    df.loc[df['is_blacklisted'], 'type_weight'] *= BLACKLIST_WEIGHT_PENALTY
    
    # 计算每只股票的权重总和
    stock_weight_sum = df.groupby('stock_code')['type_weight'].transform('sum')
    
    # 计算分摊权重
    df['share_ij'] = df['type_weight'] / stock_weight_sum
    
    return df[['stock_code', 'board_id', 'board_type', 'board_name', 
               'share_ij', 'is_blacklisted', 'type_weight']]
```

#### 1.1.3 信号展示降级策略 (Fallback Strategy)

**修改文件**: `backend/scripts/task_board_heat.py` 的 `_calc_and_save_stock_signals` 方法

```python
def _select_best_driver(self, top_boards: list, board_info: dict) -> dict:
    """
    【V3.5 核心】选择最佳驱动板块（替补降级策略）
    
    优先级：
    1. 非黑名单的 S/A 级概念板块
    2. 非黑名单的 S/A 级行业板块  
    3. 非黑名单的 B 级概念板块
    4. 非黑名单的 B 级行业板块
    5. 如果只剩黑名单板块，返回空（不显示信号）
    """
    # 按信号等级分组
    s_a_concepts = []  # 非黑名单 S/A 级概念
    s_a_industries = []  # 非黑名单 S/A 级行业
    b_concepts = []  # 非黑名单 B 级概念
    b_industries = []  # 非黑名单 B 级行业
    blacklisted = []  # 黑名单板块
    
    s_pct = self.config.get('board_signal_S_pct', 0.97)
    a_pct = self.config.get('board_signal_A_pct', 0.90)
    b_pct = self.config.get('board_signal_B_pct', 0.80)
    
    for board in top_boards:
        heat_pct = board.get('heat_pct', 0)
        board_type = board.get('type', '')
        is_blacklisted = board.get('is_blacklisted', False)
        
        if is_blacklisted:
            blacklisted.append(board)
            continue
        
        # 判断信号等级
        if heat_pct >= s_pct or heat_pct >= a_pct:  # S/A 级
            if board_type == 'concept':
                s_a_concepts.append(board)
            else:
                s_a_industries.append(board)
        elif heat_pct >= b_pct:  # B 级
            if board_type == 'concept':
                b_concepts.append(board)
            else:
                b_industries.append(board)
    
    # 按优先级返回
    for candidate_list in [s_a_concepts, s_a_industries, b_concepts, b_industries]:
        if candidate_list:
            # 在同级中选热度最高的
            return max(candidate_list, key=lambda x: x['heat_pct'])
    
    # 全是黑名单，返回空
    return {}
```

### 1.2 评分基准修正 (Ranking Fix)

#### 1.2.1 问题分析

当前 `signal_S_pct = 0.97` 被当作**绝对阈值**使用：
```python
if final_score >= signal_S_pct:  # 0.97 是绝对值！
    signal_level = 'S'
```

但 `final_score` 的计算公式是：
```python
final_score = w_stock * (total_score / 100) + w_exposure * exposure + w_max_concept * max_heat
```

这导致：
- 如果一个板块全员高分，那么该板块全员都能达到 0.97，全员S级
- 没有全市场分位对标，纯属"自嗨"

#### 1.2.2 修正方案：全市场分位制

```python
def _calc_and_save_stock_signals(self, ...):
    """
    【V3.5 修正】信号等级基于全市场分位
    """
    # ... 计算所有股票的 final_score ...
    
    # 收集所有 final_score
    all_final_scores = []
    for stock_code, group in grouped:
        # ... 计算 final_score ...
        all_final_scores.append({
            'stock_code': stock_code,
            'final_score': final_score,
            # ... 其他字段 ...
        })
    
    # 【V3.5】计算全市场分位
    df_signals = pd.DataFrame(all_final_scores)
    df_signals['final_score_pct'] = df_signals['final_score'].rank(pct=True)
    
    # 基于分位判定等级
    for idx, row in df_signals.iterrows():
        pct = row['final_score_pct']
        if pct >= s_pct:  # 0.97 = Top 3%
            signal_level = 'S'
        elif pct >= a_pct:  # 0.90 = Top 10%
            signal_level = 'A'
        elif pct >= b_pct:  # 0.80 = Top 20%
            signal_level = 'B'
        else:
            signal_level = 'NONE'
        
        df_signals.at[idx, 'signal_level'] = signal_level
```

#### 1.2.3 权重验证与调整

确保个股自身分在最终公式中占主导地位：

| 权重项 | 当前值 | 建议值 | 说明 |
|--------|--------|--------|------|
| `board_w_stock` | 1.0 | **1.5** | 个股自身分权重提高 |
| `board_w_exposure` | 0.7 | 0.5 | 板块共振权重降低 |
| `board_w_max_concept` | 0.5 | 0.3 | 最强概念权重降低 |

**配置更新SQL**:
```sql
UPDATE system_configs SET config_value = '1.5' WHERE config_key = 'board_w_stock';
UPDATE system_configs SET config_value = '0.5' WHERE config_key = 'board_w_exposure';
UPDATE system_configs SET config_value = '0.3' WHERE config_key = 'board_w_max_concept';
```

### 1.3 数据库表结构增强

#### 1.3.1 新增字段

```sql
-- 1. ext_board_list 新增黑名单标记
ALTER TABLE ext_board_list ADD COLUMN IF NOT EXISTS is_broad_index BOOLEAN DEFAULT FALSE;

-- 2. cache_stock_board_signal 新增透明化字段
ALTER TABLE cache_stock_board_signal ADD COLUMN IF NOT EXISTS final_score_pct DECIMAL(10,8);
ALTER TABLE cache_stock_board_signal ADD COLUMN IF NOT EXISTS fallback_reason VARCHAR(50);
ALTER TABLE cache_stock_board_signal ADD COLUMN IF NOT EXISTS blacklisted_boards_json TEXT;
ALTER TABLE cache_stock_board_signal ADD COLUMN IF NOT EXISTS contribution_details_json TEXT;

-- 3. 新增宽指黑名单配置表
CREATE TABLE IF NOT EXISTS board_blacklist (
    id SERIAL PRIMARY KEY,
    keyword VARCHAR(50) NOT NULL UNIQUE,
    reason VARCHAR(100),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 初始化黑名单数据
INSERT INTO board_blacklist (keyword, reason) VALUES
('融资融券', '资金通道类，对个股分析无意义'),
('转融通', '资金通道类'),
('深股通', '资金通道类'),
('沪股通', '资金通道类'),
('港股通', '资金通道类'),
('富时罗素', '指数成分类'),
('标准普尔', '指数成分类'),
('MSCI', '指数成分类'),
('证金持股', '机构持仓类'),
('基金重仓', '机构持仓类'),
('大盘股', '市值分类'),
('中盘股', '市值分类')
ON CONFLICT (keyword) DO NOTHING;
```

### 1.4 API透明化增强

#### 1.4.1 板块详情接口增强

**修改文件**: `backend/app/routers/board_heat.py`

```python
@router.get("/board/{board_id}")
async def get_board_detail(
    board_id: int,
    trade_date: Optional[str] = Query(None),
    limit: int = Query(50, ge=1, le=500),  # 支持分页
    offset: int = Query(0, ge=0),
    sort_by: str = Query("contribution", description="排序字段: contribution/rank/score"),
    db: Session = Depends(get_db),
    current_user = Depends(get_current_user)
):
    """
    【V3.5 增强】板块详情接口
    - 支持分页（limit/offset）
    - 返回 share_weight（分摊权重）
    - 返回 contribution_score（贡献分）
    - 默认按贡献度排序
    """
    # ... 获取板块基础信息 ...
    
    # 成分股查询（增强版）
    stocks_sql = """
    SELECT 
        s.stock_code, 
        st.stock_name, 
        s.board_rank,
        s.weight as share_weight,  -- 【V3.5】分摊权重
        d.total_score,
        d.rank as market_rank,
        d.price_change,
        d.turnover_rate_percent,
        d.volatility,
        (s.weight * d.total_score) as contribution_score,  -- 【V3.5】贡献分
        c.signal_level,
        c.max_driver_name,
        c.board_count
    FROM ext_board_daily_snap s
    LEFT JOIN stocks st ON s.stock_code = st.stock_code
    LEFT JOIN daily_stock_data d ON s.stock_code = d.stock_code AND d.date = :trade_date
    LEFT JOIN cache_stock_board_signal c ON s.stock_code = c.stock_code AND c.trade_date = :trade_date
    WHERE s.board_id = :board_id AND s.date = :snap_date
    ORDER BY 
        CASE WHEN :sort_by = 'contribution' THEN (s.weight * COALESCE(d.total_score, 0)) END DESC,
        CASE WHEN :sort_by = 'rank' THEN d.rank END ASC,
        CASE WHEN :sort_by = 'score' THEN d.total_score END DESC
    LIMIT :limit OFFSET :offset
    """
```

#### 1.4.2 新增个股DNA诊断接口

```python
@router.get("/stock/{stock_code}/dna")
async def get_stock_board_dna(
    stock_code: str,
    trade_date: Optional[str] = Query(None),
    db: Session = Depends(get_db),
    current_user = Depends(get_current_user)
):
    """
    【V3.5 新增】个股板块基因诊断
    返回该股票的完整板块分析过程
    """
    # 获取该股所有关联板块
    sql = """
    SELECT 
        s.board_id,
        b.board_name,
        b.board_type,
        s.weight as share_weight,
        h.heat_pct,
        CASE WHEN bl.id IS NOT NULL THEN TRUE ELSE FALSE END as is_blacklisted,
        bl.reason as blacklist_reason
    FROM ext_board_daily_snap s
    JOIN ext_board_list b ON s.board_id = b.id
    LEFT JOIN ext_board_heat_daily h ON s.board_id = h.board_id AND h.trade_date = :trade_date
    LEFT JOIN board_blacklist bl ON b.board_name LIKE '%' || bl.keyword || '%' AND bl.is_active = TRUE
    WHERE s.stock_code = :stock_code AND s.date = :snap_date
    ORDER BY h.heat_pct DESC NULLS LAST
    """
    
    # ... 查询并构建响应 ...
    
    return {
        "stock_code": stock_code,
        "stock_name": stock_name,
        "final_signal": {
            "level": "A",
            "label": "百货零售",
            "score": 0.85,
            "score_pct": 0.92
        },
        "score_breakdown": {
            "stock_score": 0.75,
            "exposure_score": 0.82,
            "max_driver_score": 0.91,
            "formula": "1.5 * 0.75 + 0.5 * 0.82 + 0.3 * 0.91 = 1.908 (normalized: 0.85)"
        },
        "board_allocation": [
            {"name": "百货零售", "type": "industry", "share": 0.50, "heat_pct": 0.91, "status": "✅ 最佳匹配"},
            {"name": "跨境电商", "type": "concept", "share": 0.30, "heat_pct": 0.60, "status": "⬇️ 热度不够"},
            {"name": "融资融券", "type": "concept", "share": 0.20, "heat_pct": 0.99, "status": "🚫 黑名单"}
        ],
        "fallback_log": [
            "Step 1: 检索非黑名单S/A级概念 → 未找到",
            "Step 2: 检索非黑名单S/A级行业 → 找到[百货零售] heat_pct=0.91",
            "Step 3: 选定最佳驱动板块 → 百货零售"
        ]
    }
```

---

## 二、全新可视化页面设计 (UI/UX Design)

### 2.1 页面总览

| 页面编号 | 页面名称 | 类型 | 优先级 | 状态 |
|----------|----------|------|--------|------|
| **P1** | 板块热度榜增强版 | 列表页 | 🔴 高 | 待开发 |
| **P2** | 板块深度透视页 | 详情页 | 🔴 高 | 待开发 |
| **P3** | 个股板块DNA诊断卡 | 弹窗 | 🔴 高 | 待开发 |
| **P4** | 信号配置面板增强 | 设置面板 | 🟡 中 | 待开发 |

### 2.2 P1: 板块热度榜增强版

**文件**: `frontend-client/src/pages/ExtBoardHeat.js`

#### 2.2.1 布局设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 📊 东财板块热度榜                                   📅 2025-12-11 ▼    │
├─────────────────────────────────────────────────────────────────────────┤
│ [🔥 全部] [🏭 行业] [💡 概念]    🔍 搜索板块...    ⚙️ 过滤黑名单 ☑️   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  # │ 板块名称        │ 类型 │ 热度  │ 成分股 │ TOP100占比 │ 平均涨幅  │
│ ───┼─────────────────┼──────┼───────┼────────┼────────────┼────────── │
│  1 │ 🔥 酿酒行业     │ 行业 │ 99.8% │   37   │   40.5%    │  +2.35%  │
│  2 │ 🔥 银行         │ 行业 │ 98.5% │   42   │   33.3%    │  +1.82%  │
│  3 │ 💡 人形机器人   │ 概念 │ 97.2% │  128   │   25.0%    │  +3.56%  │
│  4 │ 💡 固态电池     │ 概念 │ 96.8% │   85   │   22.4%    │  +2.88%  │
│  5 │ ⚫ 融资融券     │ 概念 │ 95.2% │ 2100   │   4.8%     │  +0.52%  │ ← 灰色标记
│    │                 │      │       │        │            │          │
│ ───┴─────────────────┴──────┴───────┴────────┴────────────┴────────── │
│                                                                         │
│  📈 热度分布: [████████████░░░░] 78% 板块热度 > 50%                    │
│  📊 行业/概念: 行业 87 个 | 概念 439 个 | 已过滤黑名单 23 个            │
│                                                                         │
│  ◀ 上一页    第 1/11 页    下一页 ▶    每页 [50 ▼] 条                  │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 2.2.2 新增功能点

| 功能 | 说明 | 实现方式 |
|------|------|----------|
| **黑名单过滤** | 复选框控制是否显示宽指板块 | 前端过滤 + API参数 |
| **黑名单标记** | 宽指板块灰色显示、排名靠后 | CSS类 `.blacklisted` |
| **TOP100占比** | 新增列：该板块成分股中TOP100占多少 | 后端计算返回 |
| **分页控制** | 支持自定义每页条数 | limit/offset 参数 |

### 2.3 P2: 板块深度透视页 (Board Deep Dive)

**文件**: `frontend-client/src/components/BoardDetailDialog.js` → 重构为 `BoardDeepDivePage.js`

#### 2.3.1 布局设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  ← 返回    📊 酿酒行业 详情分析                           📅 2025-12-11   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────┐  ┌─────────────────────────────────────┐  │
│  │    📈 多维雷达图             │  │    📊 关键指标                       │  │
│  │                             │  │                                     │  │
│  │         B1(龙头)            │  │    🔥 热度分位    99.81%            │  │
│  │           ●                 │  │    📊 成分股数    37 只             │  │
│  │     ●           ●           │  │    🏆 TOP100占比  40.5%             │  │
│  │  B2(密度)       C1(总量)    │  │    📈 S级成分股   15 只 (40.5%)     │  │
│  │     ●           ●           │  │    💰 平均得分    82.5 分           │  │
│  │           ●                 │  │    📉 平均涨幅    +2.35%            │  │
│  │         C2(能量)            │  │    🔄 平均换手    3.2%              │  │
│  │                             │  │                                     │  │
│  └─────────────────────────────┘  └─────────────────────────────────────┘  │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  🏆 成分股超级表格 (共 37 只)                    排序: [贡献度 ▼] 🔍 搜索  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  # │ 股票     │ 信号         │ 原始分 │ 分摊权重 │ 贡献度  │ 市场排名 │ 涨幅   │
│ ───┼──────────┼──────────────┼────────┼──────────┼─────────┼──────────┼─────── │
│  1 │ 贵州茅台 │ [S级|酿酒]   │  89.5  │  1.000   │  89.50  │   #3     │ +2.1%  │
│  2 │ 五粮液   │ [S级|酿酒]   │  85.2  │  1.000   │  85.20  │   #8     │ +1.8%  │
│  3 │ 泸州老窖 │ [A级|酿酒]   │  78.3  │  0.850   │  66.56  │  #25     │ +2.5%  │
│  4 │ 山西汾酒 │ [A级|酿酒]   │  75.1  │  0.800   │  60.08  │  #32     │ +3.2%  │
│  5 │ 重庆啤酒 │ [S级|融资融券]│ 72.0  │  0.700   │  50.40  │  #45     │ +1.9%  │ ← 信号不匹配！
│    │          │              │        │          │         │          │        │
│    │ 💡 提示：该股信号标签来自其他板块，非当前板块                          │
│                                                                             │
│  ◀ 1  2  3  ▶                                          共 37 条 / 4 页     │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  📊 贡献度分布图                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  ████████████████████████████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ │   │
│  │  贵州茅台 (18.5%) | 五粮液 (17.6%) | 泸州老窖 (13.8%) | 其他 (50.1%)   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 2.3.2 关键字段说明

| 字段 | 来源 | 计算方式 | 意义 |
|------|------|----------|------|
| **原始分 (Raw Score)** | `daily_stock_data.total_score` | 直接读取 | 个股自身技术评分 |
| **分摊权重 (Share)** | `ext_board_daily_snap.weight` | ETL计算 | 该股分配给本板块的权重 |
| **贡献度 (Contribution)** | 计算字段 | `原始分 × 分摊权重` | 对板块热度的实际贡献 |
| **信号标签** | `cache_stock_board_signal` | 查询 | 该股的最终信号（可能来自其他板块） |

#### 2.3.3 雷达图维度

```javascript
const radarData = {
  labels: ['B1 龙头强度', 'B2 龙头密度', 'C1 资金总量', 'C2 平均能量'],
  datasets: [{
    label: '酿酒行业',
    data: [
      normalize(b1_rank_sum, allBoards),  // 归一化到 0-100
      normalize(b2_rank_avg, allBoards),
      normalize(c1_score_sum, allBoards),
      normalize(c2_score_avg, allBoards)
    ],
    backgroundColor: 'rgba(255, 99, 132, 0.2)',
    borderColor: 'rgba(255, 99, 132, 1)',
  }]
};
```

### 2.4 P3: 个股板块DNA诊断卡 (Stock DNA Card)

**文件**: `frontend-client/src/components/StockBoardDNACard.js`

#### 2.4.1 触发方式

点击股票列表中的 `[S级｜锂电池]` 信号标签时，弹出 Popover 卡片。

#### 2.4.2 布局设计

```
┌───────────────────────────────────────────────────────────────────┐
│ 🧬 南极电商 (002127) 板块基因诊断                          ✕     │
├───────────────────────────────────────────────────────────────────┤
│                                                                   │
│  🏆 最终评级: [ A级 ]      💰 综合得分: 0.852 (分位: 92.3%)       │
│                                                                   │
├───────────────────────────────────────────────────────────────────┤
│  📊 1. 你的能量去哪了？(权重分配饼图)                             │
│                                                                   │
│     ┌─────────────────────────┐                                   │
│     │      ████████          │  ■ 百货零售 (50%) - 🛡️ 行业       │
│     │    ██████████████      │  ■ 跨境电商 (30%) - ⚔️ 概念        │
│     │      ████████          │  □ 融资融券 (20%) - 🚫 已降权      │
│     └─────────────────────────┘                                   │
│                                                                   │
├───────────────────────────────────────────────────────────────────┤
│  🎯 2. 信号竞选现场 (Fallback Log)                                │
│                                                                   │
│  板块名称      类型    热度   权重   状态                         │
│  ─────────────────────────────────────────────────────────────    │
│  融资融券      概念    99%    0.01   🚫 黑名单跳过                │
│  跨境电商      概念    60%    0.30   ⬇️ 热度不够(B级)             │
│  百货零售      行业    91%    0.50   ✅ 最佳匹配 (A级)            │
│                                                                   │
├───────────────────────────────────────────────────────────────────┤
│  🧮 3. 得分计算公式                                               │
│                                                                   │
│  FinalScore = 1.5 × Stock + 0.5 × Exposure + 0.3 × MaxDriver      │
│             = 1.5 × 0.75  + 0.5 × 0.72     + 0.3 × 0.91           │
│             = 1.125 + 0.36 + 0.273                                │
│             = 1.758 → 归一化 → 0.852                              │
│                                                                   │
│  全市场分位: 92.3% (Top 7.7%)  →  评级: A级                       │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘
```

#### 2.4.3 组件接口

```jsx
// 使用方式
<StockBoardDNACard
  stockCode="002127"
  tradeDate="2025-12-11"
  trigger={
    <BoardSignalBadge level="A" label="百货零售" />
  }
/>

// 内部调用 API
GET /api/board-heat/stock/002127/dna?trade_date=2025-12-11
```

---

## 三、前端组件清单

### 3.1 需要新建的组件

| 组件名 | 类型 | 路径 | 说明 |
|--------|------|------|------|
| `BoardDeepDivePage.js` | 页面 | `pages/` | 板块深度透视页（替代简陋弹窗） |
| `StockBoardDNACard.js` | 组件 | `components/` | 个股DNA诊断卡（Popover） |
| `BoardContributionChart.js` | 组件 | `components/` | 贡献度分布图（ECharts） |
| `BoardRadarChart.js` | 组件 | `components/` | B/C维度雷达图（ECharts） |
| `BoardBlacklistFilter.js` | 组件 | `components/` | 黑名单过滤控件 |

### 3.2 需要修改的组件

| 组件名 | 修改内容 |
|--------|----------|
| `ExtBoardHeat.js` | 增加黑名单过滤、分页控制、TOP100占比列 |
| `BoardDetailDialog.js` | 重构为支持全量成分股分页、贡献度排序 |
| `BoardSignalBadge.js` | 增加点击事件，触发DNA诊断卡 |

---

## 四、给 IDE 的防偷懒指令单

### 指令 1: 修复后端逻辑 (Backend Logic Fix)

```
【任务】修复外部板块系统的信号计算逻辑，解决"宽指干扰"和"S级通胀"问题。

【具体要求】

1. **引入黑名单机制**
   - 在 `backend/app/core/constants.py` 新建 BROAD_INDEX_BLACKLIST 列表
   - 包含：融资融券、深股通、沪股通、转融券、富时罗素、MSCI、证金持股、基金重仓、大盘股、中盘股
   - 在数据库新建 `board_blacklist` 表，支持动态配置

2. **修正 ETL 权重计算**
   - 修改 `backend/scripts/task_board_heat.py` 的 `_calc_share_weight` 方法
   - 如果板块名称命中黑名单，强制将其 `type_weight` 乘以 0.01（极低权重）
   - 在返回的 DataFrame 中新增 `is_blacklisted` 列

3. **修正个股信号逻辑**
   - 修改 `_calc_and_save_stock_signals` 方法
   - 实现"降级替补"策略 `_select_best_driver`：
     - 优先找非黑名单的 S/A 级概念
     - 如果没有，找非黑名单的 S/A 级行业
     - 如果还没有，找非黑名单的 B 级
     - 禁止直接显示黑名单内的板块名称

4. **修正评分基准**
   - 将 `signal_S_pct = 0.97` 改为基于全市场分位判定
   - 计算所有股票的 `final_score` 后，用 `rank(pct=True)` 得到分位
   - 基于分位值判定 S/A/B 等级

5. **API 透明化增强**
   - `/api/board-heat/board/{id}` 支持分页（limit/offset）
   - 每行数据返回 `share_weight` 和 `contribution_score`
   - 默认按 `contribution_score` 降序排列

【验收标准】
- 南极电商的信号标签不再显示"融资融券"，而是显示"百货零售"或其他有意义的板块
- 酿酒行业不再全员S级，只有真正的龙头股才是S级
- 板块详情页可以查看完整成分股（分页）
- 每只股票能看到分摊权重和贡献分
```

### 指令 2: 开发可视化组件 (Frontend Visualization)

```
【任务】开发 V3.5 版板块分析页面，拒绝黑盒展示。

【具体要求】

1. **重构 BoardDetailDialog → BoardDeepDivePage**
   - 从弹窗升级为独立页面（路由 /board/:id）
   - 支持分页显示全量成分股（后端 limit/offset）
   - 新增列：原始分、分摊权重(Share)、贡献度(Contrib)
   - 默认按贡献度降序排列
   - 增加排序切换按钮

2. **仪表盘区域**
   - 在页面顶部增加 ECharts 雷达图（B1/B2/C1/C2 四个维度）
   - 右侧显示关键指标卡片：热度分位、成分股数、TOP100占比、S级占比

3. **开发 StockBoardDNACard 组件**
   - 这是一个 Popover，点击 BoardSignalBadge 时触发
   - 内容包括：
     a) 饼图：展示 share_weight 分布
     b) 竞选列表：列出所有关联板块，标记黑名单和最终选中的板块
     c) 公式透视：显示 FinalScore 的计算数值
   - 调用新接口 `/api/board-heat/stock/{code}/dna`

4. **修改 ExtBoardHeat 页面**
   - 增加"过滤黑名单"复选框
   - 黑名单板块用灰色显示
   - 新增"TOP100占比"列

【技术要求】
- 使用 ECharts 绑定图表
- 使用 TailwindCSS 样式
- 遵循现有代码风格
- 图表颜色使用渐变色（参考 BoardSignalBadge 的 S/A/B 配色）

【验收标准】
- 板块详情页能分页查看所有成分股
- 能看到每只股票的贡献度排名
- 点击信号标签能弹出DNA诊断卡
- 诊断卡里能看到完整的计算过程和黑名单过滤日志
```

### 指令 3: 数据库迁移脚本 (Database Migration)

```
【任务】创建数据库迁移脚本 006_board_signal_v35.sql

【内容要求】

1. 新建 board_blacklist 表
2. 初始化黑名单数据（至少20个关键词）
3. ext_board_list 新增 is_broad_index 列
4. cache_stock_board_signal 新增透明化字段：
   - final_score_pct (分位值)
   - fallback_reason (降级原因)
   - blacklisted_boards_json (被过滤的黑名单板块)
   - contribution_details_json (贡献度明细)
5. 更新 system_configs 配置项的权重值

【验收标准】
- 脚本可重复执行（使用 IF NOT EXISTS）
- 有完整注释
```

---

## 五、实施路线图

### Phase 1: 后端逻辑修复 (Day 1-2)

| 任务 | 优先级 | 预估工时 | 负责人 |
|------|--------|----------|--------|
| 创建数据库迁移脚本 | P0 | 1h | Backend |
| 实现黑名单加载逻辑 | P0 | 2h | Backend |
| 修改 ETL 权重计算 | P0 | 3h | Backend |
| 实现 Fallback 选择策略 | P0 | 3h | Backend |
| 修正评分基准为分位制 | P0 | 2h | Backend |
| API 透明化增强 | P1 | 3h | Backend |

### Phase 2: 前端可视化 (Day 3-4)

| 任务 | 优先级 | 预估工时 | 负责人 |
|------|--------|----------|--------|
| BoardDeepDivePage 重构 | P0 | 4h | Frontend |
| 雷达图组件开发 | P1 | 2h | Frontend |
| StockBoardDNACard 组件 | P0 | 4h | Frontend |
| ExtBoardHeat 页面增强 | P1 | 2h | Frontend |
| 联调测试 | P0 | 2h | Full Stack |

### Phase 3: 验证与优化 (Day 5)

| 任务 | 优先级 | 预估工时 | 负责人 |
|------|--------|----------|--------|
| 端到端测试 | P0 | 2h | QA |
| 性能优化（大数据量分页） | P1 | 2h | Backend |
| 文档更新 | P2 | 1h | All |

---

## 六、验收标准清单

### 6.1 功能验收

- [ ] 南极电商的信号标签显示"百货零售"而非"融资融券"
- [ ] 酿酒行业成分股中，只有少数龙头是S级，大部分是A/B级
- [ ] 板块详情页支持分页，能查看全部成分股
- [ ] 成分股表格显示"分摊权重"和"贡献度"列
- [ ] 点击信号标签能弹出DNA诊断卡
- [ ] 诊断卡显示完整的Fallback日志
- [ ] 黑名单板块在热度榜中灰色显示或可过滤

### 6.2 数据验收

- [ ] `board_blacklist` 表有至少20条记录
- [ ] `cache_stock_board_signal.fallback_reason` 字段有值
- [ ] `cache_stock_board_signal.final_score_pct` 字段有值
- [ ] 全市场S级股票占比约3%（而非之前的20%+）

---

## 七、附录

### 7.1 配置项速查表

| 配置键 | 默认值 | V3.5建议值 | 说明 |
|--------|--------|------------|------|
| `board_w_stock` | 1.0 | **1.5** | 个股自身分权重 |
| `board_w_exposure` | 0.7 | **0.5** | 板块共振权重 |
| `board_w_max_concept` | 0.5 | **0.3** | 最强概念权重 |
| `board_signal_S_pct` | 0.97 | 0.97 | S级分位阈值 |
| `board_signal_A_pct` | 0.90 | 0.90 | A级分位阈值 |
| `board_signal_B_pct` | 0.80 | 0.80 | B级分位阈值 |
| `blacklist_weight_penalty` | - | **0.01** | 黑名单权重惩罚 |

### 7.2 黑名单关键词速查

```
资金通道类: 融资融券, 转融通, 深股通, 沪股通, 港股通
指数成分类: 富时罗素, 标准普尔, MSCI, 上证180, HS300, 中证500, 创业板综
机构持仓类: 证金持股, 基金重仓, 社保重仓, QFII重仓, 险资重仓
市值分类类: 大盘股, 中盘股, 小盘股, 微盘股
业绩相关类: 预盈预增, 预亏预减, 业绩预告
其他无效类: ST股, *ST, 次新股, 新股与次新股
```

---

**文档结束**

> 📌 **使用指南**: 将本文档直接发送给 IDE AI，要求其按照"防偷懒指令单"逐步实施。每完成一个Phase，要求其提交代码并说明变更点。
