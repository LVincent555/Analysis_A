# ç³»ç»Ÿç®¡ç†æ¨¡å—è®¾è®¡æ–‡æ¡£

> **ç‰ˆæœ¬**: v1.1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-04  
> **æ›´æ–°æ—¥æœŸ**: 2025-12-04  
> **çŠ¶æ€**: è®¾è®¡é˜¶æ®µ  
> **ä¼˜å…ˆçº§**: P0ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰  
> **ä¾èµ–æ–‡æ¡£**: [ç»Ÿä¸€ç¼“å­˜ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ](../optimization/ç»Ÿä¸€ç¼“å­˜ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ.md)

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#1-æ¦‚è¿°)
2. [ç°çŠ¶åˆ†æ](#2-ç°çŠ¶åˆ†æ)
3. [åŠŸèƒ½è®¾è®¡](#3-åŠŸèƒ½è®¾è®¡)
4. [æ•°æ®åº“è®¾è®¡](#4-æ•°æ®åº“è®¾è®¡)
5. [APIè®¾è®¡](#5-apiè®¾è®¡)
6. [å‰ç«¯è®¾è®¡](#6-å‰ç«¯è®¾è®¡)
7. [å®‰å…¨è®¾è®¡](#7-å®‰å…¨è®¾è®¡)
8. [å®æ–½è®¡åˆ’](#8-å®æ–½è®¡åˆ’)

---

## 1. æ¦‚è¿°

### 1.1 èƒŒæ™¯

å½“å‰ç³»ç»Ÿç®¡ç†æ¨¡å—åŠŸèƒ½ç®€é™‹ï¼Œä»…æœ‰åŸºç¡€çš„ç”¨æˆ·ç™»å½•è®°å½•æŸ¥çœ‹åŠŸèƒ½ã€‚éšç€ç³»ç»Ÿç”¨æˆ·å¢åŠ å’Œå®‰å…¨éœ€æ±‚æå‡ï¼Œéœ€è¦ä¸“ä¸šåŒ–æ”¹é€ ç³»ç»Ÿç®¡ç†æ¨¡å—ï¼Œæä¾›å®Œæ•´çš„ç”¨æˆ·ç®¡ç†ã€ä¼šè¯æ§åˆ¶ã€æƒé™ç®¡ç†å’Œå®‰å…¨å®¡è®¡èƒ½åŠ›ã€‚

### 1.2 ç›®æ ‡

- **ç”¨æˆ·ç®¡ç†ä¸“ä¸šåŒ–**ï¼šå®Œæ•´çš„CRUDæ“ä½œï¼Œæ”¯æŒæ‰¹é‡ç®¡ç†
- **ä¼šè¯æ§åˆ¶ç²¾ç»†åŒ–**ï¼šå®æ—¶çŠ¶æ€ç›‘æ§ï¼Œå¼ºåˆ¶ä¸‹çº¿èƒ½åŠ›
- **æƒé™ç®¡ç†è§„èŒƒåŒ–**ï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰
- **å®‰å…¨å®¡è®¡å®Œæ•´åŒ–**ï¼šå…¨é¢çš„æ“ä½œæ—¥å¿—å’Œå®‰å…¨æ—¥å¿—
- **ç­–ç•¥é…ç½®çµæ´»åŒ–**ï¼šå¯é…ç½®çš„å®‰å…¨ç­–ç•¥

### 1.3 èŒƒå›´

| æ¨¡å— | åŠŸèƒ½ | ä¼˜å…ˆçº§ |
|------|------|--------|
| ç”¨æˆ·ç®¡ç† | CRUDã€çŠ¶æ€æ§åˆ¶ã€å¯†ç ç®¡ç† | P0 |
| ä¼šè¯ç®¡ç† | çŠ¶æ€ç›‘æ§ã€å¼ºåˆ¶ä¸‹çº¿ã€è®¾å¤‡ç®¡ç† | P0 |
| æ“ä½œæ—¥å¿— | ç™»å½•æ—¥å¿—ã€æ“ä½œå®¡è®¡ã€å®‰å…¨äº‹ä»¶ | P1 |
| è§’è‰²æƒé™ | è§’è‰²ç®¡ç†ã€æƒé™åˆ†é… | P2 |
| å®‰å…¨ç­–ç•¥ | å¯†ç ç­–ç•¥ã€ç™»å½•ç­–ç•¥ã€ä¼šè¯ç­–ç•¥ | P2 |
| ç³»ç»Ÿé…ç½® | åŸºç¡€é…ç½®ã€é€šçŸ¥é…ç½® | P3 |

---

## 2. ç°çŠ¶åˆ†æ

### 2.1 ç°æœ‰æ•°æ®æ¨¡å‹

#### Users è¡¨ï¼ˆç°æœ‰ï¼‰
```python
class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True)
    username = Column(String(50), unique=True, nullable=False)
    password_hash = Column(String(255), nullable=False)
    user_key_encrypted = Column(Text, nullable=False)
    
    role = Column(String(20), default='user')      # admin/user
    is_active = Column(Boolean, default=True)
    
    created_at = Column(TIMESTAMP, default=datetime.utcnow)
    last_login = Column(TIMESTAMP, nullable=True)
    
    allowed_devices = Column(Integer, default=3)
    offline_enabled = Column(Boolean, default=True)
    offline_days = Column(Integer, default=7)
```

#### UserSessions è¡¨ï¼ˆç°æœ‰ï¼‰
```python
class UserSession(Base):
    __tablename__ = "user_sessions"
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"))
    device_id = Column(String(100), nullable=False)
    device_name = Column(String(100), nullable=True)
    
    session_key_encrypted = Column(Text, nullable=False)
    refresh_token = Column(String(500), nullable=True)
    
    created_at = Column(TIMESTAMP)
    expires_at = Column(TIMESTAMP, nullable=False)
    last_active = Column(TIMESTAMP)
```

### 2.2 ç°æœ‰é—®é¢˜

| é—®é¢˜ | å½±å“ | ä¸¥é‡ç¨‹åº¦ |
|------|------|----------|
| æ— ç”¨æˆ·CRUDç•Œé¢ | åªèƒ½é€šè¿‡API/æ•°æ®åº“ç®¡ç†ç”¨æˆ· | é«˜ |
| çŠ¶æ€åˆ¤æ–­ç®€å• | ä»…åŸºäºTokenè¿‡æœŸæ—¶é—´ï¼Œæ— å¿ƒè·³æœºåˆ¶ | ä¸­ |
| æ— å¼ºåˆ¶ä¸‹çº¿ | æ— æ³•å¤„ç†å®‰å…¨äº‹ä»¶æ—¶ç«‹å³ç»ˆæ­¢ä¼šè¯ | é«˜ |
| æ— ç™»å½•å¤±è´¥è¿½è¸ª | æ— æ³•é˜²æ­¢æš´åŠ›ç ´è§£ | é«˜ |
| æ— æ“ä½œæ—¥å¿— | æ— æ³•å®¡è®¡è¿½æº¯ | ä¸­ |
| è§’è‰²ä»…2ç§ | admin/userï¼Œä¸å¤Ÿçµæ´» | ä½ |
| æ— IPè®°å½• | æ— æ³•è¯†åˆ«å¼‚å¸¸ç™»å½• | ä¸­ |

### 2.3 ç°æœ‰ä¼˜åŠ¿ï¼ˆä¿ç•™ï¼‰

- âœ… JWT Tokenè®¤è¯æœºåˆ¶æˆç†Ÿ
- âœ… bcryptå¯†ç å“ˆå¸Œå®‰å…¨
- âœ… AES-256-GCMåŠ å¯†é€šä¿¡
- âœ… å¤šè®¾å¤‡ç™»å½•é™åˆ¶å·²å®ç°
- âœ… Refresh Tokenåˆ·æ–°æœºåˆ¶

---

## 3. åŠŸèƒ½è®¾è®¡

### 3.1 ç”¨æˆ·ç®¡ç†æ¨¡å—

#### 3.1.1 åŠŸèƒ½æ¸…å•

| åŠŸèƒ½ | æè¿° | æƒé™è¦æ±‚ |
|------|------|----------|
| ç”¨æˆ·åˆ—è¡¨ | åˆ†é¡µã€æœç´¢ã€ç­›é€‰ã€æ’åº | admin |
| åˆ›å»ºç”¨æˆ· | è®¾ç½®ç”¨æˆ·åã€å¯†ç ã€è§’è‰²ã€é…ç½® | admin |
| ç¼–è¾‘ç”¨æˆ· | ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯å’Œé…ç½® | admin |
| åˆ é™¤ç”¨æˆ· | è½¯åˆ é™¤/ç¡¬åˆ é™¤ï¼ˆå¯é…ç½®ï¼‰ | admin |
| å¯ç”¨/ç¦ç”¨ | åˆ‡æ¢ç”¨æˆ·çŠ¶æ€ | admin |
| é‡ç½®å¯†ç  | ç®¡ç†å‘˜é‡ç½®ç”¨æˆ·å¯†ç  | admin |
| æ‰¹é‡æ“ä½œ | æ‰¹é‡å¯ç”¨/ç¦ç”¨/åˆ é™¤ | admin |

#### 3.1.2 ç”¨æˆ·ä¿¡æ¯æ‰©å±•

```
æ–°å¢å­—æ®µï¼š
â”œâ”€â”€ email           - é‚®ç®±ï¼ˆå¯é€‰ï¼Œç”¨äºé€šçŸ¥ï¼‰
â”œâ”€â”€ phone           - æ‰‹æœºï¼ˆå¯é€‰ï¼Œç”¨äºé€šçŸ¥ï¼‰
â”œâ”€â”€ avatar          - å¤´åƒURL
â”œâ”€â”€ nickname        - æ˜µç§°/æ˜¾ç¤ºå
â”œâ”€â”€ remark          - å¤‡æ³¨
â”œâ”€â”€ expires_at      - è´¦å·æœ‰æ•ˆæœŸï¼ˆnull=æ°¸ä¹…ï¼‰
â”œâ”€â”€ failed_attempts - ç™»å½•å¤±è´¥æ¬¡æ•°
â”œâ”€â”€ locked_until    - é”å®šæˆªæ­¢æ—¶é—´
â”œâ”€â”€ created_by      - åˆ›å»ºè€…ID
â”œâ”€â”€ updated_at      - æœ€åæ›´æ–°æ—¶é—´
â””â”€â”€ deleted_at      - åˆ é™¤æ—¶é—´ï¼ˆè½¯åˆ é™¤ï¼‰
```

#### 3.1.3 ç”¨æˆ·çŠ¶æ€æœº

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    åˆ›å»ºè´¦æˆ·     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º æ­£å¸¸ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                    â”‚
        â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
        â”‚    â”‚             â”‚             â”‚     â”‚
        â”‚    â–¼             â–¼             â–¼     â”‚
        â”‚  ç¦ç”¨          é”å®š          è¿‡æœŸ    â”‚
        â”‚    â”‚             â”‚             â”‚     â”‚
        â”‚    â”‚  ç®¡ç†å‘˜     â”‚ è‡ªåŠ¨è§£é”    â”‚     â”‚
        â”‚    â”‚  å¯ç”¨       â”‚ /æ‰‹åŠ¨è§£é”   â”‚     â”‚
        â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
        â”‚                  â”‚                    â”‚
        â”‚                  â”‚  ç»­æœŸ/é‡æ–°æ¿€æ´»     â”‚
        â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚  æ¢å¤è´¦æˆ·
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å·²åˆ é™¤ï¼ˆè½¯åˆ é™¤ï¼‰
```

### 3.2 ä¼šè¯ç®¡ç†æ¨¡å—

#### 3.2.1 åŠŸèƒ½æ¸…å•

| åŠŸèƒ½ | æè¿° | æƒé™è¦æ±‚ |
|------|------|----------|
| æ´»è·ƒä¼šè¯åˆ—è¡¨ | æŸ¥çœ‹æ‰€æœ‰åœ¨çº¿ä¼šè¯ | admin |
| ä¼šè¯è¯¦æƒ… | æŸ¥çœ‹ä¼šè¯è¯¦ç»†ä¿¡æ¯ï¼ˆIPã€è®¾å¤‡ã€ä½ç½®ï¼‰ | admin |
| å¼ºåˆ¶ä¸‹çº¿ | ç»ˆæ­¢æŒ‡å®šä¼šè¯ | admin |
| å¼ºåˆ¶ä¸‹çº¿å…¨éƒ¨ | ç»ˆæ­¢æŒ‡å®šç”¨æˆ·æ‰€æœ‰ä¼šè¯ | admin |
| ä¼šè¯ç»Ÿè®¡ | åœ¨çº¿äººæ•°ã€è®¾å¤‡åˆ†å¸ƒç­‰ | admin |

#### 3.2.2 æ™ºèƒ½å¿ƒè·³æœºåˆ¶

> âš ï¸ **æ ¸å¿ƒè®¾è®¡**ï¼šåˆ©ç”¨ Electron æ¡Œé¢ç«¯ä¼˜åŠ¿ï¼Œç»“åˆç»Ÿä¸€ç¼“å­˜ç³»ç»Ÿå®ç°é«˜æ€§èƒ½å¿ƒè·³

**å®¢æˆ·ç«¯çŠ¶æ€å®šä¹‰**ï¼š

| çŠ¶æ€ç  | çŠ¶æ€ | åˆ¤å®šæ¡ä»¶ |
|--------|------|----------|
| 1 | Active | 60ç§’å†…æœ‰é¼ æ ‡/é”®ç›˜æ“ä½œ |
| 2 | Idle | è¶…è¿‡60ç§’æ— æ“ä½œï¼ˆç³»ç»Ÿçº§ï¼‰ |
| 3 | Locked | å±å¹•å·²é”å®šï¼ˆç³»ç»Ÿçº§ï¼‰ |

**å¿ƒè·³å‘é€ç­–ç•¥**ï¼š
- **é¢‘ç‡**ï¼šæ¯ 30ç§’ å‘é€ä¸€æ¬¡
- **å†…å®¹**ï¼š`{ "s": 1 }` æç®€Payloadï¼Œå‡å°‘åŠ å¯†å¼€é”€
- **é€šé“**ï¼šèµ° `/api/secure` åŠ å¯†é€šé“

**Electron ä¸»è¿›ç¨‹å®ç°**ï¼š
```javascript
// main.js - ç³»ç»Ÿçº§çŠ¶æ€ç›‘å¬
const { powerMonitor, ipcMain } = require('electron');

ipcMain.handle('get-system-status', () => {
  const idleTime = powerMonitor.getSystemIdleTime(); // ç§’
  const state = powerMonitor.getSystemIdleState(60); // 'active', 'idle', 'locked'
  
  if (state === 'locked') return 3;
  if (idleTime > 60) return 2;
  return 1;
});
```

**æœåŠ¡ç«¯å¤„ç†**ï¼š
- å¿ƒè·³ç›´æ¥å†™å…¥ç»Ÿä¸€ç¼“å­˜ç³»ç»Ÿ ObjectStoreï¼ˆå¾®ç§’çº§ï¼‰
- åå°çº¿ç¨‹å®šæœŸæ‰¹é‡åŒæ­¥åˆ°æ•°æ®åº“ (Write-Behind ç­–ç•¥)
- è¯¦è§ï¼š[ç»Ÿä¸€ç¼“å­˜ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ](../optimization/ç»Ÿä¸€ç¼“å­˜ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ.md)

#### 3.2.3 åœ¨çº¿çŠ¶æ€åˆ¤æ–­é€»è¾‘ï¼ˆ5çº§ç²¾ç»†çŠ¶æ€ï¼‰

| çŠ¶æ€ | é¢œè‰² | åˆ¤å®šé€»è¾‘ | ä¸šåŠ¡å«ä¹‰ |
|------|------|----------|----------|
| æ´»è·ƒ (Active) | ğŸŸ¢ ç»¿ | `last_active < 2min` AND `status='online'` | ç”¨æˆ·æ­£åœ¨æ“ä½œ |
| ç©ºé—² (Idle) | ğŸŸ¡ é»„ | `last_active < 30min` AND `status='idle'` | ç”µè„‘å¼€ç€ä½†äººä¸åœ¨ |
| é”å± (Locked) | ğŸ”’ ç° | `last_active < 30min` AND `status='locked'` | ç”¨æˆ·é”å®šäº†å±å¹• |
| å¤±è” (Lost) | ğŸ”´ çº¢ | `2min < last_active < 5min` | å¿ƒè·³æ–­è¿ï¼ˆæ–­ç½‘/å´©æºƒï¼‰ |
| ç¦»çº¿ (Offline) | âš« é»‘ | `last_active > 30min` | ä¼šè¯å·²ç»“æŸæˆ–è¶…æ—¶ |

**åç«¯çŠ¶æ€åˆ¤å®šå®ç°**ï¼š
```python
def get_session_status(session: SessionState) -> dict:
    """
    ä¼šè¯çŠ¶æ€åˆ¤æ–­ - ä»ç»Ÿä¸€ç¼“å­˜ç³»ç»Ÿ ObjectStore è¯»å–
    """
    now = time.time()
    idle_seconds = now - session.last_active
    
    status_map = {1: "online", 2: "idle", 3: "locked"}
    client_status = status_map.get(session.status, "online")
    
    if idle_seconds <= 120:  # 2åˆ†é’Ÿå†…
        return {"status": "active", "color": "green", "label": "æ´»è·ƒ"}
    elif idle_seconds <= 300:  # 2-5åˆ†é’Ÿ
        return {"status": "lost", "color": "red", "label": "å¤±è”"}
    elif idle_seconds <= 1800:  # 5-30åˆ†é’Ÿ
        if client_status == "locked":
            return {"status": "locked", "color": "gray", "label": "é”å±"}
        elif client_status == "idle":
            return {"status": "idle", "color": "yellow", "label": "ç©ºé—²"}
        else:
            return {"status": "idle", "color": "yellow", "label": "ç©ºé—²"}
    else:
        return {"status": "offline", "color": "black", "label": "ç¦»çº¿"}
```

#### 3.2.4 ä¼šè¯ä¿¡æ¯æ‰©å±•

```
æ–°å¢å­—æ®µï¼ˆæ•°æ®åº“ï¼‰ï¼š
â”œâ”€â”€ ip_address      - ç™»å½•IP
â”œâ”€â”€ user_agent      - æµè§ˆå™¨/å®¢æˆ·ç«¯ä¿¡æ¯
â”œâ”€â”€ location        - åœ°ç†ä½ç½®ï¼ˆå¯é€‰ï¼ŒIPè§£æï¼‰
â”œâ”€â”€ platform        - å¹³å°ï¼ˆWindows/Mac/Linuxï¼‰
â”œâ”€â”€ app_version     - å®¢æˆ·ç«¯ç‰ˆæœ¬
â”œâ”€â”€ device_info     - è®¾å¤‡è¯¦æƒ… (JSONB)
â”‚   â”œâ”€â”€ hostname    - è®¾å¤‡åç§° (DESKTOP-5A2B3C)
â”‚   â”œâ”€â”€ os_detail   - ç³»ç»Ÿè¯¦æƒ… (Windows 10 Pro 22H2)
â”‚   â””â”€â”€ hw_hash     - ç¡¬ä»¶æŒ‡çº¹ (ç”¨äºè¯†åˆ«è®¾å¤‡)
â”œâ”€â”€ current_status  - å½“å‰çŠ¶æ€ (online/idle/locked)
â”œâ”€â”€ is_revoked      - æ˜¯å¦è¢«æ’¤é”€ï¼ˆå¼ºåˆ¶ä¸‹çº¿æ ‡è®°ï¼‰
â”œâ”€â”€ revoked_at      - æ’¤é”€æ—¶é—´
â””â”€â”€ revoked_by      - æ’¤é”€æ“ä½œè€…ID

æ–°å¢å­—æ®µï¼ˆç»Ÿä¸€ç¼“å­˜ç³»ç»Ÿ ObjectStoreï¼‰ï¼š
â”œâ”€â”€ status          - å®¢æˆ·ç«¯ä¸ŠæŠ¥çŠ¶æ€ç  (1/2/3)
â”œâ”€â”€ last_active     - æœ€åæ´»è·ƒæ—¶é—´æˆ³ (Unix)
â”œâ”€â”€ is_dirty        - è„æ ‡è®°ï¼ˆéœ€è¦åŒæ­¥åˆ°DBï¼‰
â””â”€â”€ token_ver       - Tokenç‰ˆæœ¬å·ï¼ˆç”¨äºå¼ºåˆ¶ä¸‹çº¿æ ¡éªŒï¼‰
```

#### 3.2.5 å¼ºåˆ¶ä¸‹çº¿æœºåˆ¶

> âš ï¸ **è®¾è®¡é¢„ç•™ï¼Œæš‚ä¸å®æ–½** - ä¿ç•™æ¥å£è®¾è®¡ï¼ŒPhase 2+ å®æ–½

**æ— Redisæ–¹æ¡ˆï¼šTokenç‰ˆæœ¬å·æœºåˆ¶**

```
Users è¡¨æ–°å¢å­—æ®µï¼štoken_version (Integer, default=1)
JWT Payload æ–°å¢ï¼š"v": 1 (ç­¾å‘æ—¶çš„ç‰ˆæœ¬å·)

éªŒè¯é€»è¾‘ï¼š
1. è§£å¯† Tokenï¼Œæ‹¿åˆ° payload.v å’Œ user_id
2. ä»ç»Ÿä¸€ç¼“å­˜ç³»ç»Ÿè¯»å–å½“å‰ token_version
3. å¦‚æœ payload.v < token_version â†’ Tokenå¤±æ•ˆ

å¼ºåˆ¶ä¸‹çº¿æ“ä½œï¼š
UPDATE users SET token_version = token_version + 1 WHERE id=...
â†’ è¯¥ç”¨æˆ·æ‰€æœ‰æ—§ JWT ç«‹å³å¤±æ•ˆ
```

**å¼ºåˆ¶ä¸‹çº¿æµç¨‹**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç®¡ç†å‘˜æ“ä½œ   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ›´æ–°å†…å­˜ token_version+1  â”‚
â”‚ 2. æ ‡è®°ä¼šè¯ä¸º is_dirty       â”‚
â”‚ 3. è®°å½•æ“ä½œæ—¥å¿—              â”‚
â”‚ (åå°çº¿ç¨‹åŒæ­¥åˆ°DB)           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯ä¸‹æ¬¡è¯·æ±‚æ—¶ï¼š            â”‚
â”‚ - æ ¡éªŒ payload.v < token_ver â”‚
â”‚ - è¿”å› 401 + force_logout   â”‚
â”‚ - å®¢æˆ·ç«¯æ¸…é™¤å‡­è¯å¹¶è·³è½¬ç™»å½•    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 æ“ä½œæ—¥å¿—æ¨¡å—

#### 3.3.1 æ—¥å¿—ç±»å‹

| ç±»å‹ | ä»£ç  | æè¿° | ç¤ºä¾‹ |
|------|------|------|------|
| ç™»å½•æ—¥å¿— | LOGIN | ç™»å½•ç›¸å…³äº‹ä»¶ | ç™»å½•æˆåŠŸã€ç™»å½•å¤±è´¥ã€ç™»å‡º |
| ç”¨æˆ·æ“ä½œ | USER | ç”¨æˆ·ç®¡ç†æ“ä½œ | åˆ›å»ºç”¨æˆ·ã€ä¿®æ”¹ç”¨æˆ·ã€åˆ é™¤ç”¨æˆ· |
| ä¼šè¯æ“ä½œ | SESSION | ä¼šè¯ç®¡ç†æ“ä½œ | å¼ºåˆ¶ä¸‹çº¿ã€æ¸…é™¤ä¼šè¯ |
| å®‰å…¨äº‹ä»¶ | SECURITY | å®‰å…¨ç›¸å…³äº‹ä»¶ | å¯†ç ä¿®æ”¹ã€å¼‚å¸¸ç™»å½•ã€è´¦æˆ·é”å®š |
| ç³»ç»Ÿæ“ä½œ | SYSTEM | ç³»ç»Ÿé…ç½®å˜æ›´ | ä¿®æ”¹å®‰å…¨ç­–ç•¥ã€ä¿®æ”¹ç³»ç»Ÿé…ç½® |

#### 3.3.2 æ—¥å¿—å­—æ®µè®¾è®¡ï¼ˆå«å˜æ›´å®¡è®¡ï¼‰

```python
class OperationLog:
    id              # æ—¥å¿—ID
    log_type        # æ—¥å¿—ç±»å‹ (LOGIN/USER/SESSION/SECURITY/SYSTEM)
    action          # å…·ä½“åŠ¨ä½œ (login_success/login_failed/user_create/...)
    operator_id     # æ“ä½œè€…ID (null=ç³»ç»Ÿ)
    operator_name   # æ“ä½œè€…ç”¨æˆ·å
    target_type     # ç›®æ ‡ç±»å‹ (user/session/config/...)
    target_id       # ç›®æ ‡ID
    target_name     # ç›®æ ‡åç§°
    ip_address      # æ“ä½œIP
    user_agent      # æ“ä½œè®¾å¤‡
    detail          # è¯¦ç»†ä¿¡æ¯ (JSON)
    old_value       # ğŸ†• ä¿®æ”¹å‰çš„å€¼ (JSONB) - ç”¨äºå˜æ›´å®¡è®¡
    new_value       # ğŸ†• ä¿®æ”¹åçš„å€¼ (JSONB) - ç”¨äºå˜æ›´å®¡è®¡
    status          # çŠ¶æ€ (success/failed)
    error_message   # é”™è¯¯ä¿¡æ¯
    created_at      # åˆ›å»ºæ—¶é—´
```

**å˜æ›´å®¡è®¡ç¤ºä¾‹**ï¼š
```json
// ç®¡ç†å‘˜ä¿®æ”¹ç”¨æˆ·æƒé™
{
  "action": "user_update",
  "target_name": "user1",
  "old_value": {"role": "user", "offline_days": 7},
  "new_value": {"role": "admin", "offline_days": 30}
}
```

#### 3.3.3 å…³é”®äº‹ä»¶è®°å½•

**ç™»å½•ç›¸å…³**ï¼š
- `login_success` - ç™»å½•æˆåŠŸ
- `login_failed` - ç™»å½•å¤±è´¥ï¼ˆè®°å½•åŸå› ï¼šå¯†ç é”™è¯¯/è´¦æˆ·ç¦ç”¨/è´¦æˆ·é”å®šï¼‰
- `logout` - ä¸»åŠ¨ç™»å‡º
- `token_refresh` - Tokenåˆ·æ–°
- `session_expired` - ä¼šè¯è¿‡æœŸ

**ç”¨æˆ·ç®¡ç†**ï¼š
- `user_create` - åˆ›å»ºç”¨æˆ·
- `user_update` - ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯
- `user_delete` - åˆ é™¤ç”¨æˆ·
- `user_enable` - å¯ç”¨ç”¨æˆ·
- `user_disable` - ç¦ç”¨ç”¨æˆ·
- `password_reset` - å¯†ç é‡ç½®
- `password_change` - å¯†ç ä¿®æ”¹

**å®‰å…¨äº‹ä»¶**ï¼š
- `account_locked` - è´¦æˆ·é”å®šï¼ˆå¤±è´¥æ¬¡æ•°è¿‡å¤šï¼‰
- `account_unlocked` - è´¦æˆ·è§£é”
- `force_logout` - å¼ºåˆ¶ä¸‹çº¿
- `suspicious_login` - å¯ç–‘ç™»å½•ï¼ˆå¼‚åœ°/å¼‚å¸¸è®¾å¤‡ï¼‰

### 3.4 å®‰å…¨ç­–ç•¥æ¨¡å—

#### 3.4.1 å¯†ç ç­–ç•¥

| é…ç½®é¡¹ | å­—æ®µå | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|--------|------|
| æœ€å°é•¿åº¦ | `password_min_length` | 6 | å¯†ç æœ€å°å­—ç¬¦æ•° |
| æœ€å¤§é•¿åº¦ | `password_max_length` | 100 | å¯†ç æœ€å¤§å­—ç¬¦æ•° |
| è¦æ±‚æ•°å­— | `password_require_digit` | false | å¿…é¡»åŒ…å«æ•°å­— |
| è¦æ±‚å¤§å†™ | `password_require_upper` | false | å¿…é¡»åŒ…å«å¤§å†™å­—æ¯ |
| è¦æ±‚å°å†™ | `password_require_lower` | false | å¿…é¡»åŒ…å«å°å†™å­—æ¯ |
| è¦æ±‚ç‰¹æ®Šå­—ç¬¦ | `password_require_special` | false | å¿…é¡»åŒ…å«ç‰¹æ®Šå­—ç¬¦ |
| è¿‡æœŸå¤©æ•° | `password_expire_days` | 0 | å¯†ç è¿‡æœŸå¤©æ•°ï¼Œ0=ä¸è¿‡æœŸ |

#### 3.4.2 ç™»å½•ç­–ç•¥

| é…ç½®é¡¹ | å­—æ®µå | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|--------|------|
| å¤±è´¥é”å®šæ¬¡æ•° | `login_max_attempts` | 5 | è¿ç»­å¤±è´¥å¤šå°‘æ¬¡åé”å®š |
| é”å®šæ—¶é•¿(åˆ†é’Ÿ) | `login_lockout_minutes` | 30 | é”å®šæ—¶é•¿ |
| å¤±è´¥è®¡æ•°é‡ç½®(åˆ†é’Ÿ) | `login_attempt_reset_minutes` | 60 | å¤šä¹…åé‡ç½®å¤±è´¥è®¡æ•° |
| å¯ç”¨éªŒè¯ç  | `login_captcha_enabled` | false | æ˜¯å¦å¯ç”¨éªŒè¯ç  |
| éªŒè¯ç è§¦å‘æ¬¡æ•° | `login_captcha_threshold` | 3 | å¤±è´¥å¤šå°‘æ¬¡åæ˜¾ç¤ºéªŒè¯ç  |

#### 3.4.3 ä¼šè¯ç­–ç•¥

| é…ç½®é¡¹ | å­—æ®µå | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|--------|------|
| Access Tokenæœ‰æ•ˆæœŸ(å°æ—¶) | `session_access_token_hours` | 24 | Access Tokenæœ‰æ•ˆæ—¶é•¿ |
| Refresh Tokenæœ‰æ•ˆæœŸ(å¤©) | `session_refresh_token_days` | 7 | Refresh Tokenæœ‰æ•ˆæ—¶é•¿ |
| æœ€å¤§å¹¶å‘è®¾å¤‡æ•° | `session_max_devices` | 3 | é»˜è®¤æœ€å¤§è®¾å¤‡æ•° |
| ç©ºé—²è¶…æ—¶(åˆ†é’Ÿ) | `session_idle_timeout_minutes` | 30 | ç©ºé—²å¤šä¹…åæ ‡è®°ä¸ºç¦»çº¿ |
| å•è®¾å¤‡ç™»å½• | `session_single_device` | false | æ˜¯å¦é™åˆ¶å•è®¾å¤‡ç™»å½• |

### 3.5 è§’è‰²æƒé™æ¨¡å—ï¼ˆP2ï¼‰

#### 3.5.1 é¢„è®¾è§’è‰²

| è§’è‰² | ä»£ç  | æƒé™èŒƒå›´ |
|------|------|----------|
| è¶…çº§ç®¡ç†å‘˜ | `super_admin` | æ‰€æœ‰æƒé™ï¼Œä¸å¯åˆ é™¤ |
| ç®¡ç†å‘˜ | `admin` | ç”¨æˆ·ç®¡ç†ã€ä¼šè¯ç®¡ç†ã€æ—¥å¿—æŸ¥çœ‹ |
| æ™®é€šç”¨æˆ· | `user` | ä»…æ•°æ®åˆ†æåŠŸèƒ½ |
| åªè¯»ç”¨æˆ· | `readonly` | ä»…æŸ¥çœ‹ï¼Œä¸å¯æ“ä½œ |

#### 3.5.2 æƒé™å®šä¹‰

```python
PERMISSIONS = {
    # åˆ†æåŠŸèƒ½
    "analysis:hotspot": "æœ€æ–°çƒ­ç‚¹åˆ†æ",
    "analysis:industry": "è¡Œä¸šè¶‹åŠ¿åˆ†æ",
    "analysis:rank_jump": "æ’åè·³å˜",
    "analysis:steady_rise": "ç¨³æ­¥ä¸Šå‡",
    "analysis:sector": "æ¿å—åˆ†æ",
    "analysis:signal": "ä¿¡å·ç³»ç»Ÿ",
    
    # æŸ¥è¯¢åŠŸèƒ½
    "query:stock": "è‚¡ç¥¨æŸ¥è¯¢",
    "query:sector": "æ¿å—æŸ¥è¯¢",
    
    # æ•°æ®ç®¡ç†
    "data:view": "æŸ¥çœ‹æ•°æ®ç®¡ç†",
    "data:import": "å¯¼å…¥æ•°æ®",
    "data:delete": "åˆ é™¤æ•°æ®",
    
    # ç”¨æˆ·ç®¡ç†
    "user:view": "æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨",
    "user:create": "åˆ›å»ºç”¨æˆ·",
    "user:update": "ç¼–è¾‘ç”¨æˆ·",
    "user:delete": "åˆ é™¤ç”¨æˆ·",
    "user:reset_password": "é‡ç½®å¯†ç ",
    
    # ä¼šè¯ç®¡ç†
    "session:view": "æŸ¥çœ‹ä¼šè¯åˆ—è¡¨",
    "session:force_logout": "å¼ºåˆ¶ä¸‹çº¿",
    
    # æ—¥å¿—ç®¡ç†
    "log:view": "æŸ¥çœ‹æ“ä½œæ—¥å¿—",
    "log:export": "å¯¼å‡ºæ—¥å¿—",
    
    # ç³»ç»Ÿé…ç½®
    "config:view": "æŸ¥çœ‹ç³»ç»Ÿé…ç½®",
    "config:update": "ä¿®æ”¹ç³»ç»Ÿé…ç½®",
}
```

---

## 4. æ•°æ®åº“è®¾è®¡

### 4.1 Users è¡¨æ‰©å±•

```sql
-- æ‰©å±•ç°æœ‰ users è¡¨
ALTER TABLE users ADD COLUMN IF NOT EXISTS email VARCHAR(255);
ALTER TABLE users ADD COLUMN IF NOT EXISTS phone VARCHAR(20);
ALTER TABLE users ADD COLUMN IF NOT EXISTS nickname VARCHAR(50);
ALTER TABLE users ADD COLUMN IF NOT EXISTS avatar_url VARCHAR(500);
ALTER TABLE users ADD COLUMN IF NOT EXISTS remark TEXT;
ALTER TABLE users ADD COLUMN IF NOT EXISTS expires_at TIMESTAMP;
ALTER TABLE users ADD COLUMN IF NOT EXISTS failed_attempts INT DEFAULT 0;
ALTER TABLE users ADD COLUMN IF NOT EXISTS locked_until TIMESTAMP;
ALTER TABLE users ADD COLUMN IF NOT EXISTS password_changed_at TIMESTAMP;
ALTER TABLE users ADD COLUMN IF NOT EXISTS created_by INT;
ALTER TABLE users ADD COLUMN IF NOT EXISTS updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;
ALTER TABLE users ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMP;
-- ğŸ†• å¼ºåˆ¶ä¸‹çº¿ç”¨ï¼ˆè®¾è®¡é¢„ç•™ï¼‰
ALTER TABLE users ADD COLUMN IF NOT EXISTS token_version INT DEFAULT 1;

-- ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
CREATE INDEX IF NOT EXISTS idx_users_is_active ON users(is_active);
CREATE INDEX IF NOT EXISTS idx_users_deleted_at ON users(deleted_at);
```

### 4.2 UserSessions è¡¨æ‰©å±•

```sql
-- æ‰©å±•ç°æœ‰ user_sessions è¡¨
ALTER TABLE user_sessions ADD COLUMN IF NOT EXISTS ip_address VARCHAR(45);
ALTER TABLE user_sessions ADD COLUMN IF NOT EXISTS user_agent VARCHAR(500);
ALTER TABLE user_sessions ADD COLUMN IF NOT EXISTS platform VARCHAR(50);
ALTER TABLE user_sessions ADD COLUMN IF NOT EXISTS app_version VARCHAR(20);
ALTER TABLE user_sessions ADD COLUMN IF NOT EXISTS location VARCHAR(100);
-- ğŸ†• è®¾å¤‡è¯¦æƒ…ï¼ˆç¡¬ä»¶æŒ‡çº¹ç­‰ï¼‰
ALTER TABLE user_sessions ADD COLUMN IF NOT EXISTS device_info JSONB;
-- ğŸ†• å½“å‰çŠ¶æ€ï¼ˆä»å†…å­˜åŒæ­¥ï¼‰
ALTER TABLE user_sessions ADD COLUMN IF NOT EXISTS current_status VARCHAR(20) DEFAULT 'online';
ALTER TABLE user_sessions ADD COLUMN IF NOT EXISTS is_revoked BOOLEAN DEFAULT FALSE;
ALTER TABLE user_sessions ADD COLUMN IF NOT EXISTS revoked_at TIMESTAMP;
ALTER TABLE user_sessions ADD COLUMN IF NOT EXISTS revoked_by INT;

-- ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_sessions_is_revoked ON user_sessions(is_revoked);
CREATE INDEX IF NOT EXISTS idx_sessions_last_active ON user_sessions(last_active);
CREATE INDEX IF NOT EXISTS idx_sessions_current_status ON user_sessions(current_status);
```

### 4.3 æ–°å¢ OperationLogs è¡¨

```sql
CREATE TABLE IF NOT EXISTS operation_logs (
    id SERIAL PRIMARY KEY,
    log_type VARCHAR(20) NOT NULL,           -- LOGIN/USER/SESSION/SECURITY/SYSTEM
    action VARCHAR(50) NOT NULL,             -- login_success/user_create/...
    
    operator_id INT,                         -- æ“ä½œè€…IDï¼ˆnull=ç³»ç»Ÿï¼‰
    operator_name VARCHAR(50),               -- æ“ä½œè€…ç”¨æˆ·å
    
    target_type VARCHAR(20),                 -- user/session/config
    target_id INT,
    target_name VARCHAR(100),
    
    ip_address VARCHAR(45),
    user_agent VARCHAR(500),
    
    detail JSONB,                            -- è¯¦ç»†ä¿¡æ¯
    old_value JSONB,                         -- ğŸ†• ä¿®æ”¹å‰çš„å€¼ï¼ˆå˜æ›´å®¡è®¡ï¼‰
    new_value JSONB,                         -- ğŸ†• ä¿®æ”¹åçš„å€¼ï¼ˆå˜æ›´å®¡è®¡ï¼‰
    status VARCHAR(20) DEFAULT 'success',    -- success/failed
    error_message TEXT,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_logs_log_type ON operation_logs(log_type);
CREATE INDEX idx_logs_action ON operation_logs(action);
CREATE INDEX idx_logs_operator_id ON operation_logs(operator_id);
CREATE INDEX idx_logs_target ON operation_logs(target_type, target_id);
CREATE INDEX idx_logs_created_at ON operation_logs(created_at);
CREATE INDEX idx_logs_status ON operation_logs(status);
```

### 4.4 æ–°å¢ SystemConfigs è¡¨

```sql
CREATE TABLE IF NOT EXISTS system_configs (
    id SERIAL PRIMARY KEY,
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value TEXT NOT NULL,
    config_type VARCHAR(20) DEFAULT 'string',  -- string/int/bool/json
    category VARCHAR(50) NOT NULL,             -- password/login/session/system
    description VARCHAR(255),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_by INT
);

-- åˆå§‹åŒ–é»˜è®¤é…ç½®
INSERT INTO system_configs (config_key, config_value, config_type, category, description) VALUES
-- å¯†ç ç­–ç•¥
('password_min_length', '6', 'int', 'password', 'å¯†ç æœ€å°é•¿åº¦'),
('password_max_length', '100', 'int', 'password', 'å¯†ç æœ€å¤§é•¿åº¦'),
('password_require_digit', 'false', 'bool', 'password', 'è¦æ±‚åŒ…å«æ•°å­—'),
('password_require_upper', 'false', 'bool', 'password', 'è¦æ±‚åŒ…å«å¤§å†™å­—æ¯'),
('password_require_lower', 'false', 'bool', 'password', 'è¦æ±‚åŒ…å«å°å†™å­—æ¯'),
('password_require_special', 'false', 'bool', 'password', 'è¦æ±‚åŒ…å«ç‰¹æ®Šå­—ç¬¦'),
('password_expire_days', '0', 'int', 'password', 'å¯†ç è¿‡æœŸå¤©æ•°ï¼Œ0=ä¸è¿‡æœŸ'),

-- ç™»å½•ç­–ç•¥
('login_max_attempts', '5', 'int', 'login', 'æœ€å¤§å¤±è´¥å°è¯•æ¬¡æ•°'),
('login_lockout_minutes', '30', 'int', 'login', 'é”å®šæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰'),
('login_attempt_reset_minutes', '60', 'int', 'login', 'å¤±è´¥è®¡æ•°é‡ç½®æ—¶é—´'),
('login_captcha_enabled', 'false', 'bool', 'login', 'å¯ç”¨éªŒè¯ç '),
('login_captcha_threshold', '3', 'int', 'login', 'éªŒè¯ç è§¦å‘æ¬¡æ•°'),

-- ä¼šè¯ç­–ç•¥
('session_access_token_hours', '24', 'int', 'session', 'Access Tokenæœ‰æ•ˆæœŸï¼ˆå°æ—¶ï¼‰'),
('session_refresh_token_days', '7', 'int', 'session', 'Refresh Tokenæœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰'),
('session_max_devices', '3', 'int', 'session', 'é»˜è®¤æœ€å¤§è®¾å¤‡æ•°'),
('session_idle_timeout_minutes', '30', 'int', 'session', 'ç©ºé—²è¶…æ—¶ï¼ˆåˆ†é’Ÿï¼‰'),
('session_single_device', 'false', 'bool', 'session', 'å•è®¾å¤‡ç™»å½•é™åˆ¶')
ON CONFLICT (config_key) DO NOTHING;
```

### 4.5 æ–°å¢ Roles è¡¨ï¼ˆP2ï¼‰

```sql
-- è§’è‰²è¡¨
CREATE TABLE IF NOT EXISTS roles (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    display_name VARCHAR(100) NOT NULL,
    description VARCHAR(255),
    permissions JSONB NOT NULL DEFAULT '[]',
    is_system BOOLEAN DEFAULT FALSE,        -- ç³»ç»Ÿé¢„è®¾è§’è‰²ä¸å¯åˆ é™¤
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç”¨æˆ·è§’è‰²å…³è”è¡¨ï¼ˆå¤šå¯¹å¤šï¼‰
CREATE TABLE IF NOT EXISTS user_roles (
    user_id INT REFERENCES users(id) ON DELETE CASCADE,
    role_id INT REFERENCES roles(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, role_id)
);

-- åˆå§‹åŒ–é¢„è®¾è§’è‰²
INSERT INTO roles (name, display_name, description, permissions, is_system) VALUES
('super_admin', 'è¶…çº§ç®¡ç†å‘˜', 'æ‹¥æœ‰æ‰€æœ‰æƒé™', '["*"]', true),
('admin', 'ç®¡ç†å‘˜', 'ç”¨æˆ·ç®¡ç†å’Œç³»ç»Ÿç®¡ç†', '["user:*", "session:*", "log:*", "analysis:*", "query:*", "data:view"]', true),
('user', 'æ™®é€šç”¨æˆ·', 'æ•°æ®åˆ†æåŠŸèƒ½', '["analysis:*", "query:*"]', true),
('readonly', 'åªè¯»ç”¨æˆ·', 'ä»…æŸ¥çœ‹æƒé™', '["analysis:hotspot", "analysis:industry", "query:stock"]', true)
ON CONFLICT (name) DO NOTHING;
```

### 4.6 ERå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     users       â”‚     â”‚  user_sessions  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚â”€â”€â”  â”‚ id (PK)         â”‚
â”‚ username        â”‚  â”‚  â”‚ user_id (FK)    â”‚â”€â”€â”
â”‚ password_hash   â”‚  â”‚  â”‚ device_id       â”‚  â”‚
â”‚ email           â”‚  â”‚  â”‚ device_name     â”‚  â”‚
â”‚ phone           â”‚  â”‚  â”‚ ip_address      â”‚  â”‚
â”‚ nickname        â”‚  â”‚  â”‚ user_agent      â”‚  â”‚
â”‚ role            â”‚  â”‚  â”‚ platform        â”‚  â”‚
â”‚ is_active       â”‚  â”‚  â”‚ expires_at      â”‚  â”‚
â”‚ failed_attempts â”‚  â”‚  â”‚ last_active     â”‚  â”‚
â”‚ locked_until    â”‚  â”‚  â”‚ is_revoked      â”‚  â”‚
â”‚ expires_at      â”‚  â”‚  â”‚ ...             â”‚  â”‚
â”‚ ...             â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                       â”‚
         â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
         â”‚           â”‚  â”‚ operation_logs  â”‚  â”‚
         â”‚           â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
         â”‚           â””â”€â”€â”‚ operator_id(FK) â”‚  â”‚
         â”‚              â”‚ target_id       â”‚â”€â”€â”˜
         â”‚              â”‚ log_type        â”‚
         â”‚              â”‚ action          â”‚
         â”‚              â”‚ detail          â”‚
         â”‚              â”‚ ...             â”‚
         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  â”‚   user_roles    â”‚     â”‚     roles       â”‚
         â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â””â”€â”€â”‚ user_id (FK)    â”‚     â”‚ id (PK)         â”‚
            â”‚ role_id (FK)    â”‚â”€â”€â”€â”€â”€â”‚ name            â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ permissions     â”‚
                                    â”‚ ...             â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. APIè®¾è®¡

### 5.1 ç”¨æˆ·ç®¡ç† API

#### è·å–ç”¨æˆ·åˆ—è¡¨
```
GET /api/admin/users

Query Parameters:
  - page: int = 1
  - page_size: int = 20
  - search: string (ç”¨æˆ·å/é‚®ç®±/æ˜µç§°æ¨¡ç³Šæœç´¢)
  - role: string (è§’è‰²ç­›é€‰)
  - status: string (active/inactive/locked/expired)
  - sort_by: string = created_at
  - sort_order: string = desc

Response:
{
  "total": 100,
  "page": 1,
  "page_size": 20,
  "items": [
    {
      "id": 1,
      "username": "admin",
      "email": "admin@example.com",
      "nickname": "ç®¡ç†å‘˜",
      "role": "admin",
      "status": "active",        // active/inactive/locked/expired
      "is_active": true,
      "created_at": "2025-12-01T10:00:00",
      "last_login": "2025-12-04T18:00:00",
      "active_sessions": 2,
      "failed_attempts": 0
    }
  ]
}
```

#### è·å–ç”¨æˆ·è¯¦æƒ…
```
GET /api/admin/users/{user_id}

Response:
{
  "id": 1,
  "username": "admin",
  "email": "admin@example.com",
  "phone": "13800138000",
  "nickname": "ç®¡ç†å‘˜",
  "avatar_url": null,
  "role": "admin",
  "is_active": true,
  "created_at": "2025-12-01T10:00:00",
  "updated_at": "2025-12-04T10:00:00",
  "last_login": "2025-12-04T18:00:00",
  "expires_at": null,
  "allowed_devices": 3,
  "offline_enabled": true,
  "offline_days": 7,
  "failed_attempts": 0,
  "locked_until": null,
  "password_changed_at": "2025-12-01T10:00:00",
  "remark": "ç³»ç»Ÿç®¡ç†å‘˜",
  "sessions": [
    {
      "device_id": "device_xxx",
      "device_name": "Windows Client",
      "ip_address": "192.168.1.100",
      "platform": "win32",
      "status": "online",
      "last_active": "2025-12-04T18:50:00"
    }
  ]
}
```

#### åˆ›å»ºç”¨æˆ·
```
POST /api/admin/users

Request Body:
{
  "username": "newuser",
  "password": "password123",
  "email": "newuser@example.com",
  "phone": "13800138001",
  "nickname": "æ–°ç”¨æˆ·",
  "role": "user",
  "allowed_devices": 3,
  "offline_enabled": true,
  "offline_days": 7,
  "expires_at": null,           // ISOæ ¼å¼æ—¶é—´å­—ç¬¦ä¸²æˆ–null
  "remark": "æµ‹è¯•ç”¨æˆ·"
}

Response:
{
  "success": true,
  "message": "ç”¨æˆ·åˆ›å»ºæˆåŠŸ",
  "user_id": 10
}
```

#### æ›´æ–°ç”¨æˆ·
```
PUT /api/admin/users/{user_id}

Request Body:
{
  "email": "updated@example.com",
  "phone": "13900139000",
  "nickname": "æ›´æ–°æ˜µç§°",
  "role": "admin",
  "allowed_devices": 5,
  "offline_enabled": false,
  "offline_days": 3,
  "expires_at": "2026-12-31T23:59:59",
  "remark": "æ›´æ–°å¤‡æ³¨"
}

Response:
{
  "success": true,
  "message": "ç”¨æˆ·æ›´æ–°æˆåŠŸ"
}
```

#### åˆ é™¤ç”¨æˆ·
```
DELETE /api/admin/users/{user_id}

Query Parameters:
  - hard: bool = false  (true=ç¡¬åˆ é™¤, false=è½¯åˆ é™¤)

Response:
{
  "success": true,
  "message": "ç”¨æˆ·å·²åˆ é™¤"
}
```

#### å¯ç”¨/ç¦ç”¨ç”¨æˆ·
```
POST /api/admin/users/{user_id}/toggle-status

Request Body:
{
  "is_active": false
}

Response:
{
  "success": true,
  "message": "ç”¨æˆ·å·²ç¦ç”¨",
  "is_active": false
}
```

#### é‡ç½®å¯†ç 
```
POST /api/admin/users/{user_id}/reset-password

Request Body:
{
  "new_password": "newpassword123",
  "force_logout": true           // æ˜¯å¦å¼ºåˆ¶ç™»å‡ºæ‰€æœ‰è®¾å¤‡
}

Response:
{
  "success": true,
  "message": "å¯†ç å·²é‡ç½®"
}
```

#### è§£é”ç”¨æˆ·
```
POST /api/admin/users/{user_id}/unlock

Response:
{
  "success": true,
  "message": "ç”¨æˆ·å·²è§£é”"
}
```

#### æ‰¹é‡æ“ä½œ
```
POST /api/admin/users/batch

Request Body:
{
  "action": "disable",           // enable/disable/delete
  "user_ids": [1, 2, 3]
}

Response:
{
  "success": true,
  "message": "æ‰¹é‡æ“ä½œå®Œæˆ",
  "affected": 3
}
```

### 5.2 ä¼šè¯ç®¡ç† API

#### è·å–æ‰€æœ‰æ´»è·ƒä¼šè¯
```
GET /api/admin/sessions

Query Parameters:
  - page: int = 1
  - page_size: int = 20
  - user_id: int (ç­›é€‰æŒ‡å®šç”¨æˆ·)
  - status: string (online/idle/offline)

Response:
{
  "total": 50,
  "page": 1,
  "page_size": 20,
  "stats": {
    "total_sessions": 50,
    "online": 10,
    "idle": 15,
    "offline": 25
  },
  "items": [
    {
      "id": 1,
      "user_id": 1,
      "username": "admin",
      "device_id": "device_xxx",
      "device_name": "Windows Client",
      "ip_address": "192.168.1.100",
      "platform": "win32",
      "app_version": "1.0.0",
      "location": "åŒ—äº¬å¸‚",
      "status": "online",
      "created_at": "2025-12-04T10:00:00",
      "last_active": "2025-12-04T18:55:00",
      "expires_at": "2025-12-05T10:00:00"
    }
  ]
}
```

#### å¼ºåˆ¶ä¸‹çº¿æŒ‡å®šä¼šè¯
```
POST /api/admin/sessions/{session_id}/revoke

Request Body:
{
  "reason": "å®‰å…¨åŸå› "           // å¯é€‰
}

Response:
{
  "success": true,
  "message": "ä¼šè¯å·²ç»ˆæ­¢"
}
```

#### å¼ºåˆ¶ä¸‹çº¿ç”¨æˆ·æ‰€æœ‰ä¼šè¯
```
POST /api/admin/users/{user_id}/revoke-all-sessions

Request Body:
{
  "reason": "è´¦æˆ·å®‰å…¨æ£€æŸ¥"
}

Response:
{
  "success": true,
  "message": "å·²ç»ˆæ­¢è¯¥ç”¨æˆ·æ‰€æœ‰ä¼šè¯",
  "affected": 3
}
```

#### ä¼šè¯ç»Ÿè®¡
```
GET /api/admin/sessions/stats

Response:
{
  "total_users": 100,
  "active_users_24h": 30,
  "total_sessions": 150,
  "online_sessions": 20,
  "platform_distribution": {
    "win32": 80,
    "darwin": 15,
    "linux": 5
  },
  "hourly_active": [
    {"hour": 0, "count": 5},
    {"hour": 1, "count": 3},
    ...
  ]
}
```

### 5.3 æ“ä½œæ—¥å¿— API

#### è·å–æ“ä½œæ—¥å¿—
```
GET /api/admin/logs

Query Parameters:
  - page: int = 1
  - page_size: int = 50
  - log_type: string (LOGIN/USER/SESSION/SECURITY/SYSTEM)
  - action: string
  - operator_id: int
  - target_id: int
  - status: string (success/failed)
  - start_date: string (ISOæ ¼å¼)
  - end_date: string (ISOæ ¼å¼)

Response:
{
  "total": 1000,
  "page": 1,
  "page_size": 50,
  "items": [
    {
      "id": 1,
      "log_type": "LOGIN",
      "action": "login_success",
      "operator_id": 1,
      "operator_name": "admin",
      "target_type": null,
      "target_id": null,
      "target_name": null,
      "ip_address": "192.168.1.100",
      "user_agent": "Mozilla/5.0...",
      "detail": {
        "device_id": "device_xxx",
        "device_name": "Windows Client"
      },
      "status": "success",
      "error_message": null,
      "created_at": "2025-12-04T18:00:00"
    }
  ]
}
```

#### å¯¼å‡ºæ—¥å¿—
```
GET /api/admin/logs/export

Query Parameters:
  - format: string = csv (csv/excel)
  - ... (åŒè·å–æ—¥å¿—çš„ç­›é€‰å‚æ•°)

Response: æ–‡ä»¶ä¸‹è½½
```

### 5.4 ç³»ç»Ÿé…ç½® API

#### è·å–é…ç½®
```
GET /api/admin/configs

Query Parameters:
  - category: string (password/login/session/system)

Response:
{
  "password": {
    "password_min_length": 6,
    "password_max_length": 100,
    "password_require_digit": false,
    ...
  },
  "login": {
    "login_max_attempts": 5,
    "login_lockout_minutes": 30,
    ...
  },
  "session": {
    "session_access_token_hours": 24,
    ...
  }
}
```

#### æ›´æ–°é…ç½®
```
PUT /api/admin/configs

Request Body:
{
  "password_min_length": 8,
  "login_max_attempts": 3,
  ...
}

Response:
{
  "success": true,
  "message": "é…ç½®å·²æ›´æ–°"
}
```

---

## 6. å‰ç«¯è®¾è®¡

### 6.1 é¡µé¢ç»“æ„

```
ç³»ç»Ÿç®¡ç†
â”œâ”€â”€ ç”¨æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ ç”¨æˆ·åˆ—è¡¨ï¼ˆè¡¨æ ¼ + æœç´¢ + ç­›é€‰ï¼‰
â”‚   â”œâ”€â”€ åˆ›å»ºç”¨æˆ·ï¼ˆå¼¹çª—è¡¨å•ï¼‰
â”‚   â”œâ”€â”€ ç¼–è¾‘ç”¨æˆ·ï¼ˆå¼¹çª—è¡¨å•ï¼‰
â”‚   â””â”€â”€ ç”¨æˆ·è¯¦æƒ…ï¼ˆä¾§è¾¹æŠ½å±‰ï¼‰
â”‚
â”œâ”€â”€ ä¼šè¯ç®¡ç†
â”‚   â”œâ”€â”€ æ´»è·ƒä¼šè¯åˆ—è¡¨
â”‚   â”œâ”€â”€ ä¼šè¯ç»Ÿè®¡å¡ç‰‡
â”‚   â””â”€â”€ åœ¨çº¿çŠ¶æ€å®æ—¶åˆ·æ–°
â”‚
â”œâ”€â”€ æ“ä½œæ—¥å¿—
â”‚   â”œâ”€â”€ æ—¥å¿—åˆ—è¡¨ï¼ˆè¡¨æ ¼ + é«˜çº§ç­›é€‰ï¼‰
â”‚   â”œâ”€â”€ æ—¥å¿—è¯¦æƒ…ï¼ˆå¼¹çª—ï¼‰
â”‚   â””â”€â”€ å¯¼å‡ºåŠŸèƒ½
â”‚
â””â”€â”€ ç³»ç»Ÿè®¾ç½®
    â”œâ”€â”€ å¯†ç ç­–ç•¥é…ç½®
    â”œâ”€â”€ ç™»å½•ç­–ç•¥é…ç½®
    â””â”€â”€ ä¼šè¯ç­–ç•¥é…ç½®
```

### 6.2 ç”¨æˆ·ç®¡ç†ç•Œé¢è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ç®¡ç†                                          [+ åˆ›å»ºç”¨æˆ·]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ğŸ” æœç´¢ç”¨æˆ·... â”‚  â”‚ è§’è‰² â–¼   â”‚  â”‚ çŠ¶æ€ â–¼   â”‚  â”‚ æ‰¹é‡æ“ä½œ â–¼  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â˜ â”‚ ç”¨æˆ·      â”‚ è§’è‰²     â”‚ çŠ¶æ€   â”‚ æ³¨å†Œæ—¶é—´    â”‚ æœ€åç™»å½•    â”‚ â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¤
â”‚ â˜ â”‚ ğŸ‘¤ admin  â”‚ ğŸ”‘ ç®¡ç†å‘˜ â”‚ âœ… å¯ç”¨ â”‚ 12/01 18:09 â”‚ 12/04 18:30 â”‚â€¦â”‚
â”‚ â˜ â”‚ ğŸ‘¤ user1  â”‚ ğŸ‘¥ æ™®é€š   â”‚ âœ… å¯ç”¨ â”‚ 12/02 10:00 â”‚ 12/04 15:20 â”‚â€¦â”‚
â”‚ â˜ â”‚ ğŸ‘¤ user2  â”‚ ğŸ‘¥ æ™®é€š   â”‚ ğŸ”’ é”å®š â”‚ 12/02 11:00 â”‚ 12/03 09:00 â”‚â€¦â”‚
â”‚ â˜ â”‚ ğŸ‘¤ user3  â”‚ ğŸ‘¥ æ™®é€š   â”‚ â›” ç¦ç”¨ â”‚ 12/03 08:00 â”‚ -           â”‚â€¦â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        Â« 1 2 3 4 5 ... 10 Â»                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 ä¼šè¯ç®¡ç†ç•Œé¢è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¼šè¯ç®¡ç†                                              [ğŸ”„ åˆ·æ–°] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ æ€»ç”¨æˆ·æ•°  â”‚  â”‚ åœ¨çº¿ç”¨æˆ·  â”‚  â”‚ æ€»ä¼šè¯æ•°  â”‚  â”‚ åœ¨çº¿ä¼šè¯  â”‚        â”‚
â”‚  â”‚    100   â”‚  â”‚    15    â”‚  â”‚   150    â”‚  â”‚    20    â”‚        â”‚
â”‚  â”‚ å·²æ³¨å†Œ   â”‚  â”‚ ğŸŸ¢ æ´»è·ƒ   â”‚  â”‚ æ‰€æœ‰è®¾å¤‡  â”‚  â”‚ ğŸŸ¢ å½“å‰   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ğŸ” æœç´¢ç”¨æˆ·... â”‚  â”‚ çŠ¶æ€ â–¼   â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”¨æˆ·     â”‚ è®¾å¤‡            â”‚ ç™»å½•æ—¶é—´    â”‚ æœ€åæ´»è·ƒ  â”‚ çŠ¶æ€  â”‚ æ“ä½œâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚ admin    â”‚ ğŸ’» Windows      â”‚ 12/04 10:00 â”‚ 5åˆ†é’Ÿå‰   â”‚ ğŸŸ¢ åœ¨çº¿â”‚ â  â”‚
â”‚          â”‚ 192.168.1.100   â”‚             â”‚           â”‚       â”‚    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚ user1    â”‚ ğŸ’» Windows      â”‚ 12/04 15:00 â”‚ 20åˆ†é’Ÿå‰  â”‚ ğŸŸ¡ ç©ºé—²â”‚ â  â”‚
â”‚          â”‚ 192.168.1.101   â”‚             â”‚           â”‚       â”‚    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚ user2    â”‚ ğŸ MacOS        â”‚ 12/03 09:00 â”‚ 2å°æ—¶å‰   â”‚ âš« ç¦»çº¿â”‚ â  â”‚
â”‚          â”‚ 10.0.0.50       â”‚             â”‚           â”‚       â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.4 ç»„ä»¶æ¸…å•

| ç»„ä»¶ | ç”¨é€” |
|------|------|
| `UserManagementPage` | ç”¨æˆ·ç®¡ç†é¡µé¢ä¸»å®¹å™¨ |
| `UserTable` | ç”¨æˆ·åˆ—è¡¨è¡¨æ ¼ |
| `UserFormModal` | åˆ›å»º/ç¼–è¾‘ç”¨æˆ·å¼¹çª— |
| `UserDetailDrawer` | ç”¨æˆ·è¯¦æƒ…ä¾§è¾¹æ  |
| `SessionManagementPage` | ä¼šè¯ç®¡ç†é¡µé¢ |
| `SessionTable` | ä¼šè¯åˆ—è¡¨è¡¨æ ¼ |
| `SessionStatsCards` | ä¼šè¯ç»Ÿè®¡å¡ç‰‡ç»„ |
| `OperationLogPage` | æ“ä½œæ—¥å¿—é¡µé¢ |
| `LogTable` | æ—¥å¿—åˆ—è¡¨è¡¨æ ¼ |
| `LogFilterPanel` | æ—¥å¿—ç­›é€‰é¢æ¿ |
| `SystemConfigPage` | ç³»ç»Ÿé…ç½®é¡µé¢ |
| `PolicyConfigForm` | ç­–ç•¥é…ç½®è¡¨å• |

---

## 7. å®‰å…¨è®¾è®¡

### 7.1 è®¿é—®æ§åˆ¶

```python
# æ‰€æœ‰ç®¡ç†APIéƒ½éœ€è¦adminæƒé™
@router.get("/api/admin/users")
async def get_users(
    admin: User = Depends(require_admin)  # éªŒè¯ç®¡ç†å‘˜æƒé™
):
    ...
```

### 7.2 æ•æ„Ÿæ“ä½œä¿æŠ¤

| æ“ä½œ | ä¿æŠ¤æªæ–½ |
|------|----------|
| åˆ é™¤ç”¨æˆ· | äºŒæ¬¡ç¡®è®¤ + è®°å½•æ—¥å¿— |
| é‡ç½®å¯†ç  | è®°å½•æ—¥å¿— + å¯é€‰å¼ºåˆ¶ç™»å‡º |
| ä¿®æ”¹è§’è‰² | è®°å½•æ—¥å¿— + ä¸èƒ½ä¿®æ”¹è‡ªå·± |
| å¼ºåˆ¶ä¸‹çº¿ | è®°å½•æ—¥å¿— + åŸå› è¯´æ˜ |
| ä¿®æ”¹å®‰å…¨ç­–ç•¥ | è®°å½•æ—¥å¿— |

### 7.3 è‡ªæˆ‘ä¿æŠ¤

```python
# ç¦æ­¢åˆ é™¤è‡ªå·±
if user_id == current_user.id:
    raise HTTPException(400, "ä¸èƒ½åˆ é™¤è‡ªå·±çš„è´¦æˆ·")

# ç¦æ­¢ç¦ç”¨è‡ªå·±
if user_id == current_user.id:
    raise HTTPException(400, "ä¸èƒ½ç¦ç”¨è‡ªå·±çš„è´¦æˆ·")

# ç¦æ­¢é™çº§è‡ªå·±çš„æƒé™
if user_id == current_user.id and new_role != "admin":
    raise HTTPException(400, "ä¸èƒ½é™ä½è‡ªå·±çš„æƒé™")
```

### 7.4 ç™»å½•å®‰å…¨å¢å¼º

```python
async def login(req: LoginRequest, db: Session):
    user = get_user(req.username)
    
    # 1. æ£€æŸ¥è´¦æˆ·é”å®š
    if user.locked_until and user.locked_until > datetime.utcnow():
        remaining = (user.locked_until - datetime.utcnow()).seconds // 60
        log_event("login_failed", user, reason="account_locked")
        raise HTTPException(403, f"è´¦æˆ·å·²é”å®šï¼Œè¯·{remaining}åˆ†é’Ÿåé‡è¯•")
    
    # 2. éªŒè¯å¯†ç 
    if not verify_password(req.password, user.password_hash):
        user.failed_attempts += 1
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦é”å®š
        max_attempts = get_config("login_max_attempts")
        if user.failed_attempts >= max_attempts:
            lockout_minutes = get_config("login_lockout_minutes")
            user.locked_until = datetime.utcnow() + timedelta(minutes=lockout_minutes)
            log_event("account_locked", user)
        
        db.commit()
        log_event("login_failed", user, reason="wrong_password")
        raise HTTPException(401, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯")
    
    # 3. ç™»å½•æˆåŠŸï¼Œé‡ç½®å¤±è´¥è®¡æ•°
    user.failed_attempts = 0
    user.locked_until = None
    log_event("login_success", user)
```

### 7.5 ä¼šè¯éªŒè¯å¢å¼º

```python
async def get_current_user(token: str, db: Session):
    payload = verify_token(token)
    user = get_user(payload["sub"])
    device_id = payload["device"]
    
    # æ£€æŸ¥ä¼šè¯æ˜¯å¦è¢«æ’¤é”€
    session = get_session(user.id, device_id)
    if session.is_revoked:
        raise HTTPException(
            401, 
            detail="ä¼šè¯å·²è¢«ç»ˆæ­¢ï¼Œè¯·é‡æ–°ç™»å½•",
            headers={"X-Force-Logout": "true"}
        )
    
    return user
```

---

## 8. å®æ–½è®¡åˆ’

### 8.1 é˜¶æ®µåˆ’åˆ†

#### Phase 1: ç”¨æˆ·ç®¡ç†åŸºç¡€ï¼ˆP0ï¼‰- é¢„è®¡3å¤©

| ä»»åŠ¡ | å·¥æ—¶ | äº§å‡º |
|------|------|------|
| æ•°æ®åº“æ‰©å±•ï¼ˆUsersè¡¨ï¼‰ | 0.5å¤© | è¿ç§»è„šæœ¬ |
| ç”¨æˆ·CRUD API | 1å¤© | åç«¯æ¥å£ |
| ç”¨æˆ·ç®¡ç†å‰ç«¯é¡µé¢ | 1å¤© | Reactç»„ä»¶ |
| æµ‹è¯•å’Œè”è°ƒ | 0.5å¤© | æµ‹è¯•ç”¨ä¾‹ |

#### Phase 2: ä¼šè¯ç®¡ç†å¢å¼ºï¼ˆP0ï¼‰- é¢„è®¡2å¤©

| ä»»åŠ¡ | å·¥æ—¶ | äº§å‡º |
|------|------|------|
| æ•°æ®åº“æ‰©å±•ï¼ˆSessionsè¡¨ï¼‰ | 0.5å¤© | è¿ç§»è„šæœ¬ |
| ä¼šè¯çŠ¶æ€é€»è¾‘ + å¼ºåˆ¶ä¸‹çº¿API | 0.5å¤© | åç«¯æ¥å£ |
| ä¼šè¯ç®¡ç†å‰ç«¯é¡µé¢ | 0.5å¤© | Reactç»„ä»¶ |
| å®¢æˆ·ç«¯å¼ºåˆ¶ç™»å‡ºå¤„ç† | 0.5å¤© | Electroné€»è¾‘ |

#### Phase 3: æ“ä½œæ—¥å¿—ï¼ˆP1ï¼‰- é¢„è®¡2å¤©

| ä»»åŠ¡ | å·¥æ—¶ | äº§å‡º |
|------|------|------|
| æ—¥å¿—è¡¨åˆ›å»º | 0.25å¤© | è¿ç§»è„šæœ¬ |
| æ—¥å¿—è®°å½•æœåŠ¡ | 0.5å¤© | æ—¥å¿—æœåŠ¡ç±» |
| å…³é”®æ“ä½œåŸ‹ç‚¹ | 0.5å¤© | ä»£ç ä¿®æ”¹ |
| æ—¥å¿—æŸ¥è¯¢API | 0.25å¤© | åç«¯æ¥å£ |
| æ—¥å¿—å‰ç«¯é¡µé¢ | 0.5å¤© | Reactç»„ä»¶ |

#### Phase 4: å®‰å…¨ç­–ç•¥ï¼ˆP2ï¼‰- é¢„è®¡2å¤©

| ä»»åŠ¡ | å·¥æ—¶ | äº§å‡º |
|------|------|------|
| é…ç½®è¡¨åˆ›å»º | 0.25å¤© | è¿ç§»è„šæœ¬ |
| é…ç½®è¯»å–æœåŠ¡ | 0.25å¤© | é…ç½®æœåŠ¡ |
| ç™»å½•å®‰å…¨å¢å¼º | 0.5å¤© | ä»£ç ä¿®æ”¹ |
| å¯†ç ç­–ç•¥å®ç° | 0.5å¤© | éªŒè¯é€»è¾‘ |
| é…ç½®ç®¡ç†å‰ç«¯ | 0.5å¤© | Reactç»„ä»¶ |

#### Phase 5: è§’è‰²æƒé™ï¼ˆP2ï¼‰- é¢„è®¡3å¤©

| ä»»åŠ¡ | å·¥æ—¶ | äº§å‡º |
|------|------|------|
| è§’è‰²è¡¨åˆ›å»º | 0.5å¤© | è¿ç§»è„šæœ¬ |
| æƒé™éªŒè¯ä¸­é—´ä»¶ | 1å¤© | æƒé™æœåŠ¡ |
| è§’è‰²ç®¡ç†API | 0.5å¤© | åç«¯æ¥å£ |
| è§’è‰²ç®¡ç†å‰ç«¯ | 1å¤© | Reactç»„ä»¶ |

### 8.2 æ€»ä½“æ—¶é—´çº¿

```
Week 1: Phase 1 + Phase 2 (ç”¨æˆ·ç®¡ç† + ä¼šè¯ç®¡ç†)
Week 2: Phase 3 + Phase 4 (æ“ä½œæ—¥å¿— + å®‰å…¨ç­–ç•¥)
Week 3: Phase 5 (è§’è‰²æƒé™) + æ•´ä½“æµ‹è¯•
```

### 8.3 éªŒæ”¶æ ‡å‡†

#### P0 éªŒæ”¶æ ‡å‡†
- [ ] å¯ä»¥åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ç”¨æˆ·
- [ ] å¯ä»¥å¯ç”¨/ç¦ç”¨ç”¨æˆ·
- [ ] å¯ä»¥é‡ç½®ç”¨æˆ·å¯†ç 
- [ ] å¯ä»¥æŸ¥çœ‹å®æ—¶ä¼šè¯çŠ¶æ€ï¼ˆåœ¨çº¿/ç©ºé—²/ç¦»çº¿ï¼‰
- [ ] å¯ä»¥å¼ºåˆ¶ä¸‹çº¿æŒ‡å®šä¼šè¯
- [ ] è¢«å¼ºåˆ¶ä¸‹çº¿çš„å®¢æˆ·ç«¯èƒ½æ­£ç¡®å¤„ç†å¹¶è·³è½¬ç™»å½•

#### P1 éªŒæ”¶æ ‡å‡†
- [ ] æ‰€æœ‰ç™»å½•äº‹ä»¶è¢«è®°å½•
- [ ] æ‰€æœ‰ç”¨æˆ·ç®¡ç†æ“ä½œè¢«è®°å½•
- [ ] æ‰€æœ‰å®‰å…¨äº‹ä»¶è¢«è®°å½•
- [ ] å¯ä»¥æŒ‰æ¡ä»¶æŸ¥è¯¢æ—¥å¿—
- [ ] å¯ä»¥å¯¼å‡ºæ—¥å¿—

#### P2 éªŒæ”¶æ ‡å‡†
- [ ] ç™»å½•å¤±è´¥Næ¬¡åè´¦æˆ·è‡ªåŠ¨é”å®š
- [ ] å¯†ç å¯é…ç½®å¤æ‚åº¦è¦æ±‚
- [ ] Tokenæœ‰æ•ˆæœŸå¯é…ç½®
- [ ] è§’è‰²å¯å¢åˆ æ”¹æŸ¥
- [ ] æƒé™éªŒè¯æ­£å¸¸å·¥ä½œ

---

## 9. é™„å½•

### 9.1 çŠ¶æ€ç å®šä¹‰

| HTTPçŠ¶æ€ç  | ä¸šåŠ¡å«ä¹‰ |
|------------|----------|
| 200 | æˆåŠŸ |
| 400 | å‚æ•°é”™è¯¯ |
| 401 | æœªè®¤è¯/Tokenæ— æ•ˆ |
| 403 | æ— æƒé™/è´¦æˆ·ç¦ç”¨/è´¦æˆ·é”å®š |
| 404 | èµ„æºä¸å­˜åœ¨ |
| 409 | èµ„æºå†²çªï¼ˆå¦‚ç”¨æˆ·åå·²å­˜åœ¨ï¼‰ |
| 500 | æœåŠ¡å™¨é”™è¯¯ |

### 9.2 æ—¥å¿—Actionæšä¸¾

```python
class LogAction(str, Enum):
    # ç™»å½•ç›¸å…³
    LOGIN_SUCCESS = "login_success"
    LOGIN_FAILED = "login_failed"
    LOGOUT = "logout"
    TOKEN_REFRESH = "token_refresh"
    
    # ç”¨æˆ·ç®¡ç†
    USER_CREATE = "user_create"
    USER_UPDATE = "user_update"
    USER_DELETE = "user_delete"
    USER_ENABLE = "user_enable"
    USER_DISABLE = "user_disable"
    PASSWORD_RESET = "password_reset"
    PASSWORD_CHANGE = "password_change"
    
    # ä¼šè¯ç®¡ç†
    SESSION_REVOKE = "session_revoke"
    SESSION_REVOKE_ALL = "session_revoke_all"
    
    # å®‰å…¨äº‹ä»¶
    ACCOUNT_LOCKED = "account_locked"
    ACCOUNT_UNLOCKED = "account_unlocked"
    SUSPICIOUS_LOGIN = "suspicious_login"
    
    # ç³»ç»Ÿé…ç½®
    CONFIG_UPDATE = "config_update"
```

### 9.3 å‚è€ƒæ–‡æ¡£

- [å¼€å‘æ–‡æ¡£-å®¢æˆ·ç«¯åŠ å¯†ç³»ç»Ÿ.md](å¼€å‘æ–‡æ¡£-å®¢æˆ·ç«¯åŠ å¯†ç³»ç»Ÿ.md) - ç°æœ‰è®¤è¯æ¶æ„
- [æŠ€æœ¯å®ç°ç»†èŠ‚.md](æŠ€æœ¯å®ç°ç»†èŠ‚.md) - ç°æœ‰ä»£ç å®ç°

---

**æ–‡æ¡£ç»´æŠ¤**ï¼šå¼€å‘ç»„  
**æœ€åæ›´æ–°**ï¼š2025-12-04
