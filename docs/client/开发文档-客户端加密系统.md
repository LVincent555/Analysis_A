# Aè‚¡åˆ†æç³»ç»Ÿ - æ¡Œé¢å®¢æˆ·ç«¯å¼€å‘æ–‡æ¡£

> ç‰ˆæœ¬: 1.0.0  
> åˆ›å»ºæ—¥æœŸ: 2025-12-01  
> çŠ¶æ€: è®¾è®¡é˜¶æ®µ

---

## ç›®å½•

1. [é¡¹ç›®èƒŒæ™¯](#1-é¡¹ç›®èƒŒæ™¯)
2. [æ•´ä½“æ¶æ„](#2-æ•´ä½“æ¶æ„)
3. [ç›®å½•ç»“æ„](#3-ç›®å½•ç»“æ„)
4. [åŠ å¯†æ–¹æ¡ˆ](#4-åŠ å¯†æ–¹æ¡ˆ)
5. [ç”¨æˆ·è®¤è¯](#5-ç”¨æˆ·è®¤è¯)
6. [ç¦»çº¿å­˜å‚¨](#6-ç¦»çº¿å­˜å‚¨)
7. [è‡ªåŠ¨æ›´æ–°](#7-è‡ªåŠ¨æ›´æ–°)
8. [å¼€å‘è®¡åˆ’](#8-å¼€å‘è®¡åˆ’)
9. [APIå‚è€ƒ](#9-apiå‚è€ƒ)

---

## 1. é¡¹ç›®èƒŒæ™¯

### 1.1 é—®é¢˜
- æœåŠ¡å™¨æ— ICPå¤‡æ¡ˆï¼Œæ— æ³•ç›´æ¥æä¾›WebæœåŠ¡
- éœ€è¦ä¿æŠ¤APIæ¥å£å’Œæ•°æ®ä¼ è¾“å®‰å…¨

### 1.2 è§£å†³æ–¹æ¡ˆ
- å¼€å‘Electronæ¡Œé¢å®¢æˆ·ç«¯ï¼Œç»•è¿‡å¤‡æ¡ˆé™åˆ¶
- å®ç°AESåŠ å¯†é€šä¿¡ï¼Œä¿æŠ¤æ•°æ®å®‰å…¨
- æ”¯æŒå¤šç”¨æˆ·è®¤è¯å’Œç¦»çº¿ä½¿ç”¨

### 1.3 é¡¹ç›®ç»“æ„
```
stock_analysis_app/
â”œâ”€â”€ backend/              # åç«¯ (ç°æœ‰ + åŠ å¯†æ‰©å±•)
â”œâ”€â”€ frontend/             # Webå‰ç«¯ (ä¿ç•™ï¼Œä¸ä¿®æ”¹)
â””â”€â”€ frontend-client/      # ğŸ†• Electronæ¡Œé¢å®¢æˆ·ç«¯
```

---

## 2. æ•´ä½“æ¶æ„

### 2.1 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Electron æ¡Œé¢å®¢æˆ·ç«¯                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   React UI    â”‚  â”‚  æœ¬åœ°SQLite   â”‚  â”‚   è‡ªåŠ¨æ›´æ–°æ¨¡å—       â”‚  â”‚
â”‚  â”‚  (å¤ç”¨å‰ç«¯)   â”‚  â”‚  (ç¦»çº¿ç¼“å­˜)   â”‚  â”‚  (electron-updater) â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    åŠ å¯†é€šä¿¡å±‚                                â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚  â”‚ APIè·¯å¾„åŠ å¯†  â”‚  â”‚ è¯·æ±‚ä½“åŠ å¯†   â”‚  â”‚ å“åº”ä½“è§£å¯†          â”‚  â”‚â”‚
â”‚  â”‚  â”‚ /api/xâ†’åŠ å¯†  â”‚  â”‚ JSONâ†’AES   â”‚  â”‚ AESâ†’JSON           â”‚  â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ HTTP POST /api/secure (å…¨éƒ¨èµ°è¿™ä¸€ä¸ªç«¯ç‚¹)
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       FastAPI åç«¯                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    åŠ å¯†ç½‘å…³ä¸­é—´ä»¶                            â”‚â”‚
â”‚  â”‚  1. æ¥æ”¶åŠ å¯†è¯·æ±‚                                             â”‚â”‚
â”‚  â”‚  2. AESè§£å¯† â†’ è·å–çœŸå®APIè·¯å¾„å’Œå‚æ•°                          â”‚â”‚
â”‚  â”‚  3. å†…éƒ¨è·¯ç”±åˆ°å¯¹åº”å¤„ç†å‡½æ•°                                    â”‚â”‚
â”‚  â”‚  4. AESåŠ å¯†å“åº” â†’ è¿”å›                                       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚          â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  JWTè®¤è¯      â”‚  â”‚  ä¸šåŠ¡é€»è¾‘     â”‚  â”‚  PostgreSQL         â”‚  â”‚
â”‚  â”‚  éªŒè¯Token    â”‚â†’ â”‚  (ç°æœ‰ä»£ç )   â”‚â†’ â”‚  stocks/users/...   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 é€šä¿¡æµç¨‹

```
å®¢æˆ·ç«¯                                              æœåŠ¡ç«¯
   â”‚                                                   â”‚
   â”‚  â•â•â•â•â•â•â•â•â•â• ç™»å½•é˜¶æ®µ (æ˜æ–‡ï¼Œä»…æ­¤æ¥å£) â•â•â•â•â•â•â•â•â•â•   â”‚
   â”‚                                                   â”‚
   â”‚  POST /api/auth/login                             â”‚
   â”‚  {username, password}                             â”‚
   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚
   â”‚                                                   â”‚
   â”‚  {token, session_key_encrypted, expires_at}       â”‚
   â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
   â”‚                                                   â”‚
   â”‚  â•â•â•â•â•â•â•â•â•â• ä¸šåŠ¡é˜¶æ®µ (å…¨åŠ å¯†) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
   â”‚                                                   â”‚
   â”‚  POST /api/secure                                 â”‚
   â”‚  Headers: Authorization: Bearer <token>           â”‚
   â”‚  Body: {                                          â”‚
   â”‚    "data": "<AESåŠ å¯†çš„JSON>"                      â”‚
   â”‚  }                                                â”‚
   â”‚  åŠ å¯†å‰: {                                        â”‚
   â”‚    "path": "/api/analyze/3",                      â”‚
   â”‚    "method": "GET",                               â”‚
   â”‚    "params": {"board_type": "main"}               â”‚
   â”‚  }                                                â”‚
   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚
   â”‚                                                   â”‚
   â”‚  {                                                â”‚
   â”‚    "data": "<AESåŠ å¯†çš„å“åº”JSON>"                  â”‚
   â”‚  }                                                â”‚
   â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
```

---

## 3. ç›®å½•ç»“æ„

### 3.1 åç«¯æ–°å¢ç»“æ„

```
backend/app/
â”œâ”€â”€ auth/                        # ğŸ†• è®¤è¯æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ jwt_handler.py           # JWTç”Ÿæˆ/éªŒè¯
â”‚   â”œâ”€â”€ password.py              # å¯†ç å“ˆå¸Œ (bcrypt)
â”‚   â””â”€â”€ dependencies.py          # FastAPIä¾èµ–æ³¨å…¥
â”‚
â”œâ”€â”€ crypto/                      # ğŸ†• åŠ å¯†æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ aes_handler.py           # AES-256-GCMåŠ è§£å¯†
â”‚   â””â”€â”€ key_manager.py           # å¯†é’¥ç®¡ç†
â”‚
â”œâ”€â”€ middleware/                  # ğŸ†• ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ encryption_gateway.py    # åŠ å¯†ç½‘å…³
â”‚
â”œâ”€â”€ routers/
â”‚   â”œâ”€â”€ auth.py                  # ğŸ†• ç™»å½•/æ³¨å†Œ/åˆ·æ–°Token
â”‚   â”œâ”€â”€ secure.py                # ğŸ†• åŠ å¯†ç½‘å…³ç«¯ç‚¹
â”‚   â”œâ”€â”€ sync.py                  # ğŸ†• ç¦»çº¿æ•°æ®åŒæ­¥
â”‚   â””â”€â”€ updates.py               # ğŸ†• å®¢æˆ·ç«¯æ›´æ–°æ£€æŸ¥
â”‚
â””â”€â”€ db_models.py                 # ğŸ”„ æ–°å¢User/Sessionè¡¨
```

### 3.2 å®¢æˆ·ç«¯ç»“æ„

```
frontend-client/
â”œâ”€â”€ electron/                    # Electronä¸»è¿›ç¨‹
â”‚   â”œâ”€â”€ main.js                  # ä¸»è¿›ç¨‹å…¥å£
â”‚   â”œâ”€â”€ preload.js               # é¢„åŠ è½½è„šæœ¬ (å®‰å…¨æ¡¥æ¥)
â”‚   â”œâ”€â”€ database.js              # æœ¬åœ°SQLiteæ“ä½œ
â”‚   â”œâ”€â”€ updater.js               # è‡ªåŠ¨æ›´æ–°é€»è¾‘
â”‚   â””â”€â”€ ipc-handlers.js          # IPCé€šä¿¡å¤„ç†
â”‚
â”œâ”€â”€ src/                         # Reactæ¸²æŸ“è¿›ç¨‹ (å¤ç”¨frontend)
â”‚   â”œâ”€â”€ components/              # å¤ç”¨ç°æœ‰ç»„ä»¶
â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â””â”€â”€ LoginPage.js         # ğŸ†• ç™»å½•é¡µé¢
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ api.js               # ğŸ”„ æ”¹é€ ï¼šæ·»åŠ åŠ å¯†å±‚
â”‚   â”‚   â”œâ”€â”€ authService.js       # ğŸ†• è®¤è¯æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ cryptoService.js     # ğŸ†• åŠ å¯†æœåŠ¡
â”‚   â”‚   â””â”€â”€ syncService.js       # ğŸ†• ç¦»çº¿åŒæ­¥æœåŠ¡
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useAuth.js           # ğŸ†• è®¤è¯Hook
â”‚   â”‚   â””â”€â”€ useOffline.js        # ğŸ†• ç¦»çº¿çŠ¶æ€Hook
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ crypto.js            # ğŸ†• AESåŠ è§£å¯†å·¥å…·
â”‚   â””â”€â”€ App.js                   # ğŸ”„ æ·»åŠ ç™»å½•è·¯ç”±å®ˆå«
â”‚
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ index.html
â”‚   â””â”€â”€ icon.ico                 # åº”ç”¨å›¾æ ‡
â”‚
â”œâ”€â”€ package.json                 # Electron + Reactä¾èµ–
â”œâ”€â”€ electron-builder.yml         # æ‰“åŒ…é…ç½®
â””â”€â”€ .env                         # ç¯å¢ƒå˜é‡
```

---

## 4. åŠ å¯†æ–¹æ¡ˆ

### 4.1 åŠ å¯†ç®—æ³•é€‰æ‹©

| ç®—æ³• | ç”¨é€” | è¯´æ˜ |
|-----|------|------|
| **AES-256-GCM** | æ•°æ®åŠ å¯† | è®¤è¯åŠ å¯†ï¼Œé˜²ç¯¡æ”¹ |
| **bcrypt** | å¯†ç å“ˆå¸Œ | æ…¢å“ˆå¸Œï¼Œé˜²æš´åŠ›ç ´è§£ |
| **PBKDF2** | å¯†é’¥æ´¾ç”Ÿ | ä»ç”¨æˆ·å¯†ç æ´¾ç”Ÿå¯†é’¥ |

### 4.2 å¯†é’¥ä½“ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¯†é’¥å±‚çº§                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ä¸»å¯†é’¥ (Master Key)                                        â”‚
â”‚  â”œâ”€â”€ å­˜å‚¨: æœåŠ¡ç«¯ç¯å¢ƒå˜é‡ (.env)                            â”‚
â”‚  â”œâ”€â”€ ç”¨é€”: åŠ å¯†ç”¨æˆ·å¯†é’¥                                     â”‚
â”‚  â””â”€â”€ ç”Ÿæˆ: éšæœº32å­—èŠ‚ï¼Œéƒ¨ç½²æ—¶ç”Ÿæˆä¸€æ¬¡                        â”‚
â”‚                                                             â”‚
â”‚  ç”¨æˆ·å¯†é’¥ (User Key)                                        â”‚
â”‚  â”œâ”€â”€ å­˜å‚¨: æ•°æ®åº“ (ç”¨ä¸»å¯†é’¥åŠ å¯†)                            â”‚
â”‚  â”œâ”€â”€ ç”¨é€”: æ´¾ç”Ÿä¼šè¯å¯†é’¥                                     â”‚
â”‚  â””â”€â”€ ç”Ÿæˆ: ç”¨æˆ·æ³¨å†Œæ—¶éšæœºç”Ÿæˆ                               â”‚
â”‚                                                             â”‚
â”‚  ä¼šè¯å¯†é’¥ (Session Key)                                     â”‚
â”‚  â”œâ”€â”€ å­˜å‚¨: æœåŠ¡ç«¯å†…å­˜/Redis + å®¢æˆ·ç«¯å†…å­˜                    â”‚
â”‚  â”œâ”€â”€ ç”¨é€”: åŠ å¯†APIè¯·æ±‚/å“åº”                                 â”‚
â”‚  â”œâ”€â”€ ç”Ÿæˆ: ç”¨æˆ·ç™»å½•æ—¶ç”Ÿæˆ                                   â”‚
â”‚  â””â”€â”€ æœ‰æ•ˆæœŸ: 24å°æ—¶                                         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 åç«¯åŠ å¯†å®ç°

```python
# backend/app/crypto/aes_handler.py

from cryptography.hazmat.primitives.ciphers.aead import AESGCM
import os
import base64
import json

class AESCrypto:
    """AES-256-GCM åŠ è§£å¯†å™¨"""
    
    def __init__(self, key: bytes):
        """
        Args:
            key: 32å­—èŠ‚å¯†é’¥ (AES-256)
        """
        if len(key) != 32:
            raise ValueError("å¯†é’¥å¿…é¡»æ˜¯32å­—èŠ‚")
        self.gcm = AESGCM(key)
    
    def encrypt(self, data: dict) -> str:
        """
        åŠ å¯†å­—å…¸æ•°æ®
        
        Args:
            data: è¦åŠ å¯†çš„å­—å…¸
            
        Returns:
            Base64ç¼–ç çš„åŠ å¯†å­—ç¬¦ä¸² (nonce + ciphertext + tag)
        """
        plaintext = json.dumps(data, ensure_ascii=False).encode('utf-8')
        nonce = os.urandom(12)  # GCMæ¨è12å­—èŠ‚nonce
        ciphertext = self.gcm.encrypt(nonce, plaintext, None)
        # nonce(12) + ciphertext + tag(16) åˆå¹¶åBase64ç¼–ç 
        return base64.b64encode(nonce + ciphertext).decode('utf-8')
    
    def decrypt(self, encrypted: str) -> dict:
        """
        è§£å¯†Base64å­—ç¬¦ä¸²
        
        Args:
            encrypted: Base64ç¼–ç çš„åŠ å¯†å­—ç¬¦ä¸²
            
        Returns:
            è§£å¯†åçš„å­—å…¸
        """
        raw = base64.b64decode(encrypted)
        nonce = raw[:12]
        ciphertext = raw[12:]
        plaintext = self.gcm.decrypt(nonce, ciphertext, None)
        return json.loads(plaintext.decode('utf-8'))


# ä½¿ç”¨ç¤ºä¾‹
# key = os.urandom(32)  # ç”Ÿæˆå¯†é’¥
# crypto = AESCrypto(key)
# encrypted = crypto.encrypt({"path": "/api/analyze/3", "params": {}})
# decrypted = crypto.decrypt(encrypted)
```

### 4.4 å‰ç«¯åŠ å¯†å®ç°

```javascript
// frontend-client/src/utils/crypto.js

import CryptoJS from 'crypto-js';

/**
 * AES-256-GCM åŠ è§£å¯†ç±»
 * æ³¨æ„: CryptoJSä¸åŸç”Ÿæ”¯æŒGCMï¼Œè¿™é‡Œä½¿ç”¨CBC+HMACæ¨¡æ‹Ÿè®¤è¯åŠ å¯†
 * ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ Web Crypto API æˆ– node-forge
 */
class AESCrypto {
  constructor(keyBase64) {
    this.key = CryptoJS.enc.Base64.parse(keyBase64);
  }

  /**
   * åŠ å¯†å¯¹è±¡
   * @param {Object} data - è¦åŠ å¯†çš„å¯¹è±¡
   * @returns {string} Base64ç¼–ç çš„åŠ å¯†å­—ç¬¦ä¸²
   */
  encrypt(data) {
    const plaintext = JSON.stringify(data);
    const iv = CryptoJS.lib.WordArray.random(16);
    
    const encrypted = CryptoJS.AES.encrypt(plaintext, this.key, {
      iv: iv,
      mode: CryptoJS.mode.CBC,
      padding: CryptoJS.pad.Pkcs7
    });
    
    // iv + ciphertext åˆå¹¶
    const combined = iv.concat(encrypted.ciphertext);
    return combined.toString(CryptoJS.enc.Base64);
  }

  /**
   * è§£å¯†å­—ç¬¦ä¸²
   * @param {string} encryptedBase64 - Base64ç¼–ç çš„åŠ å¯†å­—ç¬¦ä¸²
   * @returns {Object} è§£å¯†åçš„å¯¹è±¡
   */
  decrypt(encryptedBase64) {
    const raw = CryptoJS.enc.Base64.parse(encryptedBase64);
    const iv = CryptoJS.lib.WordArray.create(raw.words.slice(0, 4), 16);
    const ciphertext = CryptoJS.lib.WordArray.create(raw.words.slice(4));
    
    const decrypted = CryptoJS.AES.decrypt(
      { ciphertext: ciphertext },
      this.key,
      {
        iv: iv,
        mode: CryptoJS.mode.CBC,
        padding: CryptoJS.pad.Pkcs7
      }
    );
    
    return JSON.parse(decrypted.toString(CryptoJS.enc.Utf8));
  }
}

export default AESCrypto;
```

### 4.5 APIè·¯å¾„åŠ å¯†

**åŸç†**: æ‰€æœ‰ä¸šåŠ¡è¯·æ±‚ç»Ÿä¸€å‘é€åˆ° `/api/secure`ï¼ŒçœŸå®è·¯å¾„æ”¾åœ¨åŠ å¯†ä½“å†…ã€‚

```javascript
// åŠ å¯†å‰çš„è¯·æ±‚ç»“æ„
{
  "path": "/api/analyze/3",           // çœŸå®APIè·¯å¾„
  "method": "GET",                    // è¯·æ±‚æ–¹æ³•
  "params": {                         // æŸ¥è¯¢å‚æ•°
    "board_type": "main"
  },
  "body": null                        // POSTè¯·æ±‚ä½“
}

// åŠ å¯†åå‘é€
POST /api/secure
Headers: 
  Authorization: Bearer <jwt_token>
  Content-Type: application/json
Body:
{
  "data": "Base64(AES(ä¸Šè¿°JSON))"
}
```

---

## 5. ç”¨æˆ·è®¤è¯

### 5.1 æ•°æ®åº“æ¨¡å‹

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    user_key_encrypted VARCHAR(255) NOT NULL,  -- ç”¨ä¸»å¯†é’¥åŠ å¯†çš„ç”¨æˆ·å¯†é’¥
    role VARCHAR(20) DEFAULT 'user',           -- admin / user
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP,
    allowed_devices INT DEFAULT 3,             -- å…è®¸åŒæ—¶ç™»å½•è®¾å¤‡æ•°
    offline_enabled BOOLEAN DEFAULT TRUE,      -- æ˜¯å¦å…è®¸ç¦»çº¿
    offline_days INT DEFAULT 7                 -- ç¦»çº¿æ•°æ®ä¿ç•™å¤©æ•°
);

-- ä¼šè¯è¡¨ (å¯é€‰ï¼Œç”¨äºå¤šè®¾å¤‡ç®¡ç†)
CREATE TABLE user_sessions (
    id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(id) ON DELETE CASCADE,
    device_id VARCHAR(100) NOT NULL,           -- è®¾å¤‡å”¯ä¸€æ ‡è¯†
    session_key_encrypted VARCHAR(255) NOT NULL,
    refresh_token VARCHAR(255),
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_active TIMESTAMP,
    UNIQUE(user_id, device_id)
);

-- ç´¢å¼•
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_sessions_user ON user_sessions(user_id);
CREATE INDEX idx_sessions_expires ON user_sessions(expires_at);
```

### 5.2 è®¤è¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç™»å½•æµç¨‹                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. å®¢æˆ·ç«¯å‘é€ username + password                          â”‚
â”‚     POST /api/auth/login                                    â”‚
â”‚                                                             â”‚
â”‚  2. æœåŠ¡ç«¯éªŒè¯å¯†ç  (bcrypt.verify)                          â”‚
â”‚                                                             â”‚
â”‚  3. ç”Ÿæˆä¼šè¯å¯†é’¥ (32å­—èŠ‚éšæœº)                               â”‚
â”‚                                                             â”‚
â”‚  4. ç”¨ç”¨æˆ·å¯†é’¥åŠ å¯†ä¼šè¯å¯†é’¥                                   â”‚
â”‚                                                             â”‚
â”‚  5. ç”ŸæˆJWT Token (åŒ…å«user_id, è¿‡æœŸæ—¶é—´)                   â”‚
â”‚                                                             â”‚
â”‚  6. è¿”å›:                                                   â”‚
â”‚     {                                                       â”‚
â”‚       "token": "eyJ...",                                    â”‚
â”‚       "session_key": "Base64(ç”¨æˆ·å¯†é’¥åŠ å¯†çš„ä¼šè¯å¯†é’¥)",       â”‚
â”‚       "expires_at": "2025-12-02T13:00:00Z"                  â”‚
â”‚     }                                                       â”‚
â”‚                                                             â”‚
â”‚  7. å®¢æˆ·ç«¯ç”¨å¯†ç æ´¾ç”Ÿç”¨æˆ·å¯†é’¥ï¼Œè§£å¯†å¾—åˆ°ä¼šè¯å¯†é’¥               â”‚
â”‚                                                             â”‚
â”‚  8. åç»­è¯·æ±‚ç”¨ä¼šè¯å¯†é’¥åŠ å¯†                                   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 JWTé…ç½®

```python
# backend/app/auth/jwt_handler.py

from datetime import datetime, timedelta
from jose import jwt, JWTError
from ..config import settings

SECRET_KEY = settings.JWT_SECRET_KEY
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_HOURS = 24
REFRESH_TOKEN_EXPIRE_DAYS = 7

def create_access_token(user_id: int, device_id: str) -> str:
    """åˆ›å»ºè®¿é—®ä»¤ç‰Œ"""
    expire = datetime.utcnow() + timedelta(hours=ACCESS_TOKEN_EXPIRE_HOURS)
    payload = {
        "sub": str(user_id),
        "device": device_id,
        "exp": expire,
        "type": "access"
    }
    return jwt.encode(payload, SECRET_KEY, algorithm=ALGORITHM)

def create_refresh_token(user_id: int, device_id: str) -> str:
    """åˆ›å»ºåˆ·æ–°ä»¤ç‰Œ"""
    expire = datetime.utcnow() + timedelta(days=REFRESH_TOKEN_EXPIRE_DAYS)
    payload = {
        "sub": str(user_id),
        "device": device_id,
        "exp": expire,
        "type": "refresh"
    }
    return jwt.encode(payload, SECRET_KEY, algorithm=ALGORITHM)

def verify_token(token: str) -> dict:
    """éªŒè¯ä»¤ç‰Œ"""
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        return payload
    except JWTError:
        return None
```

---

## 6. ç¦»çº¿å­˜å‚¨

### 6.1 æœ¬åœ°æ•°æ®åº“ç»“æ„

```javascript
// frontend-client/electron/database.js

const Database = require('better-sqlite3');
const path = require('path');
const { app } = require('electron');

// æ•°æ®åº“æ–‡ä»¶å­˜å‚¨åœ¨ç”¨æˆ·æ•°æ®ç›®å½•
const dbPath = path.join(app.getPath('userData'), 'stock_cache.db');
const db = new Database(dbPath);

// åˆå§‹åŒ–è¡¨ç»“æ„
db.exec(`
  -- ç¼“å­˜çš„è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯
  CREATE TABLE IF NOT EXISTS cached_stocks (
    stock_code TEXT PRIMARY KEY,
    stock_name TEXT NOT NULL,
    industry TEXT,
    last_synced TEXT NOT NULL
  );
  
  -- ç¼“å­˜çš„æ¯æ—¥æ•°æ® (åªä¿ç•™æœ€è¿‘Nå¤©)
  CREATE TABLE IF NOT EXISTS cached_daily_data (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    stock_code TEXT NOT NULL,
    date TEXT NOT NULL,
    rank INTEGER,
    total_score REAL,
    price_change REAL,
    turnover_rate_percent REAL,
    volume_days REAL,
    volatility REAL,
    -- å¯æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šå­—æ®µ
    UNIQUE(stock_code, date)
  );
  
  -- ç¼“å­˜çš„æ¿å—æ•°æ®
  CREATE TABLE IF NOT EXISTS cached_sectors (
    sector_id INTEGER PRIMARY KEY,
    sector_name TEXT NOT NULL,
    last_synced TEXT NOT NULL
  );
  
  -- åŒæ­¥çŠ¶æ€è®°å½•
  CREATE TABLE IF NOT EXISTS sync_status (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL,
    updated_at TEXT NOT NULL
  );
  
  -- ç”¨æˆ·é…ç½® (åŠ å¯†å­˜å‚¨)
  CREATE TABLE IF NOT EXISTS user_config (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL
  );
  
  -- åˆ›å»ºç´¢å¼•
  CREATE INDEX IF NOT EXISTS idx_daily_date ON cached_daily_data(date);
  CREATE INDEX IF NOT EXISTS idx_daily_stock ON cached_daily_data(stock_code);
`);

module.exports = db;
```

### 6.2 åŒæ­¥ç­–ç•¥

```javascript
// frontend-client/src/services/syncService.js

class SyncService {
  constructor() {
    this.isOnline = navigator.onLine;
    this.syncInterval = null;
    
    // ç›‘å¬ç½‘ç»œçŠ¶æ€
    window.addEventListener('online', () => this.handleOnline());
    window.addEventListener('offline', () => this.handleOffline());
  }

  /**
   * å¯åŠ¨è‡ªåŠ¨åŒæ­¥
   */
  startAutoSync(intervalMinutes = 30) {
    this.syncInterval = setInterval(() => {
      if (this.isOnline) {
        this.syncIncremental();
      }
    }, intervalMinutes * 60 * 1000);
  }

  /**
   * å¢é‡åŒæ­¥
   */
  async syncIncremental() {
    try {
      const lastSync = await this.getLastSyncTime();
      
      const response = await api.secureRequest({
        path: '/api/sync/incremental',
        method: 'GET',
        params: { since: lastSync }
      });
      
      if (response.data) {
        await this.saveToLocal(response.data);
        await this.updateSyncTime(response.data.sync_time);
      }
      
      return { success: true };
    } catch (error) {
      console.error('åŒæ­¥å¤±è´¥:', error);
      return { success: false, error };
    }
  }

  /**
   * å…¨é‡åŒæ­¥ (é¦–æ¬¡ç™»å½•æˆ–æ•°æ®æŸåæ—¶)
   */
  async syncFull() {
    // æ¸…ç©ºæœ¬åœ°æ•°æ®
    await window.electronAPI.clearLocalDB();
    
    // åˆ†æ‰¹è·å–æ•°æ®
    const dates = await api.secureRequest({
      path: '/api/dates',
      method: 'GET'
    });
    
    for (const date of dates.data.slice(0, 7)) { // åªåŒæ­¥æœ€è¿‘7å¤©
      const data = await api.secureRequest({
        path: '/api/sync/daily',
        method: 'GET',
        params: { date }
      });
      await this.saveToLocal(data);
    }
  }

  /**
   * ç¦»çº¿æ¨¡å¼æŸ¥è¯¢
   */
  async queryOffline(queryType, params) {
    return await window.electronAPI.queryLocalDB(queryType, params);
  }
}

export default new SyncService();
```

### 6.3 åç«¯åŒæ­¥API

```python
# backend/app/routers/sync.py

from fastapi import APIRouter, Depends, Query
from datetime import datetime, timedelta
from ..auth.dependencies import get_current_user
from ..database import get_db

router = APIRouter(prefix="/api/sync", tags=["sync"])

@router.get("/incremental")
async def incremental_sync(
    since: datetime = Query(..., description="ä¸Šæ¬¡åŒæ­¥æ—¶é—´"),
    user = Depends(get_current_user),
    db = Depends(get_db)
):
    """
    å¢é‡åŒæ­¥ï¼šè¿”å›æŒ‡å®šæ—¶é—´ä¹‹åæ›´æ–°çš„æ•°æ®
    """
    # é™åˆ¶åŒæ­¥èŒƒå›´
    max_days = user.offline_days
    cutoff = datetime.now() - timedelta(days=max_days)
    since = max(since, cutoff)
    
    # æŸ¥è¯¢å¢é‡æ•°æ®
    new_stocks = db.query(Stock).filter(
        Stock.last_updated > since
    ).all()
    
    new_daily = db.query(DailyStockData).filter(
        DailyStockData.date > since.date()
    ).limit(10000).all()  # é™åˆ¶å•æ¬¡åŒæ­¥é‡
    
    return {
        "stocks": [s.to_dict() for s in new_stocks],
        "daily_data": [d.to_sync_dict() for d in new_daily],
        "sync_time": datetime.now().isoformat(),
        "has_more": len(new_daily) == 10000
    }

@router.get("/daily")
async def sync_daily(
    date: str = Query(..., description="æ—¥æœŸ YYYY-MM-DD"),
    user = Depends(get_current_user),
    db = Depends(get_db)
):
    """
    åŒæ­¥æŒ‡å®šæ—¥æœŸçš„å®Œæ•´æ•°æ®
    """
    daily_data = db.query(DailyStockData).filter(
        DailyStockData.date == date
    ).all()
    
    return {
        "date": date,
        "count": len(daily_data),
        "data": [d.to_sync_dict() for d in daily_data]
    }
```

---

## 7. è‡ªåŠ¨æ›´æ–°

### 7.1 æ›´æ–°æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Electronå®¢æˆ·ç«¯  â”‚                          â”‚   æ›´æ–°æœåŠ¡å™¨     â”‚
â”‚                 â”‚  1. æ£€æŸ¥æ›´æ–°              â”‚  (ä½ çš„æœåŠ¡å™¨)    â”‚
â”‚  å½“å‰: v1.0.0   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚                 â”‚
â”‚                 â”‚                          â”‚  /updates/      â”‚
â”‚                 â”‚  2. è¿”å›ç‰ˆæœ¬ä¿¡æ¯          â”‚  â”œâ”€â”€ latest.yml â”‚
â”‚                 â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”œâ”€â”€ v1.1.0.exe â”‚
â”‚                 â”‚                          â”‚  â””â”€â”€ v1.1.0.yml â”‚
â”‚                 â”‚  3. ä¸‹è½½æ–°ç‰ˆæœ¬            â”‚                 â”‚
â”‚                 â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚                 â”‚
â”‚                 â”‚                          â”‚                 â”‚
â”‚                 â”‚  4. å®‰è£…å¹¶é‡å¯            â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æ›´æ–°é…ç½®

```yaml
# frontend-client/electron-builder.yml

appId: com.stockanalysis.client
productName: Aè‚¡åˆ†æç³»ç»Ÿ
copyright: Copyright Â© 2025

directories:
  output: dist
  buildResources: build

files:
  - "build/**/*"
  - "electron/**/*"
  - "node_modules/**/*"
  - "package.json"

win:
  target:
    - target: nsis
      arch: [x64]
  icon: public/icon.ico
  artifactName: ${productName}-${version}-setup.${ext}

nsis:
  oneClick: false
  allowToChangeInstallationDirectory: true
  installerIcon: public/icon.ico
  uninstallerIcon: public/icon.ico
  createDesktopShortcut: true
  createStartMenuShortcut: true

publish:
  provider: generic
  url: http://your-server-ip:8000/updates/
  channel: latest
```

### 7.3 æ›´æ–°æ¨¡å—å®ç°

```javascript
// frontend-client/electron/updater.js

const { autoUpdater } = require('electron-updater');
const { dialog, BrowserWindow, ipcMain } = require('electron');
const log = require('electron-log');

// é…ç½®æ—¥å¿—
autoUpdater.logger = log;
autoUpdater.logger.transports.file.level = 'info';

class AppUpdater {
  constructor() {
    // ä¸è‡ªåŠ¨ä¸‹è½½ï¼Œå…ˆè¯¢é—®ç”¨æˆ·
    autoUpdater.autoDownload = false;
    autoUpdater.autoInstallOnAppQuit = true;
    
    this.setupEvents();
    this.setupIPC();
  }

  setupEvents() {
    // æ£€æŸ¥æ›´æ–°å‡ºé”™
    autoUpdater.on('error', (error) => {
      log.error('æ›´æ–°é”™è¯¯:', error);
      this.sendToRenderer('update-error', error.message);
    });

    // æ£€æŸ¥åˆ°æ–°ç‰ˆæœ¬
    autoUpdater.on('update-available', (info) => {
      log.info('å‘ç°æ–°ç‰ˆæœ¬:', info.version);
      this.sendToRenderer('update-available', {
        version: info.version,
        releaseNotes: info.releaseNotes
      });
    });

    // æ²¡æœ‰æ–°ç‰ˆæœ¬
    autoUpdater.on('update-not-available', () => {
      log.info('å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬');
      this.sendToRenderer('update-not-available');
    });

    // ä¸‹è½½è¿›åº¦
    autoUpdater.on('download-progress', (progress) => {
      this.sendToRenderer('update-progress', {
        percent: progress.percent,
        transferred: progress.transferred,
        total: progress.total
      });
    });

    // ä¸‹è½½å®Œæˆ
    autoUpdater.on('update-downloaded', (info) => {
      log.info('æ›´æ–°ä¸‹è½½å®Œæˆ:', info.version);
      this.sendToRenderer('update-downloaded', info.version);
      
      // æç¤ºç”¨æˆ·é‡å¯
      dialog.showMessageBox({
        type: 'info',
        title: 'æ›´æ–°å°±ç»ª',
        message: `æ–°ç‰ˆæœ¬ ${info.version} å·²ä¸‹è½½å®Œæˆï¼Œæ˜¯å¦ç«‹å³é‡å¯å®‰è£…ï¼Ÿ`,
        buttons: ['ç«‹å³é‡å¯', 'ç¨å'],
        defaultId: 0
      }).then(result => {
        if (result.response === 0) {
          autoUpdater.quitAndInstall(false, true);
        }
      });
    });
  }

  setupIPC() {
    // æ¸²æŸ“è¿›ç¨‹è¯·æ±‚æ£€æŸ¥æ›´æ–°
    ipcMain.handle('check-for-updates', async () => {
      try {
        return await autoUpdater.checkForUpdates();
      } catch (error) {
        log.error('æ£€æŸ¥æ›´æ–°å¤±è´¥:', error);
        return null;
      }
    });

    // æ¸²æŸ“è¿›ç¨‹è¯·æ±‚ä¸‹è½½æ›´æ–°
    ipcMain.handle('download-update', async () => {
      try {
        await autoUpdater.downloadUpdate();
        return true;
      } catch (error) {
        log.error('ä¸‹è½½æ›´æ–°å¤±è´¥:', error);
        return false;
      }
    });

    // æ¸²æŸ“è¿›ç¨‹è¯·æ±‚å®‰è£…æ›´æ–°
    ipcMain.handle('install-update', () => {
      autoUpdater.quitAndInstall(false, true);
    });
  }

  sendToRenderer(channel, data) {
    const mainWindow = BrowserWindow.getAllWindows()[0];
    if (mainWindow) {
      mainWindow.webContents.send(channel, data);
    }
  }

  checkForUpdates() {
    autoUpdater.checkForUpdates();
  }
}

module.exports = new AppUpdater();
```

### 7.4 æœåŠ¡ç«¯æ›´æ–°æ–‡ä»¶

```yaml
# æœåŠ¡å™¨ /updates/latest.yml (electron-builderè‡ªåŠ¨ç”Ÿæˆ)

version: 1.1.0
files:
  - url: Aè‚¡åˆ†æç³»ç»Ÿ-1.1.0-setup.exe
    sha512: <SHA512å“ˆå¸Œå€¼>
    size: 85000000
path: Aè‚¡åˆ†æç³»ç»Ÿ-1.1.0-setup.exe
sha512: <SHA512å“ˆå¸Œå€¼>
releaseDate: '2025-12-01T12:00:00.000Z'
```

---

## 8. å¼€å‘è®¡åˆ’

### 8.1 é˜¶æ®µåˆ’åˆ†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ä¸€é˜¶æ®µ (P0): åŸºç¡€å¯ç”¨                     é¢„è®¡: 10-12h   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â–¡ åç«¯: Userè¡¨ + JWTè®¤è¯                         3h       â”‚
â”‚  â–¡ åç«¯: AESåŠ å¯†ä¸­é—´ä»¶ + åŠ å¯†ç½‘å…³                  3h       â”‚
â”‚  â–¡ å‰ç«¯: ç™»å½•é¡µé¢ + åŠ å¯†APIå±‚                      3h       â”‚
â”‚  â–¡ Electron: åŸºç¡€æ‰“åŒ…é…ç½®                          2h       â”‚
â”‚  â–¡ æµ‹è¯•: ç™»å½• + åŠ å¯†é€šä¿¡è”è°ƒ                       1h       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  äº¤ä»˜ç‰©: å¯ç™»å½•ã€åŠ å¯†é€šä¿¡çš„æ¡Œé¢å®¢æˆ·ç«¯                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬äºŒé˜¶æ®µ (P1): ç¦»çº¿åŠŸèƒ½                     é¢„è®¡: 8-10h    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â–¡ åç«¯: å¢é‡åŒæ­¥API                              2h       â”‚
â”‚  â–¡ å‰ç«¯: æœ¬åœ°SQLiteé›†æˆ                           3h       â”‚
â”‚  â–¡ å‰ç«¯: åŒæ­¥ç®¡ç†å™¨                               3h       â”‚
â”‚  â–¡ å‰ç«¯: ç¦»çº¿çŠ¶æ€UI                               2h       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  äº¤ä»˜ç‰©: æ”¯æŒç¦»çº¿ä½¿ç”¨çš„å®¢æˆ·ç«¯                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ä¸‰é˜¶æ®µ (P1): è‡ªåŠ¨æ›´æ–°                     é¢„è®¡: 4-6h     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â–¡ åç«¯: æ›´æ–°æ–‡ä»¶æ‰˜ç®¡                             1h       â”‚
â”‚  â–¡ å‰ç«¯: electron-updateré›†æˆ                     2h       â”‚
â”‚  â–¡ å‰ç«¯: æ›´æ–°UI (è¿›åº¦æ¡ã€æç¤º)                    2h       â”‚
â”‚  â–¡ æµ‹è¯•: æ›´æ–°æµç¨‹éªŒè¯                             1h       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  äº¤ä»˜ç‰©: æ”¯æŒè‡ªåŠ¨æ›´æ–°çš„å®¢æˆ·ç«¯                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬å››é˜¶æ®µ (P2): ä¼˜åŒ–å®Œå–„                     é¢„è®¡: 4-6h     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â–¡ å¤šè®¾å¤‡ç®¡ç†                                     2h       â”‚
â”‚  â–¡ ç”¨æˆ·æƒé™ç»†åˆ†                                   2h       â”‚
â”‚  â–¡ æ—¥å¿—å®¡è®¡                                       1h       â”‚
â”‚  â–¡ æ€§èƒ½ä¼˜åŒ–                                       1h       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  äº¤ä»˜ç‰©: ç”Ÿäº§çº§å®¢æˆ·ç«¯                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»è®¡: 26-34 å°æ—¶ (çº¦4-5ä¸ªå·¥ä½œæ—¥)
```

### 8.2 é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | ç›®æ ‡ | éªŒæ”¶æ ‡å‡† |
|-------|------|---------|
| **M1** | åŠ å¯†é€šä¿¡ | ç™»å½•æˆåŠŸï¼ŒAPIè¯·æ±‚/å“åº”å…¨åŠ å¯† |
| **M2** | æ¡Œé¢å®¢æˆ·ç«¯ | Windowså¯å®‰è£…è¿è¡Œ |
| **M3** | ç¦»çº¿å¯ç”¨ | æ–­ç½‘åä»å¯æŸ¥çœ‹ç¼“å­˜æ•°æ® |
| **M4** | è‡ªåŠ¨æ›´æ–° | å‘å¸ƒæ–°ç‰ˆæœ¬åå®¢æˆ·ç«¯èƒ½æ£€æµ‹å¹¶æ›´æ–° |

---

## 9. APIå‚è€ƒ

### 9.1 è®¤è¯API

#### POST /api/auth/register
æ³¨å†Œæ–°ç”¨æˆ·

```json
// è¯·æ±‚
{
  "username": "user1",
  "password": "password123"
}

// å“åº”
{
  "success": true,
  "user_id": 1,
  "message": "æ³¨å†ŒæˆåŠŸ"
}
```

#### POST /api/auth/login
ç”¨æˆ·ç™»å½•

```json
// è¯·æ±‚
{
  "username": "user1",
  "password": "password123",
  "device_id": "win-abc123"
}

// å“åº”
{
  "token": "eyJ...",
  "refresh_token": "eyJ...",
  "session_key": "Base64(åŠ å¯†çš„ä¼šè¯å¯†é’¥)",
  "expires_at": "2025-12-02T13:00:00Z",
  "user": {
    "id": 1,
    "username": "user1",
    "role": "user"
  }
}
```

#### POST /api/auth/refresh
åˆ·æ–°Token

```json
// è¯·æ±‚
{
  "refresh_token": "eyJ..."
}

// å“åº”
{
  "token": "eyJ...",
  "expires_at": "2025-12-02T13:00:00Z"
}
```

### 9.2 åŠ å¯†ç½‘å…³API

#### POST /api/secure
ç»Ÿä¸€åŠ å¯†å…¥å£

```json
// è¯·æ±‚
Headers:
  Authorization: Bearer <jwt_token>
  Content-Type: application/json

Body:
{
  "data": "Base64(AESåŠ å¯†({path, method, params, body}))"
}

// å“åº”
{
  "data": "Base64(AESåŠ å¯†(åŸAPIå“åº”))"
}
```

### 9.3 åŒæ­¥API

#### GET /api/sync/incremental
å¢é‡åŒæ­¥

```
å‚æ•°: since=2025-12-01T00:00:00Z

å“åº”:
{
  "stocks": [...],
  "daily_data": [...],
  "sync_time": "2025-12-01T13:00:00Z",
  "has_more": false
}
```

### 9.4 æ›´æ–°API

#### GET /api/updates/check
æ£€æŸ¥æ›´æ–°

```
å‚æ•°: current_version=1.0.0

å“åº”:
{
  "has_update": true,
  "version": "1.1.0",
  "download_url": "http://server/updates/app-1.1.0.exe",
  "changelog": "ä¿®å¤äº†xxxé—®é¢˜",
  "force_update": false
}
```

---

## é™„å½•

### A. ç¯å¢ƒå˜é‡é…ç½®

```bash
# backend/.env æ–°å¢
JWT_SECRET_KEY=your-super-secret-jwt-key-at-least-32-chars
MASTER_ENCRYPTION_KEY=your-32-byte-master-key-base64
TOKEN_EXPIRE_HOURS=24
REFRESH_TOKEN_EXPIRE_DAYS=7

# frontend-client/.env
REACT_APP_API_URL=http://your-server-ip:8000
REACT_APP_VERSION=$npm_package_version
```

### B. ä¾èµ–æ¸…å•

**åç«¯æ–°å¢ä¾èµ–:**
```
python-jose[cryptography]==3.3.0
bcrypt==4.1.2
cryptography==41.0.7
```

**å‰ç«¯æ–°å¢ä¾èµ–:**
```
electron==28.0.0
electron-builder==24.9.1
electron-updater==6.1.7
better-sqlite3==9.2.2
crypto-js==4.2.0
```

### C. å®‰å…¨æ³¨æ„äº‹é¡¹

1. **å¯†é’¥ç®¡ç†**: ä¸»å¯†é’¥ç»ä¸èƒ½ç¡¬ç¼–ç ï¼Œå¿…é¡»é€šè¿‡ç¯å¢ƒå˜é‡æ³¨å…¥
2. **å¯†ç ç­–ç•¥**: å»ºè®®æœ€å°‘8ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—
3. **Tokenå®‰å…¨**: å®¢æˆ·ç«¯Tokenå­˜å‚¨åœ¨å†…å­˜ï¼Œä¸æŒä¹…åŒ–åˆ°ç£ç›˜
4. **ä¼ è¾“å®‰å…¨**: è™½ç„¶æ•°æ®å·²åŠ å¯†ï¼Œç”Ÿäº§ç¯å¢ƒä»å»ºè®®ä½¿ç”¨HTTPS
5. **æ—¥å¿—è„±æ•**: æ—¥å¿—ä¸­ä¸è®°å½•å¯†ç ã€å¯†é’¥ã€Tokenç­‰æ•æ„Ÿä¿¡æ¯

---

> æ–‡æ¡£ç‰ˆæœ¬: 1.0.0  
> æœ€åæ›´æ–°: 2025-12-01  
> ä½œè€…: Cascade AI
