# 外部板块多对多分析系统 - 设计文档 V3.0

**创建时间**: 2025-12-10  
**版本**: V3.0 最终决议版  
**状态**: 🟢 Ready for Implementation  
**核心理念**: 热度守恒 + 攻守分离 + 配置驱动

---

## 1. 核心设计哲学

本系统不生产原始数据，而是作为**中间层**，对上游评分（`daily_stock_data`）与真实多对多关系（`ext_board_*`）进行**二次清洗与聚合**。

### 1.1 三大铁律

| 铁律 | 说明 | 实现方式 |
|------|------|----------|
| **热度守恒律** | 一只股票的总热度贡献恒定为 1.0，防止龙头股导致板块热度虚假膨胀 | 分摊系数 `share_ij`，按类型权重切分 |
| **攻守分离律** | 🛡️防守看行业（一对一），⚔️进攻看概念（多对多） | 行业熔断 + 概念最大驱动 |
| **配置驱动律** | 拒绝硬编码，所有权重/阈值托管于 `system_configs` | 全局 SignalConfig 架构 |

### 1.2 数据约束

- **不依赖 28 天历史**：只用当日截面 + 上游成品因子
- **尊重上游评分**：不自造指标，直接使用 `total_score / rank` 等
- **保留原版系统**：新系统与原版并行，用户可自由切换

---

## 2. 数据库架构

### 2.1 现有基础层（不动）

```
个股层:     stocks + daily_stock_data (含 total_score, rank, 80+技术因子)
本地板块层: sectors + daily_sector_data (Excel allbk)
真实板块层: ext_board_list + ext_board_daily_snap + ext_board_local_map
```

### 2.2 新增：板块热度聚合表

```sql
CREATE TABLE IF NOT EXISTS ext_board_heat_daily (
    trade_date  DATE,
    board_id    BIGINT REFERENCES ext_board_list(id) ON DELETE CASCADE,
    
    stock_count INT,              -- 当日成分股数量
    
    -- [多对多加权聚合指标] 基于 share_ij 分摊权重
    b1_rank_sum    DECIMAL(20,8), -- 排名加权总热度 Σ(share * 1/rank^k)
    b2_rank_avg    DECIMAL(20,8), -- 排名加权密度 (B1 / count)
    c1_score_sum   DECIMAL(20,8), -- 总分加权总热度 Σ(share * total_score)
    c2_score_avg   DECIMAL(20,8), -- 总分加权密度 (C1 / count) → 【核心指标】
    
    -- [综合结果]
    heat_raw       DECIMAL(20,8), -- 归一化合成后的原始热度
    heat_pct       DECIMAL(10,8), -- 当日全市场分位值 [0, 1]
    
    -- [策略投影预留] V1阶段置空
    needle_density DECIMAL(10,4), -- 预留给单针策略
    avg_volume     DECIMAL(10,2), -- 板块平均放量天数
    
    PRIMARY KEY (trade_date, board_id)
);
CREATE INDEX idx_ext_heat_date ON ext_board_heat_daily(trade_date);
```

### 2.3 新增：个股板块信号视图

```sql
CREATE OR REPLACE VIEW v_stock_board_signal_daily AS
SELECT
    d.date,
    d.stock_code,
    
    -- 行业防守
    s.industry,
    -- industry_heat_pct,    -- 来自原行业热度模块
    -- industry_safe,        -- bool: heat_pct >= safe_line
    
    -- 概念进攻
    -- max_concept_board_id,
    -- max_concept_board_name,   -- 驱动板块名 → "锂电池"
    -- max_concept_board_type,   -- 'concept' / 'industry'
    -- max_concept_heat_pct,     -- 该板块热度分位
    -- exposure_pct,             -- 多板块共振分位
    
    -- 综合板块评分
    -- final_board_score,
    -- final_board_score_pct,
    -- board_signal_level        -- 'S' / 'A' / 'B' / 'NONE'
FROM daily_stock_data d
JOIN stocks s ON d.stock_code = s.stock_code;
```

---

## 3. 核心算法

### 3.1 步骤一：权重分摊（热度守恒）

对股票 i，属于板块集合 B(i)。配置类型权重：

```
W_industry = 1.0  (行业 - 防守主线)
W_concept  = 0.7  (概念 - 进攻副线)
W_region   = 0.5  (地域 - 点缀)
```

分摊系数计算：

```
share_ij = W_type(j) / Σ_{k∈B(i)} W_type(k)
```

**保证**：`Σ_j share_ij = 1`（每只股票热度贡献总量恒定）

**SQL 实现**：
```sql
WITH base AS (
  SELECT
    snap.stock_code, snap.date, snap.board_id,
    CASE b.board_type
      WHEN 'industry' THEN :w_industry
      WHEN 'concept'  THEN :w_concept
      ELSE :w_region
    END AS type_weight
  FROM ext_board_daily_snap snap
  JOIN ext_board_list b ON b.id = snap.board_id
  WHERE snap.date = :d
),
norm AS (
  SELECT stock_code, date, board_id, type_weight,
    type_weight / SUM(type_weight) OVER (PARTITION BY stock_code, date) AS share_ij
  FROM base
)
SELECT * FROM norm;
```

### 3.2 步骤二：板块热度聚合

对板块 j，聚合其成分股（基于 share_ij）：

**C2 (能量密度)** - 核心指标：
```
C2[j] = Σ_{i∈S(j)} (share_ij × total_score_i) / count_j
```

**B2 (排名密度)**：
```
B2[j] = Σ_{i∈S(j)} (share_ij × 1/rank_i^k) / count_j
```

**综合热度**：
```
heat_raw[j] = α×norm_B1 + β×norm_B2 + γ×norm_C2 + δ×norm_local_C2
heat_pct[j] = PercentRank(heat_raw) ∈ [0,1]
```

权重 α/β/γ/δ 进配置中心，默认 `[0.4, 0.2, 0.3, 0.1]`。

### 3.3 步骤三：个股信号合成（攻守分离）

#### 3.3.1 防守判定（行业）

```python
# 使用原有行业热度模块结果
primary_industry = get_industry_heat(stock.industry, date)
industry_safe = (primary_industry.heat_pct >= CONFIG.INDUSTRY_SAFE_LINE)  # 如 0.3

if not industry_safe:
    return {"signal": False, "reason": "行业防守失败"}
```

#### 3.3.2 进攻判定（概念）

**Max Driver（最大驱动力）**：
```python
concepts = get_related_concepts(stock, date)  # board_type='concept'
max_driver = max(concepts, key=lambda c: c.heat_pct)
max_concept_heat_pct = percentile(max_driver.heat_pct)
```

**Exposure（共振强度）**：
```python
hot_boards = [b for b in stock.boards if b.heat_pct >= CONFIG.HOT_LINE]
exposure = sum(b.share_weight * b.heat_pct for b in hot_boards)
exposure_pct = percentile(exposure)
```

#### 3.3.3 综合评分

```python
base = (
    CONFIG.W_STOCK × stock_score_pct +
    CONFIG.W_EXPOSURE × exposure_pct +
    CONFIG.W_MAX_CONCEPT × max_concept_heat_pct
)

if not industry_safe:
    final_score = base × CONFIG.PENALTY  # 如 0.5
else:
    final_score = base

final_pct = percentile(final_score)

# 信号等级
if final_pct >= 0.97: level = 'S'
elif final_pct >= 0.90: level = 'A'
elif final_pct >= 0.80: level = 'B'
else: level = 'NONE'
```

---

## 4. 全局配置集成

在 `system_configs` 表中注册（category='board'）：

| Key | Default | 说明 |
|-----|---------|------|
| `board_w_industry` | `1.0` | 类型权重：行业 |
| `board_w_concept` | `0.7` | 类型权重：概念 |
| `board_w_region` | `0.5` | 类型权重：地域 |
| `board_safe_pct` | `0.3` | **防守线**：行业分位低于此不安全 |
| `board_hot_pct` | `0.8` | **进攻线**：板块分位高于此算风口 |
| `board_w_stock` | `1.0` | 合成权重：个股自身分 |
| `board_w_exposure` | `0.7` | 合成权重：板块共振 |
| `board_w_max_concept` | `0.5` | 合成权重：最强驱动 |
| `board_penalty_unsafe` | `0.5` | 行业不安全惩罚系数 |
| `board_signal_S_pct` | `0.97` | S级信号阈值 |
| `board_signal_A_pct` | `0.90` | A级信号阈值 |
| `board_signal_B_pct` | `0.80` | B级信号阈值 |

---

## 5. 前端展示：`[S级｜锂电池]` 标签

### 5.1 后端返回数据

```json
{
  "board_signal_level": "S",
  "board_signal_label": "锂电池",
  "max_concept_board_type": "concept",
  "max_concept_heat_pct": 0.96
}
```

### 5.2 组件设计

```tsx
interface BoardSignalBadgeProps {
  level: 'S' | 'A' | 'B' | 'NONE';
  label: string;              // "锂电池"
  type?: 'industry' | 'concept';
  heatPct?: number;           // 0~1，用于 tooltip
  onClick?: () => void;       // 点击跳转板块详情
}
```

### 5.3 视觉风格

| 等级 | 样式 | 说明 |
|------|------|------|
| S | 橙→粉渐变，白字 | 最高优先级，稀有 |
| A | 蓝紫→粉渐变，白字 | 次优先级 |
| B | 灰色半透明，浅色字 | 一般信号 |
| NONE | 不显示 | 无板块信号 |

### 5.4 使用场景

1. **股票查询页**：在信号列显示 `[S级｜锂电池] [跳变] [热点]`
2. **行业详情弹窗**：每行股票旁显示板块信号
3. **真实板块榜单页**：按 heat_pct 排名，点击展开成分股

---

## 6. 实施路线图

### Phase 1: 基础设施（Day 1）

- [ ] 执行 SQL 建表 `ext_board_heat_daily`
- [ ] 编写 ETL 脚本 `task_board_heat.py`
  - 读取 `daily_stock_data + ext_board_daily_snap`
  - 计算 share_ij → 聚合 B/C → 写入 heat 表
- [ ] 目标：跑通最近 1 天的数据

### Phase 2: 信号透出（Day 2）

- [ ] 实现 `v_stock_board_signal_daily` 视图（或 Python Service）
- [ ] 前端：股票列表增加 `BoardSignalBadge` 组件
- [ ] 前端：信号配置面板增加"板块数据源"切换

### Phase 3: 完善展示（Day 3-4）

- [ ] 真实板块热度榜单页
- [ ] 板块详情弹窗（点击 Badge 跳转）
- [ ] Tooltip 显示详细热度信息

### Phase 4: 未来扩展

- [ ] 板块热度趋势（3日/5日/10日斜率）
- [ ] 单针策略接入（needle_density 字段）
- [ ] 板块轮动预警

---

## 7. 计算示例

假设股票 `000001 平安银行`：

| 维度 | 值 |
|------|-----|
| 行业 | 银行（heat_pct=0.6，安全） |
| 概念1 | 数字货币（heat_pct=0.96） |
| 概念2 | 金融科技（heat_pct=0.90） |

**分摊权重**：
```
share(银行) = 1.0 / (1.0+0.7+0.7) = 0.42
share(数字货币) = 0.7 / 2.4 = 0.29
share(金融科技) = 0.7 / 2.4 = 0.29
```

**Exposure**：
```
Exposure = 0.42×0.6 + 0.29×0.96 + 0.29×0.90 = 0.79
```

**Max Driver**：
```
max_concept_heat = 0.96 → 驱动板块 = "数字货币"
```

**最终评分**：
```
base = 1.0×0.93 + 0.7×0.79 + 0.5×0.96 = 1.96 (标准化后)
industry_safe = True → 不惩罚
final_pct ≈ 0.97+ → level = 'S'
```

**前端显示**：`[S级｜数字货币]`

---

## 8. 相关文档

- [技术归档-外部板块并发同步架构.md](./技术归档-外部板块并发同步架构.md) - 数据爬取技术方案
- [板块成分股详细分析模块-开发文档.md](./板块成分股详细分析模块-开发文档.md) - 原版一对一设计

---

**文档状态**: 🟢 最终决议版  
**下一步**: 执行 Phase 1 建表 + ETL
