# 行业热度分析 - 波动率筛选 A1/A2 设计文档

> **功能版本**: v1.0.0  
> **设计日期**: 2025-11-20  
> **状态**:  设计阶段  
> **数据库**: PostgreSQL

---

## 目录

1. [功能概述](#功能概述)
2. [A1设计](#a1设计)
3. [A2设计](#a2设计)
4. [UI设计](#ui设计)
5. [API接口](#api接口)
6. [实施步骤](#实施步骤)

---

## 功能概述

### 背景
在现有 B1/B2/C1/C2 基础上，新增 A1/A2 波动率分析维度。

### 核心设计
- **A1**: 行业平均波动率排名，全量展示，动态标签
- **A2**: 高波动股票名单，行业分布柱状图

### 关键特性
- 动态标签：按百分位分配，不设固定阈值
- A1全排名：不筛选，展示所有行业
- A2股票名单：类似最新热点功能
- 柱状图统计：可视化行业分布

---

## A1设计：行业平均波动率排名 {#a1设计}

### 核心思路
计算每个行业的平均波动率变化，全部排名，不筛选。

### 计算步骤

#### 步骤1：计算行业平均波动率变化

```python
# 伪代码
for industry in all_industries:
    volatility_changes = []
    for stock in industry.stocks:
        change = (vol_today - vol_yesterday) / vol_yesterday * 100
        volatility_changes.append(change)
    
    avg_change = mean(volatility_changes)
    industry_data[industry] = avg_change

# 按平均变化率排序
sorted_industries = sort_by_avg_change(descending=True)
```

#### 步骤2：动态标签分配

按排名百分位分配标签：
- 前20%: 高波
- 20-50%: 中波
- 50-80%: 小波
- 80%后正值: 微升
- 负值<-10%: 大降
- 负值>-10%: 小降

### 数据模型

```python
class IndustryVolatilityA1(BaseModel):
    industry: str
    rank: int
    avg_volatility_change: float
    volatility_label: str
    stock_count: int
    valid_count: int
    
    # 可选B/C系列
    total_heat: Optional[float]
    avg_heat: Optional[float]
    total_score: Optional[float]
    avg_score: Optional[float]
```

### API接口

```python
GET /api/industry/volatility-ranking-a1

参数:
- date: str (YYYYMMDD)
- k: float (0.3-2.0, 默认0.618)
- sort_by: str ('volatility'|'heat'|'score')
- limit: int (10-200, 默认50)

返回: IndustryVolatilityA1Response
```

### 前端展示

表格展示前50名行业，包含：
- 排名、行业名、平均波动率变化、标签
- 成分股数、有效计算数
- 可选B1/B2/C1/C2指标
- 详情按钮

条形图展示前30名，颜色按标签：
- 高波: 红色
- 中波: 橙色  
- 小波: 黄色
- 其他: 灰/蓝色


---

## A2设计：高波动股票统计 {#a2设计}

### 核心思路
筛选高波动股票，列出名单（类似最新热点），统计行业分布，柱状图展示。

**新增需求**：添加信号标签列，展示每只股票的信号（复用SignalCalculator），但排序仍按波动率，不按信号排序。

### 计算步骤

#### 步骤1：筛选高波动股票

```python
# 伪代码
high_vol_stocks = []
signal_calculator = SignalCalculator()  # 初始化信号计算器

for stock in all_stocks:
    change = (vol_today - vol_yesterday) / vol_yesterday * 100
    
    if abs(change) >= threshold:  # 默认10%
        # 计算信号标签（复用现有的SignalCalculator）
        signal_data = signal_calculator.calculate_signals(
            stock.code, 
            current_date, 
            stock_data,
            period=7
        )
        
        high_vol_stocks.append({
            'code': stock.code,
            'name': stock.name,
            'industry': stock.industry,
            'volatility_change': change,
            'rank': stock.rank,
            'signals': signal_data.get('signals', []),  # 信号列表
            'signal_labels': ', '.join([s['label'] for s in signal_data.get('signals', [])])  # 信号标签文本
        })

# 按波动率绝对值排序（不按信号排序）
high_vol_stocks.sort(key=lambda x: abs(x['volatility_change']), reverse=True)
```

#### 步骤2：统计行业分布

```python
industry_stats = {}
for stock in high_vol_stocks:
    industry = stock['industry']
    industry_stats[industry] = industry_stats.get(industry, 0) + 1

# 排序
sorted_industries = sorted(industry_stats.items(), key=lambda x: x[1], reverse=True)
```

### 数据模型

```python
class HighVolatilityStock(BaseModel):
    stock_code: str
    stock_name: str
    industry: str
    rank: int
    volatility_change: float
    volatility_label: str
    vol_today: float
    vol_yesterday: float
    price_change: Optional[float]
    turnover_rate: Optional[float]
    
    # 新增：信号相关字段
    signals: Optional[List[Dict]] = []       # 信号详细列表
    signal_labels: Optional[str] = ""        # 信号标签文本（逗号分隔）
    total_score: Optional[float] = None      # 总分

class IndustryDistribution(BaseModel):
    industry: str
    count: int
    percentage: float
    top_stocks: List[HighVolatilityStock]  # 前5只

class HighVolatilityStocksA2Response(BaseModel):
    date: str
    previous_date: str
    threshold: float
    total_count: int
    stocks: List[HighVolatilityStock]
    industry_distribution: List[IndustryDistribution]
```

### API接口

```python
GET /api/stocks/high-volatility-a2

参数:
- date: str (YYYYMMDD)
- threshold: float (5.0-100.0, 默认10.0)
- period: int (2-14, 默认3)
- sort_by: str ('volatility'|'rank'|'industry')
- limit: int (50-1000, 默认200)
- calculate_signals: bool (默认True) # 是否计算信号标签
- signal_period: int (2-14, 默认7) # 信号计算周期

返回: HighVolatilityStocksA2Response

说明：
- sort_by 始终按波动率排序，不支持按信号排序
- calculate_signals=True 时会调用 SignalCalculator 计算信号
- signal_period 控制信号计算的周期（天数）
```

### 前端展示

#### 股票名单表格（类似最新热点）

显示筛选出的高波动股票，包含：
- 排名、代码、名称、行业
- 榜单排名、波动率变化、波动率标签
- **信号标签**（新增）：显示该股票的所有信号（如"放量↑", "波动率↑"等）
- 涨跌幅、换手率、总分
- 可展开查看详情

**排序说明**：始终按波动率变化的绝对值排序，信号标签仅作为辅助信息展示。

#### 行业分布柱状图

参考你提供的图片样式：
- 标题：「当前比例统计（共N只高波动股票）」
- 横向柱状图
- 显示行业名、股票数、百分比
- 前10个行业
- 颜色可区分不同行业


---

## UI设计 {#ui设计}

### 布局结构

```

 行业热度分析（加权版本）                

                                         
 【波动率分析维度】（新增）              
        
   A1: 行业波动    A2: 股票统计     
    全行业排名       名单+柱状图      
        
                                         
 【A2专用筛选】（仅A2模式显示）          
 波动率阈值: [] 10%                
             5%  10%  20%  50%  100%     
 分析周期: 2天 3天 5天 7天 14天     
                                         
  
                                         
 【排序指标】                            
 [A1/A2] [B1] [B2] [C1] [C2]           
                                         
 【k值】（仅B1/B2）                      
 k值: [] 0.618                     
                                         
 [ 开始计算]                           

```

### 模式切换逻辑

```jsx
const [volatilityMode, setVolatilityMode] = useState('A1'); // 'A1' or 'A2'
const [selectedMetric, setSelectedMetric] = useState('A1');

// 切换模式时自动切换指标
const handleModeChange = (mode) => {
  setVolatilityMode(mode);
  setSelectedMetric(mode);
};

// 只显示当前模式可用的指标按钮
const availableMetrics = METRICS.filter(
  m => m.available.includes(volatilityMode)
);
```

### 指标按钮配置

```jsx
const METRICS = [
  {
    value: 'A1',
    label: 'A1: 行业波动率',
    desc: '看哪个行业波动最活跃',
    detail: '按行业平均波动率变化排名，动态标签',
    color: 'red',
    available: ['A1']
  },
  {
    value: 'A2',
    label: 'A2: 高波动股数',
    desc: '看哪个行业高波动股多',
    detail: '统计高波动股票的行业分布',
    color: 'orange',
    available: ['A2']
  },
  {
    value: 'B1',
    label: 'B1: 总热度',
    desc: '看哪个行业精英多',
    detail: '排名加权累加，适合追热点',
    color: 'indigo',
    available: ['A1', 'A2']  // 两种模式都可用
  },
  // ... B2, C1, C2
];
```

---

## 实施步骤 {#实施步骤}

### Phase 1: 后端API开发

1. **创建数据模型** (ackend/app/models/industry.py)
   - IndustryVolatilityA1
   - IndustryVolatilityA1Response
   - HighVolatilityStock
   - IndustryDistribution
   - HighVolatilityStocksA2Response

2. **实现核心算法** (新建 ackend/app/services/volatility_service.py)
   - calculate_industry_volatility_ranking() - A1计算
   - get_high_volatility_stocks() - A2计算
   - extract_industry_name() - 工具函数
   - ssign_volatility_label() - 标签分配

3. **添加API端点** (ackend/app/routers/industry.py)
   - GET /api/industry/volatility-ranking-a1
   - GET /api/stocks/high-volatility-a2

4. **测试API**
   - 单元测试
   - 集成测试
   - 性能测试

### Phase 2: 前端开发

1. **扩展现有模块** (rontend/src/components/modules/IndustryWeightedModule.js)
   - 添加A1/A2模式切换按钮
   - 添加A2专用的阈值滑块
   - 添加指标按钮（A1/A2/B1/B2/C1/C2）
   - 实现模式切换逻辑

2. **A1结果展示**
   - 表格：前50名行业
   - 条形图：前30名
   - 颜色按标签区分

3. **A2结果展示**
   - 股票名单表格（参考HotSpotsModule）
   - 行业分布柱状图
   - 筛选控制UI

4. **前端说明文档**
   - 初始引导页
   - Tooltip提示
   - A1/A2对比说明

### Phase 3: 文档和测试

1. **技术文档**
   - API文档更新
   - 前端组件文档

2. **用户文档**
   - 快速参考
   - 使用案例
   - 常见问题

3. **全面测试**
   - 功能测试
   - 边界情况测试
   - 性能测试
   - 用户体验测试

### Phase 4: 优化和上线

1. **性能优化**
   - 缓存策略
   - 查询优化

2. **上线部署**
   - 代码审查
   - 部署到生产环境
   - 监控

---

## 重要注意事项

### 数据库差异
- 当前项目使用 **PostgreSQL**（不是MySQL）
- 需要注意PostgreSQL特定的查询语法

### 波动率数据
- 字段名: olatility (DECIMAL类型)
- 表: daily_stock_data
- 需处理NULL值和0值

### 行业字段处理
行业字段可能有多种格式：
- 字符串: "化学制品"
- 列表: ["化学制品"]  
- 字符串列表: "['化学制品']"

必须统一处理。

### 性能考虑
- A1需遍历所有股票（5000+）
- A2需筛选和排序
- 考虑添加缓存（TTLCache）
- 建议响应时间 < 3秒

### 复用现有代码
- 复用 memory_cache 获取数据
- 复用 SignalThresholds 的设计理念
- 参考 IndustryWeightedModule.js 的UI设计
- 参考 HotSpotsModule.js 的表格样式

---

## 附录：参考文件

### 后端参考
- ackend/app/services/memory_cache.py - 内存缓存
- ackend/app/services/signal_calculator.py - 信号计算（波动率逻辑）
- ackend/app/routers/industry.py - 行业API
- ackend/app/models/industry.py - 数据模型

### 前端参考
- rontend/src/components/modules/IndustryWeightedModule.js - 加权模块UI
- rontend/src/components/modules/HotSpotsModule.js - 热点表格样式
- rontend/src/App.js - 导航集成

### 文档参考
- docs/行业热度分析-加权版本-快速参考.md
- docs/行业热度分析-开发日志.md

---

**最后更新**: 2025-11-20  
**文档版本**: 1.0.0  
**状态**:  设计完成，待开发

---

## 补充说明：A2信号标签集成 {#a2信号标签集成}

### 实现要点

1. **复用SignalCalculator**
   - 使用现有的 SignalCalculator.calculate_signals() 方法
   - 保持与"最新热点"功能一致的信号计算逻辑
   - 信号周期默认7天（可配置）

2. **信号标签展示**
   - 多个信号用逗号分隔显示（如："放量, 波动率, 连涨3天"）
   - 可使用徽章样式（Badge）显示每个信号
   - 信号数量较多时可折叠显示

3. **排序逻辑**
   - **主要排序**：波动率变化绝对值（降序）
   - **信号不参与排序**：仅作为辅助信息
   - 用户无法选择按信号排序

4. **性能考虑**
   - SignalCalculator 计算可能较耗时
   - 建议添加 calculate_signals 参数，允许用户关闭信号计算
   - 对于大量股票（>200只），考虑异步计算或分批处理

### 代码示例

```python
# backend/app/services/volatility_service.py

from app.services.signal_calculator import SignalCalculator, SignalThresholds

def get_high_volatility_stocks_with_signals(
    target_date: date,
    threshold: float,
    calculate_signals: bool = True,
    signal_period: int = 7
):
    # ... 筛选高波动股票 ...
    
    if calculate_signals:
        signal_calculator = SignalCalculator()
        
        for stock_data in high_vol_stocks:
            # 获取股票的DailyStockData对象
            stock_daily = memory_cache.get_daily_data_by_stock(
                stock_data['stock_code'],
                target_date
            )
            
            if stock_daily:
                # 计算信号
                signal_result = signal_calculator.calculate_signals(
                    stock_data['stock_code'],
                    target_date,
                    stock_daily,
                    period=signal_period
                )
                
                # 提取信号标签
                signals = signal_result.get('signals', [])
                signal_labels = [s.get('label', '') for s in signals]
                
                stock_data['signals'] = signals
                stock_data['signal_labels'] = ', '.join(signal_labels)
                stock_data['total_score'] = signal_result.get('total_score', 0)
    
    return high_vol_stocks
```

### 前端展示示例

```jsx
// A2 股票表格列定义
const columns = [
  { key: 'rank', label: '排名', width: 60 },
  { key: 'stock_code', label: '代码', width: 80 },
  { key: 'stock_name', label: '名称', width: 100 },
  { key: 'industry', label: '行业', width: 100 },
  { key: 'volatility_change', label: '波动率变化', width: 100, 
    render: (val) => (
      <span className={val > 0 ? 'text-red-600' : 'text-green-600'}>
        {val > 0 ? '+' : ''}{val.toFixed(2)}%
      </span>
    )
  },
  { key: 'volatility_label', label: '波动标签', width: 80 },
  { 
    key: 'signal_labels', 
    label: '信号标签', 
    width: 200,
    render: (val) => {
      if (!val) return '-';
      const labels = val.split(', ');
      return (
        <div className="flex flex-wrap gap-1">
          {labels.map((label, idx) => (
            <span key={idx} className="badge badge-sm badge-info">
              {label}
            </span>
          ))}
        </div>
      );
    }
  },
  { key: 'price_change', label: '涨跌幅', width: 80 },
  { key: 'turnover_rate', label: '换手率', width: 80 },
  { key: 'total_score', label: '总分', width: 80 }
];
```

---

**文档更新时间**: 2025-11-20 10:10  
**更新内容**: 添加A2信号标签列需求  
**状态**:  设计完善，待开发
