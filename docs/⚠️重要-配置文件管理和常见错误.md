# ⚠️ 重要：配置文件管理和常见错误

## 🔴 严重错误记录

### 错误1：数据库配置文件被推送到Git（2025-11-07）

**现象**：
- 服务器拉取代码后，数据库配置被覆盖为本地开发环境的配置
- `backend/app/database.py` 包含硬编码的数据库IP `192.168.182.128`（本地IP）
- 导致服务器无法连接数据库
- `data/data_import_state.json` 被重置，导致数据重复导入

**根本原因**：
1. `backend/app/database.py` 包含硬编码的默认值
2. 该文件未被添加到 `.gitignore`
3. 被提交并推送到Git仓库
4. 服务器`git pull`时被覆盖

**影响**：
- ❌ 服务器数据库配置被覆盖
- ❌ 数据库污染（尝试连接本地数据库失败）
- ❌ 数据导入状态丢失
- ❌ 需要删库重建

**修复措施**：
1. ✅ 从Git中移除 `backend/app/database.py`
2. ✅ 创建 `backend/app/database.py.example` 模板
3. ✅ 添加到 `.gitignore`
4. ✅ 服务器需要手动配置 `database.py`
5. ✅ 删除污染的数据，重新导入

---

## 🛡️ 配置文件清单（绝对不能提交到Git）

### 必须保护的文件

```
⚠️ 数据库配置
backend/app/database.py           # 数据库连接配置（包含IP、密码）
backend/.env                      # 环境变量文件
backend/database.env              # 数据库环境变量

⚠️ 数据和状态文件
data/*.json                       # 所有JSON配置
data/data_import_state.json      # 数据导入状态（包含服务器特定信息）
data/db_config.json              # 数据库配置
data/database.json               # 数据库信息

⚠️ 日志和运行时文件
logs/                            # 日志目录
*.log                            # 日志文件
.pids/                           # 进程ID文件
*.pid                            # 进程ID
service_config.json              # 服务配置

⚠️ 环境配置
.env.production                  # 生产环境变量
.env.local                       # 本地环境变量
backend/app/config.local.py      # 本地配置覆盖
```

### 可以提交的文件

```
✅ 模板文件
backend/app/database.py.example   # 数据库配置模板
.env.example                      # 环境变量示例
deploy/nginx.conf.example         # Nginx配置示例

✅ 编译文件（用于服务器部署）
frontend/build/                   # 前端编译文件（本地编译，服务器使用）

✅ 文档和脚本
docs/                            # 文档目录
deploy/                          # 部署脚本
*.sh                             # Shell脚本
```

---

## 📋 部署前检查清单

### 本地开发

- [ ] 确认 `.gitignore` 包含所有配置文件
- [ ] 检查 `git status` 没有配置文件
- [ ] 编译前端：`cd frontend && npm run build`
- [ ] 提交代码：`git add . && git commit && git push`

### 服务器部署

- [ ] **备份服务器配置**：
  ```bash
  cp backend/app/database.py ~/database.py.backup
  cp data/data_import_state.json ~/data_import_state.json.backup
  ```

- [ ] 拉取代码：`git pull`

- [ ] **恢复配置**（如果被覆盖）：
  ```bash
  cp ~/database.py.backup backend/app/database.py
  cp ~/data_import_state.json.backup data/data_import_state.json
  ```

- [ ] 重启服务：`bash start_all.sh`

---

## 🔧 首次部署配置

### 服务器上创建数据库配置

```bash
cd ~/DA/Analysis_A/backend/app

# 1. 复制模板
cp database.py.example database.py

# 2. 编辑配置
nano database.py

# 3. 修改以下内容为服务器实际配置
DB_HOST = "your_server_ip"       # 例如：localhost 或实际IP
DB_PORT = "5432"
DB_NAME = "your_database_name"
DB_USER = "your_username"
DB_PASSWORD = "your_password"
```

### 或使用环境变量（推荐）

```bash
cd ~/DA/Analysis_A/backend

# 创建 .env 文件
cat > .env << 'EOF'
DB_HOST=localhost
DB_PORT=5432
DB_NAME=db_20251106_analysis_a
DB_USER=postgres
DB_PASSWORD=your_password_here
EOF

# 保护 .env 文件
chmod 600 .env
```

---

## 🚨 紧急恢复流程

### 如果数据库配置被覆盖

```bash
# 1. 停止服务
cd ~/DA/Analysis_A
bash stop.sh

# 2. 恢复备份的配置
cp ~/database.py.backup backend/app/database.py

# 3. 或者重新配置
nano backend/app/database.py

# 4. 重启服务
bash start_all.sh
```

### 如果数据被污染

```bash
# 1. 连接数据库
psql -h localhost -U postgres -d db_20251106_analysis_a

# 2. 删除所有数据
TRUNCATE TABLE daily_stock_data CASCADE;
TRUNCATE TABLE stocks CASCADE;

# 3. 删除导入状态
rm data/data_import_state.json

# 4. 重启服务（会自动重新导入）
bash start_all.sh
```

---

## ✅ 验证配置正确性

### 检查Git状态

```bash
# 确保没有配置文件
git status

# 应该看不到以下文件：
# ❌ backend/app/database.py
# ❌ data/*.json
# ❌ .env
```

### 测试数据库连接

```bash
cd backend
python3 -c "from app.database import test_connection; test_connection()"
```

---

## 📖 最佳实践

### DO（推荐）

✅ 使用环境变量配置敏感信息
✅ 使用 `.example` 文件作为模板
✅ 部署前备份服务器配置
✅ 使用 `git status` 检查提交内容
✅ 定期备份数据库

### DON'T（禁止）

❌ 硬编码数据库密码
❌ 提交 `.env` 文件
❌ 提交包含敏感信息的配置
❌ 直接在生产环境修改Git仓库文件
❌ 盲目执行 `git add .`

---

## 🔍 定期检查

### 每周检查

```bash
# 检查Git中是否有敏感文件
git ls-files | grep -E "database.py$|\.env$|data.*\.json$"

# 应该返回空或只有 .example 文件
```

### 部署后检查

```bash
# 1. 检查服务状态
ps aux | grep uvicorn

# 2. 检查数据库连接
tail -f logs/backend.log | grep "数据库"

# 3. 测试API
curl http://localhost:8000/
```

---

## 📞 问题排查

### 问题：服务启动后立即退出

**原因**：数据库连接失败

**解决**：
```bash
# 查看日志
tail -100 logs/backend.log

# 检查数据库配置
cat backend/app/database.py | grep DB_HOST

# 测试连接
psql -h <DB_HOST> -U <DB_USER> -d <DB_NAME>
```

### 问题：数据重复导入

**原因**：`data_import_state.json` 被重置

**解决**：
```bash
# 恢复备份
cp ~/data_import_state.json.backup data/data_import_state.json

# 或手动编辑
nano data/data_import_state.json
```

---

**记住：配置文件安全 > 一切！**

每次部署前，务必检查：
1. `.gitignore` 是否正确
2. `git status` 没有配置文件
3. 服务器配置已备份
