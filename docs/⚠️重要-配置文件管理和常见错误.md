# âš ï¸ é‡è¦ï¼šé…ç½®æ–‡ä»¶ç®¡ç†å’Œå¸¸è§é”™è¯¯

**ğŸ“Œ æœ¬æ–‡æ¡£è®°å½•äº†æ‰€æœ‰éƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆï¼ŒåŠ¡å¿…åœ¨éƒ¨ç½²å‰ä»”ç»†é˜…è¯»ï¼**

---

## ğŸ”´ ä¸¥é‡é”™è¯¯è®°å½•

### é”™è¯¯1ï¼šæ•°æ®åº“é…ç½®æ–‡ä»¶è¢«æ¨é€åˆ°Gitï¼ˆ2025-11-07 é¦–æ¬¡éƒ¨ç½²ï¼‰

**ç°è±¡**ï¼š
- æœåŠ¡å™¨æ‹‰å–ä»£ç åï¼Œæ•°æ®åº“é…ç½®è¢«è¦†ç›–ä¸ºæœ¬åœ°å¼€å‘ç¯å¢ƒçš„é…ç½®
- `backend/app/database.py` åŒ…å«ç¡¬ç¼–ç çš„æ•°æ®åº“IP `192.168.182.128`ï¼ˆæœ¬åœ°IPï¼‰
- å¯¼è‡´æœåŠ¡å™¨æ— æ³•è¿æ¥æ•°æ®åº“
- `data/data_import_state.json` è¢«é‡ç½®ï¼Œå¯¼è‡´æ•°æ®é‡å¤å¯¼å…¥

**æ ¹æœ¬åŸå› **ï¼š
1. `backend/app/database.py` åŒ…å«ç¡¬ç¼–ç çš„é»˜è®¤å€¼
2. è¯¥æ–‡ä»¶æœªè¢«æ·»åŠ åˆ° `.gitignore`
3. è¢«æäº¤å¹¶æ¨é€åˆ°Gitä»“åº“
4. æœåŠ¡å™¨`git pull`æ—¶è¢«è¦†ç›–

**å½±å“**ï¼š
- âŒ æœåŠ¡å™¨æ•°æ®åº“é…ç½®è¢«è¦†ç›–
- âŒ æ•°æ®åº“æ±¡æŸ“ï¼ˆå°è¯•è¿æ¥æœ¬åœ°æ•°æ®åº“å¤±è´¥ï¼‰
- âŒ æ•°æ®å¯¼å…¥çŠ¶æ€ä¸¢å¤±
- âŒ éœ€è¦åˆ åº“é‡å»º

**ä¿®å¤æªæ–½**ï¼š
1. âœ… ä»Gitä¸­ç§»é™¤ `backend/app/database.py`
2. âœ… åˆ›å»º `backend/app/database.py.example` æ¨¡æ¿
3. âœ… æ·»åŠ åˆ° `.gitignore`
4. âœ… æœåŠ¡å™¨éœ€è¦æ‰‹åŠ¨é…ç½® `database.py`
5. âœ… åˆ é™¤æ±¡æŸ“çš„æ•°æ®ï¼Œé‡æ–°å¯¼å…¥

---

## ğŸ›¡ï¸ é…ç½®æ–‡ä»¶æ¸…å•ï¼ˆç»å¯¹ä¸èƒ½æäº¤åˆ°Gitï¼‰

### å¿…é¡»ä¿æŠ¤çš„æ–‡ä»¶

```
âš ï¸ æ•°æ®åº“é…ç½®
backend/app/database.py           # æ•°æ®åº“è¿æ¥é…ç½®ï¼ˆåŒ…å«IPã€å¯†ç ï¼‰
backend/.env                      # ç¯å¢ƒå˜é‡æ–‡ä»¶
backend/database.env              # æ•°æ®åº“ç¯å¢ƒå˜é‡

âš ï¸ æ•°æ®å’ŒçŠ¶æ€æ–‡ä»¶
data/*.json                       # æ‰€æœ‰JSONé…ç½®
data/data_import_state.json      # æ•°æ®å¯¼å…¥çŠ¶æ€ï¼ˆåŒ…å«æœåŠ¡å™¨ç‰¹å®šä¿¡æ¯ï¼‰
data/db_config.json              # æ•°æ®åº“é…ç½®
data/database.json               # æ•°æ®åº“ä¿¡æ¯

âš ï¸ æ—¥å¿—å’Œè¿è¡Œæ—¶æ–‡ä»¶
logs/                            # æ—¥å¿—ç›®å½•
*.log                            # æ—¥å¿—æ–‡ä»¶
.pids/                           # è¿›ç¨‹IDæ–‡ä»¶
*.pid                            # è¿›ç¨‹ID
service_config.json              # æœåŠ¡é…ç½®

âš ï¸ ç¯å¢ƒé…ç½®
.env.production                  # ç”Ÿäº§ç¯å¢ƒå˜é‡
.env.local                       # æœ¬åœ°ç¯å¢ƒå˜é‡
backend/app/config.local.py      # æœ¬åœ°é…ç½®è¦†ç›–
```

### å¯ä»¥æäº¤çš„æ–‡ä»¶

```
âœ… æ¨¡æ¿æ–‡ä»¶
backend/app/database.py.example   # æ•°æ®åº“é…ç½®æ¨¡æ¿
.env.example                      # ç¯å¢ƒå˜é‡ç¤ºä¾‹
deploy/nginx.conf.example         # Nginxé…ç½®ç¤ºä¾‹

âœ… ç¼–è¯‘æ–‡ä»¶ï¼ˆç”¨äºæœåŠ¡å™¨éƒ¨ç½²ï¼‰
frontend/build/                   # å‰ç«¯ç¼–è¯‘æ–‡ä»¶ï¼ˆæœ¬åœ°ç¼–è¯‘ï¼ŒæœåŠ¡å™¨ä½¿ç”¨ï¼‰

âœ… æ–‡æ¡£å’Œè„šæœ¬
docs/                            # æ–‡æ¡£ç›®å½•
deploy/                          # éƒ¨ç½²è„šæœ¬
*.sh                             # Shellè„šæœ¬
```

---

## ğŸ“‹ éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

### æœ¬åœ°å¼€å‘

- [ ] ç¡®è®¤ `.gitignore` åŒ…å«æ‰€æœ‰é…ç½®æ–‡ä»¶
- [ ] æ£€æŸ¥ `git status` æ²¡æœ‰é…ç½®æ–‡ä»¶
- [ ] ç¼–è¯‘å‰ç«¯ï¼š`cd frontend && npm run build`
- [ ] æäº¤ä»£ç ï¼š`git add . && git commit && git push`

### æœåŠ¡å™¨éƒ¨ç½²

- [ ] **å¤‡ä»½æœåŠ¡å™¨é…ç½®**ï¼š
  ```bash
  cp backend/app/database.py ~/database.py.backup
  cp data/data_import_state.json ~/data_import_state.json.backup
  ```

- [ ] æ‹‰å–ä»£ç ï¼š`git pull`

- [ ] **æ¢å¤é…ç½®**ï¼ˆå¦‚æœè¢«è¦†ç›–ï¼‰ï¼š
  ```bash
  cp ~/database.py.backup backend/app/database.py
  cp ~/data_import_state.json.backup data/data_import_state.json
  ```

- [ ] é‡å¯æœåŠ¡ï¼š`bash start_all.sh`

---

## ğŸ”§ é¦–æ¬¡éƒ¨ç½²é…ç½®

### æœåŠ¡å™¨ä¸Šåˆ›å»ºæ•°æ®åº“é…ç½®

```bash
cd ~/DA/Analysis_A/backend/app

# 1. å¤åˆ¶æ¨¡æ¿
cp database.py.example database.py

# 2. ç¼–è¾‘é…ç½®
nano database.py

# 3. ä¿®æ”¹ä»¥ä¸‹å†…å®¹ä¸ºæœåŠ¡å™¨å®é™…é…ç½®
DB_HOST = "your_server_ip"       # ä¾‹å¦‚ï¼šlocalhost æˆ–å®é™…IP
DB_PORT = "5432"
DB_NAME = "your_database_name"
DB_USER = "your_username"
DB_PASSWORD = "your_password"
```

### æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆæ¨èï¼‰

```bash
cd ~/DA/Analysis_A/backend

# åˆ›å»º .env æ–‡ä»¶
cat > .env << 'EOF'
DB_HOST=localhost
DB_PORT=5432
DB_NAME=db_20251106_analysis_a
DB_USER=postgres
DB_PASSWORD=your_password_here
EOF

# ä¿æŠ¤ .env æ–‡ä»¶
chmod 600 .env
```

---

## ğŸš¨ ç´§æ€¥æ¢å¤æµç¨‹

### å¦‚æœæ•°æ®åº“é…ç½®è¢«è¦†ç›–

```bash
# 1. åœæ­¢æœåŠ¡
cd ~/DA/Analysis_A
bash stop.sh

# 2. æ¢å¤å¤‡ä»½çš„é…ç½®
cp ~/database.py.backup backend/app/database.py

# 3. æˆ–è€…é‡æ–°é…ç½®
nano backend/app/database.py

# 4. é‡å¯æœåŠ¡
bash start_all.sh
```

### å¦‚æœæ•°æ®è¢«æ±¡æŸ“

```bash
# 1. è¿æ¥æ•°æ®åº“
psql -h localhost -U postgres -d db_20251106_analysis_a

# 2. åˆ é™¤æ‰€æœ‰æ•°æ®
TRUNCATE TABLE daily_stock_data CASCADE;
TRUNCATE TABLE stocks CASCADE;

# 3. åˆ é™¤å¯¼å…¥çŠ¶æ€
rm data/data_import_state.json

# 4. é‡å¯æœåŠ¡ï¼ˆä¼šè‡ªåŠ¨é‡æ–°å¯¼å…¥ï¼‰
bash start_all.sh
```

---

## âœ… éªŒè¯é…ç½®æ­£ç¡®æ€§

### æ£€æŸ¥GitçŠ¶æ€

```bash
# ç¡®ä¿æ²¡æœ‰é…ç½®æ–‡ä»¶
git status

# åº”è¯¥çœ‹ä¸åˆ°ä»¥ä¸‹æ–‡ä»¶ï¼š
# âŒ backend/app/database.py
# âŒ data/*.json
# âŒ .env
```

### æµ‹è¯•æ•°æ®åº“è¿æ¥

```bash
cd backend
python3 -c "from app.database import test_connection; test_connection()"
```

---

## ğŸ“– æœ€ä½³å®è·µ

### DOï¼ˆæ¨èï¼‰

âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®æ•æ„Ÿä¿¡æ¯
âœ… ä½¿ç”¨ `.example` æ–‡ä»¶ä½œä¸ºæ¨¡æ¿
âœ… éƒ¨ç½²å‰å¤‡ä»½æœåŠ¡å™¨é…ç½®
âœ… ä½¿ç”¨ `git status` æ£€æŸ¥æäº¤å†…å®¹
âœ… å®šæœŸå¤‡ä»½æ•°æ®åº“

### DON'Tï¼ˆç¦æ­¢ï¼‰

âŒ ç¡¬ç¼–ç æ•°æ®åº“å¯†ç 
âŒ æäº¤ `.env` æ–‡ä»¶
âŒ æäº¤åŒ…å«æ•æ„Ÿä¿¡æ¯çš„é…ç½®
âŒ ç›´æ¥åœ¨ç”Ÿäº§ç¯å¢ƒä¿®æ”¹Gitä»“åº“æ–‡ä»¶
âŒ ç›²ç›®æ‰§è¡Œ `git add .`

---

## ğŸ” å®šæœŸæ£€æŸ¥

### æ¯å‘¨æ£€æŸ¥

```bash
# æ£€æŸ¥Gitä¸­æ˜¯å¦æœ‰æ•æ„Ÿæ–‡ä»¶
git ls-files | grep -E "database.py$|\.env$|data.*\.json$"

# åº”è¯¥è¿”å›ç©ºæˆ–åªæœ‰ .example æ–‡ä»¶
```

### éƒ¨ç½²åæ£€æŸ¥

```bash
# 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
ps aux | grep uvicorn

# 2. æ£€æŸ¥æ•°æ®åº“è¿æ¥
tail -f logs/backend.log | grep "æ•°æ®åº“"

# 3. æµ‹è¯•API
curl http://localhost:8000/
```

---

## ğŸ“ é—®é¢˜æ’æŸ¥

### é—®é¢˜ï¼šæœåŠ¡å¯åŠ¨åç«‹å³é€€å‡º

**åŸå› **ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥

**è§£å†³**ï¼š
```bash
# æŸ¥çœ‹æ—¥å¿—
tail -100 logs/backend.log

# æ£€æŸ¥æ•°æ®åº“é…ç½®
cat backend/app/database.py | grep DB_HOST

# æµ‹è¯•è¿æ¥
psql -h <DB_HOST> -U <DB_USER> -d <DB_NAME>
```

### é—®é¢˜ï¼šæ•°æ®é‡å¤å¯¼å…¥

**åŸå› **ï¼š`data_import_state.json` è¢«é‡ç½®

**è§£å†³**ï¼š
```bash
# æ¢å¤å¤‡ä»½
cp ~/data_import_state.json.backup data/data_import_state.json

# æˆ–æ‰‹åŠ¨ç¼–è¾‘
nano data/data_import_state.json
```

---

---

### é”™è¯¯2ï¼šå‰ç«¯buildæœªæ­£ç¡®æäº¤åˆ°Gitï¼ˆ2025-11-07 v0.2.2éƒ¨ç½²ï¼‰

**ç°è±¡**ï¼š
- æœåŠ¡å™¨æ‹‰å–ä»£ç åï¼Œ`frontend/build` ç›®å½•ä¸å­˜åœ¨æˆ–æ–‡ä»¶è¿‡å°‘
- Nginxæ— æ³•æ‰¾åˆ°å‰ç«¯é™æ€æ–‡ä»¶
- è®¿é—®ç½‘ç«™æ˜¾ç¤º404æˆ–Nginxé»˜è®¤é¡µé¢

**æ ¹æœ¬åŸå› **ï¼š
1. `.gitignore` ä¸­ `frontend/build/` æœªè¢«æ³¨é‡Š
2. åœ¨ç¬¬13è¡Œä»ç„¶æœ‰ `build/` é€šé…ç¬¦å¿½ç•¥æ‰€æœ‰buildç›®å½•
3. éœ€è¦ç²¾ç¡®æŒ‡å®šåªå¿½ç•¥ `backend/build/`

**ä¿®å¤æªæ–½**ï¼š
```gitignore
# é”™è¯¯é…ç½®
build/                    # âŒ ä¼šå¿½ç•¥æ‰€æœ‰buildç›®å½•
frontend/build/           # âŒ æ˜ç¡®å¿½ç•¥å‰ç«¯build

# æ­£ç¡®é…ç½®
backend/build/            # âœ… åªå¿½ç•¥åç«¯build
!frontend/build/          # âœ… å…è®¸å‰ç«¯build
```

**éªŒè¯æ–¹æ³•**ï¼š
```bash
# æœ¬åœ°æ£€æŸ¥
git ls-files frontend/build/ | wc -l  # åº”è¯¥æœ‰å¤šä¸ªæ–‡ä»¶

# ç¡®ä¿buildæ–‡ä»¶å·²æäº¤
git add -f frontend/build
git commit -m "build: æ·»åŠ å‰ç«¯ç¼–è¯‘æ–‡ä»¶"
```

---

### é”™è¯¯3ï¼šNginxé…ç½®å†²çªï¼ˆ2025-11-07 v0.2.2éƒ¨ç½²ï¼‰

**ç°è±¡**ï¼š
```
[warn] conflicting server name "60.205.251.109" on 0.0.0.0:80, ignored
```

**æ ¹æœ¬åŸå› **ï¼š
- æœåŠ¡å™¨å­˜åœ¨å¤šä¸ªNginxé…ç½®æ–‡ä»¶ä½¿ç”¨ç›¸åŒçš„ `server_name`
- é€šå¸¸æ˜¯æ—§é…ç½®æ–‡ä»¶æœªåˆ é™¤ï¼ˆå¦‚ `stock-analysis` å’Œ `stock_analysis`ï¼‰

**è¯Šæ–­å‘½ä»¤**ï¼š
```bash
# æŸ¥æ‰¾å†²çªé…ç½®
grep -r "60.205.251.109" /etc/nginx/sites-enabled/

# æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„é…ç½®
ls -la /etc/nginx/sites-enabled/
```

**ä¿®å¤æªæ–½**ï¼š
```bash
# åˆ é™¤æ—§é…ç½®
sudo rm /etc/nginx/sites-enabled/stock-analysis
sudo rm /etc/nginx/sites-available/stock-analysis

# é‡å¯Nginx
sudo nginx -t
sudo systemctl reload nginx
```

**é¢„é˜²æªæ–½**ï¼š
- æ–°é…ç½®æ–‡ä»¶ä½¿ç”¨å”¯ä¸€ä¸”æ¸…æ™°çš„å‘½åï¼ˆå¦‚ `stock_analysis_v2`ï¼‰
- éƒ¨ç½²å‰å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨åŒåé…ç½®
- åˆ é™¤ä¸å†ä½¿ç”¨çš„æ—§é…ç½®æ–‡ä»¶

---

### é”™è¯¯4ï¼šå‰ç«¯APIé…ç½®å¯¼è‡´CORSé”™è¯¯ï¼ˆ2025-11-07 v0.2.2éƒ¨ç½²ï¼‰

**ç°è±¡**ï¼š
- å‰ç«¯é¡µé¢å¯ä»¥è®¿é—®ï¼Œä½†æ— æ³•åŠ è½½æ•°æ®
- æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤ºCORSé”™è¯¯
- Networké¢æ¿æ˜¾ç¤ºè¯·æ±‚ `http://60.205.251.109:8000/api/...` å¤±è´¥

**æ ¹æœ¬åŸå› **ï¼š
- `frontend/src/constants/config.js` ä¸­ `API_BASE_URL` é…ç½®ä¸ºå®Œæ•´URLï¼ˆå¸¦ç«¯å£ï¼‰
- å‰ç«¯ç›´æ¥è®¿é—®åç«¯8000ç«¯å£ï¼Œç»•è¿‡Nginxä»£ç†
- å¯¼è‡´è·¨åŸŸè¯·æ±‚è¢«æµè§ˆå™¨æ‹¦æˆª

**é”™è¯¯é…ç½®**ï¼š
```javascript
// âŒ é”™è¯¯ï¼šç›´æ¥è®¿é—®åç«¯ç«¯å£
export const API_BASE_URL = 'http://60.205.251.109:8000';
```

**æ­£ç¡®é…ç½®**ï¼š
```javascript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œé€šè¿‡Nginxä»£ç†
export const API_BASE_URL = '';  // ç©ºå­—ç¬¦ä¸²æˆ–ä¸è®¾ç½®

// æœ¬åœ°å¼€å‘æ—¶ä¸´æ—¶æ”¹ä¸º
export const API_BASE_URL = 'http://localhost:8000';
```

**ä¿®å¤æµç¨‹**ï¼š
```bash
# 1. ä¿®æ”¹é…ç½®æ–‡ä»¶
nano frontend/src/constants/config.js

# 2. é‡æ–°ç¼–è¯‘
cd frontend
rm -rf build
npm run build

# 3. æäº¤æ¨é€
cd ..
git add .
git commit -m "fix: ä¿®æ”¹APIé…ç½®ä½¿ç”¨Nginxä»£ç†"
git push

# 4. æœåŠ¡å™¨æ›´æ–°
ssh server
cd ~/DA/Analysis_A
git pull
sudo systemctl reload nginx
```

**å·¥ä½œåŸç†**ï¼š
- å‰ç«¯è®¿é—®ï¼š`http://60.205.251.109/api/dates`
- Nginxä»£ç†ï¼š`/api/*` â†’ `http://localhost:8000/api/*`
- é¿å…è·¨åŸŸï¼Œç»Ÿä¸€é€šè¿‡80ç«¯å£

---

### é”™è¯¯5ï¼šPythonç¼“å­˜å¯¼è‡´é…ç½®æœªæ›´æ–°ï¼ˆ2025-11-07 v0.2.2éƒ¨ç½²ï¼‰

**ç°è±¡**ï¼š
- ä¿®æ”¹äº† `database.py` ä½†ä»ç„¶è¿æ¥æ—§çš„æ•°æ®åº“IP
- æ—¥å¿—æ˜¾ç¤º `connection to server at "192.168.182.128"` å¤±è´¥

**æ ¹æœ¬åŸå› **ï¼š
- Pythonçš„ `__pycache__` ç¼“å­˜äº†æ—§çš„é…ç½®
- ä¿®æ”¹é…ç½®æ–‡ä»¶åæœªæ¸…é™¤ç¼“å­˜

**ä¿®å¤æªæ–½**ï¼š
```bash
# æ¸…é™¤æ‰€æœ‰Pythonç¼“å­˜
find backend -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null
find backend -name "*.pyc" -delete

# é‡å¯æœåŠ¡
bash stop.sh
bash start_all.sh
```

**é¢„é˜²æªæ–½**ï¼š
- ä¿®æ”¹é…ç½®åæ€»æ˜¯æ¸…é™¤ç¼“å­˜
- æˆ–åœ¨å¯åŠ¨è„šæœ¬ä¸­è‡ªåŠ¨æ¸…é™¤

---

### é”™è¯¯6ï¼šv0.2.4å¯åŠ¨æ£€æŸ¥è¿‡äºä¸¥æ ¼å¯¼è‡´æ— æ³•å¯åŠ¨ï¼ˆ2025-11-08 v0.2.4éƒ¨ç½²ï¼‰

**ç°è±¡**ï¼š
- æœåŠ¡å™¨æ‹‰å–v0.2.4ä»£ç åæ— æ³•å¯åŠ¨
- æ—¥å¿—æ˜¾ç¤ºï¼š`âŒ æ•°æ®å¯¼å…¥å¤±è´¥: 8 ä¸ªæ–‡ä»¶`
- æœ€ç»ˆæŠ¥é”™ï¼š`RuntimeError: å¯åŠ¨æ£€æŸ¥å¤±è´¥`
- æ•°æ®åº“ä¸­å®é™…å·²æœ‰å®Œæ•´æ•°æ®

**æ ¹æœ¬åŸå› **ï¼š
1. v0.2.4å¼•å…¥äº†ä¸¥æ ¼çš„å¯åŠ¨æ£€æŸ¥æœºåˆ¶
2. å½“æ•°æ®åº“ä¸­å·²æœ‰æ•°æ®æ—¶ï¼Œé‡å¤å¯¼å…¥è§¦å‘ `UniqueViolation` é”™è¯¯
3. é”™è¯¯è¢«è®°å½•ä¸º `rolled_back` çŠ¶æ€åˆ° `data_import_state.json`
4. å¯åŠ¨æ£€æŸ¥å‘ç°å¤±è´¥è®°å½•å°±æŠ›å‡º `RuntimeError`ï¼Œæ‹’ç»å¯åŠ¨
5. **ç ´åäº†JSONçŠ¶æ€ç®¡ç†çš„å¹‚ç­‰æ€§è®¾è®¡**

**é”™è¯¯ç¤ºä¾‹**ï¼š
```json
{
  "20251107": {
    "status": "rolled_back",
    "rollback_reason": "duplicate key value violates unique constraint...",
    "imported_count": 0
  }
}
```

**è®¾è®¡ç¼ºé™·**ï¼š
```python
# backend/app/main.py:32
if failed_count > 0:
    raise RuntimeError("å¯åŠ¨æ£€æŸ¥å¤±è´¥")  # âŒ è¿‡äºä¸¥æ ¼
```

**å½±å“**ï¼š
- âŒ æ•°æ®å·²å­˜åœ¨æ—¶æ— æ³•å¯åŠ¨ï¼ˆåº”è¯¥è·³è¿‡é‡å¤æ•°æ®ï¼‰
- âŒ ç ´åäº†ç³»ç»Ÿçš„å¹‚ç­‰æ€§å’Œå®¹é”™æ€§
- âŒ å¯¼è‡´ç”Ÿäº§ç¯å¢ƒæ— æ³•æ­£å¸¸å‡çº§
- âŒ JSONçŠ¶æ€æ–‡ä»¶çš„rollbackè®°å½•æˆä¸ºæ°¸ä¹…éšœç¢

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ1ï¼šæ”¾å®½å¯åŠ¨æ£€æŸ¥ï¼ˆæ¨èï¼‰**
```python
# backend/app/main.py:32 ä¿®æ”¹ä¸º
if failed_count > 0:
    logger.warning(f"âš ï¸  æ•°æ®å¯¼å…¥å‘ç° {failed_count} ä¸ªé—®é¢˜")
    logger.warning("âš ï¸  å¯èƒ½æ˜¯æ•°æ®å·²å­˜åœ¨ï¼Œå…è®¸å¯åŠ¨")
    # ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå…è®¸å¯åŠ¨
```

**æ–¹æ¡ˆ2ï¼šæ™ºèƒ½è¯†åˆ«é”™è¯¯ç±»å‹**
```python
# åªå¯¹çœŸæ­£çš„é”™è¯¯ï¼ˆéé‡å¤é”®ï¼‰æ‰é˜»æ­¢å¯åŠ¨
if has_critical_errors:  # ç½‘ç»œé”™è¯¯ã€æ–‡ä»¶æŸåç­‰
    raise RuntimeError("å¯åŠ¨æ£€æŸ¥å¤±è´¥")
elif has_duplicate_errors:  # æ•°æ®é‡å¤
    logger.warning("æ•°æ®å·²å­˜åœ¨ï¼Œè·³è¿‡")
```

**æ–¹æ¡ˆ3ï¼šæ¸…é™¤çŠ¶æ€é‡æ–°å¯¼å…¥ï¼ˆä¸æ¨èï¼‰**
```bash
# éœ€è¦åˆ åº“é‡æ¥ï¼Œè´¹æ—¶è´¹åŠ›
rm data/data_import_state.json
rm data/sector_import_state.json
# ç„¶åé‡æ–°å¯¼å…¥æ‰€æœ‰æ•°æ®
```

**æœ€ä½³å®è·µ**ï¼š
```python
# å¯¼å…¥é€»è¾‘åº”è¯¥æ˜¯å¹‚ç­‰çš„
try:
    import_data()
except UniqueViolation:
    logger.info("æ•°æ®å·²å­˜åœ¨ï¼Œè·³è¿‡")  # âœ… ä¸åº”è§†ä¸ºé”™è¯¯
    return {"status": "skipped", "reason": "already_exists"}
```

**æ•™è®­æ€»ç»“**ï¼š
1. **å¯åŠ¨æ£€æŸ¥åº”è¯¥å®½å®¹**ï¼šç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œèƒ½å¯åŠ¨æ¯”æ•°æ®å®Œç¾æ›´é‡è¦
2. **å°Šé‡ç°æœ‰è®¾è®¡**ï¼šä¸è¦è½»æ˜“ç ´åå·²æœ‰çš„å¹‚ç­‰æ€§è®¾è®¡
3. **åŒºåˆ†é”™è¯¯ç­‰çº§**ï¼šæ•°æ®é‡å¤ â‰  ç³»ç»Ÿé”™è¯¯
4. **è€ƒè™‘å‡çº§è·¯å¾„**ï¼šæ–°ç‰ˆæœ¬ä¸åº”è®©æ—§ç³»ç»Ÿæ— æ³•å¯åŠ¨
5. **æµ‹è¯•è¾¹ç•Œæƒ…å†µ**ï¼šéƒ¨ç½²å‰æµ‹è¯•æ•°æ®å·²å­˜åœ¨çš„æƒ…å†µ

**ä¸´æ—¶è§£å†³æ–¹æ¡ˆ**ï¼ˆåœ¨ä¿®å¤ä»£ç å‰ï¼‰ï¼š
```bash
# ä¿®æ”¹ main.py ä½¿å…¶å…è®¸å¯åŠ¨
sed -i 's/raise RuntimeError("å¯åŠ¨æ£€æŸ¥å¤±è´¥")/logger.warning("âš ï¸  å¯åŠ¨æ£€æŸ¥å‘ç°é—®é¢˜ï¼Œä½†å…è®¸ç»§ç»­å¯åŠ¨")/g' backend/app/main.py

# é‡å¯æœåŠ¡
bash stop.sh && bash start_all.sh
```

**éªŒè¯ä¿®å¤**ï¼š
```bash
# å¯åŠ¨ååº”è¯¥çœ‹åˆ°è­¦å‘Šä½†ä¸é˜»æ­¢å¯åŠ¨
tail -100 logs/backend.log | grep -E "æ¿å—æ•°æ®|å…¨é‡å†…å­˜ç¼“å­˜|åº”ç”¨å¯åŠ¨å®Œæˆ"
```

**é•¿æœŸä¿®å¤**ï¼š
```bash
# å°†ä¿®å¤æäº¤åˆ°v0.2.5
git add backend/app/main.py
git commit -m "fix: æ”¾å®½å¯åŠ¨æ£€æŸ¥ï¼Œæ•°æ®é‡å¤æ—¶å…è®¸å¯åŠ¨"
git tag v0.2.5
```

**å®é™…è§£å†³æ–¹æ¡ˆ**ï¼ˆ2025-11-08ï¼‰ï¼š
```
âœ… é—®é¢˜æ ¹æºï¼šSQLAlchemy 2.xç‰ˆæœ¬å…¼å®¹æ€§
âœ… database.py.example å·²åŒ…å«æ­£ç¡®çš„ text() ç”¨æ³•
âœ… æœåŠ¡å™¨ç«¯ï¼šåˆ åº“é‡æ¥ï¼Œå…¨æ–°å¯¼å…¥æ•°æ®
âœ… ç»“æœï¼šv0.2.4æˆåŠŸéƒ¨ç½²ï¼Œæ‰€æœ‰åŠŸèƒ½æ­£å¸¸
```

---

## ğŸš€ å®Œæ•´éƒ¨ç½²æµç¨‹ï¼ˆ2025-11-07 éªŒè¯é€šè¿‡ï¼‰

### æœ¬åœ°å‡†å¤‡

```bash
# 1. ä¿®æ”¹APIé…ç½®ä¸ºç›¸å¯¹è·¯å¾„
nano frontend/src/constants/config.js
# ç¡®ä¿: export const API_BASE_URL = '';

# 2. é‡æ–°ç¼–è¯‘å‰ç«¯
cd frontend
rm -rf build
npm run build
cd ..

# 3. éªŒè¯buildæ–‡ä»¶
ls frontend/build/  # åº”è¯¥çœ‹åˆ° index.html, static/ ç­‰

# 4. æäº¤æ¨é€
git add .
git commit -m "build: æ›´æ–°å‰ç«¯ç¼–è¯‘æ–‡ä»¶"
git push origin main
```

### æœåŠ¡å™¨éƒ¨ç½²ï¼ˆé¦–æ¬¡ï¼‰

```bash
# 1. å…‹éš†æˆ–æ‹‰å–ä»£ç 
cd ~/DA/Analysis_A
git pull origin main

# 2. åˆ›å»ºæ•°æ®åº“é…ç½®ï¼ˆä¸€æ¬¡æ€§å‘½ä»¤ï¼‰
cat > backend/app/database.py << 'DBEOF'
import os
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
import logging

logger = logging.getLogger(__name__)

# æ•°æ®åº“é…ç½® - ä¿®æ”¹ä¸ºå®é™…å€¼
DB_HOST = "localhost"
DB_PORT = "5432"
DB_NAME = "db_20251106_analysis_a"
DB_USER = "postgres"
DB_PASSWORD = "your_password_here"

DATABASE_URL = f"postgresql://{DB_USER}:{DB_PASSWORD}@{DB_HOST}:{DB_PORT}/{DB_NAME}"
engine = create_engine(DATABASE_URL, pool_size=10, max_overflow=20, pool_pre_ping=True, echo=False)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

def test_connection():
    try:
        from sqlalchemy import text
        with engine.connect() as conn:
            conn.execute(text("SELECT 1"))
        logger.info(f"æ•°æ®åº“è¿æ¥æˆåŠŸ: {DB_HOST}:{DB_PORT}/{DB_NAME}")
        return True
    except Exception as e:
        logger.error(f"æ•°æ®åº“è¿æ¥å¤±è´¥: {str(e)}")
        return False
DBEOF

# 3. é…ç½®Nginxï¼ˆä¸€æ¬¡æ€§å‘½ä»¤ï¼‰
sudo tee /etc/nginx/sites-available/stock_analysis > /dev/null << 'NGINX_EOF'
server {
    listen 80;
    server_name your_server_ip;

    location / {
        root /root/DA/Analysis_A/frontend/build;
        index index.html;
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }
}
NGINX_EOF

# 4. åˆ é™¤æ—§é…ç½®ï¼ˆå¦‚æœæœ‰ï¼‰
sudo rm /etc/nginx/sites-enabled/stock-analysis 2>/dev/null
sudo rm /etc/nginx/sites-enabled/default 2>/dev/null

# 5. å¯ç”¨æ–°é…ç½®
sudo ln -sf /etc/nginx/sites-available/stock_analysis /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx

# 6. å¯åŠ¨æœåŠ¡
bash start_all.sh

# 7. éªŒè¯
curl http://localhost:8000/api/dates
curl http://localhost/api/dates
```

### åç»­æ›´æ–°

```bash
# æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd ~/DA/Analysis_A
bash stop.sh
git pull origin main
bash start_all.sh
```

---

## ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### âœ… éƒ¨ç½²å‰ï¼ˆæœ¬åœ°ï¼‰

- [ ] ä¿®æ”¹ `frontend/src/constants/config.js` ä¸ºç›¸å¯¹è·¯å¾„
- [ ] æ‰§è¡Œ `npm run build` ç¼–è¯‘å‰ç«¯
- [ ] æ£€æŸ¥ `frontend/build/` ç›®å½•å­˜åœ¨ä¸”æ–‡ä»¶å®Œæ•´
- [ ] æ‰§è¡Œ `git status` ç¡®ä¿æ²¡æœ‰é…ç½®æ–‡ä»¶
- [ ] ç¡®è®¤ `backend/app/database.py` ä¸åœ¨æäº¤åˆ—è¡¨ä¸­
- [ ] æäº¤å¹¶æ¨é€ä»£ç 

### âœ… éƒ¨ç½²ä¸­ï¼ˆæœåŠ¡å™¨ï¼‰

- [ ] å¤‡ä»½æ•°æ®åº“é…ç½®ï¼š`cp backend/app/database.py ~/database.py.backup`
- [ ] æ‹‰å–æœ€æ–°ä»£ç ï¼š`git pull`
- [ ] æ¢å¤é…ç½®ï¼ˆå¦‚éœ€è¦ï¼‰ï¼š`cp ~/database.py.backup backend/app/database.py`
- [ ] æ£€æŸ¥Nginxé…ç½®æ— å†²çªï¼š`sudo nginx -t`
- [ ] æ¸…é™¤Pythonç¼“å­˜ï¼š`find backend -name __pycache__ -delete`
- [ ] å¯åŠ¨æœåŠ¡ï¼š`bash start_all.sh`

### âœ… éƒ¨ç½²åï¼ˆéªŒè¯ï¼‰

- [ ] æ£€æŸ¥åç«¯è¿è¡Œï¼š`ps aux | grep uvicorn`
- [ ] æµ‹è¯•åç«¯APIï¼š`curl http://localhost:8000/api/dates`
- [ ] æµ‹è¯•Nginxä»£ç†ï¼š`curl http://localhost/api/dates`
- [ ] æµè§ˆå™¨è®¿é—®å‰ç«¯
- [ ] æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆCtrl+Shift+Deleteï¼‰
- [ ] æµ‹è¯•æ‰€æœ‰åŠŸèƒ½æ¨¡å—
- [ ] æ£€æŸ¥æ—¥å¿—æ— é”™è¯¯ï¼š`tail -f logs/backend.log`

---

**è®°ä½ï¼šé…ç½®æ–‡ä»¶å®‰å…¨ > ä¸€åˆ‡ï¼**

æ¯æ¬¡éƒ¨ç½²å‰ï¼ŒåŠ¡å¿…æ£€æŸ¥ï¼š
1. `.gitignore` æ˜¯å¦æ­£ç¡®
2. `git status` æ²¡æœ‰é…ç½®æ–‡ä»¶
3. æœåŠ¡å™¨é…ç½®å·²å¤‡ä»½
4. å‰ç«¯ä½¿ç”¨ç›¸å¯¹è·¯å¾„APIé…ç½®
5. Nginxé…ç½®æ— å†²çª
