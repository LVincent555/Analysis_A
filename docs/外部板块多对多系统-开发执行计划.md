# 外部板块多对多系统 - 开发执行计划

**创建时间**: 2025-12-11  
**关联设计文档**: [外部板块多对多分析系统-设计文档.md](./外部板块多对多分析系统-设计文档.md)  
**状态**: ✅ 基本完成

---

## 任务总览

| # | 任务 | 状态 | 预计 | 实际 |
|---|------|------|------|------|
| 1 | 确认现有数据库表结构 | ✅ 完成 | 10min | 5min |
| 2 | 创建 `ext_board_heat_daily` 表 + 配置项 | ✅ 完成 | 15min | 10min |
| 3 | 编写 ETL 脚本 `task_board_heat.py`（含稀疏快照寻址） | ✅ 完成 | 60min | 25min |
| 4 | 后端：板块热度 API | ✅ 完成 | 45min | 15min |
| 5 | 前端：信号配置切换按钮 | ✅ 完成 | 30min | 10min |
| 6 | 前端：BoardSignalBadge 组件 | ✅ 完成 | 30min | 10min |
| 7 | 集成测试 | 🔄 待验证 | 30min | - |

---

## 任务 1: 确认现有数据库表结构

**目标**: 确认 `ext_board_list` / `ext_board_daily_snap` 的实际字段，确保后续开发基于正确的结构。

**检查项**:
- [x] `ext_board_list` 表字段（id, board_code, board_name, board_type 等）
- [x] `ext_board_daily_snap` 表字段（board_id 还是 board_code？）
- [x] `daily_stock_data` 表字段（total_score, rank 是否存在）

**执行记录**:
```
✅ ext_board_list: id(bigint), provider_id, board_code, board_name, board_type, stock_count, is_active, created_at, updated_at
✅ ext_board_daily_snap: stock_code, board_id(bigint), date, board_rank, weight → 使用 board_id 关联
✅ daily_stock_data: stock_code, date, rank(int), total_score(numeric) → 字段存在
❌ ext_board_heat_daily: 不存在，需要创建
```

**状态**: ✅ 完成

---

## 任务 2: 创建 ext_board_heat_daily 表

**目标**: 创建板块热度聚合结果表。

**SQL**:
```sql
CREATE TABLE IF NOT EXISTS ext_board_heat_daily (
    trade_date  DATE,
    board_id    INT,                   -- 关联 ext_board_list.id
    
    stock_count INT,                   -- 当日成分股数量
    
    -- B/C 系聚合指标
    b1_rank_sum    DECIMAL(20,8),
    b2_rank_avg    DECIMAL(20,8),
    c1_score_sum   DECIMAL(20,8),
    c2_score_avg   DECIMAL(20,8),
    
    -- 综合热度
    heat_raw       DECIMAL(20,8),
    heat_pct       DECIMAL(10,8),      -- [0,1] 分位值
    
    -- 预留字段
    needle_density DECIMAL(10,4),
    avg_volume     DECIMAL(10,2),

    PRIMARY KEY (trade_date, board_id)
);
CREATE INDEX IF NOT EXISTS idx_ext_heat_date ON ext_board_heat_daily(trade_date);
```

**执行记录**:
```
待填写...
```

**状态**: ⬜ 待开始

---

## 任务 3: 编写 ETL 脚本 task_board_heat.py

**目标**: 计算每日板块热度，写入 `ext_board_heat_daily` 表。

**核心逻辑**:
1. 加载当日 `ext_board_daily_snap` + `daily_stock_data`
2. 计算分摊权重 `share_ij`（热度守恒）
3. 聚合 B1/B2/C1/C2
4. 计算综合热度 `heat_raw` → `heat_pct`
5. 写入结果表

**文件路径**: `backend/scripts/task_board_heat.py`

**依赖配置项**（从 system_configs 读取）:
- `board_w_industry` = 1.0
- `board_w_concept` = 0.7
- `board_w_region` = 0.5
- `board_heat_alpha` = 0.4 (B1权重)
- `board_heat_beta` = 0.2 (B2权重)
- `board_heat_gamma` = 0.3 (C2权重)
- `board_heat_delta` = 0.1 (本地板块权重)

**执行记录**:
```
待填写...
```

**状态**: ⬜ 待开始

---

## 任务 4: 添加系统配置项

**目标**: 在 `system_configs` 表中注册板块相关配置项。

**配置清单** (category = 'board'):

| config_key | default | description |
|------------|---------|-------------|
| board_w_industry | 1.0 | 类型权重：行业 |
| board_w_concept | 0.7 | 类型权重：概念 |
| board_w_region | 0.5 | 类型权重：地域 |
| board_safe_pct | 0.3 | 防守线：行业分位 |
| board_hot_pct | 0.8 | 进攻线：板块分位 |
| board_w_stock | 1.0 | 合成权重：个股自身分 |
| board_w_exposure | 0.7 | 合成权重：板块共振 |
| board_w_max_concept | 0.5 | 合成权重：最强驱动 |
| board_penalty_unsafe | 0.5 | 行业不安全惩罚系数 |
| board_signal_S_pct | 0.97 | S级信号阈值 |
| board_signal_A_pct | 0.90 | A级信号阈值 |
| board_signal_B_pct | 0.80 | B级信号阈值 |

**执行记录**:
```
待填写...
```

**状态**: ⬜ 待开始

---

## 任务 5: 后端 - 板块热度 API

**目标**: 提供板块热度查询接口。

**新增路由文件**: `backend/app/routers/board_heat.py`

**API 清单**:

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/board-heat/ranking` | 获取板块热度榜单 |
| GET | `/api/board-heat/stock/{code}` | 获取个股的板块信号 |
| GET | `/api/board-heat/board/{id}` | 获取板块详情（成分股等） |

**返回示例** (`/api/board-heat/stock/{code}`):
```json
{
  "stock_code": "000001",
  "board_signal_level": "S",
  "board_signal_label": "数字货币",
  "max_concept_board_type": "concept",
  "max_concept_heat_pct": 0.96,
  "industry_safe": true,
  "exposure_pct": 0.87,
  "related_boards": [...]
}
```

**执行记录**:
```
待填写...
```

**状态**: ⬜ 待开始

---

## 任务 6: 前端 - 信号配置切换按钮

**目标**: 在信号配置面板中添加「板块数据源」切换（原版 / 外部板块）。

**修改文件**: `frontend-client/src/components/SignalConfigPanel.js` (或相关文件)

**UI 设计**:
```
┌─────────────────────────────────┐
│ 📊 板块数据源                    │
│ ┌─────────────────────────────┐ │
│ │ ○ DC原版（87行业，一对一）   │ │
│ │ ● 东财板块（527，多对多）🆕 │ │
│ └─────────────────────────────┘ │
└─────────────────────────────────┘
```

**实现要点**:
- [ ] 添加 `boardDataSource` 状态（'dc' | 'eastmoney'）
- [ ] 切换时更新 SignalConfigContext
- [ ] 后端 API 调用时传递 `board_source` 参数

**执行记录**:
```
待填写...
```

**状态**: ⬜ 待开始

---

## 任务 7: 前端 - BoardSignalBadge 组件

**目标**: 创建 `[S级｜锂电池]` 样式的板块信号标签组件。

**新增文件**: `frontend-client/src/components/BoardSignalBadge.js`

**组件接口**:
```tsx
interface BoardSignalBadgeProps {
  level: 'S' | 'A' | 'B' | 'NONE';
  label: string;
  type?: 'industry' | 'concept';
  heatPct?: number;
  onClick?: () => void;
}
```

**样式**:
- S级：橙→粉渐变，白字
- A级：蓝紫→粉渐变，白字
- B级：灰色半透明，浅色字
- NONE：不渲染

**使用位置**:
- [ ] 股票查询页列表
- [ ] 行业详情弹窗
- [ ] 板块详情页

**执行记录**:
```
待填写...
```

**状态**: ⬜ 待开始

---

## 任务 8: 集成测试

**目标**: 验证完整流程。

**测试用例**:
- [ ] ETL 脚本正常运行，数据写入 heat 表
- [ ] API 返回正确的板块热度数据
- [ ] 前端切换数据源生效
- [ ] BoardSignalBadge 正常显示
- [ ] 点击 Badge 跳转板块详情

**执行记录**:
```
待填写...
```

**状态**: ⬜ 待开始

---

## 📝 执行日志

### 2025-12-11

| 时间 | 操作 | 结果 |
|------|------|------|
| - | 开始执行 | - |

---

## ⚠️ 风险与注意事项

1. **原版功能保留**: 所有修改必须保留原版切换能力，不破坏现有功能
2. **数据库兼容**: 使用 `board_id` (INT) 作为关联字段，非 `board_code`
3. **性能考虑**: snap 表数据量大，JOIN 时注意索引
4. **配置热加载**: 配置项修改后应能即时生效（清缓存）

---

**文档更新**: 每完成一个任务，更新状态和执行记录
