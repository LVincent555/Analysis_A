# 外部板块数据扩展模块设计文档

> 版本: v1.0.0  
> 日期: 2025-12-10  
> 状态: 设计完成，待实现

---

## 1. 背景 (Background)

目前系统中已有两条独立数据链：

### A. 股票数据链（来自每日 Excel 导入）
- `stocks` - 股票主表
- `daily_stock_data` - 每日技术指标（约 5,000 条/天）

### B. 东财板块数据链（来自每日 Excel 导入）
- `sectors` - 板块主表
- `daily_sector_data` - 每日板块指标（约 500 条/天）

**两条链互相独立、无关联关系。**

---

## 2. 问题 (Problem Statement)

当前系统存在以下问题：

| # | 问题 | 影响 |
|---|------|------|
| 1 | Excel 导入的东财板块数据可能不完整/不准确 | 无法保证 sectors 板块列表是全量 |
| 2 | 无法使用同花顺(THS)板块做分析 | THS 没有对应的 Excel 来源 |
| 3 | 无法知道"历史上某一天某股票属于哪些板块" | 缺少历史板块关系 |
| 4 | 不希望对原有 Excel 表做结构变更 | 需要"无侵入式"设计 |

---

## 3. 目标 (Goals)

### Goal 1 — 引入真实世界的板块数据（东财 + 同花顺）
从 AKShare 获取：
- 板块列表（行业 / 概念）
- 板块真实成分股（每日刷新）
- 来源：东财（EM）、同花顺（THS）

### Goal 2 — 为每个交易日构建"股票-板块"的历史快照
例如：
> 2025-01-10，股票 000001 属于：银行、电商金融、国企改革

保存下来供回测与统计使用。

### Goal 3 — 允许系统继续稳定使用现有 Excel 导入的板块数据
- 不修改 `sectors` / `daily_sector_data`
- 不改变旧逻辑
- 新数据链作为独立扩展模块

### Goal 4 — 能够使用 Excel 板块指标去分析"真实板块成分"
例如：
> "用 Excel 导入的板块强度指标，去分析 EM 的真实股票构成"

---

## 4. 解决方案概述 (Solution Overview)

整个方案新增一套独立的数据仓库（**ext 模块**），用于存储真实板块数据。

### 4.1 架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           数据层架构                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Excel 数据世界 (现有)                          │   │
│  │  ┌──────────────┐              ┌──────────────────┐              │   │
│  │  │   stocks     │              │    sectors       │              │   │
│  │  │ (股票主表)   │              │  (板块主表)      │              │   │
│  │  └──────┬───────┘              └────────┬─────────┘              │   │
│  │         │                               │                        │   │
│  │         ▼                               ▼                        │   │
│  │  ┌──────────────────┐          ┌──────────────────┐              │   │
│  │  │ daily_stock_data │          │ daily_sector_data│              │   │
│  │  │ (每日股票指标)   │          │ (每日板块指标)   │              │   │
│  │  └──────────────────┘          └──────────────────┘              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                          ▲                    ▲                         │
│                          │                    │                         │
│                    外键关联              桥接映射                        │
│                          │                    │                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   真实板块世界 (新增 ext 模块)                     │   │
│  │                                                                  │   │
│  │  ┌────────────────┐                                              │   │
│  │  │ ext_providers  │◄────── 数据源: EM / THS / Wind              │   │
│  │  └───────┬────────┘                                              │   │
│  │          │                                                       │   │
│  │          ▼                                                       │   │
│  │  ┌────────────────┐         ┌─────────────────────┐              │   │
│  │  │ ext_board_list │────────►│ ext_board_local_map │──► sectors   │   │
│  │  │ (真实板块列表) │         │   (桥接映射表)       │              │   │
│  │  └───────┬────────┘         └─────────────────────┘              │   │
│  │          │                                                       │   │
│  │          ▼                                                       │   │
│  │  ┌─────────────────────┐                                         │   │
│  │  │ ext_board_daily_snap│◄────── 每日快照: 股票-板块关系          │   │
│  │  │   (核心大表)        │        (2-3万条/天)                     │   │
│  │  └─────────────────────┘                                         │   │
│  │          │                                                       │   │
│  │          ▼                                                       │   │
│  │      stocks.stock_code ◄────── 外键关联                          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 新增表清单

| 表名 | 用途 | 数据量 |
|------|------|--------|
| `ext_providers` | 数据源字典 | 2-5 条 |
| `ext_board_list` | 真实板块列表 | 1000-2000 条 |
| `ext_board_daily_snap` | 股票-板块每日快照 | 2-3 万条/天 |
| `ext_board_local_map` | 外部板块 ↔ Excel 板块映射 | 300-500 条 |

---

## 5. 数据库设计详解

### 5.1 ext_providers - 数据源表

```sql
CREATE TABLE IF NOT EXISTS ext_providers (
    id SERIAL PRIMARY KEY,
    code VARCHAR(20) NOT NULL UNIQUE,       -- 'em', 'ths'
    name VARCHAR(50) NOT NULL,              -- '东方财富', '同花顺'
    description TEXT,
    api_source VARCHAR(100),                -- 'akshare', 'crawler'
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**设计要点**:
- `code` 唯一，用于查询条件 `WHERE code='em'`
- 可扩展，未来加入 Wind / 聚宽只需 INSERT

### 5.2 ext_board_list - 外部板块主表

```sql
CREATE TABLE IF NOT EXISTS ext_board_list (
    id BIGSERIAL PRIMARY KEY,
    provider_id INT NOT NULL REFERENCES ext_providers(id),
    board_code VARCHAR(50) NOT NULL,        -- 'BK0425'
    board_name VARCHAR(200) NOT NULL,       -- '半导体'
    board_type VARCHAR(50),                 -- 'industry', 'concept', 'region'
    stock_count INT DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT uq_ext_board_source_code UNIQUE (provider_id, board_code)
);
```

**设计要点**:
- `provider_id + board_code` 唯一约束，适合 UPSERT
- `board_type` 区分行业/概念/地域板块
- `updated_at` 检测僵尸板块

### 5.3 ext_board_daily_snap - 每日快照表（核心）

```sql
CREATE TABLE IF NOT EXISTS ext_board_daily_snap (
    stock_code VARCHAR(10) NOT NULL REFERENCES stocks(stock_code) ON DELETE CASCADE,
    board_id BIGINT NOT NULL REFERENCES ext_board_list(id) ON DELETE CASCADE,
    date DATE NOT NULL,
    board_rank INTEGER,                     -- 板块内排名（可选）
    weight DECIMAL(10, 6),                  -- 权重（可选）
    PRIMARY KEY (stock_code, board_id, date)
);
```

**设计要点**:
- 三元组主键保证幂等性
- 外键关联 `stocks` 表确保数据一致性
- `board_rank` / `weight` 预留扩展位

**关键索引**:
```sql
-- 查询某板块某天的成分股
CREATE INDEX idx_ext_daily_query ON ext_board_daily_snap (board_id, date);

-- 查询某股票的历史板块归属
CREATE INDEX idx_ext_daily_stock_history ON ext_board_daily_snap (stock_code, date);
```

### 5.4 ext_board_local_map - 桥接映射表

```sql
CREATE TABLE IF NOT EXISTS ext_board_local_map (
    ext_board_id BIGINT NOT NULL REFERENCES ext_board_list(id) ON DELETE CASCADE,
    local_sector_id BIGINT NOT NULL REFERENCES sectors(id) ON DELETE CASCADE,
    match_type VARCHAR(20) DEFAULT 'auto',  -- 'auto', 'manual', 'fuzzy'
    confidence DECIMAL(5, 2),               -- 匹配置信度
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (ext_board_id, local_sector_id)
);
```

**设计要点**:
- 不修改 `sectors` 表结构
- `match_type` 区分自动/人工/模糊匹配
- THS 板块没有对应 sectors 是正常的

---

## 6. 设计原则 (Design Principles)

| 原则 | 说明 |
|------|------|
| **无侵入性** | 不对 stocks、daily_stock_data、sectors、daily_sector_data 做任何结构修改 |
| **历史可追溯** | 所有股票-板块关系按日期全量快照记录 |
| **可扩展** | 新数据源（Wind、聚宽）未来可轻松加入 |
| **幂等性** | ETL 流程可重复执行，不产生重复数据 |
| **最终一致性** | 每日 ETL 保证当天所有数据同步更新、对齐 |

---

## 7. 每日数据同步流程 (Daily ETL Flow)

```
┌─────────────────────────────────────────────────────────────────┐
│                     每日 ETL 执行顺序                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Step 1: 导入股票 Excel                                          │
│          └─► 更新 stocks / daily_stock_data                     │
│                                                                 │
│  Step 2: 导入东财板块 Excel                                       │
│          └─► 更新 sectors / daily_sector_data                   │
│                                                                 │
│  Step 3: 从 AKShare 获取板块列表                                  │
│          ├─► EM 行业/概念板块 → UPSERT ext_board_list            │
│          └─► THS 概念板块 → UPSERT ext_board_list               │
│                                                                 │
│  Step 4: 从 AKShare 获取板块成分股                                │
│          └─► 写入 ext_board_daily_snap (date = 当天)            │
│                                                                 │
│  Step 5: 自动映射 EM 板块 ↔ Excel 板块                            │
│          └─► INSERT ext_board_local_map (match_type='auto')     │
│                                                                 │
│  Step 6: 人工补全无法自动对应的项目                                │
│          └─► UPDATE ext_board_local_map (match_type='manual')   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### ETL 策略

**方式 A: DELETE + INSERT（推荐）**
```sql
DELETE FROM ext_board_daily_snap WHERE date = :target_date;
-- 然后 INSERT 今天所有记录
```

**方式 B: UPSERT**
```sql
INSERT INTO ext_board_daily_snap (stock_code, board_id, date, board_rank)
VALUES (...)
ON CONFLICT (stock_code, board_id, date) 
DO UPDATE SET board_rank = EXCLUDED.board_rank;
```

> ⚠️ **警告**: 千万别 TRUNCATE 整表，否则历史数据会丢失！

---

## 8. 核心查询示例

### 8.1 查询某板块某天的成分股及技术指标

```sql
SELECT 
    s.stock_code,
    s.stock_name,
    d.close_price,
    d.price_change,
    d.total_score,
    d.rank
FROM ext_board_daily_snap snap
JOIN ext_board_list b ON b.id = snap.board_id
JOIN stocks s ON s.stock_code = snap.stock_code
JOIN daily_stock_data d ON d.stock_code = snap.stock_code AND d.date = snap.date
WHERE b.board_name = '人工智能'
  AND snap.date = '2025-01-10'
ORDER BY d.rank;
```

### 8.2 查询某股票历史所属板块

```sql
SELECT 
    snap.date,
    b.board_name,
    b.board_type,
    p.name AS provider
FROM ext_board_daily_snap snap
JOIN ext_board_list b ON b.id = snap.board_id
JOIN ext_providers p ON p.id = b.provider_id
WHERE snap.stock_code = '000001'
ORDER BY snap.date DESC, b.board_name;
```

### 8.3 自动生成板块映射

```sql
INSERT INTO ext_board_local_map (ext_board_id, local_sector_id, match_type, confidence)
SELECT b.id, s.id, 'auto', 100.00
FROM ext_board_list b
JOIN ext_providers p ON p.id = b.provider_id AND p.code = 'em'
JOIN sectors s ON s.sector_name = b.board_name
ON CONFLICT DO NOTHING;
```

### 8.4 使用 Excel 板块指标分析真实成分

```sql
-- 找出"人工智能"板块中，按 Excel 板块评分排名前 10 的股票
SELECT 
    s.stock_code,
    s.stock_name,
    dsd.total_score,
    dsd.rank AS excel_rank,
    snap.board_rank AS board_rank
FROM ext_board_daily_snap snap
JOIN ext_board_list b ON b.id = snap.board_id
JOIN stocks s ON s.stock_code = snap.stock_code
JOIN daily_stock_data dsd ON dsd.stock_code = snap.stock_code AND dsd.date = snap.date
WHERE b.board_name = '人工智能'
  AND snap.date = '2025-01-10'
ORDER BY dsd.total_score DESC
LIMIT 10;
```

---

## 9. 功能效果 (What This Enables)

| 能力 | 说明 |
|------|------|
| ✅ 使用同花顺板块做完整分析 | 即使没有同花顺的 Excel 数据 |
| ✅ 分析真实的板块成分 | 而不是 Excel 中可能缺失的版本 |
| ✅ 板块历史回溯 | 查询 2024-03-15 低空经济板块的成分股 |
| ✅ 混合分析体系 | Excel 板块评分 + 真实成分构成 |
| ✅ 审计 Excel 板块 | 对比发现 Excel 板块列表的缺漏 |

---

## 10. 系统集成设计 (System Integration)

### 10.1 集成原则

**与现有 Excel 导入系统保持一致的架构设计：**

| 特性 | Excel 导入 | 外部板块同步 |
|------|-----------|--------------|
| 状态文件 | `data/data_import_state.json` | `data/ext_board_sync_state.json` |
| 状态管理 | `ImportStateManager` | 复用 `ImportStateManager` |
| 触发方式 | 管理员点击导入 | ① 自动触发 ② 单独按钮 |
| 幂等检查 | 按日期 + 文件 Hash | 按日期检查 |
| 后台执行 | threading | threading（异步） |

### 10.1.1 触发方式决策

| 触发方式 | 说明 |
|----------|------|
| **自动触发** | 导入 Excel 完成后，自动同步今天的外部板块数据 |
| **单独按钮** | 前端提供独立的"同步外部板块"按钮，可手动触发 |
| **历史补录** | 提供单独的"补录历史"功能，指定日期范围同步 |

### 10.1.2 同步范围决策

| 场景 | 同步范围 |
|------|----------|
| 正常导入（自动/手动） | 只同步今天 |
| 历史补录（单独按钮） | 指定日期范围 |

### 10.2 状态文件设计

```json
// data/ext_board_sync_state.json
{
  "version": "1.0",
  "created_at": "2025-12-10T14:00:00",
  "last_updated": "2025-12-10T15:30:00",
  "syncs": {
    "2025-12-10": {
      "status": "success",           // pending, in_progress, success, failed
      "start_time": "2025-12-10T09:00:00",
      "end_time": "2025-12-10T09:15:00",
      "duration_seconds": 900,
      "providers": {
        "em": {
          "board_count": 450,        // 板块数
          "cons_count": 28000,       // 成分股关系数
          "status": "success"
        },
        "ths": {
          "board_count": 380,
          "cons_count": 22000,
          "status": "success"
        }
      },
      "error": null
    }
  },
  "config": {
    "auto_sync_on_import": false,    // ⚠️ 不自动同步（需要代理IP，有成本）
    "sync_providers": ["em", "ths"], // 启用的数据源
    "skip_cons_if_slow": false,      // 慢时跳过成分股
    "proxy_enabled": true,           // 是否启用代理
    "proxy_trade_no": "B200987778609", // 91HTTP 业务编号
    "proxy_secret": "****"           // 91HTTP 密钥（脱敏）
  }
}
```

### 10.3 幂等性设计

```
┌────────────────────────────────────────────────────────────┐
│                    每日同步幂等检查                          │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  管理员点击"导入数据"                                        │
│       │                                                    │
│       ▼                                                    │
│  ┌──────────────────┐                                      │
│  │ 检查 ext_board_  │                                      │
│  │ sync_state.json  │                                      │
│  └────────┬─────────┘                                      │
│           │                                                │
│           ▼                                                │
│  ┌──────────────────────────────────────────┐              │
│  │ 今天已同步成功?                            │              │
│  │ syncs[today].status == "success"         │              │
│  └────────┬──────────────────┬──────────────┘              │
│           │                  │                             │
│       YES ▼              NO  ▼                             │
│  ┌────────────┐    ┌─────────────────┐                     │
│  │ 跳过同步    │    │ 执行 AKShare    │                     │
│  │ 记录日志    │    │ 板块数据同步    │                     │
│  └────────────┘    └─────────────────┘                     │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

**幂等规则：**
- 同一天只同步一次（除非手动强制）
- 板块列表：UPSERT（可重复执行）
- 成分股快照：DELETE + INSERT 当天数据（保证干净）

### 10.4 独立触发设计（不自动集成）

> ⚠️ **重要说明**: 外部板块同步**不与 Excel 导入流程集成**，原因：
> 1. 需要使用代理 IP 池（91HTTP），有额外成本
> 2. 同步耗时较长（15-30 分钟），影响导入体验
> 3. 管理员可根据需要手动触发，更灵活

```
独立的外部板块同步流程:
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  Excel 导入流程（现有，不变）                              │
│  ┌─────────────────────────────────────────────────┐   │
│  │  _do_import_task()                              │   │
│  │  ├── Step 1: 扫描 data 目录                      │   │
│  │  ├── Step 2: 导入股票 Excel                      │   │
│  │  ├── Step 3: 导入板块 Excel                      │   │
│  │  ├── Step 4: 重载内存缓存                        │   │
│  │  └── 完成                                        │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  外部板块同步（独立模块，手动触发）                        │
│  ┌─────────────────────────────────────────────────┐   │
│  │  管理员点击"同步外部板块" 或 调用 API             │   │
│  │  ├── Step 1: 检查幂等（今天已同步则跳过）         │   │
│  │  ├── Step 2: 获取代理 IP（91HTTP）               │   │
│  │  ├── Step 3: 同步东财板块列表 + 成分股            │   │
│  │  ├── Step 4: 同步同花顺板块列表 + 成分股          │   │
│  │  ├── Step 5: 自动映射到本地 sectors              │   │
│  │  ├── Step 6: 更新状态文件                        │   │
│  │  └── 完成                                        │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**触发方式：**
1. **管理员界面按钮** - 在"系统管理 > 外部板块同步"页面手动触发
2. **API 调用** - `POST /api/admin/ext-boards/sync`
3. **命令行** - `python backend/scripts/sync_ext_boards.py --proxy`

### 10.5 同步脚本设计

```python
# backend/scripts/sync_ext_boards.py

class ExtBoardSyncer:
    """外部板块同步器"""
    
    def __init__(self, state_file="ext_board_sync_state.json"):
        self.state_manager = ExtBoardStateManager(state_file)
        self.db = ...
    
    def should_sync_today(self) -> bool:
        """检查今天是否需要同步（幂等判断）"""
        today = date.today().isoformat()
        sync_info = self.state_manager.get_sync_info(today)
        return sync_info is None or sync_info.get("status") != "success"
    
    def sync_all(self, target_date: date, progress_callback=None):
        """
        同步所有数据源
        
        Args:
            target_date: 目标日期
            progress_callback: 进度回调 fn(message, progress_pct)
        """
        if not self.should_sync_today():
            return {"skipped": True, "reason": "今天已同步"}
        
        self.state_manager.start_sync(target_date)
        
        try:
            # 同步东财
            em_result = self.sync_em_boards(target_date, progress_callback)
            
            # 同步同花顺
            ths_result = self.sync_ths_boards(target_date, progress_callback)
            
            # 更新统计
            self.update_board_stock_count()
            
            # 自动映射
            self.auto_map_local_sectors()
            
            self.state_manager.mark_success(target_date, em_result, ths_result)
            return {"success": True, "em": em_result, "ths": ths_result}
            
        except Exception as e:
            self.state_manager.mark_failed(target_date, str(e))
            raise
```

### 10.6 AKShare API 接口

| 功能 | AKShare 函数 | 返回 |
|------|-------------|------|
| 东财行业板块列表 | `ak.stock_board_industry_name_em()` | DataFrame |
| 东财概念板块列表 | `ak.stock_board_concept_name_em()` | DataFrame |
| 东财行业成分股 | `ak.stock_board_industry_cons_em(symbol="xxx")` | DataFrame |
| 东财概念成分股 | `ak.stock_board_concept_cons_em(symbol="xxx")` | DataFrame |
| 同花顺概念板块 | `ak.stock_board_concept_name_ths()` | DataFrame |
| 同花顺概念成分股 | `ak.stock_board_concept_cons_ths(symbol="xxx")` | DataFrame |

### 10.7 性能与限制

| 项目 | 预估 |
|------|------|
| 东财板块数 | ~450 个（行业+概念） |
| 同花顺板块数 | ~380 个（概念） |
| 每板块成分股 | 平均 50-100 只 |
| 每日成分股关系 | 2-5 万条 |
| 同步耗时 | 10-30 分钟（取决于网络） |
| API 请求间隔 | 100-200ms（避免封禁） |

### 10.8 错误处理策略

| 场景 | 处理方式 |
|------|----------|
| AKShare 请求失败 | 重试3次，记录失败板块，继续下一个 |
| 部分板块失败 | 标记 partial_success，记录失败列表 |
| 股票代码不存在 | 跳过（可能是新股未导入） |
| 网络超时 | 增加间隔时间，降速继续 |
| 全部失败 | 标记 failed，保留上次成功数据 |

### 10.9 后端 API 设计

```
┌─────────────────────────────────────────────────────────────────────┐
│                        外部板块同步 API                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  POST /api/admin/ext-boards/sync                                    │
│  ├── 功能: 触发今日同步                                              │
│  ├── 参数: 无（自动使用今天日期）                                     │
│  └── 返回: { success, message, task_id }                            │
│                                                                     │
│  POST /api/admin/ext-boards/sync-history                            │
│  ├── 功能: 历史补录                                                  │
│  ├── 参数: { start_date, end_date }                                 │
│  └── 返回: { success, message, task_id }                            │
│                                                                     │
│  GET /api/admin/ext-boards/sync-status                              │
│  ├── 功能: 获取同步进度（轮询）                                       │
│  └── 返回: { is_syncing, progress, current_step, logs[] }          │
│                                                                     │
│  GET /api/admin/ext-boards/sync-history-list                        │
│  ├── 功能: 获取同步历史记录                                          │
│  └── 返回: { syncs: [{date, status, providers, duration}...] }      │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 10.10 前端界面设计

```
┌─────────────────────────────────────────────────────────────────────┐
│  数据管理 > 外部板块同步                                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 今日同步状态                                                  │   │
│  │ ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐   │   │
│  │ │ 🟢 已同步    │  │ 东财: 450板块 │  │ [同步今日] [补录历史] │   │   │
│  │ │ 2025-12-10  │  │ 同花顺: 380  │  │                     │   │   │
│  │ └─────────────┘  └─────────────┘  └─────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 同步进度 (异步执行中...)                        [75%] ████████░░│   │
│  │ 📋 正在同步: 东财概念板块成分股 (256/450)                      │   │
│  │ ├─ 09:00:15 开始同步东财板块列表...                           │   │
│  │ ├─ 09:00:18 东财行业板块: 95 个                               │   │
│  │ ├─ 09:00:22 东财概念板块: 355 个                              │   │
│  │ ├─ 09:00:25 开始同步成分股...                                 │   │
│  │ └─ 09:05:30 进度: 256/450 板块                                │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 同步历史                                                      │   │
│  │ ┌──────────┬────────┬────────┬────────┬─────────┬─────────┐ │   │
│  │ │ 日期     │ 状态   │ 东财   │ 同花顺 │ 耗时    │ 操作    │ │   │
│  │ ├──────────┼────────┼────────┼────────┼─────────┼─────────┤ │   │
│  │ │ 12-10    │ ✅成功 │ 450/28k│ 380/22k│ 15分钟  │ 详情    │ │   │
│  │ │ 12-09    │ ✅成功 │ 450/28k│ 380/22k│ 14分钟  │ 详情    │ │   │
│  │ │ 12-08    │ ⚠️部分 │ 450/28k│ 380/20k│ 18分钟  │ 重试    │ │   │
│  │ └──────────┴────────┴────────┴────────┴─────────┴─────────┘ │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

运维监控卡片（右侧）:
┌─────────────────────────────────────────────────────────┐
│ 📊 运维统计                                              │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────┐  ┌─────────────────┐               │
│  │ 代理 IP 使用     │  │ 本次同步成本     │               │
│  │ 🔄 12 个        │  │ 💰 约 ¥0.12     │               │
│  └─────────────────┘  └─────────────────┘               │
│                                                         │
│  ┌─────────────────┐  ┌─────────────────┐               │
│  │ 请求成功率       │  │ 股票匹配率       │               │
│  │ ✅ 98.5%        │  │ 📈 97.2%        │               │
│  └─────────────────┘  └─────────────────┘               │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 数据源状态                                       │   │
│  │ ├─ 东财: 527 板块, 28,456 成分股                 │   │
│  │ ├─ 同花顺: 374 板块, 22,134 成分股               │   │
│  │ └─ 自动映射: 527 条                              │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ⚠️ 提示: 每次同步约消耗 10-20 个代理 IP              │
│                                                         │
└─────────────────────────────────────────────────────────┘

补录历史弹窗:
┌─────────────────────────────────────┐
│ 补录历史数据                         │
├─────────────────────────────────────┤
│ 开始日期: [2025-12-01] 📅           │
│ 结束日期: [2025-12-09] 📅           │
│                                     │
│ ⚠️ 将同步 9 天数据，预计耗时 2-3 小时 │
│                                     │
│      [取消]        [开始补录]        │
└─────────────────────────────────────┘
```

---

## 11. 实现检查清单 (Implementation Checklist)

### Phase 1: 数据库准备 ✅
- [x] 确认 `pg_trgm` 扩展已启用
- [x] 执行 `sql/ext_boards.sql` 创建表结构
- [x] 验证表和索引创建成功

### Phase 2: Python ETL 开发
- [ ] 创建 `ExtBoardStateManager` 状态管理类
- [ ] 实现 `normalize_stock_code(raw)` 函数
- [ ] 实现 EM 板块列表同步（AKShare）
- [ ] 实现 EM 板块成分同步（AKShare）
- [ ] 实现 THS 板块列表同步（AKShare）
- [ ] 实现 THS 板块成分同步（AKShare）
- [ ] 支持进度回调 `progress_callback(msg, pct)`

### Phase 2.5: 首次爬取验证 ⬅️ 当前阶段
**目标**: 完成首次完整爬取，验证数据质量和性能

#### 验证清单
- [ ] 程序验证：脚本可独立运行，无报错
- [ ] JSON 验证：`ext_board_sync_state.json` 格式正确
- [ ] 数据对齐验证：
  - [ ] `ext_board_list` 板块数量符合预期
  - [ ] `ext_board_daily_snap` 成分股数量合理
  - [ ] 股票代码与 `stocks` 表匹配率 > 95%
- [ ] 幂等验证：重复执行不产生重复数据

#### 运维数据采集
| 指标 | 实测结果 | 备注 |
|------|----------|------|
| 东财板块列表耗时 | ~5 秒 | 行业86 + 概念441 = 527个 ✅ |
| 东财成分股耗时 | 待测 | 预估 15-30 分钟 (527×1.5s) |
| 同花顺板块列表耗时 | ~9 秒 | 概念374个 ✅ |
| 同花顺成分股耗时 | 待测 | 预估 10-20 分钟 (374×2s) |
| 总耗时 | 待完整测试 | - |
| API 请求成功率 | 待测 | 需避免限流 |
| 失败板块数 | 待测 | - |
| 最终成分股记录数 | 待测 | - |

#### 反爬虫优化（v1.3.0 新增）

由于东财接口存在限流机制，脚本已添加以下优化：

1. **User-Agent 伪装** - 模拟 Chrome 浏览器请求
2. **指数回退重试** - 失败后等待 2^n 秒 (2s → 4s → 8s)
3. **随机延迟抖动** - 每次请求增加 0~0.5 秒随机延迟
4. **可配置请求间隔** - `--delay` 参数（默认 1.5 秒，被封后建议 3-5 秒）
5. **tqdm 进度条** - 实时显示同步进度

**常见问题：**
- `RemoteDisconnected` 错误 = IP 被临时封禁
- 解决方案：等待 15-30 分钟、更换网络、使用服务器运行

#### 代理 IP 配置（v1.4.0 新增）

由于东财接口 IP 封禁严格，生产环境**必须使用代理 IP 池**。

**代理服务商**: 91HTTP (http://www.91http.com)

**配置参数**:
```
业务编号: B200987778609
密钥: ****（脱敏，存储在环境变量）
有效期: 1 分钟/IP
协议: HTTPS
白名单: 自动
```

**成本估算**:
| 同步类型 | 请求数 | 消耗 IP 数 | 约成本 |
|----------|--------|-----------|--------|
| 东财行业 | 86 | ~5 | ¥0.05 |
| 东财概念 | 441 | ~20 | ¥0.20 |
| 同花顺 | 374 | ~15 | ¥0.15 |
| **每日全量** | ~900 | ~40 | **¥0.40** |

**使用方式**:
```bash
# 启用代理
python backend/scripts/sync_ext_boards.py --proxy --force

# 自定义代理账号
python backend/scripts/sync_ext_boards.py --proxy --proxy-trade-no XXX --proxy-secret YYY
```

### Phase 3: 后端 API ✅
- [x] `POST /api/admin/ext-boards/sync` - 触发今日同步（后台异步执行）
- [ ] `POST /api/admin/ext-boards/sync-history` - 历史补录
- [x] `GET /api/admin/ext-boards/sync-status` - 获取同步进度和日志
- [x] `GET /api/admin/ext-boards/sync-history-list` - 获取同步历史
- [x] `GET /api/admin/ext-boards/stats` - 获取运维统计数据
- [x] `POST /api/admin/ext-boards/sync/cancel` - 取消同步任务
- [x] `GET /api/admin/ext-boards/boards` - 板块列表查询

> ⚠️ **不集成到 `admin.py` 导入流程** - 因为需要代理 IP，有成本

### Phase 4: 前端界面 ✅
- [x] 外部板块同步页面 `ExtBoardSync.js`
- [x] 今日状态卡片（同步状态、数据源统计）
- [x] 同步进度条（实时日志流）
- [x] 运维监控卡片（数据源详情）
- [x] 同步历史表格
- [ ] 补录历史弹窗（日期范围选择）
- [x] 添加到侧边栏导航（系统管理 > 外部板块同步）

### Phase 5: 映射与验证
- [ ] 运行自动映射 SQL 生成 `ext_board_local_map`
- [ ] 验证数据完整性
- [ ] 人工校正边缘情况

### Phase 6: 数据展示页面（可选）
- [ ] 板块成分股查询页面
- [ ] 股票历史板块归属页面
- [ ] 板块映射管理页面

---

## 12. 文件清单

| 类型 | 文件 | 路径 | 说明 |
|------|------|------|------|
| 数据库 | SQL 脚本 | `sql/ext_boards.sql` | 完整建表语句 ✅ |
| 后端 | 同步脚本 | `backend/scripts/sync_ext_boards.py` | AKShare 数据同步核心逻辑 |
| 后端 | 路由 | `backend/app/routers/ext_board_mgmt.py` | API 接口 |
| 前端 | 页面 | `frontend-client/src/pages/ExtBoardSync.js` | 同步管理页面 |
| 数据 | 状态文件 | `data/ext_board_sync_state.json` | 同步状态（运行时生成） |
| 文档 | 设计文档 | `docs/外部板块数据扩展模块设计文档.md` | 本文档 ✅ |

---

## 13. 变更历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v1.0.0 | 2025-12-10 | 初始设计：数据库表结构、ETL 流程 |
| v1.1.0 | 2025-12-10 | 新增系统集成设计：状态管理、幂等性、与 admin 导入集成 |
| v1.2.0 | 2025-12-10 | 确定触发方式（自动+手动）、API 设计、前端界面设计 |
| v1.3.0 | 2025-12-10 | 首次爬取验证：板块列表同步成功(901个)、反爬虫优化(UA/指数回退/随机延迟/进度条) |
| v1.4.0 | 2025-12-10 | 代理 IP 集成：91HTTP 隧道代理、失败自动换 IP、成本估算；改为独立触发（不自动集成）；运维监控设计 |
