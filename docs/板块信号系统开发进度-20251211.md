# 板块信号系统开发进度总结

> 更新时间：2025-12-13

---

## 一、项目背景

基于**多对多系统设计简稿**，实现东财527板块的热度排名系统和个股板块信号标签功能。

核心目标：
- 在股票列表中显示 `[S级｜锂电池]` 格式的板块信号标签
- 实现板块热度榜、板块详情弹窗、板块完整分析页面
- 支持 `dc` (原版87行业) 和 `eastmoney` (新版527板块) 数据源切换

---

## 二、已完成功能 ✅

### 2.1 后端 API

| 接口 | 路径 | 说明 |
|------|------|------|
| 板块热度榜 | `GET /api/board-heat/ranking` | 获取板块热度排名列表 |
| 板块详情 | `GET /api/board-heat/board/{board_id}` | 获取板块统计和成分股 |
| 个股信号 | `GET /api/board-heat/stock/{stock_code}/signal` | 获取个股板块信号 |
| 批量信号 | `POST /api/board-heat/stocks/signals` | 批量获取多只股票信号 |
| 可用日期 | `GET /api/board-heat/dates` | 获取有数据的日期列表 |

**文件**: `backend/app/routers/board_heat.py`

**已修复问题**:
- ✅ `turnover_rate` → `turnover_rate_percent` 列名修正
- ✅ `st.name` → `st.stock_name` 列名修正

### 2.2 前端页面

| 页面/组件 | 文件 | 说明 |
|-----------|------|------|
| 板块热度榜 | `ExtBoardHeat.js` | 527板块热度排名页面 |
| 板块详情弹窗 | `BoardDetailDialog.js` | 统计卡片+4维指标+TOP10成分股 |
| 板块完整分析 | `BoardAnalysisPage.js` | 多维度信号说明+成分股详细表格 |
| 信号标签组件 | `BoardSignalBadge.js` | `[S级｜板块名]` 格式标签 |

### 2.3 信号标签格式

**设计目标** (来自设计简稿):
```
[S级｜锂电池]
```

- **左边 `S级`**: 股票的综合板块强化信号等级 (S/A/B/NONE)
- **右边 `锂电池`**: 最大驱动板块名称 (Max Driver)

**组件接口**:
```jsx
<BoardSignalBadge
  level="S"           // 信号等级
  label="锂电池"       // 驱动板块名
  type="concept"      // 板块类型
  size="sm"           // 尺寸
/>
```

**样式**:
- S级: 橙→粉渐变，白字
- A级: 蓝紫→粉渐变，白字
- B级: 灰色半透明
- NONE: 不显示

### 2.4 多维度信号说明 (T1-T6)

| 维度 | 名称 | 权重 | 说明 |
|------|------|------|------|
| T1 | 热点榜 | 25% | 总分TOP排名 |
| T2 | 排名跳变 | 20% | 排名大幅提升(≥2000) |
| T3 | 波动率上升 | 20% | 价格波动加剧 |
| T4 | 稳步上升 | 15% | 连续多天排名上升 |
| T5 | 涨幅榜 | 10% | 涨跌幅超阈值 |
| T6 | 成交量榜 | 10% | 成交量放大 |

---

## 三、待完成功能 ⏳

### 3.1 信号系统集成到各模块

需要在以下模块中集成 `BoardSignalBadge` 组件：

| 模块 | 文件 | 状态 |
|------|------|------|
| 最新热点 | `HotSpotsModule.js` | 🔄 基础集成 |
| 排名跳变 | `RankJumpModule.js` | ⏳ 待完成 |
| 稳步上升 | `SteadyRiseModule.js` | ⏳ 待完成 |
| 查询系统 | `SearchModule.js` | ⏳ 待完成 |

### 3.2 数据源切换联动

当 `boardDataSource` 在 `dc` 和 `eastmoney` 之间切换时：

- [ ] 各模块自动刷新数据
- [ ] 根据数据源显示/隐藏板块信号标签
- [ ] API 请求参数联动

**配置位置**: `SignalConfigContext.js` → `boardDataSource`

### 3.3 板块分析页面扩展

| Tab | 状态 | 说明 |
|-----|------|------|
| 成分股分析 | ✅ 已完成 | 成分股列表+信号标签 |
| 历史趋势 | ⏳ 待完成 | 板块热度历史走势 |
| 板块对比 | ⏳ 待完成 | 多板块横向对比 |

---

## 四、数据库表结构

### 4.1 板块相关表

| 表名 | 说明 |
|------|------|
| `ext_board_list` | 527个板块基础信息 |
| `ext_board_daily_snap` | 板块-股票每日映射快照 |
| `ext_board_heat_daily` | 板块每日热度指标 |
| `cache_stock_board_signal` | 个股板块信号缓存 |

### 4.2 信号等级阈值

```
>= 97%  → 'S'
90~97%  → 'A'
80~90%  → 'B'
其他    → 'NONE'
```

配置项 (system_configs):
- `board_signal_S_pct = 0.97`
- `board_signal_A_pct = 0.90`
- `board_signal_B_pct = 0.80`

---

## 五、文件变更清单

### 本次会话修改的文件

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `backend/app/routers/board_heat.py` | 修复 | 列名修正 |
| `frontend-client/src/pages/ExtBoardHeat.js` | 修复 | 空值保护、错误处理 |
| `frontend-client/src/components/BoardDetailDialog.js` | 修改 | 使用 BoardSignalBadge |
| `frontend-client/src/pages/BoardAnalysisPage.js` | 修改 | 使用 BoardSignalBadge |
| `frontend-client/src/App.js` | 修改 | 添加板块分析页面路由 |
| `docs/系统功能清单.md` | 更新 | 标记已完成功能 |

---

## 六、ETL 运维功能 (2025-12-13 新增) 🆕

### 6.1 板块热度计算 ETL 集成

后台管理页面新增"板块热度计算 (ETL)"区块：

| 功能 | 说明 |
|------|------|
| 指定日期计算 | 计算特定日期的热度 |
| 计算全部日期 | 批量计算所有可用交易日 |
| 强制重算 | 覆盖已有数据 |
| 允许借用快照 | 数据缺失时使用最近快照 |
| 实时日志 | 轮询显示计算进度 |
| 任务取消 | 支持中断正在运行的任务 |

**API 接口**:
| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/admin/ext-boards/heat/calc` | POST | 触发计算任务 |
| `/api/admin/ext-boards/heat/status` | GET | 获取状态和日志 |
| `/api/admin/ext-boards/heat/cancel` | POST | 取消任务 |

### 6.2 A股交易日自动对齐

**同步脚本** (`sync_ext_boards.py`):
- 默认日期/传入日期自动回退到最近交易日
- 避免周末/节假日产生无效快照

**热度计算脚本** (`task_board_heat.py`):
- 非交易日输入自动回退到最近交易日
- 基于 `daily_stock_data` 判断交易日

### 6.3 快照日期修复工具

新增 `fix_snap_date.py` 脚本：
- 一键修复 `ext_board_daily_snap` 中非交易日的快照
- 自动检测并回退到最近交易日

---

## 七、下一步计划

1. **信号集成**: 将 `BoardSignalBadge` 集成到排名跳变、稳步上升等模块
2. **数据源联动**: 实现 dc/eastmoney 切换后的自动刷新
3. **历史趋势**: 完成板块分析页面的历史趋势 Tab
4. **测试验证**: 端到端测试信号显示效果

---

## 八、参考文档

- `多对多系统设计简稿.md` - 核心设计文档
- `外部板块多对多系统-Phase2前端实现设计.md` - 前端设计
- `系统功能清单.md` - 功能清单和切换方案
