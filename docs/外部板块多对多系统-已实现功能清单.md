# 外部板块多对多系统 - 已实现功能清单

**更新时间**: 2025-12-11  
**状态**: V4.0 运行中（ETL 已跑通，前后端主要功能联调完成）

---

## 一、数据库层（V4.0 增强）

- 迁移 `006_board_signal_v4.sql` 已执行：  
  - `board_blacklist` 表（黑/灰名单）  
  - `ext_board_daily_snap` 增加 `contribution_score` + 索引  
  - `cache_stock_board_signal` 增加 `dna_json`、`final_score_pct`、`fallback_reason`  
  - `ext_board_heat_daily` 增加 `score_stddev`  
  - `ext_board_list` 增加 `is_broad_index`  

### 1.1 新增表：`ext_board_heat_daily`

**用途**: 存储每日板块热度聚合结果

**表结构**:
```sql
CREATE TABLE ext_board_heat_daily (
    trade_date  DATE NOT NULL,
    board_id    BIGINT NOT NULL REFERENCES ext_board_list(id),
    
    stock_count INT DEFAULT 0,              -- 当日成分股数量
    
    -- B/C 系聚合指标（基于 share_ij 分摊权重）
    b1_rank_sum    DECIMAL(20,8) DEFAULT 0, -- 排名加权总热度 Σ(share * 1/rank^k)
    b2_rank_avg    DECIMAL(20,8) DEFAULT 0, -- 排名加权密度 (B1 / count)
    c1_score_sum   DECIMAL(20,8) DEFAULT 0, -- 总分加权总热度 Σ(share * total_score)
    c2_score_avg   DECIMAL(20,8) DEFAULT 0, -- 总分加权密度 (C1 / count)
    
    -- 综合热度结果
    heat_raw       DECIMAL(20,8) DEFAULT 0, -- 归一化合成后的原始热度
    heat_pct       DECIMAL(10,8) DEFAULT 0, -- 当日全市场分位值 [0, 1]
    
    -- 预留字段（单针策略等）
    needle_density DECIMAL(10,4),
    avg_volume     DECIMAL(10,2),
    
    PRIMARY KEY (trade_date, board_id)
);
```

**索引**:
- `idx_ext_heat_date` - 按日期查询
- `idx_ext_heat_board` - 按板块查询
- `idx_ext_heat_pct` - 按热度排序

**当前数据量**: 526 条 (2025-12-10)

---

### 1.2 新增配置项：`system_configs` (category='board')

共 16 个配置项：

| 配置键 | 默认值 | 说明 |
|--------|--------|------|
| `board_w_industry` | 1.0 | 类型权重：行业板块 |
| `board_w_concept` | 0.7 | 类型权重：概念板块 |
| `board_w_region` | 0.5 | 类型权重：地域板块 |
| `board_safe_pct` | 0.3 | 防守线：行业分位低于此不安全 |
| `board_hot_pct` | 0.8 | 进攻线：板块分位高于此算风口 |
| `board_w_stock` | 1.0 | 合成权重：个股自身分 |
| `board_w_exposure` | 0.7 | 合成权重：板块共振 |
| `board_w_max_concept` | 0.5 | 合成权重：最强驱动 |
| `board_penalty_unsafe` | 0.5 | 行业不安全惩罚系数 |
| `board_signal_S_pct` | 0.97 | S级信号阈值 |
| `board_signal_A_pct` | 0.90 | A级信号阈值 |
| `board_signal_B_pct` | 0.80 | B级信号阈值 |
| `board_heat_alpha` | 0.4 | 综合热度权重：B1 |
| `board_heat_beta` | 0.2 | 综合热度权重：B2 |
| `board_heat_gamma` | 0.3 | 综合热度权重：C2 |
| `board_heat_delta` | 0.1 | 综合热度权重：本地板块 |

---

## 二、ETL 脚本（V4.0）

### 2.1 `task_board_heat.py`

**路径**: `backend/scripts/task_board_heat.py`

**功能**: 计算每日板块热度 + 个股信号（含 DNA），写入 `ext_board_heat_daily` 和 `cache_stock_board_signal`

**核心特性**:

1. **稀疏快照寻址**
   - 个股数据使用 `trade_date`（实时）
   - 板块关系使用最近的 `snap_date`（历史复用）
   - 节省 IP 池资源，避免每日重复爬取关系数据

2. **热度守恒分摊**
   ```
   share_ij = W_type(j) / Σ W_type(k) for all k in B(i)
   ```
   - 个股热度按类型权重分摊到各板块
   - 避免龙头股拉高所有关联板块

3. **B/C 系指标计算**
   - B1: 排名加权总热度 `Σ(share * 1/rank^0.5)`
   - B2: 排名加权密度 `B1 / count`
   - C1: 总分加权总热度 `Σ(share * total_score)`
   - C2: 总分加权密度 `C1 / count`

4. **综合热度**
   ```
   heat_raw = α*B1_norm + β*B2_norm + γ*C2_norm + δ*local_score
   heat_pct = percentile_rank(heat_raw)
   ```

5. **V4.0 额外逻辑**
   - 黑/灰名单权重惩罚（BLACK≈0，GREY=0.1）
   - `contribution_score = share_ij * total_score` 物理存储
   - 全市场分位计算个股 S/A/B 级（`final_score_pct`）
   - 预生成 `dna_json`（含板块驱动、行业安全、因子占位）
   - 批量写入分批 + safe_int/safe_float 防溢出

**最新运行**: 2025-12-11，写入 ext_board_heat_daily 526 条，cache_stock_board_signal 5429 条。

**命令行用法**:
```bash
# 计算指定日期
python task_board_heat.py --date 2025-12-10

# 计算所有可用日期
python task_board_heat.py --all

# 强制重算
python task_board_heat.py --date 2025-12-10 --force

# 预览模式
python task_board_heat.py --dry-run
```

---

## 三、后端 API（V4.0）

### 3.1 路由文件

**路径**: `backend/app/routers/board_heat.py`

**前缀**: `/api/board-heat`

### 3.2 接口清单

| 方法 | 路径 | 功能 | 认证 |
|------|------|------|------|
| GET | `/ranking` | 获取板块热度榜单（支持黑/灰名单过滤） | 需要 |
| GET | `/stock/{stock_code}` | 获取个股板块信号 | 需要 |
| GET | `/stocks/batch` | 批量获取个股信号 | 需要 |
| GET | `/stock/{stock_code}/dna` | 获取个股 DNA（dna_json） | 需要 |
| GET | `/board/{board_id}` | 获取板块详情（贡献度排序、分页） | 需要 |
| GET | `/dates` | 获取可用日期列表 | 需要 |
| GET | `/market/treemap` | 市场热力云图（Treemap） | 需要 |
| GET | `/market/signal-bar` | 市场信号体检仪 | 需要 |
| GET | `/market/sector-matrix` | 板块风格罗盘 | 需要 |
| GET | `/mining/resonance` | 双S级共振猎手 | 需要 |
| GET | `/mining/hidden-gems` | 隐形冠军挖掘机 | 需要 |

### 3.3 接口详情

#### GET `/api/board-heat/ranking`

**参数**:
- `trade_date`: 交易日期 (可选，默认最新)
- `board_type`: 板块类型 `industry`/`concept` (可选)
- `limit`: 返回数量 (默认50)
- `offset`: 分页偏移 (默认0)

**返回示例**:
```json
{
  "trade_date": "2025-12-10",
  "snap_date": "2025-12-10",
  "total_count": 526,
  "items": [
    {
      "board_id": 123,
      "board_code": "BK0477",
      "board_name": "酿酒行业",
      "board_type": "industry",
      "stock_count": 37,
      "heat_pct": 0.9981,
      "b1_rank_sum": 12.5,
      "c2_score_avg": 6.7
    }
  ]
}
```

#### GET `/api/board-heat/stock/{stock_code}`

**参数**:
- `trade_date`: 交易日期 (可选)

**返回示例**:
```json
{
  "stock_code": "300750",
  "board_signal_level": "S",
  "board_signal_label": "锂电池",
  "max_concept_board_id": 456,
  "max_concept_board_type": "concept",
  "max_concept_heat_pct": 0.96,
  "industry_board_id": 123,
  "industry_board_name": "电气设备",
  "industry_heat_pct": 0.72,
  "industry_safe": true,
  "exposure_pct": null,
  "related_boards": [
    {"board_id": 456, "board_name": "锂电池", "board_type": "concept", "heat_pct": 0.96},
    {"board_id": 123, "board_name": "电气设备", "board_type": "industry", "heat_pct": 0.72}
  ]
}
```

#### GET `/api/board-heat/board/{board_id}`

**参数**:
- `trade_date`: 交易日期 (可选)

**返回示例**:
```json
{
  "board_id": 456,
  "board_code": "BK0574",
  "board_name": "锂电池",
  "board_type": "concept",
  "trade_date": "2025-12-10",
  "stock_count": 128,
  "heat_pct": 0.962,
  "heat_raw": 0.847,
  "b1_rank_sum": 15.32,
  "b2_rank_avg": 0.12,
  "c1_score_sum": 856.3,
  "c2_score_avg": 6.69,
  "top_stocks": [
    {"stock_code": "300750", "stock_name": "宁德时代", "board_rank": 1, "total_score": 89.5, "market_rank": 15},
    {"stock_code": "002594", "stock_name": "比亚迪", "board_rank": 2, "total_score": 82.3, "market_rank": 28}
  ]
}
```

#### GET `/api/board-heat/dates`

**返回示例**:
```json
{
  "dates": ["2025-12-10", "2025-12-09", "2025-12-08"]
}
```

---

## 四、前端组件（V4.0 宏观 + 掘金 + DNA）

### 4.1 新增/改造的核心组件
- `ExtBoardHeat.js`：新增三大视图 Tab（市场全景/风格罗盘/智能掘金），接入宏观 Treemap、SignalBar、SectorMatrix、挖掘列表，支持板块详情弹窗 + DNA 弹窗。
- `MarketTreemap.js`：Treemap 视图，面积=资金总量(C1)，色彩=热度(heat_pct)。
- `MarketSignalBar.js`：市场信号体检仪，S/A/B 分布。
- `SectorMatrix.js`：风格罗盘散点图，X=B2，Y=C2。
- `MiningList.js`：双S共振猎手 & 隐形冠军挖掘机。
- `StockDNADialog.js`：个股 DNA 透视（显示板块驱动、行业安全、个股硬实力因子占位）。
- `BoardDetailDialog.js`：成分股表展示贡献度、支持点击成分股弹 DNA，查看完整分析按钮恢复为上层导航回调。

---

## 五、SQL 脚本

### 5.1 增量更新脚本

**路径**: `backend/migrations/004_ext_board_heat_update.sql`

**用途**: 本地测试环境快速更新

### 5.2 完整部署脚本

**路径**: `backend/migrations/004_ext_board_heat_full.sql`

**用途**: 服务器端全新部署

---

## 六、当前运行数据

- ETL 最新日期：2025-12-11  
- `ext_board_heat_daily`: 526 条  
- `cache_stock_board_signal`: 5429 条  
- Treemap 接口返回 100 条（min_size=0）  
- SectorMatrix 接口返回 200 条  
- Mining Resonance 返回 50 条；Hidden Gems 当前 0 条（筛选条件较严）  

### 6.1 前置数据表

| 表名 | 说明 | 数据量 |
|------|------|--------|
| `ext_board_list` | 板块清单 | 527 个 |
| `ext_board_daily_snap` | 每日快照 | 61,206 条 |
| `daily_stock_data` | 个股日数据 | 151,985 条 |

### 6.2 数据来源

- 板块列表: 东方财富爬虫 (`sync_ext_boards.py`)
- 板块关系: 东方财富爬虫 (成分股抓取)
- 个股数据: Excel 导入 (`import_data_robust.py`)

---

## 七、注意事项 / 待补充

- 个股硬实力因子（vol_score/turnover_score/trend_score）尚未在 ETL 产出，DNA 弹窗右侧为 0 时显示占位提示。
- Hidden Gems 为 0，若需示例可临时放宽 min_score/min_rank。
- “查看完整分析”已恢复为上层回调，若需绑定具体路由请在父级实现 `onNavigateToAnalysis`。

---

## 八、验证命令

```bash
# 1. ETL 测试
python backend/scripts/task_board_heat.py --dry-run

# 2. API 测试 (需启动后端)
curl http://localhost:8000/api/board-heat/dates

# 3. 数据库验证
SELECT COUNT(*) FROM ext_board_heat_daily;
SELECT * FROM ext_board_heat_daily ORDER BY heat_pct DESC LIMIT 10;
```

---

## 九、文档索引

| 文档 | 路径 |
|------|------|
| 设计简稿 | `docs/多对多系统设计简稿.md` |
| 开发执行计划 | `docs/外部板块多对多系统-开发执行计划.md` |
| Phase 2 设计 | `docs/外部板块多对多系统-Phase2前端实现设计.md` |
| 本文档 | `docs/外部板块多对多系统-已实现功能清单.md` |
