# 板块数据快速开始指南

## 🚀 5分钟快速上手

### 1️⃣ 创建数据库表（首次）

```bash
# 连接到PostgreSQL
psql -U your_user -d your_database

# 执行建表脚本
\i /path/to/stock_analysis_app/sql/sectors.sql

# 或者直接命令行
psql -U your_user -d your_database -f sql/sectors.sql
```

**验证**：
```sql
-- 检查表是否创建成功
\dt sectors
\dt sector_daily_data
```

### 2️⃣ 准备数据文件

将板块Excel文件放入 `data/` 目录：

```
stock_analysis_app/data/
├── 20251105_allbk_sma_feature_color.xlsx  ✅
├── 20251106_allbk_sma_feature_color.xlsx  ✅
└── 20251107_allbk_sma_feature_color.xlsx  ✅
```

### 3️⃣ 运行导入脚本

```bash
# 进入脚本目录
cd backend/scripts

# 运行导入
python import_sectors_robust.py
```

**输出示例**：
```
============================================================
开始板块数据导入任务（健壮版）
============================================================
找到 3 个板块数据文件
📂 正在导入板块数据: 20251105_allbk_sma_feature_color.xlsx
📊 读取到 500 个板块记录
✅ 文件导入完成: 导入 500 条, 耗时 5.2秒
✅ 板块数据导入任务完成！
文件统计: 成功=3, 失败=0
数据统计: 导入=1500, 跳过=0
============================================================
```

### 4️⃣ 验证数据

```sql
-- 查看板块总数
SELECT COUNT(*) FROM sectors;
-- 预期：500+ 个板块

-- 查看今日排名前10的板块
SELECT 
    s.sector_name,
    sd.rank,
    sd.total_score,
    sd.price_change
FROM sector_daily_data sd
JOIN sectors s ON sd.sector_id = s.id
WHERE sd.date = '2025-11-05'
ORDER BY sd.rank
LIMIT 10;
```

## 📋 完整操作清单

### ✅ 准备工作
- [ ] PostgreSQL数据库已安装并运行
- [ ] 数据库连接配置正确（`backend/app/database.py`）
- [ ] Python环境已安装依赖（`pip install -r requirements.txt`）

### ✅ 数据库设置
- [ ] 执行 `sql/sectors.sql` 创建表
- [ ] 验证表结构：`\d sectors` 和 `\d sector_daily_data`
- [ ] 检查索引：`\di idx_daily_sector_date_unique`

### ✅ 数据导入
- [ ] 板块Excel文件已放入 `data/` 目录
- [ ] 文件命名符合格式：`YYYYMMDD_allbk_sma_feature_color.xlsx`
- [ ] 运行导入脚本：`python import_sectors_robust.py`
- [ ] 检查导入日志，确认无错误

### ✅ 数据验证
- [ ] 板块数量正确：`SELECT COUNT(*) FROM sectors;`
- [ ] 每日数据完整：检查各日期的记录数
- [ ] 排名连续：`SELECT rank FROM sector_daily_data WHERE date='...' ORDER BY rank;`

## 🔄 日常使用

### 导入新的一天数据

```bash
# 1. 将新文件放入data目录
cp 20251108_allbk_sma_feature_color.xlsx stock_analysis_app/data/

# 2. 运行导入（会自动跳过已导入的文件）
cd backend/scripts
python import_sectors_robust.py
```

### 重新导入某天数据

```bash
# 方法1：删除数据库记录
psql -U your_user -d your_database -c "DELETE FROM sector_daily_data WHERE date='2025-11-05';"

# 方法2：删除状态文件记录
# 编辑 data/sector_import_state.json，删除对应日期

# 然后重新运行导入
python import_sectors_robust.py
```

## ⚠️ 常见问题

### Q1: 导入时提示"板块数据目录不存在"
**A**: 检查 `backend/app/config.py` 中的 `DATA_DIR` 配置，确保目录存在

### Q2: 导入后数据条数不对
**A**: 
```sql
-- 检查每日数据量
SELECT date, COUNT(*) 
FROM sector_daily_data 
GROUP BY date 
ORDER BY date;

-- 如果有异常，查看导入日志确认
```

### Q3: 重复导入导致数据翻倍
**A**: 不会！脚本有幂等性保证，重复运行会自动跳过已导入的数据

### Q4: 导入中断怎么办
**A**: 直接重新运行脚本，事务回滚保证不会有脏数据

## 📊 性能参考

| 数据量 | 导入时间 | 数据库大小 |
|--------|----------|------------|
| 500个板块/天 | ~5秒 | ~100MB/年 |
| 30天历史数据 | ~2.5分钟 | ~3MB |
| 365天历史数据 | ~30分钟 | ~36MB |

## 🔗 下一步

### 添加API接口
创建板块查询和分析接口，类似股票接口：
- `/api/sectors` - 获取所有板块
- `/api/sectors/{sector_name}` - 获取单个板块详情
- `/api/sector-trend` - 板块趋势分析

### 前端展示
在现有页面添加"板块分析"模块：
- 板块排名列表
- 板块趋势图表
- 板块对比分析

---

**需要帮助？** 查看详细文档：[板块数据导入说明.md](./板块数据导入说明.md)
