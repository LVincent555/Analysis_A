# 服务器部署步骤 - 换手率修补功能

## 📋 部署前准备

### 1. 本地准备

```bash
# 1.1 删除前端build目录
Remove-Item -Recurse -Force frontend\build

# 1.2 重新编译前端（生产模式）
cd frontend
npm run build
cd ..

# 1.3 提交所有修改
git add .
git commit -m "feat: 换手率修补功能 - 支持自动检测和修补异常换手率数据"
git push origin main
```

## 🚀 服务器部署步骤

### 步骤1：SSH登录服务器

```bash
ssh root@60.205.251.109
cd /root/DA/Analysis_A
```

### 步骤2：删除20251117的错误数据

```bash
# 方式A：使用delete命令（推荐）
python3 update_daily_data.py delete --dates 20251117 --dry-run  # 预演
python3 update_daily_data.py delete --dates 20251117            # 执行

# 确认删除：输入 20251117
```

### 步骤3：运行一键部署

```bash
# 部署会自动：
# 1. 备份状态文件
# 2. 拉取最新代码
# 3. 安装依赖
# 4. 停止服务
# 5. 启动服务（prod模式，无reload）

bash 一键部署.sh
```

### 步骤4：验证部署结果

```bash
# 4.1 检查服务状态
ps aux | grep uvicorn

# 4.2 查看后端日志（确认自动导入成功）
tail -50 logs/backend.log

# 应该看到：
# 🔧 开始换手率数据检测...
# ⚠️  检测到换手率异常！平均值=0.000365
# ✅ 换手率已修补！影响行数=5427, 平均值: 0.000365 → 3.65

# 4.3 验证修补历史
python3 update_daily_data.py fix --scan

# 应该看到：
# 📅 20251117:
#    状态: ✅ 已修补
#    倍数: 10000
#    影响行数: 5427
```

### 步骤5：验证前端

```bash
# 访问前端查看20251117的数据
# http://60.205.251.109
# 换手率应该显示正常（如 6.33%, 4.20% 等）
```

## ⚠️ 注意事项

### 1. 为什么要先删除20251117数据？

- 状态文件中20251117已标记为success
- 后端启动时会跳过已成功导入的数据（幂等性）
- 必须先删除才能重新导入并触发修补

### 2. 部署过程中的关键点

| 阶段 | 说明 | 预期结果 |
|------|------|----------|
| **删除数据** | delete命令删除数据库记录 | 状态改为deleted |
| **拉取代码** | git pull最新代码 | 包含修补功能 |
| **启动服务** | 后端启动，运行startup检查 | 自动检测到20251117需要导入 |
| **自动导入** | 导入时自动检测换手率异常 | 触发修补，乘以10000 |
| **记录状态** | 状态文件记录修补信息 | status=success, fix applied |

### 3. 如果出现问题

```bash
# 问题1：删除失败
# 解决：检查数据库连接，确认日期格式正确

# 问题2：修补未触发
# 解决：查看日志 tail -f logs/backend.log
#      确认是否检测到异常

# 问题3：状态文件损坏
# 解决：从备份恢复
cp backup/data_import_state.json data/

# 问题4：服务启动失败
# 解决：查看日志
tail -100 logs/backend.log
```

## 📊 部署时间估算

- 删除数据：~10秒
- 拉取代码：~30秒
- 安装依赖：~1分钟（如有新依赖）
- 停止服务：~5秒
- 启动服务：~5秒
- 自动导入20251117：~25秒
- **总计：约2-3分钟**

## ✅ 部署检查清单

- [ ] 本地编译前端（npm run build）
- [ ] 提交并推送代码
- [ ] SSH登录服务器
- [ ] 删除20251117数据（预演+执行）
- [ ] 运行一键部署脚本
- [ ] 检查服务状态
- [ ] 查看日志确认修补成功
- [ ] 验证修补历史
- [ ] 前端验证数据正确

## 🎯 简化命令（复制粘贴）

```bash
# ===== 服务器操作 =====
ssh root@60.205.251.109
cd /root/DA/Analysis_A

# 删除数据
python3 update_daily_data.py delete --dates 20251117

# 部署
bash 一键部署.sh

# 验证
tail -50 logs/backend.log
python3 update_daily_data.py fix --scan
```
